<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    
    <!-- ğŸ”§ v8.19: Anti-cache per GitHub Pages -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!--
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    DASHBOARD RILIEVI v8.26 - CHANGELOG
    
    ğŸ”§ AGGIORNAMENTI v8.26 (12 DIC 2025):
    - ğŸ› FIX: Corretta sintassi JavaScript (parentesi mancante in listaModelliColombo)
    - Menu hamburger funzionante
    - ğŸ’° RICARICO DEFAULT: Cambiato da 30% a 50%
    - ğŸ”§ LAVORI SENZA RICARICO: Posa, Smontaggio, Smaltimento, Componenti non ricaricati
    - ğŸ“„ ENEA ECOBONUS: Nuova voce â‚¬250 (modificabile) con checkbox per escludere
    - ğŸ“Š IVA ENEA: Elaborazione ENEA sempre al 22% (servizio, non bene)
    
    ğŸ”§ AGGIORNAMENTI v8.24 (11 DIC 2025):
    - ğŸ”§ COLOMBO-DATABASE-2025: Maniglie (42 modelli, prezzi Venerota)
    
    ğŸ”§ AGGIORNAMENTI v8.23 (11 DIC 2025):
    - ğŸšª FLESSYA-DATABASE-2025: Porte interne (17 linee, 50+ finiture, telai, accessori)
    
    ğŸ”§ AGGIORNAMENTI v8.22 (11 DIC 2025):
    - ğŸšª FERREROLEGNO-DATABASE-2025: Porte interne (Collezioni FL, Replica, Zero)
    - ğŸ”§ OLIVARI-DATABASE-2025: Maniglie (105+ modelli, 14 finiture)
    - ğŸ’° SCONTI: Aggiunti OLIVARI 43%, COLOMBO DESIGN 40%
    
    ğŸ”§ AGGIORNAMENTI v8.21 (10 DIC 2025):
    - ğŸ› FIX CRITICO IVA MISTA: righePreventivo ora accessibile globalmente
    - ğŸ› FIX: Serramenti e Cassonetti ora calcolati correttamente
    - ğŸ› FIX: window.righePreventivo invece di let righePreventivo
    - ğŸ“Š IVA Mista ora funziona: Infissi=beni signif. | Cassonetti/Tapparelle=autonomi
    
    ğŸ”§ AGGIORNAMENTI v8.20 (10 DIC 2025):
    - ğŸ”§ DATABASE OIKOS: Integrato listino EVO 2025 porte blindate
    - ğŸ”§ 4 LINEE: Evolution 3/4, Project, Tekno (Classe 3-4)
    - ğŸ”§ 6 LUCI: Dimensioni da 900x2100 a 1000x3000
    - ğŸ”§ RIVESTIMENTI: Piano, Fugato, Country Line, Legno Vivo, Massello
    - ğŸ”§ ACCESSORI: Cilindri, telai, maniglie, colori telaio
    - ğŸ”§ SCONTO 46%: (40%+10% composto)
    - ğŸ”§ calcolaPrezzo(): Funzione calcolo completa porta + rivestimenti
    
    ğŸ”§ AGGIORNAMENTI v8.19 (10 DIC 2025):
    - ğŸ”§ DATABASE PUNTO PERSIANE: Integrato listino 45/52 Collezione Infinita
    - ğŸ”§ 4 CATEGORIE: Stecca tonda, Romboidale, Orientabile, Cieche/Dogate
    - ğŸ”§ 18 MODELLI: Angela, Giulia, Aurora, Cortina, etc. con maggiorazioni %
    - ğŸ”§ 8 TIPOLOGIE: F1-F4, PF1-PF4 con griglie prezzi
    - ğŸ”§ 8 CATEGORIE COLORE: Standard, Textured, Legno EZY/Ã‰lite/Electo
    - ğŸ”§ TELAI: TH40, TH41, TH45 con griglie prezzi
    - ğŸ”§ SCONTO 55%: Applicato automaticamente
    - ğŸ”§ calcolaPrezzo(): Funzione calcolo completa con modello/colore/telaio
    
    ğŸ”§ AGGIORNAMENTI v8.18 (10 DIC 2025):
    - ğŸ”§ DATABASE PLASTICINO: Integrato listino tapparelle/avvolgibili completo
    - ğŸ”§ 18 MODELLI TELI: Alluminio MD/AD, Acciaio, PVC, Sicurezza, Termoisolanti
    - ğŸ”§ PREZZI â‚¬/MQ: Tinta unita, legno, Raffaello, Decoral
    - ğŸ”§ RINFORZI PVC: Calcolo automatico in base a larghezza telo
    - ğŸ”§ SCONTO 45%: GiÃ  configurato in SCONTI_FORNITORI
    - ğŸ”§ calcolaPrezzo(): Funzione calcolo prezzo telo con rinforzi
    
    ğŸ”§ AGGIORNAMENTI v8.17 (10 DIC 2025):
    - ğŸ› FIX IVA MISTA: Ora usa prezzi CLIENTE (con ricarico) invece di LISTINO
    - ğŸ› FIX CALCOLO: Serramenti e parti autonome ora calcolate correttamente
    - ğŸ“Š DEBUG: Aggiunto log dettagliato per verificare classificazione prodotti
    
    ğŸ”§ AGGIORNAMENTI v8.16 (09 DIC 2025):
    - ğŸ“Š IVA MISTA: Calcolo automatico beni significativi (Art. 7 L. 488/99)
    - ğŸ“Š CLASSIFICAZIONE FISCALE: Infissi=bene signif. | Cassonetti/Persiane=autonomi
    - ğŸ“Š SELETTORE TIPO INTERVENTO: Manutenzione, Ristrutturazione, Nuova costruzione
    - ğŸ“Š RIEPILOGO FISCALE: Tabella con imponibili 10%/22% separati
    - ğŸ“Š ZANZARIERE INTEGRATE: Se fornite con infisso seguono bene significativo
    - ğŸ“Š calcolaIVAMista(): Applica formula normativa D.M. 29/12/1999
    - ğŸ“Š classificaProdottoFiscale(): Classifica ogni riga preventivo
    
    ğŸ”§ AGGIORNAMENTI v8.15 (09 DIC 2025):
    - ğŸ”§ COSTI LAVORO AUTOMATICI: Posa/Smontaggio/Smaltimento/Componenti calcolati da righe
    - ğŸ”§ VALORI SUGGERITI: Sistema mostra "sugg. â‚¬XXX" basato su tipo prodotto
    - ğŸ”§ INPUT MODIFICABILI: 4 campi per costi lavoro (posa, smontaggio, smaltimento, componenti)
    - ğŸ”§ COSTANTE COSTI_LAVORO: Database completo con prezzi per tipo prodotto
    - ğŸ”§ SEPARATORE GIALLO: Sezione "COSTI LAVORO" ben evidenziata
    - ğŸ”§ Finestra â‚¬200, Portafinestra â‚¬250, Scorrevole â‚¬300, Blindata â‚¬350
    - ğŸ”§ Predisposto per futuro calcolo al metro lineare (perimetro BRM)
    
    ğŸ”§ AGGIORNAMENTI v8.14 (09 DIC 2025):
    - ğŸ’° SISTEMA SCONTI FORNITORI: SCONTI_FORNITORI con 7 aziende configurate
    - ğŸ’° FINSTRAL 36.76%, PALAGINA 50%, PUNTO PERSIANE 55%, SOMFY 40%
    - ğŸ’° FERREROLEGNO 50%, FLESSYA 53%, OIKOS 46%
    - ğŸ’° INPUT RICARICO: Campo % modificabile nel preventivo (default 30%)
    - ğŸ’° COLONNE NUOVE: LIST. (listino) | Sc% (sconto) | NETTO (tuo costo) | CLIENTE
    - ğŸ’° MARGINE LORDO: Riga dedicata che mostra il tuo guadagno
    - ğŸ’° TOTALI TRIPLI: Listino/Netto/Cliente per materiali, posa, smontaggio, IVA
    - ğŸ’° calcolaNetto(), calcolaPrezzoCliente(), calcolaDettaglio()
    - ğŸ”§ POSA/SMONTAGGIO: Input modificabili (non piÃ¹ automatici) - spostati sotto subtotale
    - ğŸ”§ TOTALE LAVORI: Nuova riga che somma posa + smontaggio
    - ğŸ¢ VISTA AZIENDE: Box con Listino e Netto separati + colonna Netto nella tabella
    
    ğŸ”§ AGGIORNAMENTI v8.13 (09 DIC 2025):
    - ğŸ¦Ÿ PALAGINA ZANZARIERE: Database completo integrato (18 modelli, 3 fasce, 6 reti, 10 accessori)
    - ğŸ¦Ÿ CALCOLO AUTOMATICO: Prezzo â‚¬/mq per fascia colore + minimo mq fatturazione
    - ğŸ¦Ÿ FASCIA AUTO: getFasciaByColore() determina F1/F2/F3 da codice colore
    - ğŸ¦Ÿ SUPPLEMENTI RETE: Alta trasparenza +5â‚¬/mq, Solar +9.50â‚¬/mq
    - ğŸ¦Ÿ ACCESSORI: Quick-Lock, Sgancio, Carro Fluo, Maniglie, Guide, etc.
    - ğŸ“Š PREVENTIVO: Zanzariere ora calcolate con listino reale (non piÃ¹ â‚¬0)
    - ğŸ‘¤ FIX MENU: Lista progetti mostra NOME CLIENTE invece di nome file
    - ğŸ‘¤ PRIORITÃ€: client â†’ clientData.nome â†’ cliente.nome â†’ name
    
    ğŸ”§ AGGIORNAMENTI v8.12 (06 DIC 2025):
    - âœ… Verifica deploy corretto su GitHub Pages
    - âœ… Aggiornamento versione per tracking modifiche
    
    ğŸ”§ AGGIORNAMENTI v8.11 (05 DIC 2025):
    - âœ… FIX CRITICO: MOTORI ora sommati al totale materiali (erano esclusi!)
    - âœ… FIX CRITICO: CASSONETTI gruppo colore determinato da codice colore (ignora gruppoColoreCass)
    - âœ… FIX: Cassonetti Modello ora mostra "PVC 300" invece di "N/D"
    - âœ… FIX: Cassonetti Colore ora mostra coloreCass invece di "N/D"
    - âœ… FIX: Soglia ribassata PF prezzo corretto (53.40 â†’ 54.50 â‚¬/ml)
    - âœ… NUOVO: Maniglietta esterna per porte-finestre (codice 454 = â‚¬39.10)
    - âœ… FIX: Supplemento telaio alluminio corretto (961N = +20.4â‚¬/ml gruppo B)
    - âœ… FIX: Supplemento maniglia (712 â†’ 7120 = â‚¬11.60)
    - âœ… Separato TELAIO (961) da TIPO ANTA (Nova-line) nel preventivo
    - âœ… determinaGruppoColoreCassonetto(): 01,07,27,42,45=bianco | 06,13,19,46,55=scuri
    - âœ… Aggiunto alias "posaclima" per isolamento cassonetto (codice 40830)
    
    ğŸ”§ AGGIORNAMENTI v8.12 (09 DIC 2025):
    - ğŸ“¦ FIX CASSONETTI: B e C ora mostrati correttamente (parseInt su stringhe)
    - ğŸ“¦ BRM CASSONETTO: Mostra L, H, C, B (usa rilevati se BRM null)
    - ğŸ“ MISURE RILEVATE: Aggiunti B e C alla griglia cassonetto
    
    ğŸ”§ AGGIORNAMENTI v8.11 (09 DIC 2025):
    - ğŸ“¦ CASSONETTI COMPLETI: Config globale mostra materialeCass + codiceCass + coloreCass
    - ğŸ“¦ CASSONETTI MISURE: Aggiunto LS, SRSX, SRDX, HCASS, ZSX, ZDX alla normalizzazione
    - ğŸ“ MISURE RILEVATE: Sezione aggiuntiva con misure originali cassonetto
    - ğŸ”§ FIX BRM_C/BRM_B: Usa valori calcolati se disponibili
    
    ğŸ”§ AGGIORNAMENTI v8.10 (09 DIC 2025):
    - ğŸ› FIX BRM_H NULL: Non mostra piÃ¹ H=0 o H=1200 quando BRM_H non Ã¨ calcolato
    - ğŸ› FIX DEFAULT: Rimossi valori default 1000x1200 nel wizard preventivo
    - ğŸ“ MISURE CONDIZIONALI: L, H, C, B mostrati solo se hanno valore reale
    
    ğŸ”§ AGGIORNAMENTI v8.09 (05 DIC 2025):
    - ğŸ“Š TABELLA FULL-WIDTH: Preventivo visibile senza scroll orizzontale
    - ğŸ“Š FONT COMPATTO: 0.65rem per celle, 0.6rem per header
    - ğŸ“Š HEADER ABBREVIATI: Pos, L, H, mÂ², ml, Tel., Col., Man., Mont., Qt, TOT
    - ğŸ“Š COLONNE PROPORZIONALI: table-layout fixed per adattarsi allo schermo
    - ğŸ” LENTE MOTORI: Click su riga motore per vedere dettaglio costi
    - ğŸ“¦ LT50 HELIOS: Aggiunto motore (ref 1045041) â‚¬255.06
    - ğŸ“¦ FIX PREZZI ACCESSORI: Usano database SOMFY invece di valori hardcoded
    - ğŸ“¦ SOMFY LISTINO 2025: Database completo da Excel ufficiale
    
    ğŸ”§ AGGIORNAMENTI v8.04 (05 DIC 2025):
    - ğŸ“Š PREVENTIVO FULL-WIDTH: La tabella preventivo usa tutta la larghezza schermo
    - ğŸ“Š HEADER FISSO: Intestazioni tabella fisse durante scroll
    - ğŸ“Š RIGHE ALTERNATE: Sfondo alternato per migliore leggibilitÃ 
    - ğŸ“Š COLORI HEADER: Header blu scuro professionale
    - ğŸ“Š FONT COMPATTO: Font ridotto per mostrare piÃ¹ dati
    - ğŸ“Š HOVER EVIDENZIATO: Riga azzurra al passaggio mouse
    
    ğŸ”§ AGGIORNAMENTI v8.03 (05 DIC 2025):
    - ğŸ­ VISTA AZIENDE RIDISEGNATA: Nuovo layout con configurazione specifica per azienda
    - ğŸ­ HEADER AZIENDA: Nome + badge prodotti + BOX TOTALE ORDINE in verde
    - ğŸ­ CONFIGURAZIONE PER TIPO: Box separati per Infissi, Tapparelle, Motori, etc.
    - ğŸ­ COLORI DISTINTI: Ogni tipo prodotto ha il suo colore (blu infissi, verde tapparelle, giallo motori)
    - ğŸ­ TABELLA SEMPLIFICATA: Rimosse colonne ridondanti (Misure BRM + LÃ—H â†’ solo Misure mm)
    - ğŸ­ TOTALE EVIDENZIATO: Riga totale verde con sfondo gradient
    - ğŸ­ BADGES CON CONTEGGIO: "3 Infissi" invece di solo "Infissi"
    
    ğŸ”§ AGGIORNAMENTI v8.02 (05 DIC 2025):
    - ğŸ“¦ PRODOTTI IN ALTO: "Prodotti e Configurazioni" ora Ã¨ la PRIMA sezione
    - ğŸ”„ SEZIONI COLLASSABILI: "Misure Complete" e "Caratteristiche Muro" chiuse di default
    - ğŸ”„ CLICK PER APRIRE: Freccia â–¼ per espandere le sezioni tecniche
    - ğŸ”„ BADGE CONTEGGIO: Mostra quante misure/dati ci sono
    - ğŸš« NASCONDI VUOTI: Se Caratteristiche Muro ha tutti N/D, non viene mostrato
    - ğŸš« NASCONDI VUOTI: Se Misure Complete non ha dati, non viene mostrato
    
    ğŸ”§ AGGIORNAMENTI v8.01 (04 DIC 2025):
    - ğŸ“± CSS RESPONSIVE COMPLETO: Ottimizzato per iPad, tablet e smartphone
    - ğŸ“± TABLET (768-1024px): Layout adattivo, tabs wrap, tabelle scrollabili
    - ğŸ“± SMARTPHONE (max 768px): Sidebar posizioni orizzontale, grids 1 colonna
    - ğŸ“± PICCOLI (max 480px): Font ridotti, totali 2 colonne, elementi compatti
    - ğŸ“± LANDSCAPE: Layout orizzontale ottimizzato
    - ğŸ“± TOUCH: Target 44px minimi, feedback tap, no hover su touch
    
    ğŸ”§ AGGIORNAMENTI v8.00 (04 DIC 2025):
    - ğŸ”Œ TAB MOTORE SEPARATO: Nuovo tab "ğŸ”Œ Motore" in Vista Posizioni (non piÃ¹ sotto Tapparella)
    - ğŸ”Œ MOTORI NEL PREVENTIVO: Righe separate per motori Somfy con prezzi calcolati
    - ğŸ”Œ CALCOLO AUTOMATICO: Motore + Comando + Accessori da database SOMFY_PREZZI
    - ğŸ”Œ renderMotoreContent(): Funzione dedicata per tab motore con dettaglio completo
    - âš™ï¸ VERSIONE CENTRALIZZATA: Costante DASHBOARD_VERSION aggiorna tutto automaticamente
    - ğŸ› FIX: Motori aggiunti SEMPRE quando serveMotore=true (non solo se serveTapparella=false)
    - ğŸ› FIX: Tab Tapparella appare solo se serveTapparella=true
    
    ğŸ”§ AGGIORNAMENTI v7.999 (04 DIC 2025):
    - ğŸ”Œ PREVENTIVO: Motori aggiunti SEMPRE quando serveMotore=true (anche con tapparella)
    - ğŸ”Œ PREVENTIVO: Calcolo prezzi automatico motore + comando + accessori da SOMFY_PREZZI
    - ğŸ”Œ SEPARAZIONE TAPPARELLA/MOTORE: Prodotti distinti con aziende diverse
    - ğŸ”Œ SOMFY_PREZZI: Chiavi normalizzate (oximo_20, amy1, supporto)
    - ğŸ”Œ calcolaPrezzoKit(): Calcola totale kit con dettaglio componenti
    
    ğŸ”§ AGGIORNAMENTI v7.998 (04 DIC 2025):
    - ğŸ”Œ DATABASE SOMFY: Listino prezzi motori, comandi e accessori
    - ğŸ”Œ MOTORI: Oximo 50 io (â‚¬137.66-â‚¬145.83), LT60 Orion (â‚¬174), LT50 Helios (â‚¬1198.80)
    - ğŸ”Œ COMANDI: Amy 1 io (â‚¬234.60), IZYMO Shutter (â‚¬665.90)
    - ğŸ”Œ ACCESSORI: Supporto (â‚¬94.60), Ruota 60mm (â‚¬21.00), Corona (â‚¬17.67)
    - ğŸ› FIX VISTA AZIENDE: Mostra "Motore" invece di "Tapparella" quando serveTapparella=false
    - ğŸ› FIX BADGE: Nuovo badge "Motori" con bordo arancione
    - ğŸ› FIX TOTALI: Conteggio separato Motori vs Tapparelle
    - ğŸ› FIX: "Azienda Non Specificata" â†’ "Somfy" per motori
    - ğŸ”„ SPOSTATO: Configurazione Prodotti Globale da RILIEVO a UFFICIO â†’ Vista Generale
    
    ğŸ”§ AGGIORNAMENTI v7.997 (04 DIC 2025):
    - ğŸ“¦ CASSONETTI FINSTRAL: Database prezzi completo da listino EUR 2025/3 (pag. 141-146)
    - ğŸ“¦ FINSTRAL_CASSONETTI_PREZZI: PVC 148/148B/300/300B + Legno 9-48/9-48B
    - ğŸ“¦ calcolaPrezzoCassonettoFinstral(): Calcolo con arrotondamento superiore
    - ğŸ” mostraDettaglioCostiCassonetto(): Popup dettaglio con breakdown costi
    - ğŸ” Click su riga cassonetto per vedere dettaglio (hover arancione #ffedd5)
    - ğŸ§Š Supporto isolamento termico cod. 40830/40831
    - ğŸ”Œ FIX TAPPARELLE/MOTORI: Controlla serveTapparella prima di creare riga
    - ğŸ”Œ MOTORI: Se serveTapparella=false e serveMotore=true â†’ riga "Motore" invece di "Tapparella"
    - ğŸ“¦ CASSONETTI PREVENTIVO: Usa BRM_L/BRM_H/B con calcolo automatico Finstral
    
    ğŸ”§ AGGIORNAMENTI v7.995 (04 DIC 2025):
    - ğŸ”Œ FIX IMPORTAZIONE MOTORI: Aggiunto supporto per nuova struttura tapparelle
    - âœ… serveTapparella, serveMotore, serveAccessori ora importati
    - âœ… accessoriDaSostituire importato  
    - âœ… Array motori[] importato (modelloId, comandoId, accessori, note)
    - âœ… motoreModelloDefault importato
    
    ğŸ”§ AGGIORNAMENTI v7.994 (03 DIC 2025):
    - ğŸ” FIX FILTRO PRODOTTI: Blindata cerca anche in pos.ingresso.blindata
    - ğŸšª Portoncino giÃ  cercava in pos.ingresso.portoncino (confermato)
    
    ğŸ”§ AGGIORNAMENTI v7.993 (03 DIC 2025):
    - ğŸšª Supporto nuovi campi: versoApertura, sensoApertura (con fallback vecchi)
    - ğŸšª Popup dettaglio: Apertura unificato (verso + senso)
    
    ğŸ”§ AGGIORNAMENTI v7.992 (03 DIC 2025):
    - ğŸšª renderPortoncinoContent(): Nuova struttura campi
    - ğŸšª Apertura: Tirare/Spingere + SX/DX (unificato)
    - ğŸšª Finiture INT/EST con colore
    - ğŸšª Sezioni: Tipo Apertura, BRM, Finiture, Telaio/Anta, Maniglie, Colori, Optional
    - ğŸ› FIX: Rimosso testo che chiudeva commento HTML
    
    ğŸ”§ AGGIORNAMENTI v7.99 (03 DIC 2025):
    - ğŸšª LISTINO_FINDOOR_PORTONCINI: Database prezzi portoncini Finstral EUR 2025/3
    - ğŸšª calcolaPrezzoPortoncinoFindoor(): Calcolo automatico con supplementi
    - ğŸšª Integrazione portoncini in calcolaPreventivo()
    - ğŸšª mostraDettaglioCostiPortoncino(): Popup dettaglio costi ğŸ”
    - ğŸšª Tipi apertura: 720, 625, 621, 622, 633, 636, 624, 623
    
    ğŸ”§ AGGIORNAMENTI v7.98 (03 DIC 2025):
    - ğŸšª PORTONCINO: Aggiunto tab portoncino nella vista dettagli posizione
    - ğŸšª renderPortoncinoContent(): Nuova funzione per visualizzare config portoncino FIN-Door
    - ğŸ” BLINDATA: Aggiunto campo versoApertura (tirare/spingere) nella visualizzazione
    - ğŸ“Š Supporto completo campi: tipoApertura, direzioneApertura, latoCerniere per portoncini
    - ğŸ“Š Array prodotti ora include: infisso, tapparella, cassonetto, persiana, zanzariera, blindata, portoncino
    
    ğŸ”§ AGGIORNAMENTI v7.97_08 (28 NOV 2025):
    - ğŸ” FIX PREVENTIVO BLINDATE: Normalizza pos.ingresso.blindata â†’ pos.blindata in calcolaPreventivo()
    - âœ… Ora le blindate appaiono correttamente nella tabella preventivo
    
    ğŸ”§ AGGIORNAMENTI v7.98_06 (28 NOV 2025):
    - ğŸ” FIX CRITICO: convertGitHubToDashboardFormat() ora estrae blindata da pos.ingresso.blindata
    - âœ… FORMATO 3 (positions): Supporta struttura ingresso.blindata e ingresso.portoncino
    - âœ… Crea sia pos.blindata che pos.ingresso per retrocompatibilitÃ 
    
    ğŸ”§ AGGIORNAMENTI v7.98_05 (28 NOV 2025):
    - ğŸ” RIVESTIMENTI NON DI SERIE: Prezzi specifici da listino EVO 2025 pag. 99
    - âœ… Prezzi differenziati per essenza (Noce Canaletto, Teak, Altre Essenze)
    - âœ… Calcolo rivestimenti con chiavi composte (es. "Piano Non di serie Teak")
    - âœ… Fallback a prezzo generico linea se chiave specifica non trovata
    - âœ… Log dettagliato prezzi rivestimenti INT/EST
    
    ğŸ”§ AGGIORNAMENTI v7.98_04 (28 NOV 2025):
    - ğŸ” FIX IMPORTAZIONE BLINDATE: Supporta struttura pos.ingresso.blindata
    - âœ… Conversione automatica da formato export OpenPorte v5.14+
    - âœ… RetrocompatibilitÃ : pos.blindata accessibile come alias
    - âœ… Supporto pos.ingresso.portoncino per portoncini Finstral
    - âœ… Conteggio n_ingressi, n_blindate, n_portoncini nei totali
    - âœ… Campi imbotte (imbotteEst, imbotteEstAltezza, imbotteEstLargh, imbotteEstEssenza)
    - âœ… Campi cornici (corniciInt, corniciFermaPannello)
    
    ğŸ”§ AGGIORNAMENTI v7.98 (28 NOV 2025):
    - ğŸ” PORTE BLINDATE OIKOS: Integrazione completa nel dashboard
    - âœ… LISTINO_OIKOS_BLINDATE: Prezzi base, controtelaio, cilindri, colori
    - âœ… calcolaLuceOikos(): Determina luce da dimensioni LNP
    - âœ… calcolaPrezzoBlindataOikos(): Calcolo completo con optional
    - âœ… calcolaPreventivo(): Sezione blindate dopo cassonetti
    - âœ… groupProductsByAzienda(): Blindate raggruppate per Oikos
    - âœ… Vista Aziende: Tab Oikos con porte blindate
    - âœ… Vista Preventivo: Righe blindate con dettaglio prezzi
    
    ğŸ”§ AGGIORNAMENTI v7.96 (28 NOV 2025):
    - âœ… Config Persiana: Colore Telaio mostrato SOLO se presente nel JSON
    - Dashboard si adatta automaticamente ai dati esportati
    
    ğŸ”§ AGGIORNAMENTI v7.95 (28 NOV 2025):
    - âœ… Config Globale Persiana: Mostra colorePersiana correttamente
    - âœ… Aggiunti campi: Colore Telaio, Fissaggio, Battuta
    - âœ… Allineamento con OpenPorte v5.04
    
    ğŸ”§ AGGIORNAMENTI v7.94 (28 NOV 2025):
    - ğŸ†• Config Globale ORA Ãˆ DENTRO ogni tab prodotto:
      * Tab Infisso â†’ Config Globale Infisso
      * Tab Persiana â†’ Config Globale Persiana
      * Tab Tapparella â†’ Config Globale Tapparella
      * Tab Cassonetto â†’ Config Globale Cassonetto
    - Rimossa Config Globale "fissa" in alto (era fuori posto)
    - Ogni config Ã¨ collassabile con click
    
    ğŸ”§ AGGIORNAMENTI v7.93 (28 NOV 2025):
    - âœ… FIX: Spagnolette NON sono supplemento - INCLUSE nel prezzo base
    - Da listino: "MANIGLIA: Kit spagnoletta nera (nÂ°1 pezzo)" = STANDARD
    - Supplemento â‚¬45 Ã¨ SOLO per aperture a LIBRO (LIB-DX, LIB-SX)
    - Traversi: inclusi per PF (1 per PF1, 2 per PF2), nessuno per F
    
    ğŸ”§ AGGIORNAMENTI v7.92 (28 NOV 2025):
    - ğŸ†• CALCOLO PERSIANE COMPLETO da listino Punto Persiane:
      * Maggiorazione modello Alto Adige +33%
      * Cardini (4 Ã— â‚¬3.50 = â‚¬14.00)
      * Imballo 3%
      * Contributo gestione â‚¬97.00
    - Popup persiana mostra TUTTE le voci come PDF Punto Persiane
    - Allineamento prezzi con preventivo ufficiale
    
    ğŸ”§ AGGIORNAMENTI v7.91 (28 NOV 2025):
    - FIX: Popup persiana ora mostra COLORE correttamente
    - Mapping corretto: supplementoTelaio = colore, supplementoAnta = spagnolette
    - Mostra codice colore e categoria nel breakdown
    
    ğŸ”§ AGGIORNAMENTI v7.90 (28 NOV 2025):
    - ğŸ” LENTE su TUTTI i tipi: Infissi, Tapparelle, Persiane
    - Tutte le funzioni dettaglio usano SOLO dati del preventivo
    - Hover colorato per tipo: blu infissi, giallo tapparelle, viola persiane
    - Una sola fonte dati = zero discrepanze
    
    ğŸ”§ AGGIORNAMENTI v7.89 (27 NOV 2025):
    - ğŸ†• RISCRITTO popup tapparella: USA SOLO DATI DEL PREVENTIVO
    - Non ricalcola piÃ¹ nulla, trascrive i valori giÃ  calcolati
    - Misure, prezzi e totali ora 100% coerenti con tabella preventivo
    - PiÃ¹ semplice e manutenibile: modifiche listino solo in un punto
    
    ğŸ”§ AGGIORNAMENTI v7.88 (27 NOV 2025):
    - FIX: Header popup tapparella ora mostra totale calcolato (coerente con breakdown)
    - ğŸ†• Warning se preventivo ha totale diverso da calcolo
    - ğŸ“Š Debug log completo per misure tapparella in console
    
    ğŸ”§ AGGIORNAMENTI v7.87 (27 NOV 2025):
    - ğŸ†• Aggiunto modello "Alto Adige" al listino persiane con griglia prezzi completa (F1, F2, PF1, PF2)
    - ğŸ†• Aggiunto modello "Cortina" e "Nerina" con maggiorazione +4%
    - ğŸ†• Arrotondamento misure secondo regole listino (<=49 in difetto, >49 in eccesso)
    - ğŸ†• Calcolo automatico persiana ora funziona per modelli Punto Persiane
    - ğŸ“Š Popup dettaglio persiana mostra breakdown completo del calcolo
    
    ğŸ”§ AGGIORNAMENTI v7.86 (27 NOV 2025):
    - FIX: Allineata logica estrazione misure popup tapparella con preventivo
    - PrioritÃ : BRM_L/BRM_H â†’ brm.L/brm.H â†’ LF/HF+magg â†’ LVT/HVT â†’ L/H
    - Arrotondamento cm come preventivo (Math.round)
    - Totale popup ora corrisponde a totale preventivo
    
    ğŸ”§ AGGIORNAMENTI v7.85 (27 NOV 2025):
    - FIX BUG: Mapping proprietÃ  calcolo tapparella (prezzoTeloâ†’telo, prezzoRulloâ†’rullo, etc.)
    - Il popup dettaglio tapparella ora mostra correttamente tutti i prezzi
    
    DASHBOARD RILIEVI v7.84 - CHANGELOG
    
    ğŸ”§ VERSIONE 7.84 (27 NOV 2025):
    
    ğŸ” DETTAGLIO COSTI PERSIANE
    - ğŸ†• Click su riga PERSIANA â†’ popup dettaglio con breakdown completo
    - ğŸ“‹ Configurazione: modello, tipo, colore, fissaggio, battuta, telaio
    - ğŸ“ Misure BRM con superficie in mÂ²
    - ğŸ’° BREAKDOWN CALCOLO: prezzo base, telaio, maggiorazione colore, contributo, imballo
    - ğŸ“ Cardini: quantitÃ , modello, prezzo unitario, totale
    - ğŸ”’ Fermapersiane: quantitÃ , modello, prezzo unitario, totale
    - ğŸ“Š Riepilogo finale: Persiana + Accessori = TOTALE POSIZIONE
    - ğŸ¨ Riga persiana cliccabile con ğŸ” e hover viola
    
    ğŸ”§ VERSIONE 7.83 (27 NOV 2025):
    
    ğŸ”© ACCESSORI PERSIANE
    - âœ… Nuova sezione Cardini + Fermapersiane in visualizzazione persiana
    - ğŸ“ Mostra quantitÃ  e modello cardini da pos.persiana.accessoriPersiana
    - ğŸ”’ Mostra quantitÃ  e modello fermapersiane
    - ğŸ”— Allineamento con OpenPorte v4.94
    
    ğŸ’° CALCOLO PREZZI ACCESSORI PERSIANE
    - ğŸ†• LISTINO_PUNTO_PERSIANE: Database cardini e fermapersiane
    - ğŸ’µ K.EASY â‚¬56/cad, F.INC â‚¬45/cad, CHA.1 â‚¬18/cad
    - ğŸ“Š calcolaPrezzoAccessoriPersiana(): Calcola totale accessori
    - ğŸ“‹ Righe separate nel preventivo per ogni accessorio con prezzo > 0
    - ğŸ¨ Badge "accessorio" (indaco) nella tabella preventivo
    
    ğŸ”§ VERSIONE 7.82 (26 NOV 2025):
    
    ğŸ’° DETTAGLIO COSTI - BREAKDOWN SINGOLA RIGA
    - ğŸ†• Nuova funzione mostraDettaglioCostiTapparella() per breakdown completo
    - ğŸ–±ï¸ Click su riga TAPPARELLA nel preventivo apre popup dettaglio
    - ğŸ“Š Mostra breakdown: Telo (mqÃ—â‚¬), Rullo (mÃ—â‚¬), Fissi (â‚¬66.40), Guide
    - ğŸ“ Sezione misure con indicazione maggiorazioni foro (+40mm, +200mm)
    - ğŸ“‹ Dettaglio componenti fissi espandibile (COMP-02 a COMP-10)
    - ğŸ¨ UI moderna con colori e icone per ogni componente
    - âœ… Righe cliccabili evidenziate con ğŸ” e hover giallo
    - ğŸ†• Modal generico mostraModalDettaglioCosti() riusabile per altri prodotti
    
    ğŸ”§ VERSIONE 7.81 (26 NOV 2025):
    
    ğŸ“ LISTINO GUIDE TAPPARELLE PLASTICINO
    - ğŸ†• Aggiunto database guide in LISTINO_PLASTICINO.guide
    - ğŸ’° Prezzi: TG15OX â‚¬40, TG10OX â‚¬57.60, TG15VE â‚¬50.90, TG10VE â‚¬69
    - ğŸ¨ Gestione colori: standard (Argento/Bronzo/Elox/Bianco) e RAL
    - ğŸ”§ Nuova funzione calcolaPrezzoGuida() per calcolo automatico
    - ğŸ“‹ Supporto guide a coppia (CP) e a metro lineare (ML)
    - âœ… INTEGRATO nel calcolo preventivo tapparelle (riga ~15590)
    - âœ… Prezzo guida sommato al totale tapparella automaticamente
    - ğŸ“Š Guida mostrata in console: "Guida: â‚¬XX.XX [CODICE]"
    
    ğŸ“ MAGGIORAZIONI MISURE FORO TAPPARELLE
    - ğŸ†• Se misure da LF/HF (foro), applica maggiorazione automatica
    - ğŸ“ Larghezza telo: LF + 40mm
    - ğŸ“ Altezza telo: HF + 200mm
    - ğŸ¯ Il telo deve essere piÃ¹ grande del foro per coprirlo
    - ğŸ“Š Console mostra: "Maggiorazione foro: 1200+40=1240mm Ã— 1400+200=1600mm"
    
    ğŸ”§ VERSIONE 7.80 (26 NOV 2025):
    
    ğŸ’° CONTO ECONOMICO IN CONFIGURAZIONE GLOBALE
    - ğŸ†• Aggiunto riepilogo economico nella sezione "Configurazione Globale Infissi"
    - ğŸ“Š Mostra totali per categoria: Infissi, Persiane, Tapparelle, Zanzariere, Cassonetti
    - ğŸ’µ Totale generale evidenziato in verde
    - ğŸ”„ Valori calcolati dinamicamente da PreventivoCalculator
    - ğŸ¨ Nuovo CSS per sezione economica (.config-economico-section)
    
    ğŸ”§ VERSIONE 7.79 (26 NOV 2025):
    
    âš™ï¸ SISTEMA VERSIONING AUTOMATICO
    - ğŸ†• Costante DASHBOARD_VERSION e DASHBOARD_DATE centralizzate (riga ~942)
    - ğŸ”„ Funzione updateDashboardVersion() aggiorna automaticamente:
      â€¢ Title pagina
      â€¢ Badge versione nell'header (id="version-badge")
      â€¢ Tutti gli elementi con classe "dashboard-version"
      â€¢ Tutti gli elementi con attributo data-version
      â€¢ Console log
    
    ğŸ“ PER AGGIORNARE VERSIONE:
    1. Modifica SOLO riga ~942: const DASHBOARD_VERSION = "7.XX";
    2. Modifica SOLO riga ~943: const DASHBOARD_DATE = "DD MMM YYYY";
    3. TUTTO il resto si aggiorna AUTOMATICAMENTE!
    
    ğŸ› ï¸ COMANDI CONSOLE (per debug):
    - dashboardVersion.get()    â†’ Mostra versione corrente
    - dashboardVersion.next()   â†’ Calcola prossima versione (+0.01)
    - dashboardVersion.next('minor') â†’ Calcola +0.10
    - dashboardVersion.check()  â†’ Verifica tutti i punti versione
    - dashboardVersion.update() â†’ Forza aggiornamento UI
    
    ğŸ”´ FIX CRITICO: CALCOLO SUPPLEMENTO PROFILO ANTA
    - âŒ PRIMA: Usava perimetro FINESTRA (â‚¬29.86 per F2 Nova-line)
    - âœ… DOPO: Usa perimetro BATTENTI (â‚¬46.28 per F2 Nova-line)
    - ğŸ“ Perimetro battenti = 2 Ã— (larghezzaAnta + altezza) Ã— numAnte
    - ğŸ”§ Corretto in calcolaPrezzoFinstral() e fallback
    - ğŸ¨ Anche supplemento colore anta ora su perimetro battenti
    
    ğŸ”´ FIX CRITICO: VALORI SUPPLEMENTI COLORE ANTA
    - âŒ PRIMA: supplementiColorePVC.anta usava valori TOTALI (profilo+colore)
    - âœ… DOPO: Separati correttamente (solo COLORE, profilo in supplementiProfiloAnta)
    - ğŸ¨ Nova-line: [6.01, 6.09] â‚¬/ml (calcolati: totale - profilo)
    - ğŸ¨ Slim-line: [0, 6.93] â‚¬/ml
    - âœ… Protocollo Finstral: profilo â‚¬46.28 + colore â‚¬50.48 = â‚¬96.76 âœ“
    
    ğŸ”´ FIX CRITICO: NOVA-LINE SEMPRE PVC
    - âŒ PRIMA: Se finituraEst=alluminio â†’ materiale=alluminio â†’ supplProfilo[alu]=â‚¬0
    - âœ… DOPO: Nova-line usa SEMPRE valore PVC (ha vetro esterno, non alluminio)
    - ğŸ”§ Logica: isNovaLine â†’ materialeProfilo = 'pvc' forzato
    
    CALCOLO PERIMETRO:
    - F1 (1 anta): perimetroBattenti = 2 Ã— (L + H)
    - F2 (2 ante): perimetroBattenti = 2 Ã— (L/2 + H) Ã— 2 = 2L + 4H
    - Esempio F2 1220Ã—1490: 2Ã—(0.61+1.49)Ã—2 = 8.40 ml
    
    ğŸ“Š TABELLE DIMENSIONALI ANTE SPECIALI (â‚¬/pezzo):
    - Slim-line Cristal (954): 605-2730mm Ã— 615-2115mm
    - Slim-line Twin (C788/C988): 605-2730mm Ã— 615-1490mm
    - Nova-line Twin (N989): 605-2730mm Ã— 615-1490mm
    - Funzione getSupplementoAntaDimensionale() per lookup
    
    ğŸ”§ MONTANTE PER 2+ ANTE
    - Nodi specifici per tipo anta (NL45 per Nova-line, C45 per Twin, ecc.)
    - Gruppi colore alluminio: aluA, aluB, aluC (decorativi), aluD (RAL/NCS)
    - Colonna "Montante â‚¬" aggiunta nella tabella preventivo
    
    ğŸ¨ FIX COLORE BIANCO
    - Gruppo A (bianco) = â‚¬0 supplemento (incluso nel prezzo base)
    - Pattern regex per codici PVC numerici ("45 - Bianco" â†’ "45")
    
    ğŸ“Š FIX TABELLA PREZZI BASE
    - Riga tipo401: 1480â†’1490 per match con configuratore Finstral
    
    ---
    
    ğŸ”§ VERSIONE 7.78 (26 NOV 2025):
    
    âœ… UI FERRAMENTA IN DETTAGLIO POSIZIONE
    - ğŸ”© Nuovo blocco "FERRAMENTA" nel dettaglio infisso
    - ğŸšª Mostra tipo apertura (Anta/Ribalta, Solo Anta, ecc.)
    - ğŸ”’ Mostra tipo cerniere (Vista/Scomparsa con icone)
    - ğŸ’° Mostra supplemento ferramenta se > â‚¬0
    - ğŸ”„ Override detection per cerniere e tipo apertura
    - ğŸ†• Funzione helper formatTipoApertura()
    
    ---
    
    ğŸ”§ VERSIONE 7.77 (26 NOV 2025):
    
    âœ… DATABASE FERRAMENTA / APERTURE / CERNIERE
    - ğŸ“‹ Riferimento: Listino Finstral EUR 2025/3 pag.116-157
    - ğŸšª tipiApertura: AR, A, R, FX, VA, SP, SPR, PFS con codici
    - ğŸ”© supplementiCerniere: scomparsa â‚¬47-189 per tipo
    - ğŸ”’ supplementiSicurezza: RC2, scontri, contatti magnetici
    - ğŸŒ¬ï¸ supplementiAerazione: estate/inverno, limitata
    - ğŸ›‹ï¸ supplementiComfort: facilita chiusura, fermo anta
    - ğŸšª supplementiScorrevoli: parallela, ribalta, serratura
    - ğŸ“ supplementiVasistasComando: aste, motori
    - ğŸ” rc2: requisiti e supplementi antieffrazione
    
    ğŸ“Š STRUTTURA DATI FERRAMENTA:
    - Cerniere Vista (4xx.0): â‚¬0 incluse nel prezzo base
    - Cerniere Scomparsa (2xx.0): supplemento variabile
    - Scorrevoli: NO cerniere, usano carrelli su guide
    - Misure minime per ogni tipo apertura
    
    ---
    
    ğŸ”§ VERSIONE 7.76 (26 NOV 2025):
    
    âœ… FIX TAB PRODOTTI IN VISTA POSIZIONI
    - ğŸ› Bug: cambiando tab (es. Infissoâ†’Persiana) e tornando, il tab spariva
    - ğŸ”§ Fix: switchProductTab ora opera solo nel contenitore corrente (.position-section)
    - ğŸ”§ Fix: renderPositionProducts ora usa logica dinamica per primo tab active
    - âœ… Solo il PRIMO prodotto disponibile Ã¨ active (non sempre Infisso)
    - âœ… Tab isolati per posizione (non interferiscono tra card diverse)
    
    ---
    
    ğŸ”§ VERSIONE 7.75 (26 NOV 2025):
    
    âœ… RIMOSSO BOTTONE "GENERALE" DAL MENU PRINCIPALE
    - âŒ Era duplicato: giÃ  presente come tab in Ufficio
    - ğŸ  Ufficio ora Ã¨ la landing page di default
    - ğŸ“Š Vista Generale accessibile da: Ufficio â†’ Vista Generale
    - ğŸ§¹ Menu semplificato: [Ufficio] [App Posa] [Conferma Cliente]
    
    âœ… TAGLI TELAIO AUTOMATICI (codici da JSON)
    - ğŸ“‹ Database 50+ codici taglio con prezzi â‚¬/ml (pag.22-28 listino)
    - âœ‚ï¸ Tagli standard (127,107,163,etc): â‚¬2.19/ml
    - âœ‚ï¸ Tagli medi (164,165,116,etc): â‚¬2.75/ml
    - âœ‚ï¸ Tagli speciali (118,172,147,etc): â‚¬5.22/ml
    - ğŸ”„ Legge campo: infisso.taglio, infisso.tagli, pos.taglio, pos.tagli
    - ğŸ“Š Supporta singolo codice o array di codici
    
    âœ… CALCOLO AUTOMATICO TAGLI
    - Formula: codice taglio Ã— perimetro (ml)
    - Console log: "âœ‚ï¸ Taglio XXX: X.XXml Ã— â‚¬X.XX/ml = â‚¬XX.XX"
    - Campo supplementoTagli nelle righe preventivo
    - Campo tagli con descrizione codici applicati
    
    ğŸ“‹ ESEMPIO JSON:
    {
      "infisso": {
        "taglio": "156"           // singolo
        // oppure
        "tagli": ["156", "127"]   // multipli
      }
    }
    
    ---
    
    ğŸ”§ VERSIONE 7.74 (26 NOV 2025):
    
    âœ… FIX RILEVAZIONE PORTE-FINESTRE PER SOGLIA AUTOMATICA
    - ğŸ› BUG RISOLTO: 'pf2'.includes('p2') = FALSE, soglia non applicata
    - âœ… Nuova logica: tipoInfisso.startsWith('pf') OR H_mm >= 1800
    - ğŸšª Soglia codice3: â‚¬53.40/ml applicata automaticamente a PF1, PF2
    
    âœ… SUPPLEMENTO SOGLIA VISIBILE NEL BREAKDOWN
    - ğŸ“Š Aggiunto supplementoSoglia nelle righe preventivo
    - ğŸ“‹ Log console: "ğŸšª Soglia porta-finestra: X.XXml Ã— â‚¬53.40 = â‚¬XX.XX"
    
    âœ… MIGLIORATA DETECCIÃ“N PORTE-FINESTRE
    - Rileva: tipo PF1, PF2, PFx, porta, o H >= 1800mm
    - Compatibile con logica Finstral: altezza >= 1800mm = PF
    
    ğŸ“Š CONFRONTO POS.3 (PF2 1585Ã—2542):
    - CONFIGURATORE: â‚¬1884.39
    - PRIMA v7.73: â‚¬1581.15 (manca soglia â‚¬84+)
    - DOPO v7.74: ~â‚¬1665+ (con soglia automatica)
    
    ---
    
    ğŸ”§ VERSIONE 7.73 (26 NOV 2025):
    
    âœ… FIX PREZZO TELAIO 967 (FORMA Z) PER ALLUMINIO
    - Valore corretto da â‚¬15.30/ml a â‚¬31.85/ml per PVC-Alluminio
    - Allineato con configuratore Finstral ufficiale
    - Riferimento: Listino EUR 2025/3 pag.17
    
    âœ… NUOVO SUPPLEMENTO PROFILO ANTA (Step-line, Classic-line, etc.)
    - Aggiunto supplementiProfiloAnta in FINSTRAL_PREZZI
    - Step-line alluminio: â‚¬17.13/ml (configuratore calcola questo valore)
    - Classic-line alluminio: â‚¬10.50/ml (codice 973K)
    - Separato dal supplemento colore anta
    
    âœ… FIX SUPPLEMENTO MONTANTE MOBILE PER F2 (tipo 401)
    - Montante codice28 ora calcolato automaticamente per infissi 2 ante
    - PVC gruppo A: â‚¬0 / gruppo B: â‚¬2.35
    - Alluminio gruppo A: â‚¬26.70 / gruppo B: â‚¬29.10
    
    âœ… INTEGRAZIONE IN calcolaPreventivo()
    - supplementoProfiloAnta estratto da risultatoFinstral
    - supplementoMontante aggiunto a righe preventivo
    - Log dettagliato per debug prezzi Finstral
    
    ğŸ“Š CONFRONTO POS.1 (F2 1305Ã—1563, 967 Step-line Alu):
    - PRIMA v7.72: â‚¬962.44
    - DOPO v7.73: ~â‚¬1191 (allineato a configuratore Finstral â‚¬1191.81)
    
    ---
    
    ğŸ”§ VERSIONE 7.73 PRECEDENTE (da v7.72):
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.72 (25 NOV 2025):
    
    âœ… FIX VISTA GENERALE VUOTA AL RITORNO
    - ğŸ› BUG RISOLTO: Passando Posizioni â†’ Generale, contenuto spariva
      â€¢ switchVistaUfficio() nascondeva content ma non ri-renderizzava
    - âœ… AGGIUNTO: Gestione esplicita per vistaName === 'generale'
      â€¢ Ri-chiama renderVistaGeneraleUfficio(currentData)
      â€¢ Fallback a projectData se currentData non disponibile
    
    âœ… FIX CONFIG INFISSI NON PRESERVATO AL CAMBIO PROGETTO
    - ğŸ› BUG RISOLTO: configInfissi perso durante conversione formato
      â€¢ FORMATO 2 (project.rilievoInfissi) non copiava configInfissi
      â€¢ FORMATO 3 (positions) non copiava configInfissi esplicitamente
    - âœ… FIX: Aggiunto configInfissi: githubData.configInfissi || {} in tutti i return
    
    âœ… PREZZI CONDIVISI TRA VISTA AZIENDE E PREVENTIVO
    - ğŸ› BUG RISOLTO: Vista Aziende ricalcolava prezzi diversi da Preventivo
      â€¢ Ora groupProductsByAzienda() chiama calcolaPreventivo() per ottenere prezzi
      â€¢ Crea mappa chiaveâ†’prezzo: "posizione-tipoProdotto"
      â€¢ Usa prezzi da mappa invece di ricalcolare
    - âœ… RISULTATO: Prezzi identici in Vista Aziende e Preventivo
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.67 (25 NOV 2025):
    
    âœ… COLORI FINSTRAL COLLEGATI ALLA UI
    - ğŸ†• mappaColoreACodiceFinstral() - converte testo colore â†’ codice Finstral
      â€¢ Pattern matching: "bianco", "grigio antracite", "castagno", "RAL 7016"
      â€¢ Supporto codici diretti: F716, L19, M01
    - ğŸ†• getGruppoColorePVC() - determina gruppo A o B
    - ğŸ“Š calcolaPrezzoFinstral() ora riceve colori dalla UI:
      â€¢ colorePVC: estratto da coloreInt/coloreEst
      â€¢ coloreAlluminio: per materiale alluminio
      â€¢ tipoAnta: step-line, nova-line, etc.
    - ğŸ†• COLONNA "Colore â‚¬" in tabella Preventivo
      â€¢ Mostra supplemento colore per ogni riga
      â€¢ Incluso nel totale prezzoUnitario
    - ğŸ“Š Console log dettagliato: Base + Telaio + Colore(A/B)
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.66 (25 NOV 2025):
    
    âœ… MERGE: SUPPLEMENTI COLORE FINSTRAL + DEBUG MISURE
    - ğŸ¨ Da v7.64-colori: Database completo supplementi colore
      â€¢ Gruppi PVC: A (bianco), B (scuri) - â‚¬/ml per tipo anta
      â€¢ Gruppi Alluminio: 1, 1H (legno), 2 (+284â‚¬), 3 (+1410â‚¬)
      â€¢ calcolaPrezzoFinstral() con tipoAnta, colorePVC, coloreAlluminio
    - ğŸ” Da v7.65: Debug fonte misure in Vista Aziende
      â€¢ Mostra origine valori: LVT/HVT, BRM_L/H, brm.L/H
      â€¢ PrioritÃ  misure unificata tra viste
    - ğŸ“š Dati estratti da PDF Finstral EUR 2025/3 (pag 101-105)
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.65 (25 NOV 2025):
    
    âœ… DEBUG FONTE MISURE IN VISTA AZIENDE
    - ğŸ†• Colonna "Misure BRM" ora mostra anche la FONTE del valore
    - ğŸ“Š FORMATO: L:1000 Ã— H:1500
                  (LVT:1000, HVT:1500)
    - ğŸ” VARIABILI TRACCIATE:
      â€¢ LVT/HVT = pos.misure.LVT/HVT (prioritÃ )
      â€¢ BRM_L/BRM_H = prodotto.BRM_L/BRM_H
      â€¢ brm.L/brm.H = prodotto.brm.L/H
      â€¢ larg/alt = prodotto.larghezza/altezza (fallback)
    - ğŸ¯ SCOPO: Debugging trasparente per verificare quale campo viene usato
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.64 (25 NOV 2025):
    
    âœ… FIX MISURE UNIFICATE TRA VISTE
    - ğŸ› BUG RISOLTO: Vista Aziende e Preventivo usavano misure diverse
      â€¢ Aziende leggeva: prodotto.brm.L/H (valori vecchi)
      â€¢ Preventivo leggeva: pos.misure.LVT/HVT (valori corretti)
    - âœ… PRIORITÃ€ UNIFICATA per tutte le viste:
      1ï¸âƒ£ pos.misure.LVT / pos.misure.HVT (misure posizione - PRIORITÃ€)
      2ï¸âƒ£ prodotto.BRM_L / prodotto.BRM_H (campo diretto)
      3ï¸âƒ£ prodotto.brm.L / prodotto.brm.H (retrocompatibilitÃ )
      4ï¸âƒ£ prodotto.larghezza / prodotto.altezza (fallback)
    - ğŸ“Š RISULTATO: Prezzi ora identici in Vista Aziende e Preventivo
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.63 (25 NOV 2025):
    
    âœ… FINSTRAL INTEGRATO IN VISTA PREVENTIVO
    - ğŸ†• calcolaPreventivo() ora usa calcolaPrezzoFinstral() per infissi
    - ğŸ“Š Mappatura automatica tipo infisso â†’ tipo Finstral:
      â€¢ F1, P1, battente â†’ tipo 101 (1 anta)
      â€¢ Fisso, F0 â†’ tipo 102 (elemento fisso)
      â€¢ F2, P2, 2 ante â†’ tipo 401 (2 ante montante mobile)
    - ğŸ’° FORMULA COMPLETA:
      â€¢ Base da griglia Finstral EUR 2025/3
      â€¢ + Supplemento telaio (â‚¬/ml Ã— perimetro)
      â€¢ + Supplemento anta (Step/Nova/Classic)
      â€¢ + Supplemento vetro (â‚¬/mq)
      â€¢ + Supplemento maniglia (Ã— numero ante)
    - ğŸ”„ Fallback automatico a sistema vecchio se dimensioni fuori range
    - ğŸ” Console log dettagliato per debug prezzi
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.62 (25 NOV 2025):
    
    âœ… INTEGRAZIONE PREZZI FINSTRAL - LISTINO EUR 2025/3
    - ğŸ†• DATABASE COMPLETO: 3 tipologie infisso (101, 102, 401)
      â€¢ Tipo 101: Finestra 1 anta (anta/ribalta) - 35Ã—39 = 1365 prezzi
      â€¢ Tipo 102: Elemento fisso - 23Ã—29 = 667 prezzi
      â€¢ Tipo 401: 2 ante con montante mobile - 27Ã—36 = 972 prezzi
    - ğŸ’° SUPPLEMENTI TELAIO: 9 modelli (961-967, Z62, Z91) con prezzi PVC/Alluminio
    - ğŸ”§ FUNZIONI CALCOLO:
      â€¢ trovaPrezzoBaseFinstral(tipo, L, H) - ricerca griglia dimensionale
      â€¢ calcolaPrezzoFinstral(config) - calcolo completo con supplementi
    - ğŸ“Š FORMULA: Base + (Perimetro Ã— Suppl.Telaio) + (Superficie Ã— Suppl.Vetro)
    - ğŸ¯ PROSSIMO STEP: Collegare calcolo a Vista Aziende â†’ Finstral
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.61 (25 NOV 2025):
    
    âœ… FIX COMPLETO TIPO INFISSO UNIFICATO
    - ğŸ› BUG RISOLTO: tipo e apertura ancora separati in v7.60
    - ğŸ†• IMPLEMENTAZIONE CORRETTA: "Tipo Infisso" UNIFICATO con formato "tipo + apertura"
    - ğŸ“ ESEMPI OUTPUT: "F1 + SX", "F2 + DX", "P1 + Scorrevole"
    - ğŸ“Š ORDINE DEFINITIVO CAMPI INFISSI:
      1ï¸âƒ£ QuantitÃ 
      2ï¸âƒ£ Tipo Infisso (tipo + apertura UNIFICATO) â¬…ï¸ FIX PRINCIPALE
      3ï¸âƒ£ Azienda
      4ï¸âƒ£ Telaio (spostato in alto) â¬…ï¸ NUOVO POSIZIONAMENTO
      5ï¸âƒ£ Altri dettagli tecnici (finiture, colori, vetro, ecc.)
    - ğŸ¯ LOGICA: Per infissi â†’ campo unificato, per altri prodotti â†’ campi separati
    - âš¡ ELIMINATA DUPLICAZIONE: Campo telaio non piÃ¹ duplicato in basso
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.60 (21 NOV 2025):
    
    âœ… FIX PARZIALE INTERFACCIA VISTA POSIZIONI
    - ğŸ› BUG RISOLTO: Etichetta "Cassonetto/Monoblocco" errata
    - âš ï¸ PROBLEMA: tipo e apertura ancora separati (corretto in v7.61)
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.59 (21 NOV 2025):
    
    âœ… FIX COMPLETO CALCOLO TAPPARELLE - TELO INCLUSO
    - ğŸ› BUG RISOLTO: Calcolo tapparelle mancava il TELO (solo rullo+fissi)
    - ğŸ†• DATABASE TELI: 11 modelli da catalogo Plasticino 07.2022
      â€¢ Alluminio MD: TA01, TA05, TA42, TA07 (â‚¬60-92/mq)
      â€¢ Alluminio AD: TA25, TA30 (â‚¬72-75/mq, alta densitÃ )
      â€¢ Acciaio: TA15, TA20 (â‚¬75-120/mq)
      â€¢ PVC: A01, A10, A16 (â‚¬40-54/mq)
    - ğŸ’° FORMULA CORRETTA: TELO (al mq) + RULLO (al metro) + FISSI (â‚¬66.40) + SUPP.ALTEZZA
    - ğŸ“Š ESEMPIO 1275Ã—2425mm (3.09 mq):
      â€¢ Telo TA01: â‚¬185.40 (3.09Ã—â‚¬60)
      â€¢ Rullo: â‚¬16.83 (1.275Ã—â‚¬13.20)
      â€¢ Fissi: â‚¬66.40
      â€¢ TOTALE: â‚¬268.63 âœ… (prima era solo â‚¬83.23 âŒ)
    - ğŸ“‹ VISTA GENERALE: Dettaglio costi completo
      â€¢ Base â‚¬ = TELO (costo principale ~70% del totale)
      â€¢ Telaio â‚¬ = RULLO (~6% del totale)
      â€¢ Anta â‚¬ = FISSI (~24% del totale)
      â€¢ Vetro â‚¬ = SUPPLEMENTO ALTEZZA (se H>300cm)
    - ğŸ¢ VISTA AZIENDE: Prezzi completi con telo incluso
    - ğŸ” LOG DETTAGLIATO: Console mostra breakdown Telo+Rullo+Fissi+Supplemento
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.58 (21 NOV 2025):
    
    âœ… FIX PRIORITÃ€ FALLBACK TAPPARELLE - MISURE CORRETTE
    - ğŸ› BUG RISOLTO: Vista Generale usava LVT/HVT (infissi) invece di BRM tapparella
    - âœ… PRIORITÃ€ CORRETTA implementata:
      1ï¸âƒ£ tapp.BRM_L / tapp.BRM_H (campo diretto tapparella)
      2ï¸âƒ£ tapp.brm?.L / tapp.brm?.H (retrocompatibilitÃ  vecchi JSON)
      3ï¸âƒ£ pos.misure.LF / pos.misure.HF (Larghezza/Altezza Foro)
      4ï¸âƒ£ pos.misure.LVT / pos.misure.HVT (ultimo fallback - misure infisso)
      5ï¸âƒ£ pos.L / pos.H (fallback assoluto generico)
    - ğŸ” LOG DETTAGLIATO: Console mostra tutti i campi testati con prioritÃ 
    - ğŸ“Š RISULTATO: Vista Generale ora mostra 1275Ã—2425 e 875Ã—1375 (corretto!)
    - âœ… ESEMPIO: progetto-2025P002 ora calcola prezzi con misure BRM tapparella
    - ğŸ¯ COMPATIBILITÃ€: Funziona con JSON vecchi e nuovi grazie a fallback multipli
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.57 (21 NOV 2025):
    
    âœ… FIX CRITICO TAPPARELLE - MISURE IN MM (NON CM)
    - ğŸ› BUG RISOLTO: Tapparelle mostravano misure in cm invece di mm nella tabella
    - âœ… CAUSA: Assumeva tapp.brm?.L fosse in cm, ma era in mm!
    - ğŸ”§ SOLUZIONE: Mantiene tutte le misure in mm, converte in cm solo per calcolo Plasticino
    - ğŸ“Š TABELLA: Ora mostra L(mm) e H(mm) consistente con infissi/persiane
    - ğŸ” LOG: Console mostra sia mm che cm per debug
    - âœ… ESEMPIO: Tapparella 1000mmÃ—1500mm (non piÃ¹ 100Ã—150)
    - ğŸ¯ COMPATIBILITÃ€: Fallback corretto da pos.misure.LVT/HVT (giÃ  in mm)
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.56 (21 NOV 2025):
    
    âœ… PREZZI PERSIANE COMPLETI CON SUPPLEMENTI
    - ğŸ¨ DATABASE COLORI: 41 colori in 8 categorie con maggiorazioni 0%-30%
    - ğŸ’° MAGGIORAZIONI COLORE: Applicate automaticamente su prezzo base
      â€¢ CAT01 (0%): 7 colori standard
      â€¢ CAT02A (+3%): 6 colori opachi speciali
      â€¢ CAT02B (+5%): 6 colori textured
      â€¢ CAT03 (+20%): 7 colori legno Ezy
      â€¢ CAT04 (+25%): 3 colori legno Ã‰lite
      â€¢ CAT05 (+25%): 3 colori sublimato Electo
      â€¢ CAT06 (+30%): 5 colori sublimato
      â€¢ CAT07 (+30%): 1 colore speciale (Winchester CPF70KA)
      â€¢ CAT08 (A prev): 3 colori + supplemento cabina â‚¬237
    - ğŸ”§ SUPPLEMENTO SPAGNOLETTE: +â‚¬45 automatico per persiane 2+ ante
    - ğŸ“‹ FUNZIONE: trovaMaggiorazioneColorePersiana(colore) â†’ categoria + %
    - ğŸ” LOG: Console mostra categoria colore, supplemento spagnolette
    - ğŸ“Š CALCOLO: Prezzo = Base + MaggiorazioneColore% + Spagnolette
    - âœ… ESEMPIO PERSIANA: F2 Winchester = Base â‚¬632 + 30% colore â‚¬190 + Spagnolette â‚¬45 = â‚¬867
    
    âœ… INFISSI - MANIGLIE MOLTIPLICATE PER NUMERO ANTE
    - ğŸ”¢ MOLTIPLICAZIONE AUTOMATICA: Supplemento maniglia Ã— numero ante
    - ğŸšª LOGICA: 1 maniglia per anta (F2 = 2 maniglie, F3 = 3 maniglie, ecc.)
    - ğŸ” LOG: Console mostra calcolo maniglie se ante > 1
    - âœ… ESEMPIO INFISSO: F2 maniglia standard â‚¬5 â†’ 2 ante Ã— â‚¬5 = â‚¬10 totale
    - ğŸ¯ COMPATIBILITÃ€: Usa campo pos.infisso.tipo per estrarre numero ante
    
    ğŸ“‹ TABELLA PREVENTIVO:
    - Persiane: Supplementi in colonne (riutilizzate per colore + spagnolette)
    - Infissi: Supplemento maniglia giÃ  moltiplicato nel totale
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.55 (21 NOV 2025):
    
    âœ… INTEGRAZIONE TIPO E MODELLO NEL CALCOLO PREZZI
    - ğŸ†• FUNZIONE: estraiNumeroAnte(tipo) â†’ Parsa numero ante da campo "tipo"
    - ğŸ“Š PERSIANE: Usa pos.persiana.tipo (F1, F2, PF2) per determinare numero ante
    - ğŸ“Š PERSIANE: Mostra pos.persiana.modello ("Alto Adige", "NERINA", ecc.) in tabella
    - ğŸªŸ INFISSI: Usa pos.infisso.tipo (F1, F2, PF2) per determinare numero ante
    - ğŸšª INFISSI: Mostra pos.infisso.tipoAnta ("Step-line", "Nova-line") in tabella
    - ğŸ” LOG: Console mostra tipo, numero ante estratto, modello persiana, tipoAnta infissi
    - ğŸ“‹ TABELLA: Colonna "Tipo" ora include tipo (es. "Infisso F2", "Persiana PF1")
    - ğŸ“‹ TABELLA: Colonna "Telaio" infissi include tipoAnta (es. "967 - Step-line")
    - ğŸ“‹ TABELLA: Colonna "Telaio" persiane mostra modello (es. "Alto Adige")
    - âœ… COMPATIBILITÃ€: Funziona con JSON esistenti che hanno campo "tipo"
    - ğŸ¯ Preparazione per calcoli supplementi basati su numero ante
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.54 (21 NOV 2025):
    
    âœ… PORTE FINESTRE PF1 E PF2 IMPLEMENTATE
    - ğŸ“‹ AGGIUNTO: Tipologia PF1 (Porta Finestra 1 anta) con griglia completa
    - ğŸ“‹ AGGIUNTO: Tipologia PF2 (Porta Finestra 2 ante) con griglia completa
    - ğŸšª PF1: Larghezze 500-1200mm (8 col) Ã— Altezze 1800-2700mm (10 righe) = 80 prezzi
    - ğŸšª PF2: Larghezze 800-1500mm (8 col) Ã— Altezze 1800-2700mm (10 righe) = 80 prezzi
    - ğŸ§® Logica automatica F vs PF: Altezza >= 1800mm â†’ Porta Finestra (PF), altrimenti Finestra (F)
    - ğŸ”„ Selezione dinamica: 1 anta H<1800 â†’ F1, 1 anta H>=1800 â†’ PF1, 2 ante H>=1800 â†’ PF2
    - ğŸ“Š Totale listino completo: F1+F2+F3+F4+PF1+PF2 = 647 prezzi
    - ğŸ¯ Tutte le tipologie standard Punto Persiane coperte
    - ğŸ—ï¸ Nota: F3, F4 solo per finestre (nessuna PF3, PF4 nel listino)
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.53 (21 NOV 2025):
    
    âœ… PERSIANE F3 E F4 IMPLEMENTATE
    - ğŸ“‹ AGGIUNTO: Tipologia F3 (Finestra 3 ante) con griglia completa
    - ğŸ“‹ AGGIUNTO: Tipologia F4 (Finestra 4 ante) con griglia completa
    - ğŸ—ï¸ F3: Larghezze 1200-2300mm (12 col) Ã— Altezze 700-2000mm (14 righe) = 168 prezzi
    - ğŸ—ï¸ F4: Larghezze 1600-3000mm (15 col) Ã— Altezze 800-2000mm (13 righe) = 195 prezzi
    - ğŸ§® Logica selezione automatica tipologia estesa: 1â†’F1, 2â†’F2, 3â†’F3, 4â†’F4
    - ğŸ“Š Totale listino Punto Persiane: F1+F2+F3+F4 = 487 prezzi
    - âš™ï¸ Funzione calcolaPrezzoPUNTOPERSIANE supporta tutte le tipologie
    - ğŸ¯ Sistema interpolazione automatica per dimensioni intermedie
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.52 (21 NOV 2025):
    
    âœ… LISTINO PREZZI PERSIANE PUNTO PERSIANE IMPLEMENTATO
    - ğŸ“‹ AGGIUNTO: Sistema completo calcolo prezzi persiane Punto Persiane
    - ğŸ’° Listino stecche fisse tonde con griglie dimensionali complete
    - ğŸ—ï¸ Tipologie implementate: F1 (1 anta 500-1200mm) e F2 (2 ante 800-1500mm)
    - ğŸ“ Range dimensioni: Larghezza 500-1500mm, Altezza 700-2000mm (step 100mm)
    - ğŸ§® Funzione calcolaPrezzoPUNTOPERSIANE(L_mm, H_mm, tipologia) con interpolazione
    - ğŸ“Š Integrazione Vista Preventivo: persiane con prezzi reali in tabella
    - ğŸ”¢ Calcolo automatico: Determina tipologia da numero ante (1â†’F1, 2â†’F2)
    - ğŸ¯ Compatibile con aziende: "punto persiane", "p. persiane", "p persiane"
    - ğŸ“‚ Database: LISTINO_PUNTO_PERSIANE con F1 (14 altezze Ã— 8 larghezze) e F2 (14 altezze Ã— 8 larghezze)
    - âœ… Fonte: Listino Punto Persiane 2025 - Stecche fisse tonde categoria standard
    - ğŸ” Log dettagliato: Mostra dimensioni riferimento e prezzo calcolato
    - âš™ï¸ Sistema fallback misure pos.misure.LVT/HVT mantenuto da v7.51
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.51 (21 NOV 2025):
    
    âœ… FIX DEFINITIVO MISURE - FALLBACK A POS.MISURE.LVT/HVT
    - ğŸ¯ CAUSA TROVATA: pos.infisso.BRM_L Ã¨ null, parseInt(null) = NaN
    - âœ… SOLUZIONE: Usare pos.misure.LVT/HVT come fanno gli INFISSI
    - ğŸ“ LOGICA CORRETTA:
      1. Cerca misure prodotto (tapp.brm.L, pers.brm.L, etc.)
      2. Se non trova â†’ Fallback a pos.misure.LVT/HVT (COME INFISSI!)
      3. Conversione: Tapparelle mmâ†’cm (/10), altri prodotti mm diretto
    - ğŸ”§ APPLICATO A: Tapparelle, Persiane, Zanzariere, Cassonetti
    - ğŸ¯ RISULTATO ATTESO: Ora TUTTI i prodotti trovano misure (stesse degli infissi)
    - ğŸ” LOG v7.51: Mostra fallback LVT/HVT quando attivato
    - âœ… TESTATO: Con log v7.50 che mostrava pos.infisso.BRM_L=null
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.50 (21 NOV 2025):
    
    ğŸ” DEBUG ESTREMO - LOGGING COMPLETO STRUTTURA DATI
    - ğŸ› PROBLEMA PERSISTENTE: Fallback v7.49 non funziona, tapparelle ancora senza misure
    - ğŸ” IMPLEMENTATO: Logging ESTREMO per vedere TUTTA la struttura pos.infisso
    - ğŸ“Š LOG AGGIUNTI:
      â€¢ pos.infisso completo (oggetto intero)
      â€¢ pos.infisso.BRM_L/BRM_H con tipo dato
      â€¢ pos.infisso.brm (formato alternativo)
      â€¢ tapp.brm e tapp completo
      â€¢ Calcolo passo-passo per ogni step del fallback
    - ğŸ¯ OBIETTIVO: Capire perchÃ© fallback non trova pos.infisso.BRM_L
    - ğŸ’¡ PROSSIMO: Con questi log possiamo vedere ESATTAMENTE dove sono le misure
    - âš ï¸ TEMPORANEO: Log verboso sarÃ  rimosso una volta capito problema
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.49 (21 NOV 2025):
    
    âœ… FIX MISURE PRODOTTI - FALLBACK AUTOMATICO A INFISSO
    - ğŸ› PROBLEMA RISOLTO: Tapparelle/Persiane/Zanzariere/Cassonetti senza misure proprie
    - âœ… IMPLEMENTATO: Fallback automatico alle misure BRM dell'infisso (stesso foro!)
    - ğŸ“ LOGICA: Se prodotto non ha misure, usa quelle dell'infisso nella stessa posizione
    - ğŸ”§ CONVERSIONE: Tapparelle usano cm (BRM_L/10), altri prodotti usano mm (BRM_L diretto)
    - ğŸ“Š PRIORITÃ€ MISURE: 
      1. prodotto.brm.L/H (se presente)
      2. prodotto.larghezza/altezza (se presente)
      3. infisso.BRM_L/BRM_H (NUOVO - fallback intelligente)
      4. pos.L/H (ultimo fallback)
    - ğŸ¯ RISULTATO: Ora TUTTI i prodotti appaiono nel preventivo con misure corrette
    - ğŸ” LOG MIGLIORATO: Mostra source delle misure per ogni prodotto
    - âœ… APPLICATO A: Tapparelle, Persiane, Zanzariere, Cassonetti
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.48 (21 NOV 2025):
    
    ğŸ” DEBUG PREVENTIVO - LOGGING ESTESO
    - ğŸ› PROBLEMA: Preventivo mostra SOLO infissi, mancano tapparelle/persiane/zanzariere/cassonetti
    - âœ… Implementato logging dettagliato per tracciare creazione righe preventivo
    - ğŸ“Š Log prima/dopo forEach: mostra quante righe vengono create
    - ğŸ“‹ Log popolaTabellaPreventivo: mostra quante righe riceve e aggiunge
    - ğŸ” Log per ogni riga: tipo, azienda, ambiente per debug
    - ğŸ¯ OBIETTIVO: Capire se problema Ã¨ in creazione righe[] o in popolamento tabella
    - ğŸ’¡ PROSSIMO: Analisi log console completi per identificare causa esatta
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.47 (21 NOV 2025):
    
    âœ… PREVENTIVO - TUTTI I PRODOTTI IMPLEMENTATI
    - âœ… PERSIANE: Appaiono nella tabella preventivo con misure e quantitÃ 
    - âœ… ZANZARIERE: Appaiono nella tabella preventivo con misure e quantitÃ 
    - âœ… CASSONETTI: Appaiono nella tabella preventivo con misure e quantitÃ 
    - ğŸ¯ Come Infissi: Stessa logica per tutti i prodotti
    - âš ï¸ Prezzi: Placeholder â‚¬0.00 con nota "Prezzo da definire" (listini da implementare)
    - ğŸ“Š RISOLTO: "Voglio avere tutti i prodotti presenti nel preventivo"
    - ğŸ”¢ Conteggio: numeroPezzi include TUTTI i prodotti (infissi, tapparelle, persiane, zanzariere, cassonetti)
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.46 (21 NOV 2025):
    
    âœ… DETTAGLIO COSTI - TAB TAPPARELLE IMPLEMENTATO
    - ğŸšï¸ ABILITATO: Tab Tapparelle nel popup "Dettaglio Costi"
    - ğŸ“Š Listino Plasticino completo con formula, componenti, test calcolo
    - ğŸ§® Funzione testCalcoloTapparellaDettaglio() per calcolo rapido
    - ğŸ“ Misure FORO (BRM) utilizzate per calcolo rullo corretto
    - âœ… RISOLTO: "dettaglio costi non da valori" per tapparelle
    - ğŸ¯ Accesso: Ufficio â†’ Preventivo â†’ Dettaglio Costi â†’ Tab Tapparelle
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.45 (21 NOV 2025):
    
    âœ… EXPORT EXCEL COMPLETO CON TUTTI I PRODOTTI
    - ğŸ“Š AGGIUNTO: Libreria SheetJS per export Excel professionale
    - âœ… 7 FOGLI: Generale, Posizioni, Infissi, Persiane, Tapparelle, Zanzariere, Cassonetti
    - ğŸ†• PERSIANE: Foglio dedicato con modello, tipologia, colore (PRIMA MANCAVA)
    - ğŸ†• TAPPARELLE: Foglio dedicato con calcolo prezzi Plasticino (PRIMA MANCAVA)
    - ğŸ’° Prezzi Tapparelle: Include calcolo automatico per Plasticino/New Solar/Estella
    - ğŸ“ Misure FORO (BRM): Usa larghezza foro tapparella per calcoli corretti
    - ğŸ¯ File .xlsx scaricabile con tutti i dettagli prodotti per ogni posizione
    - âœ… Sostituisce vecchio CSV limitato (solo SI/NO prodotti)
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.44 (21 NOV 2025):
    
    âœ… FIX CALCOLO RULLO TAPPARELLE - USA LARGHEZZA FORO (BRM)
    - ğŸ”§ CRITICO: COMP-01 (Rullo) ora usa larghezza FORO (BRM) tapparella specifica
    - ğŸ“ PrioritÃ  misure: tapp.brm.L â†’ tapp.larghezza â†’ pos.L
    - âœ… Fix applicato in Vista Preventivo E Vista Aziende
    - ğŸ’¡ Motivo: Il rullo deve essere calcolato sulla larghezza luce/foro, non misura generica
    - ğŸ” Log aggiornato: Mostra "Misure FORO (BRM)" per debug
    - ğŸ¯ Risultato: Calcolo prezzo rullo ora corretto per ogni tapparella
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.43 (21 NOV 2025):
    
    âœ… FIX TAB INFISSO/PERSIANA VISTA POSIZIONI
    - ğŸ› RISOLTO: Tab Infisso/Persiana non switchavano correttamente
    - ğŸ”§ Fix funzione switchProductTab: aggiunto parametro event
    - âœ… Click su tab ora attiva correttamente il contenuto corrispondente
    - ğŸ¯ Prevenuto bug: tornare su Infisso dopo Persiana ora funziona
    
    âœ… FIX PULSANTI VISTA SEMPRE FISSI
    - ğŸ“Œ CAMBIATO: position da sticky a fixed per garantire persistenza
    - ğŸ¯ Pulsanti Vista (Generale, Posizioni, Aziende, Preventivo) SEMPRE visibili
    - ğŸ“ Aggiunto padding-top 6rem a vista-ufficio per compensare spazio pulsanti
    - ğŸ’¡ Esperienza utente migliorata: navigazione sempre accessibile durante scroll
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.42 (20 NOV 2025):
    
    âœ… FIX PULSANTI VISTA UFFICIO SEMPRE FISSI
    - ğŸ“Œ MODIFICATO: Z-index pulsanti vista aumentato a 999 (sotto header ma sopra contenuto)
    - ğŸ“ OTTIMIZZATO: Top ridotto a 70px per migliore aderenza all'header
    - ğŸ¯ RISULTATO: Pulsanti Vista (Generale, Posizioni, Aziende, Preventivo) sempre visibili sotto header
    - ğŸ’¡ Migliorata UX: Navigazione piÃ¹ veloce tra viste senza scroll
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.41 (20 NOV 2025):
    
    âœ… TAB TAPPARELLE IN GESTIONE LISTINI
    - ğŸšï¸ AGGIUNTO: Nuovo tab "Tapparelle" nel popup Gestione Listini Prezzi
    - ğŸ“‹ Visualizzazione formula calcolo: TOTALE = (L Ã— â‚¬13.20/m) + â‚¬66.40 + Supplemento H
    - ğŸ“Š Tabella componenti completa con tutti i 10 componenti e prezzi
    - ğŸ”§ COMP-01: Rullo Ottagonale 60mm (â‚¬13.20/m sulla larghezza)
    - ğŸ”§ COMP-02 a COMP-10: Componenti fissi totale â‚¬66.40
    - ğŸ’° Supplemento doppia altezza (â‚¬0.50/m se H > 300cm)
    - ğŸ§ª Test calcolo rapido: Input L/H â†’ Calcolo immediato con dettaglio componenti
    - ğŸ¯ Integrato con sistema esistente Plasticino/New Solar/Estella
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.40 (20 NOV 2025):
    
    ğŸ” DEBUG SISTEMA CALCOLO TAPPARELLE VISTA AZIENDE
    - ğŸ“Š AGGIUNTO: Log dettagliati in groupProductsByAzienda per debug prezzi tapparelle
    - ğŸ” Console log: Verifica tipo prodotto, azienda, misure LÃ—H
    - ğŸ” Log se azienda NON matcha con listino Plasticino
    - ğŸ› Identificazione problema: prezzi calcolati ma non visualizzati in Vista Aziende
    - ğŸ¯ Obiettivo: Capire perchÃ© calcolo non parte (condizione, misure, o azienda)
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.39 (20 NOV 2025):
    
    âœ… LISTINO PREZZI TAPPARELLE PLASTICINO
    - ğŸ“‹ AGGIUNTO: Sistema completo calcolo prezzi tapparelle Plasticino/New Solar/Estella
    - ğŸ’° Listino componenti completo: Rullo (â‚¬13.20/m), Componenti fissi (â‚¬66.40), Supplemento H (â‚¬0.50/m)
    - ğŸ§® Funzione calcolaPrezzoPLASTICINO(L_cm, H_cm) con calcolo automatico
    - ğŸ“Š Integrazione Vista Preventivo: tapparelle appaiono automaticamente in tabella prezzi
    - ğŸ”¢ Calcolo dettagliato: Rullo + 10 componenti fissi + supplemento doppia altezza (se H>300cm)
    - ğŸ¯ Compatibile con struttura esistente: aziende plasticino, new solar, estella
    - ğŸ“‚ Database: LISTINO_PLASTICINO con tutti i codici componenti (COMP-01 a COMP-10)
    - âœ… Test: Calcoli verificati con esempi 120Ã—250cm, 150Ã—400cm, 200Ã—250cm
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.38 (20 NOV 2025):
    
    âœ… GESTIONE GUIDE TAPPARELLE
    - ğŸ“œ AGGIUNTO: Campo "Guida Tapparella" nelle configurazioni colonne
    - ğŸ”§ Integrato con sistema esistente tapparelle (azienda, tipo, colore, automazione)
    - âœ… Visualizzazione guida in sezione tapparella Vista Posizioni
    - ğŸ“Š Checkbox controllo visibilitÃ  colonna nelle impostazioni
    - ğŸ“‹ Database guide preparatorio creato (guide-tapparelle-prezzi.js) con listino Plasticino
    - ğŸ’° Pronto per calcoli costi guide in future versioni
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.36 (19 NOV 2025):
    
    âœ… SEMPLIFICAZIONE MENU PRINCIPALE
    - âŒ RIMOSSO: Bottone "Dettaglio Costi" dal menu principale
    - ğŸ¯ Accesso: Dettaglio Costi ora disponibile solo da Ufficio â†’ Preventivo â†’ Toolbar
    - ğŸ“Š Menu: [Generale] [Ufficio] [Apri App Posa] [Conferma Cliente]
    - âš¡ Dashboard piÃ¹ pulita e intuitiva
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.35 (19 NOV 2025):
    
    âœ… RIORGANIZZAZIONE PREVENTIVO E LISTINI
    - ğŸ“Š Vista Preventivo: aggiunto bottone "ğŸ“š Listini"
    - ğŸ“ˆ Vista Preventivo: aggiunto bottone "ğŸ’° Dettaglio Costi"
    - ğŸ”— Bottoni nel toolbar sotto la tabella Excel
    - ğŸ“š Modal "Gestione Listini" separato giÃ  esistente
    - ğŸ¯ Struttura: Ufficio â†’ Preventivo â†’ [Listini] [Dettaglio Costi] [Excel]
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.34 (19 NOV 2025):
    
    âœ… SNELLIMENTO DASHBOARD - ELIMINATO BLOCCO POSA INTERNO
    - âŒ RIMOSSO: Intero blocco-posa dalla dashboard (HTML + funzioni)
    - âœ… SOSTITUITO: Bottone "Posa" â†’ "Apri App Posa"
    - ğŸ”— Click diretto su bottone â†’ apre posa-app-v1_6.html in nuova tab
    - ğŸ¯ Dashboard piÃ¹ leggera: -700+ righe HTML eliminate
    - âš¡ Funzione apriPosaApp() giÃ  esistente e funzionante
    - ğŸ“± Separazione totale: Dashboard (gestione) vs App Posa (campo)
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.33 (19 NOV 2025):
    
    âœ… RISTRUTTURAZIONE "DETTAGLIO COSTI" - NUOVA ORGANIZZAZIONE TAB
    - ğŸ“Š Tab 1: "Riepilogo" (ex "Dettaglio Costi") - Tabella Excel-style con tutti i totali
    - ğŸšª Tab 2: "Persiane" - Listino Punto Persiane + Test Calcolo integrato
    - ğŸ¦Ÿ Tab 3: "Zanzariere" - Listino Palagina completo
    - ğŸªŸ Tab 4: "Infissi" - Placeholder (da implementare con listino Finstral)
    - ğŸ“¦ Tab 5: "Tapparelle" - Placeholder (da implementare)
    - ğŸ“ Tab 6: "Cassonetti" - Placeholder (da implementare)
    - ğŸ¯ Organizzazione logica: prima riepilogo generale, poi dettagli per prodotto
    - âœ… Test Calcolo integrato dentro ogni tab prodotto
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.32 (19 NOV 2025):
    
    âœ… IMPLEMENTATO SISTEMA CALCOLO PERSIANE - STEP 1
    - ğŸ“Š Nuovo listino persiane con griglie dimensionali (Punto Persiane)
    - ğŸ—ï¸ Modelli implementati: NERINA, OSCURA, VANITOSA
    - ğŸ“ Prezzi base da preventivi reali per dimensioni specifiche
    - ğŸ¨ **Sistema colori COMPLETO: 41 colori in 8 categorie (0%-30% maggiorazione)**
    - ğŸ› ï¸ Telai: TH62 (â‚¬136), TH40 (â‚¬167), TH45 (â‚¬187)
    - ğŸ’° Supplementi automatici: Contributo gestione â‚¬57 + Imballo 3%
    - âš™ï¸ Formula calcolo: Base + Telaio + Colore% + Contributo + Imballo
    - ğŸ”„ Sostituito vecchio sistema a prezzo/mq con griglie dimensionali
    - ğŸ“ Fonte dati: Listino Ottobre 2025 + Preventivi P2520726, P2520434
    
    âœ… ğŸ¨ COLORI PERSIANE COMPLETI (41 COLORI)
    - Cat.01 (0%): 7 colori standard (CPF910L, CPF113L, CPF701L, CPF716L, CPF605L, CPF609T, CPF817L)
    - Cat.02A (+3%): 6 colori opachi speciali (CPF735L, CPF609L, CPF621L, CPF119L, CPF524L, CPF811L)
    - Cat.02B (+5%): 6 colori textured (CPF910T, CPF113T, CPF701T, CPF305T, CPF605T, CPF817T)
    - Cat.03 (+20%): 7 colori legno Ezy (CPF820H, CPF818H, CPF813H, CPFR811, CPF812H, CPFN630, CPFN632)
    - Cat.04 (+25%): 3 colori legno Ã‰lite (HD303, HD360, HD366)
    - Cat.05 (+25%): 3 colori sublimato Electo (CPF90RC, CPF91RS, CPF51CR)
    - Cat.06 (+30%): 5 colori sublimato (CPF358R, CPF127R, CPF375R, CPF378R, CPF317R)
    - Cat.07 (+30%): 1 colore speciale (CPF70KA Winchester)
    - Cat.08 (A preventivo): 3 colori speciali (CPFSLV7, CPFRGG4, CPF744L + cambio cabina â‚¬237)
    - ğŸ“‹ Estratti da Listino Punto Persiane 45/52 Ottobre 2025 (pag.124-125)
    
    âœ… ğŸ†• SISTEMA GESTIONE LISTINI
    - ğŸ“š Bottone "Listini" nel menu principale (arancione)
    - ğŸ—ï¸ Tab Persiane: Visualizzazione modelli, dimensioni, telai, colori, supplementi
    - ğŸ¦Ÿ Tab Zanzariere: Listino Palagina completo
    - ğŸ§ª Tab Test Calcolo: Calcolo prezzi in tempo reale con breakdown dettagliato
    - ğŸ¨ Card interattive con hover effects
    - ğŸ“Š Grid responsive per dimensioni/prezzi
    - âš¡ Anteprima calcolo istantanea
    
    âœ… ğŸ†• INSERIMENTO MANUALE PREZZI PERSIANE
    - âš ï¸ Quando dimensione NON trovata in listino â†’ Modale inserimento manuale
    - âœï¸ Form inserimento: Prezzo base, Telaio, Colore%, Note
    - ğŸ§® Anteprima calcolo automatica con breakdown completo
    - ğŸ’¾ Salvataggio in progetto con timestamp e tracciabilitÃ 
    - ğŸ”„ Sync automatico su GitHub
    - ğŸ·ï¸ Badge "(MANUALE)" per prezzi inseriti manualmente
    - ğŸ“ Formula calcolo consistente: Base + Telaio + Colore% + Contributo + Imballo
    - âœ… PrioritÃ : Prezzo Manuale â†’ Listino â†’ Errore con bottone inserimento
    
    FUNZIONI MODIFICATE:
    - calcolaPersiana(): Nuovo sistema con griglia dimensioni + tipologie (F1, F2, PF2)
    - Listino persiane: Struttura gerarchica modelli â†’ prezzi â†’ tipologie â†’ dimensioni
    - Supporto parametro "tipologia" per selezione corretta griglia prezzi
    - Gestione prezzi manuali con oggetto completo (base, telaio, colore, supplementi)
    
    FUNZIONI AGGIUNTE:
    - apriGestioneListini(): Apre modale gestione listini
    - switchTabListini(): Switch tra tab persiane/zanzariere/test
    - eseguiTestCalcolo(): Test calcolo prezzi in tempo reale
    - apriModalPrezzoManuale(): Apre modale inserimento manuale
    - calcolaAnteprimaManuale(): Calcola anteprima con valori manuali
    - salvaPrezzoManuale(): Salva prezzo manuale nel progetto + sync GitHub
    
    â³ PROSSIMI STEP:
    - [ ] STEP 2: Estrazione griglie complete da PDF per NERINA, OSCURA, VANITOSA
    - [ ] STEP 3: Aggiunta altri modelli (ANGELA, GIULIA, LUNA, AURORA)
    - [ ] STEP 4: Lista completa colori categorie 1-8
    - [ ] STEP 5: Integrazione in App rilievo v4.33
    - [ ] Badge "MANUALE" visivo in preventivi PDF
    - [ ] Pagina gestione prezzi manuali (modifica/elimina)
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.31 (19 NOV 2025):
    
    âœ… INTEGRAZIONE POSA APP v1.6 - TOKEN PERSONALI & DEPLOYMENT
    - ğŸ”— AGGIORNATO: Collegamento a posa-app-v1_6.html (era v1_5.html)
    - ğŸ”‘ Posa App ora usa token GitHub personali (no hardcoded)
    - ğŸ‘¤ Sistema multi-utente sicuro con autenticazione
    - ğŸ“± Ottimizzazione smartphone completa (touch targets 48px)
    - ğŸšª Logout button integrato per cambio utente
    - ğŸ¯ Pronto per deployment GitHub Pages multi-repository
    - ğŸ“š Documentazione completa deployment inclusa
    - âœ… Testing locale completato
    - ğŸš€ Production-ready per squadra campo
    
    NOVITÃ€ POSA APP v1.6:
    - Token personali salvati in localStorage (sicurezza)
    - Schermata login elegante con istruzioni integrate
    - Validazione formato token (ghp_/github_pat_)
    - Pulsante logout con conferma
    - Media query responsive smartphone (320px-480px)
    - Font 16px per prevenire zoom iOS
    - Touch targets conformi Apple HIG
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.30 (19 NOV 2025):
    
    âœ… SEMPLIFICAZIONE BLOCCO POSA - COLLEGAMENTO APP DEDICATA
    - âŒ RIMOSSO: Intero blocco Posa dalla dashboard (Vista Generale, Posizioni, Dettaglio)
    - âœ… SOSTITUITO: Card informativa con collegamento diretto alla Posa App
    - ğŸ”— Bottone centrale "Apri Posa App" per accesso immediato
    - ğŸ“± Mostra funzionalitÃ  disponibili nell'app (4 viste principali)
    - ğŸ¯ Dashboard focalizzata su: Generale, Ufficio, Analisi Costi, Conferma Cliente
    - ğŸ”§ Posa App gestisce: Vista Posizione, Prodotto, Azienda, Editing
    - ğŸš€ Migliore separazione responsabilitÃ : Dashboard (gestione) vs App (campo)
    - âš¡ Dashboard piÃ¹ leggera: -77 righe HTML eliminato codice obsoleto
    - ğŸ“Š Layout responsive con grid 4 funzionalitÃ 
    - ğŸ¨ Styling coordinato arancione
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.29 (19 NOV 2025):
    
    âœ… INTEGRAZIONE POSA APP SEPARATA
    - Nuovo bottone nel Blocco Posa: "ğŸ”— Apri App Separata"
    - Header dedicato con styling arancione coordinato
    - Funzione apriPosaApp(): apre posa-app-v1_6.html in nuova finestra
    - Passaggio automatico project ID via localStorage
    - Verifica progetto caricato prima apertura
    - Gestione popup bloccati con messaggio utente
    - Finestra ottimizzata: 1400Ã—900px
    - CSS responsive con hover/active states
    - Console log per debugging
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.28 (18 NOV 2025):
    
    âœ… RINOMINA "PREVENTIVO" â†’ "ANALISI COSTI"
    - Bottone menu: ğŸ’° Preventivo â†’ ğŸ“ˆ Analisi Costi
    - Modale: "Preventivo Commessa" â†’ "Analisi Costi Commessa"
    - Scopo: uso interno operatore per calcoli dettagliati
    
    âœ… SISTEMA CONFERMA CLIENTE (in sviluppo)
    - Nuovo documento separato da Analisi Costi
    - Layout 1 pagina per posizione
    - Colonne selezionabili (infissi, persiane, prezzi, ecc)
    - Prezzi opzionali/editabili (integrazione Odoo)
    - Export PDF professionale
    - Menu impostazioni colonne + quick toggles
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.27 (18 NOV 2025):
    
    âœ… MENU DINAMICO CON INDICATORI COMPLETAMENTO
    - Indicatori colorati per ogni sezione: ğŸŸ¢ 100%, ğŸŸ¡ 50-99%, ğŸ”´ 1-49%, âšª 0%
    - Calcolo automatico completamento Generale (6 campi)
    - Calcolo automatico completamento Ufficio (configurazioni prodotti)
    - Calcolo automatico completamento Posa (posizioni con prodotti)
    - Calcolo automatico completamento Preventivo (presenza prezzi)
    - Aggiornamento real-time al caricamento progetto
    - Aggiornamento dopo import JSON e sync GitHub
    
    âœ… FUNZIONI AGGIUNTE
    - calcolaCompletamentoGenerale(): verifica dati cliente/progetto
    - calcolaCompletamentoUfficio(): verifica config prodotti (infissi, persiane, ecc)
    - calcolaCompletamentoPosa(): verifica posizioni con quantitÃ  prodotti
    - calcolaCompletamentoPreventivo(): verifica presenza prezzi
    - aggiornaMenuIndicatori(): aggiorna tutti gli indicatori menu
    - getColoreIndicatore(): restituisce colore in base a percentuale
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.26 (18 NOV 2025):
    
    âœ… INTEGRATO DATABASE MANIGLIE FINSTRAL COMPLETO
    - Database completo da catalogo EUR 2025/3 Finstral (1075 righe)
    - 67 maniglie complete (Serie 1-4, 11-16)
    - 13 colori ufficiali con codici
    - Funzioni helper: getManigliaByCode(), getSupplemento(), getColoreDescrizione()
    
    âœ… FUNZIONI PARSING MANIGLIE (CompatibilitÃ  App v4.31-v4.32)
    - estraiCodiceManiglia(): estrae "6010" da "6010 - Finestra alluminio"
    - estraiCodiceColore(): estrae "07" da "07 - Bianco perla"
    - calcolaSupplementoManigliaFinstral(): calcolo supplementi con database
    - calcolaSupplementoManigliaVecchio(): fallback per progetti vecchi
    
    âœ… CALCOLO SUPPLEMENTI MANIGLIE
    - Supporta formato nuovo App v4.31+: "6010 - Finestra alluminio" + "07 - Bianco perla"
    - Supporta formato vecchio App v4.30-: "standard", "inox", "design", ecc.
    - Calcolo automatico supplementi base + supplementi extra per colori speciali
    - Esempi: 6010+07 = â‚¬19.6, 6020+56 = â‚¬64.4, 1901+M01 = â‚¬31.3
    
    âœ… MODIFICHE TECNICHE
    - Riga ~3900: Database MANIGLIE_FINSTRAL incluso (dopo tag script)
    - Riga ~8560: Funzioni parsing maniglie/colori
    - Riga ~8818: Lettura infisso.maniglia + infisso.coloreManiglia
    - Riga ~8730: Vecchia funzione calcolaSupplementoManiglia() deprecata
    - Riga ~8560: SUPPLEMENTI_MANIGLIE vecchio commentato
    
    âœ… COMPATIBILITÃ€
    - Progetti vecchi (pre-v4.31): funzionano con supplementi fissi
    - Progetti nuovi (v4.31+): calcolo supplementi preciso da database
    - Colori custom (es: RAL speciali): riconosciuti e visualizzati
    - Dashboard riconosce automaticamente formato vecchio vs nuovo
    
    â³ PROSSIMI SVILUPPI
    - [ ] Aggiungere colonne "Maniglia" e "Colore" nella tabella (se richiesto)
    - [ ] Visualizzare descrizioni complete maniglie/colori (non solo supplemento)
    - [ ] Export Excel con dettagli maniglie complete
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -->
    
    <title>Dashboard Rilievi v8.26 - Ricarico 50%, ENEA Ecobonus</title>
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // âœ… VERSIONE CENTRALIZZATA - MODIFICARE SOLO QUI!
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const DASHBOARD_VERSION = "8.26";
        const DASHBOARD_DATE = "05 DIC 2025";
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”„ FUNZIONE AGGIORNAMENTO VERSIONE AUTOMATICO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function updateDashboardVersion() {
            const v = DASHBOARD_VERSION;
            const d = DASHBOARD_DATE;
            
            // 1. Title pagina
            document.title = `Dashboard Rilievi v${v} - Calcolo Completo`;
            
            // 2. Badge versione nell'header
            const versionBadge = document.getElementById('version-badge');
            if (versionBadge) versionBadge.textContent = `v${v}`;
            
            // 3. Tutti gli elementi con classe 'dashboard-version'
            document.querySelectorAll('.dashboard-version').forEach(el => {
                el.textContent = `v${v}`;
            });
            
            // 4. Tutti gli elementi con data-version
            document.querySelectorAll('[data-version]').forEach(el => {
                el.setAttribute('data-version', v);
                if (el.dataset.versionText === 'true') {
                    el.textContent = `v${v}`;
                }
            });
            
            // 5. Console log
            console.log(`ğŸš€ Dashboard Rilievi v${v} (${d}) - Caricato`);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ› ï¸ FUNZIONI UTILITÃ€ VERSIONING (usabili da console per debug)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Mostra versione corrente
        function getVersion() {
            console.log(`ğŸ“‹ Versione attuale: ${DASHBOARD_VERSION} (${DASHBOARD_DATE})`);
            return { version: DASHBOARD_VERSION, date: DASHBOARD_DATE };
        }
        
        // Calcola prossima versione (per Claude/sviluppatore)
        function nextVersion(tipo = 'patch') {
            const parts = DASHBOARD_VERSION.split('.');
            let major = parseInt(parts[0]);
            let minor = parseInt(parts[1]);
            
            if (tipo === 'minor') {
                // +0.10 (es: 7.79 â†’ 7.89)
                minor += 10;
                if (minor >= 100) { major++; minor = minor - 100; }
            } else {
                // +0.01 (es: 7.79 â†’ 7.80)
                minor += 1;
                if (minor >= 100) { major++; minor = 0; }
            }
            
            const newVersion = `${major}.${minor.toString().padStart(2, '0')}`;
            console.log(`ğŸ“ˆ Prossima versione (${tipo}): ${DASHBOARD_VERSION} â†’ ${newVersion}`);
            console.log(`ğŸ“ Aggiorna riga ~942: const DASHBOARD_VERSION = "${newVersion}";`);
            return newVersion;
        }
        
        // Verifica tutti i punti con versione
        function checkVersionPoints() {
            const v = DASHBOARD_VERSION;
            const points = [];
            
            // Title
            points.push({ 
                element: 'title', 
                value: document.title, 
                correct: document.title.includes(`v${v}`)
            });
            
            // Badge header
            const badge = document.getElementById('version-badge');
            if (badge) {
                points.push({ 
                    element: 'version-badge', 
                    value: badge.textContent, 
                    correct: badge.textContent.includes(v)
                });
            }
            
            // Elementi con classe
            document.querySelectorAll('.dashboard-version').forEach((el, i) => {
                points.push({ 
                    element: `.dashboard-version[${i}]`, 
                    value: el.textContent, 
                    correct: el.textContent.includes(v)
                });
            });
            
            console.table(points);
            const allCorrect = points.every(p => p.correct);
            console.log(allCorrect ? 'âœ… Tutte le versioni corrette!' : 'âŒ Alcune versioni non aggiornate!');
            return allCorrect;
        }
        
        // Aggiorna appena DOM Ã¨ pronto
        document.addEventListener('DOMContentLoaded', updateDashboardVersion);
        
        // Esponi funzioni globalmente per uso da console
        window.dashboardVersion = {
            get: getVersion,
            next: nextVersion,
            check: checkVersionPoints,
            update: updateDashboardVersion,
            current: DASHBOARD_VERSION,
            date: DASHBOARD_DATE
        };
    </script>
    <style>
        /* ================================================================================
           RESET E BASE
           ================================================================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* FIX iPad/Touch - Tutti elementi cliccabili */
        button,
        a,
        label,
        input[type="checkbox"],
        input[type="radio"],
        select,
        [onclick],
        [role="button"] {
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
            line-height: 1.6;
        }

        /* ================================================================================
           HEADER E NAVIGAZIONE PRINCIPALE
           ================================================================================ */
        .header {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
        }

        .logo-version {
            font-size: 0.7rem;
            color: #fff;
            font-weight: 600;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }
        
        .logo-subtitle {
            font-size: 0.75rem;
            color: #718096;
            font-weight: 400;
            margin-left: 4px;
        }

        .main-nav {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .nav-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: #e2e8f0;
            color: #4a5568;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s;
            /* FIX iPad/Touch */
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            user-select: none;
            -webkit-user-select: none;
        }
        
        /* Spazio extra dopo Ufficio */
        .nav-btn.blocco-ufficio {
            margin-right: 1rem;
        }
        
        /* Spazio extra dopo Posa */
        .nav-btn.blocco-posa {
            margin-right: 0.5rem;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .nav-btn.active {
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
        }

        .nav-btn.active.blocco-generale {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .nav-btn.active.blocco-ufficio {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .nav-btn.active.blocco-posa {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        /* Bottone Analisi Costi (ex Preventivo) */
        .nav-btn#btn-preventivo:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .nav-btn#btn-preventivo:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        /* Bottone Conferma Cliente */
        .nav-btn#btn-conferma-cliente:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .nav-btn#btn-conferma-cliente:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        /* Completion badges sui bottoni top nav */
        .nav-btn .completion-badge {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 700;
            transition: all 0.2s;
        }

        .nav-btn:hover .completion-badge {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .nav-btn.active .completion-badge {
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* âœ… INDICATORI PERCENTUALE MENU DINAMICO v7.27 */
        .indicator-percentage {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }

        .nav-btn:hover .indicator-percentage {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .nav-btn.active .indicator-percentage {
            background: rgba(255, 255, 255, 0.25);
        }

        /* ================================================================================
           MENU AVANZATO - SIDEBAR E BREADCRUMB
           ================================================================================ */
        
        /* Toggle button hamburger menu - SEMPRE VISIBILE */
        .menu-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            padding: 0.5rem;
            font-size: 1.8rem;
            cursor: pointer;
            color: #4a5568;
            transition: all 0.2s;
            margin-right: 1rem;
        }

        .menu-toggle:hover {
            color: #667eea;
            transform: scale(1.1);
        }


        /* ================================================================================
           CONTAINER PRINCIPALE
           ================================================================================ */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
        }

        /* ================================================================================
           BLOCCHI CONTENUTO (nascosti di default)
           ================================================================================ */
        .blocco {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .blocco.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ================================================================================
           CARD GENERICHE
           ================================================================================ */
        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #1a202c;
        }

        .card-subtitle {
            font-size: 1rem;
            color: #718096;
            margin-bottom: 1.5rem;
        }

        /* ================================================================================
           ZONA IMPORT JSON
           ================================================================================ */
        .import-zone {
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            background: #f7fafc;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .import-zone:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .import-zone.drag-over {
            border-color: #667eea;
            background: #e6f2ff;
            transform: scale(1.02);
        }

        .import-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .import-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #2d3748;
        }

        .import-subtitle {
            color: #718096;
            margin-bottom: 1.5rem;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        /* Input file nascosto */
        #jsonFileInput {
            display: none;
        }

        /* ================================================================================
           STATO DATI
           ================================================================================ */
        .data-status {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 2rem;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-badge.success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-badge.info {
            background: #dbeafe;
            color: #1e40af;
        }

        /* ================================================================================
           VISTA POSIZIONI UFFICIO - LAYOUT
           ================================================================================ */
        .positions-layout {
            display: flex;
            gap: 1.5rem;
            min-height: 600px;
        }

        /* Sidebar Posizioni */
        .positions-sidebar {
            width: 280px;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            position: sticky;
            top: 100px;
        }

        .positions-sidebar-title {
            font-size: 1rem;
            font-weight: 700;
            color: #10b981;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Filtri sidebar */
        .positions-filters {
            margin-bottom: 1.5rem;
        }

        .filter-group {
            margin-bottom: 1rem;
        }

        .filter-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.5rem;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Lista posizioni */
        .positions-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .position-list-item {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .position-list-item:hover {
            border-color: #10b981;
            transform: translateX(4px);
        }

        .position-list-item.active {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-color: #10b981;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        .position-item-id {
            font-size: 0.85rem;
            font-weight: 700;
            color: #10b981;
        }

        .position-item-details {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Card Dettaglio Posizione */
        .position-detail {
            flex: 1;
            min-width: 0;
        }

        /* Config Globale Card */
        .config-globale-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid #f59e0b;
            margin-bottom: 1.5rem;
        }

        .config-globale-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 1.25rem 1.5rem;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .config-globale-header:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        }

        .config-globale-title {
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .config-globale-toggle {
            font-size: 1.5rem;
            transition: transform 0.3s ease;
        }

        .config-globale-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .config-globale-content {
            padding: 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .config-globale-content.collapsed {
            display: none;
        }

        .config-item {
            background: #fef3c7;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border-left: 3px solid #f59e0b;
        }

        .config-item-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .config-item-value {
            font-size: 1rem;
            color: #1f2937;
            font-weight: 500;
        }
        
        .config-item-value-empty {
            color: #9ca3af;
            font-style: italic;
            font-weight: 400;
        }
        
        /* ğŸ†• v7.94: Config Globale DENTRO i tabs prodotto */
        .config-globale-intab {
            background: #fffbeb;
            border-radius: 8px;
            border: 1px solid #fcd34d;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        .config-globale-header-intab {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .config-globale-header-intab:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        }
        
        .config-globale-title-intab {
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .config-globale-toggle-intab {
            font-size: 1rem;
            transition: transform 0.3s ease;
        }
        
        .config-globale-toggle-intab.collapsed {
            transform: rotate(-90deg);
        }
        
        .config-globale-content-intab {
            padding: 0.75rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.5rem;
        }
        
        .config-globale-content-intab.collapsed {
            display: none;
        }
        
        .config-item-intab {
            background: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            border-left: 3px solid #f59e0b;
        }
        
        .config-item-label-intab {
            font-size: 0.7rem;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.15rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .config-item-value-intab {
            font-size: 0.85rem;
            color: #1f2937;
            font-weight: 500;
        }
        
        .config-item-value-intab.empty {
            color: #9ca3af;
            font-style: italic;
            font-weight: 400;
        }

        /* ============================================================
           MENU CONFIGURAZIONE PRODOTTI - v7.78
           ============================================================ */

        /* Container principale config */
        .config-menu-container {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        /* Tabs categorie prodotti */
        .config-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .config-tab {
            padding: 0.75rem 1.25rem;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            color: #9ca3af;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .config-tab:hover {
            background: rgba(59, 130, 246, 0.2);
            color: #e5e7eb;
        }

        .config-tab.active {
            background: rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
            color: #60a5fa;
        }

        /* Pannelli config */
        .config-panel {
            display: none;
        }

        .config-panel.active {
            display: block;
        }

        /* Grid campi config */
        .config-fields-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        /* Singolo campo config */
        .config-field {
            background: rgba(17, 24, 39, 0.5);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid rgba(55, 65, 81, 0.5);
        }

        .config-field-label {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        /* Select con stile */
        .config-select {
            width: 100%;
            padding: 0.75rem;
            background: #1f2937;
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 6px;
            color: #e5e7eb;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .config-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* Input custom */
        .config-custom-input {
            width: 100%;
            padding: 0.75rem;
            background: #1f2937;
            border: 1px solid rgba(59, 130, 246, 0.5);
            border-radius: 6px;
            color: #e5e7eb;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            box-sizing: border-box;
        }

        .config-custom-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .config-custom-input.hidden {
            display: none;
        }

        /* Indicatore valore modificato */
        .config-field.modified {
            border-color: rgba(251, 191, 36, 0.5);
        }

        .config-field.modified .config-field-label::after {
            content: ' âœ“';
            color: #fbbf24;
        }

        /* Bottoni azioni */
        .config-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }

        .config-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .config-btn-save {
            background: #10b981;
            color: white;
            border: none;
        }

        .config-btn-save:hover {
            background: #059669;
        }

        .config-btn-reset {
            background: transparent;
            color: #9ca3af;
            border: 1px solid rgba(75, 85, 99, 0.5);
        }

        .config-btn-reset:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.5);
            color: #f87171;
        }

        .position-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid #10b981;
        }

        /* Header Posizione */
        .position-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px 12px 0 0;
        }

        .position-id-large {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .position-location {
            font-size: 1.1rem;
            opacity: 0.95;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .position-location-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .position-qty {
            margin-top: 0.5rem;
            font-size: 0.95rem;
            opacity: 0.9;
        }

        /* Sezioni Posizione */
        .position-section {
            padding: 2rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .position-section:last-child {
            border-bottom: none;
        }

        .position-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .position-section-icon {
            color: #10b981;
            font-size: 1.3rem;
        }

        /* Tabella Misure */
        .measures-table {
            width: 100%;
            border-collapse: collapse;
        }

        .measures-table th {
            background: #f9fafb;
            padding: 0.75rem;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 2px solid #e5e7eb;
        }

        .measures-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.95rem;
        }

        .measure-label {
            font-weight: 600;
            color: #4b5563;
        }

        .measure-value {
            color: #10b981;
            font-weight: 600;
            font-size: 1.05rem;
        }

        .measure-highlight {
            background: #ecfdf5;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        /* Grid caratteristiche muro */
        .wall-chars-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .wall-char-item {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .wall-char-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .wall-char-value {
            font-size: 1rem;
            color: #1f2937;
            font-weight: 500;
        }

        .override-badge {
            display: inline-block;
            background: #fef3c7;
            color: #92400e;
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* Prodotti tabs */
        .products-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .product-tab {
            padding: 0.75rem 1.25rem;
            border: none;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .product-tab:hover {
            color: #10b981;
        }

        .product-tab.active {
            color: #10b981;
            border-bottom-color: #10b981;
        }

        .product-content {
            display: none;
        }

        .product-content.active {
            display: block;
        }

        /* BRM Box */
        .brm-box {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .brm-title {
            font-size: 1rem;
            font-weight: 700;
            color: #10b981;
            margin-bottom: 1rem;
            text-align: center;
        }

        .brm-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .brm-item {
            text-align: center;
        }

        .brm-label {
            font-size: 0.85rem;
            color: #6b7280;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .brm-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #10b981;
        }

        /* Tag notes */
        .notes-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .note-tag {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .note-tag.urgente {
            background: #fee2e2;
            color: #991b1b;
        }

        .note-tag.verificare {
            background: #fef3c7;
            color: #92400e;
        }

        .note-tag.richiesta {
            background: #dbeafe;
            color: #1e40af;
        }

        .note-tag.problema {
            background: #fce7f3;
            color: #831843;
        }

        .notes-content {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            border-left: 3px solid #10b981;
        }

        /* Navigazione Posizioni */
        .position-navigation {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            padding: 1.5rem;
            background: #f9fafb;
            border-radius: 0 0 12px 12px;
        }

        .nav-btn-position {
            flex: 1;
            padding: 1rem;
            border: 2px solid #10b981;
            background: white;
            color: #10b981;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .nav-btn-position:hover:not(:disabled) {
            background: #10b981;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.25);
        }

        .nav-btn-position:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .positions-layout {
                flex-direction: column;
            }

            .positions-sidebar {
                width: 100%;
                max-height: none;
                position: relative;
                top: 0;
            }

            .brm-grid {
                grid-template-columns: 1fr;
            }

            .wall-chars-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ================================================================================
           PLACEHOLDER CONTENUTO BLOCCHI
           ================================================================================ */
        .placeholder {
            text-align: center;
            padding: 4rem 2rem;
            color: #718096;
        }

        .placeholder-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .placeholder-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #4a5568;
        }

        .placeholder-text {
            font-size: 1rem;
            color: #718096;
        }

        /* ================================================================================
           SUBMENU BLOCCO UFFICIO
           ================================================================================ */
        .submenu-ufficio {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            padding: 1rem;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border-radius: 12px;
            border: 2px solid #d1fae5;
            position: fixed;  /* Cambiato da sticky a fixed */
            top: 70px;
            left: 0;
            right: 0;
            max-width: 1400px;  /* Stesso max-width del container */
            margin-left: auto;
            margin-right: auto;
            z-index: 999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Header Blocco Posa con bottone App - v7.29 */
        .blocco-posa-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
            border-radius: 12px;
            border: 2px solid #fb923c;
            margin-bottom: 1.5rem;
        }

        .blocco-posa-header h2 {
            margin: 0;
            color: #9a3412;
            font-size: 1.75rem;
            font-weight: 700;
        }

        .btn-posa-app {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-posa-app:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
        }

        .btn-posa-app:active {
            transform: translateY(0);
        }

        /* Submenu Posa - v7.20 */
        .submenu-posa {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            padding: 1rem;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px;
            border: 2px solid #fbbf24;
            position: sticky;
            top: 80px;
            z-index: 900;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .submenu-btn-posa {
            padding: 1rem 1.75rem;
            border: 2px solid #fbbf24;
            background: white;
            color: #d97706;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex: 1;
            min-width: 180px;
            text-align: center;
        }

        .submenu-btn-posa:hover {
            border-color: #f59e0b;
            color: #f59e0b;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(245, 158, 11, 0.2);
        }

        .submenu-btn-posa.active {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-color: #f59e0b;
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
            transform: scale(1.05);
        }

        .submenu-btn {
            padding: 1rem 1.75rem;
            border: 2px solid #d1fae5;
            background: white;
            color: #059669;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex: 1;
            min-width: 180px;
            text-align: center;
        }

        .submenu-btn:hover {
            border-color: #10b981;
            color: #10b981;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(16, 185, 129, 0.2);
        }

        .submenu-btn.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #10b981;
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
            transform: scale(1.05);
        }

        /* Vista Ufficio - Contenitori */
        .vista-ufficio {
            display: none !important;
        }

        .vista-ufficio.active {
            display: block !important;
            animation: fadeIn 0.3s ease-in;
            padding-top: 6rem;  /* Spazio per pulsanti fissi (submenu-ufficio) */
        }

        /* Contenuto nascosto - v7.20 */
        .content-hidden {
            display: none !important;
        }

        /* ================================================================================
           SEZIONI VISTA GENERALE UFFICIO
           ================================================================================ */
        
        /* Card Ufficio con tema verde */
        .card-ufficio {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            border-left: 4px solid #10b981;
        }

        .card-ufficio-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #1a202c;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-ufficio-icon {
            color: #10b981;
            font-size: 1.5rem;
        }

        /* Grid info cliente */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .info-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 1rem;
            color: #1f2937;
            font-weight: 500;
        }

        .info-value-large {
            font-size: 1.1rem;
            font-weight: 600;
            color: #10b981;
        }

        /* Note progetto */
        .note-box {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            border-left: 3px solid #10b981;
        }

        .note-box-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .note-box-content {
            font-size: 0.95rem;
            color: #4b5563;
            line-height: 1.6;
        }

        /* Totali commessa */
        .totali-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .totale-item {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-radius: 10px;
            padding: 1.25rem 1rem;
            text-align: center;
            border: 1px solid #a7f3d0;
        }

        .totale-numero {
            font-size: 2rem;
            font-weight: 700;
            color: #065f46;
            line-height: 1;
        }

        .totale-label {
            font-size: 0.85rem;
            color: #047857;
            margin-top: 0.5rem;
            font-weight: 600;
        }

        /* Riepilogo economico lista */
        .economico-list {
            background: #f9fafb;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #e5e7eb;
        }
        
        .economico-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .economico-item:last-child {
            border-bottom: none;
        }
        
        .economico-item.totale {
            border-top: 2px solid #10b981;
            margin-top: 0.5rem;
            padding-top: 1rem;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .economico-label {
            color: #4b5563;
            font-weight: 500;
        }
        
        .economico-item.totale .economico-label {
            color: #059669;
        }
        
        .economico-value {
            color: #1f2937;
            font-weight: 600;
            font-size: 1.05rem;
        }
        
        .economico-item.totale .economico-value {
            color: #059669;
            font-size: 1.25rem;
        }

        /* === v7.80: Sezione Economico in Config Globale === */
        .config-economico-section {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 2px dashed #e5e7eb;
        }
        
        .config-economico-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #059669;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .config-economico-grid {
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #d1fae5;
        }
        
        .config-eco-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #d1fae5;
        }
        
        .config-eco-row:last-child {
            border-bottom: none;
        }
        
        .config-eco-row.totale {
            margin-top: 0.5rem;
            padding-top: 0.75rem;
            border-top: 2px solid #059669;
            font-weight: 700;
            font-size: 1.05rem;
            color: #059669;
        }
        
        .config-eco-cat {
            color: #374151;
            font-size: 0.9rem;
        }
        
        .config-eco-val {
            font-family: 'SF Mono', Monaco, monospace;
            font-weight: 600;
            color: #047857;
        }

        /* Timeline stato avanzamento */
        .timeline {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 3px solid #d1d5db;
        }

        .timeline-item.completed {
            background: #ecfdf5;
            border-left-color: #10b981;
        }

        .timeline-icon {
            font-size: 1.5rem;
            min-width: 40px;
            text-align: center;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .timeline-subtitle {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .timeline-percentage {
            font-size: 1.25rem;
            font-weight: 700;
            color: #10b981;
        }

        /* ================================================================================
           ALERT/NOTIFICHE
           ================================================================================ */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        /* ================================================================================
           RESPONSIVE
           ================================================================================ */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .main-nav {
                width: 100%;
                flex-direction: column;
            }

            .nav-btn {
                width: 100%;
            }

            .container {
                padding: 0 1rem;
            }

            .card {
                padding: 1.5rem;
            }
        }

        /* ================================================================================
           LOADING SPINNER
           ================================================================================ */
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ================================================================================
           KPI CARDS
           ================================================================================ */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .kpi-card.green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .kpi-card.orange {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .kpi-card.teal {
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
        }

        .kpi-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .kpi-subtitle {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* ================================================================================
           FILTRI
           ================================================================================ */
        .filters-container {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            min-width: 150px;
        }

        .filter-group.search-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #4a5568;
        }

        .filter-group select,
        .filter-group input {
            padding: 0.5rem;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 0.95rem;
            background: white;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* ================================================================================
           TABELLA
           ================================================================================ */
        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table thead {
            background: #f7fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        .data-table th {
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #2d3748;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .data-table th:hover {
            background: #edf2f7;
        }

        .data-table th.sortable::after {
            content: 'â‡…';
            margin-left: 0.5rem;
            opacity: 0.3;
        }

        .data-table th.sorted-asc::after {
            content: 'â†‘';
            opacity: 1;
        }

        .data-table th.sorted-desc::after {
            content: 'â†“';
            opacity: 1;
        }

        .data-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table tbody tr:hover {
            background: #f7fafc;
        }

        .product-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
        }

        .product-badge.infisso {
            background: #dbeafe;
            color: #1e40af;
        }

        .product-badge.persiana {
            background: #d1fae5;
            color: #065f46;
        }

        .product-badge.tapparella {
            background: #fef3c7;
            color: #92400e;
        }

        .product-badge.zanzariera {
            background: #e0e7ff;
            color: #3730a3;
        }

        .product-badge.cassonetto {
            background: #fed7aa;
            color: #92400e;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #718096;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* ================================================================================
           VISTA AZIENDE - STILI
           ================================================================================ */
        .aziende-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .azienda-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .azienda-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            border-color: #10b981;
        }

        .azienda-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .azienda-header-left {
            flex: 1;
        }

        .azienda-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .azienda-name-icon {
            font-size: 1.75rem;
        }

        .azienda-stats {
            display: flex;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .azienda-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6b7280;
            font-size: 0.95rem;
        }

        .azienda-stat-value {
            font-weight: 600;
            color: #10b981;
        }

        .azienda-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .azienda-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            background: #ecfdf5;
            color: #059669;
        }

        .azienda-badge.infissi { background: #dbeafe; color: #1e40af; }
        .azienda-badge.tapparelle { background: #fef3c7; color: #92400e; }
        .azienda-badge.motori { background: #fef3c7; color: #b45309; border: 2px solid #f59e0b; font-weight: 700; }
        .azienda-badge.persiane { background: #f3e8ff; color: #6b21a8; }
        .azienda-badge.cassonetti { background: #fce7f3; color: #9f1239; }
        .azienda-badge.zanzariere { background: #ecfccb; color: #3f6212; }

        /* ===================================== */
        /* NUOVI STILI: TAB ORIZZONTALI AZIENDE */
        /* ===================================== */
        
        .aziende-tabs-container {
            margin-bottom: 2rem;
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .aziende-tabs {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: stretch;
        }

        .azienda-tab {
            flex: 1;
            min-width: 180px;
            max-width: 250px;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 1.25rem 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
            overflow: hidden;
        }

        .azienda-tab:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #10b981, #059669);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .azienda-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #10b981;
        }

        .azienda-tab.active {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-color: #10b981;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.2);
            transform: translateY(-2px);
        }

        .azienda-tab.active:before {
            transform: scaleX(1);
        }

        .azienda-tab-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .azienda-tab-content {
            flex: 1;
            min-width: 0;
        }

        .azienda-tab-name {
            font-size: 1rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .azienda-tab.active .azienda-tab-name {
            color: #059669;
        }

        .azienda-tab-count {
            font-size: 0.85rem;
            font-weight: 600;
            color: #6b7280;
        }

        .azienda-tab.active .azienda-tab-count {
            color: #047857;
        }

        .aziende-details-container {
            position: relative;
        }

        .azienda-details {
            display: none;
            animation: fadeInUp 0.4s ease;
        }

        .azienda-details.active {
            display: block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive: Stack tabs verticalmente su mobile */
        @media (max-width: 768px) {
            .aziende-tabs {
                flex-direction: column;
            }
            
            .azienda-tab {
                max-width: 100%;
            }
        }

        /* Tabella prodotti azienda */
        .azienda-prodotti-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .azienda-prodotti-table thead {
            background: #f9fafb;
        }

        .azienda-prodotti-table th {
            padding: 1rem;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            border-bottom: 2px solid #e5e7eb;
        }

        .azienda-prodotti-table td {
            padding: 1rem;
            color: #374151;
            border-bottom: 1px solid #f3f4f6;
        }

        .azienda-prodotti-table tbody tr:hover {
            background: #f9fafb;
        }

        .azienda-prodotti-table tbody tr:last-child td {
            border-bottom: none;
        }

        .product-type-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .product-type-badge.infisso { background: #dbeafe; color: #1e40af; }
        .product-type-badge.tapparella { background: #fef3c7; color: #92400e; }
        .product-type-badge.motore { background: #fef3c7; color: #b45309; border: 2px solid #f59e0b; }
        .product-type-badge.persiana { background: #f3e8ff; color: #6b21a8; }
        .product-type-badge.accessorio { background: #e0e7ff; color: #4338ca; }
        .product-type-badge.cassonetto { background: #fce7f3; color: #9f1239; }
        .product-type-badge.zanzariera { background: #ecfccb; color: #3f6212; }

        .product-positions {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }

        .position-tag {
            display: inline-block;
            background: #e5e7eb;
            color: #4b5563;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* âŒ RIMOSSO v7.20: CSS Totali azienda (non piÃ¹ utilizzati) */

        /* Azioni azienda */
        .azienda-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .azienda-action-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid #10b981;
            background: white;
            color: #10b981;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .azienda-action-btn:hover {
            background: #10b981;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(16,185,129,0.2);
        }

        .azienda-action-btn.primary {
            background: #10b981;
            color: white;
        }

        .azienda-action-btn.primary:hover {
            background: #059669;
        }

        /* Note fornitore */
        .azienda-note {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }

        .azienda-note-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .azienda-note-content {
            color: #78350f;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .azienda-note textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 80px;
        }

        .azienda-note textarea:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16,185,129,0.1);
        }

        /* ================================================================================
           VISTA PREVENTIVO - TABELLA STILE EXCEL
           ================================================================================ */
        
        /* ğŸ”§ v8.09: Tabella preventivo FULL-WIDTH senza scroll */
        .excel-container {
            width: 100%;
            overflow-x: visible;  /* No scroll */
            background: white;
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.7rem;  /* Font compatto */
            background: white;
            table-layout: fixed;  /* Colonne proporzionali */
        }

        .excel-table thead {
            background: #1e3a8a;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .excel-table th {
            padding: 0.4rem 0.15rem;  /* Padding ridotto */
            text-align: center;
            font-weight: 600;
            border: 1px solid #dbeafe;
            white-space: normal;  /* Permetti wrap */
            word-wrap: break-word;
            font-size: 0.6rem;  /* Header piccolo */
            line-height: 1.2;
        }

        .excel-table td {
            padding: 0.3rem 0.15rem;  /* Padding ridotto */
            text-align: center;
            border: 1px solid #e5e7eb;
            background: white;
            font-size: 0.65rem;  /* Font compatto */
            word-wrap: break-word;
            overflow: hidden;
        }

        .excel-table tbody tr:hover {
            background: #f0f9ff;
        }

        .excel-table tbody tr:nth-child(even) {
            background: #f9fafb;
        }

        .excel-table tbody tr:nth-child(even):hover {
            background: #f0f9ff;
        }

        /* ğŸ”§ v8.09: Larghezze colonne proporzionali */
        .excel-col-narrow {
            width: 4%;  /* Colonne strette */
        }

        .excel-col-medium {
            width: 6%;  /* Colonne medie */
        }

        .excel-col-wide {
            width: 7%;  /* Colonna totale */
        }

        /* Righe totali */
        .excel-total-row {
            background: #dbeafe !important;
            font-weight: 700;
        }

        .excel-total-row:hover {
            background: #bfdbfe !important;
        }

        .excel-total-value {
            background: #dbeafe !important;
            color: #1e40af;
            font-weight: 700;
            font-size: 1rem;
        }

        .excel-subtotal-row {
            background: #fef3c7 !important;
            font-weight: 700;
        }

        .excel-subtotal-row:hover {
            background: #fde68a !important;
        }

        .excel-subtotal-value {
            background: #fef3c7 !important;
            color: #92400e;
            font-weight: 700;
            font-size: 1rem;
        }

        .excel-grand-total-row {
            background: #10b981 !important;
            color: white !important;
        }

        .excel-grand-total-row:hover {
            background: #059669 !important;
        }

        .excel-grand-total-value {
            background: #10b981 !important;
            color: white !important;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .excel-row {
            background: white;
        }

        .excel-value {
            font-weight: 600;
            color: #374151;
        }

        /* Pulsanti azioni */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: #e5e7eb;
            color: #374151;
        }

        .btn:hover {
            background: #d1d5db;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* ================================================================================
           BLOCCO POSA - VISTA GENERALE CANTIERE
           ================================================================================ */
        
        .cantiere-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .cantiere-section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #f59e0b;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .materials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .material-category {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            border-radius: 8px;
            padding: 1rem;
        }

        .material-category-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .material-item {
            background: white;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 6px;
            font-size: 0.95rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .material-item strong {
            color: #92400e;
            display: block;
            margin-bottom: 0.25rem;
        }

        .tools-checklist {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .tool-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: #fef3c7;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .tool-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .mounting-order {
            margin-top: 1rem;
        }

        .order-step {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 1rem;
            margin: 0.75rem 0;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
        }

        .order-step-number {
            display: inline-block;
            width: 32px;
            height: 32px;
            background: #f59e0b;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 32px;
            font-weight: 700;
            margin-right: 0.75rem;
        }

        .preparation-checklist {
            margin-top: 1rem;
        }

        .checklist-group {
            margin: 1rem 0;
        }

        .checklist-group-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.75rem;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: white;
            margin: 0.5rem 0;
            border-radius: 6px;
            border: 2px solid #fde68a;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .checklist-item:hover {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .checklist-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .checklist-item.checked {
            background: #d1fae5;
            border-color: #10b981;
            opacity: 0.7;
        }

        .logistics-info {
            background: #fef3c7;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .logistics-item {
            display: flex;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid #fde68a;
        }

        .logistics-item:last-child {
            border-bottom: none;
        }

        .logistics-label {
            font-weight: 600;
            color: #92400e;
            min-width: 150px;
        }

        .logistics-value {
            color: #1f2937;
        }

        /* ================================================================================
           BLOCCO POSA - VISTA POSIZIONI CANTIERE
           ================================================================================ */
        
        .posa-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .posa-header {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .posa-position-info {
            flex: 1;
        }

        .posa-position-id {
            font-size: 1.8rem;
            font-weight: 700;
            color: #f59e0b;
            margin-bottom: 0.25rem;
        }

        .posa-position-location {
            font-size: 1.1rem;
            color: #6b7280;
        }

        .posa-navigation {
            display: flex;
            gap: 0.75rem;
        }

        .nav-btn-large {
            padding: 1rem 2rem;
            font-size: 1.2rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 120px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .nav-btn-large.prev {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .nav-btn-large.next {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .nav-btn-large:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .nav-btn-large:active {
            transform: translateY(0);
        }

        .nav-btn-large:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* MISURE BRM GRANDI E CHIARE */
        .brm-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .brm-box-large {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 4px solid #f59e0b;
            border-radius: 12px;
            padding: 2rem;
            margin: 1rem 0;
            text-align: center;
        }

        .brm-product-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .brm-measurements {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .brm-measure {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .brm-label {
            font-size: 1.2rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .brm-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #f59e0b;
            font-family: 'Courier New', monospace;
        }

        .brm-unit {
            font-size: 1.5rem;
            color: #9ca3af;
            margin-left: 0.5rem;
        }

        /* CARATTERISTICHE MURO */
        .muro-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .muro-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .muro-item {
            background: #fef3c7;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
        }

        .muro-label {
            font-size: 0.95rem;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.5rem;
        }

        .muro-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
        }

        /* ISTRUZIONI MONTAGGIO */
        .instructions-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .instruction-step {
            background: linear-gradient(135deg, #ffffff 0%, #fef3c7 100%);
            border-left: 5px solid #f59e0b;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            transition: all 0.2s;
        }

        .instruction-step:hover {
            box-shadow: 0 4px 12px rgba(245,158,11,0.2);
            transform: translateX(4px);
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background: #f59e0b;
            color: white;
            border-radius: 50%;
            font-size: 1.5rem;
            font-weight: 700;
            margin-right: 1rem;
            margin-bottom: 1rem;
        }

        .step-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 1rem;
        }

        .step-tasks {
            list-style: none;
            margin-left: 1rem;
        }

        .step-task {
            padding: 0.5rem 0;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            font-size: 1rem;
        }

        .step-task input[type="checkbox"] {
            margin-top: 0.25rem;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* MATERIALI SPECIFICI POSIZIONE */
        .materials-list {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .material-list-item {
            background: #fef3c7;
            padding: 1rem;
            margin: 0.75rem 0;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
            font-size: 1rem;
        }

        /* NOTE E ALERT */
        .notes-alerts-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .alert-item {
            padding: 1rem;
            margin: 0.75rem 0;
            border-radius: 8px;
            border-left: 4px solid;
            font-size: 1rem;
        }

        .alert-item.warning {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }

        .alert-item.info {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .alert-item.tip {
            background: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }

        /* CHECKLIST OPERAZIONI FINALI */
        .final-checklist-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .final-checklist-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #fef3c7;
            margin: 0.75rem 0;
            border-radius: 8px;
            border: 2px solid #fde68a;
            font-size: 1.1rem;
            transition: all 0.2s;
        }

        .final-checklist-item:hover {
            border-color: #f59e0b;
            background: #fef3c7;
        }

        .final-checklist-item input[type="checkbox"] {
            width: 28px;
            height: 28px;
            cursor: pointer;
        }

        .final-checklist-item.checked {
            background: #d1fae5;
            border-color: #10b981;
        }

        /* FULLSCREEN MODE */
        .fullscreen-toggle {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.2s;
            z-index: 999;
        }

        .fullscreen-toggle:hover {
            background: #d97706;
            transform: scale(1.1);
        }

        /* RESPONSIVE - MOBILE FIRST */
        @media (max-width: 768px) {
            .brm-measurements {
                grid-template-columns: 1fr;
            }

            .brm-value {
                font-size: 2rem;
            }

            .nav-btn-large {
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
                min-width: 100px;
            }

            .posa-position-id {
                font-size: 1.5rem;
            }

            .materials-grid {
                grid-template-columns: 1fr;
            }

            .muro-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* ================================================================================
           MODAL PREVENTIVO - STILI
           ================================================================================ */
        .preventivo-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }
        
        .preventivo-modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .preventivo-modal {
            background: white;
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .preventivo-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preventivo-modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
        }
        
        .preventivo-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preventivo-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .preventivo-modal-body {
            padding: 2rem;
        }
        
        .preventivo-info-progetto {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #667eea;
        }
        
        .preventivo-info-progetto h3 {
            margin: 0 0 0.5rem 0;
            color: #1e293b;
            font-size: 1.25rem;
        }
        
        .preventivo-info-progetto p {
            margin: 0.25rem 0;
            color: #64748b;
        }
        
        .preventivo-prodotti-lista {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .preventivo-prodotto-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s;
        }
        
        .preventivo-prodotto-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }
        
        .preventivo-prodotto-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .preventivo-prodotto-info h4 {
            margin: 0 0 0.25rem 0;
            color: #1e293b;
            font-size: 1.1rem;
        }
        
        .preventivo-prodotto-info p {
            margin: 0;
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .preventivo-prodotto-prezzo {
            text-align: right;
        }
        
        .preventivo-prezzo-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }
        
        .preventivo-prezzo-valore {
            font-size: 1.5rem;
            font-weight: 700;
            color: #10b981;
        }
        
        .preventivo-prodotto-dettagli {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .preventivo-dettaglio-item {
            background: #f8fafc;
            padding: 0.75rem;
            border-radius: 8px;
        }
        
        .preventivo-dettaglio-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }
        
        .preventivo-dettaglio-valore {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .preventivo-totale-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .preventivo-totale-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
        }
        
        .preventivo-totale-row.finale {
            border-top: 2px solid #cbd5e1;
            padding-top: 1rem;
            margin-top: 0.5rem;
        }
        
        .preventivo-totale-label {
            font-size: 1rem;
            color: #475569;
        }
        
        .preventivo-totale-label.finale {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .preventivo-totale-valore {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .preventivo-totale-valore.finale {
            font-size: 1.75rem;
            font-weight: 700;
            color: #10b981;
        }
        
        .preventivo-modal-actions {
            display: flex;
            gap: 1rem;
            padding: 1.5rem 2rem;
            border-top: 2px solid #f1f5f9;
            background: #f8fafc;
            border-radius: 0 0 16px 16px;
        }
        
        .preventivo-btn {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .preventivo-btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .preventivo-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .preventivo-btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }
        
        .preventivo-btn-secondary:hover {
            background: #cbd5e1;
        }
        
        .preventivo-placeholder {
            text-align: center;
            padding: 3rem 2rem;
        }
        
        .preventivo-placeholder-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .preventivo-placeholder-text {
            color: #64748b;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .preventivo-loading {
            text-align: center;
            padding: 3rem 2rem;
        }
        
        .preventivo-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Modal Preventivo Overlay */
        .preventivo-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s;
        }
        
        .preventivo-modal {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s;
        }
        
        .preventivo-modal-large {
            max-width: 1200px;
        }
        
        .preventivo-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preventivo-modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
        }
        
        .preventivo-modal-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 0.5rem;
        }
        
        .preventivo-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preventivo-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .preventivo-warning {
            margin: 2rem;
            padding: 2rem;
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 12px;
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }
        
        .preventivo-warning-icon {
            font-size: 3rem;
            flex-shrink: 0;
        }
        
        .preventivo-warning-text {
            flex: 1;
        }
        
        .preventivo-warning-text p {
            margin: 0.5rem 0;
            color: #78350f;
            line-height: 1.6;
        }
        
        .preventivo-cliente-info {
            padding: 1.5rem 2rem;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .preventivo-info-item {
            display: flex;
            gap: 0.5rem;
        }
        
        .preventivo-info-label {
            font-weight: 600;
            color: #64748b;
        }
        
        .preventivo-info-value {
            color: #1e293b;
        }
        
        .preventivo-warnings-list {
            margin: 1.5rem 2rem;
            padding: 1rem;
            background: #fef3c7;
            border-left: 4px solid #fbbf24;
            border-radius: 8px;
        }
        
        .preventivo-warnings-title {
            font-weight: 700;
            color: #78350f;
            margin-bottom: 0.5rem;
        }
        
        .preventivo-warning-item {
            color: #78350f;
            font-size: 0.9rem;
            padding: 0.25rem 0;
        }
        
        /* ğŸ”„ v8.04: PREVENTIVO FULL-WIDTH */
        .preventivo-fullwidth {
            max-width: 100% !important;
            width: 100% !important;
            padding: 0 0.5rem !important;
            margin: 0 !important;
        }
        
        .preventivo-fullwidth .vista-ufficio {
            max-width: 100% !important;
            padding: 0 !important;
        }
        
        .preventivo-fullwidth .card {
            max-width: 100% !important;
            border-radius: 8px;
        }
        
        .preventivo-table-container {
            padding: 0.25rem;
            overflow-x: visible;  /* ğŸ”§ v8.09: No scroll orizzontale */
        }
        
        .preventivo-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;  /* ğŸ”§ v8.09: Font piÃ¹ piccolo */
            table-layout: fixed;  /* ğŸ”§ v8.09: Colonne fisse */
        }
        
        .preventivo-table th {
            background: linear-gradient(135deg, #1e3a5f 0%, #0f2744 100%);
            padding: 0.4rem 0.2rem;  /* ğŸ”§ v8.09: Padding ridotto */
            text-align: center;
            font-weight: 600;
            color: white;
            border-bottom: 2px solid #0ea5e9;
            font-size: 0.6rem;  /* ğŸ”§ v8.09: Header piÃ¹ piccolo */
            text-transform: uppercase;
            letter-spacing: 0;
            white-space: normal;  /* ğŸ”§ v8.09: Permetti wrap */
            word-wrap: break-word;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .preventivo-table td {
            padding: 0.35rem 0.2rem;  /* ğŸ”§ v8.09: Padding ridotto */
            border-bottom: 1px solid #e2e8f0;
            color: #1e293b;
            vertical-align: middle;
            text-align: center;
            font-size: 0.68rem;  /* ğŸ”§ v8.09: Font compatto */
            word-wrap: break-word;
        }
        
        /* ğŸ”§ v8.09: Prima colonna (Pos) allineata a sinistra */
        .preventivo-table td:first-child,
        .preventivo-table th:first-child {
            text-align: center;
            width: 3%;
        }
        
        /* ğŸ”§ v8.09: Colonna Ambiente piÃ¹ larga */
        .preventivo-table td:nth-child(2),
        .preventivo-table th:nth-child(2) {
            text-align: left;
            width: 8%;
        }
        
        /* ğŸ”§ v8.09: Colonna Tipo */
        .preventivo-table td:nth-child(3),
        .preventivo-table th:nth-child(3) {
            width: 7%;
        }
        
        /* ğŸ”§ v8.09: Ultima colonna (Totale) evidenziata */
        .preventivo-table td:last-child {
            font-weight: 700;
            color: #059669;
        }
        
        .preventivo-table tbody tr:hover {
            background: #f0f9ff;
        }
        
        .preventivo-table tbody tr:nth-child(even) {
            background: #f8fafc;
        }
        
        .preventivo-table tbody tr:nth-child(even):hover {
            background: #f0f9ff;
        }
        
        .voce-tipo-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .voce-tipo-badge.infisso {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .voce-tipo-badge.zanzariera {
            background: #d1fae5;
            color: #065f46;
        }
        
        .voce-tipo-badge.persiana {
            background: #fef3c7;
            color: #78350f;
        }
        
        .voce-tipo-badge.tapparella {
            background: #fce7f3;
            color: #9f1239;
        }
        
        .voce-tipo-badge.cassonetto {
            background: #e0e7ff;
            color: #3730a3;
        }
        
        .preventivo-totali {
            margin: 0 2rem 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
        }
        
        .preventivo-totale-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            font-size: 1rem;
            color: #475569;
        }
        
        .preventivo-totale-row.subtotale {
            border-top: 1px solid #cbd5e1;
            margin-top: 0.5rem;
            padding-top: 1rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .preventivo-totale-row.finale {
            border-top: 2px solid #10b981;
            margin-top: 0.5rem;
            padding-top: 1rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: #10b981;
        }
        
        .btn-preventivo {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-preventivo.btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .btn-preventivo.btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .btn-preventivo.btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }
        
        .btn-preventivo.btn-secondary:hover {
            background: #cbd5e1;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ================================================================================
           WIZARD COMPLETAMENTO DATI
           ================================================================================ */
        .wizard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s;
        }
        
        .wizard-container {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s;
        }
        
        .wizard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px 16px 0 0;
            position: relative;
        }
        
        .wizard-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
        }
        
        .wizard-subtitle {
            font-size: 0.95rem;
            opacity: 0.9;
            margin-top: 0.5rem;
        }
        
        .wizard-close {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .wizard-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .wizard-body {
            padding: 2rem;
        }
        
        .wizard-info-box {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .wizard-info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
        }
        
        .wizard-info-label {
            font-weight: 600;
            color: #64748b;
        }
        
        .wizard-info-value {
            font-weight: 700;
            color: #1e293b;
        }
        
        .wizard-analysis {
            margin: 2rem 0;
        }
        
        .wizard-stat {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .wizard-stat.success {
            background: #d1fae5;
            border: 2px solid #10b981;
        }
        
        .wizard-stat.warning {
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }
        
        .wizard-stat-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }
        
        .wizard-stat-text {
            flex: 1;
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .wizard-message {
            background: #e0e7ff;
            border-left: 4px solid #6366f1;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 2rem 0;
        }
        
        .wizard-message p {
            margin: 0.5rem 0;
            line-height: 1.6;
        }
        
        .wizard-section {
            margin: 2rem 0;
        }
        
        .wizard-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 1rem;
        }
        
        .wizard-list {
            list-style: none;
            padding: 0;
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem 1.5rem;
        }
        
        .wizard-list li {
            padding: 0.5rem 0;
            color: #475569;
        }
        
        .wizard-misure-disponibili {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .wizard-misura-badge {
            background: #d1fae5;
            color: #065f46;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .wizard-warning-text {
            color: #ef4444;
            font-style: italic;
        }
        
        .wizard-radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .wizard-radio {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .wizard-radio:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        
        .wizard-radio input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .wizard-radio input[type="radio"]:checked + .wizard-radio-label {
            font-weight: 700;
            color: #6366f1;
        }
        
        .wizard-radio-label {
            flex: 1;
            font-size: 1rem;
        }
        
        .wizard-corrections {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .wizard-correction-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .wizard-label {
            font-weight: 600;
            min-width: 100px;
        }
        
        .wizard-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .wizard-input-group input[type="number"],
        .wizard-input-group input[type="text"] {
            padding: 0.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .wizard-btn-mini {
            padding: 0.5rem 1rem;
            background: #e2e8f0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .wizard-btn-mini:hover {
            background: #cbd5e1;
        }
        
        .wizard-unit {
            color: #64748b;
            font-weight: 600;
        }
        
        .wizard-example {
            background: #fef3c7;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.95rem;
        }
        
        .wizard-preview {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            min-height: 100px;
        }
        
        .wizard-loading {
            text-align: center;
            color: #64748b;
            font-style: italic;
        }
        
        .wizard-summary {
            margin: 2rem 0;
        }
        
        .wizard-summary-item {
            display: flex;
            gap: 1rem;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .wizard-summary-item.success {
            background: #d1fae5;
            border: 2px solid #10b981;
        }
        
        .wizard-summary-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }
        
        .wizard-summary-text {
            flex: 1;
        }
        
        .wizard-summary-text strong {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .wizard-summary-section {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        
        .wizard-summary-section h4 {
            margin: 0 0 0.75rem 0;
            color: #1e293b;
        }
        
        .wizard-summary-section ul {
            list-style: none;
            padding: 0;
        }
        
        .wizard-summary-section li {
            padding: 0.25rem 0;
            color: #475569;
        }
        
        .wizard-footer {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            padding: 1.5rem 2rem;
            border-top: 2px solid #f1f5f9;
            background: #f8fafc;
            border-radius: 0 0 16px 16px;
        }
        
        .wizard-btn {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .wizard-btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }
        
        .wizard-btn-secondary:hover {
            background: #cbd5e1;
        }
        
        .wizard-btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .wizard-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        /* ================================================================================
           MODAL SCELTA BRM
           ================================================================================ */
        .brm-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 10001;
            animation: fadeIn 0.3s ease;
        }
        
        .brm-modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        
        .brm-modal {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        .brm-modal-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 16px 16px 0 0;
        }
        
        .brm-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 0.5rem 0;
        }
        
        .brm-modal-subtitle {
            font-size: 0.95rem;
            opacity: 0.9;
            margin: 0;
        }
        
        .brm-modal-body {
            padding: 2rem;
        }
        
        .brm-alert {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        .brm-alert-text {
            color: #92400e;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .brm-section {
            margin-bottom: 2rem;
        }
        
        .brm-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .brm-section-icon {
            font-size: 1.3rem;
        }
        
        .brm-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .brm-option {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .brm-option:hover {
            border-color: #f59e0b;
            background: #fffbeb;
        }
        
        .brm-option.selected {
            border-color: #f59e0b;
            background: #fef3c7;
        }
        
        .brm-option-radio {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #cbd5e1;
            margin-right: 1rem;
            position: relative;
            transition: all 0.2s;
        }
        
        .brm-option.selected .brm-option-radio {
            border-color: #f59e0b;
        }
        
        .brm-option.selected .brm-option-radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #f59e0b;
        }
        
        .brm-option-content {
            flex: 1;
        }
        
        .brm-option-label {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }
        
        .brm-option-value {
            font-size: 1.1rem;
            color: #f59e0b;
            font-weight: 700;
        }
        
        .brm-option-unit {
            font-size: 0.9rem;
            color: #64748b;
            margin-left: 0.25rem;
        }
        
        .brm-option-input {
            display: none;
            margin-top: 0.75rem;
        }
        
        .brm-option-input.active {
            display: block;
        }
        
        .brm-input-label {
            display: block;
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
        
        .brm-input-field {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .brm-input-field:focus {
            outline: none;
            border-color: #f59e0b;
            background: #fffbeb;
        }
        
        .brm-modal-actions {
            display: flex;
            gap: 1rem;
            padding: 1.5rem 2rem;
            border-top: 2px solid #f1f5f9;
            background: #f8fafc;
            border-radius: 0 0 16px 16px;
        }
        
        .brm-btn {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .brm-btn-primary {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .brm-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        
        .brm-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .brm-btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }
        
        .brm-btn-secondary:hover {
            background: #cbd5e1;
        }
        
        
        /* ================================================================
           SIDEBAR MENU LATERALE
           ================================================================ */
        .sidebar-menu {
            position: fixed;
            top: 0;
            left: -320px;
            width: 320px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 12px rgba(0,0,0,0.15);
            transition: left 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .sidebar-menu.open {
            left: 0;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .sidebar-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .sidebar-content {
            padding: 1rem 0;
        }
        
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 0.875rem 1.5rem;
            color: #374151;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            font-weight: 500;
        }
        
        .sidebar-item:hover {
            background: #f3f4f6;
            color: #667eea;
        }
        
        .sidebar-item span:first-child {
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }
        
        .sidebar-expandable {
            cursor: pointer;
        }
        
        .sidebar-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .expand-icon {
            transition: transform 0.3s;
            font-size: 0.875rem;
            color: #9ca3af;
        }
        
        .sidebar-expandable.expanded .expand-icon {
            transform: rotate(180deg);
        }
        
        .sidebar-submenu {
            background: #f9fafb;
            border-left: 3px solid #667eea;
            margin-left: 1.5rem;
        }
        
        .sidebar-submenu a {
            display: block;
            padding: 0.75rem 1.5rem;
            color: #6b7280;
            text-decoration: none;
            font-size: 0.9375rem;
            transition: all 0.2s;
        }
        
        .sidebar-submenu a:hover {
            background: white;
            color: #667eea;
            padding-left: 2rem;
        }
        
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }
        
        /* Bottoni action nel menu laterale */
        .sidebar-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            margin: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .sidebar-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .sidebar-action-btn.import {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .sidebar-action-btn.github {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }
        
        .sidebar-action-btn.settings {
            background: #718096;
        }
        
        .sidebar-action-btn span:first-child {
            margin-right: 0.5rem;
        }
        
        /* ================================================================================
           âœ… CONFERMA CLIENTE v7.28 - CSS
           ================================================================================ */
        
        /* Modal Conferma Cliente Overlay */
        #conferma-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            overflow-y: auto;
            padding: 2rem 0;
        }
        
        #conferma-modal-overlay.active {
            display: block;
        }
        
        .conferma-modal-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .conferma-modal-header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .conferma-modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
        }
        
        .conferma-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 2rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .conferma-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        /* Toolbar Quick Actions */
        .conferma-toolbar {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            padding: 20px;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .conferma-toolbar button {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            /* FIX iPad/Touch */
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            user-select: none;
            -webkit-user-select: none;
        }
        
        .conferma-toolbar .btn-settings {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
        }
        
        .conferma-toolbar .btn-settings:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        
        .conferma-toolbar .btn-export {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .conferma-toolbar .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .quick-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0.6rem 1rem;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .quick-toggle:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .quick-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Documento Conferma */
        .conferma-content {
            padding: 30px;
        }
        
        .conferma-page {
            background: white;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        
        .conferma-page h2 {
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 12px;
            margin: 20px 0;
            font-size: 1.5rem;
        }
        
        .conferma-page h3 {
            color: #1e40af;
            margin: 20px 0 12px 0;
            font-size: 1.2rem;
        }
        
        .sezione-misure,
        .sezione-infisso,
        .sezione-persiana,
        .sezione-tapparella,
        .sezione-zanzariera,
        .sezione-cassonetto,
        .sezione-prezzi,
        .sezione-note {
            margin: 20px 0;
            padding: 18px;
            background: #f9fafb;
            border-left: 4px solid #3b82f6;
            border-radius: 4px;
        }
        
        .sezione-prezzi {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        
        .sezione-note {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .sezione-misure p,
        .sezione-infisso p,
        .sezione-persiana p,
        .sezione-tapparella p,
        .sezione-zanzariera p,
        .sezione-cassonetto p,
        .sezione-prezzi p,
        .sezione-note p {
            margin: 8px 0;
            color: #1e293b;
            line-height: 1.6;
        }
        
        .sezione-misure strong,
        .sezione-infisso strong,
        .sezione-persiana strong,
        .sezione-tapparella strong,
        .sezione-zanzariera strong,
        .sezione-cassonetto strong,
        .sezione-prezzi strong {
            color: #0f172a;
            font-weight: 600;
        }
        
        .campo-prezzo-editabile {
            margin-top: 12px;
            padding: 12px;
            background: white;
            border: 2px dashed #cbd5e1;
            border-radius: 6px;
            min-height: 50px;
            color: #64748b;
            font-style: italic;
        }
        
        /* Modal Impostazioni Colonne */
        #modal-impostazioni-conferma {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }
        
        #modal-impostazioni-conferma.active {
            display: flex;
        }
        
        .modal-impostazioni-content {
            background: white;
            border-radius: 16px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }
        
        .modal-impostazioni-header {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-impostazioni-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .modal-impostazioni-body {
            padding: 2rem;
        }
        
        .settings-section {
            margin: 25px 0;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }
        
        .settings-section h3 {
            color: #1e40af;
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .settings-section label {
            display: block;
            margin: 10px 0;
            cursor: pointer;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .settings-section label:hover {
            background: #eff6ff;
            transform: translateX(4px);
        }
        
        .settings-section label input {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .modal-impostazioni-actions {
            display: flex;
            gap: 15px;
            padding: 1.5rem 2rem;
            background: #f8fafc;
            border-top: 2px solid #e2e8f0;
            border-radius: 0 0 16px 16px;
        }
        
        .modal-impostazioni-actions button {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            /* FIX iPad/Touch */
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            user-select: none;
            -webkit-user-select: none;
        }
        
        .btn-salva {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .btn-salva:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .btn-reset {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .btn-reset:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }
        
        .btn-chiudi {
            background: #e5e7eb;
            color: #374151;
        }
        
        .btn-chiudi:hover {
            background: #d1d5db;
        }
        
        /* Page break per stampa PDF */
        @media print {
            .conferma-toolbar {
                display: none !important;
            }
            
            .page-break {
                page-break-after: always;
            }
            
            .conferma-page {
                border: none;
                margin: 0;
                padding: 20px;
            }
            
            @page {
                size: A4;
                margin: 2cm;
            }
        }
        
        /* === TAB ANALISI COSTI === */
        .tab-analisi {
            padding: 0.75rem 1.5rem;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-analisi:hover {
            background: #f3f4f6;
            color: #374151;
            transform: translateY(-2px);
        }
        
        .tab-analisi.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #10b981;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3);
        }
        
        .tab-content-analisi {
            animation: fadeIn 0.3s ease-in;
        }
        
        /* === TAB LISTINI === */
        .tab-listini {
            padding: 0.75rem 1.5rem;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-listini:hover {
            background: #f3f4f6;
            color: #374151;
            transform: translateY(-2px);
        }
        
        .tab-listini.active {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-color: #f59e0b;
            box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3);
        }
        
        .tab-content-listini {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modello-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }
        
        .modello-card:hover {
            border-color: #f59e0b;
            box-shadow: 0 4px 6px rgba(245, 158, 11, 0.1);
            transform: translateX(4px);
        }
        
        .modello-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .modello-nome {
            font-weight: 700;
            font-size: 1.125rem;
            color: #1f2937;
        }
        
        .modello-badge {
            background: #fef3c7;
            color: #92400e;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .dimensioni-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .dimensione-item {
            background: #f9fafb;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            display: flex;
            justify-content: space-between;
        }
        
        .dimensione-size {
            color: #4b5563;
            font-weight: 500;
        }
        
        .dimensione-price {
            color: #059669;
            font-weight: 700;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ”Œ v8.00 - CSS RESPONSIVE PER IPAD E SMARTPHONE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* ===== TABLET / IPAD (768px - 1024px) ===== */
        @media (max-width: 1024px) {
            .main-container {
                padding: 1rem;
            }
            
            .header-container {
                flex-wrap: wrap;
                gap: 0.75rem;
                padding: 0.75rem 1rem;
            }
            
            .header-left {
                flex: 1 1 100%;
                justify-content: center;
            }
            
            .header-right {
                flex: 1 1 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .nav-tab {
                flex: 1 1 45%;
                min-width: 140px;
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
            
            .products-tabs {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .product-tab {
                flex: 1 1 auto;
                min-width: 100px;
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
            }
            
            .wall-chars-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            .brm-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* Tabella preventivo scrollabile */
            .preventivo-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .preventivo-table th,
            .preventivo-table td {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            
            /* Sidebar posizioni */
            .positions-sidebar {
                width: 150px !important;
                min-width: 120px !important;
            }
            
            .position-card {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
        }
        
        /* ===== SMARTPHONE (max 768px) ===== */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }
            
            .main-container {
                padding: 0.5rem;
            }
            
            .header-container {
                padding: 0.5rem;
            }
            
            .logo-text {
                font-size: 1.1rem;
            }
            
            .logo-version {
                font-size: 0.7rem;
                padding: 2px 6px;
            }
            
            /* Tabs navigazione verticali su mobile */
            .nav-tabs {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .nav-tab {
                width: 100%;
                padding: 0.75rem;
                font-size: 0.9rem;
                border-radius: 8px;
            }
            
            /* Products tabs scrollabili orizzontalmente */
            .products-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                flex-wrap: nowrap;
                gap: 0.5rem;
                padding-bottom: 0.5rem;
            }
            
            .product-tab {
                flex-shrink: 0;
                min-width: 90px;
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            
            /* Grid campi: 1 colonna su mobile */
            .wall-chars-grid {
                grid-template-columns: 1fr !important;
            }
            
            .brm-grid {
                grid-template-columns: 1fr;
            }
            
            .brm-box {
                padding: 1rem;
            }
            
            .brm-value {
                font-size: 1.5rem;
            }
            
            /* Vista posizioni: sidebar sopra contenuto */
            .position-layout {
                flex-direction: column;
            }
            
            .positions-sidebar {
                width: 100% !important;
                max-width: 100% !important;
                display: flex;
                flex-direction: row;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                gap: 0.5rem;
                padding: 0.5rem;
            }
            
            .position-card {
                flex-shrink: 0;
                min-width: 100px;
                padding: 0.5rem 0.75rem;
            }
            
            .position-content {
                width: 100% !important;
            }
            
            /* Tabella preventivo */
            .preventivo-table {
                font-size: 0.75rem;
            }
            
            .preventivo-table th,
            .preventivo-table td {
                padding: 0.4rem;
                white-space: nowrap;
            }
            
            /* Nascondi colonne meno importanti su mobile */
            .preventivo-table th:nth-child(9),
            .preventivo-table td:nth-child(9),
            .preventivo-table th:nth-child(10),
            .preventivo-table td:nth-child(10),
            .preventivo-table th:nth-child(11),
            .preventivo-table td:nth-child(11) {
                display: none;
            }
            
            /* Bottoni piÃ¹ grandi per touch */
            button, .btn {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Modal fullscreen su mobile */
            .modal-content {
                width: 95% !important;
                max-width: 95% !important;
                margin: 1rem auto;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Cards aziende */
            .azienda-card {
                padding: 1rem;
            }
            
            .azienda-header {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            /* Config globale */
            .config-globale-box {
                padding: 0.75rem;
            }
            
            /* Totali commessa */
            .totali-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
            }
            
            .totale-card {
                padding: 0.75rem;
            }
            
            .totale-numero {
                font-size: 1.5rem;
            }
        }
        
        /* ===== SMARTPHONE PICCOLI (max 480px) ===== */
        @media (max-width: 480px) {
            body {
                font-size: 13px;
            }
            
            .header-container {
                padding: 0.4rem;
            }
            
            .logo-text {
                font-size: 1rem;
            }
            
            .header-right {
                gap: 0.25rem;
            }
            
            .header-right button {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
            }
            
            /* Totali commessa 2 colonne */
            .totali-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* Tab prodotti ancora piÃ¹ compatti */
            .product-tab {
                min-width: 70px;
                padding: 0.4rem;
                font-size: 0.75rem;
            }
            
            /* Misure BRM compatte */
            .brm-value {
                font-size: 1.3rem;
            }
            
            .brm-label {
                font-size: 0.75rem;
            }
            
            /* Wall chars items piÃ¹ compatti */
            .wall-char-item {
                padding: 0.5rem;
            }
            
            .wall-char-label {
                font-size: 0.7rem;
            }
            
            .wall-char-value {
                font-size: 0.85rem;
            }
        }
        
        /* ===== LANDSCAPE MODE (tablet/phone orizzontali) ===== */
        @media (max-height: 500px) and (orientation: landscape) {
            .header-container {
                padding: 0.25rem 0.5rem;
            }
            
            .nav-tabs {
                flex-direction: row;
                flex-wrap: nowrap;
                overflow-x: auto;
            }
            
            .nav-tab {
                flex: 0 0 auto;
                width: auto;
                padding: 0.5rem 1rem;
            }
        }
        
        /* ===== TOUCH IMPROVEMENTS ===== */
        @media (hover: none) and (pointer: coarse) {
            /* Elementi cliccabili piÃ¹ grandi per dita */
            button, 
            .btn,
            .nav-tab,
            .product-tab,
            .position-card {
                min-height: 44px;
            }
            
            /* Rimuovi hover effects su touch */
            .nav-tab:hover,
            .product-tab:hover,
            .position-card:hover {
                transform: none;
            }
            
            /* Feedback tap */
            .nav-tab:active,
            .product-tab:active,
            .position-card:active,
            button:active {
                transform: scale(0.98);
                opacity: 0.9;
            }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ”„ v8.02 - SEZIONI COLLASSABILI
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .collapsible-section {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .collapsible-section .position-section-title {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            margin: 0;
            padding: 1rem 1.25rem;
            border-bottom: none;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }
        
        .collapsible-section .position-section-title:hover {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        }
        
        .collapsible-header {
            cursor: pointer;
            user-select: none;
        }
        
        .collapsible-arrow {
            font-size: 0.8rem;
            color: #6b7280;
            transition: transform 0.3s ease;
        }
        
        .collapsible-count {
            font-weight: 500;
        }
        
        .collapsible-content {
            padding: 0 1.25rem 1.25rem;
            background: white;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ”„ v8.03 - CONFIGURAZIONE PRODOTTI AZIENDA
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .azienda-configurazioni {
            margin-bottom: 1.5rem;
        }
        
        .azienda-config-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .azienda-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }
        
        .azienda-config-box {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .azienda-config-header {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .azienda-config-fields {
            display: grid;
            gap: 0.4rem;
        }
        
        .azienda-config-field {
            display: grid;
            grid-template-columns: 110px 1fr;
            gap: 0.5rem;
            font-size: 0.85rem;
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .azienda-config-field:last-child {
            border-bottom: none;
        }
        
        .azienda-config-label {
            color: #6b7280;
            font-weight: 500;
        }
        
        .azienda-config-value {
            color: #1f2937;
            font-weight: 600;
        }
        
        /* Tabella prodotti semplificata */
        .azienda-prodotti-table-v2 {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .azienda-prodotti-table-v2 th {
            background: #f8fafc;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .azienda-prodotti-table-v2 td {
            padding: 0.75rem;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }
        
        .azienda-prodotti-table-v2 tbody tr:hover {
            background: #f8fafc;
        }
        
        .azienda-totale-row {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%) !important;
        }
        
        .azienda-totale-row td {
            padding: 1rem 0.75rem !important;
            border-top: 2px solid #10b981 !important;
        }
    </style>
    
    <!-- ================================================================================
         SISTEMA PREVENTIVAZIONE - Moduli JS
         ================================================================================ -->
    <script>

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”§ DATABASE MANIGLIE FINSTRAL - v7.26
        // Integrato da MANIGLIE-FINSTRAL-DB.js
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”§ DATABASE MANIGLIE FINSTRAL - Estratto da catalogo EUR 2025/3
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const MANIGLIE_FINSTRAL = {
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // COLORI DISPONIBILI
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    colori: {
        "01": "bianco",
        "07": "bianco perla",
        "56": "neutro anodizzato",
        "79": "colore titanio",
        "74": "colore bronzo",
        "40": "ottone lucido",
        "0156": "interno bianco",
        "0174": "esterno neutro / colore bronzo",
        "M01": "bianco opaco",
        "M03": "nero opaco",
        "M07": "bianco crema",
        "43": "acciaio inox",
        "E03": "nero anodizzato"
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 1 - Maniglie Classic-line, Slim-line, Step-line, Nova-line
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie1: {
        // FINESTRE
        "6010": {
            codice: "6010",
            descrizione: "maniglia per finestra in alluminio",
            tipo: "finestra",
            serie: "1",
            colori: ["01", "07", "56", "79", "74", "40", "0156", "0174"],
            supplemento: 19.6
        },
        "6011": {
            codice: "6011",
            descrizione: "maniglia per finestra in alluminio",
            tipo: "finestra",
            serie: "1",
            colori: ["01", "07", "56", "79", "74", "40", "0156", "0174"],
            supplemento: 19.6
        },
        "6012": {
            codice: "6012",
            descrizione: "maniglia per finestra in alluminio",
            tipo: "finestra",
            serie: "1",
            colori: ["01", "07", "56", "79", "74", "40", "0156", "0174"],
            supplemento: 19.6
        },
        
        "6020": {
            codice: "6020",
            descrizione: "maniglia per finestra in alluminio con pulsante",
            tipo: "finestra",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 15.4,
            supplementoExtra: {
                "56": 64.4
            }
        },
        "6021": {
            codice: "6021",
            descrizione: "maniglia per finestra in alluminio con pulsante",
            tipo: "finestra",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 15.4,
            supplementoExtra: {
                "56": 64.4
            }
        },
        
        "6030": {
            codice: "6030",
            descrizione: "maniglia per finestra in alluminio con chiusura inclusa placca antiperforazione",
            tipo: "finestra",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 30.1,
            supplementoExtra: {
                "56": 83.5
            }
        },
        "6031": {
            codice: "6031",
            descrizione: "maniglia per finestra in alluminio con chiusura inclusa placca antiperforazione",
            tipo: "finestra",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 30.1,
            supplementoExtra: {
                "56": 83.5
            }
        },
        
        // APERTURA SCORREVOLE PARALLELA
        "6470": {
            codice: "6470",
            descrizione: "maniglia per porta-finestra scorrevole in alluminio",
            tipo: "scorrevole",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 0
        },
        "6471": {
            codice: "6471",
            descrizione: "maniglia per porta-finestra scorrevole in alluminio",
            tipo: "scorrevole",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 0
        },
        
        // PORTA-FINESTRA
        "6710": {
            codice: "6710",
            descrizione: "doppia maniglia in alluminio cilindro incluso (per anta 935, 947 e 953)",
            tipo: "porta-finestra",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 51.4,
            supplementoExtra: {
                "56": 18.9
            }
        },
        
        "6700": {
            codice: "6700",
            descrizione: "doppia maniglia in alluminio con collo esterno ribassato (36 mm) cilindro incluso (per anta 935, 947 e 953)",
            tipo: "porta-finestra",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 0
        },
        
        "6750": {
            codice: "6750",
            descrizione: "doppia maniglia in alluminio anta/ribalta cilindro incluso (per anta 935 e 953)",
            tipo: "porta-finestra",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 68.4
        },
        
        "6740": {
            codice: "6740",
            descrizione: "doppia maniglia in alluminio anta/ribalta con collo esterno ribassato (36 mm) cilindro incluso (per anta 935 e 953)",
            tipo: "porta-finestra",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 0
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 2 - Maniglie moderne
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie2: {
        // FINESTRE
        "7040": {
            codice: "7040",
            descrizione: "maniglia per finestra in alluminio",
            tipo: "finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 9.12
        },
        "7041": {
            codice: "7041",
            descrizione: "maniglia per finestra in alluminio",
            tipo: "finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 9.12
        },
        "7042": {
            codice: "7042",
            descrizione: "maniglia per finestra in alluminio",
            tipo: "finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 9.12
        },
        
        "7120": {
            codice: "7120",
            descrizione: "maniglia a pressione in alluminio",
            tipo: "finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 11.6
        },
        "7121": {
            codice: "7121",
            descrizione: "maniglia a pressione in alluminio",
            tipo: "finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 11.6
        },
        
        "7130": {
            codice: "7130",
            descrizione: "maniglia a pressione in alluminio con chiusura incluso placca antiperforazione",
            tipo: "finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 63.2
        },
        "7131": {
            codice: "7131",
            descrizione: "maniglia a pressione in alluminio con chiusura incluso placca antiperforazione",
            tipo: "finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 63.2
        },
        
        "7070": {
            codice: "7070",
            descrizione: "maniglia per apertura a ribalta e ad anta (TBT) - apertura ad anta deve essere sbloccata mediante la chiave",
            tipo: "finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 47.0
        },
        "7071": {
            codice: "7071",
            descrizione: "maniglia per apertura a ribalta e ad anta (TBT) - apertura ad anta deve essere sbloccata mediante la chiave",
            tipo: "finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 47.0
        },
        
        // PORTA-FINESTRA
        "7720": {
            codice: "7720",
            descrizione: "doppia maniglia in alluminio apertura ad anta cilindro incluso (per anta 935, 947 e 953)",
            tipo: "porta-finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 24.4
        },
        
        "7730": {
            codice: "7730",
            descrizione: "doppia maniglia in alluminio anta/ribalta cilindro incluso (per anta 935 e 953)",
            tipo: "porta-finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 24.4
        },
        
        "7740": {
            codice: "7740",
            descrizione: "doppia maniglia in alluminio anta/ribalta con collo esterno ribassato cilindro incluso (per anta 935 e 953)",
            tipo: "porta-finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 30.6
        },
        
        // APERTURA SCORREVOLE
        "7500": {
            codice: "7500",
            descrizione: "maniglia per porta-finestra scorrevole in alluminio",
            tipo: "scorrevole",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 23.5
        },
        "7501": {
            codice: "7501",
            descrizione: "maniglia per porta-finestra scorrevole in alluminio",
            tipo: "scorrevole",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 23.5
        },
        
        "7510": {
            codice: "7510",
            descrizione: "maniglia per porta-finestra scorrevole in alluminio con chiusura incluso placca antiperforazione",
            tipo: "scorrevole",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 49.5
        },
        "7511": {
            codice: "7511",
            descrizione: "maniglia per porta-finestra scorrevole in alluminio con chiusura incluso placca antiperforazione",
            tipo: "scorrevole",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 49.5
        },
        
        "7520": {
            codice: "7520",
            descrizione: "doppia maniglia per porta-finestra scorrevole in alluminio cilindro incluso (per anta 935 e 953)",
            tipo: "scorrevole",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 53.4
        },
        
        "7530": {
            codice: "7530",
            descrizione: "doppia maniglia per porta-finestra scorrevole in alluminio con collo esterno ribassato cilindro incluso (per anta 935 e 953)",
            tipo: "scorrevole",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 70.4
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 3 - Acciaio inox
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie3: {
        "8010": {
            codice: "8010",
            descrizione: "maniglia per finestra in acciaio inox",
            tipo: "finestra",
            serie: "3",
            colori: ["43"],
            supplemento: 18.4
        },
        "8011": {
            codice: "8011",
            descrizione: "maniglia per finestra in acciaio inox",
            tipo: "finestra",
            serie: "3",
            colori: ["43"],
            supplemento: 18.4
        },
        
        "8020": {
            codice: "8020",
            descrizione: "maniglia per porta-finestra scorrevole in acciaio inox",
            tipo: "scorrevole",
            serie: "3",
            colori: ["43"],
            supplemento: 50.8
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 4
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie4: {
        "1040": {
            codice: "1040",
            descrizione: "maniglia senza rosetta",
            tipo: "finestra",
            serie: "4",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 19.6,
            supplementoExtra: {
                "M07": 63.1
            }
        },
        "1041": {
            codice: "1041",
            descrizione: "maniglia senza rosetta",
            tipo: "finestra",
            serie: "4",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 19.6,
            supplementoExtra: {
                "M07": 63.1
            }
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 11
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie11: {
        // FINESTRE
        "1901": {
            codice: "1901",
            descrizione: "maniglia per finestra serie 11 con fissaggio a scomparsa e rosetta rotonda",
            tipo: "finestra",
            serie: "11",
            colori: ["56", "43", "E03"],
            supplemento: 31.3,
            supplementoExtra: {
                "E03": 35.2,
                "extra": 75.1
            }
        },
        
        "19110": {
            codice: "19110",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "11",
            colori: ["56", "43", "E03"],
            supplemento: 26.2,
            supplementoExtra: {
                "E03": 28.8,
                "extra": 70.0
            }
        },
        "19111": {
            codice: "19111",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "11",
            colori: ["56", "43", "E03"],
            supplemento: 26.2,
            supplementoExtra: {
                "E03": 28.8,
                "extra": 70.0
            }
        },
        "19112": {
            codice: "19112",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "11",
            colori: ["56", "43", "E03"],
            supplemento: 26.2,
            supplementoExtra: {
                "E03": 28.8,
                "extra": 70.0
            }
        },
        
        "49110": {
            codice: "49110",
            descrizione: "maniglia a pressione serie 11 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "11",
            colori: ["56", "43", "E03"],
            supplemento: 59.9,
            supplementoExtra: {
                "E03": 68.6,
                "extra": 104
            }
        },
        "49111": {
            codice: "49111",
            descrizione: "maniglia a pressione serie 11 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "11",
            colori: ["56", "43", "E03"],
            supplemento: 59.9,
            supplementoExtra: {
                "E03": 68.6,
                "extra": 104
            }
        },
        
        // PORTA-FINESTRA
        "29110": {
            codice: "29110",
            descrizione: "doppia maniglia serie 11 apertura ad anta - rosetta inferiore fissata dall'esterno",
            tipo: "porta-finestra",
            serie: "11",
            colori: ["56", "43", "E03"],
            supplemento: 67.6,
            supplementoExtra: {
                "E03": 71.6,
                "extra": 155
            }
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 12
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie12: {
        "1902": {
            codice: "1902",
            descrizione: "maniglia per finestra serie 12 con fissaggio a scomparsa e rosetta rotonda",
            tipo: "finestra",
            serie: "12",
            colori: ["56", "43", "E03"],
            supplemento: 36.5,
            supplementoExtra: {
                "43": 58.7,
                "E03": 40.4,
                "extra": 80.3
            }
        },
        
        "19120": {
            codice: "19120",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "12",
            colori: ["56", "43", "E03"],
            supplemento: 30.7,
            supplementoExtra: {
                "43": 53.9,
                "E03": 34.6,
                "extra": 74.6
            }
        },
        "19122": {
            codice: "19122",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "12",
            colori: ["56", "43", "E03"],
            supplemento: 30.7,
            supplementoExtra: {
                "43": 53.9,
                "E03": 34.6,
                "extra": 74.6
            }
        },
        
        "49120": {
            codice: "49120",
            descrizione: "maniglia a pressione serie 12 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "12",
            colori: ["56", "43", "E03"],
            supplemento: 64.4,
            supplementoExtra: {
                "43": 96.8,
                "E03": 74.4,
                "extra": 108
            }
        },
        
        "29120": {
            codice: "29120",
            descrizione: "doppia maniglia serie 12 apertura ad anta - rosetta inferiore fissata dall'esterno",
            tipo: "porta-finestra",
            serie: "12",
            colori: ["56", "43", "E03"],
            supplemento: 77.4,
            supplementoExtra: {
                "43": 134,
                "E03": 82.6,
                "extra": 165
            }
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 13
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie13: {
        "1903": {
            codice: "1903",
            descrizione: "maniglia per finestra serie 13 con fissaggio a scomparsa e rosetta rotonda",
            tipo: "finestra",
            serie: "13",
            colori: ["56", "43", "E03"],
            supplemento: 60.0,
            supplementoExtra: {
                "43": 89.9,
                "E03": 70.4,
                "extra": 104
            }
        },
        
        "19130": {
            codice: "19130",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "13",
            colori: ["56", "43", "E03"],
            supplemento: 56.5,
            supplementoExtra: {
                "43": 86.2,
                "E03": 65.6,
                "extra": 100
            }
        },
        "19131": {
            codice: "19131",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "13",
            colori: ["56", "43", "E03"],
            supplemento: 56.5,
            supplementoExtra: {
                "43": 86.2,
                "E03": 65.6,
                "extra": 100
            }
        },
        "19132": {
            codice: "19132",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "13",
            colori: ["56", "43", "E03"],
            supplemento: 56.5,
            supplementoExtra: {
                "43": 86.2,
                "E03": 65.6,
                "extra": 100
            }
        },
        
        "49130": {
            codice: "49130",
            descrizione: "maniglia a pressione serie 13 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "13",
            colori: ["56", "43", "E03"],
            supplemento: 90.2,
            supplementoExtra: {
                "43": 129,
                "E03": 105,
                "extra": 134
            }
        },
        "49131": {
            codice: "49131",
            descrizione: "maniglia a pressione serie 13 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "13",
            colori: ["56", "43", "E03"],
            supplemento: 90.2,
            supplementoExtra: {
                "43": 129,
                "E03": 105,
                "extra": 134
            }
        },
        
        "29130": {
            codice: "29130",
            descrizione: "doppia maniglia serie 13 apertura ad anta - rosetta inferiore fissata dall'esterno",
            tipo: "porta-finestra",
            serie: "13",
            colori: ["56", "43", "E03"],
            supplemento: 127,
            supplementoExtra: {
                "43": 199,
                "E03": 144,
                "extra": 214
            }
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 14
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie14: {
        "1904": {
            codice: "1904",
            descrizione: "maniglia per finestra serie 14 con fissaggio a scomparsa e rosetta rotonda",
            tipo: "finestra",
            serie: "14",
            colori: ["56", "43", "E03"],
            supplemento: 41.3,
            supplementoExtra: {
                "E03": 52.9,
                "extra": 85.1
            }
        },
        
        "19140": {
            codice: "19140",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "14",
            colori: ["56", "43", "E03"],
            supplemento: 34.6,
            supplementoExtra: {
                "E03": 38.5,
                "extra": 78.4
            }
        },
        "19141": {
            codice: "19141",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "14",
            colori: ["56", "43", "E03"],
            supplemento: 34.6,
            supplementoExtra: {
                "E03": 38.5,
                "extra": 78.4
            }
        },
        "19142": {
            codice: "19142",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "14",
            colori: ["56", "43", "E03"],
            supplemento: 34.6,
            supplementoExtra: {
                "E03": 38.5,
                "extra": 78.4
            }
        },
        
        "49140": {
            codice: "49140",
            descrizione: "maniglia a pressione serie 14 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "14",
            colori: ["56", "43", "E03"],
            supplemento: 68.2,
            supplementoExtra: {
                "E03": 78.2,
                "extra": 112
            }
        },
        "49141": {
            codice: "49141",
            descrizione: "maniglia a pressione serie 14 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "14",
            colori: ["56", "43", "E03"],
            supplemento: 68.2,
            supplementoExtra: {
                "E03": 78.2,
                "extra": 112
            }
        },
        
        "29140": {
            codice: "29140",
            descrizione: "doppia maniglia serie 14 apertura ad anta - rosetta inferiore fissata dall'esterno",
            tipo: "porta-finestra",
            serie: "14",
            colori: ["56", "43", "E03"],
            supplemento: 83.9,
            supplementoExtra: {
                "E03": 90.3,
                "extra": 172
            }
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 15
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie15: {
        "1905": {
            codice: "1905",
            descrizione: "maniglia per finestra serie 15 con fissaggio a scomparsa e rosetta rotonda",
            tipo: "finestra",
            serie: "15",
            colori: ["56", "43", "E03"],
            supplemento: 37.2,
            supplementoExtra: {
                "43": 59.1,
                "E03": 46.2,
                "extra": 81.0
            }
        },
        
        "19150": {
            codice: "19150",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "15",
            colori: ["56", "43", "E03"],
            supplemento: 30.7,
            supplementoExtra: {
                "43": 52.7,
                "E03": 38.5,
                "extra": 74.6
            }
        },
        "19151": {
            codice: "19151",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "15",
            colori: ["56", "43", "E03"],
            supplemento: 30.7,
            supplementoExtra: {
                "43": 52.7,
                "E03": 38.5,
                "extra": 74.6
            }
        },
        "19152": {
            codice: "19152",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "15",
            colori: ["56", "43", "E03"],
            supplemento: 30.7,
            supplementoExtra: {
                "43": 52.7,
                "E03": 38.5,
                "extra": 74.6
            }
        },
        
        "49150": {
            codice: "49150",
            descrizione: "maniglia a pressione serie 15 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "15",
            colori: ["56", "43", "E03"],
            supplemento: 64.4,
            supplementoExtra: {
                "43": 95.5,
                "E03": 78.2,
                "extra": 108
            }
        },
        "49151": {
            codice: "49151",
            descrizione: "maniglia a pressione serie 15 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "15",
            colori: ["56", "43", "E03"],
            supplemento: 64.4,
            supplementoExtra: {
                "43": 95.5,
                "E03": 78.2,
                "extra": 108
            }
        },
        
        "29150": {
            codice: "29150",
            descrizione: "doppia maniglia serie 15 apertura ad anta - rosetta inferiore fissata dall'esterno",
            tipo: "porta-finestra",
            serie: "15",
            colori: ["56", "43", "E03"],
            supplemento: 76.1,
            supplementoExtra: {
                "43": 132,
                "E03": 89.0,
                "extra": 164
            }
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 16
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie16: {
        "1906": {
            codice: "1906",
            descrizione: "maniglia per finestra serie 16 con fissaggio a scomparsa e rosetta rotonda",
            tipo: "finestra",
            serie: "16",
            colori: ["56", "43", "E03"],
            supplemento: 53.7,
            supplementoExtra: {
                "43": 103,
                "E03": 61.3,
                "extra": 97.5
            }
        },
        
        "19160": {
            codice: "19160",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "16",
            colori: ["56", "43", "E03"],
            supplemento: 47.3,
            supplementoExtra: {
                "43": 95.8,
                "E03": 53.7,
                "extra": 91.1
            }
        },
        "19161": {
            codice: "19161",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "16",
            colori: ["56", "43", "E03"],
            supplemento: 47.3,
            supplementoExtra: {
                "43": 95.8,
                "E03": 53.7,
                "extra": 91.1
            }
        },
        "19162": {
            codice: "19162",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "16",
            colori: ["56", "43", "E03"],
            supplemento: 47.3,
            supplementoExtra: {
                "43": 95.8,
                "E03": 53.7,
                "extra": 91.1
            }
        },
        
        "49160": {
            codice: "49160",
            descrizione: "maniglia a pressione serie 16 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "16",
            colori: ["56", "43", "E03"],
            supplemento: 80.9,
            supplementoExtra: {
                "43": 139,
                "E03": 93.4,
                "extra": 125
            }
        },
        "49161": {
            codice: "49161",
            descrizione: "maniglia a pressione serie 16 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "16",
            colori: ["56", "43", "E03"],
            supplemento: 80.9,
            supplementoExtra: {
                "43": 139,
                "E03": 93.4,
                "extra": 125
            }
        },
        
        "29160": {
            codice: "29160",
            descrizione: "doppia maniglia serie 16 apertura ad anta - rosetta inferiore fissata dall'esterno",
            tipo: "porta-finestra",
            serie: "16",
            colori: ["56", "43", "E03"],
            supplemento: 110,
            supplementoExtra: {
                "43": 218,
                "E03": 120,
                "extra": 198
            }
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ACCESSORI
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    accessori: {
        "690": {
            codice: "690",
            descrizione: "rosetta per maniglia estraibile",
            tipo: "accessorio",
            colori: ["01", "56"],
            supplemento: 1.63
        },
        "691": {
            codice: "691",
            descrizione: "maniglia estraibile",
            tipo: "accessorio",
            colori: ["01", "56"],
            supplemento: 4.09
        },
        "100": {
            codice: "100",
            descrizione: "senza maniglia solo foro maniglia (per finestra)",
            tipo: "accessorio",
            colori: [],
            supplemento: -5.34
        },
        "100HY": {
            codice: "100HY",
            descrizione: "senza maniglia solo foro maniglia (per finestra)",
            tipo: "accessorio",
            colori: [],
            supplemento: -5.34
        },
        "1900": {
            codice: "1900",
            descrizione: "senza maniglia, foro per fissaggio a scomparsa della maniglia estraibile per finestre del produttore FSB",
            tipo: "accessorio",
            colori: [],
            supplemento: -5.34
        },
        "97": {
            codice: "97",
            descrizione: "senza maniglia solo foro maniglia (per porta-finestra con chiave)",
            tipo: "accessorio",
            colori: [],
            supplemento: -14.1
        },
        "99": {
            codice: "99",
            descrizione: "senza maniglia solo foro maniglia (con placca per porta-finestra con chiave)",
            tipo: "accessorio",
            colori: [],
            supplemento: -25.4
        },
        "96": {
            codice: "96",
            descrizione: "senza maniglia solo foro maniglia (con rosetta per porta-finestra con chiave)",
            tipo: "accessorio",
            colori: [],
            supplemento: -25.4
        },
        "70": {
            codice: "70",
            descrizione: "accessorio anta per protezione antiperforazione",
            tipo: "accessorio",
            colori: [],
            supplemento: 4.41
        }
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNZIONI HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Ottiene maniglia per codice
function getManigliaByCode(codice) {
    // âœ… v8.10: Cerca codice esatto
    for (const serie in MANIGLIE_FINSTRAL) {
        if (serie === 'colori' || serie === 'accessori') continue;
        if (MANIGLIE_FINSTRAL[serie][codice]) {
            return MANIGLIE_FINSTRAL[serie][codice];
        }
    }
    
    // âœ… v8.10: Se non trovato e codice Ã¨ 3 cifre, prova con "0" alla fine (712 â†’ 7120)
    if (codice && codice.length === 3) {
        const codiceEsteso = codice + "0";
        for (const serie in MANIGLIE_FINSTRAL) {
            if (serie === 'colori' || serie === 'accessori') continue;
            if (MANIGLIE_FINSTRAL[serie][codiceEsteso]) {
                console.log(`ğŸ”§ Maniglia: ${codice} â†’ ${codiceEsteso} (padding)`);
                return MANIGLIE_FINSTRAL[serie][codiceEsteso];
            }
        }
    }
    
    return null;
}

// Ottiene supplemento per maniglia+colore
function getSupplemento(codiceManiglia, codiceColore) {
    const maniglia = getManigliaByCode(codiceManiglia);
    if (!maniglia) return 0;
    
    // Supplemento base
    let supplemento = maniglia.supplemento || 0;
    
    // Supplemento extra per colore specifico
    if (maniglia.supplementoExtra && maniglia.supplementoExtra[codiceColore]) {
        supplemento = maniglia.supplementoExtra[codiceColore];
    }
    
    return supplemento;
}

// Ottiene descrizione colore
function getColoreDescrizione(codiceColore) {
    return MANIGLIE_FINSTRAL.colori[codiceColore] || codiceColore;
}

// Ottiene lista maniglie per tipo
function getManiglieByTipo(tipo) {
    const risultato = [];
    for (const serie in MANIGLIE_FINSTRAL) {
        if (serie === 'colori' || serie === 'accessori') continue;
        for (const codice in MANIGLIE_FINSTRAL[serie]) {
            const maniglia = MANIGLIE_FINSTRAL[serie][codice];
            if (maniglia.tipo === tipo) {
                risultato.push(maniglia);
            }
        }
    }
    return risultato;
}

// Export per uso in altri file
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        MANIGLIE_FINSTRAL,
        getManigliaByCode,
        getSupplemento,
        getColoreDescrizione,
        getManiglieByTipo
    };
}
        // Modulo Calcolatore Preventivi - EMBEDDED
        const PreventivoCalculator = {
            listini: {
                zanzariere: {
                    modelli: [
                        { modello: "EXTREMA", fascia_1: 164.0, fascia_2: 189.6, fascia_3: 199.8, fascia_4: 210.0 },
                        { modello: "FUTURA", fascia_1: 137.0, fascia_2: 158.2, fascia_3: 166.7, fascia_4: 175.3 },
                        { modello: "ORIZZ SCORR", fascia_1: 173.0, fascia_2: 199.8, fascia_3: 210.6, fascia_4: 221.4 },
                        { modello: "PANN SCORR VERT", fascia_1: 212.0, fascia_2: 244.8, fascia_3: 258.0, fascia_4: 271.2 },
                        { modello: "VERT SCORR", fascia_1: 102.0, fascia_2: 117.8, fascia_3: 124.2, fascia_4: 130.6 },
                        { modello: "PLISS+CONT MANUALE", fascia_1: 108.0, fascia_2: 124.7, fascia_3: 131.4, fascia_4: 138.2 },
                        { modello: "PLISS+CONT MOLLA", fascia_1: 115.0, fascia_2: 132.8, fascia_3: 140.0, fascia_4: 147.2 },
                        { modello: "PLISS ORIZZ", fascia_1: 245.0, fascia_2: 283.0, fascia_3: 298.2, fascia_4: 313.4 },
                        { modello: "SOTTO FINESTRA", fascia_1: 84.0, fascia_2: 97.0, fascia_3: 102.2, fascia_4: 107.5 },
                        { modello: "1 ANTA", fascia_1: 45.0, fascia_2: 52.0, fascia_3: 54.8, fascia_4: 57.6 },
                        { modello: "2 ANTE", fascia_1: 75.0, fascia_2: 86.6, fascia_3: 91.3, fascia_4: 96.0 },
                        { modello: "1 ANTA+CONT MANUALE", fascia_1: 59.0, fascia_2: 68.1, fascia_3: 71.8, fascia_4: 75.5 },
                        { modello: "2 ANTE+CONT MANUALE", fascia_1: 100.0, fascia_2: 115.5, fascia_3: 121.7, fascia_4: 128.0 },
                        { modello: "1 ANTA+CONT MOLLA", fascia_1: 66.0, fascia_2: 76.2, fascia_3: 80.3, fascia_4: 84.5 },
                        { modello: "2 ANTE+CONT MOLLA", fascia_1: 111.0, fascia_2: 128.2, fascia_3: 135.1, fascia_4: 142.1 },
                        { modello: "ROBY SCORREVOLE", fascia_1: 112.0, fascia_2: 129.4, fascia_3: 136.3, fascia_4: 143.4 },
                        { modello: "AVVOLG MINI", fascia_1: 84.0, fascia_2: 97.0, fascia_3: 102.2, fascia_4: 107.5 },
                        { modello: "AVVOLG SMART", fascia_1: 90.0, fascia_2: 104.0, fascia_3: 109.6, fascia_4: 115.2 },
                        { modello: "AVVOLG ORIZZ", fascia_1: 186.0, fascia_2: 214.9, fascia_3: 226.5, fascia_4: 238.1 },
                        { modello: "PLISS+CONT MANUALE COL", fascia_1: 108.0, fascia_2: 124.7, fascia_3: 131.4, fascia_4: 138.2 },
                        { modello: "PLISS+CONT MOLLA COL", fascia_1: 115.0, fascia_2: 132.8, fascia_3: 140.0, fascia_4: 147.2 },
                        { modello: "PLISS ORIZZ COLORE", fascia_1: 245.0, fascia_2: 283.0, fascia_3: 298.2, fascia_4: 313.4 },
                        { modello: "SOTTO FINESTRA COLORE", fascia_1: 84.0, fascia_2: 97.0, fascia_3: 102.2, fascia_4: 107.5 },
                        { modello: "1 ANTA COLORE", fascia_1: 45.0, fascia_2: 52.0, fascia_3: 54.8, fascia_4: 57.6 },
                        { modello: "2 ANTE COLORE", fascia_1: 75.0, fascia_2: 86.6, fascia_3: 91.3, fascia_4: 96.0 },
                        { modello: "1 ANTA+CONT MANUALE COL", fascia_1: 59.0, fascia_2: 68.1, fascia_3: 71.8, fascia_4: 75.5 },
                        { modello: "2 ANTE+CONT MANUALE COL", fascia_1: 100.0, fascia_2: 115.5, fascia_3: 121.7, fascia_4: 128.0 },
                        { modello: "1 ANTA+CONT MOLLA COL", fascia_1: 66.0, fascia_2: 76.2, fascia_3: 80.3, fascia_4: 84.5 },
                        { modello: "2 ANTE+CONT MOLLA COL", fascia_1: 111.0, fascia_2: 128.2, fascia_3: 135.1, fascia_4: 142.1 },
                        { modello: "AVVOLG MINI COLORE", fascia_1: 84.0, fascia_2: 97.0, fascia_3: 102.2, fascia_4: 107.5 },
                        { modello: "AVVOLG SMART COLORE", fascia_1: 90.0, fascia_2: 104.0, fascia_3: 109.6, fascia_4: 115.2 }
                    ],
                    fasce: [
                        { fascia: 1, min: 0, max: 1.0 },
                        { fascia: 2, min: 1.01, max: 1.5 },
                        { fascia: 3, min: 1.51, max: 2.0 },
                        { fascia: 4, min: 2.01, max: 999 }
                    ]
                },
                persiane: {
                    versione: "1.1 - Alto Adige + Cortina",
                    dataAggiornamento: "2025-11-27",
                    fonte: "Listino Punto Persiane 45/52 Ottobre 2025 + Preventivi Reali",
                    
                    modelli: {
                        "Alto Adige": {
                            descrizione: "Persiana cieca con doghe orizzontali da 125mm",
                            categoria: "Persiane cieche e a doghe",
                            spessore_anta: "45mm",
                            struttura_esterna: "80mm",
                            maggiorazione_modello: 0,  // Prezzo base nella griglia
                            prezzi: {
                                "F1": {
                                    "500x700": 257, "500x800": 275, "500x900": 291, "500x1000": 307,
                                    "600x700": 282, "600x800": 294, "600x900": 336, "600x1000": 349, "600x1100": 362, "600x1200": 376, "600x1300": 389, "600x1400": 398, "600x1500": 414,
                                    "700x700": 306, "700x800": 314, "700x900": 351, "700x1000": 365, "700x1100": 381, "700x1200": 393, "700x1300": 407, "700x1400": 421, "700x1500": 433, "700x1600": 446, "700x1700": 461, "700x1800": 485, "700x1900": 510, "700x2000": 534,
                                    "800x700": 326, "800x800": 338, "800x900": 382, "800x1000": 395, "800x1100": 412, "800x1200": 427, "800x1300": 444, "800x1400": 460, "800x1500": 477, "800x1600": 490, "800x1700": 507, "800x1800": 532, "800x1900": 559, "800x2000": 585,
                                    "900x700": 317, "900x800": 327, "900x900": 365, "900x1000": 382, "900x1100": 394, "900x1200": 409, "900x1300": 424, "900x1400": 441, "900x1500": 455, "900x1600": 469, "900x1700": 483, "900x1800": 509, "900x1900": 534, "900x2000": 561,
                                    "1000x700": 335, "1000x800": 349, "1000x900": 394, "1000x1000": 410, "1000x1100": 427, "1000x1200": 445, "1000x1300": 464, "1000x1400": 479, "1000x1500": 497, "1000x1600": 510, "1000x1700": 529, "1000x1800": 556, "1000x1900": 583, "1000x2000": 610,
                                    "1100x700": 350, "1100x800": 365, "1100x900": 417, "1100x1000": 436, "1100x1100": 457, "1100x1200": 477, "1100x1300": 492, "1100x1400": 510, "1100x1500": 531, "1100x1600": 551, "1100x1700": 572, "1100x1800": 598, "1100x1900": 623, "1100x2000": 649,
                                    "1200x700": 366, "1200x800": 381, "1200x900": 438, "1200x1000": 464, "1200x1100": 485, "1200x1200": 508, "1200x1300": 521, "1200x1400": 542, "1200x1500": 566, "1200x1600": 591, "1200x1700": 614, "1200x1800": 648, "1200x1900": 682, "1200x2000": 715
                                },
                                "F2": {
                                    "800x700": 542, "800x800": 550, "800x900": 565, "800x1000": 579, "800x1100": 602, "800x1200": 623, "800x1300": 648, "800x1400": 658, "800x1500": 684, "800x1600": 698, "800x1700": 720, "800x1800": 755, "800x1900": 773, "800x2000": 790,
                                    "900x700": 546, "900x800": 552, "900x900": 569, "900x1000": 587, "900x1100": 608, "900x1200": 627, "900x1300": 650, "900x1400": 666, "900x1500": 688, "900x1600": 705, "900x1700": 727, "900x1800": 762, "900x1900": 780, "900x2000": 799,
                                    "1000x700": 551, "1000x800": 554, "1000x900": 574, "1000x1000": 593, "1000x1100": 613, "1000x1200": 633, "1000x1300": 652, "1000x1400": 674, "1000x1500": 693, "1000x1600": 711, "1000x1700": 732, "1000x1800": 769, "1000x1900": 789, "1000x2000": 809,
                                    "1100x700": 563, "1100x800": 579, "1100x900": 597, "1100x1000": 614, "1100x1100": 639, "1100x1200": 661, "1100x1300": 682, "1100x1400": 704, "1100x1500": 724, "1100x1600": 746, "1100x1700": 769, "1100x1800": 809, "1100x1900": 830, "1100x2000": 851,
                                    "1200x700": 569, "1200x800": 580, "1200x900": 602, "1200x1000": 622, "1200x1100": 645, "1200x1200": 664, "1200x1300": 688, "1200x1400": 706, "1200x1500": 731, "1200x1600": 751, "1200x1700": 775, "1200x1800": 818, "1200x1900": 845, "1200x2000": 872,
                                    "1300x700": 576, "1300x800": 600, "1300x900": 622, "1300x1000": 646, "1300x1100": 667, "1300x1200": 693, "1300x1300": 716, "1300x1400": 740, "1300x1500": 764, "1300x1600": 785, "1300x1700": 813, "1300x1800": 853, "1300x1900": 876, "1300x2000": 899,
                                    "1400x700": 580, "1400x800": 604, "1400x900": 626, "1400x1000": 650, "1400x1100": 675, "1400x1200": 699, "1400x1300": 720, "1400x1400": 742, "1400x1500": 769, "1400x1600": 790, "1400x1700": 817, "1400x1800": 857, "1400x1900": 878, "1400x2000": 900,
                                    "1500x700": 602, "1500x800": 625, "1500x900": 650, "1500x1000": 674, "1500x1100": 700, "1500x1200": 724, "1500x1300": 750, "1500x1400": 777, "1500x1500": 801, "1500x1600": 827, "1500x1700": 854, "1500x1800": 895, "1500x1900": 920, "1500x2000": 944
                                },
                                "PF1": {
                                    "500x1800": 488, "500x1900": 498, "500x2000": 514, "500x2100": 526, "500x2200": 534, "500x2300": 549, "500x2400": 561, "500x2500": 573, "500x2600": 586, "500x2700": 598,
                                    "600x1800": 542, "600x1900": 559, "600x2000": 569, "600x2100": 591, "600x2200": 604, "600x2300": 620, "600x2400": 633, "600x2500": 649, "600x2600": 666, "600x2700": 683,
                                    "700x1800": 569, "700x1900": 585, "700x2000": 604, "700x2100": 621, "700x2200": 635, "700x2300": 650, "700x2400": 667, "700x2500": 682, "700x2600": 696, "700x2700": 710,
                                    "800x1800": 597, "800x1900": 614, "800x2000": 631, "800x2100": 650, "800x2200": 667, "800x2300": 682, "800x2400": 702, "800x2500": 720, "800x2600": 738, "800x2700": 755,
                                    "900x1800": 675, "900x1900": 694, "900x2000": 715, "900x2100": 737, "900x2200": 757, "900x2300": 779, "900x2400": 797, "900x2500": 816, "900x2600": 835, "900x2700": 854,
                                    "1000x1800": 626, "1000x1900": 644, "1000x2000": 663, "1000x2100": 681, "1000x2200": 698, "1000x2300": 719, "1000x2400": 737, "1000x2500": 755, "1000x2600": 775, "1000x2700": 793,
                                    "1100x1800": 723, "1100x1900": 744, "1100x2000": 767, "1100x2100": 792, "1100x2200": 817, "1100x2300": 839, "1100x2400": 858, "1100x2500": 876, "1100x2600": 895, "1100x2700": 915,
                                    "1200x1800": 515, "1200x1900": 528, "1200x2000": 542, "1200x2100": 559, "1200x2200": 569, "1200x2300": 585, "1200x2400": 597, "1200x2500": 611, "1200x2600": 625, "1200x2700": 640
                                },
                                "PF2": {
                                    "800x1800": 840, "800x1900": 871, "800x2000": 893, "800x2100": 918, "800x2200": 939, "800x2300": 964, "800x2400": 991, "800x2500": 1004, "800x2600": 1017, "800x2700": 1032,
                                    "900x1800": 849, "900x1900": 878, "900x2000": 902, "900x2100": 925, "900x2200": 948, "900x2300": 971, "900x2400": 996, "900x2500": 1017, "900x2600": 1040, "900x2700": 1061,
                                    "1000x1800": 860, "1000x1900": 886, "1000x2000": 910, "1000x2100": 933, "1000x2200": 957, "1000x2300": 979, "1000x2400": 1002, "1000x2500": 1032, "1000x2600": 1061, "1000x2700": 1091,
                                    "1100x1800": 905, "1100x1900": 933, "1100x2000": 960, "1100x2100": 989, "1100x2200": 1014, "1100x2300": 1037, "1100x2400": 1062, "1100x2500": 1088, "1100x2600": 1113, "1100x2700": 1138,
                                    "1200x1800": 911, "1200x1900": 947, "1200x2000": 969, "1200x2100": 997, "1200x2200": 1022, "1200x2300": 1047, "1200x2400": 1071, "1200x2500": 1106, "1200x2600": 1142, "1200x2700": 1178,
                                    "1300x1800": 959, "1300x1900": 995, "1300x2000": 1022, "1300x2100": 1051, "1300x2200": 1078, "1300x2300": 1107, "1300x2400": 1132, "1300x2500": 1160, "1300x2600": 1189, "1300x2700": 1218,
                                    "1400x1800": 1005, "1400x1900": 1047, "1400x2000": 1075, "1400x2100": 1106, "1400x2200": 1135, "1400x2300": 1165, "1400x2400": 1195, "1400x2500": 1225, "1400x2600": 1254, "1400x2700": 1285,
                                    "1500x1800": 1017, "1500x1900": 1051, "1500x2000": 1082, "1500x2100": 1111, "1500x2200": 1143, "1500x2300": 1173, "1500x2400": 1201, "1500x2500": 1229, "1500x2600": 1258, "1500x2700": 1287
                                }
                            }
                        },
                        "Cortina": {
                            descrizione: "Persiana cieca con doghe verticali da 80mm",
                            categoria: "Persiane cieche e a doghe",
                            spessore_anta: "45mm",
                            struttura_esterna: "80mm",
                            maggiorazione_modello: 4,  // +4% rispetto a prezzi griglia base
                            usa_griglia_base: "Alto Adige"  // Usa stessa griglia + maggiorazione
                        },
                        "Nerina": {
                            descrizione: "Persiana cieca con doghe verticali da 80mm, cornice perimetrale a rientro",
                            categoria: "Persiane cieche e a doghe",
                            spessore_anta: "45mm",
                            struttura_esterna: "80mm",
                            maggiorazione_modello: 4,  // +4% rispetto a prezzi griglia base
                            usa_griglia_base: "Alto Adige"
                        },
                        "NERINA": {
                            descrizione: "Scuro in alluminio con doghe verticali a passo di 80mm",
                            categoria: "Persiane cieche e a doghe",
                            spessore_anta: "45mm",
                            struttura_esterna: "80mm",
                            prezzi: {
                                "F2": {
                                    "1400x1300": 842.40,
                                    "1000x1300": 762.84
                                },
                                "F1": {
                                    "600x1300": 496.08
                                },
                                "PF2": {
                                    "1000x2200": 1117.35
                                }
                            }
                        },
                        "OSCURA": {
                            descrizione: "Scuro in alluminio con doghe verticali da 80mm con struttura portante a scomparsa",
                            categoria: "Scuri a doghe",
                            spessore_anta: "53mm",
                            struttura_esterna: "58mm (a scomparsa)",
                            prezzi: {
                                "F2": {
                                    "1000x1300": 815.85,
                                    "1200x1270": 864.85
                                },
                                "F1": {
                                    "700x1275": 498.58
                                }
                            }
                        },
                        "VANITOSA": {
                            descrizione: "Persiana con lamelle orientabili a goccia da 55mm - Tecnologia Ultratech",
                            categoria: "Persiane a stecche orientabili ULTRATECH",
                            spessore_anta: "45mm",
                            struttura_esterna: "80mm",
                            prezzi: {
                                "PF2": {
                                    "1330x2350": 1533.87
                                }
                            }
                        }
                    },
                    
                    telai: {
                        "TH62": { prezzo: 136.00, descrizione: "Telaio standard TH62" },
                        "TH40": { prezzo: 167.00, descrizione: "Telaio standard TH40" },
                        "TH45": { prezzo: 187.00, descrizione: "Telaio standard TH45" }
                    },
                    
                    colori: {
                        categorie: {
                            "1": { maggiorazione: 0, descrizione: "Colori standard" },
                            "2A": { maggiorazione: 3, descrizione: "Colori opachi speciali" },
                            "2B": { maggiorazione: 5, descrizione: "Colori textured" },
                            "3": { maggiorazione: 20, descrizione: "Colori legno polvere su polvere" },
                            "4": { maggiorazione: 25, descrizione: "Colori legno Ã‰lite" },
                            "5": { maggiorazione: 25, descrizione: "Colori legno sublimato Electo" },
                            "6": { maggiorazione: 30, descrizione: "Colori legno sublimato" },
                            "7": { maggiorazione: 30, descrizione: "Colori legno sublimato speciali" },
                            "8": { maggiorazione: null, descrizione: "Colori speciali (a preventivo)" }
                        },
                        colori_specifici: {
                            // CATEGORIA 01 - Nessun supplemento (0%)
                            "CPF910L": { nome: "Bianco puro tipo Ral 9010 opaco", categoria: "1", maggiorazione: 0 },
                            "CPF113L": { nome: "Bianco perla tipo Ral 1013 opaco", categoria: "1", maggiorazione: 0 },
                            "CPF701L": { nome: "Grigio argento tipo Ral 7001 opaco", categoria: "1", maggiorazione: 0 },
                            "CPF716L": { nome: "Antracite tipo Ral 7016 opaco", categoria: "1", maggiorazione: 0 },
                            "CPF605L": { nome: "Verde muschio tipo Ral 6005 opaco", categoria: "1", maggiorazione: 0 },
                            "CPF609T": { nome: "Verde abete textured tipo Ral 6009 ruvido", categoria: "1", maggiorazione: 0 },
                            "CPF817L": { nome: "Marrone cioccolato tipo Ral 8017 opaco", categoria: "1", maggiorazione: 0 },
                            
                            // CATEGORIA 02A - +3%
                            "CPF735L": { nome: "Grigio luce tipo Ral 7035 opaco", categoria: "2A", maggiorazione: 3 },
                            "CPF609L": { nome: "Verde abete tipo Ral 6009 semiopaco", categoria: "2A", maggiorazione: 3 },
                            "CPF621L": { nome: "Verde pallido tipo Ral 6021 opaco", categoria: "2A", maggiorazione: 3 },
                            "CPF119L": { nome: "Beige tipo Ral 1019 opaco", categoria: "2A", maggiorazione: 3 },
                            "CPF524L": { nome: "Azzurro pastello tipo Ral 5024 opaco", categoria: "2A", maggiorazione: 3 },
                            "CPF811L": { nome: "Marrone Nuss tipo Ral 8011 opaco", categoria: "2A", maggiorazione: 3 },
                            
                            // CATEGORIA 02B - +5%
                            "CPF910T": { nome: "Bianco puro textured tipo Ral 9010 ruvido", categoria: "2B", maggiorazione: 5 },
                            "CPF113T": { nome: "Bianco perla textured tipo Ral 1013 ruvido", categoria: "2B", maggiorazione: 5 },
                            "CPF701T": { nome: "Grigio argento textured tipo Ral 7001 ruvido", categoria: "2B", maggiorazione: 5 },
                            "CPF305T": { nome: "Rosso vino textured tipo Ral 3005 ruvido", categoria: "2B", maggiorazione: 5 },
                            "CPF605T": { nome: "Verde foglia textured tipo Ral 6005 ruvido", categoria: "2B", maggiorazione: 5 },
                            "CPF817T": { nome: "Marrone cioccolato textured tipo Ral 8017 ruvido", categoria: "2B", maggiorazione: 5 },
                            
                            // CATEGORIA 03 - +20% (Colori legno polvere su polvere Ezy)
                            "CPF820H": { nome: "Grey Oak", categoria: "3", maggiorazione: 20 },
                            "CPF818H": { nome: "Renolit Vulcano", categoria: "3", maggiorazione: 20 },
                            "CPF813H": { nome: "Renolit Gold", categoria: "3", maggiorazione: 20 },
                            "CPFR811": { nome: "Marrone Renolit scuro", categoria: "3", maggiorazione: 20 },
                            "CPF812H": { nome: "Marrone Renolit dorato", categoria: "3", maggiorazione: 20 },
                            "CPFN630": { nome: "Acacia - effetto rigato", categoria: "3", maggiorazione: 20 },
                            "CPFN632": { nome: "Noce Reale - effetto rigato", categoria: "3", maggiorazione: 20 },
                            
                            // CATEGORIA 04 - +25% (Colori legno Ã‰lite)
                            "HD303": { nome: "Polar Ash", categoria: "4", maggiorazione: 25 },
                            "HD360": { nome: "Silver Ash", categoria: "4", maggiorazione: 25 },
                            "HD366": { nome: "Dark Ash", categoria: "4", maggiorazione: 25 },
                            
                            // CATEGORIA 05 - +25% (Colori legno / sublimato Electo)
                            "CPF90RC": { nome: "Marrone RENOLIT CHIARO ruvido", categoria: "5", maggiorazione: 25 },
                            "CPF91RS": { nome: "Marrone RENOLIT SCURO ruvido", categoria: "5", maggiorazione: 25 },
                            "CPF51CR": { nome: "Marrone ciliegio Renoir ruvido", categoria: "5", maggiorazione: 25 },
                            
                            // CATEGORIA 06 - +30% (Colori legno / sublimato)
                            "CPF358R": { nome: "Douglas tipo 335-80R", categoria: "6", maggiorazione: 30 },
                            "CPF127R": { nome: "Noce scuro ruvido tipo 102-70R", categoria: "6", maggiorazione: 30 },
                            "CPF375R": { nome: "Castagno chiaro ruvido tipo 375-80R", categoria: "6", maggiorazione: 30 },
                            "CPF378R": { nome: "Castagno scuro ruvido tipo 378-70R", categoria: "6", maggiorazione: 30 },
                            "CPF317R": { nome: "Ciliegio chiaro ruvido tipo 317-70R", categoria: "6", maggiorazione: 30 },
                            
                            // CATEGORIA 07 - +30%
                            "CPF70KA": { nome: "Winchester", categoria: "7", maggiorazione: 30 },
                            
                            // CATEGORIA 08 - A PREVENTIVO (Colori speciali)
                            "CPFSLV7": { nome: "Verde Salvia", categoria: "8", maggiorazione: null },
                            "CPFRGG4": { nome: "Ruggine EVO", categoria: "8", maggiorazione: null },
                            "CPF744L": { nome: "Grigio seta tipo RAL 7044 opaco", categoria: "8", maggiorazione: null }
                        }
                    },
                    
                    supplementi: {
                        contributo_gestione: 57.00,
                        imballo_percentuale: 3.0
                    }
                }
            },
            
            calcolaZanzariera(datiRilievo) {
                try {
                    const { larghezza, altezza, modello } = datiRilievo;
                    if (!larghezza || !altezza) throw new Error("Misure mancanti");
                    
                    const superficie_mq = (larghezza * altezza) / 10000;
                    const modelloData = this.listini.zanzariere.modelli.find(
                        m => m.modello.toUpperCase() === (modello || "").toUpperCase()
                    );
                    
                    if (!modelloData) throw new Error(`Modello "${modello}" non trovato`);
                    
                    let fasciaPrezzo = 1;
                    for (const fascia of this.listini.zanzariere.fasce) {
                        if (superficie_mq >= fascia.min && superficie_mq <= fascia.max) {
                            fasciaPrezzo = fascia.fascia;
                            break;
                        }
                    }
                    
                    const prezzoCampo = `fascia_${fasciaPrezzo}`;
                    const prezzoUnitario = modelloData[prezzoCampo];
                    const prezzoTotale = prezzoUnitario;
                    
                    return {
                        successo: true,
                        prodotto: "Zanzariera",
                        modello: modelloData.modello,
                        misure: {
                            larghezza: larghezza,
                            altezza: altezza,
                            superficie_mq: superficie_mq.toFixed(2)
                        },
                        fascia: fasciaPrezzo,
                        prezzi: {
                            unitario: prezzoUnitario.toFixed(2),
                            totale: prezzoTotale.toFixed(2),
                            iva: (prezzoTotale * 0.22).toFixed(2),
                            totale_iva: (prezzoTotale * 1.22).toFixed(2)
                        }
                    };
                } catch (error) {
                    return { successo: false, errore: error.message };
                }
            },
            
            calcolaPersiana(datiRilievo) {
                try {
                    const { larghezza, altezza, modello, telaio, colore, tipologia } = datiRilievo;
                    
                    // Validazione base
                    if (!larghezza || !altezza) throw new Error("Misure mancanti");
                    if (!modello) throw new Error("Modello mancante");
                    
                    // Verifica modello esiste
                    if (!this.listini.persiane.modelli[modello]) {
                        throw new Error(`Modello "${modello}" non trovato nel listino`);
                    }
                    
                    let mod = this.listini.persiane.modelli[modello];
                    let maggiorazioneModello = mod.maggiorazione_modello || 0;
                    
                    // ğŸ†• v7.86: Se il modello usa griglia base di altro modello
                    if (mod.usa_griglia_base) {
                        const modBase = this.listini.persiane.modelli[mod.usa_griglia_base];
                        if (modBase && modBase.prezzi) {
                            mod = { ...mod, prezzi: modBase.prezzi };
                        }
                    }
                    
                    // ğŸ†• v7.86: Arrotondamento misure secondo regole listino Punto Persiane
                    // Ultime 2 cifre: <=49 arrotonda in difetto, >49 arrotonda in eccesso
                    function arrotondaMisura(mm) {
                        const ultime2cifre = mm % 100;
                        if (ultime2cifre <= 49) {
                            return Math.floor(mm / 100) * 100;
                        } else {
                            return Math.ceil(mm / 100) * 100;
                        }
                    }
                    
                    const L_arr = arrotondaMisura(larghezza);
                    const H_arr = arrotondaMisura(altezza);
                    const key = `${L_arr}x${H_arr}`;
                    const tip = tipologia || "F2"; // Default F2 se non specificato
                    
                    console.log(`ğŸ“ Persiana ${modello} ${tip}: ${larghezza}x${altezza}mm â†’ arrotondato ${key}`);
                    
                    let prezzoBase = 0;
                    let dimensioneUsata = key;
                    
                    if (mod.prezzi && mod.prezzi[tip] && mod.prezzi[tip][key]) {
                        // Trovato prezzo esatto
                        prezzoBase = mod.prezzi[tip][key];
                    } else if (mod.prezzi && mod.prezzi[tip]) {
                        // Cerca dimensione disponibile piÃ¹ vicina come fallback
                        const dimensioniDisponibili = Object.keys(mod.prezzi[tip]);
                        if (dimensioniDisponibili.length > 0) {
                            // Trova la dimensione piÃ¹ vicina
                            let minDiff = Infinity;
                            let bestKey = dimensioniDisponibili[0];
                            
                            dimensioniDisponibili.forEach(dk => {
                                const [dL, dH] = dk.split('x').map(Number);
                                const diff = Math.abs(dL - L_arr) + Math.abs(dH - H_arr);
                                if (diff < minDiff) {
                                    minDiff = diff;
                                    bestKey = dk;
                                }
                            });
                            
                            prezzoBase = mod.prezzi[tip][bestKey];
                            dimensioneUsata = bestKey;
                            console.warn(`âš ï¸ Persiana ${modello}: dimensione ${key} non trovata, uso ${bestKey}`);
                        } else {
                            throw new Error(`Nessuna dimensione disponibile per ${modello} ${tip}`);
                        }
                    } else {
                        throw new Error(`Tipologia ${tip} non disponibile per ${modello}`);
                    }
                    
                    // Applica maggiorazione modello (es. Cortina +4%)
                    if (maggiorazioneModello > 0) {
                        prezzoBase = prezzoBase * (1 + maggiorazioneModello / 100);
                        console.log(`ğŸ“Š Maggiorazione modello +${maggiorazioneModello}%: â‚¬${prezzoBase.toFixed(2)}`);
                    }
                    
                    // Aggiungi telaio se presente
                    let prezzoTelaio = 0;
                    if (telaio && this.listini.persiane.telai[telaio]) {
                        prezzoTelaio = this.listini.persiane.telai[telaio].prezzo;
                    }
                    
                    const subtotale = prezzoBase + prezzoTelaio;
                    
                    // Applica maggiorazione colore
                    let maggiorazioneColore = 0;
                    let percColore = 0;
                    let nomeColore = "N/D";
                    
                    if (colore && this.listini.persiane.colori.colori_specifici[colore]) {
                        const colData = this.listini.persiane.colori.colori_specifici[colore];
                        percColore = colData.maggiorazione;
                        nomeColore = colData.nome;
                        maggiorazioneColore = subtotale * (percColore / 100);
                    }
                    
                    const totaleProdotto = subtotale + maggiorazioneColore;
                    
                    // Aggiungi supplementi
                    const contributo = this.listini.persiane.supplementi.contributo_gestione;
                    const conContributo = totaleProdotto + contributo;
                    
                    // Aggiungi imballo
                    const percImballo = this.listini.persiane.supplementi.imballo_percentuale;
                    const imballo = conContributo * (percImballo / 100);
                    const prezzoFinale = conContributo + imballo;
                    
                    return {
                        successo: true,
                        prodotto: "Persiana",
                        modello: `${modello} - ${mod.descrizione || modello}`,
                        tipologia: tip,
                        misure: {
                            larghezza: larghezza,
                            altezza: altezza,
                            larghezza_arrotondata: L_arr,
                            altezza_arrotondata: H_arr,
                            dimensione: dimensioneUsata
                        },
                        dettaglio: {
                            prezzo_base: prezzoBase.toFixed(2),
                            maggiorazione_modello: maggiorazioneModello,
                            telaio: prezzoTelaio.toFixed(2),
                            subtotale: subtotale.toFixed(2),
                            colore_perc: percColore,
                            colore_nome: nomeColore,
                            maggiorazione_colore: maggiorazioneColore.toFixed(2),
                            totale_prodotto: totaleProdotto.toFixed(2),
                            contributo_gestione: contributo.toFixed(2),
                            imballo: imballo.toFixed(2)
                        },
                        prezzi: {
                            totale: prezzoFinale.toFixed(2),
                            iva: (prezzoFinale * 0.22).toFixed(2),
                            totale_iva: (prezzoFinale * 1.22).toFixed(2)
                        }
                    };
                    
                } catch (error) {
                    console.error("âŒ Errore calcolo persiana:", error);
                    return { successo: false, errore: error.message };
                }
            },
            
            calcolaProgetto(datiProgetto) {
                const risultati = {
                    successo: true,
                    progetto: datiProgetto.nome || datiProgetto.projectName || "Progetto",
                    cliente: datiProgetto.cliente || datiProgetto.clientData || {},
                    timestamp: new Date().toISOString(),
                    prodotti: [],
                    totale: 0,
                    totale_iva: 0
                };
                
                if (datiProgetto.posizioni && Array.isArray(datiProgetto.posizioni)) {
                    datiProgetto.posizioni.forEach((pos, idx) => {
                        if (pos.zanzariera && pos.zanzariera.modello) {
                            const calc = this.calcolaZanzariera({
                                larghezza: pos.zanzariera.brm?.L || 0,
                                altezza: pos.zanzariera.brm?.H || 0,
                                modello: pos.zanzariera.modello
                            });
                            
                            if (calc.successo) {
                                risultati.prodotti.push({
                                    posizione: pos.nome || `Posizione ${idx + 1}`,
                                    ...calc
                                });
                                risultati.totale += parseFloat(calc.prezzi.totale);
                                risultati.totale_iva += parseFloat(calc.prezzi.totale_iva);
                            }
                        }
                        
                        if (pos.persiana && pos.persiana.modello) {
                            // Controlla se esiste prezzo manuale
                            if (pos.persiana.prezzoManuale && pos.persiana.prezzoManuale.totaleFinale) {
                                // Usa prezzo manuale
                                const pm = pos.persiana.prezzoManuale;
                                risultati.prodotti.push({
                                    posizione: pos.nome || `Posizione ${idx + 1}`,
                                    successo: true,
                                    prodotto: "Persiana",
                                    modello: `${pos.persiana.modello} - ${pm.dimensione} (MANUALE)`,
                                    tipologia: pos.persiana.tipologia || 'N/D',
                                    misure: {
                                        larghezza: pos.persiana.brm?.L || 0,
                                        altezza: pos.persiana.brm?.H || 0,
                                        dimensione: pm.dimensione
                                    },
                                    dettaglio: {
                                        prezzo_base: pm.prezzoBase.toFixed(2),
                                        telaio: pm.prezzoTelaio.toFixed(2),
                                        subtotale: (pm.prezzoBase + pm.prezzoTelaio).toFixed(2),
                                        colore_perc: pm.colorePercentuale,
                                        colore_nome: 'Manuale',
                                        maggiorazione_colore: pm.maggiorazioneColore.toFixed(2),
                                        totale_prodotto: pm.totaleProdotto.toFixed(2),
                                        contributo_gestione: pm.contributo.toFixed(2),
                                        imballo: pm.imballo.toFixed(2)
                                    },
                                    prezzi: {
                                        totale: pm.totaleFinale.toFixed(2),
                                        iva: (pm.totaleFinale * 0.22).toFixed(2),
                                        totale_iva: (pm.totaleFinale * 1.22).toFixed(2)
                                    },
                                    manuale: true,
                                    note_manuale: pm.note || ''
                                });
                                risultati.totale += parseFloat(pm.totaleFinale);
                                risultati.totale_iva += parseFloat((pm.totaleFinale * 1.22).toFixed(2));
                                console.log(`âœ… Persiana ${idx + 1}: Prezzo MANUALE â‚¬${pm.totaleFinale.toFixed(2)}`);
                            } else {
                                // Prova calcolo automatico
                                const calc = this.calcolaPersiana({
                                    larghezza: pos.persiana.brm?.L || 0,
                                    altezza: pos.persiana.brm?.H || 0,
                                    modello: pos.persiana.modello,
                                    tipologia: pos.persiana.tipologia || "F2",
                                    telaio: pos.persiana.telaio || "",
                                    colore: pos.persiana.colore || ""
                                });
                                
                                if (calc.successo) {
                                    risultati.prodotti.push({
                                        posizione: pos.nome || `Posizione ${idx + 1}`,
                                        ...calc
                                    });
                                    risultati.totale += parseFloat(calc.prezzi.totale);
                                    risultati.totale_iva += parseFloat(calc.prezzi.totale_iva);
                                } else {
                                    // Calcolo fallito - Log warning
                                    console.warn(`âš ï¸ Persiana posizione ${idx + 1}: ${calc.errore}. Richiede inserimento manuale.`);
                                    risultati.prodotti.push({
                                        posizione: pos.nome || `Posizione ${idx + 1}`,
                                        successo: false,
                                        prodotto: "Persiana",
                                        errore: calc.errore,
                                        richiede_inserimento_manuale: true,
                                        dati_persiana: {
                                            modello: pos.persiana.modello,
                                            tipologia: pos.persiana.tipologia || "F2",
                                            larghezza: pos.persiana.brm?.L || 0,
                                            altezza: pos.persiana.brm?.H || 0,
                                            telaio: pos.persiana.telaio || "",
                                            colore: pos.persiana.colore || "",
                                            posizioneIndex: idx
                                        }
                                    });
                                }
                            }
                            
                            // ğŸ”© ACCESSORI PERSIANA (Cardini + Fermapersiane)
                            if (pos.persiana.accessoriPersiana) {
                                const accessoriCalc = calcolaPrezzoAccessoriPersiana(pos.persiana.accessoriPersiana);
                                
                                if (accessoriCalc.totale > 0) {
                                    accessoriCalc.dettaglio.forEach(acc => {
                                        risultati.prodotti.push({
                                            posizione: pos.nome || `Posizione ${idx + 1}`,
                                            successo: true,
                                            prodotto: `Accessorio Persiana`,
                                            modello: `${acc.modello} - ${acc.nome}`,
                                            tipologia: acc.tipo,
                                            misure: {
                                                quantita: acc.qta
                                            },
                                            dettaglio: {
                                                prezzo_unitario: acc.prezzo_unitario.toFixed(2),
                                                quantita: acc.qta
                                            },
                                            prezzi: {
                                                totale: acc.prezzo_totale.toFixed(2),
                                                iva: (acc.prezzo_totale * 0.22).toFixed(2),
                                                totale_iva: (acc.prezzo_totale * 1.22).toFixed(2)
                                            }
                                        });
                                    });
                                    
                                    risultati.totale += accessoriCalc.totale;
                                    risultati.totale_iva += accessoriCalc.totale * 1.22;
                                    console.log(`âœ… Accessori Persiana ${idx + 1}: â‚¬${accessoriCalc.totale.toFixed(2)}`);
                                }
                            }
                        }
                    });
                }
                
                risultati.totale = risultati.totale.toFixed(2);
                risultati.totale_iva = risultati.totale_iva.toFixed(2);
                
                return risultati;
            }
        };
        
        console.log('âœ… PreventivoCalculator caricato');
    </script>
    
    <script>
        // ================================================================================
        // FUNZIONI UI PREVENTIVO
        // ================================================================================
        
        let currentPreventivo = null;
        
        /**
         * Apri modal preventivo
         */
        function apriPreventivo() {
            if (!appState.rilievoData) {
                alert('âš ï¸ Nessun progetto caricato!\n\nCarica prima un file JSON dal Blocco Generale.');
                return;
            }
            
            console.log('ğŸ’° Apertura modal preventivo...');
            
            // Crea modal se non esiste
            let overlay = document.getElementById('preventivo-modal-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'preventivo-modal-overlay';
                overlay.className = 'preventivo-modal-overlay';
                overlay.innerHTML = `
                    <div class="preventivo-modal" onclick="event.stopPropagation()" style="max-width: 1400px; max-height: 95vh;">
                        <div class="preventivo-modal-header">
                            <h2 class="preventivo-modal-title">ğŸ“ˆ Dettaglio Costi</h2>
                            <button class="preventivo-modal-close" onclick="chiudiPreventivo()">Ã—</button>
                        </div>
                        
                        <!-- Tab Navigation -->
                        <div style="display: flex; gap: 0.5rem; padding: 1rem; border-bottom: 2px solid #e5e7eb; background: #f9fafb; overflow-x: auto;">
                            <button class="tab-analisi active" onclick="switchTabAnalisi('riepilogo')" style="white-space: nowrap;">
                                ğŸ“Š Riepilogo
                            </button>
                            <button class="tab-analisi" onclick="switchTabAnalisi('persiane')" style="white-space: nowrap;">
                                ğŸšª Persiane
                            </button>
                            <button class="tab-analisi" onclick="switchTabAnalisi('zanzariere')" style="white-space: nowrap;">
                                ğŸ¦Ÿ Zanzariere
                            </button>
                            <button class="tab-analisi" onclick="switchTabAnalisi('infissi')" style="white-space: nowrap; opacity: 0.5;" disabled>
                                ğŸªŸ Infissi
                            </button>
                            <button class="tab-analisi" onclick="switchTabAnalisi('tapparelle')" style="white-space: nowrap;">
                                ğŸšï¸ Tapparelle
                            </button>
                            <button class="tab-analisi" onclick="switchTabAnalisi('cassonetti')" style="white-space: nowrap; opacity: 0.5;" disabled>
                                ğŸ“ Cassonetti
                            </button>
                        </div>
                        
                        <!-- Tab Content: Riepilogo -->
                        <div id="tab-content-riepilogo" class="tab-content-analisi" style="overflow-y: auto; max-height: calc(95vh - 200px);">
                            <div class="preventivo-modal-body" id="preventivo-modal-content">
                                <div class="preventivo-loading">
                                    <div class="preventivo-spinner"></div>
                                    <p style="color: #64748b;">Calcolo in corso...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab Content: Persiane -->
                        <div id="tab-content-persiane" class="tab-content-analisi" style="display: none; padding: 1.5rem; overflow-y: auto; max-height: calc(95vh - 200px);">
                            <!-- Listino Persiane -->
                            <div id="tab-listini-persiane">
                                <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ“Š Listino Persiane - STEP 1</h3>
                                
                                <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.5rem;">
                                    <p style="margin: 0; font-weight: 600; color: #065f46;">
                                        â„¹ï¸ Versione: <span id="listino-persiane-versione-2"></span> | 
                                        Aggiornamento: <span id="listino-persiane-data-2"></span>
                                    </p>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #047857;">
                                        ğŸ“„ Fonte: <span id="listino-persiane-fonte-2"></span>
                                    </p>
                                </div>
                                
                                <div style="margin-bottom: 1.5rem;">
                                    <h4 style="margin-bottom: 0.75rem; color: #374151;">ğŸ—ï¸ Modelli Disponibili</h4>
                                    <div id="listino-persiane-modelli-2"></div>
                                </div>
                                
                                <div style="margin-bottom: 1.5rem;">
                                    <h4 style="margin-bottom: 0.75rem; color: #374151;">ğŸ› ï¸ Telai</h4>
                                    <div id="listino-persiane-telai-2"></div>
                                </div>
                                
                                <div style="margin-bottom: 1.5rem;">
                                    <h4 style="margin-bottom: 0.75rem; color: #374151;">ğŸ¨ Colori (41 totali)</h4>
                                    <div id="listino-persiane-colori-2"></div>
                                </div>
                                
                                <div>
                                    <h4 style="margin-bottom: 0.75rem; color: #374151;">ğŸ’° Supplementi</h4>
                                    <div id="listino-persiane-supplementi-2"></div>
                                </div>
                                
                                <!-- Separatore -->
                                <div style="border-top: 3px solid #e5e7eb; margin: 2rem 0; position: relative;">
                                    <div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: white; padding: 0 1rem; color: #6b7280; font-weight: 600;">
                                        ğŸ§ª Test Calcolo
                                    </div>
                                </div>
                                
                                <!-- Test Calcolo Persiane -->
                                <div>
                                    <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ§ª Test Calcolo Rapido</h3>
                                    
                                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem;">
                                        <h4 style="margin-bottom: 1rem; color: #374151;">Persiana</h4>
                                        
                                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                                            <div>
                                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Modello:</label>
                                                <select id="test-modello-2" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                                    <option value="">Seleziona...</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Tipologia:</label>
                                                <select id="test-tipologia-2" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                                    <option value="">Seleziona...</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Larghezza (mm):</label>
                                                <input type="number" id="test-larghezza-2" placeholder="es. 1400" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Altezza (mm):</label>
                                                <input type="number" id="test-altezza-2" placeholder="es. 1300" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Telaio:</label>
                                                <select id="test-telaio-2" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                                    <option value="">Nessuno</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Colore:</label>
                                                <select id="test-colore-2" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                                    <option value="">Nessuno</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <button onclick="eseguiTestCalcolo2()" style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer;">
                                            ğŸ§® Calcola Prezzo
                                        </button>
                                        
                                        <div id="test-risultato-2" style="margin-top: 1rem;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab Content: Zanzariere -->
                        <!-- Tab Content: Zanzariere -->
                        <div id="tab-content-zanzariere" class="tab-content-analisi" style="display: none; padding: 1.5rem; overflow-y: auto; max-height: calc(95vh - 200px);">
                            <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ“Š Listino Zanzariere</h3>
                            
                            <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.5rem;">
                                <p style="margin: 0; font-weight: 600; color: #065f46;">
                                    â„¹ï¸ Fornitore: Palagina
                                </p>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #047857;">
                                    ğŸ“„ Listino completo con fasce di prezzo per superficie
                                </p>
                            </div>
                            
                            <div id="listino-zanzariere-content-dettaglio">
                                <!-- Popolato dinamicamente dalla funzione caricaDatiListinoZanzariereDettaglio() -->
                            </div>
                        </div>
                        
                        <!-- Tab Content: Infissi (Placeholder) -->
                        <div id="tab-content-infissi" class="tab-content-analisi" style="display: none; padding: 1.5rem; overflow-y: auto; max-height: calc(95vh - 200px);">
                            <div style="text-align: center; padding: 3rem 1rem;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸªŸ</div>
                                <h3 style="color: #6b7280; margin-bottom: 0.5rem;">Listino Infissi</h3>
                                <p style="color: #9ca3af;">In fase di implementazione - Listino Finstral completo</p>
                                <div style="margin-top: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 0.5rem; text-align: left;">
                                    <p style="margin: 0.5rem 0; color: #6b7280;"><strong>Prossimi step:</strong></p>
                                    <p style="margin: 0.5rem 0; color: #6b7280;">â€¢ Prezzi base per tipologie 101-401</p>
                                    <p style="margin: 0.5rem 0; color: #6b7280;">â€¢ Supplementi telai (Step-line, Nova-line)</p>
                                    <p style="margin: 0.5rem 0; color: #6b7280;">â€¢ Database maniglie Finstral (67 modelli)</p>
                                    <p style="margin: 0.5rem 0; color: #6b7280;">â€¢ Test calcolo integrato</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab Content: Tapparelle (Listino Plasticino) -->
                        <div id="tab-content-tapparelle" class="tab-content-analisi" style="display: none; padding: 1.5rem; overflow-y: auto; max-height: calc(95vh - 200px);">
                            <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ“Š Listino Tapparelle - PLASTICINO</h3>
                            
                            <!-- Info Generale -->
                            <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.5rem;">
                                <p style="margin: 0; font-weight: 600; color: #1e40af;">
                                    â„¹ï¸ Aziende: Plasticino | New Solar | Estella
                                </p>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #1e3a8a;">
                                    ğŸ“„ Formula: <strong>TOTALE = (L Ã— â‚¬13.20/m) + â‚¬66.40 + Supplemento H</strong>
                                </p>
                            </div>
                            
                            <!-- Formula Calcolo -->
                            <div style="margin-bottom: 1.5rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                                <h4 style="margin: 0 0 1rem 0; color: #374151;">ğŸ§® Formula di Calcolo</h4>
                                <div style="font-family: monospace; background: white; padding: 1rem; border-radius: 0.375rem; border: 1px solid #d1d5db;">
                                    <div style="margin-bottom: 0.5rem;"><strong>TOTALE</strong> = <span style="color: #2563eb;">(L_metri Ã— 13.20)</span> + <span style="color: #059669;">66.40</span> + <span style="color: #dc2626;">Supplemento_H</span></div>
                                    <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
                                        â€¢ L_metri = Larghezza foro in metri (L_cm Ã· 100)<br>
                                        â€¢ 13.20 = Costo rullo â‚¬/metro lineare<br>
                                        â€¢ 66.40 = Totale componenti fissi<br>
                                        â€¢ Supplemento_H = â‚¬0.50/metro se H > 300cm
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Componenti Fissi (compatta) -->
                            <details style="margin-bottom: 1.5rem; cursor: pointer;">
                                <summary style="font-weight: 600; padding: 0.5rem; background: #f9fafb; border-radius: 0.375rem;">
                                    ğŸ”§ Componenti Fissi (â‚¬66.40) - Clicca per dettagli
                                </summary>
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem; margin-top: 0.5rem;">
                                    <thead>
                                        <tr style="background: #f3f4f6;">
                                            <th style="padding: 0.5rem; text-align: left; border: 1px solid #e5e7eb;">Codice</th>
                                            <th style="padding: 0.5rem; text-align: left; border: 1px solid #e5e7eb;">Descrizione</th>
                                            <th style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">Prezzo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td style="padding: 0.5rem; border: 1px solid #e5e7eb;">COMP-01</td><td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Rullo Ottagonale 60mm</td><td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb; color: #2563eb; font-weight: 600;">â‚¬13.20/m</td></tr>
                                        <tr style="background: #f9fafb;"><td style="padding: 0.5rem; border: 1px solid #e5e7eb;">COMP-02</td><td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Calotta</td><td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">â‚¬15.00</td></tr>
                                        <tr><td style="padding: 0.5rem; border: 1px solid #e5e7eb;">COMP-03</td><td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Avvolgitore</td><td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">â‚¬10.00</td></tr>
                                        <tr style="background: #f9fafb;"><td style="padding: 0.5rem; border: 1px solid #e5e7eb;">COMP-04</td><td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Cuscinetto</td><td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">â‚¬3.50</td></tr>
                                        <tr><td style="padding: 0.5rem; border: 1px solid #e5e7eb;">COMP-05</td><td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Supporti x2</td><td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">â‚¬6.00</td></tr>
                                        <tr style="background: #f9fafb;"><td style="padding: 0.5rem; border: 1px solid #e5e7eb;">COMP-06</td><td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Ganci x2</td><td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">â‚¬7.20</td></tr>
                                        <tr><td style="padding: 0.5rem; border: 1px solid #e5e7eb;">COMP-08</td><td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Placca</td><td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">â‚¬5.00</td></tr>
                                        <tr style="background: #f9fafb;"><td style="padding: 0.5rem; border: 1px solid #e5e7eb;">COMP-09</td><td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Passacinghia</td><td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">â‚¬1.70</td></tr>
                                        <tr><td style="padding: 0.5rem; border: 1px solid #e5e7eb;">COMP-10</td><td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Macchinetta</td><td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">â‚¬18.00</td></tr>
                                        <tr style="background: #dcfce7; font-weight: 600;"><td colspan="2" style="padding: 0.5rem; border: 1px solid #e5e7eb; text-align: right;">TOTALE COMPONENTI FISSI:</td><td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb; color: #059669;">â‚¬66.40</td></tr>
                                    </tbody>
                                </table>
                            </details>
                            
                            <!-- Test Rapido -->
                            <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 0.5rem; padding: 1rem;">
                                <h4 style="margin: 0 0 1rem 0; color: #92400e;">ğŸ§ª Test Calcolo Rapido</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #78350f;">Larghezza (cm):</label>
                                        <input type="number" id="test-tapp-L-dettaglio" placeholder="es. 127.5" style="width: 100%; padding: 0.5rem; border: 1px solid #d97706; border-radius: 0.375rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #78350f;">Altezza (cm):</label>
                                        <input type="number" id="test-tapp-H-dettaglio" placeholder="es. 242.5" style="width: 100%; padding: 0.5rem; border: 1px solid #d97706; border-radius: 0.375rem;">
                                    </div>
                                    <div id="test-tapp-result-dettaglio" style="font-size: 1.25rem; font-weight: 700; color: #059669; text-align: center; padding: 0.5rem;">
                                        -
                                    </div>
                                    <button onclick="testCalcoloTapparellaDettaglio()" style="padding: 0.5rem 1rem; background: #2563eb; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 600; white-space: nowrap;">
                                        ğŸ§® Calcola
                                    </button>
                                </div>
                                <div id="test-tapp-dettaglio-result" style="margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 0.375rem; font-size: 0.875rem; font-family: monospace; display: none;"></div>
                            </div>
                        </div>
                        
                        <!-- Tab Content: Cassonetti (Placeholder) -->
                        <div id="tab-content-cassonetti" class="tab-content-analisi" style="display: none; padding: 1.5rem; overflow-y: auto; max-height: calc(95vh - 200px);">
                            <div style="text-align: center; padding: 3rem 1rem;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ“</div>
                                <h3 style="color: #6b7280; margin-bottom: 0.5rem;">Listino Cassonetti</h3>
                                <p style="color: #9ca3af;">In fase di implementazione</p>
                                <div style="margin-top: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 0.5rem; text-align: left;">
                                    <p style="margin: 0.5rem 0; color: #6b7280;"><strong>Fornitori da integrare:</strong></p>
                                    <p style="margin: 0.5rem 0; color: #6b7280;">â€¢ Finstral</p>
                                    <p style="margin: 0.5rem 0; color: #6b7280;">â€¢ MagÃ²</p>
                                    <p style="margin: 0.5rem 0; color: #6b7280;">â€¢ Alpac</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="preventivo-modal-actions">
                            <button class="preventivo-btn preventivo-btn-secondary" onclick="chiudiPreventivo()">
                                â† Chiudi
                            </button>
                            <button id="btn-export-pdf" class="preventivo-btn preventivo-btn-primary" onclick="esportaPreventiPDF()">
                                ğŸ“„ Esporta PDF
                            </button>
                        </div>
                    </div>
                `;
                overlay.addEventListener('click', chiudiPreventivo);
                document.body.appendChild(overlay);
            }
            
            // Mostra modal
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Calcola preventivo tab Dettaglio
            setTimeout(() => {
                const preventivo = PreventivoCalculator.calcolaProgetto(appState.rilievoData);
                renderPreventivo(preventivo);
            }, 500);
            
            // Popola listini e test
            setTimeout(() => {
                caricaDatiListinoPersiane2();
                popolaSelectTest2();
            }, 600);
        }
        
        /**
         * Chiudi modal
         */
        function chiudiPreventivo() {
            const overlay = document.getElementById('preventivo-modal-overlay');
            if (overlay) {
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        // ============================================================================
        // âœ… CONFERMA CLIENTE v7.28
        // ============================================================================
        
        /**
         * Configurazione colonne Conferma Cliente
         * Definisce quali informazioni mostrare nel documento per il cliente
         */
        const CONFERMA_CONFIG = {
            // Colonne sempre presenti (non disattivabili)
            colonneBase: {
                nomePosizione: { label: 'Nome Posizione', sempre: true },
                misure: { label: 'Misure (LxH)', sempre: true },
                quantita: { label: 'QuantitÃ ', sempre: true }
            },
            
            // Colonne opzionali (utente puÃ² scegliere)
            colonneOpzionali: {
                // ===== INFISSI =====
                infisso_azienda: { 
                    label: 'Azienda Infisso', 
                    default: true, 
                    gruppo: 'infisso',
                    emoji: 'ğŸªŸ'
                },
                infisso_telaio: { 
                    label: 'Telaio', 
                    default: true, 
                    gruppo: 'infisso',
                    emoji: 'ğŸªŸ'
                },
                infisso_materiale: { 
                    label: 'Materiale', 
                    default: true, 
                    gruppo: 'infisso',
                    emoji: 'ğŸªŸ'
                },
                infisso_vetro: { 
                    label: 'Vetro', 
                    default: true, 
                    gruppo: 'infisso',
                    emoji: 'ğŸªŸ'
                },
                infisso_coloreInterno: { 
                    label: 'Colore Interno', 
                    default: true, 
                    gruppo: 'infisso',
                    emoji: 'ğŸªŸ'
                },
                infisso_coloreEsterno: { 
                    label: 'Colore Esterno', 
                    default: true, 
                    gruppo: 'infisso',
                    emoji: 'ğŸªŸ'
                },
                infisso_maniglia: { 
                    label: 'Maniglia', 
                    default: true, 
                    gruppo: 'infisso',
                    emoji: 'ğŸªŸ'
                },
                
                // ===== PERSIANE =====
                persiana_azienda: { 
                    label: 'Azienda Persiana', 
                    default: true, 
                    gruppo: 'persiana',
                    emoji: 'ğŸšª'
                },
                persiana_tipo: { 
                    label: 'Tipo Persiana', 
                    default: true, 
                    gruppo: 'persiana',
                    emoji: 'ğŸšª'
                },
                persiana_colore: { 
                    label: 'Colore Persiana', 
                    default: true, 
                    gruppo: 'persiana',
                    emoji: 'ğŸšª'
                },
                persiana_oscurante: { 
                    label: 'Oscurante', 
                    default: false, 
                    gruppo: 'persiana',
                    emoji: 'ğŸšª'
                },
                
                // ===== TAPPARELLE =====
                tapparella_azienda: { 
                    label: 'Azienda Tapparella', 
                    default: false, 
                    gruppo: 'tapparella',
                    emoji: 'ğŸ“œ'
                },
                tapparella_tipo: { 
                    label: 'Tipo Tapparella', 
                    default: false, 
                    gruppo: 'tapparella',
                    emoji: 'ğŸ“œ'
                },
                tapparella_colore: { 
                    label: 'Colore Tapparella', 
                    default: false, 
                    gruppo: 'tapparella',
                    emoji: 'ğŸ“œ'
                },
                tapparella_automazione: { 
                    label: 'Automazione', 
                    default: false, 
                    gruppo: 'tapparella',
                    emoji: 'ğŸ“œ'
                },
                tapparella_guida: { 
                    label: 'Guida Tapparella', 
                    default: false, 
                    gruppo: 'tapparella',
                    emoji: 'ğŸ“œ'
                },
                
                // ===== ZANZARIERE =====
                zanzariera_azienda: { 
                    label: 'Azienda Zanzariera', 
                    default: false, 
                    gruppo: 'zanzariera',
                    emoji: 'ğŸ¦Ÿ'
                },
                zanzariera_tipo: { 
                    label: 'Tipo Zanzariera', 
                    default: false, 
                    gruppo: 'zanzariera',
                    emoji: 'ğŸ¦Ÿ'
                },
                zanzariera_colore: { 
                    label: 'Colore Zanzariera', 
                    default: false, 
                    gruppo: 'zanzariera',
                    emoji: 'ğŸ¦Ÿ'
                },
                
                // ===== CASSONETTI =====
                cassonetto_azienda: { 
                    label: 'Azienda Cassonetto', 
                    default: false, 
                    gruppo: 'cassonetto',
                    emoji: 'ğŸ“¦'
                },
                cassonetto_tipo: { 
                    label: 'Tipo Cassonetto', 
                    default: false, 
                    gruppo: 'cassonetto',
                    emoji: 'ğŸ“¦'
                },
                cassonetto_isolamento: { 
                    label: 'Isolamento', 
                    default: false, 
                    gruppo: 'cassonetto',
                    emoji: 'ğŸ“¦'
                },
                
                // ===== PREZZI =====
                prezzo_calcolato: { 
                    label: 'Prezzo Calcolato', 
                    default: false, 
                    gruppo: 'prezzi',
                    emoji: 'ğŸ’°',
                    descrizione: 'Mostra prezzo da calcolo automatico'
                },
                prezzo_editabile: { 
                    label: 'Campo Prezzo Vuoto', 
                    default: true, 
                    gruppo: 'prezzi',
                    emoji: 'ğŸ’°',
                    descrizione: 'Lascia spazio vuoto per compilare manualmente'
                },
                
                // ===== ALTRO =====
                note: { 
                    label: 'Note', 
                    default: false, 
                    gruppo: 'altro',
                    emoji: 'ğŸ“'
                }
            }
        };
        
        /**
         * Carica configurazione colonne salvata in localStorage
         * Se non esiste, usa default da CONFERMA_CONFIG
         */
        function caricaConfigurazioneConferma() {
            const saved = localStorage.getItem('conferma_colonne_config');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.warn('âš ï¸ Configurazione salvata corrotta, uso default');
                }
            }
            
            // Default: attiva colonne con default:true
            const config = {};
            Object.keys(CONFERMA_CONFIG.colonneOpzionali).forEach(key => {
                config[key] = CONFERMA_CONFIG.colonneOpzionali[key].default;
            });
            
            console.log('ğŸ“‹ Configurazione colonne (default):', config);
            return config;
        }
        
        /**
         * Salva configurazione colonne in localStorage
         */
        function salvaConfigurazioneConferma(config) {
            localStorage.setItem('conferma_colonne_config', JSON.stringify(config));
            console.log('ğŸ’¾ Configurazione colonne salvata');
        }
        
        /**
         * Reset configurazione a valori default
         */
        function resetConfigurazioneConferma() {
            localStorage.removeItem('conferma_colonne_config');
            const config = caricaConfigurazioneConferma();
            console.log('ğŸ”„ Configurazione resettata a default');
            return config;
        }
        
        /**
         * Toggle singola colonna on/off
         */
        function toggleColonnaConferma(colonnaKey) {
            const config = caricaConfigurazioneConferma();
            config[colonnaKey] = !config[colonnaKey];
            salvaConfigurazioneConferma(config);
            
            console.log(`ğŸ”„ Toggle colonna: ${colonnaKey} = ${config[colonnaKey]}`);
            
            // Rigenera documento se giÃ  aperto
            if (document.getElementById('conferma-modal-overlay')?.classList.contains('active')) {
                generaConfermaCliente();
            }
        }
        
        /**
         * Toggle gruppo colonne (es: tutti prezzi, tutti infissi)
         */
        function toggleGruppoColonne(gruppo, isEnabled) {
            const config = caricaConfigurazioneConferma();
            
            Object.keys(CONFERMA_CONFIG.colonneOpzionali).forEach(key => {
                if (CONFERMA_CONFIG.colonneOpzionali[key].gruppo === gruppo) {
                    config[key] = isEnabled;
                }
            });
            
            salvaConfigurazioneConferma(config);
            console.log(`ğŸ”„ Toggle gruppo ${gruppo}: ${isEnabled}`);
            
            // Rigenera documento se giÃ  aperto
            if (document.getElementById('conferma-modal-overlay')?.classList.contains('active')) {
                generaConfermaCliente();
            }
        }
        
        /**
         * Apre modale Conferma Cliente
         * Documento professionale per il cliente (1 pagina per posizione)
         */
        function apriConfermaCliente() {
            if (!appState.rilievoData) {
                alert('âš ï¸ Nessun progetto caricato!\n\nCarica prima un file JSON dal Blocco Generale.');
                return;
            }
            
            console.log('ğŸ“‹ Apertura Conferma Cliente...');
            
            // Crea modal se non esiste
            let overlay = document.getElementById('conferma-modal-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'conferma-modal-overlay';
                overlay.innerHTML = `
                    <div class="conferma-modal-container">
                        <div class="conferma-modal-header">
                            <h2 class="conferma-modal-title">ğŸ“‹ Conferma Cliente</h2>
                            <button class="conferma-modal-close" onclick="chiudiConfermaCliente()">Ã—</button>
                        </div>
                        
                        <div class="conferma-toolbar">
                            <button class="btn-settings" onclick="apriImpostazioniConferma()">
                                âš™ï¸ Impostazioni Colonne
                            </button>
                            
                            <label class="quick-toggle">
                                <input type="checkbox" id="toggle-prezzi" onchange="toggleQuickPrezzi()">
                                ğŸ’° Mostra Prezzi
                            </label>
                            
                            <label class="quick-toggle">
                                <input type="checkbox" id="toggle-note" onchange="toggleQuickNote()">
                                ğŸ“ Mostra Note
                            </label>
                            
                            <button class="btn-export" onclick="esportaConfermaClientePDF()">
                                ğŸ“„ Esporta PDF
                            </button>
                        </div>
                        
                        <div class="conferma-content" id="conferma-content">
                            <p style="text-align: center; padding: 40px; color: #64748b;">
                                Generazione documento in corso...
                            </p>
                        </div>
                    </div>
                `;
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        chiudiConfermaCliente();
                    }
                });
                document.body.appendChild(overlay);
            }
            
            // Mostra modal
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Genera documento
            setTimeout(() => {
                generaDocumentoConferma();
            }, 100);
        }
        
        /**
         * Chiude modale Conferma Cliente
         */
        function chiudiConfermaCliente() {
            const overlay = document.getElementById('conferma-modal-overlay');
            if (overlay) {
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        // ============================================================================
        // TAB ANALISI COSTI INTEGRATI
        // ============================================================================
        
        /**
         * Switch tra tab Analisi Costi
         */
        function switchTabAnalisi(tabName) {
            // Aggiorna bottoni
            document.querySelectorAll('.tab-analisi').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Nascondi tutti i contenuti
            document.querySelectorAll('.tab-content-analisi').forEach(content => {
                content.style.display = 'none';
            });
            
            // Mostra contenuto selezionato
            document.getElementById(`tab-content-${tabName}`).style.display = 'block';
            
            // Carica dati specifici per tab
            if (tabName === 'persiane') {
                // Dati giÃ  caricati all'apertura modal
            } else if (tabName === 'zanzariere') {
                caricaDatiListinoZanzariereDettaglio();
            }
            
            // Gestisci bottone export PDF (solo per riepilogo)
            const btnExport = document.getElementById('btn-export-pdf');
            if (btnExport) {
                btnExport.style.display = tabName === 'riepilogo' ? 'inline-block' : 'none';
            }
            
            console.log(`âœ… Tab Dettaglio Costi: ${tabName}`);
        }
        
        /**
         * Carica dati listino persiane (versione 2 per tab integrato)
         */
        function caricaDatiListinoPersiane2() {
            const listino = PreventivoCalculator.listini.persiane;
            
            // Info generale
            document.getElementById('listino-persiane-versione-2').textContent = listino.versione || 'N/D';
            document.getElementById('listino-persiane-data-2').textContent = listino.dataAggiornamento || 'N/D';
            document.getElementById('listino-persiane-fonte-2').textContent = listino.fonte || 'N/D';
            
            // Modelli
            const modelliHTML = Object.entries(listino.modelli).map(([nome, dati]) => {
                const tipologie = Object.keys(dati.prezzi);
                const totDimensioni = tipologie.reduce((sum, tip) => sum + Object.keys(dati.prezzi[tip]).length, 0);
                
                let dimensioniHTML = '';
                tipologie.forEach(tip => {
                    const dimensioni = Object.entries(dati.prezzi[tip]);
                    dimensioniHTML += `
                        <div style="margin-top: 0.75rem;">
                            <div style="font-weight: 600; color: #6b7280; margin-bottom: 0.5rem;">${tip}:</div>
                            <div class="dimensioni-grid">
                                ${dimensioni.map(([dim, prezzo]) => `
                                    <div class="dimensione-item">
                                        <span class="dimensione-size">${dim}</span>
                                        <span class="dimensione-price">â‚¬${prezzo.toFixed(2)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
                
                return `
                    <div class="modello-card">
                        <div class="modello-header">
                            <span class="modello-nome">${nome}</span>
                            <span class="modello-badge">${totDimensioni} dimensioni</span>
                        </div>
                        <p style="margin: 0 0 0.5rem 0; color: #6b7280; font-size: 0.875rem;">${dati.descrizione}</p>
                        <div style="display: flex; gap: 1rem; font-size: 0.75rem; color: #9ca3af;">
                            <span>ğŸ“ Spessore: ${dati.spessore_anta}</span>
                            <span>ğŸ”§ Struttura: ${dati.struttura_esterna}</span>
                        </div>
                        ${dimensioniHTML}
                    </div>
                `;
            }).join('');
            document.getElementById('listino-persiane-modelli-2').innerHTML = modelliHTML;
            
            // Telai
            const telaiHTML = Object.entries(listino.telai).map(([codice, dati]) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.375rem; margin-bottom: 0.5rem;">
                    <div>
                        <span style="font-weight: 600; color: #1f2937;">${codice}</span>
                        <span style="color: #6b7280; margin-left: 0.5rem; font-size: 0.875rem;">${dati.descrizione}</span>
                    </div>
                    <span style="font-weight: 700; color: #059669;">â‚¬${dati.prezzo.toFixed(2)}</span>
                </div>
            `).join('');
            document.getElementById('listino-persiane-telai-2').innerHTML = telaiHTML;
            
            // Colori (mostra solo totale per categoria per non occupare troppo spazio)
            const coloriHTML = `
                <div style="margin-bottom: 1rem;">
                    <h5 style="margin-bottom: 0.5rem; color: #4b5563;">Categorie:</h5>
                    ${Object.entries(listino.colori.categorie).map(([cat, dati]) => `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f9fafb; border-radius: 0.375rem; margin-bottom: 0.25rem;">
                            <span style="font-weight: 600; color: #1f2937;">Cat. ${cat}</span>
                            <span style="color: #6b7280; flex: 1; margin: 0 1rem;">${dati.descrizione}</span>
                            <span style="font-weight: 700; color: ${dati.maggiorazione === 0 ? '#10b981' : '#f59e0b'};">
                                ${dati.maggiorazione !== null ? `+${dati.maggiorazione}%` : 'A preventivo'}
                            </span>
                        </div>
                    `).join('')}
                </div>
                <p style="margin: 0; color: #6b7280; font-size: 0.875rem;">
                    ğŸ“ Totale: ${Object.keys(listino.colori.colori_specifici).length} colori disponibili
                </p>
            `;
            document.getElementById('listino-persiane-colori-2').innerHTML = coloriHTML;
            
            // Supplementi
            const supplementiHTML = `
                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 0.375rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="font-weight: 600; color: #92400e;">ğŸ’° Contributo Gestione:</span>
                        <span style="font-weight: 700; color: #92400e;">â‚¬${listino.supplementi.contributo_gestione.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-weight: 600; color: #92400e;">ğŸ“¦ Imballo:</span>
                        <span style="font-weight: 700; color: #92400e;">+${listino.supplementi.imballo_percentuale}%</span>
                    </div>
                </div>
            `;
            document.getElementById('listino-persiane-supplementi-2').innerHTML = supplementiHTML;
        }
        
        /**
         * Popola select per test calcolo (versione 2 per tab integrato)
         */
        function popolaSelectTest2() {
            const listino = PreventivoCalculator.listini.persiane;
            
            // Modelli
            const selectModello = document.getElementById('test-modello-2');
            selectModello.innerHTML = '<option value="">Seleziona...</option>' + 
                Object.keys(listino.modelli).map(nome => 
                    `<option value="${nome}">${nome}</option>`
                ).join('');
            
            // Telai
            const selectTelaio = document.getElementById('test-telaio-2');
            selectTelaio.innerHTML = '<option value="">Nessuno</option>' +
                Object.keys(listino.telai).map(codice =>
                    `<option value="${codice}">${codice} - â‚¬${listino.telai[codice].prezzo}</option>`
                ).join('');
            
            // Colori
            const selectColore = document.getElementById('test-colore-2');
            selectColore.innerHTML = '<option value="">Nessuno</option>' +
                Object.entries(listino.colori.colori_specifici).map(([codice, dati]) =>
                    `<option value="${codice}">${codice} - ${dati.nome} (+${dati.maggiorazione}%)</option>`
                ).join('');
            
            // Event listener per modello â†’ aggiorna tipologie
            selectModello.addEventListener('change', function() {
                const modello = this.value;
                const selectTipologia = document.getElementById('test-tipologia-2');
                
                if (modello && listino.modelli[modello]) {
                    const tipologie = Object.keys(listino.modelli[modello].prezzi);
                    selectTipologia.innerHTML = '<option value="">Seleziona...</option>' +
                        tipologie.map(tip => `<option value="${tip}">${tip}</option>`).join('');
                    selectTipologia.disabled = false;
                } else {
                    selectTipologia.innerHTML = '<option value="">Seleziona modello prima</option>';
                    selectTipologia.disabled = true;
                }
            });
        }
        
        /**
         * Esegue test calcolo persiana (versione 2 per tab integrato)
         */
        function eseguiTestCalcolo2() {
            const modello = document.getElementById('test-modello-2').value;
            const tipologia = document.getElementById('test-tipologia-2').value;
            const larghezza = parseInt(document.getElementById('test-larghezza-2').value);
            const altezza = parseInt(document.getElementById('test-altezza-2').value);
            const telaio = document.getElementById('test-telaio-2').value;
            const colore = document.getElementById('test-colore-2').value;
            
            const risultatoDiv = document.getElementById('test-risultato-2');
            
            // Validazione
            if (!modello || !tipologia || !larghezza || !altezza) {
                risultatoDiv.innerHTML = `
                    <div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 1rem; border-radius: 0.375rem;">
                        <p style="margin: 0; color: #991b1b; font-weight: 600;">âš ï¸ Compilare tutti i campi obbligatori</p>
                    </div>
                `;
                return;
            }
            
            // Esegui calcolo
            const risultato = PreventivoCalculator.calcolaPersiana({
                modello: modello,
                tipologia: tipologia,
                larghezza: larghezza,
                altezza: altezza,
                telaio: telaio,
                colore: colore
            });
            
            if (risultato.successo) {
                const det = risultato.dettaglio;
                risultatoDiv.innerHTML = `
                    <div style="background: #d1fae5; border-left: 4px solid #10b981; padding: 1rem; border-radius: 0.375rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #065f46;">âœ… Calcolo Completato</h4>
                        
                        <div style="background: white; padding: 1rem; border-radius: 0.375rem; margin-bottom: 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; font-size: 0.875rem;">
                                <div style="color: #6b7280;">Prezzo Base (${tipologia} ${larghezza}x${altezza}):</div>
                                <div style="font-weight: 600; color: #1f2937;">â‚¬${det.prezzo_base}</div>
                                
                                <div style="color: #6b7280;">Telaio ${telaio || '-'}:</div>
                                <div style="font-weight: 600; color: #1f2937;">â‚¬${det.telaio}</div>
                                
                                <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; color: #6b7280;">Subtotale:</div>
                                <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; font-weight: 600; color: #1f2937;">â‚¬${det.subtotale}</div>
                                
                                <div style="color: #6b7280;">Colore ${colore || '-'} (+${det.colore_perc}%):</div>
                                <div style="font-weight: 600; color: #f59e0b;">â‚¬${det.maggiorazione_colore}</div>
                                
                                <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; color: #6b7280;">Totale Prodotto:</div>
                                <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; font-weight: 700; color: #059669;">â‚¬${det.totale_prodotto}</div>
                                
                                <div style="color: #6b7280;">Contributo Gestione:</div>
                                <div style="font-weight: 600; color: #1f2937;">â‚¬${det.contributo_gestione}</div>
                                
                                <div style="color: #6b7280;">Imballo (3%):</div>
                                <div style="font-weight: 600; color: #1f2937;">â‚¬${det.imballo}</div>
                                
                                <div style="padding-top: 0.5rem; border-top: 2px solid #10b981; color: #065f46; font-weight: 700; font-size: 1rem;">TOTALE FINALE:</div>
                                <div style="padding-top: 0.5rem; border-top: 2px solid #10b981; font-weight: 700; color: #059669; font-size: 1.25rem;">â‚¬${risultato.prezzi.totale}</div>
                                
                                <div style="color: #9ca3af; font-size: 0.75rem;">IVA 22%:</div>
                                <div style="color: #9ca3af; font-size: 0.75rem;">â‚¬${risultato.prezzi.iva}</div>
                                
                                <div style="color: #9ca3af; font-size: 0.75rem;">Totale IVA inclusa:</div>
                                <div style="color: #9ca3af; font-size: 0.75rem; font-weight: 600;">â‚¬${risultato.prezzi.totale_iva}</div>
                            </div>
                        </div>
                        
                        <p style="margin: 0; color: #047857; font-size: 0.875rem;">
                            ğŸ’¡ Formula: Base + Telaio + Colore% + Contributo + Imballo 3%
                        </p>
                    </div>
                `;
            } else {
                risultatoDiv.innerHTML = `
                    <div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 1rem; border-radius: 0.375rem;">
                        <p style="margin: 0; color: #991b1b; font-weight: 600;">âŒ Errore Calcolo</p>
                        <p style="margin: 0.5rem 0 0 0; color: #7f1d1d;">${risultato.errore}</p>
                        
                        <button onclick="apriModalPrezzoManuale({
                            modello: '${modello}',
                            tipologia: '${tipologia}',
                            larghezza: ${larghezza},
                            altezza: ${altezza},
                            telaio: '${telaio}',
                            colore: '${colore}',
                            posizioneIndex: -1
                        })" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; width: 100%;">
                            âœï¸ Inserisci Prezzo Manuale
                        </button>
                    </div>
                `;
            }
        }
        
        // ============================================================================
        // GESTIONE LISTINI (VECCHIA MODALE SEPARATA - DA RIMUOVERE)
        // ============================================================================
        
        /**
         * Apre modal gestione listini
         */
        function apriGestioneListini() {
            console.log('ğŸ“š Apertura gestione listini...');
            
            const modal = document.getElementById('listini-modal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                // Carica dati listino persiane
                caricaDatiListinoPersiane();
                
                // Popola select test
                popolaSelectTest();
            }
        }
        
        /**
         * Chiude modal gestione listini
         */
        function chiudiGestioneListini() {
            const modal = document.getElementById('listini-modal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        /**
         * Switch tra tab listini
         */
        function switchTabListini(tabName) {
            // Aggiorna bottoni
            document.querySelectorAll('.tab-listini').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Mostra content corretto
            document.querySelectorAll('.tab-content-listini').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`tab-content-${tabName}`).style.display = 'block';
            
            // Carica dati specifici
            if (tabName === 'persiane') {
                caricaDatiListinoPersiane();
            } else if (tabName === 'zanzariere') {
                caricaDatiListinoZanzariere();
            }
        }
        
        /**
         * Carica e visualizza dati listino persiane
         */
        function caricaDatiListinoPersiane() {
            const listino = PreventivoCalculator.listini.persiane;
            
            // Info generale
            document.getElementById('listino-persiane-versione').textContent = listino.versione || 'N/D';
            document.getElementById('listino-persiane-data').textContent = listino.dataAggiornamento || 'N/D';
            document.getElementById('listino-persiane-fonte').textContent = listino.fonte || 'N/D';
            
            // Modelli
            const modelliHTML = Object.entries(listino.modelli).map(([nome, dati]) => {
                const tipologie = Object.keys(dati.prezzi);
                const totDimensioni = tipologie.reduce((sum, tip) => sum + Object.keys(dati.prezzi[tip]).length, 0);
                
                let dimensioniHTML = '';
                tipologie.forEach(tip => {
                    const dimensioni = Object.entries(dati.prezzi[tip]);
                    dimensioniHTML += `
                        <div style="margin-top: 0.75rem;">
                            <div style="font-weight: 600; color: #6b7280; margin-bottom: 0.5rem;">${tip}:</div>
                            <div class="dimensioni-grid">
                                ${dimensioni.map(([dim, prezzo]) => `
                                    <div class="dimensione-item">
                                        <span class="dimensione-size">${dim}</span>
                                        <span class="dimensione-price">â‚¬${prezzo.toFixed(2)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
                
                return `
                    <div class="modello-card">
                        <div class="modello-header">
                            <span class="modello-nome">${nome}</span>
                            <span class="modello-badge">${totDimensioni} dimensioni</span>
                        </div>
                        <p style="margin: 0 0 0.5rem 0; color: #6b7280; font-size: 0.875rem;">${dati.descrizione}</p>
                        <div style="display: flex; gap: 1rem; font-size: 0.75rem; color: #9ca3af;">
                            <span>ğŸ“ Spessore: ${dati.spessore_anta}</span>
                            <span>ğŸ”§ Struttura: ${dati.struttura_esterna}</span>
                        </div>
                        ${dimensioniHTML}
                    </div>
                `;
            }).join('');
            document.getElementById('listino-persiane-modelli').innerHTML = modelliHTML;
            
            // Telai
            const telaiHTML = Object.entries(listino.telai).map(([codice, dati]) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.375rem; margin-bottom: 0.5rem;">
                    <div>
                        <span style="font-weight: 600; color: #1f2937;">${codice}</span>
                        <span style="color: #6b7280; margin-left: 0.5rem; font-size: 0.875rem;">${dati.descrizione}</span>
                    </div>
                    <span style="font-weight: 700; color: #059669;">â‚¬${dati.prezzo.toFixed(2)}</span>
                </div>
            `).join('');
            document.getElementById('listino-persiane-telai').innerHTML = telaiHTML;
            
            // Colori
            const coloriHTML = `
                <div style="margin-bottom: 1rem;">
                    <h5 style="margin-bottom: 0.5rem; color: #4b5563;">Categorie:</h5>
                    ${Object.entries(listino.colori.categorie).map(([cat, dati]) => `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f9fafb; border-radius: 0.375rem; margin-bottom: 0.25rem;">
                            <span style="font-weight: 600; color: #1f2937;">Cat. ${cat}</span>
                            <span style="color: #6b7280; flex: 1; margin: 0 1rem;">${dati.descrizione}</span>
                            <span style="font-weight: 700; color: ${dati.maggiorazione === 0 ? '#10b981' : '#f59e0b'};">
                                ${dati.maggiorazione !== null ? `+${dati.maggiorazione}%` : 'A preventivo'}
                            </span>
                        </div>
                    `).join('')}
                </div>
                <div>
                    <h5 style="margin-bottom: 0.5rem; color: #4b5563;">Colori Specifici:</h5>
                    ${Object.entries(listino.colori.colori_specifici).map(([codice, dati]) => `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.375rem; margin-bottom: 0.25rem;">
                            <span style="font-weight: 600; color: #1f2937;">${codice}</span>
                            <span style="color: #6b7280; flex: 1; margin: 0 1rem; font-size: 0.875rem;">${dati.nome}</span>
                            <span style="background: #fef3c7; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">Cat. ${dati.categoria}</span>
                            <span style="font-weight: 700; color: #f59e0b; margin-left: 0.5rem;">+${dati.maggiorazione}%</span>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('listino-persiane-colori').innerHTML = coloriHTML;
            
            // Supplementi
            const supplementiHTML = `
                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 0.375rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="font-weight: 600; color: #92400e;">ğŸ’° Contributo Gestione:</span>
                        <span style="font-weight: 700; color: #92400e;">â‚¬${listino.supplementi.contributo_gestione.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-weight: 600; color: #92400e;">ğŸ“¦ Imballo:</span>
                        <span style="font-weight: 700; color: #92400e;">+${listino.supplementi.imballo_percentuale}%</span>
                    </div>
                </div>
            `;
            document.getElementById('listino-persiane-supplementi').innerHTML = supplementiHTML;
        }
        
        /**
         * Carica dati listino zanzariere
         */
        function caricaDatiListinoZanzariere() {
            const listino = PreventivoCalculator.listini.zanzariere;
            
            const html = `
                <h4 style="margin-bottom: 1rem; color: #374151;">Modelli Disponibili: ${listino.modelli.length}</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                    ${listino.modelli.map(mod => `
                        <div style="background: white; border: 2px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                            <div style="font-weight: 700; color: #1f2937; margin-bottom: 0.5rem;">${mod.modello}</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.875rem;">
                                <div>Fascia 1: <span style="color: #059669; font-weight: 600;">â‚¬${mod.fascia_1}</span></div>
                                <div>Fascia 2: <span style="color: #059669; font-weight: 600;">â‚¬${mod.fascia_2}</span></div>
                                <div>Fascia 3: <span style="color: #059669; font-weight: 600;">â‚¬${mod.fascia_3}</span></div>
                                <div>Fascia 4: <span style="color: #059669; font-weight: 600;">â‚¬${mod.fascia_4}</span></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('listino-zanzariere-content').innerHTML = html;
        }
        
        /**
         * Carica dati listino zanzariere per tab Dettaglio Costi
         */
        function caricaDatiListinoZanzariereDettaglio() {
            const listino = PreventivoCalculator.listini.zanzariere;
            
            const html = `
                <h4 style="margin-bottom: 1rem; color: #374151;">ğŸ“‹ Modelli Disponibili: ${listino.modelli.length}</h4>
                
                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.5rem;">
                    <p style="margin: 0; font-weight: 600; color: #92400e;">â„¹ï¸ Fasce di Prezzo per Superficie</p>
                    <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #78350f;">
                        <p style="margin: 0.25rem 0;">â€¢ Fascia 1: fino a 0.50 mÂ²</p>
                        <p style="margin: 0.25rem 0;">â€¢ Fascia 2: da 0.51 a 1.50 mÂ²</p>
                        <p style="margin: 0.25rem 0;">â€¢ Fascia 3: da 1.51 a 3.00 mÂ²</p>
                        <p style="margin: 0.25rem 0;">â€¢ Fascia 4: oltre 3.00 mÂ²</p>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem;">
                    ${listino.modelli.map(mod => `
                        <div style="background: white; border: 2px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; transition: all 0.2s;" 
                             onmouseenter="this.style.borderColor='#10b981'; this.style.boxShadow='0 4px 12px rgba(16,185,129,0.15)'"
                             onmouseleave="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                            <div style="font-weight: 700; font-size: 1.125rem; color: #1f2937; margin-bottom: 1rem; border-bottom: 2px solid #10b981; padding-bottom: 0.5rem;">
                                ${mod.modello}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                                <div style="background: #f0fdf4; padding: 0.5rem; border-radius: 0.375rem;">
                                    <div style="font-size: 0.75rem; color: #047857; font-weight: 600; margin-bottom: 0.25rem;">FASCIA 1</div>
                                    <div style="font-size: 1.25rem; color: #059669; font-weight: 700;">â‚¬${mod.fascia_1}</div>
                                </div>
                                <div style="background: #ecfdf5; padding: 0.5rem; border-radius: 0.375rem;">
                                    <div style="font-size: 0.75rem; color: #047857; font-weight: 600; margin-bottom: 0.25rem;">FASCIA 2</div>
                                    <div style="font-size: 1.25rem; color: #059669; font-weight: 700;">â‚¬${mod.fascia_2}</div>
                                </div>
                                <div style="background: #d1fae5; padding: 0.5rem; border-radius: 0.375rem;">
                                    <div style="font-size: 0.75rem; color: #047857; font-weight: 600; margin-bottom: 0.25rem;">FASCIA 3</div>
                                    <div style="font-size: 1.25rem; color: #059669; font-weight: 700;">â‚¬${mod.fascia_3}</div>
                                </div>
                                <div style="background: #a7f3d0; padding: 0.5rem; border-radius: 0.375rem;">
                                    <div style="font-size: 0.75rem; color: #047857; font-weight: 600; margin-bottom: 0.25rem;">FASCIA 4</div>
                                    <div style="font-size: 1.25rem; color: #059669; font-weight: 700;">â‚¬${mod.fascia_4}</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('listino-zanzariere-content-dettaglio').innerHTML = html;
        }
        
        /**
         * Popola select per test calcolo
         */
        function popolaSelectTest() {
            const listino = PreventivoCalculator.listini.persiane;
            
            // Modelli
            const selectModello = document.getElementById('test-modello');
            selectModello.innerHTML = '<option value="">Seleziona...</option>' + 
                Object.keys(listino.modelli).map(nome => 
                    `<option value="${nome}">${nome}</option>`
                ).join('');
            
            // Telai
            const selectTelaio = document.getElementById('test-telaio');
            selectTelaio.innerHTML = '<option value="">Nessuno</option>' +
                Object.keys(listino.telai).map(codice =>
                    `<option value="${codice}">${codice} - â‚¬${listino.telai[codice].prezzo}</option>`
                ).join('');
            
            // Colori
            const selectColore = document.getElementById('test-colore');
            selectColore.innerHTML = '<option value="">Nessuno</option>' +
                Object.entries(listino.colori.colori_specifici).map(([codice, dati]) =>
                    `<option value="${codice}">${codice} - ${dati.nome} (+${dati.maggiorazione}%)</option>`
                ).join('');
            
            // Event listener per modello â†’ aggiorna tipologie
            selectModello.addEventListener('change', function() {
                const modello = this.value;
                const selectTipologia = document.getElementById('test-tipologia');
                
                if (modello && listino.modelli[modello]) {
                    const tipologie = Object.keys(listino.modelli[modello].prezzi);
                    selectTipologia.innerHTML = '<option value="">Seleziona...</option>' +
                        tipologie.map(tip => `<option value="${tip}">${tip}</option>`).join('');
                    selectTipologia.disabled = false;
                } else {
                    selectTipologia.innerHTML = '<option value="">Seleziona modello prima</option>';
                    selectTipologia.disabled = true;
                }
            });
        }
        
        /**
         * Esegue test calcolo persiana
         */
        function eseguiTestCalcolo() {
            const modello = document.getElementById('test-modello').value;
            const tipologia = document.getElementById('test-tipologia').value;
            const larghezza = parseInt(document.getElementById('test-larghezza').value);
            const altezza = parseInt(document.getElementById('test-altezza').value);
            const telaio = document.getElementById('test-telaio').value;
            const colore = document.getElementById('test-colore').value;
            
            const risultatoDiv = document.getElementById('test-risultato');
            
            // Validazione
            if (!modello || !tipologia || !larghezza || !altezza) {
                risultatoDiv.innerHTML = `
                    <div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 1rem; border-radius: 0.375rem;">
                        <p style="margin: 0; color: #991b1b; font-weight: 600;">âš ï¸ Compilare tutti i campi obbligatori</p>
                    </div>
                `;
                return;
            }
            
            // Esegui calcolo
            const risultato = PreventivoCalculator.calcolaPersiana({
                modello: modello,
                tipologia: tipologia,
                larghezza: larghezza,
                altezza: altezza,
                telaio: telaio,
                colore: colore
            });
            
            if (risultato.successo) {
                const det = risultato.dettaglio;
                risultatoDiv.innerHTML = `
                    <div style="background: #d1fae5; border-left: 4px solid #10b981; padding: 1rem; border-radius: 0.375rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #065f46;">âœ… Calcolo Completato</h4>
                        
                        <div style="background: white; padding: 1rem; border-radius: 0.375rem; margin-bottom: 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; font-size: 0.875rem;">
                                <div style="color: #6b7280;">Prezzo Base (${tipologia} ${larghezza}x${altezza}):</div>
                                <div style="font-weight: 600; color: #1f2937;">â‚¬${det.prezzo_base}</div>
                                
                                <div style="color: #6b7280;">Telaio ${telaio || '-'}:</div>
                                <div style="font-weight: 600; color: #1f2937;">â‚¬${det.telaio}</div>
                                
                                <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; color: #6b7280;">Subtotale:</div>
                                <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; font-weight: 600; color: #1f2937;">â‚¬${det.subtotale}</div>
                                
                                <div style="color: #6b7280;">Colore ${colore || '-'} (+${det.colore_perc}%):</div>
                                <div style="font-weight: 600; color: #f59e0b;">â‚¬${det.maggiorazione_colore}</div>
                                
                                <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; color: #6b7280;">Totale Prodotto:</div>
                                <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; font-weight: 700; color: #059669;">â‚¬${det.totale_prodotto}</div>
                                
                                <div style="color: #6b7280;">Contributo Gestione:</div>
                                <div style="font-weight: 600; color: #1f2937;">â‚¬${det.contributo_gestione}</div>
                                
                                <div style="color: #6b7280;">Imballo (3%):</div>
                                <div style="font-weight: 600; color: #1f2937;">â‚¬${det.imballo}</div>
                                
                                <div style="padding-top: 0.5rem; border-top: 2px solid #10b981; color: #065f46; font-weight: 700; font-size: 1rem;">TOTALE FINALE:</div>
                                <div style="padding-top: 0.5rem; border-top: 2px solid #10b981; font-weight: 700; color: #059669; font-size: 1.25rem;">â‚¬${risultato.prezzi.totale}</div>
                                
                                <div style="color: #9ca3af; font-size: 0.75rem;">IVA 22%:</div>
                                <div style="color: #9ca3af; font-size: 0.75rem;">â‚¬${risultato.prezzi.iva}</div>
                                
                                <div style="color: #9ca3af; font-size: 0.75rem;">Totale IVA inclusa:</div>
                                <div style="color: #9ca3af; font-size: 0.75rem; font-weight: 600;">â‚¬${risultato.prezzi.totale_iva}</div>
                            </div>
                        </div>
                        
                        <p style="margin: 0; color: #047857; font-size: 0.875rem;">
                            ğŸ’¡ Formula: Base + Telaio + Colore% + Contributo + Imballo 3%
                        </p>
                    </div>
                `;
            } else {
                risultatoDiv.innerHTML = `
                    <div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 1rem; border-radius: 0.375rem;">
                        <p style="margin: 0; color: #991b1b; font-weight: 600;">âŒ Errore Calcolo</p>
                        <p style="margin: 0.5rem 0 0 0; color: #7f1d1d;">${risultato.errore}</p>
                        
                        <button onclick="apriModalPrezzoManuale({
                            modello: '${modello}',
                            tipologia: '${tipologia}',
                            larghezza: ${larghezza},
                            altezza: ${altezza},
                            telaio: '${telaio}',
                            colore: '${colore}',
                            posizioneIndex: -1
                        })" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; width: 100%;">
                            âœï¸ Inserisci Prezzo Manuale
                        </button>
                    </div>
                `;
            }
        }
        
        // ============================================================================
        // INSERIMENTO MANUALE PREZZI PERSIANE
        // ============================================================================
        
        let datiModalPrezzoManuale = null;
        
        /**
         * Apre modal inserimento manuale prezzo persiana
         */
        function apriModalPrezzoManuale(datiPersiana) {
            console.log('âš ï¸ Apertura modal prezzo manuale...', datiPersiana);
            
            // Salva dati per uso successivo
            datiModalPrezzoManuale = datiPersiana;
            
            // Mostra info dimensione
            const infoText = `Modello: ${datiPersiana.modello} | Tipologia: ${datiPersiana.tipologia || 'N/D'} | Dimensioni: ${datiPersiana.larghezza}x${datiPersiana.altezza} mm`;
            document.getElementById('dimensione-mancante-info').textContent = infoText;
            
            // Reset form
            document.getElementById('input-prezzo-base-manuale').value = '';
            document.getElementById('input-telaio-manuale').value = '';
            document.getElementById('input-colore-perc-manuale').value = '';
            document.getElementById('input-note-manuale').value = '';
            document.getElementById('anteprima-calcolo-manuale').style.display = 'none';
            document.getElementById('btn-salva-prezzo-manuale').disabled = true;
            document.getElementById('btn-salva-prezzo-manuale').style.opacity = '0.5';
            
            // Mostra modal
            const modal = document.getElementById('modal-prezzo-manuale');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                // Focus su input prezzo base
                setTimeout(() => {
                    document.getElementById('input-prezzo-base-manuale').focus();
                }, 100);
            }
        }
        
        /**
         * Chiude modal inserimento manuale
         */
        function chiudiModalPrezzoManuale() {
            const modal = document.getElementById('modal-prezzo-manuale');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
                datiModalPrezzoManuale = null;
            }
        }
        
        /**
         * Calcola anteprima con valori manuali
         */
        function calcolaAnteprimaManuale() {
            const prezzoBase = parseFloat(document.getElementById('input-prezzo-base-manuale').value) || 0;
            const prezzoTelaio = parseFloat(document.getElementById('input-telaio-manuale').value) || 0;
            const colorePerc = parseFloat(document.getElementById('input-colore-perc-manuale').value) || 0;
            
            if (prezzoBase <= 0) {
                alert('âš ï¸ Inserire un prezzo base valido');
                return;
            }
            
            // Calcolo
            const subtotale = prezzoBase + prezzoTelaio;
            const maggiorazioneColore = subtotale * (colorePerc / 100);
            const totaleProdotto = subtotale + maggiorazioneColore;
            const contributo = 57.00;
            const conContributo = totaleProdotto + contributo;
            const imballo = conContributo * 0.03;
            const totaleFinale = conContributo + imballo;
            
            // Mostra anteprima
            document.getElementById('preview-base').textContent = `â‚¬${prezzoBase.toFixed(2)}`;
            document.getElementById('preview-telaio').textContent = `â‚¬${prezzoTelaio.toFixed(2)}`;
            document.getElementById('preview-subtotale').textContent = `â‚¬${subtotale.toFixed(2)}`;
            document.getElementById('preview-colore').textContent = `â‚¬${maggiorazioneColore.toFixed(2)} (+${colorePerc}%)`;
            document.getElementById('preview-totale-prodotto').textContent = `â‚¬${totaleProdotto.toFixed(2)}`;
            document.getElementById('preview-imballo').textContent = `â‚¬${imballo.toFixed(2)}`;
            document.getElementById('preview-finale').textContent = `â‚¬${totaleFinale.toFixed(2)}`;
            
            document.getElementById('anteprima-calcolo-manuale').style.display = 'block';
            
            // Abilita bottone salva
            document.getElementById('btn-salva-prezzo-manuale').disabled = false;
            document.getElementById('btn-salva-prezzo-manuale').style.opacity = '1';
            
            console.log('âœ… Anteprima calcolata:', {
                base: prezzoBase,
                telaio: prezzoTelaio,
                colore: maggiorazioneColore,
                totale: totaleFinale
            });
        }
        
        /**
         * Salva prezzo manuale nel progetto
         */
        function salvaPrezzoManuale() {
            if (!datiModalPrezzoManuale) {
                alert('âŒ Errore: dati persiana non disponibili');
                return;
            }
            
            const prezzoBase = parseFloat(document.getElementById('input-prezzo-base-manuale').value) || 0;
            const prezzoTelaio = parseFloat(document.getElementById('input-telaio-manuale').value) || 0;
            const colorePerc = parseFloat(document.getElementById('input-colore-perc-manuale').value) || 0;
            const note = document.getElementById('input-note-manuale').value.trim();
            
            if (prezzoBase <= 0) {
                alert('âš ï¸ Inserire un prezzo base valido');
                return;
            }
            
            // Calcolo totale
            const subtotale = prezzoBase + prezzoTelaio;
            const maggiorazioneColore = subtotale * (colorePerc / 100);
            const totaleProdotto = subtotale + maggiorazioneColore;
            const contributo = 57.00;
            const conContributo = totaleProdotto + contributo;
            const imballo = conContributo * 0.03;
            const totaleFinale = conContributo + imballo;
            
            // Crea oggetto prezzo manuale
            const prezzoManuale = {
                tipo: 'manuale',
                data: new Date().toISOString(),
                prezzoBase: prezzoBase,
                prezzoTelaio: prezzoTelaio,
                colorePercentuale: colorePerc,
                maggiorazioneColore: maggiorazioneColore,
                totaleProdotto: totaleProdotto,
                contributo: contributo,
                imballo: imballo,
                totaleFinale: totaleFinale,
                note: note,
                dimensione: `${datiModalPrezzoManuale.larghezza}x${datiModalPrezzoManuale.altezza}`
            };
            
            // Salva in currentProject
            if (!currentProject || !currentProject.posizioni) {
                alert('âŒ Errore: nessun progetto caricato');
                return;
            }
            
            // Trova posizione con questa persiana
            const posIndex = datiModalPrezzoManuale.posizioneIndex;
            if (posIndex !== undefined && currentProject.posizioni[posIndex]) {
                if (!currentProject.posizioni[posIndex].persiana) {
                    currentProject.posizioni[posIndex].persiana = {};
                }
                currentProject.posizioni[posIndex].persiana.prezzoManuale = prezzoManuale;
                
                console.log('âœ… Prezzo manuale salvato:', prezzoManuale);
                
                // Sync su GitHub
                if (window.projectManager) {
                    window.projectManager.syncToGitHub(currentProject).then(() => {
                        console.log('âœ… Progetto sincronizzato su GitHub');
                        alert(`âœ… Prezzo manuale salvato!\n\nTotale: â‚¬${totaleFinale.toFixed(2)}\n\n${note ? 'Note: ' + note : ''}`);
                        chiudiModalPrezzoManuale();
                        
                        // Refresh visualizzazione se necessario
                        if (currentBlocco === 'ufficio' || currentBlocco === 'preventivo') {
                            loadProjectData(currentProject);
                        }
                    }).catch(err => {
                        console.error('âŒ Errore sync GitHub:', err);
                        alert('âš ï¸ Prezzo salvato localmente, ma sync GitHub fallito.\nRiprova piÃ¹ tardi.');
                        chiudiModalPrezzoManuale();
                    });
                } else {
                    alert(`âœ… Prezzo manuale salvato!\n\nTotale: â‚¬${totaleFinale.toFixed(2)}\n\nâš ï¸ Sync GitHub non disponibile`);
                    chiudiModalPrezzoManuale();
                }
            } else {
                alert('âŒ Errore: posizione non trovata');
            }
        }
        
        // Event listeners per calcolo automatico anteprima
        document.addEventListener('DOMContentLoaded', function() {
            ['input-prezzo-base-manuale', 'input-telaio-manuale', 'input-colore-perc-manuale'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', function() {
                        // Auto-calcola se prezzo base presente
                        const prezzoBase = parseFloat(document.getElementById('input-prezzo-base-manuale').value);
                        if (prezzoBase > 0) {
                            // Non auto-calcolare, utente deve cliccare bottone
                            // Questo evita calcoli continui durante la digitazione
                        }
                    });
                }
            });
        });
        
        // ============================================================================
        
        /**
         * Apre modal impostazioni colonne
         */
        function apriImpostazioniConferma() {
            console.log('âš™ï¸ Apertura impostazioni colonne...');
            
            // Crea modal impostazioni se non esiste
            let modal = document.getElementById('modal-impostazioni-conferma');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modal-impostazioni-conferma';
                modal.innerHTML = generaHTMLImpostazioni();
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        chiudiImpostazioniConferma();
                    }
                });
                document.body.appendChild(modal);
            }
            
            // Popola checkbox con configurazione corrente
            aggiornaUIImpostazioni();
            
            // Mostra modal
            modal.classList.add('active');
        }
        
        /**
         * Chiude modal impostazioni
         */
        function chiudiImpostazioniConferma() {
            const modal = document.getElementById('modal-impostazioni-conferma');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        /**
         * Genera HTML modal impostazioni
         */
        function generaHTMLImpostazioni() {
            return `
                <div class="modal-impostazioni-content" onclick="event.stopPropagation()">
                    <div class="modal-impostazioni-header">
                        <h2>âš™ï¸ Impostazioni Colonne</h2>
                        <button class="conferma-modal-close" onclick="chiudiImpostazioniConferma()">Ã—</button>
                    </div>
                    
                    <div class="modal-impostazioni-body">
                        <div class="settings-section">
                            <h3>ğŸªŸ Infissi</h3>
                            <label><input type="checkbox" data-col="infisso_azienda"> Azienda Infisso</label>
                            <label><input type="checkbox" data-col="infisso_telaio"> Telaio</label>
                            <label><input type="checkbox" data-col="infisso_materiale"> Materiale</label>
                            <label><input type="checkbox" data-col="infisso_vetro"> Vetro</label>
                            <label><input type="checkbox" data-col="infisso_coloreInterno"> Colore Interno</label>
                            <label><input type="checkbox" data-col="infisso_coloreEsterno"> Colore Esterno</label>
                            <label><input type="checkbox" data-col="infisso_maniglia"> Maniglia</label>
                        </div>
                        
                        <div class="settings-section">
                            <h3>ğŸšª Persiane</h3>
                            <label><input type="checkbox" data-col="persiana_azienda"> Azienda Persiana</label>
                            <label><input type="checkbox" data-col="persiana_tipo"> Tipo Persiana</label>
                            <label><input type="checkbox" data-col="persiana_colore"> Colore Persiana</label>
                            <label><input type="checkbox" data-col="persiana_oscurante"> Oscurante</label>
                        </div>
                        
                        <div class="settings-section">
                            <h3>ğŸ“œ Tapparelle</h3>
                            <label><input type="checkbox" data-col="tapparella_azienda"> Azienda Tapparella</label>
                            <label><input type="checkbox" data-col="tapparella_tipo"> Tipo Tapparella</label>
                            <label><input type="checkbox" data-col="tapparella_colore"> Colore Tapparella</label>
                            <label><input type="checkbox" data-col="tapparella_automazione"> Automazione</label>
                            <label><input type="checkbox" data-col="tapparella_guida"> Guida Tapparella</label>
                        </div>
                        
                        <div class="settings-section">
                            <h3>ğŸ¦Ÿ Zanzariere</h3>
                            <label><input type="checkbox" data-col="zanzariera_azienda"> Azienda Zanzariera</label>
                            <label><input type="checkbox" data-col="zanzariera_tipo"> Tipo Zanzariera</label>
                            <label><input type="checkbox" data-col="zanzariera_colore"> Colore Zanzariera</label>
                        </div>
                        
                        <div class="settings-section">
                            <h3>ğŸ“¦ Cassonetti</h3>
                            <label><input type="checkbox" data-col="cassonetto_azienda"> Azienda Cassonetto</label>
                            <label><input type="checkbox" data-col="cassonetto_tipo"> Tipo Cassonetto</label>
                            <label><input type="checkbox" data-col="cassonetto_isolamento"> Isolamento</label>
                        </div>
                        
                        <div class="settings-section">
                            <h3>ğŸ’° Prezzi</h3>
                            <label>
                                <input type="checkbox" data-col="prezzo_calcolato"> 
                                Prezzo Calcolato <small>(da analisi costi)</small>
                            </label>
                            <label>
                                <input type="checkbox" data-col="prezzo_editabile"> 
                                Campo Prezzo Vuoto <small>(per compilazione manuale)</small>
                            </label>
                        </div>
                        
                        <div class="settings-section">
                            <h3>ğŸ“ Altro</h3>
                            <label><input type="checkbox" data-col="note"> Note</label>
                        </div>
                    </div>
                    
                    <div class="modal-impostazioni-actions">
                        <button class="btn-salva" onclick="salvaImpostazioniConferma()">ğŸ’¾ Salva</button>
                        <button class="btn-reset" onclick="resetImpostazioniConfermaUI()">ğŸ”„ Reset Default</button>
                        <button class="btn-chiudi" onclick="chiudiImpostazioniConferma()">âœ–ï¸ Chiudi</button>
                    </div>
                </div>
            `;
        }
        
        /**
         * Aggiorna UI impostazioni con configurazione corrente
         */
        function aggiornaUIImpostazioni() {
            const config = caricaConfigurazioneConferma();
            
            // Aggiorna tutti i checkbox
            document.querySelectorAll('#modal-impostazioni-conferma [data-col]').forEach(checkbox => {
                const col = checkbox.getAttribute('data-col');
                checkbox.checked = config[col] || false;
            });
        }
        
        /**
         * Salva impostazioni da UI
         */
        function salvaImpostazioniConferma() {
            const config = {};
            
            // Leggi tutti i checkbox
            document.querySelectorAll('#modal-impostazioni-conferma [data-col]').forEach(checkbox => {
                const col = checkbox.getAttribute('data-col');
                config[col] = checkbox.checked;
            });
            
            // Salva configurazione
            salvaConfigurazioneConferma(config);
            
            // Rigenera documento
            generaDocumentoConferma();
            
            // Chiudi modal
            chiudiImpostazioniConferma();
            
            showAlert('success', 'âœ… Impostazioni salvate!');
        }
        
        /**
         * Reset impostazioni a default da UI
         */
        function resetImpostazioniConfermaUI() {
            if (confirm('ğŸ”„ Reset configurazione colonne ai valori di default?')) {
                resetConfigurazioneConferma();
                aggiornaUIImpostazioni();
                showAlert('success', 'ğŸ”„ Configurazione resettata!');
            }
        }
        
        /**
         * Quick toggle prezzi dalla toolbar
         */
        function toggleQuickPrezzi() {
            const isChecked = document.getElementById('toggle-prezzi').checked;
            toggleGruppoColonne('prezzi', isChecked);
        }
        
        /**
         * Quick toggle note dalla toolbar
         */
        function toggleQuickNote() {
            const isChecked = document.getElementById('toggle-note').checked;
            toggleColonnaConferma('note');
        }
        
        /**
         * Genera documento conferma (placeholder Step 6)
         */
        // ============================================================================
        // âœ… GENERAZIONE DOCUMENTO CONFERMA - STEP 6
        // ============================================================================
        
        /**
         * Genera sezione Infisso per una posizione
         */
        function generaSezioneInfisso(infisso, config) {
            if (!infisso || !infisso.quantita || infisso.quantita === 0) return '';
            
            let html = '<div class="sezione-infisso"><h3>ğŸªŸ INFISSO</h3>';
            
            if (config.infisso_azienda && infisso.azienda) {
                html += `<p><strong>Azienda:</strong> ${infisso.azienda}</p>`;
            }
            if (config.infisso_telaio && infisso.telaio) {
                html += `<p><strong>Telaio:</strong> ${infisso.telaio}</p>`;
            }
            if (config.infisso_materiale && infisso.materialeTelaio) {
                html += `<p><strong>Materiale:</strong> ${infisso.materialeTelaio}</p>`;
            }
            if (config.infisso_vetro && infisso.vetro) {
                html += `<p><strong>Vetro:</strong> ${infisso.vetro}</p>`;
            }
            if (config.infisso_coloreInterno && infisso.coloreInterno) {
                html += `<p><strong>Colore Interno:</strong> ${infisso.coloreInterno}</p>`;
            }
            if (config.infisso_coloreEsterno && infisso.coloreEsterno) {
                html += `<p><strong>Colore Esterno:</strong> ${infisso.coloreEsterno}</p>`;
            }
            if (config.infisso_maniglia && infisso.maniglia) {
                let manigliaText = infisso.maniglia;
                if (infisso.coloreManiglia) {
                    manigliaText += ` (${infisso.coloreManiglia})`;
                }
                html += `<p><strong>Maniglia:</strong> ${manigliaText}</p>`;
            }
            
            html += `<p><strong>QuantitÃ :</strong> ${infisso.quantita}</p>`;
            html += '</div>';
            
            return html;
        }
        
        /**
         * Genera sezione Persiana per una posizione
         */
        function generaSezionePersiana(persiana, config) {
            if (!persiana || !persiana.quantita || persiana.quantita === 0) return '';
            
            let html = '<div class="sezione-persiana"><h3>ğŸšª PERSIANA</h3>';
            
            if (config.persiana_azienda && persiana.azienda) {
                html += `<p><strong>Azienda:</strong> ${persiana.azienda}</p>`;
            }
            if (config.persiana_tipo && persiana.tipo) {
                html += `<p><strong>Tipo:</strong> ${persiana.tipo}</p>`;
            }
            if (config.persiana_colore && persiana.colore) {
                html += `<p><strong>Colore:</strong> ${persiana.colore}</p>`;
            }
            if (config.persiana_oscurante && persiana.oscurante) {
                html += `<p><strong>Oscurante:</strong> ${persiana.oscurante}</p>`;
            }
            
            html += `<p><strong>QuantitÃ :</strong> ${persiana.quantita}</p>`;
            
            // ğŸ”© ACCESSORI PERSIANA (Cardini + Fermapersiane)
            if (persiana.accessoriPersiana) {
                const acc = persiana.accessoriPersiana;
                
                // Cardini
                if (acc.cardini && acc.cardini.qta > 0) {
                    html += `<p><strong>ğŸ“ Cardini:</strong> ${acc.cardini.qta} pz - ${acc.cardini.modello || 'N/D'}</p>`;
                }
                
                // Fermapersiane
                if (acc.fermapersiane && acc.fermapersiane.qta > 0) {
                    html += `<p><strong>ğŸ”’ Fermapersiane:</strong> ${acc.fermapersiane.qta} pz - ${acc.fermapersiane.modello || 'N/D'}</p>`;
                }
            }
            
            html += '</div>';
            
            return html;
        }
        
        /**
         * Genera sezione Tapparella per una posizione
         */
        function generaSezioneTapparella(tapparella, config) {
            if (!tapparella || !tapparella.quantita || tapparella.quantita === 0) return '';
            
            let html = '<div class="sezione-tapparella"><h3>ğŸ“œ TAPPARELLA</h3>';
            
            if (config.tapparella_azienda && tapparella.azienda) {
                html += `<p><strong>Azienda:</strong> ${tapparella.azienda}</p>`;
            }
            if (config.tapparella_tipo && tapparella.tipo) {
                html += `<p><strong>Tipo:</strong> ${tapparella.tipo}</p>`;
            }
            if (config.tapparella_colore && tapparella.colore) {
                html += `<p><strong>Colore:</strong> ${tapparella.colore}</p>`;
            }
            if (config.tapparella_automazione && tapparella.automazione) {
                html += `<p><strong>Automazione:</strong> ${tapparella.automazione}</p>`;
            }
            if (config.tapparella_guida && tapparella.guida) {
                html += `<p><strong>Guida:</strong> ${tapparella.guida}</p>`;
            }
            
            html += `<p><strong>QuantitÃ :</strong> ${tapparella.quantita}</p>`;
            html += '</div>';
            
            return html;
        }
        
        /**
         * Genera sezione Zanzariera per una posizione
         */
        function generaSezioneZanzariera(zanzariera, config) {
            if (!zanzariera || !zanzariera.quantita || zanzariera.quantita === 0) return '';
            
            let html = '<div class="sezione-zanzariera"><h3>ğŸ¦Ÿ ZANZARIERA</h3>';
            
            if (config.zanzariera_azienda && zanzariera.azienda) {
                html += `<p><strong>Azienda:</strong> ${zanzariera.azienda}</p>`;
            }
            if (config.zanzariera_tipo && zanzariera.tipo) {
                html += `<p><strong>Tipo:</strong> ${zanzariera.tipo}</p>`;
            }
            if (config.zanzariera_colore && zanzariera.colore) {
                html += `<p><strong>Colore:</strong> ${zanzariera.colore}</p>`;
            }
            
            html += `<p><strong>QuantitÃ :</strong> ${zanzariera.quantita}</p>`;
            html += '</div>';
            
            return html;
        }
        
        /**
         * Genera sezione Cassonetto per una posizione
         */
        function generaSezioneCassonetto(cassonetto, config) {
            if (!cassonetto || !cassonetto.quantita || cassonetto.quantita === 0) return '';
            
            let html = '<div class="sezione-cassonetto"><h3>ğŸ“¦ CASSONETTO</h3>';
            
            if (config.cassonetto_azienda && cassonetto.azienda) {
                html += `<p><strong>Azienda:</strong> ${cassonetto.azienda}</p>`;
            }
            if (config.cassonetto_tipo && cassonetto.tipo) {
                html += `<p><strong>Tipo:</strong> ${cassonetto.tipo}</p>`;
            }
            if (config.cassonetto_isolamento && cassonetto.isolamento) {
                html += `<p><strong>Isolamento:</strong> ${cassonetto.isolamento}</p>`;
            }
            
            html += `<p><strong>QuantitÃ :</strong> ${cassonetto.quantita}</p>`;
            html += '</div>';
            
            return html;
        }
        
        /**
         * Genera sezione Prezzi per una posizione
         */
        function generaSezionePrezzi(posizione, config) {
            if (!config.prezzo_calcolato && !config.prezzo_editabile) return '';
            
            let html = '<div class="sezione-prezzi"><h3>ğŸ’° PREZZO</h3>';
            
            if (config.prezzo_calcolato) {
                // Calcola prezzo totale posizione
                let totale = 0;
                if (posizione.infisso && posizione.infisso.prezzo) {
                    totale += parseFloat(posizione.infisso.prezzo) || 0;
                }
                if (posizione.persiana && posizione.persiana.prezzo) {
                    totale += parseFloat(posizione.persiana.prezzo) || 0;
                }
                if (posizione.tapparella && posizione.tapparella.prezzo) {
                    totale += parseFloat(posizione.tapparella.prezzo) || 0;
                }
                if (posizione.zanzariera && posizione.zanzariera.prezzo) {
                    totale += parseFloat(posizione.zanzariera.prezzo) || 0;
                }
                if (posizione.cassonetto && posizione.cassonetto.prezzo) {
                    totale += parseFloat(posizione.cassonetto.prezzo) || 0;
                }
                
                html += `<p><strong>Prezzo Totale Calcolato:</strong> â‚¬ ${totale.toFixed(2)}</p>`;
            }
            
            if (config.prezzo_editabile) {
                html += `
                    <div class="campo-prezzo-editabile">
                        <p><em>Campo prezzo da compilare manualmente in Odoo</em></p>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        /**
         * Genera documento Conferma Cliente completo
         */
        function generaDocumentoConferma() {
            const content = document.getElementById('conferma-content');
            if (!content) return;
            
            const data = appState.rilievoData;
            if (!data || !data.posizioni || data.posizioni.length === 0) {
                content.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #64748b;">
                        <p>âš ï¸ Nessuna posizione disponibile nel progetto</p>
                    </div>
                `;
                return;
            }
            
            console.log('ğŸ“‹ Generazione documento conferma...');
            console.log(`   Posizioni: ${data.posizioni.length}`);
            
            // Carica configurazione colonne
            const config = caricaConfigurazioneConferma();
            console.log('   Configurazione colonne:', config);
            
            // Aggiorna stato quick toggles
            const hasPrezzi = config.prezzo_calcolato || config.prezzo_editabile;
            const togglePrezzi = document.getElementById('toggle-prezzi');
            const toggleNote = document.getElementById('toggle-note');
            if (togglePrezzi) togglePrezzi.checked = hasPrezzi;
            if (toggleNote) toggleNote.checked = config.note || false;
            
            // Genera HTML documento
            let html = `
                <div style="text-align: center; margin-bottom: 40px; padding: 30px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 12px;">
                    <h1 style="color: #2563eb; margin: 0 0 10px 0;">ğŸ“‹ Conferma Cliente</h1>
                    <p style="color: #1e40af; font-size: 1.1rem; margin: 0;">
                        <strong>${data.cliente_nome || 'Cliente'}</strong>
                    </p>
                    <p style="color: #64748b; margin: 5px 0 0 0;">
                        ${data.cliente_indirizzo || ''} ${data.cliente_citta ? '- ' + data.cliente_citta : ''}
                    </p>
                    <p style="color: #64748b; margin: 5px 0 0 0;">
                        Data: ${data.data_rilievo || new Date().toLocaleDateString('it-IT')}
                    </p>
                </div>
            `;
            
            // Genera pagina per ogni posizione
            data.posizioni.forEach((pos, index) => {
                html += '<div class="conferma-page">';
                
                // Header posizione
                html += `
                    <h2>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</h2>
                    <h2>POSIZIONE ${index + 1}: ${pos.nome || 'Senza nome'}</h2>
                    <h2>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</h2>
                `;
                
                // Sezione Misure (sempre presente)
                html += `
                    <div class="sezione-misure">
                        <h3>ğŸ“ MISURE</h3>
                        <p><strong>Larghezza:</strong> ${pos.larghezza || 'N/D'} cm</p>
                        <p><strong>Altezza:</strong> ${pos.altezza || 'N/D'} cm</p>
                    </div>
                `;
                
                // Sezioni prodotti (solo se presenti e colonne attive)
                html += generaSezioneInfisso(pos.infisso, config);
                html += generaSezionePersiana(pos.persiana, config);
                html += generaSezioneTapparella(pos.tapparella, config);
                html += generaSezioneZanzariera(pos.zanzariera, config);
                html += generaSezioneCassonetto(pos.cassonetto, config);
                
                // Sezione Prezzi (se attivata)
                html += generaSezionePrezzi(pos, config);
                
                // Sezione Note (se attivata e presenti)
                if (config.note && pos.note) {
                    html += `
                        <div class="sezione-note">
                            <h3>ğŸ“ NOTE</h3>
                            <p>${pos.note}</p>
                        </div>
                    `;
                }
                
                html += '</div>'; // chiudi conferma-page
                
                // Page break (tranne ultima posizione)
                if (index < data.posizioni.length - 1) {
                    html += '<div class="page-break"></div>';
                }
            });
            
            // Inserisci nel DOM
            content.innerHTML = html;
            
            console.log('âœ… Documento generato con successo!');
            console.log(`   Pagine: ${data.posizioni.length}`);
        }
        
        /**
         * Esporta PDF (placeholder Step 7)
         */
        /**
         * Esporta Conferma Cliente come PDF
         * Usa window.print() con CSS ottimizzato per stampa
         */
        function esportaConfermaClientePDF() {
            const content = document.getElementById('conferma-content');
            if (!content || !content.innerHTML.trim()) {
                alert('âš ï¸ Nessun documento da esportare!\n\nGenera prima il documento Conferma Cliente.');
                return;
            }
            
            const data = appState.rilievoData;
            if (!data) {
                alert('âš ï¸ Dati progetto non disponibili!');
                return;
            }
            
            console.log('ğŸ“„ Preparazione export PDF...');
            
            // Prepara nome file suggerito
            const nomeCliente = (data.cliente_nome || 'Cliente').replace(/[^a-z0-9]/gi, '-');
            const dataOggi = new Date().toLocaleDateString('it-IT').replace(/\//g, '-');
            const nomeFile = `Conferma-Cliente-${nomeCliente}-${dataOggi}`;
            
            // Crea finestra stampa
            const printWindow = window.open('', '_blank', 'width=1000,height=800');
            if (!printWindow) {
                alert('âš ï¸ Impossibile aprire finestra di stampa!\n\nVerifica che il browser consenta i popup.');
                return;
            }
            
            // Genera HTML per stampa
            const htmlContent = `
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${nomeFile}</title>
    <style>
        /* Reset e Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #1e293b;
            background: white;
            padding: 0;
            margin: 0;
        }
        
        /* Configurazione pagina */
        @page {
            size: A4;
            margin: 2cm;
        }
        
        /* Header documento */
        .document-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-radius: 12px;
            border: 2px solid #3b82f6;
        }
        
        .document-header h1 {
            color: #2563eb;
            font-size: 24pt;
            margin-bottom: 10px;
        }
        
        .document-header .cliente-nome {
            font-size: 14pt;
            font-weight: 600;
            color: #1e40af;
            margin: 5px 0;
        }
        
        .document-header .cliente-info {
            font-size: 10pt;
            color: #64748b;
            margin: 3px 0;
        }
        
        /* Pagina posizione */
        .conferma-page {
            page-break-after: always;
            padding: 20px 0;
        }
        
        .conferma-page:last-child {
            page-break-after: auto;
        }
        
        /* Header posizione */
        .conferma-page h2 {
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 8px;
            margin: 15px 0;
            font-size: 16pt;
        }
        
        .conferma-page h3 {
            color: #1e40af;
            font-size: 13pt;
            margin: 15px 0 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Sezioni prodotti */
        .sezione-misure,
        .sezione-infisso,
        .sezione-persiana,
        .sezione-tapparella,
        .sezione-zanzariera,
        .sezione-cassonetto,
        .sezione-prezzi,
        .sezione-note {
            margin: 15px 0;
            padding: 12px 15px;
            border-left: 4px solid #3b82f6;
            background: #f9fafb;
            border-radius: 4px;
        }
        
        .sezione-infisso {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }
        
        .sezione-persiana {
            border-left-color: #8b5cf6;
            background: #f5f3ff;
        }
        
        .sezione-tapparella {
            border-left-color: #ec4899;
            background: #fdf2f8;
        }
        
        .sezione-zanzariera {
            border-left-color: #06b6d4;
            background: #ecfeff;
        }
        
        .sezione-cassonetto {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .sezione-prezzi {
            border-left-color: #10b981;
            background: #f0fdf4;
            font-weight: 600;
        }
        
        .sezione-note {
            border-left-color: #f59e0b;
            background: #fffbeb;
            font-style: italic;
        }
        
        /* Paragrafi */
        .conferma-page p {
            margin: 6px 0;
            line-height: 1.6;
        }
        
        .conferma-page strong {
            color: #0f172a;
            font-weight: 600;
        }
        
        /* Campo prezzo editabile */
        .campo-prezzo-editabile {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border: 2px dashed #cbd5e1;
            border-radius: 6px;
            min-height: 40px;
            color: #64748b;
            font-style: italic;
        }
        
        /* Page breaks */
        .page-break {
            page-break-after: always;
            height: 0;
            margin: 0;
            padding: 0;
        }
        
        /* Stampa ottimizzata */
        @media print {
            body {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }
            
            .page-break {
                page-break-after: always;
            }
            
            .conferma-page {
                page-break-inside: avoid;
            }
            
            /* Evita rottura sezioni */
            .sezione-misure,
            .sezione-infisso,
            .sezione-persiana,
            .sezione-tapparella,
            .sezione-zanzariera,
            .sezione-cassonetto,
            .sezione-prezzi,
            .sezione-note {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    ${content.innerHTML}
    
    <script>
        // Auto-stampa dopo caricamento
        window.onload = function() {
            console.log('ğŸ“„ Finestra stampa pronta');
            
            // Breve delay per rendering completo
            setTimeout(function() {
                window.print();
                
                // Chiudi finestra dopo stampa (opzionale)
                // window.onafterprint = function() {
                //     window.close();
                // };
            }, 500);
        };
    <\/script>
</body>
</html>
            `;
            
            // Scrivi contenuto nella finestra
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            console.log('âœ… Finestra stampa aperta!');
            console.log(`   Nome file suggerito: ${nomeFile}.pdf`);
            
            // Alert informativo
            showAlert('success', `ğŸ“„ Finestra stampa aperta!\n\nNome file: ${nomeFile}.pdf`);
        }
        
        /**
         * ============================================================================
         * MODAL SCELTA BRM
         * ============================================================================
         */
        
        let brmModalCallback = null;
        let brmSceltaLarghezza = null;
        let brmSceltaAltezza = null;
        
        /**
         * Mostra modal per scegliere misure BRM
         */
        function mostraModalBRM(options) {
            const {
                posizione,
                misureDisponibili,
                needLarghezza,
                needAltezza,
                callback
            } = options;
            
            // Salva callback
            brmModalCallback = callback;
            brmSceltaLarghezza = null;
            brmSceltaAltezza = null;
            
            // Imposta nome posizione
            document.getElementById('brm-posizione-nome').textContent = 
                `${posizione.nome || 'Posizione'} - ${posizione.locale || posizione.ambiente || ''}`;
            
            // Mostra sezioni necessarie
            const sectionLarghezza = document.getElementById('brm-section-larghezza');
            const sectionAltezza = document.getElementById('brm-section-altezza');
            
            sectionLarghezza.style.display = needLarghezza ? 'block' : 'none';
            sectionAltezza.style.display = needAltezza ? 'block' : 'none';
            
            // Popola opzioni larghezza
            if (needLarghezza) {
                const optionsL = document.getElementById('brm-options-larghezza');
                optionsL.innerHTML = '';
                
                if (misureDisponibili.LVT) {
                    optionsL.innerHTML += createBRMOption('L', 'LVT', 'LVT - Luce Vano Telaio', misureDisponibili.LVT);
                }
                if (misureDisponibili.LF) {
                    optionsL.innerHTML += createBRMOption('L', 'LF', 'LF - Larghezza Foro', misureDisponibili.LF);
                }
                optionsL.innerHTML += createBRMOption('L', 'MANUALE', 'Inserisci manuale', null, true);
            }
            
            // Popola opzioni altezza
            if (needAltezza) {
                const optionsH = document.getElementById('brm-options-altezza');
                optionsH.innerHTML = '';
                
                if (misureDisponibili.HVT) {
                    optionsH.innerHTML += createBRMOption('H', 'HVT', 'HVT - Altezza Vano Telaio', misureDisponibili.HVT);
                }
                if (misureDisponibili.HF) {
                    optionsH.innerHTML += createBRMOption('H', 'HF', 'Altezza Foro', misureDisponibili.HF);
                }
                optionsH.innerHTML += createBRMOption('H', 'MANUALE', 'Inserisci manuale', null, true);
            }
            
            // Mostra modal
            const overlay = document.getElementById('brm-modal-overlay');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Disabilita bottone conferma
            document.getElementById('brm-btn-conferma').disabled = true;
        }
        
        /**
         * Crea HTML per un'opzione BRM
         */
        function createBRMOption(tipo, key, label, valore, isManuale = false) {
            const id = `brm-option-${tipo}-${key}`;
            const inputId = `brm-input-${tipo}-${key}`;
            
            return `
                <div class="brm-option" id="${id}" onclick="selezionaBRMOption('${tipo}', '${key}', ${isManuale})">
                    <div class="brm-option-radio"></div>
                    <div class="brm-option-content">
                        <div class="brm-option-label">${label}</div>
                        ${!isManuale && valore ? `
                            <div class="brm-option-value">${valore}<span class="brm-option-unit">mm</span></div>
                        ` : ''}
                        ${isManuale ? `
                            <div class="brm-option-input" id="${inputId}">
                                <label class="brm-input-label">Inserisci valore in mm:</label>
                                <input type="number" class="brm-input-field" 
                                       placeholder="es. 1200" 
                                       min="100" max="5000"
                                       onchange="aggiornaBRMManuale('${tipo}', this.value)"
                                       onclick="event.stopPropagation()">
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        /**
         * Seleziona un'opzione BRM
         */
        function selezionaBRMOption(tipo, key, isManuale) {
            // Rimuovi selezione precedente
            const options = document.querySelectorAll(`.brm-option[id^="brm-option-${tipo}-"]`);
            options.forEach(opt => opt.classList.remove('selected'));
            
            // Aggiungi selezione
            const selected = document.getElementById(`brm-option-${tipo}-${key}`);
            selected.classList.add('selected');
            
            // Mostra/nascondi input manuale
            const inputs = document.querySelectorAll(`[id^="brm-input-${tipo}-"]`);
            inputs.forEach(inp => inp.classList.remove('active'));
            
            if (isManuale) {
                const inputDiv = document.getElementById(`brm-input-${tipo}-${key}`);
                inputDiv.classList.add('active');
                const inputField = inputDiv.querySelector('input');
                setTimeout(() => inputField.focus(), 100);
            } else {
                // Salva valore dalla label
                const valueEl = selected.querySelector('.brm-option-value');
                if (valueEl) {
                    const valore = parseInt(valueEl.textContent);
                    if (tipo === 'L') {
                        brmSceltaLarghezza = valore;
                    } else {
                        brmSceltaAltezza = valore;
                    }
                }
            }
            
            // Verifica se puÃ² abilitare conferma
            verificaBRMCompleto();
        }
        
        /**
         * Aggiorna valore BRM manuale
         */
        function aggiornaBRMManuale(tipo, valore) {
            const val = parseInt(valore);
            if (!isNaN(val) && val >= 100 && val <= 5000) {
                if (tipo === 'L') {
                    brmSceltaLarghezza = val;
                } else {
                    brmSceltaAltezza = val;
                }
                verificaBRMCompleto();
            }
        }
        
        /**
         * Verifica se tutte le misure necessarie sono state selezionate
         */
        function verificaBRMCompleto() {
            const needL = document.getElementById('brm-section-larghezza').style.display !== 'none';
            const needH = document.getElementById('brm-section-altezza').style.display !== 'none';
            
            const completo = (!needL || brmSceltaLarghezza !== null) && 
                           (!needH || brmSceltaAltezza !== null);
            
            document.getElementById('brm-btn-conferma').disabled = !completo;
        }
        
        /**
         * Conferma scelta BRM e chiama callback
         */
        function confermaBRM() {
            if (brmModalCallback) {
                brmModalCallback({
                    larghezza: brmSceltaLarghezza,
                    altezza: brmSceltaAltezza
                });
            }
            chiudiModalBRM();
        }
        
        /**
         * Chiudi modal BRM
         */
        function chiudiModalBRM() {
            const overlay = document.getElementById('brm-modal-overlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
            
            // Reset
            brmModalCallback = null;
            brmSceltaLarghezza = null;
            brmSceltaAltezza = null;
        }
        
        /**
         * ============================================================================
         */
        
        /**
         * Render preventivo nel modal
         */
        function renderPreventivo(preventivo) {
            const content = document.getElementById('preventivo-modal-content');
            
            if (!preventivo.successo || preventivo.prodotti.length === 0) {
                content.innerHTML = `
                    <div class="preventivo-placeholder">
                        <div class="preventivo-placeholder-icon">âš ï¸</div>
                        <div class="preventivo-placeholder-text">
                            Nessun prodotto con dati sufficienti per calcolare il preventivo.<br>
                            Verifica che siano presenti <strong>modelli</strong> e <strong>misure BRM</strong> nei rilievi.
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="preventivo-info-progetto">
                    <h3>ğŸ“‹ ${preventivo.progetto}</h3>
                    ${preventivo.cliente.nome ? `<p><strong>Cliente:</strong> ${preventivo.cliente.nome} ${preventivo.cliente.cognome || ''}</p>` : ''}
                    <p><strong>Data:</strong> ${new Date(preventivo.timestamp).toLocaleDateString('it-IT')}</p>
                    <p><strong>Prodotti:</strong> ${preventivo.prodotti.length}</p>
                </div>
                
                <div class="preventivo-prodotti-lista">
            `;
            
            preventivo.prodotti.forEach((prod, idx) => {
                html += `
                    <div class="preventivo-prodotto-card">
                        <div class="preventivo-prodotto-header">
                            <div class="preventivo-prodotto-info">
                                <h4>${prod.posizione}</h4>
                                <p>${prod.prodotto} - ${prod.modello}</p>
                            </div>
                            <div class="preventivo-prodotto-prezzo">
                                <div class="preventivo-prezzo-label">Prezzo</div>
                                <div class="preventivo-prezzo-valore">â‚¬ ${prod.prezzi.totale}</div>
                            </div>
                        </div>
                        
                        <div class="preventivo-prodotto-dettagli">
                            <div class="preventivo-dettaglio-item">
                                <div class="preventivo-dettaglio-label">Larghezza</div>
                                <div class="preventivo-dettaglio-valore">${prod.misure.larghezza} mm</div>
                            </div>
                            <div class="preventivo-dettaglio-item">
                                <div class="preventivo-dettaglio-label">Altezza</div>
                                <div class="preventivo-dettaglio-valore">${prod.misure.altezza} mm</div>
                            </div>
                            <div class="preventivo-dettaglio-item">
                                <div class="preventivo-dettaglio-label">Superficie</div>
                                <div class="preventivo-dettaglio-valore">${prod.misure.superficie_mq} mÂ²</div>
                            </div>
                            ${prod.fascia ? `
                            <div class="preventivo-dettaglio-item">
                                <div class="preventivo-dettaglio-label">Fascia Prezzo</div>
                                <div class="preventivo-dettaglio-valore">Fascia ${prod.fascia}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div class="preventivo-totale-section">
                    <div class="preventivo-totale-row">
                        <span class="preventivo-totale-label">Subtotale</span>
                        <span class="preventivo-totale-valore">â‚¬ ${preventivo.totale}</span>
                    </div>
                    <div class="preventivo-totale-row">
                        <span class="preventivo-totale-label">IVA 22%</span>
                        <span class="preventivo-totale-valore">â‚¬ ${(preventivo.totale_iva - preventivo.totale).toFixed(2)}</span>
                    </div>
                    <div class="preventivo-totale-row finale">
                        <span class="preventivo-totale-label finale">TOTALE</span>
                        <span class="preventivo-totale-valore finale">â‚¬ ${preventivo.totale_iva}</span>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            currentPreventivo = preventivo;
            
            console.log('âœ… Preventivo renderizzato:', preventivo);
        }
        
        /**
         * Esporta PDF
         */
        function esportaPreventiPDF() {
            if (!currentPreventivo) {
                alert('Nessun preventivo disponibile per l\'export');
                return;
            }
            
            console.log('ğŸ“„ Export PDF:', currentPreventivo);
            alert('ğŸ“„ Funzione export PDF in fase di implementazione\n\nSarÃ  disponibile nella prossima versione con libreria jsPDF.');
        }
        
        console.log('âœ… Funzioni UI Preventivo caricate');
    </script>
    
    <!-- ğŸ“Š SHEETJS LIBRARY - Export Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div class="header-content">
            <!-- MENU TOGGLE HAMBURGER -->
            <button class="menu-toggle" onclick="toggleMenu()" aria-label="Toggle Menu">
                â˜°
            </button>
            
            <div class="logo">
                Dashboard Rilievi 
                <span class="logo-version" id="version-badge">v8.15</span>
                <span class="logo-subtitle">- Calcolo Completo</span>
            </div>
            <nav class="main-nav">
                <button class="nav-btn active blocco-ufficio" onclick="switchBlocco('ufficio')">
                    ğŸ’¼ Ufficio
                </button>
                <button class="nav-btn blocco-posa" onclick="apriPosaApp()" title="Apri App Posa in nuova finestra">
                    ğŸ”§ Apri App Posa
                </button>
                
                <!-- PULSANTE CONFERMA CLIENTE -->
                <button class="nav-btn blocco-conferma" id="btn-conferma-cliente" onclick="apriConfermaCliente()" 
                        style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; font-weight: 700;" 
                        title="Genera documento conferma per il cliente"
                        disabled>
                    ğŸ“‹ Conferma Cliente
                </button>
            </nav>
        </div>
        
    </header>

    <!-- MENU LATERALE -->
    <div id="sidebarMenu" class="sidebar-menu">
        <div class="sidebar-header">
            <h3>Menu</h3>
            <button onclick="closeSidebar()" class="close-btn">&times;</button>
        </div>
        <div class="sidebar-content">
            
            <div class="sidebar-item sidebar-expandable" onclick="toggleGithubProjects(event)">
                <div class="sidebar-item-header">
                    <span>ğŸ”„</span> GitHub Projects
                    <span class="expand-icon">â–¼</span>
                </div>
            </div>
            <div id="githubProjectsList" class="sidebar-submenu" style="display: none;">
                <!-- Popolato dinamicamente -->
            </div>
            
            <div class="sidebar-item sidebar-expandable" onclick="toggleImpostazioni(event)">
                <div class="sidebar-item-header">
                    <span>âš™ï¸</span> Impostazioni
                    <span class="expand-icon">â–¼</span>
                </div>
            </div>
            <div id="impostazioniMenu" class="sidebar-submenu" style="display: none;">
                <button class="sidebar-action-btn import" onclick="document.getElementById('jsonFileInput').click(); closeSidebar();" title="Importa file JSON di rilievo">
                    <span>ğŸ“</span> Importa JSON
                </button>
                <button class="sidebar-action-btn github" onclick="loadProjectsFromGitHub(); closeSidebar();" title="Ricarica progetti da GitHub">
                    <span>ğŸ”„</span> GitHub
                </button>
                <button class="sidebar-action-btn settings" onclick="showGitHubTokenForm(); closeSidebar();" title="Configura GitHub">
                    <span>âš™ï¸</span> Configura
                </button>
            </div>
        </div>
    </div>
    
    <!-- Overlay per chiudere sidebar -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- CONTAINER PRINCIPALE -->
    <div class="container">
        
        <!-- ====================================================================
             BLOCCO 1: GENERALE (ora nascosto di default, accessibile solo da sidebar GitHub)
             ==================================================================== -->
        <div id="blocco-generale" class="blocco">
            <div class="card">
                <div style="margin-bottom: 1.5rem;">
                    <h1 class="card-title" style="margin-bottom: 0.5rem;">ğŸ“Š Dashboard Generale</h1>
                </div>
                <input type="file" id="jsonFileInput" accept=".json" onchange="handleFileSelect(event)" style="display: none;">

                <!-- STATO DATI -->
                <div id="dataStatus" class="data-status" style="display: none;">
                    <!-- Popolato dinamicamente -->
                </div>
            </div>

            <!-- PLACEHOLDER (nascosto dopo import) -->
            <div id="generalePlaceholder" class="card">
                <div class="placeholder">
                    <div class="placeholder-icon">ğŸ“‹</div>
                    <div class="placeholder-title">Nessun rilievo caricato</div>
                    <div class="placeholder-text">
                        Carica un file JSON per visualizzare dashboard, KPI e tabella posizioni
                    </div>
                </div>
            </div>

            <!-- CONTENUTO (mostrato dopo import) -->
            <div id="generaleContent" style="display: none;">
                
                <!-- DASHBOARD KPI -->
                <div class="card">
                    <h2 class="card-title">ğŸ“Š Dashboard KPI</h2>
                    <div id="kpiCards" class="kpi-grid">
                        <!-- Popolato dinamicamente -->
                    </div>
                </div>

                <!-- FILTRI E RICERCA -->
                <div class="card">
                    <h2 class="card-title">ğŸ” Filtra Posizioni</h2>
                    <div class="filters-container">
                        <div class="filter-group">
                            <label>Piano:</label>
                            <select id="filterPiano" onchange="applyFilters()">
                                <option value="">Tutti i piani</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Stanza:</label>
                            <select id="filterStanza" onchange="applyFilters()">
                                <option value="">Tutte le stanze</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Prodotto:</label>
                            <select id="filterProdotto" onchange="applyFilters()">
                                <option value="">Tutti i prodotti</option>
                            </select>
                        </div>
                        <div class="filter-group search-group">
                            <label>Cerca:</label>
                            <input type="text" id="searchInput" placeholder="Cerca per ID, ambiente..." oninput="applyFilters()">
                        </div>
                        <button class="btn btn-secondary" onclick="resetFilters()">ğŸ”„ Reset</button>
                    </div>
                </div>

                <!-- TABELLA POSIZIONI -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 class="card-title" style="margin: 0;">ğŸ“‹ Tabella Posizioni</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="exportToJSON()">ğŸ’¾ JSON</button>
                            <button class="btn btn-primary" onclick="exportToCSV()">ğŸ“Š Excel/CSV</button>
                        </div>
                    </div>
                    <div id="tableContainer" class="table-container">
                        <!-- Popolato dinamicamente -->
                    </div>
                </div>

            </div>
        </div>

        <!-- ====================================================================
             BLOCCO 2: UFFICIO (ora default attivo)
             ==================================================================== -->
        <div id="blocco-ufficio" class="blocco active">
            
            <!-- Submenu Blocco Ufficio -->
            <div class="submenu-ufficio">
                <button class="submenu-btn active" onclick="switchVistaUfficio('generale', event)">
                    ğŸ“Š Vista Generale
                </button>
                <button class="submenu-btn" onclick="switchVistaUfficio('posizioni', event)">
                    ğŸ“‹ Vista Posizioni
                </button>
                <button class="submenu-btn" onclick="switchVistaUfficio('aziende', event)">
                    ğŸ¢ Vista Aziende
                </button>
                <button class="submenu-btn" onclick="switchVistaUfficio('preventivo', event)">
                    ğŸ’° Preventivo
                </button>
            </div>

            <!-- ============================================================
                 VISTA GENERALE UFFICIO
                 ============================================================ -->
            <div id="vista-generale-ufficio" class="vista-ufficio active">
                
                <!-- Placeholder quando nessun dato caricato -->
                <div id="ufficioPlaceholder">
                    <div class="card">
                        <div class="placeholder">
                            <div class="placeholder-icon">ğŸ“Š</div>
                            <div class="placeholder-title">Vista Generale Ufficio</div>
                            <div class="placeholder-text">
                                Carica un file JSON dal Blocco Generale per visualizzare<br>
                                le informazioni del progetto, totali commessa e stato avanzamento
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenuto Vista Generale (nascosto inizialmente) -->
                <div id="ufficioContent" class="content-hidden">
                    
                    <!-- SEZIONE A: Info Cliente -->
                    <div class="card-ufficio">
                        <h2 class="card-ufficio-title">
                            <span class="card-ufficio-icon">ğŸ‘¤</span>
                            Informazioni Cliente e Progetto
                        </h2>
                        <div id="infoCliente" class="info-grid">
                            <!-- Popolato dinamicamente -->
                        </div>
                        <div id="noteProgetto">
                            <!-- Note progetto (se presenti) -->
                        </div>
                    </div>

                    <!-- SEZIONE B2: Configurazione Infissi Globale - RIMOSSA (spostata in Vista Aziende) -->

                    <!-- SEZIONE C: Totali Commessa - Creata dinamicamente v7.21 -->
                    <div id="totaliCommessaContainer"></div>

                    <!-- SEZIONE D: Configurazione Prodotti Globale - v7.997 -->
                    <div id="configGlobaleUfficioContainer" class="card-ufficio" style="display: none;">
                        <h2 class="card-ufficio-title">
                            <span class="card-ufficio-icon">âš™ï¸</span>
                            Configurazione Prodotti Globale
                        </h2>
                        <p style="color: #6b7280; font-size: 0.85rem; margin-bottom: 1rem;">
                            Imposta i valori predefiniti. Simboli: â—‹ PVC base, â— PVC pellicola, â—‡ Alu standard, â—† Alu legno
                        </p>
                        
                        <!-- Tabs Categorie -->
                        <div class="config-tabs">
                            <button class="config-tab active" onclick="switchConfigTabUfficio('infissi')">ğŸªŸ Infissi</button>
                            <button class="config-tab" onclick="switchConfigTabUfficio('persiane')">ğŸšª Persiane</button>
                            <button class="config-tab" onclick="switchConfigTabUfficio('tapparelle')">ğŸšï¸ Tapparelle</button>
                            <button class="config-tab" onclick="switchConfigTabUfficio('cassonetti')">ğŸ“¦ Cassonetti</button>
                            <button class="config-tab" onclick="switchConfigTabUfficio('zanzariere')">ğŸ¦Ÿ Zanzariere</button>
                        </div>
                        
                        <!-- Pannelli Config -->
                        <div id="configPanelInfissiUfficio" class="config-panel active"></div>
                        <div id="configPanelPersianeUfficio" class="config-panel"></div>
                        <div id="configPanelTapparelleUfficio" class="config-panel"></div>
                        <div id="configPanelCassonettiUfficio" class="config-panel"></div>
                        <div id="configPanelZanzariereUfficio" class="config-panel"></div>
                        
                        <!-- Azioni -->
                        <div class="config-actions">
                            <button class="config-btn config-btn-reset" onclick="resetConfigGlobaleMenuUfficio()">
                                ğŸ”„ Reset
                            </button>
                            <button class="config-btn config-btn-save" onclick="salvaConfigGlobaleMenuUfficio()">
                                ğŸ’¾ Salva Config
                            </button>
                        </div>
                    </div>

                </div>
            </div>

            <!-- ============================================================
                 VISTA POSIZIONI - Implementata in Chat 100011
                 ============================================================ -->
            <div id="vista-posizioni-ufficio" class="vista-ufficio">
                
                <!-- Placeholder quando nessun dato caricato -->
                <div id="posizioniPlaceholder">
                    <div class="card">
                        <div class="placeholder">
                            <div class="placeholder-icon">ğŸ“‹</div>
                            <div class="placeholder-title">Vista Posizione per Posizione</div>
                            <div class="placeholder-text">
                                Carica un file JSON dal Blocco Generale per visualizzare<br>
                                il dettaglio completo di ogni posizione rilevata
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenuto Vista Posizioni (nascosto inizialmente) -->
                <div id="posizioniContent" class="content-hidden">
                    
                    <!-- Header Progetto -->
                    <div id="projectHeaderPosizioni" class="card" style="margin-bottom: 1.5rem;">
                        <div style="padding: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div>
                                    <h2 id="projectNameDisplay" style="font-size: 1.5rem; color: #1e293b; margin: 0 0 0.5rem 0; font-weight: 700;">
                                        Nome Progetto
                                    </h2>
                                    <div id="projectClientDisplay" style="color: #475569; font-size: 1.1rem; font-weight: 500;">
                                        ğŸ‘¤ Cliente
                                    </div>
                                </div>
                                <div style="text-align: right; color: #6b7280; font-size: 0.9rem;">
                                    <div id="projectDateDisplay" style="margin-bottom: 0.25rem;">
                                        ğŸ“… Data
                                    </div>
                                    <div id="projectPositionsCountDisplay">
                                        ğŸ“ Posizioni
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="positions-layout">
                        
                        <!-- Sidebar Lista Posizioni -->
                        <aside class="positions-sidebar">
                            <div class="positions-sidebar-title">
                                ğŸ“‹ Posizioni
                                <span id="positionsCount" style="font-size: 0.9rem; color: #6b7280; font-weight: 400;"></span>
                            </div>

                            <!-- Lista posizioni -->
                            <div id="positionsList" class="positions-list">
                                <!-- Popolata dinamicamente -->
                            </div>
                        </aside>

                        <!-- Card Dettaglio Posizione -->
                        <div class="position-detail">
                            <!-- âŒ v7.997: Config Globale SPOSTATA in Ufficio â†’ Vista Generale -->
                            <!-- (Container rimosso - ora in configGlobaleUfficioContainer) -->
                            
                            <!-- ğŸ†• v7.94: Config Globale ora Ã¨ DENTRO ogni tab prodotto -->
                            
                            <div id="positionDetailCard" class="position-card">
                                <!-- Popolata dinamicamente -->
                            </div>
                        </div>

                    </div>

                </div>

            </div>

            <!-- ============================================================
                 VISTA AZIENDE (placeholder per prossima chat)
                 ============================================================ -->
            <!-- ============================================================
                 VISTA AZIENDE - Implementata in Chat 10012
                 ============================================================ -->
            <div id="vista-aziende-ufficio" class="vista-ufficio">
                
                <!-- Placeholder quando nessun dato caricato -->
                <div id="aziendePlaceholder">
                    <div class="card">
                        <div class="placeholder">
                            <div class="placeholder-icon">ğŸ¢</div>
                            <div class="placeholder-title">Vista Prodotti per Azienda</div>
                            <div class="placeholder-text">
                                Carica un file JSON dal Blocco Generale per visualizzare<br>
                                il riepilogo prodotti raggruppati per fornitore/azienda
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenuto vista aziende -->
                <div id="aziendeContent" class="content-hidden">
                    
                    <!-- Header vista -->
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <h2 style="font-size: 1.5rem; font-weight: 700; color: #10b981; margin-bottom: 0.5rem;">
                            ğŸ¢ Vista Prodotti per Azienda
                        </h2>
                        <p style="color: #6b7280; margin: 0;">
                            Riepilogo prodotti raggruppati per fornitore
                        </p>
                    </div>

                    <!-- Contenitore card aziende -->
                    <div id="aziendeCards" class="aziende-container">
                        <!-- Popolato dinamicamente da renderVistaAziende() -->
                    </div>

                </div>
            </div>

            <!-- ============================================================
                 VISTA PREVENTIVO - Foglio Calcolo con Listino Finstral
                 Implementata in Chat v7.22
                 ============================================================ -->
            <div id="vista-preventivo-ufficio" class="vista-ufficio">
                
                <!-- Placeholder quando nessun dato caricato -->
                <div id="preventivoPlaceholder">
                    <div class="card">
                        <div class="placeholder">
                            <div class="placeholder-icon">ğŸ’°</div>
                            <div class="placeholder-title">Vista Preventivo</div>
                            <div class="placeholder-text">
                                Carica un file JSON per calcolare il preventivo con listino Finstral
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenuto Vista Preventivo (nascosto inizialmente) -->
                <div id="preventivoContent" class="content-hidden">
                    
                    <!-- HEADER PREVENTIVO -->
                    <div class="card">
                        <h2 class="card-title">ğŸ’° Preventivo - Calcolo Dettagliato</h2>
                        <p class="card-subtitle">
                            Calcolo prezzi con listino Finstral EUR 2025/3 - Sistema supplementi al metro lineare BRM
                        </p>
                    </div>

                    <!-- TOOLBAR AZIONI -->
                    <div class="card" style="padding: 1rem;">
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                            <button class="btn btn-primary" onclick="ricalcolaPreventivo(); ricalcolaTotaliPreventivo();">
                                ğŸ”„ Ricalcola Preventivo
                            </button>
                            <button class="btn btn-success" onclick="exportPreventivoExcel()">
                                ğŸ“Š Export Excel
                            </button>
                            <button class="btn" onclick="window.print()">
                                ğŸ–¨ï¸ Stampa PDF
                            </button>
                            
                            <!-- Separatore -->
                            <div style="width: 2px; height: 30px; background: #d1d5db;"></div>
                            
                            <!-- NUOVI BOTTONI -->
                            <button class="btn" onclick="apriGestioneListini()" 
                                    style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-weight: 600;"
                                    title="Gestione listini fornitori">
                                ğŸ“š Listini
                            </button>
                            <button class="btn" onclick="apriPreventivo()" 
                                    style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-weight: 600;"
                                    title="Apri dettaglio costi completo">
                                ğŸ’° Dettaglio Costi
                            </button>
                            
                            <div style="margin-left: auto; display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-weight: 600;">Ricarico:</label>
                                <input type="number" id="ricaricoPct" value="50" min="0" max="100" step="1" 
                                       onchange="ricalcolaPreventivo(); ricalcolaTotaliPreventivo();" 
                                       style="width: 60px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; text-align: center; font-weight: 600; background: #fef3c7;">
                                <span style="color: #64748b;">%</span>
                                
                                <div style="width: 1px; height: 24px; background: #d1d5db; margin: 0 0.5rem;"></div>
                                
                                <label style="font-weight: 600;">Tipo Intervento:</label>
                                <select id="tipoInterventoSelect" onchange="ricalcolaTotaliPreventivo()" 
                                        style="padding: 0.5rem; border: 1px solid #6366f1; border-radius: 0.375rem; font-size: 0.8rem; background: #eef2ff;">
                                    <option value="nessuna">Senza IVA</option>
                                    <option value="manutenzione" selected>Manutenzione ord/straord (IVA mista)</option>
                                    <option value="ristrutturazione">Ristrutturazione (tutto 10%)</option>
                                    <option value="nuova_costruzione_prima">Nuova costr. 1Âª casa (4%)</option>
                                    <option value="nuova_costruzione_altra">Nuova costr. altra (10%)</option>
                                    <option value="sola_fornitura">Sola fornitura (22%)</option>
                                </select>
                                
                                <span id="labelTipoIVA" style="font-size: 0.7rem; color: #6366f1; margin-left: 0.25rem;">
                                    ğŸ“Š Beni signif.
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- TABELLA FOGLIO CALCOLO STILE EXCEL -->
                    <div class="card" style="padding: 0; overflow: auto;">
                        <div class="excel-container">
                            <table class="excel-table" id="preventivoTable">
                                <thead>
                                    <tr>
                                        <th class="excel-col-narrow">Pos</th>
                                        <th class="excel-col-medium">Ambiente</th>
                                        <th class="excel-col-narrow">Tipo</th>
                                        <th class="excel-col-medium">Azienda</th>
                                        <th class="excel-col-narrow">Telaio</th>
                                        <th class="excel-col-narrow">L</th>
                                        <th class="excel-col-narrow">H</th>
                                        <th class="excel-col-narrow">mÂ²</th>
                                        <th class="excel-col-narrow">ml</th>
                                        <th class="excel-col-narrow">Base</th>
                                        <th class="excel-col-narrow">Tel.</th>
                                        <th class="excel-col-narrow">Anta</th>
                                        <th class="excel-col-narrow">Vetro</th>
                                        <th class="excel-col-narrow">Col.</th>
                                        <th class="excel-col-narrow">Man.</th>
                                        <th class="excel-col-narrow">Mont.</th>
                                        <th class="excel-col-narrow">Qt</th>
                                        <th class="excel-col-narrow" style="background: #fef3c7;">LIST.</th>
                                        <th class="excel-col-narrow" style="background: #d1fae5;">Sc%</th>
                                        <th class="excel-col-narrow" style="background: #d1fae5;">NETTO</th>
                                        <th class="excel-col-wide" style="background: #dbeafe;">CLIENTE</th>
                                    </tr>
                                </thead>
                                <tbody id="preventivoTableBody">
                                    <!-- Popolato dinamicamente -->
                                </tbody>
                                <tfoot>
                                    <!-- SUBTOTALE MATERIALI -->
                                    <tr class="excel-subtotal-row" style="background: #f0f9ff;">
                                        <td colspan="17" style="text-align: right; font-weight: 700;">SUBTOTALE MATERIALI:</td>
                                        <td class="excel-subtotal-value" id="totaleListino" style="background: #fef3c7;">â‚¬ 0.00</td>
                                        <td style="background: #d1fae5;"></td>
                                        <td class="excel-subtotal-value" id="totaleNetto" style="background: #d1fae5; color: #059669;">â‚¬ 0.00</td>
                                        <td class="excel-subtotal-value" id="totaleCliente" style="background: #dbeafe; color: #1d4ed8;">â‚¬ 0.00</td>
                                    </tr>
                                    <!-- SEPARATORE LAVORI -->
                                    <tr style="height: 8px; background: #fbbf24;">
                                        <td colspan="21" style="text-align: center; font-size: 0.7rem; color: #78350f; font-weight: 600;">ğŸ”§ COSTI LAVORO (senza ricarico)</td>
                                    </tr>
                                    <!-- POSA IN OPERA -->
                                    <tr class="excel-row" style="background: #fffbeb;">
                                        <td colspan="14" style="text-align: right; font-weight: 600;">ğŸ”§ Posa in opera:</td>
                                        <td style="text-align: right; font-size: 0.75rem; color: #6b7280;" id="posaSuggerito">sugg. â‚¬0</td>
                                        <td colspan="2" style="text-align: right;">
                                            <input type="number" id="inputPosa" value="0" min="0" step="50" 
                                                   onchange="ricalcolaTotaliPreventivo()" 
                                                   style="width: 80px; padding: 4px; border: 1px solid #f59e0b; border-radius: 4px; text-align: right; background: #fffbeb;">
                                            <span style="color: #92400e; font-size: 0.8rem;"> â‚¬</span>
                                        </td>
                                        <td class="excel-value" id="totalePosaListino" style="background: #fffbeb;">â‚¬ 0.00</td>
                                        <td style="background: #fffbeb;"></td>
                                        <td class="excel-value" id="totalePosaNetto" style="color: #059669; background: #fffbeb;">â‚¬ 0.00</td>
                                        <td class="excel-value" id="totalePosaCliente" style="color: #1d4ed8; background: #fffbeb;">â‚¬ 0.00</td>
                                    </tr>
                                    <!-- SMONTAGGIO -->
                                    <tr class="excel-row" style="background: #fffbeb;">
                                        <td colspan="14" style="text-align: right; font-weight: 600;">ğŸ”¨ Smontaggio:</td>
                                        <td style="text-align: right; font-size: 0.75rem; color: #6b7280;" id="smontaggioSuggerito">sugg. â‚¬0</td>
                                        <td colspan="2" style="text-align: right;">
                                            <input type="number" id="inputSmontaggio" value="0" min="0" step="10" 
                                                   onchange="ricalcolaTotaliPreventivo()" 
                                                   style="width: 80px; padding: 4px; border: 1px solid #f59e0b; border-radius: 4px; text-align: right; background: #fffbeb;">
                                            <span style="color: #92400e; font-size: 0.8rem;"> â‚¬</span>
                                        </td>
                                        <td class="excel-value" id="totaleSmontaggioListino" style="background: #fffbeb;">â‚¬ 0.00</td>
                                        <td style="background: #fffbeb;"></td>
                                        <td class="excel-value" id="totaleSmontaggioNetto" style="color: #059669; background: #fffbeb;">â‚¬ 0.00</td>
                                        <td class="excel-value" id="totaleSmontaggioCliente" style="color: #1d4ed8; background: #fffbeb;">â‚¬ 0.00</td>
                                    </tr>
                                    <!-- SMALTIMENTO -->
                                    <tr class="excel-row" style="background: #fffbeb;">
                                        <td colspan="14" style="text-align: right; font-weight: 600;">ğŸ—‘ï¸ Smaltimento:</td>
                                        <td style="text-align: right; font-size: 0.75rem; color: #6b7280;" id="smaltimentoSuggerito">sugg. â‚¬0</td>
                                        <td colspan="2" style="text-align: right;">
                                            <input type="number" id="inputSmaltimento" value="0" min="0" step="10" 
                                                   onchange="ricalcolaTotaliPreventivo()" 
                                                   style="width: 80px; padding: 4px; border: 1px solid #f59e0b; border-radius: 4px; text-align: right; background: #fffbeb;">
                                            <span style="color: #92400e; font-size: 0.8rem;"> â‚¬</span>
                                        </td>
                                        <td class="excel-value" id="totaleSmaltimentoListino" style="background: #fffbeb;">â‚¬ 0.00</td>
                                        <td style="background: #fffbeb;"></td>
                                        <td class="excel-value" id="totaleSmaltimentoNetto" style="color: #059669; background: #fffbeb;">â‚¬ 0.00</td>
                                        <td class="excel-value" id="totaleSmaltimentoCliente" style="color: #1d4ed8; background: #fffbeb;">â‚¬ 0.00</td>
                                    </tr>
                                    <!-- COMPONENTI POSA -->
                                    <tr class="excel-row" style="background: #fffbeb;">
                                        <td colspan="14" style="text-align: right; font-weight: 600;">ğŸ”© Componenti posa:</td>
                                        <td style="text-align: right; font-size: 0.75rem; color: #6b7280;" id="componentiSuggerito">sugg. â‚¬0</td>
                                        <td colspan="2" style="text-align: right;">
                                            <input type="number" id="inputComponenti" value="0" min="0" step="5" 
                                                   onchange="ricalcolaTotaliPreventivo()" 
                                                   style="width: 80px; padding: 4px; border: 1px solid #f59e0b; border-radius: 4px; text-align: right; background: #fffbeb;">
                                            <span style="color: #92400e; font-size: 0.8rem;"> â‚¬</span>
                                        </td>
                                        <td class="excel-value" id="totaleComponentiListino" style="background: #fffbeb;">â‚¬ 0.00</td>
                                        <td style="background: #fffbeb;"></td>
                                        <td class="excel-value" id="totaleComponentiNetto" style="color: #059669; background: #fffbeb;">â‚¬ 0.00</td>
                                        <td class="excel-value" id="totaleComponentiCliente" style="color: #1d4ed8; background: #fffbeb;">â‚¬ 0.00</td>
                                    </tr>
                                    <!-- ENEA ECOBONUS v8.26 -->
                                    <tr class="excel-row" id="rowENEA" style="background: #f0fdf4;">
                                        <td colspan="13" style="text-align: right; font-weight: 600;">ğŸ“„ Elaborazione ENEA:</td>
                                        <td style="text-align: center;">
                                            <input type="checkbox" id="checkENEA" checked onchange="ricalcolaTotaliPreventivo()" style="width: 18px; height: 18px; cursor: pointer;">
                                        </td>
                                        <td style="text-align: right; font-size: 0.75rem; color: #6b7280;">(IVA 22%)</td>
                                        <td colspan="2" style="text-align: right;">
                                            <input type="number" id="inputENEA" value="250" min="0" step="10" onchange="ricalcolaTotaliPreventivo()" style="width: 80px; padding: 4px; border: 1px solid #10b981; border-radius: 4px; text-align: right; background: #f0fdf4;">
                                            <span style="color: #065f46; font-size: 0.8rem;"> â‚¬</span>
                                        </td>
                                        <td class="excel-value" id="totaleENEAListino" style="background: #f0fdf4;">â‚¬ 0.00</td>
                                        <td style="background: #f0fdf4;"></td>
                                        <td class="excel-value" id="totaleENEANetto" style="color: #059669; background: #f0fdf4;">â‚¬ 0.00</td>
                                        <td class="excel-value" id="totaleENEACliente" style="color: #1d4ed8; background: #f0fdf4;">â‚¬ 0.00</td>
                                    </tr>
                                    <!-- TOTALE LAVORI -->
                                    <tr class="excel-row" style="background: #fef3c7;">
                                        <td colspan="17" style="text-align: right; font-weight: 700; color: #92400e;">TOTALE LAVORI:</td>
                                        <td class="excel-value" id="totaleLavoriListino" style="font-weight: 700; background: #fef3c7;">â‚¬ 0.00</td>
                                        <td style="background: #fef3c7;"></td>
                                        <td class="excel-value" id="totaleLavoriNetto" style="color: #059669; font-weight: 700; background: #fef3c7;">â‚¬ 0.00</td>
                                        <td class="excel-value" id="totaleLavoriCliente" style="color: #1d4ed8; font-weight: 700; background: #fef3c7;">â‚¬ 0.00</td>
                                    </tr>
                                    <!-- SEPARATORE -->
                                    <tr style="height: 4px; background: #1e40af;">
                                        <td colspan="21"></td>
                                    </tr>
                                    <!-- SUBTOTALE GENERALE -->
                                    <tr class="excel-subtotal-row">
                                        <td colspan="17" style="text-align: right; font-weight: 700;">SUBTOTALE:</td>
                                        <td class="excel-subtotal-value" id="subtotaleListino">â‚¬ 0.00</td>
                                        <td></td>
                                        <td class="excel-subtotal-value" id="subtotaleNetto" style="color: #059669;">â‚¬ 0.00</td>
                                        <td class="excel-subtotal-value" id="subtotaleCliente" style="color: #1d4ed8;">â‚¬ 0.00</td>
                                    </tr>
                                    <!-- MARGINE -->
                                    <tr class="excel-row" style="background: #ecfdf5;">
                                        <td colspan="17" style="text-align: right; font-weight: 700; color: #059669;">ğŸ’° TUO MARGINE:</td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td class="excel-value" id="totaleMargineLordo" style="font-weight: 700; color: #059669;">â‚¬ 0.00</td>
                                    </tr>
                                    <!-- SEPARATORE RIEPILOGO FISCALE -->
                                    <tr id="rowSeparatoreFiscale" style="height: 8px; background: #6366f1; display: none;">
                                        <td colspan="21" style="text-align: center; font-size: 0.65rem; color: white; font-weight: 600;">
                                            ğŸ“Š RIEPILOGO FISCALE (Art. 7 L. 488/99 - Beni Significativi)
                                        </td>
                                    </tr>
                                    
                                    <!-- BENI SIGNIFICATIVI QUOTA 10% -->
                                    <tr class="excel-row" id="rowBeniSignif10" style="display: none; background: #f0fdf4;">
                                        <td colspan="17" style="text-align: right; font-size: 0.8rem;">
                                            Serramenti (bene significativo - quota 10%):
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td class="excel-value" id="valBeniSignif10" style="color: #059669;">â‚¬ 0.00</td>
                                    </tr>
                                    
                                    <!-- BENI SIGNIFICATIVI QUOTA 22% -->
                                    <tr class="excel-row" id="rowBeniSignif22" style="display: none; background: #fef2f2;">
                                        <td colspan="17" style="text-align: right; font-size: 0.8rem;">
                                            Serramenti (bene significativo - quota 22%):
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td class="excel-value" id="valBeniSignif22" style="color: #dc2626;">â‚¬ 0.00</td>
                                    </tr>
                                    
                                    <!-- PARTI AUTONOME -->
                                    <tr class="excel-row" id="rowPartiAutonome" style="display: none; background: #f0fdf4;">
                                        <td colspan="17" style="text-align: right; font-size: 0.8rem;">
                                            Cassonetti/Oscuranti (non integrati - 10%):
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td class="excel-value" id="valPartiAutonome" style="color: #059669;">â‚¬ 0.00</td>
                                    </tr>
                                    
                                    <!-- MANODOPERA -->
                                    <tr class="excel-row" id="rowManodoperaFiscale" style="display: none; background: #f0fdf4;">
                                        <td colspan="17" style="text-align: right; font-size: 0.8rem;">
                                            Manodopera (sempre 10%):
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td class="excel-value" id="valManodoperaFiscale" style="color: #059669;">â‚¬ 0.00</td>
                                    </tr>
                                    
                                    <!-- SEPARATORE IMPONIBILI -->
                                    <tr id="rowSepImponibili" style="height: 2px; background: #d1d5db; display: none;">
                                        <td colspan="21"></td>
                                    </tr>
                                    
                                    <!-- IMPONIBILE 10% -->
                                    <tr class="excel-row" id="rowImponibile10" style="display: none; background: #ecfdf5;">
                                        <td colspan="17" style="text-align: right; font-weight: 600; color: #059669;">
                                            IMPONIBILE IVA 10%:
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td class="excel-value" id="valImponibile10" style="font-weight: 600; color: #059669;">â‚¬ 0.00</td>
                                    </tr>
                                    
                                    <!-- IMPONIBILE 22% -->
                                    <tr class="excel-row" id="rowImponibile22" style="display: none; background: #fef2f2;">
                                        <td colspan="17" style="text-align: right; font-weight: 600; color: #dc2626;">
                                            IMPONIBILE IVA 22%:
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td class="excel-value" id="valImponibile22" style="font-weight: 600; color: #dc2626;">â‚¬ 0.00</td>
                                    </tr>
                                    
                                    <!-- IVA 10% -->
                                    <tr class="excel-row" id="rowIVA10" style="display: none;">
                                        <td colspan="17" style="text-align: right; font-weight: 600;">
                                            IVA 10%:
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td class="excel-value" id="valIVA10">â‚¬ 0.00</td>
                                    </tr>
                                    
                                    <!-- IVA 22% -->
                                    <tr class="excel-row" id="rowIVA22" style="display: none;">
                                        <td colspan="17" style="text-align: right; font-weight: 600;">
                                            IVA 22%:
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td class="excel-value" id="valIVA22">â‚¬ 0.00</td>
                                    </tr>
                                    
                                    <!-- IVA SINGOLA (per altri tipi intervento) -->
                                    <tr class="excel-row" id="rowIVA" style="display: none;">
                                        <td colspan="17" style="text-align: right; font-weight: 600;">IVA (<span id="ivaPercent">22</span>%):</td>
                                        <td class="excel-value" id="totaleIVAListino">â‚¬ 0.00</td>
                                        <td></td>
                                        <td class="excel-value" id="totaleIVANetto">â‚¬ 0.00</td>
                                        <td class="excel-value" id="totaleIVACliente">â‚¬ 0.00</td>
                                    </tr>
                                    <!-- TOTALE FINALE -->
                                    <tr class="excel-grand-total-row">
                                        <td colspan="17" style="text-align: right; font-weight: 700; font-size: 1.1rem;">TOTALE PREVENTIVO:</td>
                                        <td class="excel-grand-total-value" id="grandTotalListino">â‚¬ 0.00</td>
                                        <td></td>
                                        <td class="excel-grand-total-value" id="grandTotalNetto" style="color: #059669;">â‚¬ 0.00</td>
                                        <td class="excel-grand-total-value" id="grandTotalCliente" style="color: #1d4ed8; font-size: 1.1rem;">â‚¬ 0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- LEGENDA CALCOLO -->
                    <div class="card">
                        <h3 style="font-size: 1rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem;">
                            ğŸ“‹ Legenda Calcolo Finstral
                        </h3>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; font-size: 0.875rem; line-height: 1.6;">
                            <p><strong>Sistema Finstral EUR 2025/3:</strong></p>
                            <ul style="margin: 0.5rem 0 0 1.5rem;">
                                <li><strong>Perimetro BRM (ml):</strong> 2 Ã— (Larghezza + Altezza) / 1000</li>
                                <li><strong>Base â‚¬:</strong> Prezzo base per tipologia infisso (MOCK: â‚¬ 350-600)</li>
                                <li><strong>Suppl. â‚¬:</strong> Supplemento telaio al metro lineare Ã— Perimetro BRM</li>
                                <li><strong>Unit. â‚¬:</strong> Base + Supplementi</li>
                                <li><strong>Totale â‚¬:</strong> Prezzo Unitario Ã— QuantitÃ </li>
                            </ul>
                            <p style="margin-top: 0.5rem;"><em>Note: Prezzi base MOCK per testing. Integrare listino completo Finstral.</em></p>
                        </div>
                    </div>

                </div>
            </div>

        </div>

    </div>

    <!-- ================================================================================
         JAVASCRIPT
         ================================================================================ -->
    <script>
        // ============================================================================
        // STATO APPLICAZIONE
        // ============================================================================
        let appState = {
            currentBlocco: 'generale',
            rilievoData: null,
            lastImport: null
        };

        // ============================================================================
        // NAVIGAZIONE TRA BLOCCHI
        // ============================================================================
        function switchBlocco(bloccoName) {
            // âœ… FIX: Chiudi modale preventivo se aperta
            chiudiPreventivo();
            
            // Aggiorna stato
            appState.currentBlocco = bloccoName;

            // Nascondi tutti i blocchi
            document.querySelectorAll('.blocco').forEach(b => b.classList.remove('active'));
            // Mostra blocco selezionato
            document.getElementById(`blocco-${bloccoName}`).classList.add('active');

            // Aggiorna pulsanti nav
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            // âœ… CORRETTO: Trova il bottone corretto in base al bloccoName
            const targetButton = document.querySelector(`.nav-btn.blocco-${bloccoName}`);
            if (targetButton) {
                targetButton.classList.add('active');
            }

            console.log(`âœ… Switched to: ${bloccoName}`);
        }

        // ============================================================================
        // FILE SELECTION
        // ============================================================================
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // ============================================================================
        // PROCESSAMENTO FILE JSON
        // ============================================================================
        function handleFile(file) {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ”¥ HANDLE FILE CALLED!');
            console.log(`ğŸ“ Name: ${file.name}`);
            console.log(`ğŸ“Š Size: ${file.size} bytes`);
            console.log(`ğŸ“‹ Type: ${file.type}`);
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

            // Verifica sia JSON
            if (!file.name.endsWith('.json')) {
                console.error('âŒ Not a JSON file');
                showAlert('error', 'âŒ Errore: Seleziona un file JSON valido');
                return;
            }

            console.log('âœ… File is JSON');
            showAlert('info', `ğŸ“‚ Caricamento: ${file.name}...`);

            const reader = new FileReader();

            reader.onload = function(e) {
                console.log('ğŸ“– FileReader onload triggered');
                console.log(`ğŸ“ Content length: ${e.target.result.length} chars`);
                
                try {
                    const jsonData = JSON.parse(e.target.result);
                    console.log('âœ… JSON parsed successfully');
                    console.log('ğŸ“‹ JSON keys:', Object.keys(jsonData));
                    
                    // âš ï¸ FIX: Carica i dati SEMPRE, anche se validazione fallisce
                    // Il wizard si occuperÃ  di completare i dati mancanti
                    console.log('âš™ï¸ Caricamento dati (validazione permissiva)...');
                    processRilievoData(jsonData, file.name);
                    
                    // Valida per warnings (non bloccante)
                    if (!validateRilievoJSON(jsonData)) {
                        console.warn('âš ï¸ Validazione ha trovato problemi (non bloccanti)');
                    }
                } catch (error) {
                    console.error('âŒ Parse error:', error);
                    showAlert('error', `âŒ Errore parsing JSON: ${error.message}`);
                }
            };

            reader.onerror = function() {
                console.error('âŒ FileReader error');
                showAlert('error', 'âŒ Errore lettura file');
            };

            console.log('ğŸ“– Starting FileReader...');
            reader.readAsText(file);
        }

        // ============================================================================
        // CONVERSIONE AUTOMATICA FORMATI JSON
        // ============================================================================
        function convertProjectsFormat(data) {
            console.log('ğŸ”„ AUTO-CONVERSION: Checking JSON format...');
            
            // FORMATO 0: JSON da GitHub (formato app-rilievo-027K-FIXED con project.rilievoInfissi)
            if (data.project && data.project.rilievoInfissi) {
                console.log('â˜ï¸ Detected: GITHUB format (app-rilievo-027K sync)');
                console.log(`   Found ${data.project.rilievoInfissi.length} posizioni in rilievoInfissi`);
                
                // Converti project.rilievoInfissi -> positions per processarlo come singolo progetto
                const githubProject = {
                    id: data.id,
                    name: data.projectName,
                    client: data.customerName || data.projectName,
                    positions: data.project.rilievoInfissi || [],
                    clientData: {
                        telefono: data.customerPhone || '',
                        email: data.customerEmail || '',
                        via: data.customerAddress || ''
                    },
                    createdAt: data.metadata?.createdAt || new Date().toISOString()
                };
                
                console.log(`   Converting GitHub format to standard...`);
                console.log(`   Project: "${githubProject.name}" with ${githubProject.positions.length} positions`);
                
                // Riusa la conversione formato singolo progetto
                return convertProjectsFormat({ projects: [githubProject] });
            }
            
            // FORMATO 1: JSON con "projects" array (formato app-rilievo multi-progetto)
            if (data.projects && Array.isArray(data.projects)) {
                console.log('ğŸ“¦ Detected: PROJECTS format (multi-project export)');
                console.log(`   Found ${data.projects.length} projects in file`);
                
                // Trova il primo progetto con posizioni non vuote
                const project = data.projects.find(p => p.positions && p.positions.length > 0);
                
                if (!project) {
                    console.error('âŒ No projects with positions found!');
                    console.error('   All projects have empty positions arrays');
                    return null;
                }
                
                console.log(`   Using project: "${project.name || project.client}" (${project.positions.length} positions)`);
                
                // Converti nel formato atteso dal dashboard
                const converted = {
                    commessa_id: project.id || 'unknown',
                    versione: data.version || '1.0',
                    data_rilievo: project.createdAt || new Date().toISOString(),
                    nome_ricerca: project.name || project.client,
                    
                    // âœ… FALLBACK: Preserva campi root per compatibilitÃ  v4.17
                    name: project.name || '',
                    client: project.client || '',
                    clientData: project.clientData || {},
                    
                    // CLIENTE: converti da clientData (per retrocompatibilitÃ )
                    cliente: {
                        nome: project.client || 'Cliente Sconosciuto',
                        progetto: project.name || '',
                        piano: project.clientData?.piano || '',
                        indirizzo: project.clientData?.via || '',
                        citta: project.clientData?.citta || '',
                        telefono: project.clientData?.telefono || '',
                        email: project.clientData?.email || ''
                    },
                    
                    // NOTE PROGETTO
                    note_progetto: project.note || '',
                    
                    // CARATTERISTICHE MURO GLOBALI
                    caratteristiche_muro_globali: {
                        telaio_larghezza: project.caratteristicheMuro?.telaioLarghezza || 0,
                        telaio_altezza: project.caratteristicheMuro?.telaioProfondita || 0,
                        falso_esistente: project.caratteristicheMuro?.falsoEsistente || 'no',
                        spessore_falso: project.caratteristicheMuro?.spessoreFalso || 0,
                        guida_tipo: project.caratteristicheMuro?.guidaEsistente === 'si' ? 'guida' : 'no',
                        prof_muro_int: project.caratteristicheMuro?.profMuroInt || 0,
                        prof_muro_est: project.caratteristicheMuro?.profMuroEst || 0,
                        battuta_superiore_tapparella: project.caratteristicheMuro?.battutaSuperioreTapparella || 0
                    },
                    
                    // POSIZIONI: converti da positions
                    posizioni: (project.positions || []).map((pos, index) => {
                        const converted_pos = {
                            id: pos.id || `P${String(index + 1).padStart(3, '0')}`,
                            nome: pos.name || `Posizione ${index + 1}`,
                            piano: pos.piano || '',
                            stanza: pos.ambiente || '',
                            ambiente: pos.ambiente || '',
                            quantita: pos.quantita || 1,
                            
                            // MISURE
                            misure: pos.misure || {},
                            
                            // PRODOTTI (converti da singular a oggetto con quantitÃ )
                            infisso: pos.infisso ? {
                                quantita: pos.infisso.qta || 1,
                                tipo: pos.infisso.tipo || '',
                                apertura: pos.infisso.apertura || '',
                                azienda: pos.infisso.azienda || '',
                                brm: {
                                    // ğŸ”§ COMPATIBILITÃ€: Supporta sia brm.L che BRM_L
                                    L: pos.infisso.brm?.L || pos.infisso.BRM_L || 0,
                                    H: pos.infisso.brm?.H || pos.infisso.BRM_H || 0
                                },
                                finitura_int: pos.infisso.finituraInt || '',
                                finitura_est: pos.infisso.finituraEst || '',
                                colore_int: pos.infisso.coloreInt || '',
                                colore_est: pos.infisso.coloreEst || ''
                            } : null,
                            
                            tapparella: pos.tapparella ? {
                                quantita: parseInt(pos.tapparella.qta) || parseInt(pos.tapparella.quantita) || 1,
                                azienda: pos.tapparella.azienda || '',
                                modello: pos.tapparella.modello || '',
                                tipologia: pos.tapparella.tipologia || '',
                                colore: pos.tapparella.colore || '',
                                colore_tipo: pos.tapparella.colore_tipo || 'tinta_unita',
                                guida: pos.tapparella.guida || '',
                                coloreGuida: pos.tapparella.coloreGuida || 'Argento',
                                manualeMot: pos.tapparella.manualeMot || 'Manuale',
                                motorizzazione: pos.tapparella.motorizzazione || (pos.tapparella.manualeMot === 'Motorizzata' ? 'si' : 'no'),
                                comando: pos.tapparella.comando || '',
                                motoreAzienda: pos.tapparella.motoreAzienda || '',
                                motoreModello: pos.tapparella.motoreModello || '',
                                sostEsistente: pos.tapparella.sostEsistente || '',
                                sostTipo: pos.tapparella.sostTipo || '',
                                accessoriDaSostituire: pos.tapparella.accessoriDaSostituire || {},
                                note: pos.tapparella.note || '',
                                brm: {
                                    L: parseInt(pos.tapparella.BRM_L) || parseInt(pos.tapparella.brm?.L) || 0,
                                    H: parseInt(pos.tapparella.BRM_H) || parseInt(pos.tapparella.brm?.H) || 0
                                },
                                // ğŸ†• v7.82: Mantieni riferimenti originali per compatibilitÃ 
                                BRM_L: parseInt(pos.tapparella.BRM_L) || parseInt(pos.tapparella.brm?.L) || null,
                                BRM_H: parseInt(pos.tapparella.BRM_H) || parseInt(pos.tapparella.brm?.H) || null,
                                qta: pos.tapparella.qta || pos.tapparella.quantita || '1',
                                // ğŸ†• v7.995: Nuovi campi struttura motori
                                serveTapparella: pos.tapparella.serveTapparella !== false,
                                serveMotore: pos.tapparella.serveMotore || false,
                                serveAccessori: pos.tapparella.serveAccessori || false,
                                motoreModelloDefault: pos.tapparella.motoreModelloDefault || '',
                                motori: pos.tapparella.motori || []
                            } : null,
                            
                            cassonetto: pos.cassonetto ? {
                                quantita: pos.cassonetto.qta || 1,
                                tipo: pos.cassonetto.tipo || '',
                                azienda: pos.cassonetto.azienda || '',
                                // ğŸ†• v8.11: Aggiunti tutti i campi cassonetto
                                materialeCass: pos.cassonetto.materialeCass || '',
                                codiceCass: pos.cassonetto.codiceCass || '',
                                gruppoColoreCass: pos.cassonetto.gruppoColoreCass || '',
                                coloreCass: pos.cassonetto.coloreCass || '',
                                codiceIsolamento: pos.cassonetto.codiceIsolamento || '',
                                // Misure rilevate
                                LS: parseInt(pos.cassonetto.LS) || 0,
                                SRSX: parseInt(pos.cassonetto.SRSX) || 0,
                                SRDX: parseInt(pos.cassonetto.SRDX) || 0,
                                ZSX: parseInt(pos.cassonetto.ZSX) || 0,
                                ZSX_tipo: pos.cassonetto.ZSX_tipo || '',
                                ZDX: parseInt(pos.cassonetto.ZDX) || 0,
                                ZDX_tipo: pos.cassonetto.ZDX_tipo || '',
                                HCASS: parseInt(pos.cassonetto.HCASS) || 0,
                                B: parseInt(pos.cassonetto.B) || 0,
                                C: parseInt(pos.cassonetto.C) || 0,
                                BSuperiore: parseInt(pos.cassonetto.BSuperiore) || 0,
                                brm: {
                                    L: parseInt(pos.cassonetto.BRM_L) || 0,
                                    H: parseInt(pos.cassonetto.BRM_H) || parseInt(pos.cassonetto.HCASS) || 0,
                                    C: parseInt(pos.cassonetto.BRM_C) || parseInt(pos.cassonetto.C) || 0,
                                    B: parseInt(pos.cassonetto.BRM_B) || parseInt(pos.cassonetto.B) || 0
                                }
                            } : null,
                            
                            persiana: pos.persiana && pos.persiana.qta ? {
                                quantita: pos.persiana.qta || 1,
                                azienda: pos.persiana.azienda || '',
                                tipo: pos.persiana.tipo || '',
                                modello: pos.persiana.modello || '',
                                colore: pos.persiana.colorePersiana || pos.persiana.colore || '',
                                fissaggio: pos.persiana.fissaggio || '',
                                accessoriPersiana: pos.persiana.accessoriPersiana || null
                            } : null,
                            
                            zanzariera: pos.zanzariera && pos.zanzariera.qta ? {
                                quantita: pos.zanzariera.qta || 1
                            } : null,
                            
                            // ğŸ” v7.98_04: INGRESSO (Porte Blindate/Portoncini)
                            // Supporta entrambi i formati: pos.ingresso.blindata (nuovo) e pos.blindata (legacy)
                            ingresso: (pos.ingresso || pos.blindata || pos.portoncino) ? {
                                tipo: pos.ingresso?.tipo || (pos.blindata ? 'blindata' : (pos.portoncino ? 'portoncino' : null)),
                                // BLINDATA OIKOS
                                blindata: (pos.ingresso?.blindata || pos.blindata) ? (() => {
                                    const bld = pos.ingresso?.blindata || pos.blindata;
                                    return {
                                        LNP_L: bld.LNP_L || 0,
                                        LNP_H: bld.LNP_H || 0,
                                        luceCalcolata: bld.luceCalcolata || '',
                                        azienda: bld.azienda || 'Oikos',
                                        versione: bld.versione || 'E3',
                                        tipoAnta: bld.tipoAnta || 'singola',
                                        sensoApertura: bld.sensoApertura || '',
                                        versoApertura: bld.versoApertura || '',
                                        controtelaio: bld.controtelaio || 'si',
                                        cilindro: bld.cilindro || 'BASIC',
                                        coloreTelaio: bld.coloreTelaio || 'RAL8022',
                                        acustica: bld.acustica || 'serie',
                                        termica: bld.termica || 'serie',
                                        kitAAV: bld.kitAAV || '',
                                        rivestimentoInt: bld.rivestimentoInt || null,
                                        rivestimentoEst: bld.rivestimentoEst || null,
                                        imbotteEst: bld.imbotteEst || null,
                                        imbotteEstAltezza: bld.imbotteEstAltezza || null,
                                        imbotteEstLargh: bld.imbotteEstLargh || null,
                                        imbotteEstEssenza: bld.imbotteEstEssenza || null,
                                        corniciInt: bld.corniciInt || false,
                                        corniciFermaPannello: bld.corniciFermaPannello || false,
                                        vetro: bld.vetro || null,
                                        sopraluce: bld.sopraluce || null,
                                        fiancoluce: bld.fiancoluce || null
                                    };
                                })() : null,
                                // PORTONCINO FINSTRAL
                                portoncino: (pos.ingresso?.portoncino || pos.portoncino) ? (pos.ingresso?.portoncino || pos.portoncino) : null
                            } : null,
                            
                            // ğŸ” v7.98_04: ALIAS DI PRIMO LIVELLO per retrocompatibilitÃ 
                            // Il resto del codice accede a pos.blindata direttamente
                            blindata: (() => {
                                const bld = pos.ingresso?.blindata || pos.blindata;
                                if (!bld) return null;
                                return {
                                    LNP_L: bld.LNP_L || 0,
                                    LNP_H: bld.LNP_H || 0,
                                    luceCalcolata: bld.luceCalcolata || '',
                                    azienda: bld.azienda || 'Oikos',
                                    versione: bld.versione || 'E3',
                                    tipoAnta: bld.tipoAnta || 'singola',
                                    sensoApertura: bld.sensoApertura || '',
                                    versoApertura: bld.versoApertura || '',
                                    controtelaio: bld.controtelaio || 'si',
                                    cilindro: bld.cilindro || 'BASIC',
                                    coloreTelaio: bld.coloreTelaio || 'RAL8022',
                                    acustica: bld.acustica || 'serie',
                                    termica: bld.termica || 'serie',
                                    kitAAV: bld.kitAAV || '',
                                    rivestimentoInt: bld.rivestimentoInt || null,
                                    rivestimentoEst: bld.rivestimentoEst || null,
                                    imbotteEst: bld.imbotteEst || null,
                                    imbotteEstAltezza: bld.imbotteEstAltezza || null,
                                    imbotteEstLargh: bld.imbotteEstLargh || null,
                                    imbotteEstEssenza: bld.imbotteEstEssenza || null,
                                    corniciInt: bld.corniciInt || false,
                                    corniciFermaPannello: bld.corniciFermaPannello || false,
                                    vetro: bld.vetro || null,
                                    sopraluce: bld.sopraluce || null,
                                    fiancoluce: bld.fiancoluce || null
                                };
                            })(),
                            
                            portoncino: (pos.ingresso?.portoncino || pos.portoncino) || null,
                            
                            // NOTE E RILIEVI - TUTTI I PRODOTTI
                            note: pos.note || '',
                            rilievo_preesistente: pos.rilievo || {},
                            rilievo_persiane: pos.rilievoPersiane || {},
                            rilievo_tapparelle: pos.rilievoTapparelle || {},
                            rilievo_zanzariere: pos.rilievoZanzariere || {},
                            rilievo_cassonetti: pos.rilievoCassonetti || {}
                        };
                        
                        return converted_pos;
                    }),
                    
                    // TOTALI
                    totali: {
                        n_posizioni: project.positions?.length || 0,
                        n_infissi: (project.positions || []).filter(p => p.infisso && p.infisso.qta).length,
                        n_tapparelle: (project.positions || []).filter(p => p.tapparella && p.tapparella.qta).length,
                        n_cassonetti: (project.positions || []).filter(p => p.cassonetto && p.cassonetto.qta).length,
                        n_persiane: (project.positions || []).filter(p => p.persiana && p.persiana.qta).length,
                        n_zanzariere: (project.positions || []).filter(p => p.zanzariera && p.zanzariera.qta).length,
                        // ğŸ” v7.98_04: Conta ingressi da entrambi i formati
                        n_ingressi: (project.positions || []).filter(p => p.ingresso || p.blindata || p.portoncino).length,
                        n_blindate: (project.positions || []).filter(p => p.ingresso?.tipo === 'blindata' || p.ingresso?.blindata || p.blindata).length,
                        n_portoncini: (project.positions || []).filter(p => p.ingresso?.tipo === 'portoncino' || p.ingresso?.portoncino || p.portoncino).length
                    }
                };
                
                console.log('âœ… Conversion completed:');
                console.log(`   Cliente: ${converted.cliente.nome}`);
                console.log(`   Posizioni: ${converted.posizioni.length}`);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                return converted;
            }
            
            // FORMATO 2: JSON giÃ  nel formato corretto (con "posizioni")
            if (data.posizioni) {
                console.log('âœ… Detected: STANDARD format (already compatible)');
                
                // ğŸ” v7.98_04: Normalizza posizioni per estrarre blindata da ingresso
                data.posizioni = data.posizioni.map(pos => {
                    // Se ha ingresso.blindata, copia in pos.blindata per retrocompatibilitÃ 
                    if (pos.ingresso?.blindata && !pos.blindata) {
                        console.log(`   ğŸ” Normalizing pos ${pos.id}: ingresso.blindata â†’ blindata`);
                        pos.blindata = pos.ingresso.blindata;
                    }
                    // Se ha ingresso.portoncino, copia in pos.portoncino
                    if (pos.ingresso?.portoncino && !pos.portoncino) {
                        console.log(`   ğŸšª Normalizing pos ${pos.id}: ingresso.portoncino â†’ portoncino`);
                        pos.portoncino = pos.ingresso.portoncino;
                    }
                    return pos;
                });
                
                return data;
            }
            
            // FORMATO 3: JSON singolo progetto diretto (senza wrapper)
            if (data.positions && !data.projects) {
                console.log('ğŸ“¦ Detected: SINGLE PROJECT format');
                console.log('   Converting single project...');
                
                // Converti come se fosse projects[0]
                return convertProjectsFormat({ projects: [data] });
            }
            
            // FORMATO NON RICONOSCIUTO
            console.error('âŒ Unknown JSON format');
            console.error('   Expected: "projects" array OR "posizioni" array OR "positions" array');
            console.error('   Found keys:', Object.keys(data));
            return null;
        }

        // ============================================================================
        // VALIDAZIONE JSON
        // ============================================================================
        function validateRilievoJSON(data) {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ” VALIDATION STARTED');
            console.log('ğŸ“‹ JSON keys found:', Object.keys(data));
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            // STEP 1: Prova conversione automatica
            const convertedData = convertProjectsFormat(data);
            if (!convertedData) {
                showAlert('error', 'âŒ Formato JSON non riconosciuto');
                return false;
            }
            
            // Sostituisci i dati con quelli convertiti
            Object.keys(data).forEach(key => delete data[key]);
            Object.assign(data, convertedData);

            // VALIDAZIONE MINIMA: serve solo "posizioni"
            if (!data.posizioni) {
                console.error('âŒ Missing required field: "posizioni"');
                showAlert('error', 'âŒ Manca il campo "posizioni" nel JSON');
                return false;
            }

            if (!Array.isArray(data.posizioni)) {
                console.error('âŒ Field "posizioni" must be an array');
                showAlert('error', 'âŒ Il campo "posizioni" deve essere un array');
                return false;
            }

            console.log(`âœ… Found ${data.posizioni.length} posizioni`);

            // Cliente opzionale - usa default se manca
            if (!data.cliente) {
                console.warn('âš ï¸ Missing "cliente" - using default');
                data.cliente = { nome: 'Cliente Sconosciuto' };
            } else if (!data.cliente.nome) {
                console.warn('âš ï¸ Missing "cliente.nome" - using default');
                data.cliente.nome = 'Cliente Sconosciuto';
            }

            console.log('âœ… VALIDATION PASSED!');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            return true;
        }

        // ============================================================================
        // PROCESSAMENTO DATI RILIEVO
        // ============================================================================
        function processRilievoData(data, filename) {
            console.log('âš™ï¸ Processing rilievo data...');
            
            // âœ… CONTROLLO SICUREZZA: Garantisci che posizioni sia un array
            if (!data.posizioni || !Array.isArray(data.posizioni)) {
                console.warn('âš ï¸ Dati senza campo posizioni valido, inizializzo array vuoto');
                data.posizioni = [];
            }

            // âš ï¸ FIX CRITICO: Salva SEMPRE in currentData, indipendentemente dalla validazione
            // Questo permette al wizard di analizzare i dati e completarli
            window.currentData = data;
            console.log('âœ… currentData salvato:', window.currentData);
            
            // Salva nello stato
            appState.rilievoData = data;
            
            // Update menu status con nuovi dati
            if (window.CompletionTracker && menuStructure) {
                console.log('ğŸ”„ Updating menu status...');
                CompletionTracker.updateMenuStatus(menuStructure, data);
                // renderAdvancedMenu(); // Sidebar rimossa
                
                // Update badge completamento sui bottoni top nav
                updateTopNavBadges();
            }
            
            appState.lastImport = {
                filename: filename,
                timestamp: new Date().toISOString(),
                posizioni: data.posizioni.length
            };

            // Salva in localStorage
            saveToLocalStorage(data, filename);

            // Mostra successo
            showDataStatus(data);
            showAlert('success', `âœ… Rilievo caricato con successo: ${data.posizioni.length} posizioni`);

            // Mostra contenuto
            document.getElementById('generalePlaceholder').style.display = 'none';
            document.getElementById('generaleContent').style.display = 'block';

            // Genera dashboard Blocco Generale
            generateKPIDashboard(data);
            populateFilters(data);
            generateTable(data);

            // Genera Vista Generale Blocco Ufficio
            renderVistaGeneraleUfficio(data);
            
            // Prepara dati per Vista Posizioni (renderizzata quando attivata)
            // I dati sono giÃ  in currentData, la vista si popolerÃ  al click del submenu

            // âœ… NUOVO: Prepara viste Blocco Posa
            // Le viste si popoleranno quando l'utente passerÃ  al Blocco Posa
            
            // âœ… SISTEMA PREVENTIVAZIONE: Abilita pulsanti
            const btnPreventivo = document.getElementById('btn-preventivo');
            if (btnPreventivo) {
                btnPreventivo.disabled = false;
                btnPreventivo.style.opacity = '1';
                btnPreventivo.style.cursor = 'pointer';
                console.log('âœ… Pulsante Analisi Costi abilitato');
            }
            
            const btnConferma = document.getElementById('btn-conferma-cliente');
            if (btnConferma) {
                btnConferma.disabled = false;
                btnConferma.style.opacity = '1';
                btnConferma.style.cursor = 'pointer';
                console.log('âœ… Pulsante Conferma Cliente abilitato');
            }

            // âœ… MENU DINAMICO v7.27: Aggiorna indicatori completamento
            aggiornaMenuIndicatori();
            
            // âœ… v7.73: Aggiorna config globale quando cambia il progetto
            projectData = data;
            renderConfigGlobale();
            initConfigMenu();
            console.log('âš™ï¸ v7.73: Config globale aggiornata in processRilievoData');

            console.log('âœ… Data processed and stored');
        }

        // ============================================================================
        // âœ… MENU DINAMICO CON INDICATORI v7.27
        // ============================================================================
        
        /**
         * Calcola completamento Blocco GENERALE
         * Campi: cliente, telefono, indirizzo, citta, dataRilievo, tecnico
         */
        function calcolaCompletamentoGenerale(data) {
            if (!data) return 0;
            
            let completati = 0;
            const totali = 6;
            
            if (data.cliente_nome && data.cliente_nome.trim()) completati++;
            if (data.cliente_telefono && data.cliente_telefono.trim()) completati++;
            if (data.cliente_indirizzo && data.cliente_indirizzo.trim()) completati++;
            if (data.cliente_citta && data.cliente_citta.trim()) completati++;
            if (data.data_rilievo && data.data_rilievo.trim()) completati++;
            if (data.tecnico_nome && data.tecnico_nome.trim()) completati++;
            
            return Math.round((completati / totali) * 100);
        }
        
        /**
         * Calcola completamento Blocco UFFICIO
         * Somma di tutti i campi configurazione prodotti
         */
        function calcolaCompletamentoUfficio(data) {
            if (!data || !data.configurazioni) return 0;
            
            let completati = 0;
            let totali = 0;
            const config = data.configurazioni;
            
            // Configurazione Infissi (8 campi)
            if (config.infissi) {
                totali += 8;
                if (config.infissi.azienda) completati++;
                if (config.infissi.telaio) completati++;
                if (config.infissi.materialeTelaio) completati++;
                if (config.infissi.tipoAnta) completati++;
                if (config.infissi.vetro) completati++;
                if (config.infissi.coloreInterno) completati++;
                if (config.infissi.coloreEsterno) completati++;
                if (config.infissi.maniglia) completati++;
            }
            
            // Configurazione Persiane (5 campi)
            if (config.persiane) {
                totali += 5;
                if (config.persiane.azienda) completati++;
                if (config.persiane.tipo) completati++;
                if (config.persiane.colore) completati++;
                if (config.persiane.oscurante) completati++;
                if (config.persiane.automazione) completati++;
            }
            
            // Configurazione Tapparelle (4 campi)
            if (config.tapparelle) {
                totali += 4;
                if (config.tapparelle.azienda) completati++;
                if (config.tapparelle.tipo) completati++;
                if (config.tapparelle.colore) completati++;
                if (config.tapparelle.automazione) completati++;
            }
            
            // Configurazione Zanzariere (4 campi)
            if (config.zanzariere) {
                totali += 4;
                if (config.zanzariere.azienda) completati++;
                if (config.zanzariere.tipo) completati++;
                if (config.zanzariere.colore) completati++;
                if (config.zanzariere.rete) completati++;
            }
            
            // Configurazione Cassonetti (3 campi)
            if (config.cassonetti) {
                totali += 3;
                if (config.cassonetti.azienda) completati++;
                if (config.cassonetti.tipo) completati++;
                if (config.cassonetti.isolamento) completati++;
            }
            
            if (totali === 0) return 0;
            return Math.round((completati / totali) * 100);
        }
        
        /**
         * Calcola completamento Blocco POSA
         * Media completamento posizioni (5 prodotti per posizione)
         */
        function calcolaCompletamentoPosa(data) {
            if (!data || !data.posizioni || data.posizioni.length === 0) {
                return 0;
            }
            
            let totaleCompletamento = 0;
            
            data.posizioni.forEach(pos => {
                let completatiPos = 0;
                const totaliPos = 5; // 5 prodotti
                
                // Infisso
                if (pos.infisso && pos.infisso.quantita > 0) completatiPos++;
                
                // Persiana
                if (pos.persiana && pos.persiana.quantita > 0) completatiPos++;
                
                // Tapparella
                if (pos.tapparella && pos.tapparella.quantita > 0) completatiPos++;
                
                // Zanzariera
                if (pos.zanzariera && pos.zanzariera.quantita > 0) completatiPos++;
                
                // Cassonetto
                if (pos.cassonetto && pos.cassonetto.quantita > 0) completatiPos++;
                
                totaleCompletamento += (completatiPos / totaliPos) * 100;
            });
            
            return Math.round(totaleCompletamento / data.posizioni.length);
        }
        
        /**
         * Calcola completamento Blocco PREVENTIVO
         * 100% se ha almeno 1 posizione con prezzi, altrimenti 0%
         */
        function calcolaCompletamentoPreventivo(data) {
            if (!data || !data.posizioni || data.posizioni.length === 0) {
                return 0;
            }
            
            let hasPrezzi = false;
            
            data.posizioni.forEach(pos => {
                // Verifica se almeno 1 prodotto ha prezzo > 0
                if (pos.infisso && pos.infisso.prezzo > 0) hasPrezzi = true;
                if (pos.persiana && pos.persiana.prezzo > 0) hasPrezzi = true;
                if (pos.tapparella && pos.tapparella.prezzo > 0) hasPrezzi = true;
                if (pos.zanzariera && pos.zanzariera.prezzo > 0) hasPrezzi = true;
                if (pos.cassonetto && pos.cassonetto.prezzo > 0) hasPrezzi = true;
            });
            
            return hasPrezzi ? 100 : 0;
        }
        
        /**
         * Restituisce colore in base a percentuale completamento
         */
        function getColoreIndicatore(percentuale) {
            if (percentuale === 100) return '#4CAF50'; // Verde
            if (percentuale >= 50) return '#FFC107';   // Giallo
            if (percentuale > 0) return '#F44336';     // Rosso
            return '#9E9E9E';                           // Grigio
        }
        
        /**
         * Aggiorna indicatore percentuale su singolo bottone menu
         */
        function aggiornaIndicatoreMenu(blocco, percentuale) {
            const btn = document.querySelector(`.nav-btn.blocco-${blocco}`);
            if (!btn) {
                console.warn(`âš ï¸ Bottone menu non trovato: blocco-${blocco}`);
                return;
            }
            
            // Trova/crea span indicatore
            let indicator = btn.querySelector('.indicator-percentage');
            if (!indicator) {
                indicator = document.createElement('span');
                indicator.className = 'indicator-percentage';
                btn.appendChild(indicator);
            }
            
            // Aggiorna testo e colore
            indicator.textContent = `${percentuale}%`;
            indicator.style.color = getColoreIndicatore(percentuale);
        }
        
        /**
         * Aggiorna TUTTI gli indicatori menu
         */
        function aggiornaMenuIndicatori() {
            const data = window.currentData || appState.rilievoData;
            
            if (!data) {
                console.warn('âš ï¸ Nessun dato disponibile per aggiornare indicatori');
                return;
            }
            
            console.log('ğŸ”„ Aggiornamento indicatori menu...');
            
            // Calcola percentuali
            const percGenerale = calcolaCompletamentoGenerale(data);
            const percUfficio = calcolaCompletamentoUfficio(data);
            const percPreventivo = calcolaCompletamentoPreventivo(data);
            
            console.log(`   Generale: ${percGenerale}%`);
            console.log(`   Ufficio: ${percUfficio}%`);
            console.log(`   Preventivo: ${percPreventivo}%`);
            
            // Aggiorna UI
            aggiornaIndicatoreMenu('generale', percGenerale);
            aggiornaIndicatoreMenu('ufficio', percUfficio);
            aggiornaIndicatoreMenu('preventivo', percPreventivo);
            
            console.log('âœ… Indicatori menu aggiornati');
        }

        /**
         * Calcola percentuale completamento di un blocco (media delle sottosezioni)
         */
        function calcolaCompletamentoBlocco(bloccoKey) {
            if (!menuStructure || !menuStructure[bloccoKey]) {
                return 0;
            }
            
            const items = menuStructure[bloccoKey].items;
            if (!items || items.length === 0) {
                return 0;
            }
            
            // Somma percentuali di tutte le sottosezioni
            let somma = 0;
            let count = 0;
            
            items.forEach(item => {
                if (item.completamento !== undefined) {
                    somma += item.completamento;
                    count++;
                }
            });
            
            // Calcola media e arrotonda
            return count > 0 ? Math.round(somma / count) : 0;
        }

        /**
         * Aggiorna badge completamento sui bottoni top navigation
         */
        function updateTopNavBadges() {
            if (!menuStructure) {
                console.warn('âš ï¸ menuStructure non disponibile per top nav badges');
                return;
            }
            
            // Array dei blocchi da processare
            const blocchi = [
                { key: 'ufficio', selector: '.nav-btn.blocco-ufficio' }
            ];
            
            blocchi.forEach(blocco => {
                // Calcola percentuale completamento blocco
                const percent = calcolaCompletamentoBlocco(blocco.key);
                
                // Trova bottone
                const btn = document.querySelector(blocco.selector);
                if (!btn) {
                    console.warn(`âš ï¸ Bottone non trovato: ${blocco.selector}`);
                    return;
                }
                
                // Rimuovi badge esistente se presente
                const oldBadge = btn.querySelector('.completion-badge');
                if (oldBadge) {
                    oldBadge.remove();
                }
                
                // Crea e aggiungi nuovo badge
                const badge = document.createElement('span');
                badge.className = 'completion-badge';
                badge.textContent = `${percent}%`;
                
                // Aggiungi tooltip
                badge.title = `Completamento ${blocco.key}: ${percent}%`;
                
                btn.appendChild(badge);
                
                console.log(`âœ… Badge aggiunto a ${blocco.key}: ${percent}%`);
            });
        }

        // ============================================================================
        // GENERA KPI DASHBOARD
        // ============================================================================
        function generateKPIDashboard(data) {
            console.log('ğŸ“Š Generating KPI dashboard...');

            const stats = calculateStatistics(data);
            
            const kpiHTML = `
                <div class="kpi-card">
                    <div class="kpi-label">Posizioni Totali</div>
                    <div class="kpi-value">${stats.totalePosizioni}</div>
                    <div class="kpi-subtitle">nel progetto</div>
                </div>

                <div class="kpi-card green">
                    <div class="kpi-label">Infissi</div>
                    <div class="kpi-value">${stats.totaleInfissi}</div>
                    <div class="kpi-subtitle">${stats.percentualeInfissi}% del totale</div>
                </div>

                <div class="kpi-card orange">
                    <div class="kpi-label">Tapparelle</div>
                    <div class="kpi-value">${stats.totaleTapparelle}</div>
                    <div class="kpi-subtitle">${stats.percentualeTapparelle}% del totale</div>
                </div>

                <div class="kpi-card teal">
                    <div class="kpi-label">Altri Prodotti</div>
                    <div class="kpi-value">${stats.totaleAltri}</div>
                    <div class="kpi-subtitle">Persiane, zanzariere, etc.</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-label">Piani</div>
                    <div class="kpi-value">${stats.numeroPiani}</div>
                    <div class="kpi-subtitle">${stats.numeroStanze} stanze totali</div>
                </div>

                <div class="kpi-card green">
                    <div class="kpi-label">Completamento</div>
                    <div class="kpi-value">${stats.completamento}%</div>
                    <div class="kpi-subtitle">Rilievo completo</div>
                </div>
            `;

            document.getElementById('kpiCards').innerHTML = kpiHTML;
            console.log('âœ… KPI dashboard generated');
        }

        // ============================================================================
        // CALCOLA STATISTICHE
        // ============================================================================
        function calculateStatistics(data) {
            const posizioni = data.posizioni || [];
            
            let totaleInfissi = 0;
            let totaleTapparelle = 0;
            let totalePersiane = 0;
            let totaleZanzariere = 0;
            let totaleCassonetti = 0;

            const pianiSet = new Set();
            const stanzeSet = new Set();

            posizioni.forEach(pos => {
                // Conta prodotti
                if (pos.infisso && pos.infisso.quantita > 0) {
                    totaleInfissi += pos.infisso.quantita;
                }
                if (pos.tapparella && pos.tapparella.quantita > 0) {
                    totaleTapparelle += pos.tapparella.quantita;
                }
                if (pos.persiana && pos.persiana.quantita > 0) {
                    totalePersiane += pos.persiana.quantita;
                }
                if (pos.zanzariera && pos.zanzariera.quantita > 0) {
                    totaleZanzariere += pos.zanzariera.quantita;
                }
                if (pos.cassonetto && pos.cassonetto.quantita > 0) {
                    totaleCassonetti += pos.cassonetto.quantita;
                }

                // Raccogli piani e stanze
                if (pos.piano) pianiSet.add(pos.piano);
                if (pos.stanza) stanzeSet.add(pos.stanza);
            });

            const totaleAltri = totalePersiane + totaleZanzariere + totaleCassonetti;
            const totaleProdotti = totaleInfissi + totaleTapparelle + totaleAltri;

            return {
                totalePosizioni: posizioni.length,
                totaleInfissi,
                totaleTapparelle,
                totalePersiane,
                totaleZanzariere,
                totaleCassonetti,
                totaleAltri,
                totaleProdotti,
                percentualeInfissi: totaleProdotti > 0 ? Math.round((totaleInfissi / totaleProdotti) * 100) : 0,
                percentualeTapparelle: totaleProdotti > 0 ? Math.round((totaleTapparelle / totaleProdotti) * 100) : 0,
                numeroPiani: pianiSet.size,
                numeroStanze: stanzeSet.size,
                completamento: 100 // TODO: calcolare in base a campi compilati
            };
        }

        // ============================================================================
        // POPOLA FILTRI
        // ============================================================================
        function populateFilters(data) {
            console.log('ğŸ” Populating filters...');

            const posizioni = data.posizioni || [];
            const pianiSet = new Set();
            const stanzeSet = new Set();
            const prodottiSet = new Set();

            posizioni.forEach(pos => {
                if (pos.piano) pianiSet.add(pos.piano);
                if (pos.stanza) stanzeSet.add(pos.stanza);

                // Raccogli tipi prodotti presenti
                if (pos.infisso && pos.infisso.quantita > 0) prodottiSet.add('Infisso');
                if (pos.tapparella && pos.tapparella.quantita > 0) prodottiSet.add('Tapparella');
                if (pos.persiana && pos.persiana.quantita > 0) prodottiSet.add('Persiana');
                if (pos.zanzariera && pos.zanzariera.quantita > 0) prodottiSet.add('Zanzariera');
                if (pos.cassonetto && pos.cassonetto.quantita > 0) prodottiSet.add('Cassonetto');
            });

            // Popola select piano
            const filterPiano = document.getElementById('filterPiano');
            filterPiano.innerHTML = '<option value="">Tutti i piani</option>';
            Array.from(pianiSet).sort().forEach(piano => {
                filterPiano.innerHTML += `<option value="${piano}">${piano}</option>`;
            });

            // Popola select stanza
            const filterStanza = document.getElementById('filterStanza');
            filterStanza.innerHTML = '<option value="">Tutte le stanze</option>';
            Array.from(stanzeSet).sort().forEach(stanza => {
                filterStanza.innerHTML += `<option value="${stanza}">${stanza}</option>`;
            });

            // Popola select prodotto
            const filterProdotto = document.getElementById('filterProdotto');
            filterProdotto.innerHTML = '<option value="">Tutti i prodotti</option>';
            Array.from(prodottiSet).sort().forEach(prodotto => {
                filterProdotto.innerHTML += `<option value="${prodotto}">${prodotto}</option>`;
            });

            console.log('âœ… Filters populated');
        }

        // ============================================================================
        // GENERA TABELLA
        // ============================================================================
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        function generateTable(data, filteredPositions = null) {
            console.log('ğŸ“‹ Generating table...');

            const posizioni = filteredPositions || data.posizioni || [];

            if (posizioni.length === 0) {
                document.getElementById('tableContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ”</div>
                        <div>Nessuna posizione trovata con i filtri selezionati</div>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('id')">ID</th>
                            <th class="sortable" onclick="sortTable('piano')">Piano</th>
                            <th class="sortable" onclick="sortTable('stanza')">Stanza</th>
                            <th>Ambiente</th>
                            <th>Prodotti</th>
                            <th class="sortable" onclick="sortTable('dimensioni')">Dimensioni</th>
                            <th class="sortable" onclick="sortTable('quantita')">Qta</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            posizioni.forEach(pos => {
                // Raccogli prodotti
                const prodotti = [];
                if (pos.infisso && pos.infisso.quantita > 0) {
                    prodotti.push(`<span class="product-badge infisso">Infisso x${pos.infisso.quantita}</span>`);
                }
                if (pos.tapparella && pos.tapparella.quantita > 0) {
                    prodotti.push(`<span class="product-badge tapparella">Tapparella x${pos.tapparella.quantita}</span>`);
                }
                if (pos.persiana && pos.persiana.quantita > 0) {
                    prodotti.push(`<span class="product-badge persiana">Persiana x${pos.persiana.quantita}</span>`);
                }
                if (pos.zanzariera && pos.zanzariera.quantita > 0) {
                    prodotti.push(`<span class="product-badge zanzariera">Zanzariera x${pos.zanzariera.quantita}</span>`);
                }
                if (pos.cassonetto && pos.cassonetto.quantita > 0) {
                    prodotti.push(`<span class="product-badge cassonetto">Cassonetto x${pos.cassonetto.quantita}</span>`);
                }

                // Dimensioni
                const lvt = pos.misure?.LVT || '-';
                const hvt = pos.misure?.HVT || '-';
                const dimensioni = `${lvt} Ã— ${hvt}`;

                tableHTML += `
                    <tr>
                        <td><strong>${pos.id || '-'}</strong></td>
                        <td>${pos.piano || '-'}</td>
                        <td>${pos.stanza || '-'}</td>
                        <td>${pos.ambiente || pos.nome || '-'}</td>
                        <td>${prodotti.join(' ')}</td>
                        <td>${dimensioni}</td>
                        <td>${pos.quantita || 1}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            document.getElementById('tableContainer').innerHTML = tableHTML;
            console.log(`âœ… Table generated with ${posizioni.length} rows`);
        }

        // ============================================================================
        // ORDINAMENTO TABELLA
        // ============================================================================
        function sortTable(column) {
            if (!appState.rilievoData) return;

            console.log(`ğŸ”„ Sorting by: ${column}`);

            // Toggle direction se stessa colonna
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            // Copia array per non modificare originale
            const sortedPositions = [...(appState.rilievoData.posizioni || [])];

            // Sort
            sortedPositions.sort((a, b) => {
                let valA, valB;

                switch (column) {
                    case 'id':
                        valA = a.id || '';
                        valB = b.id || '';
                        break;
                    case 'piano':
                        valA = a.piano || '';
                        valB = b.piano || '';
                        break;
                    case 'stanza':
                        valA = a.stanza || '';
                        valB = b.stanza || '';
                        break;
                    case 'dimensioni':
                        valA = (a.misure?.LVT || 0) * (a.misure?.HVT || 0);
                        valB = (b.misure?.LVT || 0) * (b.misure?.HVT || 0);
                        break;
                    case 'quantita':
                        valA = a.quantita || 1;
                        valB = b.quantita || 1;
                        break;
                    default:
                        return 0;
                }

                if (typeof valA === 'string') {
                    return currentSortDirection === 'asc' 
                        ? valA.localeCompare(valB)
                        : valB.localeCompare(valA);
                } else {
                    return currentSortDirection === 'asc'
                        ? valA - valB
                        : valB - valA;
                }
            });

            // Rigenera tabella con posizioni ordinate
            generateTable(appState.rilievoData, sortedPositions);

            // Aggiorna UI header
            document.querySelectorAll('.data-table th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            const sortedTh = document.querySelector(`.data-table th[onclick="sortTable('${column}')"]`);
            if (sortedTh) {
                sortedTh.classList.add(`sorted-${currentSortDirection}`);
            }
        }

        // ============================================================================
        // APPLICA FILTRI
        // ============================================================================
        function applyFilters() {
            if (!appState.rilievoData) return;

            console.log('ğŸ” Applying filters...');

            const filterPiano = document.getElementById('filterPiano').value;
            const filterStanza = document.getElementById('filterStanza').value;
            const filterProdotto = document.getElementById('filterProdotto').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();

            let filteredPositions = appState.rilievoData.posizioni || [];

            // Filtro piano
            if (filterPiano) {
                filteredPositions = filteredPositions.filter(pos => pos.piano === filterPiano);
            }

            // Filtro stanza
            if (filterStanza) {
                filteredPositions = filteredPositions.filter(pos => pos.stanza === filterStanza);
            }

            // Filtro prodotto
            if (filterProdotto) {
                filteredPositions = filteredPositions.filter(pos => {
                    const hasProdotto = 
                        (filterProdotto === 'Infisso' && pos.infisso && pos.infisso.quantita > 0) ||
                        (filterProdotto === 'Tapparella' && pos.tapparella && pos.tapparella.quantita > 0) ||
                        (filterProdotto === 'Persiana' && pos.persiana && pos.persiana.quantita > 0) ||
                        (filterProdotto === 'Zanzariera' && pos.zanzariera && pos.zanzariera.quantita > 0) ||
                        (filterProdotto === 'Cassonetto' && pos.cassonetto && pos.cassonetto.quantita > 0);
                    return hasProdotto;
                });
            }

            // Ricerca testuale
            if (searchText) {
                filteredPositions = filteredPositions.filter(pos => {
                    const searchableText = [
                        pos.id,
                        pos.nome,
                        pos.piano,
                        pos.stanza,
                        pos.ambiente
                    ].join(' ').toLowerCase();
                    
                    return searchableText.includes(searchText);
                });
            }

            console.log(`âœ… Filtered: ${filteredPositions.length}/${appState.rilievoData.posizioni.length} posizioni`);
            generateTable(appState.rilievoData, filteredPositions);
        }

        // ============================================================================
        // RESET FILTRI
        // ============================================================================
        function resetFilters() {
            document.getElementById('filterPiano').value = '';
            document.getElementById('filterStanza').value = '';
            document.getElementById('filterProdotto').value = '';
            document.getElementById('searchInput').value = '';
            
            if (appState.rilievoData) {
                generateTable(appState.rilievoData);
            }
            
            showAlert('info', 'ğŸ”„ Filtri resettati');
        }
        function saveToLocalStorage(data, filename) {
            try {
                const storageData = {
                    rilievo: data,
                    metadata: {
                        filename: filename,
                        importDate: new Date().toISOString(),
                        version: '6.1'
                    }
                };

                localStorage.setItem('dashboard_rilievo_current', JSON.stringify(storageData));
                console.log('ğŸ’¾ Data saved to localStorage');
            } catch (error) {
                console.error('âŒ localStorage save error:', error);
                showAlert('warning', 'âš ï¸ Impossibile salvare in localStorage');
            }
        }

        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem('dashboard_rilievo_current');
                if (stored) {
                    const storageData = JSON.parse(stored);
                    console.log('ğŸ“‚ Found data in localStorage');
                    
                    // Ripristina stato
                    appState.rilievoData = storageData.rilievo;
                    appState.lastImport = {
                        filename: storageData.metadata.filename,
                        timestamp: storageData.metadata.importDate,
                        posizioni: storageData.rilievo.posizioni.length
                    };

                    // Mostra dati
                    showDataStatus(storageData.rilievo);
                    document.getElementById('generalePlaceholder').style.display = 'none';
                    document.getElementById('generaleContent').style.display = 'block';

                    // Rigenera dashboard
                    generateKPIDashboard(storageData.rilievo);
                    populateFilters(storageData.rilievo);
                    generateTable(storageData.rilievo);

                    showAlert('info', 'ğŸ“‚ Rilievo precedente ripristinato da memoria');
                }
            } catch (error) {
                console.error('âŒ localStorage load error:', error);
            }
        }

        // ============================================================================
        // EXPORT CSV/EXCEL
        // ============================================================================
        function exportToCSV() {
            exportToExcel(); // Redirect to Excel export
        }

        /**
         * ğŸ“Š EXPORT EXCEL COMPLETO
         * Genera file Excel con fogli multipli: Generale, Posizioni, Infissi, Persiane, Tapparelle, Zanzariere, Cassonetti
         */
        function exportToExcel() {
            if (!appState.rilievoData) {
                showAlert('warning', 'âš ï¸ Nessun dato da esportare');
                return;
            }

            console.log('ğŸ“Š Exporting to Excel with SheetJS...');

            const posizioni = appState.rilievoData.posizioni || [];
            const project = appState.rilievoData.project || {};
            
            // Crea workbook
            const wb = XLSX.utils.book_new();
            
            // ========== FOGLIO 1: GENERALE ==========
            const wsGenerale = XLSX.utils.aoa_to_sheet([
                ['PROGETTO', project.id || 'N/D'],
                ['Cliente', project.cliente?.nome || 'N/D'],
                ['Indirizzo', project.cliente?.indirizzo || 'N/D'],
                ['Telefono', project.cliente?.telefono || 'N/D'],
                ['Data Rilievo', project.dataRilievo || 'N/D'],
                [''],
                ['TOTALI PROGETTO'],
                ['Totale Posizioni', posizioni.length],
                ['Totale Infissi', posizioni.filter(p => p.infisso && p.infisso.quantita > 0).reduce((sum, p) => sum + (parseInt(p.infisso.quantita) || 0), 0)],
                ['Totale Persiane', posizioni.filter(p => p.persiana && p.persiana.quantita > 0).reduce((sum, p) => sum + (parseInt(p.persiana.quantita) || 0), 0)],
                ['Totale Tapparelle', posizioni.filter(p => p.tapparella && p.tapparella.quantita > 0).reduce((sum, p) => sum + (parseInt(p.tapparella.quantita) || 0), 0)],
                ['Totale Zanzariere', posizioni.filter(p => p.zanzariera && p.zanzariera.quantita > 0).reduce((sum, p) => sum + (parseInt(p.zanzariera.quantita) || 0), 0)],
                ['Totale Cassonetti', posizioni.filter(p => p.cassonetto && p.cassonetto.quantita > 0).reduce((sum, p) => sum + (parseInt(p.cassonetto.quantita) || 0), 0)]
            ]);
            XLSX.utils.book_append_sheet(wb, wsGenerale, "Generale");
            
            // ========== FOGLIO 2: POSIZIONI ==========
            const posizioniData = [
                ['ID', 'Piano', 'Stanza', 'Ambiente', 'QuantitÃ ', 'L (mm)', 'H (mm)', 'Infisso', 'Persiana', 'Tapparella', 'Zanzariera', 'Cassonetto']
            ];
            posizioni.forEach(pos => {
                posizioniData.push([
                    pos.id || '',
                    pos.piano || '',
                    pos.stanza || '',
                    pos.ambiente || pos.nome || '',
                    pos.quantita || 1,
                    pos.L || '',
                    pos.H || '',
                    (pos.infisso && pos.infisso.quantita > 0) ? 'SI' : 'NO',
                    (pos.persiana && pos.persiana.quantita > 0) ? 'SI' : 'NO',
                    (pos.tapparella && pos.tapparella.quantita > 0) ? 'SI' : 'NO',
                    (pos.zanzariera && pos.zanzariera.quantita > 0) ? 'SI' : 'NO',
                    (pos.cassonetto && pos.cassonetto.quantita > 0) ? 'SI' : 'NO'
                ]);
            });
            const wsPosizioni = XLSX.utils.aoa_to_sheet(posizioniData);
            XLSX.utils.book_append_sheet(wb, wsPosizioni, "Posizioni");
            
            // ========== FOGLIO 3: INFISSI ==========
            const infissiData = [
                ['Posizione', 'Ambiente', 'QtÃ ', 'LÃ—H (mm)', 'Azienda', 'Telaio', 'Materiale', 'Tipo Anta', 'Vetro', 'Colore Int', 'Colore Est']
            ];
            posizioni.forEach(pos => {
                if (pos.infisso && pos.infisso.quantita > 0) {
                    const inf = pos.infisso;
                    infissiData.push([
                        pos.id || '',
                        pos.ambiente || pos.nome || '',
                        inf.quantita || 1,
                        `${pos.L || inf.brm?.L || 'N/D'}Ã—${pos.H || inf.brm?.H || 'N/D'}`,
                        inf.azienda || 'N/D',
                        inf.telaio || 'N/D',
                        inf.materiale_telaio || 'N/D',
                        inf.tipo_anta || 'N/D',
                        inf.vetro || 'N/D',
                        inf.colore_int || 'N/D',
                        inf.colore_est || 'N/D'
                    ]);
                }
            });
            const wsInfissi = XLSX.utils.aoa_to_sheet(infissiData);
            XLSX.utils.book_append_sheet(wb, wsInfissi, "Infissi");
            
            // ========== FOGLIO 4: PERSIANE ==========
            const persianeData = [
                ['Posizione', 'Ambiente', 'QtÃ ', 'LÃ—H (mm)', 'Azienda', 'Modello', 'Tipologia', 'Colore', 'Note']
            ];
            posizioni.forEach(pos => {
                if (pos.persiana && pos.persiana.quantita > 0) {
                    const pers = pos.persiana;
                    persianeData.push([
                        pos.id || '',
                        pos.ambiente || pos.nome || '',
                        pers.quantita || 1,
                        `${pers.brm?.L || pos.L || 'N/D'}Ã—${pers.brm?.H || pos.H || 'N/D'}`,
                        pers.azienda || 'N/D',
                        pers.modello || 'N/D',
                        pers.tipologia || 'N/D',
                        pers.colore || 'N/D',
                        pers.note || ''
                    ]);
                }
            });
            const wsPersiane = XLSX.utils.aoa_to_sheet(persianeData);
            XLSX.utils.book_append_sheet(wb, wsPersiane, "Persiane");
            
            // ========== FOGLIO 5: TAPPARELLE ==========
            const tapparelleData = [
                ['Posizione', 'Ambiente', 'QtÃ ', 'LÃ—H Foro (mm)', 'Azienda', 'Tipo', 'Colore', 'Automazione', 'Prezzo Unit.', 'Prezzo Tot.']
            ];
            posizioni.forEach(pos => {
                if (pos.tapparella && pos.tapparella.quantita > 0) {
                    const tapp = pos.tapparella;
                    // Calcola prezzo se Plasticino
                    let prezzoUnit = 'N/D';
                    let prezzoTot = 'N/D';
                    const aziendaLower = (tapp.azienda || '').toLowerCase();
                    if (aziendaLower.includes('plasticino') || aziendaLower.includes('solar') || aziendaLower.includes('estella')) {
                        const L_cm = parseInt(tapp.brm?.L) || parseInt(tapp.larghezza) || parseInt(pos.L) || 0;
                        const H_cm = parseInt(tapp.brm?.H) || parseInt(tapp.altezza) || parseInt(pos.H) || 0;
                        if (L_cm > 0 && H_cm > 0 && typeof calcolaPrezzoPLASTICINO !== 'undefined') {
                            const calc = calcolaPrezzoPLASTICINO(L_cm, H_cm);
                            prezzoUnit = 'â‚¬' + calc.totale.toFixed(2);
                            prezzoTot = 'â‚¬' + (calc.totale * (tapp.quantita || 1)).toFixed(2);
                        }
                    }
                    tapparelleData.push([
                        pos.id || '',
                        pos.ambiente || pos.nome || '',
                        tapp.quantita || 1,
                        `${tapp.brm?.L || tapp.larghezza || pos.L || 'N/D'}Ã—${tapp.brm?.H || tapp.altezza || pos.H || 'N/D'}`,
                        tapp.azienda || 'N/D',
                        tapp.tipo || 'N/D',
                        tapp.colore || 'N/D',
                        tapp.automazione || 'Manuale',
                        prezzoUnit,
                        prezzoTot
                    ]);
                }
            });
            const wsTapparelle = XLSX.utils.aoa_to_sheet(tapparelleData);
            XLSX.utils.book_append_sheet(wb, wsTapparelle, "Tapparelle");
            
            // ========== FOGLIO 6: ZANZARIERE ==========
            const zanzariereData = [
                ['Posizione', 'Ambiente', 'QtÃ ', 'LÃ—H (mm)', 'Azienda', 'Modello', 'Colore', 'Note']
            ];
            posizioni.forEach(pos => {
                if (pos.zanzariera && pos.zanzariera.quantita > 0) {
                    const zanz = pos.zanzariera;
                    zanzariereData.push([
                        pos.id || '',
                        pos.ambiente || pos.nome || '',
                        zanz.quantita || 1,
                        `${zanz.brm?.L || pos.L || 'N/D'}Ã—${zanz.brm?.H || pos.H || 'N/D'}`,
                        zanz.azienda || 'N/D',
                        zanz.modello || 'N/D',
                        zanz.colore || 'N/D',
                        zanz.note || ''
                    ]);
                }
            });
            const wsZanzariere = XLSX.utils.aoa_to_sheet(zanzariereData);
            XLSX.utils.book_append_sheet(wb, wsZanzariere, "Zanzariere");
            
            // ========== FOGLIO 7: CASSONETTI ==========
            const cassonettiData = [
                ['Posizione', 'Ambiente', 'QtÃ ', 'LÃ—H (mm)', 'Azienda', 'Tipo', 'Note']
            ];
            posizioni.forEach(pos => {
                if (pos.cassonetto && pos.cassonetto.quantita > 0) {
                    const cass = pos.cassonetto;
                    cassonettiData.push([
                        pos.id || '',
                        pos.ambiente || pos.nome || '',
                        cass.quantita || 1,
                        `${cass.brm?.L || pos.L || 'N/D'}Ã—${cass.brm?.H || pos.H || 'N/D'}`,
                        cass.azienda || 'N/D',
                        cass.tipo || 'N/D',
                        cass.note || ''
                    ]);
                }
            });
            const wsCassonetti = XLSX.utils.aoa_to_sheet(cassonettiData);
            XLSX.utils.book_append_sheet(wb, wsCassonetti, "Cassonetti");
            
            // ========== GENERA FILE EXCEL ==========
            const filename = `rilievo-${project.id || Date.now()}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showAlert('success', 'âœ… Excel esportato con successo');
            console.log('âœ… Excel exported:', filename);
        }

        // ============================================================================
        // EXPORT JSON
        // ============================================================================
        function exportToJSON() {
            if (!appState.rilievoData) {
                showAlert('warning', 'âš ï¸ Nessun dato da esportare');
                return;
            }

            console.log('ğŸ’¾ Exporting to JSON...');

            const dataStr = JSON.stringify(appState.rilievoData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const filename = appState.lastImport?.filename || `rilievo-${Date.now()}.json`;
            link.download = `backup-${filename}`;
            link.click();
            
            URL.revokeObjectURL(url);
            showAlert('success', 'âœ… JSON esportato con successo');
            console.log('âœ… JSON exported');
        }

        // ============================================================================
        // UI: MOSTRA STATO DATI
        // ============================================================================
        function showDataStatus(data) {
            const statusDiv = document.getElementById('dataStatus');
            
            // Estrai informazioni in modo sicuro da formati diversi
            const numPosizioni = data.posizioni?.length || 0;
            const nomeCliente = data.cliente?.nome || 
                               data.rilievo?.cliente?.nome || 
                               data.customerName || 
                               'N/D';
            const nomeProgetto = data.cliente?.progetto || 
                                data.rilievo?.meta?.id_rilievo || 
                                data.projectName || 
                                'Progetto';
            const dataRilievo = data.data_rilievo || 
                               data.rilievo?.meta?.data_creazione || 
                               data.metadata?.created || 
                               Date.now();
            
            const html = `
                <div class="status-badge success">
                    âœ… ${numPosizioni} Posizioni
                </div>
                <div class="status-badge info">
                    ğŸ‘¤ ${nomeCliente}
                </div>
                <div class="status-badge info">
                    ğŸ“‹ ${nomeProgetto}
                </div>
                <div class="status-badge info">
                    ğŸ“… ${new Date(dataRilievo).toLocaleDateString('it-IT')}
                </div>
            `;

            statusDiv.innerHTML = html;
            statusDiv.style.display = 'flex';
        }

        // ============================================================================
        // UI: ALERT/NOTIFICHE
        // ============================================================================
        function showAlert(type, message) {
            // Rimuovi alert precedenti
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());

            // Crea nuovo alert
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;

            // Inserisci dopo header
            const container = document.querySelector('.container');
            container.insertBefore(alert, container.firstChild);

            // Rimuovi dopo 5 secondi
            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }

        // ============================================================================
        // ============================================================================
        // INIZIALIZZAZIONE
        // ============================================================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log(`ğŸš€ Dashboard Rilievi v${DASHBOARD_VERSION} (${DASHBOARD_DATE})`);
            console.log('ğŸ“Š Initializing...');

            // Carica dati se presenti in localStorage
            loadFromLocalStorage();

            console.log('âœ… App ready');
        });

        // ============================================================================
        // RESET DATI
        // ============================================================================
        function resetData() {
            if (confirm('âš ï¸ Cancellare tutti i dati caricati?')) {
                localStorage.removeItem('dashboard_rilievo_current');
                appState.rilievoData = null;
                appState.lastImport = null;
                
                document.getElementById('dataStatus').style.display = 'none';
                document.getElementById('generalePlaceholder').style.display = 'block';
                document.getElementById('generaleContent').style.display = 'none';
                
                // âœ… v7.20: Uso classList invece di style.display per ufficio
                document.getElementById('ufficioPlaceholder').classList.remove('content-hidden');
                document.getElementById('ufficioContent').classList.add('content-hidden');
                
                // Reset filtri
                document.getElementById('filterPiano').value = '';
                document.getElementById('filterStanza').value = '';
                document.getElementById('filterProdotto').value = '';
                document.getElementById('searchInput').value = '';
                
                showAlert('info', 'ğŸ”„ Dati cancellati');
                console.log('ğŸ”„ Data reset');
            }
        }

        // ============================================================================
        // BLOCCO UFFICIO - NAVIGAZIONE VISTE
        // ============================================================================
        function switchVistaUfficio(vistaName, evt) {
            console.log(`ğŸ”„ Switching to vista: ${vistaName}`);
            
            // ğŸ†• v7.82 FIX: Usa window.currentData e window.projectData per sicurezza
            const currentData = window.currentData;
            const projectData = window.projectData;
            
            // ğŸ”„ v8.04: Applica/rimuovi fullwidth per preventivo
            const mainContainer = document.querySelector('.blocco.active');
            if (mainContainer) {
                if (vistaName === 'preventivo') {
                    mainContainer.classList.add('preventivo-fullwidth');
                    document.body.style.overflow = 'auto'; // Permetti scroll
                } else {
                    mainContainer.classList.remove('preventivo-fullwidth');
                }
            }
            
            // âœ… v7.20 FIX: RESET tutte le viste prima di cambiare
            // Ripristina stato iniziale (placeholder visibile, content nascosto)
            const allContentIds = ['ufficioContent', 'posizioniContent', 'aziendeContent', 'preventivoContent'];
            const allPlaceholderIds = ['ufficioPlaceholder', 'posizioniPlaceholder', 'aziendePlaceholder', 'preventivoPlaceholder'];
            
            allContentIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('content-hidden');
            });
            
            allPlaceholderIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('content-hidden');
            });
            
            // âœ… v7.21: Pulisci container totali quando non in Vista Generale
            if (vistaName !== 'generale') {
                const totaliContainer = document.getElementById('totaliCommessaContainer');
                if (totaliContainer) {
                    totaliContainer.innerHTML = '';
                    console.log('ğŸ§¹ Totali Commessa rimossi (non in Vista Generale)');
                }
            }
            
            // Nascondi tutte le viste
            document.querySelectorAll('.vista-ufficio').forEach(v => v.classList.remove('active'));
            // Mostra vista selezionata
            document.getElementById(`vista-${vistaName}-ufficio`).classList.add('active');
            
            // Aggiorna pulsanti submenu
            document.querySelectorAll('.submenu-btn').forEach(btn => btn.classList.remove('active'));
            
            // Trova e attiva il pulsante corretto
            if (evt && evt.target) {
                evt.target.closest('.submenu-btn').classList.add('active');
            } else {
                // Fallback: cerca pulsante per nome vista
                document.querySelectorAll('.submenu-btn').forEach(btn => {
                    if (btn.onclick && btn.onclick.toString().includes(`'${vistaName}'`)) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // Se vista posizioni, renderizza se ci sono dati
            if (vistaName === 'posizioni' && currentData && currentData.posizioni) {
                console.log(`ğŸ“‹ Rendering Vista Posizioni con ${currentData.posizioni.length} posizioni...`);
                renderVistaPosizioniUfficio(currentData);
            } else if (vistaName === 'posizioni') {
                console.warn('âš ï¸ Vista Posizioni richiesta ma nessun dato disponibile');
            }
            
            // Se vista aziende, renderizza se ci sono dati
            if (vistaName === 'aziende' && currentData && currentData.posizioni) {
                console.log(`ğŸ¢ Rendering Vista Aziende con ${currentData.posizioni.length} posizioni...`);
                renderVistaAziende(currentData);
            } else if (vistaName === 'aziende') {
                console.warn('âš ï¸ Vista Aziende richiesta ma nessun dato disponibile');
            }
            
            // âœ… v7.22: Se vista preventivo, renderizza se ci sono dati
            if (vistaName === 'preventivo' && currentData && currentData.posizioni) {
                console.log(`ğŸ’° Rendering Vista Preventivo con ${currentData.posizioni.length} posizioni...`);
                renderVistaPreventivo(currentData);
            } else if (vistaName === 'preventivo') {
                console.warn('âš ï¸ Vista Preventivo richiesta ma nessun dato disponibile');
            }
            
            // âœ… v7.73: FIX - Se vista generale, ri-renderizza contenuto
            if (vistaName === 'generale' && currentData && currentData.posizioni) {
                console.log(`ğŸ“Š Rendering Vista Generale con ${currentData.posizioni.length} posizioni...`);
                renderVistaGeneraleUfficio(currentData);
            } else if (vistaName === 'generale' && projectData && projectData.posizioni) {
                // Fallback a projectData se currentData non disponibile
                console.log(`ğŸ“Š Rendering Vista Generale da projectData con ${projectData.posizioni.length} posizioni...`);
                renderVistaGeneraleUfficio(projectData);
            } else if (vistaName === 'generale') {
                console.warn('âš ï¸ Vista Generale richiesta ma nessun dato disponibile');
            }
            
            console.log(`âœ… Vista ${vistaName} attivata`);
        }

        // ============================================================================
        // BLOCCO UFFICIO - RENDER VISTA GENERALE
        // ============================================================================
        function renderVistaGeneraleUfficio(data) {
            console.log('ğŸ“Š Rendering Vista Generale Ufficio...');
            
            // Nascondi placeholder, mostra contenuto (usando classList invece di style.display)
            document.getElementById('ufficioPlaceholder').classList.add('content-hidden');
            document.getElementById('ufficioContent').classList.remove('content-hidden');
            
            // âœ… v7.21: CREA sezione totali dinamicamente
            createTotaliCommessaSection();
            
            // Popola tutte le sezioni
            renderInfoCliente(data);
            // renderCaratteristicheMuro(data); // âŒ ELIMINATO
            // âŒ RIMOSSO: renderConfigurazioneInfissi(data) - Spostato in Vista Aziende
            renderTotaliCommessa(data);
            renderRiepilogoEconomico(data); // âœ… NUOVO: Riepilogo economico con totale
            
            // âœ… v7.997: Inizializza Config Prodotti Globale in Ufficio
            initConfigMenuUfficio();
            
            console.log('âœ… Vista Generale Ufficio rendered');
        }

        // ============================================================================
        // SEZIONE A: INFO CLIENTE
        // ============================================================================
        function renderInfoCliente(data) {
            const cliente = data.cliente || {};
            const clientData = data.clientData || {};
            
            // âœ… FALLBACK INTELLIGENTE per compatibilitÃ  con formato app v4.17
            // Nome Cliente: usa client (root) se clientData.nome vuoto
            const nomeCliente = clientData.nome || cliente.nome || data.client || 'N/D';
            
            // Nome Progetto: usa name (root) come fallback principale
            const nomeProgetto = clientData.progetto || cliente.progetto || data.name || data.nome_ricerca || 'N/D';
            
            // Piano: usa clientData.piano o cliente.piano
            const piano = clientData.piano || cliente.piano || 'N/D';
            
            // Indirizzo: costruisce intelligentemente da indirizzo + cittÃ 
            let indirizzo = 'N/D';
            const via = clientData.indirizzo || cliente.indirizzo || cliente.via || '';
            const citta = clientData.citta || cliente.citta || '';
            
            if (via && citta) {
                indirizzo = `${via}, ${citta}`;
            } else if (via) {
                indirizzo = via;
            } else if (citta) {
                indirizzo = citta;
            }
            
            // Telefono e Email
            const telefono = clientData.telefono || cliente.telefono || 'N/D';
            const email = clientData.email || cliente.email || 'N/D';
            
            const html = `
                <div class="info-item">
                    <div class="info-label">Nome Cliente</div>
                    <div class="info-value-large">${nomeCliente}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Nome Progetto</div>
                    <div class="info-value">${nomeProgetto}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Piano</div>
                    <div class="info-value">${piano}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Indirizzo</div>
                    <div class="info-value">${indirizzo}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Telefono</div>
                    <div class="info-value">${telefono}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value">${email}</div>
                </div>
            `;
            
            document.getElementById('infoCliente').innerHTML = html;
            
            // Note progetto (se presenti)
            if (data.note_progetto || data.notes) {
                const noteHtml = `
                    <div class="note-box">
                        <div class="note-box-title">ğŸ“ Note Progetto</div>
                        <div class="note-box-content">${data.note_progetto || data.notes}</div>
                    </div>
                `;
                document.getElementById('noteProgetto').innerHTML = noteHtml;
            } else {
                document.getElementById('noteProgetto').innerHTML = '';
            }
        }

        // ============================================================================
        // SEZIONE B: CARATTERISTICHE MURO GLOBALI
        // ============================================================================

        // ============================================================================
        // SEZIONE CONFIG INFISSI - CONFIGURAZIONE GLOBALE PRODOTTI
        // ============================================================================
        function renderConfigurazioneInfissi(data) {
            const config = data.configInfissi || {};
            
            // Verifica se ci sono dati
            const hasConfig = Object.keys(config).length > 0;
            
            if (!hasConfig) {
                document.getElementById('configInfissiContent').innerHTML = `
                    <p style="color: #6b7280; font-style: italic; text-align: center; padding: 2rem;">
                        Nessuna configurazione infissi presente
                    </p>
                `;
                return;
            }
            
            const configItems = [
                { label: 'Azienda', value: config.azienda, icon: 'ğŸ¢' },
                { label: 'Tipo Anta', value: config.tipoAnta, icon: 'ğŸšª' },
                { label: 'Telaio', value: config.telaio, icon: 'â¬œ' },
                { label: 'Finitura Interna', value: config.finituraInt, icon: 'ğŸ¨' },
                { label: 'Finitura Esterna', value: config.finituraEst, icon: 'ğŸ¨' },
                { label: 'Colore Interno', value: config.coloreInt, icon: 'ğŸŒˆ' },
                { label: 'Colore Esterno', value: config.coloreEst, icon: 'ğŸŒˆ' },
                { label: 'Allarme', value: config.allarme, icon: 'ğŸ””' },
                { label: 'Vetro', value: config.vetro, icon: 'ğŸ’' },
                { label: 'Maniglia', value: config.maniglia, icon: 'ğŸ”§' },
                { label: 'Colore Maniglia', value: config.coloreManiglia, icon: 'ğŸ¨' }
            ].filter(item => item.value); // Mostra solo campi compilati
            
            const html = `
                <div class="wall-chars-grid">
                    ${configItems.map(item => `
                        <div class="wall-char-item">
                            <div class="wall-char-label">${item.icon} ${item.label}</div>
                            <div class="wall-char-value">${item.value}</div>
                        </div>
                    `).join('')}
                </div>
                ${configItems.length === 0 ? `
                    <p style="color: #6b7280; font-style: italic; text-align: center; padding: 1rem;">
                        Configurazione non completa
                    </p>
                ` : ''}
            `;
            
            document.getElementById('configInfissiContent').innerHTML = html;
        }

        // ============================================================================
        // CREAZIONE DINAMICA SEZIONE TOTALI COMMESSA - v7.21
        // ============================================================================
        function createTotaliCommessaSection() {
            const container = document.getElementById('totaliCommessaContainer');
            if (!container) return;
            
            // Crea HTML completo
            container.innerHTML = `
                <div class="card-ufficio">
                    <h2 class="card-ufficio-title">
                        <span class="card-ufficio-icon">ğŸ“¦</span>
                        Totali Commessa
                    </h2>
                    
                    <h3 style="font-size: 1rem; font-weight: 600; color: #6b7280; margin-bottom: 1rem;">
                        Riepilogo QuantitÃ 
                    </h3>
                    <div id="totaliQuantita" class="totali-grid">
                        <!-- Popolato dinamicamente -->
                    </div>

                    <h3 style="font-size: 1rem; font-weight: 600; color: #6b7280; margin-bottom: 1rem; margin-top: 2rem;">
                        Riepilogo Economico
                    </h3>
                    <div id="riepilogoEconomico" class="economico-list">
                        <!-- Popolato dinamicamente -->
                    </div>
                </div>
            `;
            
            console.log('âœ… Sezione Totali Commessa creata dinamicamente');
        }

        // ============================================================================
        // SEZIONE C: TOTALI COMMESSA
        // ============================================================================
        function renderTotaliCommessa(data) {
            const stats = calculateTotaliCommessa(data);
            
            // v7.998: Genera HTML dinamico, nascondendo voci con 0
            let html = `
                <div class="totale-item">
                    <div class="totale-numero">${stats.n_posizioni}</div>
                    <div class="totale-label">Posizioni</div>
                </div>
                <div class="totale-item">
                    <div class="totale-numero">${stats.n_infissi}</div>
                    <div class="totale-label">Infissi</div>
                </div>
            `;
            
            // Tapparelle (solo se > 0)
            if (stats.n_tapparelle > 0) {
                html += `
                <div class="totale-item">
                    <div class="totale-numero">${stats.n_tapparelle}</div>
                    <div class="totale-label">Tapparelle</div>
                </div>
                `;
            }
            
            // Motori (solo se > 0) - v7.998
            if (stats.n_motori > 0) {
                html += `
                <div class="totale-item" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #f59e0b;">
                    <div class="totale-numero" style="color: #b45309;">${stats.n_motori}</div>
                    <div class="totale-label" style="color: #92400e;">Motori</div>
                </div>
                `;
            }
            
            html += `
                <div class="totale-item">
                    <div class="totale-numero">${stats.n_persiane}</div>
                    <div class="totale-label">Persiane</div>
                </div>
                <div class="totale-item">
                    <div class="totale-numero">${stats.n_zanzariere}</div>
                    <div class="totale-label">Zanzariere</div>
                </div>
                <div class="totale-item">
                    <div class="totale-numero">${stats.n_cassonetti}</div>
                    <div class="totale-label">Cassonetti</div>
                </div>
            `;
            
            document.getElementById('totaliQuantita').innerHTML = html;
        }

        // Helper: calcola totali commessa
        function calculateTotaliCommessa(data) {
            const posizioni = data.posizioni || [];
            
            let n_infissi = 0;
            let n_tapparelle = 0;
            let n_motori = 0;  // v7.998: Conteggio motori separato
            let n_persiane = 0;
            let n_zanzariere = 0;
            let n_cassonetti = 0;
            
            posizioni.forEach(pos => {
                // Infissi
                if (pos.infisso && pos.infisso.quantita > 0) {
                    n_infissi += parseInt(pos.infisso.quantita) || 0;
                }
                
                // Tapparelle vs Motori - v7.998
                if (pos.tapparella) {
                    const qta = parseInt(pos.tapparella.quantita || pos.tapparella.qta) || 0;
                    if (qta > 0) {
                        if (pos.tapparella.serveTapparella === true) {
                            // Tapparella vera (con telo)
                            n_tapparelle += qta;
                        } else if (pos.tapparella.serveMotore === true) {
                            // Solo motore
                            n_motori += qta;
                        }
                    }
                }
                
                // Persiane
                if (pos.persiana && pos.persiana.quantita > 0) {
                    n_persiane += parseInt(pos.persiana.quantita) || 0;
                }
                
                // Zanzariere
                if (pos.zanzariera && pos.zanzariera.quantita > 0) {
                    n_zanzariere += parseInt(pos.zanzariera.quantita) || 0;
                }
                
                // Cassonetti
                if (pos.cassonetto && pos.cassonetto.quantita > 0) {
                    n_cassonetti += parseInt(pos.cassonetto.quantita) || 0;
                }
            });
            
            return {
                n_posizioni: posizioni.length,
                n_infissi,
                n_tapparelle,
                n_motori,  // v7.998
                n_persiane,
                n_zanzariere,
                n_cassonetti
            };
        }

        // ============================================================================
        // NUOVO: RIEPILOGO ECONOMICO CON TOTALE
        // ============================================================================
        function renderRiepilogoEconomico(data) {
            console.log('ğŸ’° Calcolo riepilogo economico...');
            
            try {
                // Calcola preventivo usando PreventivoCalculator
                const preventivo = window.PreventivoCalculator.calcolaPreventivo(data);
                
                if (!preventivo.successo || !preventivo.voci) {
                    console.warn('âš ï¸ Preventivo non calcolabile, mostro placeholder');
                    document.getElementById('riepilogoEconomico').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #6b7280; font-style: italic;">
                            Configura i prodotti per calcolare i costi
                        </div>
                    `;
                    return;
                }
                
                // Raggruppa totali per categoria
                const totali = {
                    infissi: 0,
                    persiane: 0,
                    tapparelle: 0,
                    zanzariere: 0,
                    cassonetti: 0
                };
                
                preventivo.voci.forEach(voce => {
                    const importo = parseFloat(voce.importo) || 0;
                    const tipo = voce.tipo.toLowerCase();
                    
                    if (tipo.includes('infisso')) {
                        totali.infissi += importo;
                    } else if (tipo.includes('persiana')) {
                        totali.persiane += importo;
                    } else if (tipo.includes('tapparella')) {
                        totali.tapparelle += importo;
                    } else if (tipo.includes('zanzariera')) {
                        totali.zanzariere += importo;
                    } else if (tipo.includes('cassonetto')) {
                        totali.cassonetti += importo;
                    }
                });
                
                const totaleGenerale = Object.values(totali).reduce((sum, val) => sum + val, 0);
                
                // Genera HTML (OPZIONE A: Lista con totale evidenziato)
                let html = '';
                
                if (totali.infissi > 0) {
                    html += `
                        <div class="economico-item">
                            <span class="economico-label">Infissi</span>
                            <span class="economico-value">â‚¬ ${totali.infissi.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                if (totali.persiane > 0) {
                    html += `
                        <div class="economico-item">
                            <span class="economico-label">Persiane</span>
                            <span class="economico-value">â‚¬ ${totali.persiane.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                if (totali.tapparelle > 0) {
                    html += `
                        <div class="economico-item">
                            <span class="economico-label">Tapparelle</span>
                            <span class="economico-value">â‚¬ ${totali.tapparelle.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                if (totali.zanzariere > 0) {
                    html += `
                        <div class="economico-item">
                            <span class="economico-label">Zanzariere</span>
                            <span class="economico-value">â‚¬ ${totali.zanzariere.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                if (totali.cassonetti > 0) {
                    html += `
                        <div class="economico-item">
                            <span class="economico-label">Cassonetti</span>
                            <span class="economico-value">â‚¬ ${totali.cassonetti.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                // TOTALE FINALE (evidenziato)
                html += `
                    <div class="economico-item totale">
                        <span class="economico-label">ğŸ’° TOTALE</span>
                        <span class="economico-value">â‚¬ ${totaleGenerale.toFixed(2)}</span>
                    </div>
                `;
                
                document.getElementById('riepilogoEconomico').innerHTML = html;
                console.log('âœ… Riepilogo economico renderizzato:', totaleGenerale.toFixed(2));
                
            } catch (error) {
                console.error('âŒ Errore calcolo riepilogo economico:', error);
                document.getElementById('riepilogoEconomico').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ef4444;">
                        Errore nel calcolo dei costi
                    </div>
                `;
            }
        }

        // ============================================================================
        // MENU AVANZATO - GESTIONE SIDEBAR E BREADCRUMB
        // ============================================================================
        
        // Struttura menu completa
        const menuStructure = {
            generale: {
                icon: 'ğŸ“Š',
                label: 'Generale',
                color: '#667eea',
                items: [
                    { id: 'dashboard', label: 'Dashboard', icon: 'ğŸ“Š', status: 'completed' },
                    { id: 'import', label: 'Import JSON', icon: 'ğŸ“¥', status: 'completed' },
                    { id: 'tabella', label: 'Tabella Completa', icon: 'ğŸ“‹', status: 'completed' },
                    { id: 'statistiche', label: 'Statistiche', icon: 'ğŸ“ˆ', status: 'completed' },
                    { id: 'export', label: 'Export', icon: 'ğŸ’¾', status: 'completed' }
                ]
            },
            ufficio: {
                icon: 'ğŸ’¼',
                label: 'Ufficio',
                color: '#10b981',
                items: [
                    { id: 'generale', label: 'Vista Generale', icon: 'ğŸ“Š', status: 'completed' },
                    { id: 'posizioni', label: 'Vista Posizioni', icon: 'ğŸ“‹', status: 'completed' },
                    { id: 'aziende', label: 'Vista Aziende', icon: 'ğŸ¢', status: 'completed' }
                ]
            },
            posa: {
                icon: 'ğŸ”§',
                label: 'Posa',
                color: '#f59e0b',
                items: [
                    { id: 'generale-cantiere', label: 'Vista Generale Cantiere', icon: 'ğŸ“¦', status: 'completed' },
                    { id: 'posizioni-cantiere', label: 'Vista Posizioni Cantiere', icon: 'ğŸ”¨', status: 'completed' }
                ]
            }
        };

        // Stato corrente menu
        let currentMenuState = {
            blocco: 'generale',
            sottosezione: 'dashboard'
        };

        // Render menu sidebar completo
        function renderAdvancedMenu() {
            const sidebar = document.getElementById('menuSidebar');
            if (!sidebar) return;

            let html = '';

            // Per ogni blocco
            Object.keys(menuStructure).forEach(bloccoKey => {
                const blocco = menuStructure[bloccoKey];
                
                html += `
                    <div class="sidebar-section">
                        <div class="sidebar-section-title">
                            <span>${blocco.icon}</span>
                            <span>${blocco.label.toUpperCase()}</span>
                        </div>
                `;

                // Items del blocco
                blocco.items.forEach(item => {
                    const isActive = currentMenuState.blocco === bloccoKey && 
                                   currentMenuState.sottosezione === item.id;
                    const isDisabled = item.status === 'disabled';
                    
                    html += `
                        <div class="menu-item ${isActive ? 'active blocco-'+bloccoKey : ''} ${isDisabled ? 'disabled' : ''} submenu-item"
                             onclick="${isDisabled ? '' : `navigateToSection('${bloccoKey}', '${item.id}')`}">
                            <span class="menu-item-icon">${item.icon}</span>
                            <span class="menu-item-text">${item.label}</span>
                            <span class="menu-item-badge badge-${item.status}">
                                ${window.BadgeRenderer ? 
                                    BadgeRenderer.getBadgeHTML(item) : 
                                    getStatusIcon(item.status)
                                }
                            </span>
                        </div>
                        ${item.completamento !== undefined && item.completamento < 100 && window.BadgeRenderer ? 
                            `<div style="padding: 0 12px;">${BadgeRenderer.renderMiniProgressBar(item.completamento)}</div>` : 
                            ''
                        }
                    `;
                });

                html += `</div>`;
            });

            // Keyboard shortcuts hint
            html += `
                <div class="keyboard-hint">
                    <strong>âŒ¨ï¸ Shortcuts:</strong><br>
                    <kbd>G</kbd> Generale â€¢ <kbd>U</kbd> Ufficio â€¢ <kbd>P</kbd> Posa<br>
                    <kbd>â†</kbd> <kbd>â†’</kbd> Naviga sezioni
                </div>
            `;

            sidebar.innerHTML = html;
        }

        // Get status icon
        function getStatusIcon(status) {
            switch(status) {
                case 'completed': return 'âœ…';
                case 'in-progress': return 'â³';
                case 'disabled': return 'âŒ';
                default: return '';
            }
        }

        // Toggle menu (mobile)
        function toggleMenu() {
            const sidebar = document.getElementById('sidebarMenu');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar && overlay) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            }
        }
        
        // Chiudi sidebar
        function closeSidebar() {
            const sidebar = document.getElementById('sidebarMenu');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar && overlay) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            }
        }
        
        // Toggle GitHub Projects cascata
        function toggleGithubProjects(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const expandable = event.currentTarget;
            const submenu = document.getElementById('githubProjectsList');
            
            if (expandable && submenu) {
                expandable.classList.toggle('expanded');
                
                if (submenu.style.display === 'none') {
                    submenu.style.display = 'block';
                } else {
                    submenu.style.display = 'none';
                }
            }
        }
        
        // Toggle Impostazioni nel menu laterale
        function toggleImpostazioni(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const expandable = event.currentTarget;
            const submenu = document.getElementById('impostazioniMenu');
            
            if (expandable && submenu) {
                expandable.classList.toggle('expanded');
                
                if (submenu.style.display === 'none') {
                    submenu.style.display = 'block';
                } else {
                    submenu.style.display = 'none';
                }
            }
        }
        
        // Popola menu laterale con progetti GitHub
        function updateSidebarMenu(projects) {
            const submenu = document.getElementById('githubProjectsList');
            if (!submenu) return;
            
            if (projects.length === 0) {
                submenu.innerHTML = '<div style="padding: 1rem; text-align: center; color: #9ca3af; font-size: 0.875rem;">Nessun progetto trovato</div>';
                return;
            }
            
            submenu.innerHTML = projects.map(proj => `
                <a href="#" onclick="loadGitHubProject('${proj.id}'); closeSidebar(); return false;">
                    ğŸ‘¤ ${proj.cliente || proj.nome}
                </a>
            `).join('');
            
            console.log(`âœ… Menu laterale aggiornato con ${projects.length} progetti`);
        }
        
        // âš ï¸ v7.73: loadGitHubProject definita piÃ¹ avanti (riga ~18900)
        // NON duplicare qui!

        // Navigate to section
        function navigateToSection(blocco, sottosezione) {
            console.log(`Navigate to: ${blocco} > ${sottosezione}`);
            
            // Update state
            currentMenuState.blocco = blocco;
            currentMenuState.sottosezione = sottosezione;
            
            // Switch blocco if different
            if (currentBlocco !== blocco) {
                switchBlocco(blocco);
            }
            
            // Update breadcrumb
            updateBreadcrumb(blocco, sottosezione);
            
            // Re-render menu to update active state
            renderAdvancedMenu();
            
            // Close mobile menu
            const sidebar = document.getElementById('menuSidebar');
            if (sidebar && window.innerWidth <= 768) {
                sidebar.classList.remove('open');
            }
            
            // Handle specific actions based on section
            handleSectionAction(blocco, sottosezione);
        }

        // Handle section-specific actions
        function handleSectionAction(blocco, sottosezione) {
            switch(blocco) {
                case 'generale':
                    // Scroll to relevant section
                    switch(sottosezione) {
                        case 'dashboard':
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                            break;
                        case 'tabella':
                            const tableSection = document.getElementById('kpiCardsContainer');
                            if (tableSection) {
                                tableSection.scrollIntoView({ behavior: 'smooth' });
                            }
                            break;
                    }
                    break;
                    
                case 'ufficio':
                    switch(sottosezione) {
                        case 'generale':
                            switchVistaUfficio('generale');
                            break;
                        case 'posizioni':
                            switchVistaUfficio('posizioni');
                            break;
                        case 'aziende':
                            switchVistaUfficio('aziende');
                            break;
                    }
                    break;
            }
        }

        // Update breadcrumb
        function updateBreadcrumb(blocco, sottosezione) {
            const breadcrumb = document.getElementById('breadcrumb');
            if (!breadcrumb) return;

            const bloccoLabel = menuStructure[blocco]?.label || blocco;
            const sottosezioneItem = menuStructure[blocco]?.items.find(i => i.id === sottosezione);
            const sottosezioneLabel = sottosezioneItem?.label || sottosezione;

            breadcrumb.innerHTML = `
                <div class="breadcrumb-content">
                    <a href="#" class="breadcrumb-item" onclick="navigateToSection('generale', 'dashboard'); return false;">Dashboard</a>
                    <span class="breadcrumb-separator">â€º</span>
                    <span class="breadcrumb-item">${bloccoLabel}</span>
                    <span class="breadcrumb-separator">â€º</span>
                    <span class="breadcrumb-item current">${sottosezioneLabel}</span>
                </div>
            `;
        }

        // Setup keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ignore if typing in input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                switch(e.key.toLowerCase()) {
                    case 'g':
                        navigateToSection('generale', 'dashboard');
                        break;
                    case 'u':
                        navigateToSection('ufficio', 'generale');
                        break;
                }
            });
        }

        // Modify existing switchBlocco to update menu state
        const originalSwitchBlocco = switchBlocco;
        switchBlocco = function(blocco) {
            originalSwitchBlocco(blocco);
            currentMenuState.blocco = blocco;
            
            // Set default sottosezione
            const defaultSottosezione = menuStructure[blocco]?.items[0]?.id || 'dashboard';
            currentMenuState.sottosezione = defaultSottosezione;
            
            updateBreadcrumb(blocco, defaultSottosezione);
            renderAdvancedMenu();
        };

        // ============================================================================
        // VISTA POSIZIONI UFFICIO - Variabili Globali
        // ============================================================================
        let currentPositionIndex = 0;
        let filteredPositions = [];
        let allPositionsData = [];
        let projectData = null; // ğŸ†• Dati completi progetto (per config globale)

        // ============================================================================
        // VISTA POSIZIONI - RENDER PRINCIPALE
        // ============================================================================
        function renderVistaPosizioniUfficio(data) {
            console.log('ğŸ“‹ Rendering Vista Posizioni Ufficio...');
            
            if (!data || !data.posizioni || data.posizioni.length === 0) {
                console.warn('âš ï¸ Nessuna posizione trovata');
                return;
            }

            // Nascondi placeholder, mostra contenuto (usando classList invece di style.display)
            document.getElementById('posizioniPlaceholder').classList.add('content-hidden');
            document.getElementById('posizioniContent').classList.remove('content-hidden');
            
            // âœ… Popola header progetto
            const nomeProgetto = data.nome || data.projectName || 'Progetto Senza Nome';
            const nomeCliente = data.cliente?.nome || data.cliente?.ragione_sociale || 
                              data.customerName || 'Cliente Non Specificato';
            const cognomeCliente = data.cliente?.cognome || '';
            const dataRilievo = data.data_rilievo || data.metadata?.created || Date.now();
            const numPosizioni = data.posizioni.length;
            
            // Formatta data
            const dataFormatted = new Date(dataRilievo).toLocaleDateString('it-IT', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
            
            // Aggiorna elementi header
            document.getElementById('projectNameDisplay').textContent = nomeProgetto;
            document.getElementById('projectClientDisplay').textContent = 
                `ğŸ‘¤ ${nomeCliente}${cognomeCliente ? ' ' + cognomeCliente : ''}`;
            document.getElementById('projectDateDisplay').textContent = `ğŸ“… ${dataFormatted}`;
            document.getElementById('projectPositionsCountDisplay').textContent = 
                `ğŸ“ ${numPosizioni} posizion${numPosizioni !== 1 ? 'i' : 'e'}`;
            
            console.log(`â„¹ï¸ Header progetto popolato: ${nomeProgetto} - ${nomeCliente}`);
            
            // Salva dati progetto completi (per config globale)
            projectData = data;
            
            // Salva dati posizioni
            allPositionsData = data.posizioni;
            filteredPositions = [...allPositionsData];
            currentPositionIndex = 0;
            
            // Popola filtri
            populateFilters();
            
            // Render config globale
            renderConfigGlobale();
            
            // âœ… v7.73: Inizializza menu configurazione prodotti
            initConfigMenu();
            
            // Rende lista e dettaglio
            renderPositionsList();
            renderPositionDetail(0);
            
            console.log(`âœ… Vista Posizioni rendered: ${allPositionsData.length} posizioni`);
        }

        // ============================================================================
        // BLOCCO UFFICIO - RENDER VISTA AZIENDE
        // ============================================================================
        function renderVistaAziende(data) {
            console.log('ğŸ¢ Rendering Vista Aziende...');
            
            // Salva dati progetto completi
            projectData = data;
            
            // Nascondi placeholder, mostra contenuto (usando classList invece di style.display)
            document.getElementById('aziendePlaceholder').classList.add('content-hidden');
            document.getElementById('aziendeContent').classList.remove('content-hidden');
            
            // Raggruppa prodotti per azienda
            const aziendeMap = groupProductsByAzienda(data.posizioni);
            
            // NUOVO LAYOUT: Tab orizzontali + contenuto espandibile
            const aziendeArray = Array.from(aziendeMap.entries());
            
            // Genera HTML per tab orizzontali
            const tabsHTML = `
                <div class="aziende-tabs-container">
                    <div class="aziende-tabs">
                        ${aziendeArray.map(([aziendaKey, aziendaData], index) => {
                            const totaleProdotti = aziendaData.prodotti.reduce((sum, p) => sum + p.quantita, 0);
                            const displayName = aziendaData.displayName || aziendaKey;
                            return `
                                <div class="azienda-tab ${index === 0 ? 'active' : ''}" 
                                     onclick="showAziendaDetails('${displayName}', ${index})"
                                     id="azienda-tab-${index}">
                                    <div class="azienda-tab-icon">ğŸ¢</div>
                                    <div class="azienda-tab-content">
                                        <div class="azienda-tab-name">${displayName}</div>
                                        <div class="azienda-tab-count">${totaleProdotti} pz</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            // Genera HTML per contenuti espandibili
            const contentsHTML = `
                <div class="aziende-details-container">
                    ${aziendeArray.map(([aziendaKey, aziendaData], index) => {
                        const displayName = aziendaData.displayName || aziendaKey;
                        return `
                            <div class="azienda-details ${index === 0 ? 'active' : ''}" 
                                 id="azienda-details-${index}">
                                ${renderAziendaCard(displayName, aziendaData, data)}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            // Inserisci nel DOM
            document.getElementById('aziendeCards').innerHTML = tabsHTML + contentsHTML;
            
            console.log(`âœ… Vista Aziende rendered: ${aziendeMap.size} aziende`);
        }

        // NUOVA FUNZIONE: Mostra dettagli azienda selezionata
        function showAziendaDetails(aziendaName, index) {
            // Rimuovi classe active da tutti i tab
            document.querySelectorAll('.azienda-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Rimuovi classe active da tutti i contenuti
            document.querySelectorAll('.azienda-details').forEach(details => {
                details.classList.remove('active');
            });
            
            // Aggiungi classe active al tab selezionato
            document.getElementById(`azienda-tab-${index}`).classList.add('active');
            
            // Aggiungi classe active al contenuto selezionato
            document.getElementById(`azienda-details-${index}`).classList.add('active');
            
            console.log(`ğŸ“‚ Azienda selezionata: ${aziendaName}`);
        }

        // ============================================================================
        // LISTINO FINSTRAL - EUR 2025/3
        // ============================================================================

        // CAMPIONI PREZZI BASE TIPO 101 (Battente 1 anta)
        const CAMPIONI_TIPO_101 = [
            // [L_min, L_max, A_min, A_max, prezzo_eur]
            // Larghezza 605-730 (piccole)
            [605, 665, 605, 665, 221],
            [605, 665, 730, 790, 235],
            [605, 665, 855, 915, 248],
            [605, 665, 1040, 1105, 285],
            [605, 665, 1230, 1290, 320],
            [605, 665, 1415, 1480, 350],
            // Larghezza 800-865 (medie-piccole)
            [800, 865, 605, 665, 248],
            [800, 865, 790, 855, 277],
            [800, 865, 1040, 1105, 337],
            [800, 865, 1230, 1290, 370],
            [800, 865, 1415, 1480, 393],
            [800, 865, 1615, 1675, 423],
            // Larghezza 1050-1115 (medie)
            [1050, 1115, 605, 665, 300],
            [1050, 1115, 790, 855, 337],
            [1050, 1115, 1040, 1105, 414],
            [1050, 1115, 1230, 1290, 451],
            [1050, 1115, 1415, 1480, 480],
            [1050, 1115, 1615, 1675, 518],
            // Larghezza 1300-1365 (medie-grandi)
            [1300, 1365, 605, 665, 340],
            [1300, 1365, 790, 855, 382],
            [1300, 1365, 1040, 1105, 466],
            [1300, 1365, 1230, 1290, 511],
            [1300, 1365, 1415, 1480, 541],
            [1300, 1365, 1615, 1675, 586],
            // Larghezza 1550-1615 (grandi)
            [1550, 1615, 605, 665, 367],
            [1550, 1615, 790, 855, 412],
            [1550, 1615, 1040, 1105, 505],
            [1550, 1615, 1230, 1290, 551],
            [1550, 1615, 1415, 1480, 585],
            [1550, 1615, 1615, 1675, 628],
            // Larghezza 1800-1865 (molto grandi)
            [1800, 1865, 605, 665, 392],
            [1800, 1865, 790, 855, 437],
            [1800, 1865, 1040, 1105, 535],
            [1800, 1865, 1230, 1290, 586],
            [1800, 1865, 1415, 1480, 618],
            [1800, 1865, 1615, 1675, 653],
            // Larghezza 2050+ (extra large)
            [2050, 2115, 605, 665, 422],
            [2050, 2115, 790, 855, 474],
            [2050, 2115, 1040, 1105, 581],
            [2050, 2115, 1230, 1290, 636],
            [2050, 2115, 1415, 1480, 672],
            // Larghezza max
            [2790, 2855, 605, 665, 541],
            [2790, 2855, 790, 855, 650],
            [2790, 2855, 1040, 1105, 833],
            [2790, 2855, 1230, 1290, 872],
            [2915, 2980, 605, 665, 552],
            [2915, 2980, 790, 855, 661],
            [2915, 2980, 1040, 1105, 856],
            [2915, 2980, 1230, 1290, 891],
            [2915, 2980, 1415, 1480, 884],
            [2915, 2980, 1615, 1675, 907]
        ];

        // CAMPIONI PREZZI BASE TIPO 401 (Battente 2 ante)
        const CAMPIONI_TIPO_401 = [
            // [L_min, L_max, A_min, A_max, prezzo_eur]
            // Larghezza 990-1115 (piccole 2 ante)
            [990, 1050, 605, 665, 378],
            [990, 1050, 730, 790, 403],
            [990, 1050, 855, 915, 423],
            [990, 1050, 1040, 1105, 514],
            [990, 1050, 1230, 1290, 566],
            [990, 1050, 1415, 1480, 613],
            [1115, 1175, 605, 665, 400],
            [1115, 1175, 730, 790, 429],
            [1115, 1175, 855, 915, 450],
            [1115, 1175, 1040, 1105, 541],
            [1115, 1175, 1230, 1290, 601],
            [1115, 1175, 1415, 1480, 658],
            // Larghezza 1300-1425 (medie 2 ante)
            [1300, 1365, 605, 665, 432],
            [1300, 1365, 730, 790, 457],
            [1300, 1365, 855, 915, 488],
            [1300, 1365, 1040, 1105, 588],
            [1300, 1365, 1230, 1290, 653],
            [1300, 1365, 1415, 1480, 712],
            [1425, 1490, 605, 665, 441],
            [1425, 1490, 730, 790, 472],
            [1425, 1490, 855, 915, 498],
            [1425, 1490, 1040, 1105, 604],
            [1425, 1490, 1230, 1290, 664],
            [1425, 1490, 1415, 1480, 725],
            // Larghezza 1550-1675 (grandi 2 ante)
            [1550, 1615, 605, 665, 458],
            [1550, 1615, 730, 790, 492],
            [1550, 1615, 855, 915, 523],
            [1550, 1615, 1040, 1105, 633],
            [1550, 1615, 1230, 1290, 698],
            [1550, 1615, 1415, 1480, 762],
            [1740, 1800, 605, 665, 487],
            [1740, 1800, 730, 790, 526],
            [1740, 1800, 855, 915, 560],
            [1740, 1800, 1040, 1105, 678],
            [1740, 1800, 1230, 1290, 744],
            [1740, 1800, 1415, 1480, 805],
            // Larghezza 1990-2050 (molto grandi)
            [1990, 2050, 605, 665, 509],
            [1990, 2050, 730, 790, 554],
            [1990, 2050, 855, 915, 594],
            [1990, 2050, 1040, 1105, 725],
            [1990, 2050, 1230, 1290, 793],
            [1990, 2050, 1415, 1480, 848],
            // Larghezza max
            [2790, 2855, 605, 665, 741],
            [2790, 2855, 730, 790, 808],
            [2790, 2855, 1040, 1105, 1016],
            [2790, 2855, 1230, 1290, 1116],
            [2915, 2980, 605, 665, 758],
            [2915, 2980, 730, 790, 825],
            [2915, 2980, 855, 915, 878],
            [2915, 2980, 1040, 1105, 1047],
            [2915, 2980, 1230, 1290, 1146],
            [2915, 2980, 1415, 1480, 1233]
        ];

        // TELAI PVC-PVC
        const TELAI_PVC = {
            "961": { base_incluso: true, supplemento_ml: 5.20 },
            "962": { base_incluso: true, supplemento_ml: 5.61 },
            "963": { supplemento_ml_chiaro: 2.89, supplemento_ml_scuro: 9.31 },
            "967": { base_incluso: true, supplemento_ml: 5.20 }  // Alias 961
        };

        // TELAI ALLUMINIO-PVC
        const TELAI_ALLUMINIO = {
            "961X": { supplemento_ml_chiaro: 23.6, supplemento_ml_scuro: 25.4 },
            "962X": { supplemento_ml_chiaro: 23.6, supplemento_ml_scuro: 25.4 },
            "963X": { supplemento_ml_chiaro: 23.6, supplemento_ml_scuro: 25.4 },
            "961N5": { supplemento_ml_chiaro: 18.0, supplemento_ml_scuro: 19.3 },
            "962N5": { supplemento_ml_chiaro: 18.0, supplemento_ml_scuro: 19.3 },
            "963N5": { supplemento_ml_chiaro: 18.0, supplemento_ml_scuro: 19.3 },
            "961N": { supplemento_ml_chiaro: 17.2, supplemento_ml_scuro: 20.4 },
            "962N": { supplemento_ml_chiaro: 17.2, supplemento_ml_scuro: 22.4 },
            "963N": { supplemento_ml_chiaro: 18.0, supplemento_ml_scuro: 24.9 }
        };

        // TELAI INTERNI
        const TELAI_INTERNI = {
            "F961": { supplemento_ml_chiaro: 16.9, supplemento_ml_scuro: 18.2 },
            "F962": { supplemento_ml_chiaro: 16.9, supplemento_ml_scuro: 18.2 }
        };

        // SUPPLEMENTI ANTE (al metro lineare)
        const SUPPLEMENTI_ANTE = {
            "classic-line": 0,        // Inclusa (standard)
            "classicline": 0,
            "step-line": 0,           // Inclusa (standard)
            "stepline": 0,
            "nova-line": 10,          // â‚¬ 10/ml
            "novaline": 10,
            "nova-line-plus": 10,     // â‚¬ 10/ml
            "novalineplus": 10,
            "nova-line-twin": 12,     // â‚¬ 12/ml
            "novalinetwin": 12
        };

        // SUPPLEMENTI VETRI (al mÂ² - solo se superficie > 2.5 mÂ²)
        const SUPPLEMENTI_VETRI = {
            "doppio": 0,              // Incluso (standard)
            "triplo": 35,             // â‚¬ 35/mÂ²
            "triplo-sat": 50,         // â‚¬ 50/mÂ²
            "triplo-satinato": 50,
            "triplo-selettivo": 60    // â‚¬ 60/mÂ²
        };


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”§ FUNZIONI PARSING MANIGLIE FINSTRAL - v7.26
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        /**
         * Estrae codice maniglia da stringa tipo "6010 - Finestra alluminio"
         * @param {string} manigliaValue - Valore salvato (es: "6010 - Finestra alluminio" o "standard")
         * @returns {string} - Codice maniglia (es: "6010") o stringa originale se non parsabile
         */
        function estraiCodiceManiglia(manigliaValue) {
            if (!manigliaValue || manigliaValue === '') return '';
            
            // Se contiene " - " Ã¨ formato nuovo: "6010 - Finestra alluminio"
            if (manigliaValue.includes(' - ')) {
                const match = manigliaValue.match(/^(\S+)/);
                return match ? match[1] : '';
            }
            
            // Altrimenti Ã¨ valore vecchio: "standard", "inox", ecc.
            return manigliaValue;
        }

        /**
         * Estrae codice colore da stringa tipo "07 - Bianco perla"
         * @param {string} coloreValue - Valore salvato (es: "07 - Bianco perla" o "bianco")
         * @returns {string} - Codice colore (es: "07") o stringa originale se non parsabile
         */
        function estraiCodiceColore(coloreValue) {
            if (!coloreValue || coloreValue === '') return '';
            
            // Se contiene " - " Ã¨ formato nuovo: "07 - Bianco perla"
            if (coloreValue.includes(' - ')) {
                const match = coloreValue.match(/^(\S+)/);
                return match ? match[1] : '';
            }
            
            // Altrimenti Ã¨ valore vecchio: "bianco", "bronzo", ecc.
            return coloreValue;
        }

        /**
         * Calcola supplemento maniglia usando database Finstral
         * Supporta sia formato nuovo (6010 - Finestra) che vecchio (standard, inox)
         * @param {string} manigliaValue - Valore maniglia salvato
         * @param {string} coloreValue - Valore colore salvato
         * @returns {number} - Supplemento in â‚¬ (0 se non trovato o valori vecchi)
         */
        function calcolaSupplementoManigliaFinstral(manigliaValue, coloreValue) {
            const codiceManiglia = estraiCodiceManiglia(manigliaValue);
            const codiceColore = estraiCodiceColore(coloreValue);
            
            // Se Ã¨ formato vecchio (no codici Finstral), usa vecchia logica
            if (!manigliaValue || !manigliaValue.includes(' - ')) {
                // Valori vecchi: "standard", "inox", "design", ecc.
                return calcolaSupplementoManigliaVecchio(manigliaValue);
            }
            
            // Formato nuovo: usa database Finstral
            if (!codiceManiglia || !codiceColore) {
                return 0; // Campi vuoti
            }
            
            // Usa funzione del database
            return getSupplemento(codiceManiglia, codiceColore);
        }

        /**
         * Fallback per valori vecchi (pre-v4.31)
         * @param {string} tipoManiglia - "standard", "inox", "design", ecc.
         * @returns {number} - Supplemento in â‚¬
         */
        function calcolaSupplementoManigliaVecchio(tipoManiglia) {
            if (!tipoManiglia) return 0;
            const maniglia = tipoManiglia.toLowerCase().replace(/\s+/g, '-').replace(/_/g, '-');
            
            // Supplementi vecchi (compatibilitÃ )
            const SUPPLEMENTI_VECCHI = {
                "standard": 0,
                "bianco": 0,
                "satinato": 0,
                "inox": 20,
                "design": 40,
                "con-chiave": 50
            };
            
            return SUPPLEMENTI_VECCHI[maniglia] || 0;
        }

        // SUPPLEMENTI MANIGLIE (DEPRECATO v7.26)
        // SOSTITUITO da database MANIGLIE_FINSTRAL
        // Mantenuto per riferimento storico
        /*
        const SUPPLEMENTI_MANIGLIE = {
            "standard": 0,            // Inclusa
            "bianco": 0,              // Inclusa
            "satinato": 0,            // Inclusa (variante standard)
            "inox": 20,               // â‚¬ 20/pezzo
            "design": 40,             // â‚¬ 40/pezzo
            "con-chiave": 50          // â‚¬ 50/pezzo
        };
        */

        // MAPPING APERTURE â†’ TIPI
        const MAPPING_APERTURE_TIPI = {
            // Battenti standard
            'battente_1_anta': 'tipo_101',
            'battente': 'tipo_101',
            'vasistas': 'tipo_101',
            'ribalta': 'tipo_101',
            // Aperture direzionali
            'dx': 'tipo_101',
            'sx': 'tipo_101',
            'destra': 'tipo_101',
            'sinistra': 'tipo_101',
            // Fissi
            'fisso': 'tipo_102',
            'f1': 'tipo_102',  // App usa F1 per fisso 1 campo
            // 2 Ante
            'battente_2_ante': 'tipo_401',
            'due_ante': 'tipo_401',
            'f2': 'tipo_401',  // App usa F2 per fisso 2 campi (o 2 ante)
            '2_ante': 'tipo_401',
            // Scorrevoli
            'scorrevole': 'tipo_501',
            'scorrevole_parallela': 'tipo_501',
            // Fallback
            'default': 'tipo_101'
        };

        // COSTI EXTRA
        const COSTI_EXTRA = {
            posa_per_pezzo: 50,         // â‚¬ per pezzo
            smontaggio_per_pezzo: 30    // â‚¬ per pezzo
        };

        // Funzione: Calcola perimetro BRM in metri lineari
        function calcolaPerimetroBRM(larghezza_mm, altezza_mm) {
            return 2 * (larghezza_mm + altezza_mm) / 1000;
        }

        // Funzione: Trova campione prezzo base
        function trovaCampionePrezzoBase(tipo, L_mm, A_mm) {
            let campioni;
            
            if (tipo === 'tipo_101') {
                campioni = CAMPIONI_TIPO_101;
            } else if (tipo === 'tipo_401') {
                campioni = CAMPIONI_TIPO_401;
            } else if (tipo === 'tipo_102') {
                // Fisso: usa tipo 101 con sconto 5%
                campioni = CAMPIONI_TIPO_101;
                const prezzo = trovaCampionePrezzoBase('tipo_101', L_mm, A_mm);
                return prezzo ? prezzo * 0.95 : null;
            } else {
                console.warn(`Tipo ${tipo} non trovato`);
                return null;
            }
            
            // Cerca campione esatto o piÃ¹ vicino
            for (const [L_min, L_max, A_min, A_max, prezzo] of campioni) {
                if (L_mm >= L_min && L_mm <= L_max && 
                    A_mm >= A_min && A_mm <= A_max) {
                    return prezzo;
                }
            }
            
            // Nessun campione trovato: usa piÃ¹ vicino per sicurezza
            let minDistanza = Infinity;
            let prezzoVicino = null;
            
            for (const [L_min, L_max, A_min, A_max, prezzo] of campioni) {
                const L_centro = (L_min + L_max) / 2;
                const A_centro = (A_min + A_max) / 2;
                const distanza = Math.sqrt(
                    Math.pow(L_mm - L_centro, 2) + 
                    Math.pow(A_mm - A_centro, 2)
                );
                
                if (distanza < minDistanza) {
                    minDistanza = distanza;
                    prezzoVicino = prezzo;
                }
            }
            
            console.warn(`âš ï¸ Prezzo per L=${L_mm}, A=${A_mm} non trovato, uso piÃ¹ vicino: â‚¬${prezzoVicino}`);
            return prezzoVicino;
        }

        // Funzione: Calcola supplemento telaio
        function calcolaSupplementoTelaio(codiceTelaio, perimetro_ml, coloreScuro = false) {
            let supplemento = 0;
            
            // Cerca in telai PVC
            if (TELAI_PVC[codiceTelaio]) {
                const telaio = TELAI_PVC[codiceTelaio];
                if (telaio.supplemento_ml) {
                    supplemento = telaio.supplemento_ml * perimetro_ml;
                } else {
                    const sup_ml = coloreScuro ? telaio.supplemento_ml_scuro : telaio.supplemento_ml_chiaro;
                    supplemento = sup_ml * perimetro_ml;
                }
            }
            // Cerca in telai Alluminio
            else if (TELAI_ALLUMINIO[codiceTelaio]) {
                const telaio = TELAI_ALLUMINIO[codiceTelaio];
                const sup_ml = coloreScuro ? telaio.supplemento_ml_scuro : telaio.supplemento_ml_chiaro;
                supplemento = sup_ml * perimetro_ml;
            }
            // Cerca in telai Interni
            else if (TELAI_INTERNI[codiceTelaio]) {
                const telaio = TELAI_INTERNI[codiceTelaio];
                const sup_ml = coloreScuro ? telaio.supplemento_ml_scuro : telaio.supplemento_ml_chiaro;
                supplemento = sup_ml * perimetro_ml;
            }
            
            return supplemento;
        }

        // Funzione: Determina se colore Ã¨ scuro (gruppo B)
        function isColoreScuro(colore) {
            if (!colore) return false;
            const coloreLC = colore.toLowerCase();
            
            // Gruppo A (chiari): bianco, bianco perla, bianco satinato, bianco goffrato
            const coloriChiari = ['bianco', 'white', 'ral 9010', 'ral 9016', 'perla', 'satinato', 'goffrato'];
            
            // Se contiene una parola chiara, Ã¨ chiaro
            if (coloriChiari.some(c => coloreLC.includes(c))) {
                return false;
            }
            
            // Altrimenti consideralo scuro (gruppo B)
            return true;
        }

        // Funzione: Ottieni tipo da apertura
        function getTipoDaApertura(apertura) {
            const aperturaLC = (apertura || '').toLowerCase().trim();
            return MAPPING_APERTURE_TIPI[aperturaLC] || MAPPING_APERTURE_TIPI['default'];
        }

        // Funzione: Calcola supplemento anta
        function calcolaSupplementoAnta(tipoAnta, perimetro_ml) {
            if (!tipoAnta) return 0;
            const anta = tipoAnta.toLowerCase().replace(/\s+/g, '-').replace(/_/g, '-');
            const suppl_ml = SUPPLEMENTI_ANTE[anta] || 0;
            return suppl_ml * perimetro_ml;
        }

        // Funzione: Calcola supplemento vetro
        function calcolaSupplementoVetro(tipoVetro, superficie_mq) {
            if (!tipoVetro) return 0;
            const vetro = tipoVetro.toLowerCase().replace(/\s+/g, '-').replace(/_/g, '-');
            
            // âœ… v7.73: Usa database Finstral per vetri 2113/11414
            let suppl_mq = 0;
            if (vetro.includes('triplo') || vetro === '11414') {
                suppl_mq = FINSTRAL_PREZZI.supplementiVetro?.["11414"] || 118.00;
            } else if (vetro.includes('doppio') || vetro === '2113') {
                suppl_mq = FINSTRAL_PREZZI.supplementiVetro?.["2113"] || 52.20;
            } else {
                suppl_mq = SUPPLEMENTI_VETRI[vetro] || 0;
            }
            
            // Supplemento vetro sempre applicato
            return suppl_mq * superficie_mq;
        }

        /**
         * âœ… v7.79: Cerca supplemento anta da tabella dimensionale
         * Per ante Slim-line Cristal, Twin, Nova Twin che hanno prezzo â‚¬/pezzo invece di â‚¬/ml
         * @param {string} tipoAnta - Tipo anta normalizzato (es. "slim-line-cristal")
         * @param {number} altezza_mm - Altezza anta in mm
         * @param {number} larghezza_mm - Larghezza anta in mm
         * @returns {number|null} Supplemento â‚¬/pezzo o null se non trovato
         */
        function getSupplementoAntaDimensionale(tipoAnta, altezza_mm, larghezza_mm) {
            const tabella = FINSTRAL_PREZZI.tabelleAnteDimensionali?.[tipoAnta];
            if (!tabella) return null; // Non Ã¨ un tipo con tabella dimensionale
            
            // Trova riga (altezza) piÃ¹ vicina
            const righe = Object.keys(tabella).map(Number).sort((a, b) => a - b);
            let rigaKey = righe[righe.length - 1]; // Default: ultima riga
            for (const r of righe) {
                if (r >= altezza_mm) {
                    rigaKey = r;
                    break;
                }
            }
            
            // Trova colonna (larghezza) piÃ¹ vicina
            const colonne = Object.keys(tabella[rigaKey] || {}).map(Number).sort((a, b) => a - b);
            let colonnaKey = colonne[colonne.length - 1]; // Default: ultima colonna
            for (const c of colonne) {
                if (c >= larghezza_mm) {
                    colonnaKey = c;
                    break;
                }
            }
            
            const prezzo = tabella[rigaKey]?.[colonnaKey];
            if (prezzo) {
                console.log(`ğŸ“Š Tabella anta ${tipoAnta}: A=${altezza_mm}â†’${rigaKey}, L=${larghezza_mm}â†’${colonnaKey} = â‚¬${prezzo}`);
            }
            return prezzo || 0;
        }

        // Funzione: Calcola supplemento maniglia (DEPRECATA v7.26)
        // SOSTITUITA da calcolaSupplementoManigliaFinstral()
        // Mantenuta per debug e compatibilitÃ  temporanea
        /*
        function calcolaSupplementoManiglia(tipoManiglia) {
            if (!tipoManiglia) return 0;
            const maniglia = tipoManiglia.toLowerCase().replace(/\s+/g, '-').replace(/_/g, '-');
            return SUPPLEMENTI_MANIGLIE[maniglia] || 0;
        }
        */

        /**
         * Estrae numero ante dal campo tipo (F1, F2, F3, F4, PF1, PF2)
         * @param {string} tipo - Tipo infisso/persiana (es. "F2", "PF1")
         * @returns {number} Numero ante (1, 2, 3, 4)
         */
        function estraiNumeroAnte(tipo) {
            if (!tipo) return 1;
            
            // Estrai ultima cifra da tipo: F1â†’1, F2â†’2, PF2â†’2, F3â†’3, F4â†’4
            const match = tipo.match(/(\d+)$/);
            if (match) {
                return parseInt(match[1]);
            }
            
            return 1; // Default 1 anta
        }

        // ============================================================================
        // LISTINO PUNTO PERSIANE - STECCHE FISSE TONDE - 2025
        // ============================================================================
        
        // ğŸ†• v7.92: MAGGIORAZIONI MODELLI PERSIANE (da listino pag. 88)
        const MAGGIORAZIONI_MODELLI_PERSIANE = {
            'Alto Adige': 0.33,      // +33% (verificato da preventivo Punto Persiane)
            'Alto Adige [R]': 0.17,  // +17%
            'Alto Adige [TT]': 0.225, // +22.5%
            'Cortina': 0.04,          // +4%
            'Cortina [R]': 0.04,      // +4%
            'Nerina': 0.04,           // +4%
            'Nerina [R]': 0.04,       // +4%
            'Canazei': 0.04,          // +4%
            'Diamante': 0.04          // +4%
        };
        
        // VOCI FISSE PERSIANE (da PDF Punto Persiane)
        const VOCI_FISSE_PERSIANE = {
            contributoGestione: 97.00,  // â‚¬97 fisso
            imballoPercent: 3.00,       // 3% sul totale
            cardiniBase: 3.50,          // â‚¬3.50 cad (C.SAF90)
            cardiniQuantita: 4          // 4 pezzi per F2
        };
        
        // ============================================================================
        // LISTINO OIKOS PORTE BLINDATE - 2025
        // ============================================================================
        const LISTINO_OIKOS_BLINDATE = {
            // Prezzi base per versione e luce
            prezziBase: {
                'E3': { 'luce0': 1156, 'luce1': 1206, 'luce2': 1441 },
                'E4': { 'luce0': 1436, 'luce1': 1486, 'luce2': 1721 },
                'E3D': { 'luce3': 2217, 'luce4': 2532 },
                'E3EI30': { 'luce0': 1731 },
                'E3EI45': { 'luce0': 1731 },
                'E3EI60': { 'luce0': 1891 },
                'E3TT086': { 'luce0': 2254, 'luce1': 2442, 'luce2': 2766 },
                'E3TT1': { 'luce0': 1958, 'luce1': 2131, 'luce2': 2386 },
                'P3': { 'luce0': 1173, 'luce1': 1293, 'luce2': 1480 }
            },
            // Controtelaio
            controtelaio: {
                'luce0': 177, 'luce1': 202, 'luce2': 240,
                'luce3': 318, 'luce4': 350
            },
            // Cilindro
            cilindri: { 'BASIC': 123, 'SEKUR': 238 },
            // Colori telaio
            colori: {
                'RAL8022': 0,
                'OIKOS_Polveri': 246,
                'OIKOS_Evergreen': 320,
                'OIKOS_Future': 384,
                'OIKOS_Liquido': 492
            },
            // Termica upgrade
            termica: {
                'singola': {
                    '1.2': { 'luce0': 272, 'luce1': 308, 'luce2': 354 },
                    '1.0': { 'luce0': 496, 'luce1': 544, 'luce2': 624 }
                }
            },
            // Kit Aria-Acqua-Vento
            kitAAV: {
                'MOSE': { 'luce0': 405, 'luce1': 464, 'luce2': 499, 'luce3': 499, 'luce4': 499 },
                'DAM': { 'luce0': 459, 'luce1': 489, 'luce2': 514, 'luce3': 514, 'luce4': 514 }
            },
            // Rivestimenti (prezzi da listino EVO 2025)
            rivestimenti: {
                // Piano - Di Serie (pag. 94)
                'Piano Di Serie': { 'luce0': 192, 'luce1': 192, 'luce2': 235, 'luce3': 346, 'luce4': 414 },
                // ğŸ” v7.98_05: Piano - Non di serie (pag. 99)
                'Piano Non di serie': { 'luce0': 405, 'luce1': 405, 'luce2': 483, 'luce5': 526, 'luce6': 585, 'luce3': 626, 'luce4': 811 },
                'Piano Non di serie Noce Canaletto': { 'luce0': 458, 'luce1': 458, 'luce2': 545, 'luce3': 700, 'luce4': 889 },
                'Piano Non di serie Teak': { 'luce0': 520, 'luce1': 520, 'luce2': 620, 'luce3': 782, 'luce4': 1005 },
                'Piano Non di serie Altre Essenze': { 'luce0': 486, 'luce1': 486, 'luce2': 579, 'luce3': 751, 'luce4': 973 },
                // Piano - Gres (pag. 100)
                'Piano Gres': { 'luce0': 1304, 'luce1': 1347, 'luce2': 1436 },
                // Piano generico (media per retrocompatibilitÃ )
                'Piano': { 'luce0': 192, 'luce1': 192, 'luce2': 235, 'luce3': 346, 'luce4': 414 },
                // Fugato
                'Fugato': { 'luce0': 592, 'luce1': 592, 'luce2': 706, 'luce3': 894, 'luce4': 1156 },
                // Pantografato
                'Pantografato': { 'luce0': 791, 'luce1': 791, 'luce2': 968, 'luce3': 1235, 'luce4': 1477 },
                // Legno Vivo
                'LegnoVivo': { 'luce0': 1183, 'luce1': 1183, 'luce2': 1411, 'luce3': 1788, 'luce4': 2304 },
                // Massello (su richiesta - stima)
                'Massello': { 'luce0': 450, 'luce1': 520, 'luce2': 590 },
                // Riflessi Vetro
                'Riflessi': { 'luce0': 1197, 'luce1': 1322, 'luce2': 1534 },
                'Riflessi Vetro': { 'luce0': 1197, 'luce1': 1322, 'luce2': 1534 },
                // Alluminio (su richiesta - stima)
                'Alluminio': { 'luce0': 280, 'luce1': 320, 'luce2': 360 },
                // Gres
                'Gres': { 'luce0': 1304, 'luce1': 1347, 'luce2': 1436 },
                // Tekno
                'Tekno': { 'luce0': 909, 'luce1': 1000, 'luce2': 1192 }
            },
            // Optional vetro blindato
            vetroBlindato: {
                'V1': { 'trasparente': 1050, 'sabbiato': 1150 },
                'V2': { 'trasparente': 1350, 'sabbiato': 1450 },
                'V3': { 'trasparente': 1650, 'sabbiato': 1750 },
                'V4': { 'trasparente': 2100, 'sabbiato': 2200 },
                'V5': { 'trasparente': 2800, 'sabbiato': 2900 }
            },
            // Optional vetro termico
            vetroTermico: {
                'V1': { 'trasparente': 850, 'sabbiato': 950 },
                'V2': { 'trasparente': 1100, 'sabbiato': 1200 },
                'V3': { 'trasparente': 1350, 'sabbiato': 1450 },
                'V4': { 'trasparente': 1750, 'sabbiato': 1850 },
                'V5': { 'trasparente': 2350, 'sabbiato': 2450 }
            },
            // Sopraluce
            sopraluce: {
                'H500': { 'luce0': 380, 'luce1': 420, 'luce2': 480 },
                'H800': { 'luce0': 520, 'luce1': 580, 'luce2': 650 },
                'controtelaio': { 'luce0': 95, 'luce1': 110, 'luce2': 130 },
                'sabbiato_H500': { 'luce0': 85, 'luce1': 95, 'luce2': 110 },
                'sabbiato_H800': { 'luce0': 110, 'luce1': 125, 'luce2': 145 }
            },
            // Fiancoluce
            fiancoluce: {
                'conVetro': { 'luce1': 650, 'luce2': 750, 'luce3': 850 },
                'senzaVetro': { 'luce1': 380, 'luce2': 440, 'luce3': 500 },
                'sabbiato': { 'luce1': 95, 'luce2': 110, 'luce3': 125 },
                'colori': {
                    'OIKOS_Polveri': { 'luce1': 150, 'luce2': 175, 'luce3': 200 },
                    'OIKOS_Evergreen': { 'luce1': 195, 'luce2': 225, 'luce3': 255 },
                    'OIKOS_Future': { 'luce1': 235, 'luce2': 270, 'luce3': 305 },
                    'OIKOS_Liquido': { 'luce1': 300, 'luce2': 345, 'luce3': 390 }
                }
            },
            // Acustica maggiorata
            acusticaMagg: 120,
            // Verniciatura esterni
            verniciaturaEst: 150,
            
            // ğŸ†• v7.98: IMBOTTI (da listino EVO 2025 pag. 142-143)
            imbotti: {
                // Imbotte esterno in legno - prezzo per altezza Ã— larghezza
                'imbotte_cornici': {
                    // Altezze (H1=fino 2100, H2=fino 2400)
                    'H1': {
                        'L20': 180, 'L25': 210, 'L30': 240, 'L35': 270, 'L40': 300
                    },
                    'H2': {
                        'L20': 210, 'L25': 245, 'L30': 280, 'L35': 315, 'L40': 350
                    }
                },
                'imbotte_solo': {
                    'H1': { 'L20': 140, 'L25': 165, 'L30': 190, 'L35': 215, 'L40': 240 },
                    'H2': { 'L20': 165, 'L25': 195, 'L30': 225, 'L35': 255, 'L40': 285 }
                },
                // Essenza maggiorazione (rispetto a standard)
                'essenze': {
                    'tangMog': 0,        // Tanganica Mogano - standard
                    'tangNat': 0,        // Tanganica Naturale
                    'rovereNat': 20,     // Rovere Naturale +â‚¬20
                    'rovereSbi': 35,     // Rovere Sbiancato +â‚¬35
                    'noce': 45,          // Noce +â‚¬45
                    'noceCan': 65,       // Noce Canaletto +â‚¬65
                    'teak': 85,          // Teak +â‚¬85
                    'laccato': 60        // Laccato +â‚¬60
                }
            },
            
            // ğŸ†• v7.98: CORNICI FERMA PANNELLO (pag. 142)
            cornici: {
                'fermaPannello': { 'luce0': 96, 'luce1': 108, 'luce2': 125, 'luce3': 145, 'luce4': 165 },
                'interne': { 'luce0': 85, 'luce1': 95, 'luce2': 110, 'luce3': 125, 'luce4': 145 }
            },
            
            // ğŸ†• v7.98: MANIGLIE E POMOLI (pag. 144-148)
            maniglie: {
                // Maniglie interne
                'MO-05': { 'OL': 0, 'OL_TZ': 45, 'CS': 35, 'CL': 40, 'VP': 50, 'VL': 60, 'VS': 55 },
                'MO-07Q': { 'OL': 65, 'OL_TZ': 95, 'CS': 85, 'CL': 90, 'VP': 95, 'VL': 105, 'VS': 100 },
                'MO-07T': { 'OL': 65, 'OL_TZ': 95, 'CS': 85, 'CL': 90, 'VP': 95, 'VL': 105, 'VS': 100 },
                'MO-08Q': { 'OL': 85, 'OL_TZ': 120, 'CS': 105, 'CL': 110, 'VP': 115, 'VL': 130, 'VS': 120 },
                'MO-08T': { 'OL': 85, 'OL_TZ': 120, 'CS': 105, 'CL': 110, 'VP': 115, 'VL': 130, 'VS': 120 },
                'MO-13Q': { 'OL': 95, 'OL_TZ': 135, 'CS': 120, 'CL': 125, 'VP': 130, 'VL': 145, 'VS': 135 },
                'MO-13T': { 'OL': 95, 'OL_TZ': 135, 'CS': 120, 'CL': 125, 'VP': 130, 'VL': 145, 'VS': 135 },
                'MO-03T': { 'OL_TZ': 145, 'CS': 130, 'CL': 135 },
                // Pomoli esterni
                'PO-05': { 'OL': 0, 'OL_TZ': 35, 'CS': 30, 'CL': 32, 'VP': 40, 'VL': 50, 'VS': 45 },
                'PO-02': { 'OL_TZ': 55, 'CS': 45, 'CL': 48 },
                'PO-INOX': { 'INOX': 76 },
                // Maniglioni
                'JUMBO-300': { 'VP': 180, 'VL': 210, 'VS': 195, 'OB': 220 },
                'JUMBO-600': { 'VP': 240, 'VL': 280, 'VS': 260, 'OB': 295 }
            },
            
            // ğŸ†• v7.98: CHIAVI EXTRA (oltre le 3 di serie)
            chiaviExtra: 25  // â‚¬25 per ogni chiave aggiuntiva
        };
        
        // Funzione calcolo luce Oikos
        function calcolaLuceOikos(L, H) {
            if (L <= 0 || H <= 0) return '';
            if (L <= 900 && H <= 2100) return 'luce0';
            if (L <= 940 && H <= 2210) return 'luce1';
            if (L <= 1030 && H <= 2400) return 'luce2';
            if (L <= 1350 && H <= 2210) return 'luce3';
            if (L <= 1600 && H <= 2400) return 'luce4';
            if (L <= 1800 && H <= 2210) return 'luce5';
            if (L <= 2000 && H <= 2400) return 'luce6';
            return 'fuoriMisura';
        }
        
        // Funzione calcolo prezzo blindata Oikos
        function calcolaPrezzoBlindataOikos(bld) {
            const dettaglio = {
                prezzoBase: 0,
                controtelaio: 0,
                cilindro: 0,
                colore: 0,
                acustica: 0,
                termica: 0,
                kitAAV: 0,
                rivestimenti: 0,
                optional: 0,
                // ğŸ†• v7.98: Nuovi campi
                imbotti: 0,
                cornici: 0,
                maniglie: 0,
                chiaviExtra: 0
            };
            
            // Calcola luce se non presente
            const L = parseInt(bld.LNP_L) || 0;
            const H = parseInt(bld.LNP_H) || 0;
            const luce = bld.luceCalcolata || calcolaLuceOikos(L, H) || 'luce0';
            
            // Prezzo base anta
            dettaglio.prezzoBase = LISTINO_OIKOS_BLINDATE.prezziBase[bld.versione]?.[luce] || 
                                   LISTINO_OIKOS_BLINDATE.prezziBase['E3']?.[luce] || 0;
            
            // Controtelaio
            if (bld.controtelaio === 'si' || bld.controtelaio === true) {
                dettaglio.controtelaio = LISTINO_OIKOS_BLINDATE.controtelaio[luce] || 0;
            }
            
            // Cilindro
            dettaglio.cilindro = LISTINO_OIKOS_BLINDATE.cilindri[bld.cilindro] || 
                                 LISTINO_OIKOS_BLINDATE.cilindri['BASIC'] || 0;
            
            // ğŸ†• v7.98: CHIAVI EXTRA (oltre le 3 di serie)
            const numChiavi = parseInt(bld.numChiavi) || 3;
            if (numChiavi > 3) {
                dettaglio.chiaviExtra = (numChiavi - 3) * (LISTINO_OIKOS_BLINDATE.chiaviExtra || 25);
                console.log(`   Chiavi extra: ${numChiavi - 3} Ã— â‚¬25 = â‚¬${dettaglio.chiaviExtra}`);
            }
            
            // Colore telaio
            dettaglio.colore = LISTINO_OIKOS_BLINDATE.colori[bld.coloreTelaio] || 0;
            
            // ğŸ†• v7.98: MANIGLIA INTERNA
            if (bld.manigliaInt && bld.finituraInt) {
                const prezzoManInt = LISTINO_OIKOS_BLINDATE.maniglie[bld.manigliaInt]?.[bld.finituraInt] || 0;
                dettaglio.maniglie += prezzoManInt;
                console.log(`   Maniglia INT: ${bld.manigliaInt} ${bld.finituraInt} â†’ â‚¬${prezzoManInt}`);
            }
            
            // ğŸ†• v7.98: MANIGLIA/POMOLO ESTERNO
            if (bld.manigliaEst && bld.finituraEst) {
                let finitura = bld.finituraEst;
                // PO-INOX usa sempre finitura INOX
                if (bld.manigliaEst === 'PO-INOX') finitura = 'INOX';
                const prezzoManEst = LISTINO_OIKOS_BLINDATE.maniglie[bld.manigliaEst]?.[finitura] || 0;
                dettaglio.maniglie += prezzoManEst;
                console.log(`   Maniglia EST: ${bld.manigliaEst} ${finitura} â†’ â‚¬${prezzoManEst}`);
            }
            
            // Acustica maggiorata
            if (bld.acustica === 'maggiorata') {
                dettaglio.acustica = LISTINO_OIKOS_BLINDATE.acusticaMagg || 0;
            }
            
            // Termica
            if (bld.termica && bld.termica !== 'serie') {
                dettaglio.termica = LISTINO_OIKOS_BLINDATE.termica?.['singola']?.[bld.termica]?.[luce] || 0;
            }
            
            // Kit AAV (MOSE/DAM)
            if (bld.kitAAV) {
                dettaglio.kitAAV = LISTINO_OIKOS_BLINDATE.kitAAV[bld.kitAAV]?.[luce] || 0;
            }
            
            // Rivestimento INTERNO
            if (bld.rivestimentoInt?.linea) {
                // ğŸ” v7.98_05: Chiave composita linea+modello per prezzi specifici
                const linea = bld.rivestimentoInt.linea;
                const modello = bld.rivestimentoInt.modello || '';
                const essenza = bld.rivestimentoInt.essenza || '';
                let keyRiv = linea;
                
                // Prova chiave specifica (es. "Piano Non di serie Noce Canaletto")
                if (modello === 'Non di serie') {
                    if (essenza.includes('Noce Canaletto')) {
                        keyRiv = `${linea} ${modello} Noce Canaletto`;
                    } else if (essenza.includes('Teak')) {
                        keyRiv = `${linea} ${modello} Teak`;
                    } else if (essenza.includes('Altre Essenze')) {
                        keyRiv = `${linea} ${modello} Altre Essenze`;
                    } else {
                        keyRiv = `${linea} ${modello}`;
                    }
                } else if (modello === 'Gres') {
                    keyRiv = `${linea} Gres`;
                } else if (modello) {
                    keyRiv = `${linea} ${modello}`;
                }
                
                // Cerca prezzo con fallback
                const prezzoRiv = LISTINO_OIKOS_BLINDATE.rivestimenti[keyRiv]?.[luce] ||
                                  LISTINO_OIKOS_BLINDATE.rivestimenti[linea]?.[luce] || 0;
                dettaglio.rivestimenti += prezzoRiv;
                console.log(`   Riv INT: ${keyRiv} â†’ â‚¬${prezzoRiv}`);
            }
            
            // Rivestimento ESTERNO
            if (bld.rivestimentoEst?.linea) {
                // ğŸ” v7.98_05: Chiave composita linea+modello per prezzi specifici
                const linea = bld.rivestimentoEst.linea;
                const modello = bld.rivestimentoEst.modello || '';
                const essenza = bld.rivestimentoEst.essenza || '';
                let keyRiv = linea;
                
                if (modello === 'Non di serie') {
                    if (essenza.includes('Noce Canaletto')) {
                        keyRiv = `${linea} ${modello} Noce Canaletto`;
                    } else if (essenza.includes('Teak')) {
                        keyRiv = `${linea} ${modello} Teak`;
                    } else if (essenza.includes('Altre Essenze')) {
                        keyRiv = `${linea} ${modello} Altre Essenze`;
                    } else {
                        keyRiv = `${linea} ${modello}`;
                    }
                } else if (modello === 'Gres') {
                    keyRiv = `${linea} Gres`;
                } else if (modello) {
                    keyRiv = `${linea} ${modello}`;
                }
                
                const prezzoRiv = LISTINO_OIKOS_BLINDATE.rivestimenti[keyRiv]?.[luce] ||
                                  LISTINO_OIKOS_BLINDATE.rivestimenti[linea]?.[luce] || 0;
                dettaglio.rivestimenti += prezzoRiv;
                console.log(`   Riv EST: ${keyRiv} â†’ â‚¬${prezzoRiv}`);
                
                // Verniciatura esterni
                if (bld.rivestimentoEst.verniciatura) {
                    dettaglio.rivestimenti += LISTINO_OIKOS_BLINDATE.verniciaturaEst || 0;
                }
            }
            
            // ğŸ†• v7.98: IMBOTTI ESTERNO
            if (bld.imbotteEst && bld.imbotteEst !== '' && bld.imbotteEstAltezza && bld.imbotteEstLargh) {
                const tipoImbotte = bld.imbotteEst; // 'imbotte_cornici' o 'imbotte_solo'
                const altezza = bld.imbotteEstAltezza; // 'H1' o 'H2'
                const larghezza = bld.imbotteEstLargh; // 'L20', 'L25', 'L30', 'L35', 'L40'
                const essenza = bld.imbotteEstEssenza || 'tangMog';
                
                // Prezzo base imbotte
                const prezzoImbotte = LISTINO_OIKOS_BLINDATE.imbotti[tipoImbotte]?.[altezza]?.[larghezza] || 0;
                // Maggiorazione essenza
                const maggEssenza = LISTINO_OIKOS_BLINDATE.imbotti.essenze[essenza] || 0;
                
                dettaglio.imbotti = prezzoImbotte + maggEssenza;
                console.log(`   Imbotte: ${tipoImbotte} ${altezza}Ã—${larghezza} ${essenza} â†’ â‚¬${dettaglio.imbotti}`);
            }
            
            // ğŸ†• v7.98: CORNICI FERMA PANNELLO
            if (bld.corniciFermaPannello) {
                dettaglio.cornici += LISTINO_OIKOS_BLINDATE.cornici.fermaPannello[luce] || 0;
                console.log(`   Cornici ferma pannello: â‚¬${dettaglio.cornici}`);
            }
            
            // ğŸ†• v7.98: CORNICI INTERNE
            if (bld.corniciInt) {
                dettaglio.cornici += LISTINO_OIKOS_BLINDATE.cornici.interne[luce] || 0;
                console.log(`   Cornici interne: â‚¬${dettaglio.cornici}`);
            }
            
            // Optional: VETRO
            if (bld.vetro?.attivo && bld.vetro?.tipo) {
                const tipoVetro = bld.vetro.termico ? 
                    LISTINO_OIKOS_BLINDATE.vetroTermico : 
                    LISTINO_OIKOS_BLINDATE.vetroBlindato;
                const finitura = bld.vetro.finitura || 'trasparente';
                dettaglio.optional += tipoVetro[bld.vetro.tipo]?.[finitura] || 0;
            }
            
            // Optional: SOPRALUCE
            if (bld.sopraluce?.attivo && bld.sopraluce?.altezza) {
                dettaglio.optional += LISTINO_OIKOS_BLINDATE.sopraluce[bld.sopraluce.altezza]?.[luce] || 0;
                dettaglio.optional += LISTINO_OIKOS_BLINDATE.sopraluce.controtelaio[luce] || 0;
                if (bld.sopraluce.sabbiato) {
                    const sabKey = 'sabbiato_' + bld.sopraluce.altezza;
                    dettaglio.optional += LISTINO_OIKOS_BLINDATE.sopraluce[sabKey]?.[luce] || 0;
                }
            }
            
            // Optional: FIANCOLUCE
            if (bld.fiancoluce?.attivo) {
                const luceFL = luce === 'luce0' ? 'luce1' : luce;
                if (bld.fiancoluce.conVetro) {
                    dettaglio.optional += LISTINO_OIKOS_BLINDATE.fiancoluce.conVetro[luceFL] || 0;
                } else {
                    dettaglio.optional += LISTINO_OIKOS_BLINDATE.fiancoluce.senzaVetro[luceFL] || 0;
                }
                if (bld.fiancoluce.sabbiato) {
                    dettaglio.optional += LISTINO_OIKOS_BLINDATE.fiancoluce.sabbiato[luceFL] || 0;
                }
                if (bld.fiancoluce.colore && bld.fiancoluce.colore !== 'RAL8022') {
                    dettaglio.optional += LISTINO_OIKOS_BLINDATE.fiancoluce.colori[bld.fiancoluce.colore]?.[luceFL] || 0;
                }
            }
            
            // Totale
            const totale = dettaglio.prezzoBase + dettaglio.controtelaio + dettaglio.cilindro +
                          dettaglio.colore + dettaglio.acustica + dettaglio.termica +
                          dettaglio.kitAAV + dettaglio.rivestimenti + dettaglio.optional +
                          dettaglio.imbotti + dettaglio.cornici + dettaglio.maniglie + dettaglio.chiaviExtra;
            
            console.log(`ğŸ” Calcolo Oikos: Base â‚¬${dettaglio.prezzoBase} + CT â‚¬${dettaglio.controtelaio} + Cil â‚¬${dettaglio.cilindro} + Col â‚¬${dettaglio.colore} + Riv â‚¬${dettaglio.rivestimenti} + Imb â‚¬${dettaglio.imbotti} + Cor â‚¬${dettaglio.cornici} + Man â‚¬${dettaglio.maniglie} + Opt â‚¬${dettaglio.optional} = â‚¬${totale}`);
            
            return {
                totale: totale,
                dettaglio: dettaglio,
                luce: luce
            };
        }
        

        // ============================================================================
        // ğŸšª FERREROLEGNO PORTE INTERNE 2025 - Collezioni FL, Replica, Zero
        // ============================================================================
/**
 * FERREROLEGNO DATABASE 2025
 * Porte Interne - Collezioni FL, Replica, Zero
 * 
 * ValiditÃƒÂ : 1 Aprile 2025
 * Sconto Installatore: 50%
 * 
 * STRUTTURA:
 * - FERREROLEGNO_CONFIG: Configurazione generale
 * - FERREROLEGNO_COLLEZIONI_FL: Collezioni standard legno/laccato
 * - FERREROLEGNO_REPLICA: Linea sintetica
 * - FERREROLEGNO_ZERO: Linea filo muro
 * - FERREROLEGNO_TELAI: Telai per ogni linea
 * - FERREROLEGNO_MAGGIORAZIONI: Supplementi comuni
 * - calcolaPrezzoFerreroLegno(): Funzione calcolo
 */

// =============================================================================
// CONFIGURAZIONE GENERALE
// =============================================================================

const FERREROLEGNO_CONFIG = {
    fornitore: "FerreroLegno S.p.A.",
    validita: "2025-04-01",
    scontoInstallatore: 0.50,
    ivaEsclusa: true,
    trasportoEscluso: true,
    
    // Dimensioni standard
    larghezzeStandard: [600, 650, 700, 750, 800, 850, 900],
    altezzeStandard: [2000, 2100],
    
    // Linee disponibili
    linee: ["COLLEZIONI_FL", "REPLICA", "ZERO"]
};

// =============================================================================
// COLLEZIONI FL - PREZZI ANTE
// =============================================================================

const FERREROLEGNO_COLLEZIONI_FL = {
    
    // EXIT / EXITLYNE
    EXIT: {
        nome: "EXIT",
        spessore: 44,
        tipologia: "tamburata_cristallo",
        finiture: {
            "grezzo_prefinito": { cieca: 327, vetro: null },
            "iride": { cieca: 552, vetro: 1063 },
            "natural_touch_rovere": { cieca: 582, vetro: 1095 },
            "natural_touch_noce": { cieca: 592, vetro: 1105 },
            "ultralucido_base": { cieca: 906, vetro: 1451 },
            "ultralucido_cartella": { cieca: 1105, vetro: 1648 }
        }
    },
    
    EXITLYNE: {
        nome: "EXITLYNE",
        spessore: 44,
        tipologia: "tamburata_cristallo",
        finiture: {
            "iride": { cieca: 533, vetro: 1047 },
            "natural_touch_rovere": { cieca: 563, vetro: 1079 },
            "natural_touch_noce": { cieca: 573, vetro: 1089 }
        }
    },
    
    // EQUA
    EQUA: {
        nome: "EQUA",
        spessore: 44,
        tipologia: "tamburata",
        finiture: {
            "blond_tanganika": { cieca: 436, con_1: 578, vetro: 981 },
            "noce_nazionale": { cieca: 491, con_1: 633, vetro: 1036 },
            "opaco_base": { cieca: 361, con_1: 503, vetro: 983 },
            "opaco_ral": { cieca: 417, con_1: 559, vetro: 1040 },
            "ultraopaco_base": { cieca: 381, con_1: 523, vetro: 1003 },
            "ultraopaco_cartella": { cieca: 437, con_1: 579, vetro: 1060 },
            "trame_base": { cieca: 522, con_1: 664, vetro: 1068 },
            "trame_ral": { cieca: 577, con_1: 719, vetro: 1123 }
        }
    },
    
    EQUA_STYLA: {
        nome: "EQUA STYLA",
        spessore: 44,
        tipologia: "tamburata",
        finiture: {
            "opaco_base": { cieca: 520 },
            "opaco_ral": { cieca: 576 },
            "ultraopaco_base": { cieca: 540 },
            "ultraopaco_cartella": { cieca: 596 }
        }
    },
    
    // NOVA
    NOVA: {
        nome: "NOVA",
        spessore: 44,
        tipologia: "tamburata",
        finiture: {
            "blond_tanganika": { cieca: 266, supernova: 354, vetro: 553 },
            "noce_nazionale": { cieca: 362, supernova: 450, vetro: 649 },
            "opaco_base": { cieca: 300, vetro: 583 },
            "opaco_ral": { cieca: 417, vetro: 704 }
        }
    },
    
    // GLASS
    GLASS: {
        nome: "GLASS",
        spessore: 44,
        tipologia: "tamburata_vetro",
        finiture: {
            "blond_tanganika": { satinato: 844, fronte_retro: 892, decorato: 904, bolla: 944 },
            "noce_nazionale": { satinato: 885, fronte_retro: 933, decorato: 945, bolla: 985 },
            "opaco_base": { satinato: 873, fronte_retro: 921, decorato: 933, bolla: 973 },
            "opaco_ral": { satinato: 929, fronte_retro: 977, decorato: 989, bolla: 1029 },
            "ultraopaco_base": { satinato: 894, fronte_retro: 942, decorato: 954, bolla: 994 },
            "trame_base": { satinato: 935, fronte_retro: 983, decorato: 995, bolla: 1035 },
            "iride": { satinato: 974, fronte_retro: 1022, decorato: 1034, bolla: 1074 }
        }
    },
    
    // INTAGLIO
    INTAGLIO: {
        nome: "INTAGLIO",
        spessore: 44,
        tipologia: "pantografata",
        modelli: ["0", "0_vetro", "1", "2", "4", "8", "10"],
        finiture: {
            "blond_tanganika": { "0": 632, "0_vetro": 721, "1": 600, "2": 632, "4": 684, "8": 655 },
            "noce_nazionale": { "0": 672, "0_vetro": 782, "1": 663, "2": 672, "4": 743, "8": 703 },
            "opaco_base": { "0": 472, "0_vetro": 651, "1": 472, "2": 472, "4": 613, "8": 472 },
            "ultraopaco_base": { "0": 492, "0_vetro": 671, "1": 492, "2": 492, "4": 633, "8": 492 },
            "trame_base": { "0": 716, "0_vetro": 836, "1": 712, "2": 716, "4": 797, "8": 740 }
        }
    },
    
    // PLISSÃƒË†
    PLISSE: {
        nome: "PLISSÃƒË†",
        spessore: 44,
        tipologia: "tamburata",
        finiture: {
            "opaco_base": { cieca: 423 },
            "opaco_ral": { cieca: 480 },
            "ultraopaco_base": { cieca: 443 },
            "ultraopaco_cartella": { cieca: 500 }
        }
    },
    
    // SUITE
    SUITE: {
        nome: "SUITE",
        spessore: 44,
        tipologia: "tamburata",
        modelli: ["4_6", "9", "10", "21_22_27"],
        finiture: {
            "opaco_base": { "4_6": 403, "9": 457, "10": 500, "21_22_27": 423 },
            "opaco_ral": { "4_6": 458, "9": 512, "10": 557, "21_22_27": 480 },
            "ultraopaco_base": { "4_6": 423, "9": 477, "10": 520, "21_22_27": 443 },
            "ultraopaco_cartella": { "4_6": 478, "9": 532, "10": 577, "21_22_27": 500 },
            "trame_base": { "21_22_27": 553 },
            "trame_ral": { "21_22_27": 609 }
        }
    },
    
    // MIXY
    MIXY: {
        nome: "MIXY",
        spessore: 44,
        tipologia: "tamburata",
        finiture: {
            "opaco_base": { cieca: 367, predisposta_cristallo: 486 },
            "opaco_ral": { cieca: 423, predisposta_cristallo: 540 },
            "ultraopaco_base": { cieca: 387, predisposta_cristallo: 506 },
            "ultraopaco_cartella": { cieca: 443, predisposta_cristallo: 560 }
        }
    },
    
    // YNCISA
    YNCISA: {
        nome: "YNCISA",
        spessore: 44,
        tipologia: "tamburata",
        finiture: {
            "opaco_base": { cieca: 414, con_cristallo: 532 },
            "opaco_ral": { cieca: 470, con_cristallo: 588 },
            "ultraopaco_base": { cieca: 434, con_cristallo: 552 },
            "ultraopaco_cartella": { cieca: 490, con_cristallo: 608 }
        }
    },
    
    // KÃƒâ€°VIA
    KEVIA: {
        nome: "KÃƒâ€°VIA",
        spessore: 44,
        tipologia: "pantografata",
        finiture: {
            "opaco_base": { cieca: 403, con_cristallo: 521 },
            "opaco_ral": { cieca: 458, con_cristallo: 576 },
            "ultraopaco_base": { cieca: 423, con_cristallo: 541 }
        }
    },
    
    // CLASSICHE
    DIVA: {
        nome: "DIVA",
        spessore: 44,
        tipologia: "pantografata",
        finiture: {
            "opaco_base": { cieca: 563 },
            "opaco_ral": { cieca: 618 },
            "patinato_bianco": { cieca: 678 },
            "patinato_crema": { cieca: 678 }
        }
    },
    
    EPOCA: {
        nome: "EPOCA",
        spessore: 44,
        tipologia: "pantografata",
        finiture: {
            "opaco_base": { cieca: 563 },
            "opaco_ral": { cieca: 618 },
            "patinato_bianco": { cieca: 678 },
            "patinato_crema": { cieca: 678 }
        }
    }
};

// =============================================================================
// REPLICA - PREZZI ANTE
// =============================================================================

const FERREROLEGNO_REPLICA = {
    
    // LISS
    LISS: {
        nome: "LISS",
        tipologia: "liscia_sintetica",
        finiture: {
            "bianco_grigio_lino": { 
                liss: 173, liss_1: 245, liss_4: 296, liss_90: 296,
                vetro_sat: 427, vetro_fr: 469, vetro_point: 615, vetro_strip: 615
            },
            "noce": { 
                liss: 168, liss_1: 240, liss_4: 291, liss_90: 291,
                vetro_sat: 422, vetro_fr: 464, vetro_point: 610, vetro_strip: 610
            },
            "grafis": { 
                liss: 205, liss_1: 277, liss_4: 328, liss_90: 328,
                vetro_sat: 459, vetro_fr: 501, vetro_point: 647, vetro_strip: 647
            },
            "materic_ontario": { 
                liss: 230, liss_1: 302, liss_4: 353, liss_90: 353,
                vetro_sat: 484, vetro_fr: 526, vetro_point: 672, vetro_strip: 672
            }
        }
    },
    
    // LISS VETRO LARGE
    LISS_VETRO_LARGE: {
        nome: "LISS VETRO LARGE",
        tipologia: "vetro_grande",
        finiture: {
            "bianco_grigio_lino": { satinato: 636, fronte_retro: 684, decorato: 693, graffio: 782, bolla: 782 },
            "noce": { satinato: 621, fronte_retro: 669, decorato: 678, graffio: 767, bolla: 767 },
            "grafis": { satinato: 634, fronte_retro: 682, decorato: 691, graffio: 780, bolla: 780 },
            "materic_ontario": { satinato: 662, fronte_retro: 710, decorato: 719, graffio: 808, bolla: 808 }
        }
    },
    
    // LOGICA
    LOGICA: {
        nome: "LOGICA",
        tipologia: "pantografata_sintetica",
        finiture: {
            "grafis": { 
                logica: 223, logica_1: 295, logica_4: 346, logica_90: 346,
                vetro_sat: 477, vetro_fr: 519, vetro_point: 665, vetro_strip: 665
            },
            "materic_ontario": { 
                logica: 249, logica_1: 321, logica_4: 372, logica_90: 372,
                vetro_sat: 503, vetro_fr: 545, vetro_point: 691, vetro_strip: 691
            }
        }
    },
    
    // TRATTO / SEGNI
    TRATTO: {
        nome: "TRATTO",
        tipologia: "pantografata_sintetica",
        finiture: {
            "materic": { cieca: 394 },
            "ontario": { cieca: 394 }
        }
    },
    
    SEGNI: {
        nome: "SEGNI",
        tipologia: "pantografata_sintetica",
        finiture: {
            "materic": { cieca: 394 },
            "ontario": { cieca: 394 }
        }
    },
    
    // AREA
    AREA: {
        nome: "AREA",
        tipologia: "pannelletti",
        finiture: {
            "bianco": { cieca: 475, satinato: 567, fronte_retro: 617, decorato: 644, bolla: 723, graffio: 723 },
            "noce": { cieca: 461, satinato: 553, fronte_retro: 603, decorato: 630, bolla: 709, graffio: 709 },
            "grafis": { cieca: 475, satinato: 567, fronte_retro: 617, decorato: 644, bolla: 723, graffio: 723 },
            "materic_ontario": { cieca: 490, satinato: 582, fronte_retro: 632, decorato: 659, bolla: 738, graffio: 738 }
        }
    },
    
    // AREA/31 SIMPLY
    AREA_31_SIMPLY: {
        nome: "AREA/31 SIMPLY",
        tipologia: "pannelletti_simply",
        finiture: {
            "bianco": { lisci: 360, satinato: 506, fronte_retro: 556, decorato: 583, bolla: 662, graffio: 662 },
            "noce": { lisci: 351, satinato: 497, fronte_retro: 547, decorato: 574, bolla: 653, graffio: 653 },
            "grafis": { lisci: 398, satinato: 544, fronte_retro: 594, decorato: 621, bolla: 700, graffio: 700 },
            "materic_ontario": { lisci: 414, satinato: 560, fronte_retro: 610, decorato: 637, bolla: 716, graffio: 716 }
        }
    },
    
    // FORMA
    FORMA: {
        nome: "FORMA",
        tipologia: "sagomata",
        finiture: {
            "bianco": { pannelletto: 375, satinato: 491, fronte_retro: 541, decorato: 572 },
            "noce": { pannelletto: 364, satinato: 480, fronte_retro: 530, decorato: 561 },
            "rovere_gold": { pannelletto: 439, satinato: 555, fronte_retro: 605, decorato: 636 }
        }
    }
};

// =============================================================================
// REPLICA - TELAI
// =============================================================================

const FERREROLEGNO_TELAI_REPLICA = {
    
    FLAT: {
        nome: "FLAT",
        tipo: "complanare",
        spessori: [75, 100],
        finiture: {
            "bianco_grigio_lino": { pivot: 308, scomparsa: 333 },
            "grafis_bianco": { pivot: 314, scomparsa: 339 },
            "materic": { pivot: 314, scomparsa: 339 },
            "ontario": { pivot: 314, scomparsa: 339 },
            "rovere_gold": { pivot: 314, scomparsa: 339 }
        }
    },
    
    GENIUS_ELEVA: {
        nome: "GENIUS ELEVA",
        tipo: "standard",
        spessori: [75, 100],
        finiture: {
            "bianco_grigio_lino": { anuba: 161, pivot: 191 },
            "noce": { anuba: 157, pivot: 187 },
            "grafis_bianco": { anuba: 193, pivot: 223 },
            "grafis_beige_moka": { anuba: 193, pivot: 223 },
            "materic": { anuba: 208, pivot: null },
            "ontario": { anuba: 208, pivot: null },
            "rovere_gold": { anuba: 208, pivot: 238 }
        }
    },
    
    OVAL_ELEVA: {
        nome: "OVAL ELEVA",
        tipo: "standard_stondato",
        spessori: [80, 100],
        finiture: {
            "bianco_grigio_lino": { anuba: 182, pivot: 212 },
            "noce": { anuba: 177, pivot: 207 },
            "grafis_bianco": { anuba: 212, pivot: 242 },
            "grafis_beige_moka": { anuba: 212, pivot: 242 },
            "rovere_gold": { anuba: 227, pivot: 257 }
        }
    }
};

// =============================================================================
// ZERO - PREZZI ANTE
// =============================================================================

const FERREROLEGNO_ZERO = {
    
    // EXIT ZERO
    EXIT_ZERO: {
        nome: "EXIT ZERO",
        tipologia: "filo_muro",
        finiture: {
            "grezzo_prefinito": { cieca: 327 },
            "iride": { cieca: 587 },
            "natural_touch_rovere": { cieca: 595 },
            "natural_touch_noce": { cieca: 605 },
            "ultralucido_base": { cieca: 906 },
            "ultralucido_cartella": { cieca: 1105 }
        }
    },
    
    // EXITLYNE ZERO
    EXITLYNE_ZERO: {
        nome: "EXITLYNE ZERO",
        tipologia: "filo_muro",
        finiture: {
            "iride": { cieca: 568 },
            "natural_touch_rovere": { cieca: 576 },
            "natural_touch_noce": { cieca: 586 }
        }
    },
    
    // EQUA ZERO
    EQUA_ZERO: {
        nome: "EQUA ZERO",
        tipologia: "filo_muro",
        finiture: {
            "opaco_base": { cieca: 396 },
            "opaco_ral": { cieca: 452 },
            "ultraopaco_base": { cieca: 416 },
            "ultraopaco_cartella": { cieca: 472 },
            "trame_base": { cieca: 557 },
            "trame_ral": { cieca: 612 }
        }
    },
    
    // SUITE ZERO
    SUITE_ZERO: {
        nome: "SUITE ZERO",
        tipologia: "filo_muro",
        modelli: ["21", "22", "27"],
        finiture: {
            "opaco_base": { cieca: 423 },
            "opaco_ral": { cieca: 480 },
            "ultraopaco_base": { cieca: 443 },
            "ultraopaco_cartella": { cieca: 500 },
            "trame_base": { cieca: 553 }
        }
    },
    
    // MIXY ZERO
    MIXY_ZERO: {
        nome: "MIXY ZERO",
        tipologia: "filo_muro",
        finiture: {
            "opaco_base": { cieca: 367 },
            "opaco_ral": { cieca: 423 },
            "ultraopaco_base": { cieca: 387 },
            "ultraopaco_cartella": { cieca: 443 }
        }
    },
    
    // YNCISA ZERO
    YNCISA_ZERO: {
        nome: "YNCISA ZERO",
        tipologia: "filo_muro",
        finiture: {
            "opaco_base": { cieca: 414 },
            "opaco_ral": { cieca: 469 },
            "ultraopaco_base": { cieca: 434 },
            "ultraopaco_cartella": { cieca: 489 }
        }
    },
    
    // LOGICA ZERO
    LOGICA_ZERO: {
        nome: "LOGICA ZERO",
        tipologia: "filo_muro",
        finiture: {
            "materic": { cieca: 249 },
            "ontario": { cieca: 249 }
        }
    },
    
    // PLISSE ZERO
    PLISSE_ZERO: {
        nome: "PLISSÃƒË† ZERO",
        tipologia: "filo_muro",
        finiture: {
            "opaco_base": { cieca: 423 },
            "opaco_ral": { cieca: 480 },
            "ultraopaco_base": { cieca: 443 },
            "ultraopaco_cartella": { cieca: 500 }
        }
    }
};

// =============================================================================
// ZERO - TELAI A_FILO
// =============================================================================

const FERREROLEGNO_TELAI_ZERO = {
    
    A_FILO: {
        nome: "A_FILO",
        materiale: "alluminio",
        prezzi: {
            70: 506,
            100: 540,
            125: 582
        }
    },
    
    CONCEPT: {
        nome: "CONCEPT",
        materiale: "alluminio",
        prezzi: {
            100: 677
        }
    },
    
    maggiorazioni: {
        telaio_doppio: 327,
        telaio_muratura: 27  // zanche + rete porta intonaco
    }
};

// =============================================================================
// ZERO - BASIC ZERO (Vetro Temperato 8mm)
// =============================================================================

const FERREROLEGNO_BASIC_ZERO = {
    
    nome: "BASIC ZERO",
    tipologia: "vetro_temperato_8mm",
    
    // Prezzi per fascia altezza
    prezziPerAltezza: {
        "2000-2049": {
            trasparente: 680,
            satinato: 752,
            grigio_bronzo: 752,
            extrachiaro: 824,
            decorato: 1060
        },
        "2050-2100": {
            trasparente: 714,
            satinato: 790,
            grigio_bronzo: 790,
            extrachiaro: 866,
            decorato: 1113
        },
        "2101-2249": {
            trasparente: 812,
            satinato: 897,
            grigio_bronzo: 897,
            extrachiaro: 984,
            decorato: 1264
        },
        "2250-2449": {
            trasparente: 896,
            satinato: 978,
            grigio_bronzo: 1069,
            extrachiaro: 1216,
            decorato: 1609
        },
        "2450-2700": {
            trasparente: 896,
            satinato: 978,
            grigio_bronzo: 1069,
            extrachiaro: 1297,
            decorato: 1751
        }
    },
    
    // Maniglie
    maniglie: {
        ponte_alluminio: 140,
        ponte_laccato: 150,
        vitra_senza_foro_cromo: 215,
        vitra_senza_foro_laccato: 225,
        vitra_yale_cromo: 325,
        vitra_yale_laccato: 335,
        vitra_nottolino_cromo: 360,
        vitra_nottolino_laccato: 370,
        pomax_tonda: 164
    }
};

// =============================================================================
// ZERO - FRAME ZERO (Vetro Temperato 6mm con profilo)
// =============================================================================

const FERREROLEGNO_FRAME_ZERO = {
    
    nome: "FRAME ZERO",
    tipologia: "vetro_temperato_6mm_profilo",
    spessoreVetro: "6mm filtrante / 3+3mm coprente",
    
    // Prezzi per fascia altezza e larghezza
    // Larghezze: 600-850, 900-1000, 1050-1200
    prezziPerAltezza: {
        "2000-2049": {
            trasparente_bianco: { "600-850": 758, "900-1000": 799, "1050-1200": 855 },
            satinato_bianco: { "600-850": 852, "900-1000": 910, "1050-1200": 987 },
            grigio_bronzo: { "600-850": 927, "900-1000": 998, "1050-1200": 1093 },
            extrachiaro: { "600-850": 1048, "900-1000": 1143, "1050-1200": 1267 },
            decorato: { "600-850": 1142, "900-1000": 1251, "1050-1200": 1397 }
        },
        "2050-2100": {
            trasparente_bianco: { "600-850": 797, "900-1000": 840, "1050-1200": 899 },
            satinato_bianco: { "600-850": 897, "900-1000": 958, "1050-1200": 1039 },
            grigio_bronzo: { "600-850": 975, "900-1000": 1050, "1050-1200": 1150 },
            extrachiaro: { "600-850": 1103, "900-1000": 1203, "1050-1200": 1335 },
            decorato: { "600-850": 1202, "900-1000": 1316, "1050-1200": 1470 }
        },
        "2101-2249": {
            trasparente_bianco: { "600-850": 834, "900-1000": 878, "1050-1200": 939 },
            satinato_bianco: { "600-850": 938, "900-1000": 1002, "1050-1200": 1086 },
            grigio_bronzo: { "600-850": 1019, "900-1000": 1097, "1050-1200": 1202 },
            extrachiaro: { "600-850": 1153, "900-1000": 1258, "1050-1200": 1396 },
            decorato: { "600-850": 1257, "900-1000": 1376, "1050-1200": 1537 }
        },
        "2250-2449": {
            trasparente_bianco: { "600-850": 870, "900-1000": 918, "1050-1200": 980 },
            satinato_bianco: { "600-850": 977, "900-1000": 1044, "1050-1200": 1132 },
            grigio_bronzo: { "600-850": 1062, "900-1000": 1143, "1050-1200": 1253 },
            lucido_nero: { "600-850": 1142, "900-1000": 1238, "1050-1200": 1365 },
            riflettente: { "600-850": 1142, "900-1000": 1238, "1050-1200": 1365 },
            extrachiaro: { "600-850": 1236, "900-1000": 1349, "1050-1200": 1498 },
            satinato_nero: { "600-850": 1330, "900-1000": 1459, "1050-1200": 1629 },
            decorato_bit03: { "600-850": 1686, "900-1000": 1878, "1050-1200": 2132 },
            milky: { "600-850": 938, "900-1000": 995, "1050-1200": 1074 },
            lucido_colori: { "600-850": 1236, "900-1000": 1349, "1050-1200": 1498 },
            specchio_smoke_bronze: { "600-850": 1461, "900-1000": 1613, "1050-1200": 1814 }
        },
        "2450-2749": {
            trasparente_bianco: { "600-850": 895, "900-1000": 945, "1050-1200": 1012 },
            satinato_bianco: { "600-850": 1009, "900-1000": 1078, "1050-1200": 1169 },
            grigio_bronzo: { "600-850": 1097, "900-1000": 1181, "1050-1200": 1294 },
            lucido_nero: { "600-850": 1201, "900-1000": 1310, "1050-1200": 1453 },
            riflettente: { "600-850": 1201, "900-1000": 1310, "1050-1200": 1453 },
            extrachiaro: { "600-850": 1309, "900-1000": 1434, "1050-1200": 1603 },
            satinato_nero: { "600-850": 1414, "900-1000": 1560, "1050-1200": 1754 },
            decorato_bit03: { "600-850": 1808, "900-1000": 2022, "1050-1200": 2309 },
            milky: { "600-850": 977, "900-1000": 1044, "1050-1200": 1132 },
            lucido_colori: { "600-850": 1310, "900-1000": 1435, "1050-1200": 1604 },
            specchio_smoke_bronze: { "600-850": 1563, "900-1000": 1723, "1050-1200": 1946 }
        }
    },
    
    // Telai specifici FRAME ZERO
    telai: {
        A_FILO_70: 591,
        A_FILO_100: 625,
        A_FILO_125: 667,
        muratura: 27
    },
    
    // Cristalli disponibili
    cristalli: [
        "trasparente", "satinato", "satinato_fronte_retro", "riflettente",
        "lucido_nero", "segni", "point", "strip", "textil", "bit03",
        "chillout", "flutes", "milky", "lucido_colori", "satinato_colori", "specchio"
    ]
};

// =============================================================================
// ZERO - PREMIUM ZERO (Vetro Sicurezza 3mm bifacciale)
// =============================================================================

const FERREROLEGNO_PREMIUM_ZERO = {
    
    nome: "PREMIUM ZERO",
    tipologia: "vetro_sicurezza_3mm_bifacciale",
    spessoreAnta: 44,
    spessoreVetro: "3mm + 3mm (bifacciale)",
    
    // Prezzi per fascia altezza
    // Larghezze: 600-850, 900-1000
    prezziPerAltezza: {
        "1400-2200": {
            lucido_base: { "600-850": 1222, "900-1000": 1393 },        // Black/Antracite/Ginger/Red/Beige/White
            specchio_classic: { "600-850": 1222, "900-1000": 1393 },
            satinato: { "600-850": 1441, "900-1000": 1626 },           // Black/Antracite/Ginger/Silver/White/Blue
            lucido_pearl_blue: { "600-850": 1441, "900-1000": 1626 },
            specchio_smoke_bronze: { "600-850": 1441, "900-1000": 1626 },
            bicolore: { "600-850": 1441, "900-1000": 1626 }            // escluso Ginger
        },
        "2201-2400": {
            lucido_base: { "600-850": 1296, "900-1000": 1549 },
            specchio_classic: { "600-850": 1296, "900-1000": 1549 },
            satinato: { "600-850": 1533, "900-1000": 1798 },
            lucido_pearl_blue: { "600-850": 1533, "900-1000": 1798 },
            specchio_smoke_bronze: { "600-850": 1533, "900-1000": 1798 },
            bicolore: { "600-850": 1533, "900-1000": 1798 }
        },
        "2401-2700": {
            lucido_base: { "600-850": 1432, "900-1000": 1722 },
            specchio_classic: { "600-850": 1432, "900-1000": 1722 },
            satinato: { "600-850": 1643, "900-1000": 1962 },
            lucido_pearl_blue: { "600-850": 1643, "900-1000": 1962 },
            specchio_smoke_bronze: { "600-850": 1643, "900-1000": 1962 },
            bicolore: { "600-850": 1643, "900-1000": 1962 }
        },
        "2701-2900": {
            lucido_base: { "600-850": 1709, "900-1000": 1801 },
            specchio_classic: { "600-850": 1709, "900-1000": 1801 },
            satinato: { "600-850": 1980, "900-1000": 2116 },
            lucido_pearl_blue: { "600-850": 1980, "900-1000": 2116 },
            specchio_smoke_bronze: { "600-850": 1980, "900-1000": 2116 },
            bicolore: { "600-850": 1980, "900-1000": 2116 }
        }
    },
    
    // Maggiorazioni laccatura profilo
    laccaturaProfilo: {
        "1400-2200": { bianco_base: 150, metallizzato: 265 },
        "2201-2400": { bianco_base: 160, metallizzato: 280 },
        "2401-2700": { bianco_base: 170, metallizzato: 295 },
        "2701-2900": { bianco_base: 180, metallizzato: 310 }
    },
    
    // Maggiorazioni laccatura CONCEPT
    laccaturaConceptProfilo: {
        "1400-2200": { bianco_base: 80, metallizzato: 110 },
        "2201-2450": { bianco_base: 90, metallizzato: 125 },
        "2451-2700": { bianco_base: 100, metallizzato: 140 },
        "2701-2900": { bianco_base: 110, metallizzato: 155 }
    },
    
    // Telai Premium Zero (stessi di ZERO standard)
    telai: {
        A_FILO_70: 506,
        A_FILO_100: 540,
        A_FILO_125: 582,
        CONCEPT_100: 677,
        muratura: 27
    },
    
    // Colori vetro disponibili
    coloriLucido: ["Black", "Antracite", "Ginger", "Red", "Beige", "White", "Pearl", "Blue"],
    coloriSatinato: ["Black", "Antracite", "Ginger", "Silver", "White", "Blue"],
    coloriSpecchio: ["Classic", "Smoke", "Bronze"],
    
    // Note
    note: "NO ANTE DOPPIE per Premium Zero"
};

// =============================================================================
// MAGGIORAZIONI COMUNI
// =============================================================================

const FERREROLEGNO_MAGGIORAZIONI = {
    
    // Dimensioni
    dimensioni: {
        larghezza: {
            standard: [600, 650, 700, 750, 800, 850, 900],
            fuori_standard_50: { range: [500, 550, 950, 1000, 1050, 1100, 1150, 1200], perc: 0.50 }
        },
        altezza: {
            standard: [2000, 2100],
            fuori_standard_15: { range_min: 1950, range_max: 2200, perc: 0.15 },  // escluso 2000-2100
            fuori_standard_50: { ranges: [[1400, 1949], [1750, 1900], [2250, 2400]], perc: 0.50 },
            fuori_standard_55: { range_min: 2401, range_max: 2600, perc: 0.55 },
            fuori_standard_60: { range_min: 2601, range_max: 2900, perc: 0.60 }
        }
    },
    
    // Versioni battente
    battente: {
        specchio_sicurezza_4mm: 500,  // su 1 lato
        cappucci_copricerniera: 23,    // per telaio
        serratura_yale: 55,
        serratura_yale_passepartout: 95
    },
    
    // Versioni scorrevole
    scorrevole: {
        rolling_scrighi_con_serratura: 150,
        rolling_scrighi_senza_serratura: 130,
        rolling_scrighi_senza_nulla: 110,
        rolling_prima_con_serratura: 545,
        rolling_prima_senza_serratura: 465,
        rolling_prima_senza_nulla: 440,
        rolling_magic_completo: 510,
        rolling_magic_senza_nulla: 485,
        essential_syntesis_con_serratura: 225,
        essential_syntesis_senza_serratura: 205,
        essential_syntesis_senza_nulla: 185,
        maniglia_quadra: 15,
        serratura_yale: 55,
        fermo_soft_monolaterale: 60,
        fermo_soft_bilaterale: 90,
        esclusione_cassonetto: -295
    },
    
    // Pieghevoli
    pieghevoli: {
        modula_ferramenta: 420,
        indue_ferramenta: 445,
        fold_90_ferramenta_anta: 570,
        fold_90_ferramenta_telaio: 120,
        fold_180_ferramenta_anta: 590,
        fold_180_ferramenta_telaio: 120,
        telaio_doppio_replica: 85,
        telaio_doppio_zero: 327,
        anta_semifissa_wave: 110
    },
    
    // Maniglie
    maniglie: {
        wave_senza_foro: 110,
        wave_nottolino: 130,
        quadra: 15,
        rettangolare: 30
    }
};

// =============================================================================
// BEST SELLER - SOLUZIONI COMPLETE
// =============================================================================

const FERREROLEGNO_BEST_SELLER = {
    
    // REPLICA Best Seller
    REPLICA: {
        "LISS_bianco_genius_anuba": { anta: 173, telaio: 161, totale: 334 },
        "LISS_bianco_flat_pivot": { anta: 173, telaio: 308, totale: 481 },
        "LISS_grafis_genius_anuba": { anta: 205, telaio: 193, totale: 398 },
        "LOGICA_grafis_genius_anuba": { anta: 223, telaio: 193, totale: 416 },
        "LOGICA_materic_genius_anuba": { anta: 249, telaio: 208, totale: 457 },
        "AREA_grafis_genius_anuba": { anta: 475, telaio: 193, totale: 668 }
    },
    
    // ZERO Best Seller
    ZERO: {
        "EXIT_grezzo_afilo_100": { anta: 327, telaio: 540, totale: 867 },
        "EQUA_opaco_afilo_100": { anta: 396, telaio: 540, totale: 936 },
        "EQUA_ultraopaco_afilo_100": { anta: 416, telaio: 540, totale: 956 },
        "EXITLYNE_iride_afilo_100": { anta: 568, telaio: 540, totale: 1108 },
        "MIXY_opaco_afilo_100": { anta: 367, telaio: 540, totale: 907 },
        "YNCISA_opaco_afilo_100": { anta: 414, telaio: 540, totale: 954 },
        "LOGICA_materic_afilo_100": { anta: 249, telaio: 540, totale: 789 }
    }
};

// =============================================================================
// FUNZIONE CALCOLO PREZZO
// =============================================================================

/**
 * Calcola prezzo porta FerreroLegno
 * @param {Object} config - Configurazione porta
 * @returns {Object} - Dettaglio prezzi
 */
function calcolaPrezzoFerreroLegno(config) {
    const {
        linea = "COLLEZIONI_FL",     // COLLEZIONI_FL, REPLICA, ZERO
        collezione,                   // es. "EXIT", "LISS", "EQUA_ZERO"
        modello = "cieca",            // cieca, vetro, liss_4, etc.
        finitura,                     // es. "opaco_base", "grafis"
        telaio,                       // es. "GENIUS_ELEVA", "A_FILO"
        telaioSpessore = 100,         // mm
        telaioFinitura,               // finitura telaio
        telaioCerniera = "anuba",     // anuba, pivot, scomparsa
        larghezza = 800,              // mm
        altezza = 2100,               // mm
        versione = "battente",        // battente, scorrevole, pieghevole
        opzioni = []                  // array opzioni aggiuntive
    } = config;
    
    let prezzoAnta = 0;
    let prezzoTelaio = 0;
    let prezzoOpzioni = 0;
    let maggiorazioneDim = 0;
    
    // Recupera prezzo anta in base alla linea
    let datiCollezione;
    if (linea === "COLLEZIONI_FL") {
        datiCollezione = FERREROLEGNO_COLLEZIONI_FL[collezione];
    } else if (linea === "REPLICA") {
        datiCollezione = FERREROLEGNO_REPLICA[collezione];
    } else if (linea === "ZERO") {
        datiCollezione = FERREROLEGNO_ZERO[collezione];
    }
    
    if (datiCollezione && datiCollezione.finiture[finitura]) {
        prezzoAnta = datiCollezione.finiture[finitura][modello] || 0;
    }
    
    // Recupera prezzo telaio
    if (linea === "REPLICA" && FERREROLEGNO_TELAI_REPLICA[telaio]) {
        const datiTelaio = FERREROLEGNO_TELAI_REPLICA[telaio];
        if (datiTelaio.finiture[telaioFinitura]) {
            prezzoTelaio = datiTelaio.finiture[telaioFinitura][telaioCerniera] || 0;
        }
    } else if (linea === "ZERO" && FERREROLEGNO_TELAI_ZERO[telaio]) {
        prezzoTelaio = FERREROLEGNO_TELAI_ZERO[telaio].prezzi[telaioSpessore] || 0;
    }
    
    // Calcola maggiorazione dimensioni
    const stdL = FERREROLEGNO_CONFIG.larghezzeStandard;
    const stdH = FERREROLEGNO_CONFIG.altezzeStandard;
    
    if (!stdL.includes(larghezza)) {
        maggiorazioneDim += 0.50;  // fuori standard larghezza
    }
    if (!stdH.includes(altezza)) {
        if (altezza >= 1950 && altezza <= 2200) {
            maggiorazioneDim += 0.15;
        } else {
            maggiorazioneDim += 0.50;
        }
    }
    
    // Calcola opzioni
    opzioni.forEach(opt => {
        if (FERREROLEGNO_MAGGIORAZIONI.battente[opt]) {
            prezzoOpzioni += FERREROLEGNO_MAGGIORAZIONI.battente[opt];
        } else if (FERREROLEGNO_MAGGIORAZIONI.scorrevole[opt]) {
            prezzoOpzioni += FERREROLEGNO_MAGGIORAZIONI.scorrevole[opt];
        } else if (FERREROLEGNO_MAGGIORAZIONI.pieghevoli[opt]) {
            prezzoOpzioni += FERREROLEGNO_MAGGIORAZIONI.pieghevoli[opt];
        } else if (FERREROLEGNO_MAGGIORAZIONI.maniglie[opt]) {
            prezzoOpzioni += FERREROLEGNO_MAGGIORAZIONI.maniglie[opt];
        }
    });
    
    // Calcoli finali
    const subtotale = prezzoAnta + prezzoTelaio + prezzoOpzioni;
    const totaleListino = subtotale * (1 + maggiorazioneDim);
    const totaleNetto = totaleListino * (1 - FERREROLEGNO_CONFIG.scontoInstallatore);
    
    return {
        linea,
        collezione,
        modello,
        finitura,
        dimensioni: { larghezza, altezza },
        prezzoAnta,
        prezzoTelaio,
        prezzoOpzioni,
        maggiorazioneDim: `${(maggiorazioneDim * 100).toFixed(0)}%`,
        subtotale,
        totaleListino: Math.round(totaleListino * 100) / 100,
        scontoInstallatore: `${FERREROLEGNO_CONFIG.scontoInstallatore * 100}%`,
        totaleNetto: Math.round(totaleNetto * 100) / 100
    };
}

// =============================================================================
// EXPORT
// =============================================================================


        console.log('âœ… FERREROLEGNO-DATABASE-2025 caricato');

        // ============================================================================
        // ğŸ”§ OLIVARI MANIGLIE 2025 - Listino NÂ°55
        // ============================================================================
/**
 * OLIVARI DATABASE 2025
 * Maniglie e Accessori - Listino NÃ‚Â°55 Gennaio 2025
 * 
 * SCONTO INSTALLATORE: 40% + 5% = 43% effettivo
 * Calcolo: 100 Ãƒâ€” 0.60 Ãƒâ€” 0.95 = 57.00 (netto 57%, sconto 43%)
 * 
 * NOTA: Aumento 4% previsto dal 01/01/2026
 * 
 * @version 1.0
 * @date 11/12/2025
 */

const OLIVARI_2025 = {
    
    // ==================== INFORMAZIONI GENERALI ====================
    info: {
        nome: "OLIVARI",
        listino: "NÃ‚Â°55",
        anno: "Gennaio 2025",
        sconto_1: 0.40,
        sconto_2: 0.05,
        sconto_effettivo: 0.43,  // 1 - (0.60 Ãƒâ€” 0.95) = 0.43
        tipo: "maniglie",
        materiale: "Ottone",
        produzione: "Made in Italy dal 1911",
        minimo_ordine: 250,  // Ã¢â€šÂ¬ Italia
        validita: "31/12/2025",
        note: "Prezzi per coppia (maniglie/pomoli) o pezzo (cremonesi/DK)"
    },

    // ==================== FINITURE ====================
    finiture: {
        // CROMO - Garanzia 10 anni
        CR: { nome: "Cromo lucido", codice: "CR", garanzia: 10, maggiorazione: 0 },
        CO: { nome: "Cromo satinato", codice: "CO", garanzia: 10, maggiorazione: 0.09 },
        
        // SUPERFINISHÃ‚Â® - Garanzia 30 anni
        ZL: { nome: "SuperOro lucido", codice: "ZL", garanzia: 30, maggiorazione: 0.22 },
        TS: { nome: "SuperOro satinato", codice: "TS", garanzia: 30, maggiorazione: 0.27 },
        NL: { nome: "SuperNichel lucido", codice: "NL", garanzia: 30, maggiorazione: 0.22 },
        NS: { nome: "SuperNichel satinato", codice: "NS", garanzia: 30, maggiorazione: 0.27 },
        IS: { nome: "SuperInox satinato", codice: "IS", garanzia: 30, maggiorazione: 0.21 },
        
        // SUPERFINISHÃ‚Â® - Garanzia 10 anni
        RS: { nome: "SuperRame satinato", codice: "RS", garanzia: 10, maggiorazione: 0.33 },
        DS: { nome: "SuperBronzo satinato", codice: "DS", garanzia: 10, maggiorazione: 0.33 },
        US: { nome: "SuperAntracite satinato", codice: "US", garanzia: 10, maggiorazione: 0.28 },
        
        // ALTRI
        NP: { nome: "Nero opaco", codice: "NP", garanzia: 5, maggiorazione: -0.03 },
        BP: { nome: "Bianco opaco", codice: "BP", garanzia: 5, maggiorazione: -0.03 },
        
        // COMBINAZIONI
        CD: { nome: "Cromo lucido + bianco", codice: "CD", garanzia: 10, maggiorazione: -0.28 },
        MD: { nome: "Cromo satinato + bianco", codice: "MD", garanzia: 10, maggiorazione: -0.19 }
    },

    // ==================== MODELLI MANIGLIE ====================
    // Prezzi base in Cromo lucido (CR) per coppia
    // Formato: { rosette, verticali, placca, magnetica }
    maniglie: {
        // DESIGN ICONICI
        ABC: { codice: 255, designer: "OMA/Rem Koolhaas", rosette: 176.45, verticali: 176.45, placca: 236.45 },
        ADAMANT: { codice: 216, designer: "Patricia Urquiola", rosette: 222.60, verticali: 237.20, placca: 292.80 },
        AGATA: { codice: 116, designer: "Franco Albini/Franca Helg", rosette: 127.60, verticali: 142.90, placca: 198.10, magnetica: 148.65 },
        ALA: { codice: 215, designer: "Studio Olivari", rosette: 146.75, verticali: 162.05, placca: 217.25, magnetica: 167.80 },
        ALBA: { codice: 267, designer: "Studio Olivari", rosette: 231.90, verticali: 231.90, placca: 291.90 },
        ALEXANDRA: { codice: 150, designer: "Studio Olivari", rosette: 99.95, verticali: 115.25, placca: 170.45, magnetica: 121.00 },
        ARC: { codice: 225, designer: "Studio Olivari", rosette: 227.15, verticali: 227.15, placca: 287.00 },
        ASTER: { codice: 174, designer: "Studio Olivari", rosette: 158.10, verticali: 173.40, placca: 228.60, magnetica: 179.15 },
        ATENA_LIGNE: { codice: "1AL", designer: "Studio Olivari", rosette: 245.60, verticali: 245.60, placca: 305.60 },
        ATENA_PANIER: { codice: "1AP", designer: "Studio Olivari", rosette: 263.35, verticali: 263.35, placca: 323.35 },
        ATENA_RANK: { codice: "1AR", designer: "Studio Olivari", rosette: 291.95, verticali: 291.95, placca: 351.95 },
        AURELIA: { codice: 185, designer: "Studio Olivari", rosette: 163.40, verticali: 178.70, placca: 233.90, magnetica: 184.45 },
        AURORA: { codice: 164, designer: "Studio Olivari", rosette: 134.65, verticali: 134.65, placca: 194.50 },
        BAU: { codice: 263, designer: "Studio Olivari", rosette: 229.05, verticali: 229.05, placca: 288.90 },
        BEIJING: { codice: 208, designer: "Studio Olivari", rosette: 188.85, verticali: 188.85, placca: 248.85 },
        BETA: { codice: 221, designer: "Studio Olivari", rosette: 155.35, verticali: 155.35, placca: 215.20 },
        BIOS: { codice: 204, designer: "Studio Olivari", rosette: 154.80, verticali: 154.80, placca: 214.65 },
        BLADE: { codice: 213, designer: "Studio Olivari", rosette: 170.30, verticali: 170.30, placca: 230.15 },
        BOND: { codice: 163, designer: "Studio Olivari", rosette: 80.60, verticali: 95.90, placca: 151.10, magnetica: 101.65 },
        CHELSEA: { codice: 232, designer: "Studio Olivari", rosette: 150.05, verticali: 150.05, placca: 209.90 },
        CHEVRON: { codice: 248, designer: "Studio Olivari", rosette: 306.00, verticali: 306.00, placca: 366.00 },
        CHIARA: { codice: 125, designer: "Studio Olivari", rosette: 94.55, verticali: 109.85, placca: 165.05, magnetica: 115.60 },
        CLUB: { codice: 181, designer: "Studio Olivari", rosette: 100.40, verticali: 115.70, placca: 170.90, magnetica: 121.45 },
        COMET: { codice: 183, designer: "Studio Olivari", rosette: 120.40, verticali: 120.40, placca: 180.25 },
        CONCA: { codice: 236, designer: "Patricia Urquiola", rosette: 152.75, verticali: 152.75, placca: 212.60 },
        CONCA_L: { codice: 272, designer: "Patricia Urquiola", rosette: 204.55, verticali: 219.15, placca: 274.75 },
        CONO: { codice: 265, designer: "Luigi Caccia Dominioni", rosette: 131.70, verticali: 131.70, placca: 191.55 },
        CRYSTAL_DIAMOND: { codice: 246, designer: "Studio Olivari", rosette: 248.50, verticali: 248.50, placca: 308.35 },
        CRYSTALROYAL: { codice: 245, designer: "Studio Olivari", rosette: 255.60, verticali: 255.60, placca: 315.45 },
        DENVER: { codice: 218, designer: "Studio Olivari", rosette: 144.75, verticali: 144.75, placca: 204.60 },
        DIANA: { codice: 206, designer: "Studio Olivari", rosette: 137.35, verticali: 152.65, placca: 207.85, magnetica: 158.40 },
        DIANA_BARLEY: { codice: "1DB", designer: "Studio Olivari", rosette: 217.70, verticali: 232.30, placca: 287.90 },
        DIANA_CHEVRON: { codice: "1DC", designer: "Studio Olivari", rosette: 232.35, verticali: 246.95, placca: 302.55 },
        DIANA_DAMIER: { codice: "1DD", designer: "Studio Olivari", rosette: 227.60, verticali: 242.20, placca: 297.80 },
        DIVA: { codice: 256, designer: "Studio Olivari", rosette: 192.90, verticali: 192.90, placca: 252.75 },
        DOLCE_VITA: { codice: 243, designer: "Studio Olivari", rosette: 141.95, verticali: 141.95, placca: 201.80 },
        DYNAMIC: { codice: 261, designer: "Studio Olivari", rosette: 235.35, verticali: 235.35, placca: 295.35 },
        EMILIA: { codice: 167, designer: "Studio Olivari", rosette: 106.85, verticali: 122.15, placca: 177.35, magnetica: 127.90 },
        EUCLIDE: { codice: 229, designer: "Studio Olivari", rosette: 144.10, verticali: 144.10, placca: 203.95 },
        EUCLIDE_Q: { codice: 230, designer: "Studio Olivari", rosette: 185.40, verticali: 185.40, placca: 245.25 },
        FIN: { codice: 217, designer: "Studio Olivari", rosette: 131.25, verticali: 131.25, placca: 191.10 },
        FLAMINIA: { codice: 159, designer: "Studio Olivari", rosette: 107.40, verticali: 107.40, placca: 167.25 },
        FLUTE: { codice: 270, designer: "Studio Olivari", rosette: 116.95, verticali: 132.25, placca: 187.45, magnetica: 138.00 },
        FUTURA: { codice: 172, designer: "Studio Olivari", rosette: 121.05, verticali: 136.35, placca: 191.55, magnetica: 142.10 },
        GARDA: { codice: 105, designer: "Studio Olivari", rosette: 77.80, verticali: 93.10, placca: 148.30, magnetica: 98.85 },
        GLORIA: { codice: 268, designer: "Studio Olivari", rosette: 141.45, verticali: 141.45, placca: 201.45 },
        GLORIA_Q: { codice: 269, designer: "Studio Olivari", rosette: 146.05, verticali: 146.05, placca: 206.05 },
        GOLIA: { codice: 160, designer: "Studio Olivari", rosette: 112.00, verticali: 112.00, placca: 171.85 },
        HYBRID: { codice: 271, designer: "Studio Olivari", rosette: 126.45, verticali: 126.45, placca: 186.30 },  // cromo+bianco
        ICE_CUBE: { codice: 223, designer: "Studio Olivari", rosette: 266.60, verticali: null, placca: null },  // solo rosette
        ICONA: { codice: 254, designer: "Studio Olivari", rosette: 137.35, verticali: 152.65, placca: 207.85, magnetica: 158.40 },
        LAMA: { codice: 107, designer: "Studio Olivari", rosette: 123.85, verticali: 139.15, placca: 194.35, magnetica: 144.90 },
        LAMA_L: { codice: 106, designer: "Studio Olivari", rosette: 155.45, verticali: 163.75, placca: null },
        LASER: { codice: 176, designer: "Studio Olivari", rosette: 170.40, verticali: 178.70, placca: null },
        LINK: { codice: 200, designer: "Studio Olivari", rosette: 152.05, verticali: 160.35, placca: null },
        LIPSTICK: { codice: 273, designer: "Studio Olivari", rosette: 143.20, verticali: 151.50, placca: null },
        LIVING: { codice: 222, designer: "Studio Olivari", rosette: 134.95, verticali: 143.25, placca: null },
        LOGO_L: { codice: 198, designer: "Studio Olivari", rosette: 175.40, verticali: 183.70, placca: null },
        LOTUS: { codice: 238, designer: "Studio Olivari", rosette: 170.95, verticali: 179.25, placca: null },
        LOTUS_Q: { codice: 241, designer: "Studio Olivari", rosette: 179.55, verticali: 187.85, placca: null },
        LUCY: { codice: 231, designer: "Studio Olivari", rosette: 100.50, verticali: 108.80, placca: null },
        LUGANO: { codice: 258, designer: "Studio Olivari", rosette: 103.30, verticali: 111.60, placca: null },
        MARBELLA: { codice: 237, designer: "Studio Olivari", rosette: 104.65, verticali: 112.95, placca: null },
        MARILYN: { codice: 252, designer: "Studio Olivari", rosette: 153.90, verticali: 162.20, placca: null },
        MELANZANA: { codice: 266, designer: "Luigi Caccia Dominioni", rosette: 155.90, verticali: 155.90, placca: 215.75 },
        MILANO: { codice: 259, designer: "Studio Olivari", rosette: 109.10, verticali: 117.40, placca: null },
        MILANO_Q: { codice: 260, designer: "Studio Olivari", rosette: 121.50, verticali: 129.80, placca: null },
        MINERVA: { codice: 205, designer: "Studio Olivari", rosette: 137.05, verticali: 145.35, placca: null },
        NINA: { codice: 234, designer: "Studio Olivari", rosette: 71.50, verticali: 79.80, placca: null },
        NOVELLA: { codice: 165, designer: "Studio Olivari", rosette: 83.45, verticali: 91.75, placca: null },
        OKAY: { codice: 262, designer: "Studio Olivari", rosette: 81.45, verticali: 89.75, placca: null },
        ONDA: { codice: 175, designer: "Studio Olivari", rosette: 74.75, verticali: 83.05, placca: null },
        OPEN: { codice: 249, designer: "Studio Olivari", rosette: 76.00, verticali: 84.30, placca: null },
        ORVIETO: { codice: 170, designer: "Studio Olivari", rosette: 93.05, verticali: 101.35, placca: null },
        PADDLE: { codice: 264, designer: "Studio Olivari", rosette: 76.55, verticali: 84.85, placca: null },
        PLANET: { codice: 195, designer: "Studio Olivari", rosette: 132.00, verticali: 147.30, placca: 202.50, magnetica: 153.05 },
        PLANET_Q: { codice: 203, designer: "Studio Olivari", rosette: 166.50, verticali: 180.70, placca: 236.70 },
        PLUME: { codice: 253, designer: "Studio Olivari", rosette: 66.30, verticali: 74.60, placca: null },
        RADIAL: { codice: 235, designer: "Studio Olivari", rosette: 66.90, verticali: 75.20, placca: null },
        RAFFAELLA: { codice: 128, designer: "Studio Olivari", rosette: 62.25, verticali: 70.55, placca: null },
        SECTOR: { codice: 186, designer: "Studio Olivari", rosette: 47.05, verticali: 55.35, placca: null },
        SERENELLA: { codice: 130, designer: "Studio Olivari", rosette: 61.55, verticali: 69.85, placca: null },
        SIBILLA: { codice: 154, designer: "Studio Olivari", rosette: 57.10, verticali: 65.40, placca: null },
        SIENA: { codice: 169, designer: "Studio Olivari", rosette: 72.35, verticali: 80.65, placca: null },
        SKY: { codice: 214, designer: "Studio Olivari", rosette: 82.55, verticali: 90.85, placca: null },
        STILO: { codice: 190, designer: "Studio Olivari", rosette: 57.15, verticali: 65.45, placca: null },
        TECNO: { codice: 182, designer: "Studio Olivari", rosette: 68.15, verticali: 76.45, placca: null },
        TIME: { codice: 192, designer: "Studio Olivari", rosette: 47.55, verticali: 55.85, placca: null },
        TIME_Q: { codice: 201, designer: "Studio Olivari", rosette: 89.40, verticali: 97.70, placca: null },
        TIZIANELLA_F: { codice: 112, designer: "Studio Olivari", rosette: 92.60, verticali: 100.90, placca: null },
        TOTAL: { codice: 207, designer: "Studio Olivari", rosette: 96.75, verticali: 105.05, placca: null },
        TREND: { codice: 228, designer: "Studio Olivari", rosette: 115.55, verticali: 123.85, placca: null },
        TWIST: { codice: 242, designer: "Studio Olivari", rosette: 137.70, verticali: 146.00, placca: null },
        UOVO: { codice: 108, designer: "Studio Olivari", rosette: 138.85, verticali: 154.15, placca: 209.35, magnetica: 159.90 },
        VIRGOLA: { codice: 251, designer: "Studio Olivari", rosette: 83.55, verticali: 91.85, placca: null },
        VOLA: { codice: 257, designer: "Max Pajetta", rosette: 192.90, verticali: 192.90, placca: 252.75 },
        WIND: { codice: 187, designer: "Studio Olivari", rosette: 109.50, verticali: 124.80, placca: 180.00, magnetica: 130.55 }
    },

    // ==================== CREMONESI (per finestre) ====================
    // Prezzi in Cromo lucido (CR) per PEZZO
    cremonesi: {
        ABC: { senza_mov: 97.65, con_mov: 105.95, dk_4scatti: 105.95, dk_sicurezza: 130.00 },
        ADAMANT: { senza_mov: 123.85, con_mov: 132.15, dk_4scatti: 132.15, dk_sicurezza: 156.20 },
        AGATA: { senza_mov: 75.90, con_mov: 84.20, dk_4scatti: 84.20, dk_sicurezza: 108.25 },
        ALA: { senza_mov: 94.75, con_mov: 103.05, dk_4scatti: 103.05, dk_sicurezza: 127.10 },
        ASTER: { senza_mov: 101.15, con_mov: 109.45, dk_4scatti: 109.45, dk_sicurezza: 133.50 },
        BOND: { senza_mov: 47.05, con_mov: 55.35, dk_4scatti: 55.35, dk_sicurezza: 79.40 },
        CHIARA: { senza_mov: 57.10, con_mov: 65.40, dk_4scatti: 65.40, dk_sicurezza: 89.45 },
        CLUB: { senza_mov: 62.25, con_mov: 70.55, dk_4scatti: 70.55, dk_sicurezza: 94.60 },
        DIANA: { senza_mov: 89.40, con_mov: 97.70, dk_4scatti: 97.70, dk_sicurezza: 121.75 },
        EMILIA: { senza_mov: 57.15, con_mov: 65.45, dk_4scatti: 65.45, dk_sicurezza: 89.50 },
        FUTURA: { senza_mov: 71.50, con_mov: 79.80, dk_4scatti: 79.80, dk_sicurezza: 103.85 },
        GARDA: { senza_mov: 47.55, con_mov: 55.85, dk_4scatti: 55.85, dk_sicurezza: 79.90 },
        ICONA: { senza_mov: 82.55, con_mov: 90.85, dk_4scatti: 90.85, dk_sicurezza: 114.90 },
        LAMA: { senza_mov: 71.50, con_mov: 79.80, dk_4scatti: 79.80, dk_sicurezza: 103.85 },
        PLANET: { senza_mov: 83.30, con_mov: 92.80, dk_4scatti: 92.80, dk_sicurezza: 116.85 },
        UOVO: { senza_mov: 87.90, con_mov: 97.40, dk_4scatti: 97.40, dk_sicurezza: 121.45 },
        VOLA: { senza_mov: 126.70, con_mov: 135.00, dk_4scatti: 135.00, dk_sicurezza: 159.05 },
        WIND: { senza_mov: 68.15, con_mov: 76.45, dk_4scatti: 76.45, dk_sicurezza: 100.50 }
    },

    // ==================== POMOLI ====================
    // Prezzi in Cromo lucido (CR) per coppia (pomoli zancati) o pezzo (fissi)
    pomoli: {
        // POMOLI ZANCATI (offset)
        BLINDO: { codice: 178, coppia: 137.35, fisso: 86.85 },
        CONCA: { codice: 236, coppia: 152.75, fisso: 90.65 },
        MELANZANA: { codice: 266, coppia: 155.90, fisso: 98.30 },
        PLANET: { codice: 195, coppia: 132.00, fisso: 83.30 },
        PLANET_Q: { codice: 203, coppia: 166.50, fisso: 103.90 },
        UOVO: { codice: 108, coppia: 138.85, fisso: 87.90 },
        
        // POMOLI CENTRALI
        DIANA_CENTRALE: { codice: 206, coppia: 188.35, fisso: 113.05 }
    },

    // ==================== BOCCHETTE ====================
    // Prezzi in Cromo lucido (CR) per coppia
    bocchette: {
        // TONDE
        tonde_patent: { codice: 1151, prezzo: 25.80 },
        tonde_yale: { codice: 1152, prezzo: 25.80 },
        tonde_B_patent: { codice: "1501B", prezzo: 35.20 },
        tonde_B_yale: { codice: "1502B", prezzo: 35.20 },
        
        // VERTICALI
        verticali_patent: { codice: 1154, prezzo: 27.60 },
        verticali_yale: { codice: 1155, prezzo: 27.60 },
        verticali_B_patent: { codice: "1511B", prezzo: 37.00 },
        verticali_B_yale: { codice: "1512B", prezzo: 37.00 },
        
        // QUADRATE
        quadrate_patent: { codice: 1201, prezzo: 32.40 },
        quadrate_yale: { codice: 1202, prezzo: 32.40 },
        quadrate_B_patent: { codice: "1521B", prezzo: 41.80 },
        quadrate_B_yale: { codice: "1522B", prezzo: 41.80 }
    },

    // ==================== CHIAVISTELLI ====================
    // Prezzi in Cromo lucido (CR) per pezzo
    chiavistelli: {
        H106V6: { descrizione: "Chiavistello rettangolare", prezzo: 38.50 },
        H106V6B: { descrizione: "Chiavistello rettangolare basso", prezzo: 48.20 },
        H136V6: { descrizione: "Chiavistello tondo", prezzo: 42.30 },
        H136V6B: { descrizione: "Chiavistello tondo basso", prezzo: 52.00 },
        H200V6: { descrizione: "Chiavistello ovale", prezzo: 36.80 },
        H200V6B: { descrizione: "Chiavistello ovale basso", prezzo: 46.50 },
        H202V6: { descrizione: "Chiavistello quadrato", prezzo: 44.60 },
        H202V6B: { descrizione: "Chiavistello quadrato basso", prezzo: 54.30 }
    },

    // ==================== MANIGLIONI ====================
    // Prezzi in Cromo lucido (CR) per pezzo
    maniglioni: {
        // STANDARD (interasse 300mm)
        standard_300: {
            CR: 197.85,
            CO: 218.55,
            NS: 257.20,
            IS: 257.20,
            RS: 304.35,
            DS: 304.35,
            US: 289.00
        },
        // STANDARD (interasse 400mm)
        standard_400: {
            CR: 227.60,
            CO: 251.20,
            NS: 295.85,
            IS: 295.85,
            RS: 350.00,
            DS: 350.00,
            US: 332.35
        },
        // STANDARD (interasse 600mm)
        standard_600: {
            CR: 287.10,
            CO: 316.90,
            NS: 373.30,
            IS: 373.30,
            RS: 441.60,
            DS: 441.60,
            US: 419.30
        }
    },

    // ==================== FERMAPORTE ====================
    fermaporte: {
        a_pavimento: { CR: 29.00, CO: 32.50, NS: 38.50, IS: 38.50 },
        a_parete: { CR: 24.00, CO: 27.00, NS: 32.00, IS: 32.00 },
        magnetico: { CR: 45.00, CO: 50.00, NS: 59.00, IS: 59.00 }
    },

    // ==================== SUPPLEMENTI ====================
    supplementi: {
        // Ferro quadro speciale
        ferro_9mm: 8.50,    // invece di 8mm standard
        ferro_10mm: 12.00,
        
        // Spessori porta non standard
        porta_63_75mm: 15.00,
        porta_75_90mm: 25.00,
        
        // Rosette/placche alte invece di basse
        rosette_alte: 12.00,
        placche_alte: 18.00,
        
        // Finiture speciali su richiesta
        finitura_speciale_min: 150.00  // quantitÃƒÂ  minima richiesta
    }
};

// ==================== FUNZIONE CALCOLO PREZZO ====================
function calcolaPrezzoOlivari(modello, tipo_montaggio, finitura, quantita = 1, opzioni = {}) {
    const info = OLIVARI_2025.info;
    const maniglia = OLIVARI_2025.maniglie[modello];
    const fin = OLIVARI_2025.finiture[finitura];
    
    if (!maniglia) {
        return { errore: `Modello ${modello} non trovato` };
    }
    
    if (!fin) {
        return { errore: `Finitura ${finitura} non trovata` };
    }
    
    // Prezzo base per tipo montaggio
    let prezzoBase;
    switch (tipo_montaggio) {
        case 'rosette':
            prezzoBase = maniglia.rosette;
            break;
        case 'verticali':
            prezzoBase = maniglia.verticali;
            break;
        case 'placca':
            prezzoBase = maniglia.placca;
            break;
        case 'magnetica':
            prezzoBase = maniglia.magnetica;
            break;
        default:
            prezzoBase = maniglia.rosette;
    }
    
    if (!prezzoBase) {
        return { errore: `Tipo montaggio ${tipo_montaggio} non disponibile per ${modello}` };
    }
    
    // Applica maggiorazione finitura
    const prezzoFinitura = prezzoBase * (1 + fin.maggiorazione);
    
    // Supplementi
    let supplementi = 0;
    if (opzioni.rosette_alte) supplementi += OLIVARI_2025.supplementi.rosette_alte;
    if (opzioni.ferro_9mm) supplementi += OLIVARI_2025.supplementi.ferro_9mm;
    if (opzioni.ferro_10mm) supplementi += OLIVARI_2025.supplementi.ferro_10mm;
    if (opzioni.porta_spessa) {
        if (opzioni.spessore_porta <= 75) {
            supplementi += OLIVARI_2025.supplementi.porta_63_75mm;
        } else {
            supplementi += OLIVARI_2025.supplementi.porta_75_90mm;
        }
    }
    
    // Totale listino
    const prezzoListino = (prezzoFinitura + supplementi) * quantita;
    
    // Calcolo sconto (40% + 5%)
    const prezzoNetto = prezzoListino * (1 - info.sconto_1) * (1 - info.sconto_2);
    
    return {
        modello: modello,
        codice: maniglia.codice,
        designer: maniglia.designer,
        tipo_montaggio: tipo_montaggio,
        finitura: fin.nome,
        garanzia_anni: fin.garanzia,
        quantita: quantita,
        prezzo_unitario_listino: Math.round((prezzoFinitura + supplementi) * 100) / 100,
        prezzoListino: Math.round(prezzoListino * 100) / 100,
        sconto: `${info.sconto_1 * 100}% + ${info.sconto_2 * 100}%`,
        sconto_effettivo: `${info.sconto_effettivo * 100}%`,
        prezzoNetto: Math.round(prezzoNetto * 100) / 100,
        supplementi: supplementi > 0 ? supplementi : null
    };
}

// ==================== FUNZIONE LISTA MODELLI ====================
function listaModelliOlivari() {
    const modelli = [];
    for (const [nome, dati] of Object.entries(OLIVARI_2025.maniglie)) {
        modelli.push({
            nome: nome,
            codice: dati.codice,
            designer: dati.designer,
            prezzo_base_CR: dati.rosette,
            disponibile_placca: dati.placca ? true : false,
            disponibile_magnetica: dati.magnetica ? true : false
        });
    }
    return modelli.sort((a, b) => a.prezzo_base_CR - b.prezzo_base_CR);
}

// ==================== EXPORT ====================

        console.log('âœ… OLIVARI-DATABASE-2025 caricato');

        // ============================================================================
        // ğŸ”§ COLOMBO DESIGN MANIGLIE 2025 - Prezzi Venerota
        // ============================================================================
/**
 * COLOMBO DESIGN DATABASE 2025
 * Maniglie per Porte - Prezzi da Ferramenta Venerota
 * 
 * SCONTO INSTALLATORE: 40%
 * Fonte: store.venerota.it (Dicembre 2025)
 * 
 * @version 1.0
 * @date 11/12/2025
 */

const COLOMBO_2025 = {
    
    // ==================== INFORMAZIONI GENERALI ====================
    info: {
        nome: "COLOMBO DESIGN",
        anno: "2025",
        sconto: 0.40,
        tipo: "maniglie",
        materiale: "Ottone / Acciaio Inox",
        produzione: "Made in Italy dal 1991",
        fonte: "Ferramenta Venerota",
        note: "Prezzi per coppia con rosetta/placca"
    },

    // ==================== MANIGLIE ====================
    // Prezzi LISTINO (il prezzo netto si calcola con sconto 40%)
    maniglie: {
        // === SERIE ROBOT (Entry Level) ===
        ROBOT: {
            nome: "Robot",
            rosetta_tonda: { listino: 35.33, netto: 21.20 },
            rosetta_stretta: { listino: 61.70, netto: 37.02 },
            placca: { listino: 57.20, netto: 34.32 }
        },
        ROBODUE: {
            nome: "Robodue",
            rosetta_tonda: { listino: 45.40, netto: 27.24 },
            rosetta_stretta: { listino: 64.40, netto: 38.64 }
        },
        ROBOTRE: {
            nome: "Robotre",
            rosetta_tonda: { listino: 37.33, netto: 22.40 },
            rosetta_stretta: { listino: 55.50, netto: 33.30 }
        },
        ROBOQUATTRO: {
            nome: "Roboquattro",
            rosetta_tonda: { listino: 37.33, netto: 22.40 },
            rosetta_stretta: { listino: 63.10, netto: 37.86 }
        },
        ROBOQUATTRO_S: {
            nome: "Roboquattro S",
            rosetta_quadra: { listino: 54.17, netto: 32.50 }
        },
        ROBOCINQUE: {
            nome: "Robocinque",
            rosetta_tonda: { listino: 52.30, netto: 31.38 }
        },
        ROBOCINQUE_S: {
            nome: "Robocinque S",
            rosetta_quadra: { listino: 56.50, netto: 33.90 },
            rosetta_stretta: { listino: 80.50, netto: 48.30 }
        },

        // === SERIE DESIGN ===
        ALBA: {
            nome: "Alba",
            rosetta_quadra_bassa: { listino: 107.80, netto: 64.38 }
        },
        BLAZER: {
            nome: "Blazer",
            rosetta_tonda: { listino: 77.10, netto: 46.26 }
        },
        DEA: {
            nome: "Dea",
            rosetta_quadra_bassa: { listino: 141.80, netto: 85.08 }
        },
        EDO: {
            nome: "Edo",
            rosetta_tonda: { listino: 78.20, netto: 46.92 }
        },
        ELECTRA: {
            nome: "Electra",
            rosetta_quadra_bassa: { listino: 97.70, netto: 58.62 }
        },
        ELLE: {
            nome: "Elle",
            rosetta_tonda: { listino: 95.60, netto: 57.36 }
        },
        ELLESSE: {
            nome: "Ellesse",
            rosetta_quadra: { listino: 99.80, netto: 59.88 },
            rosetta_quadra_bassa: { listino: 139.10, netto: 83.46 }
        },
        ESPRIT: {
            nome: "Esprit",
            rosetta_quadra_bassa: { listino: 132.20, netto: 79.32 }
        },
        FEDRA: {
            nome: "Fedra",
            rosetta_quadra_bassa: { listino: 111.50, netto: 66.90 }
        },
        FLESSA: {
            nome: "Flessa",
            rosetta_tonda: { listino: 137.00, netto: 82.20 }
        },
        GIRA: {
            nome: "Gira",
            rosetta_tonda: { listino: 105.50, netto: 63.30 }
        },
        HEIDI: {
            nome: "Heidi",
            rosetta_tonda: { listino: 88.40, netto: 53.04 }
        },
        ISY: {
            nome: "Isy",
            rosetta_quadra: { listino: 111.30, netto: 66.78 },
            rosetta_quadra_bassa: { listino: 131.00, netto: 78.60 }
        },
        LUND: {
            nome: "Lund",
            rosetta_tonda_bassa: { listino: 94.30, netto: 56.58 }
        },
        MACH: {
            nome: "Mach",
            rosetta_tonda: { listino: 54.80, netto: 32.88 },
            rosetta_stretta: { listino: 66.80, netto: 40.08 },
            ribassata_stretta: { listino: 76.90, netto: 46.14 }
        },
        MADI: {
            nome: "Madi",
            rosetta_tonda: { listino: 83.70, netto: 50.22 }
        },
        META: {
            nome: "Meta",
            rosetta_tonda: { listino: 101.50, netto: 60.90 }
        },
        MILLA: {
            nome: "Milla",
            rosetta_tonda: { listino: 87.60, netto: 52.56 },
            rosetta_tonda_LC31: { listino: 92.10, netto: 55.26 }
        },
        OLLY: {
            nome: "Olly",
            rosetta_tonda: { listino: 82.40, netto: 49.44 }
        },
        PEGASO: {
            nome: "Pegaso",
            rosetta_tonda: { listino: 101.70, netto: 61.02 }
        },
        PETER: {
            nome: "Peter",
            rosetta_tonda: { listino: 89.80, netto: 53.88 }
        },
        PRIUS: {
            nome: "Prius",
            rosetta_quadra: { listino: 150.70, netto: 90.42 }
        },
        SIRIO: {
            nome: "Sirio",
            rosetta_tonda: { listino: 81.20, netto: 48.72 }
        },
        SLIM: {
            nome: "Slim",
            rosetta_tonda_bassa: { listino: 95.50, netto: 57.30 }
        },
        SPIDER: {
            nome: "Spider",
            rosetta_quadra: { listino: 136.70, netto: 82.02 }
        },
        STAR: {
            nome: "Star",
            rosetta_tonda: { listino: 78.80, netto: 47.28 }
        },
        TAILLA: {
            nome: "Tailla",
            rosetta_tonda: { listino: 99.80, netto: 59.88 }
        },
        TAIPAN: {
            nome: "Taipan",
            rosetta_tonda: { listino: 94.70, netto: 56.82 }
        },
        TENDER: {
            nome: "Tender",
            rosetta_tonda: { listino: 73.50, netto: 44.10 }
        },
        TOOL: {
            nome: "Tool",
            rosetta_tonda: { listino: 105.50, netto: 63.30 }
        },
        VIOLA: {
            nome: "Viola",
            rosetta_tonda: { listino: 85.50, netto: 51.30 }
        },
        WING: {
            nome: "Wing",
            rosetta_tonda: { listino: 115.70, netto: 69.42 }
        },
        ZELDA: {
            nome: "Zelda",
            rosetta_quadra: { listino: 148.50, netto: 89.10 },
            rosetta_quadra_bassa: { listino: 154.40, netto: 92.64 }
        }
    },

    // ==================== FINITURE DISPONIBILI ====================
    finiture: {
        CR: { nome: "Cromo lucido", codice: "CR" },
        CS: { nome: "Cromo satinato", codice: "CS" },
        HPS: { nome: "HPS (antigrafio)", codice: "HPS" },
        NM: { nome: "Nero opaco", codice: "NM" },
        OM: { nome: "Oro opaco", codice: "OM" },
        GM: { nome: "Grafite opaco", codice: "GM" },
        BM: { nome: "Bronzo opaco", codice: "BM" },
        WM: { nome: "Bianco opaco", codice: "WM" },
        ZN: { nome: "Zirconio nero", codice: "ZN" },
        VL: { nome: "Vintage ottone", codice: "VL" },
        PVD_GOLD: { nome: "PVD Oro", codice: "PVD-GO" },
        PVD_BLACK: { nome: "PVD Nero", codice: "PVD-BK" }
    }
};

// ==================== FUNZIONE CALCOLO PREZZO ====================
function calcolaPrezzoColombo(modello, tipo_rosetta) {
    const maniglia = COLOMBO_2025.maniglie[modello.toUpperCase()];
    if (!maniglia) {
        return { errore: `Modello ${modello} non trovato` };
    }
    
    const variante = maniglia[tipo_rosetta];
    if (!variante) {
        return { errore: `Tipo rosetta ${tipo_rosetta} non disponibile per ${modello}` };
    }
    
    return {
        modello: maniglia.nome,
        tipo: tipo_rosetta,
        listino: variante.listino,
        netto: variante.netto,
        sconto: COLOMBO_2025.info.sconto * 100 + '%'
    };
}

// ==================== LISTA MODELLI ====================
function listaModelliColombo() {
    const lista = [];
    for (const [codice, dati] of Object.entries(COLOMBO_2025.maniglie)) {
        const varianti = Object.keys(dati).filter(k => k !== 'nome');
        const prezzoMin = Math.min(...varianti.map(v => dati[v].netto));
        lista.push({
            codice: codice,
            nome: dati.nome,
            varianti: varianti,
            prezzo_da: prezzoMin
        });
    }
    return lista.sort((a, b) => a.prezzo_da - b.prezzo_da);
}

console.log('âœ… COLOMBO-DATABASE-2025 caricato - ' + Object.keys(COLOMBO_2025.maniglie).length + ' modelli');


        // ============================================================================
        // ğŸšª FLESSYA PORTE INTERNE 2025 - Listino 2025/26
        // ============================================================================
/**
 * FLESSYA DATABASE 2025
 * Porte Interne - Listino 2025/26
 * 
 * SCONTO INSTALLATORE: 53%
 * 
 * Struttura prezzo:
 * Prezzo porta = Base finitura + Modello + Versione + Telaio/Cornice + Spessore muro + Accessori
 * 
 * @version 1.0
 * @date 11/12/2025
 */

const FLESSYA_2025 = {
    
    // ==================== INFORMAZIONI GENERALI ====================
    info: {
        nome: "FLESSYA",
        anno: "2025/26",
        sconto: 0.53,
        tipo: "porte_interne",
        note: "I prezzi definitivi verranno sempre comunicati tramite conferma d'ordine"
    },

    // ==================== LINEE PRODOTTO ====================
    linee: {
        NIDIO: {
            codice: "N00",
            descrizione: "Porte tamburate in legno",
            spessore_anta: 44,
            caratteristiche: "Intelaiate massello abete, nido d'ape, MDF 4mm"
        },
        NIDIO_INCISE: {
            codice: "N13",
            descrizione: "Porte tamburate con incisioni",
            spessore_anta: 44,
            caratteristiche: "MDF 5/8mm, lavorazioni incise"
        },
        TALEA: {
            codice: "T00",
            descrizione: "Porte pantografate",
            spessore_anta: 44,
            caratteristiche: "Massello toulipier, MDF 8mm"
        },
        CLASSIKA: {
            codice: "C00",
            descrizione: "Porte pantografate classiche",
            spessore_anta: 44,
            caratteristiche: "Massello toulipier, MDF 5mm rinforzato"
        },
        PLENIA: {
            codice: "P00",
            descrizione: "Porte massello impiallacciato e laccate",
            spessore_anta: 44,
            caratteristiche: "Elementi in legno massellato assemblati"
        },
        KIKKA: {
            codice: "K00",
            descrizione: "Porte in vetro con bordatura legno",
            spessore_vetro: 8,
            caratteristiche: "Vetro sp.8mm o 4+4, bordatura listellare 40x40mm"
        },
        VETRA: {
            codice: "V00",
            descrizione: "Porte in vetro",
            caratteristiche: "Porte tutto vetro con telaio"
        },
        S_NZIALE_MONO: {
            codice: "S00-MONO",
            descrizione: "Porte vetro e alluminio - singola",
            caratteristiche: "Vetro monolitico 8mm, profilo alluminio"
        },
        S_NZIALE_DUO: {
            codice: "S00-DUO",
            descrizione: "Porte vetro e alluminio - doppia",
            caratteristiche: "Doppia lastra vetro 5mm, profilo alluminio"
        },
        RASOMURO: {
            codice: "RMU",
            descrizione: "Porte rasomuro",
            caratteristiche: "Sistema rasomuro filo parete"
        },
        RECEPTIVA_EI30: {
            codice: "EI30",
            descrizione: "Porte REI antincendio EI30",
            spessore_anta: 44,
            caratteristiche: "Resistenza fuoco EI30, abbattimento acustico 27dB"
        },
        RECEPTIVA_EI60: {
            codice: "EI60",
            descrizione: "Porte REI antincendio EI60",
            spessore_anta: 58,
            caratteristiche: "Resistenza fuoco EI60, rovere massiccio"
        },
        RECEPTIVA_N00_27DB: {
            codice: "N00-27dB",
            descrizione: "Porte abbattimento acustico 27dB",
            caratteristiche: "Certificato abbattimento acustico 27dB"
        },
        RECEPTIVA_N00_32DB: {
            codice: "N00-32dB",
            descrizione: "Porte abbattimento acustico 32dB",
            caratteristiche: "Certificato abbattimento acustico 32dB"
        },
        RECEPTIVA_N00_40DB: {
            codice: "N00-40dB",
            descrizione: "Porte abbattimento acustico 40dB",
            caratteristiche: "Certificato abbattimento acustico 40dB"
        },
        RECEPTIVA_N00_42DB: {
            codice: "N00-42dB",
            descrizione: "Porte abbattimento acustico 42dB",
            caratteristiche: "Certificato abbattimento acustico 42dB"
        },
        MADERA: {
            codice: "M00",
            descrizione: "Porte in legno massello",
            caratteristiche: "Porte classiche in legno massello"
        },
        ANALOGICA: {
            codice: "A00",
            descrizione: "Porte moderne",
            caratteristiche: "Design moderno lineare"
        },
        EMPIRIA: {
            codice: "EN00",
            descrizione: "Porte tamburate / PVC / HPL",
            caratteristiche: "Anta tamburata EN00, PVC ER00, HPL ES00"
        },
        LAMINIO: {
            codice: "LM00",
            descrizione: "Porte laminato",
            caratteristiche: "Rivestimento laminato"
        },
        LAMINIO_PLUS: {
            codice: "LMP00",
            descrizione: "Porte laminato plus",
            caratteristiche: "Rivestimento laminato premium"
        },
        RESINAE: {
            codice: "RS00",
            descrizione: "Porte in resina",
            caratteristiche: "Rivestimento in resina"
        }
    },

    // ==================== FINITURE ====================
    finiture: {
        // LACCATI STANDARD
        "0": { nome: "Laccato bianco RAL 9016", categoria: "laccati_standard" },
        "1": { nome: "Laccato avorio RAL 1013", categoria: "laccati_standard" },
        "2": { nome: "Laccato bianco crema RAL 9001", categoria: "laccati_standard" },
        "5": { nome: "Laccato bianco puro RAL 9010", categoria: "laccati_standard" },
        "9": { nome: "Laccato nero RAL 9005", categoria: "laccati_extra" },
        
        // LACCATI BASE
        "3": { nome: "Laccato base", categoria: "laccati_base" },
        
        // LACCATI EXTRA
        "4": { nome: "Laccato extra", categoria: "laccati_extra" },
        
        // LACCATI IDEA
        "6": { nome: "Laccato colori idea", categoria: "laccati_idea" },
        
        // LACCATI SPECIALI
        "7": { nome: "Laccato corten", categoria: "laccati_speciali" },
        
        // LACCATI ULTRA
        "15": { nome: "Laccato ULTRA standard-idea", categoria: "laccati_ultra" },
        "16": { nome: "Laccato ULTRA base-extra", categoria: "laccati_ultra" },
        
        // GOFFRATI
        "10": { nome: "Goffrato standard-idea", categoria: "goffrati" },
        "11": { nome: "Goffrato base-extra", categoria: "goffrati" },
        
        // LUCIDI
        "30": { nome: "Laccato lucido standard-idea", categoria: "lucidi" },
        "31": { nome: "Laccato lucido base-extra", categoria: "lucidi" },
        
        // LACCATI PORO APERTO
        "39": { nome: "Frassino poro aperto RAL 9016", categoria: "poro_aperto" },
        "40": { nome: "Frassino poro aperto standard-idea", categoria: "poro_aperto" },
        "41": { nome: "Frassino poro aperto base-extra", categoria: "poro_aperto" },
        "50": { nome: "Frassino epoca standard-idea", categoria: "poro_aperto" },
        "51": { nome: "Frassino epoca base-extra", categoria: "poro_aperto" },
        "60": { nome: "Pino graffiato standard-idea", categoria: "poro_aperto" },
        "61": { nome: "Pino graffiato base-extra", categoria: "poro_aperto" },
        "20": { nome: "Rovere decapÃƒÂ¨", categoria: "poro_aperto" },
        
        // LEGNI
        "100": { nome: "Tanganika", categoria: "legni" },
        "101": { nome: "Tanganika cuoio", categoria: "legni" },
        "102": { nome: "Tanganika ciliegio", categoria: "legni" },
        "103": { nome: "Tanganika tabacco", categoria: "legni" },
        "120": { nome: "Rovere", categoria: "legni" },
        "121": { nome: "Rovere tabacco", categoria: "legni" },
        "122": { nome: "Rovere caffÃƒÂ¨", categoria: "legni" },
        "123": { nome: "Rovere sbiancato", categoria: "legni" },
        "126": { nome: "Rovere grigio", categoria: "legni" },
        "127": { nome: "Rovere cenere", categoria: "legni" },
        "128": { nome: "Rovere nodato", categoria: "legni" },
        "129": { nome: "Rovere crudo", categoria: "legni" },
        "140": { nome: "Noce nazionale bicolore", categoria: "legni" },
        "150": { nome: "Ciliegio", categoria: "legni" },
        
        // SPECIALI
        "110": { nome: "Mogano", categoria: "speciali" },
        "170": { nome: "Noce biondo", categoria: "speciali" },
        "181": { nome: "Frassino antico", categoria: "speciali" },
        "183": { nome: "Frassino sbiancato", categoria: "speciali" },
        "231": { nome: "Pino graffiato rame", categoria: "speciali" },
        "232": { nome: "Pino graffiato antico", categoria: "speciali" },
        
        // GREZZO
        "G0": { nome: "Grezzo da laccare", categoria: "grezzo" },
        "F0": { nome: "Fondo levigato-cementite", categoria: "grezzo" }
    },

    // ==================== PREZZI BASE PER LINEA ====================
    // Formato: [80x210, 90x210, 120x210, 120x240, 120x288]
    prezzi_base: {
        NIDIO: {
            "0":   [475, 508, 589, 744, 828],    // Bianco 9016
            "1":   [518, 555, 651, 817, 908],    // Avorio 1013
            "2":   [518, 555, 651, 817, 908],    // Bianco crema 9001
            "3":   [623, 660, 756, 922, 1013],   // Base
            "4":   [738, 775, 852, 1041, 1133],  // Extra
            "5":   [518, 555, 651, 817, 908],    // Bianco 9010
            "6":   [570, 607, 704, 869, 961],    // Idea
            "7":   [886, 923, 998, 1185, 1287],  // Corten
            "9":   [738, 775, 852, 1041, 1133],  // Nero 9005
            "15":  [723, 760, 856, 1022, 1113],  // ULTRA standard-idea
            "16":  [838, 875, 952, 1141, 1233],  // ULTRA base-extra
            "10":  [655, 692, 787, 954, 1045],   // Goffrato standard
            "11":  [770, 807, 888, 1089, 1180],  // Goffrato extra
            "30":  [1165, 1198, 1313, 1507, 1591], // Lucido standard
            "31":  [1270, 1303, 1418, 1612, 1696], // Lucido extra
            "40":  [682, 714, 846, 1062, 1146],  // Frassino poro standard
            "41":  [787, 819, 951, 1167, 1251],  // Frassino poro extra
            "50":  [682, 714, 846, 1062, 1146],  // Frassino epoca standard
            "51":  [787, 819, 951, 1167, 1251],  // Frassino epoca extra
            "60":  [682, 714, 846, 1062, 1146],  // Pino graffiato standard
            "61":  [787, 819, 951, 1167, 1251],  // Pino graffiato extra
            "20":  [787, 819, 951, 1167, 1251],  // Rovere decapÃƒÂ¨
            "100": [496, 534, 633, 912, 996],    // Tanganika
            "101": [496, 534, 633, 912, 996],    // Tanganika cuoio
            "102": [496, 534, 633, 912, 996],    // Tanganika ciliegio
            "103": [496, 534, 633, 912, 996],    // Tanganika tabacco
            "120": [578, 616, 725, 1019, 1103],  // Rovere
            "121": [578, 616, 725, 1019, 1103],  // Rovere tabacco
            "122": [682, 714, 846, 1062, 1146],  // Rovere caffÃƒÂ¨
            "123": [682, 714, 846, 1062, 1146],  // Rovere sbiancato
            "126": [734, 767, 898, 1115, 1199],  // Rovere grigio
            "127": [734, 767, 898, 1115, 1199],  // Rovere cenere
            "128": [734, 767, 898, 1115, 1199],  // Rovere nodato
            "129": [1160, 1218, 1392, 1515, 1645], // Rovere crudo
            "140": [636, 672, 823, 1054, 1138],  // Noce bicolore
            "150": [636, 672, 823, 1054, 1138],  // Ciliegio
            "110": [540, 578, 676, 956, 1040],   // Mogano
            "170": [786, 818, 1025, 1315, 1399], // Noce biondo
            "181": [734, 767, 898, 1115, 1199],  // Frassino antico
            "183": [682, 714, 846, 1062, 1146],  // Frassino sbiancato
            "231": [734, 767, 898, 1115, 1199],  // Pino rame
            "232": [734, 767, 898, 1115, 1199],  // Pino antico
            "G0":  [320, 352, 425, 583, 667],    // Grezzo
            "F0":  [464, 498, 579, 734, 818]     // Fondo
        },
        
        NIDIO_INCISE: {
            "0":   [599, 632, 713, 868, 952],
            "1":   [599, 632, 713, 868, 952],
            "2":   [599, 632, 713, 868, 952],
            "3":   [704, 737, 818, 973, 1057],
            "4":   [819, 852, 914, 1092, 1177],
            "5":   [599, 632, 713, 868, 952],
            "6":   [651, 684, 766, 920, 1005],
            "7":   [967, 1000, 1060, 1236, 1331],
            "9":   [819, 852, 914, 1092, 1177],
            "15":  [804, 837, 918, 1073, 1157],
            "16":  [919, 952, 1014, 1192, 1277],
            "10":  [779, 816, 911, 1078, 1169],
            "11":  [894, 931, 1012, 1213, 1304],
            "30":  [1289, 1322, 1437, 1631, 1715],
            "31":  [1394, 1427, 1542, 1736, 1820],
            "40":  [806, 838, 970, 1186, 1270],
            "41":  [911, 943, 1075, 1291, 1375],
            "60":  [806, 838, 970, 1186, 1270],
            "61":  [911, 943, 1075, 1291, 1375],
            "G0":  [444, 476, 549, 707, 791],
            "F0":  [588, 622, 703, 858, 942]
        },
        
        TALEA: {
            "0":   [599, 632, 713, 868, 952],
            "1":   [599, 632, 713, 868, 952],
            "2":   [599, 632, 713, 868, 952],
            "3":   [704, 737, 818, 984, 1068],
            "4":   [819, 852, 914, 1092, 1177],
            "5":   [599, 632, 713, 868, 952],
            "6":   [651, 684, 766, 931, 1015],
            "7":   [967, 1000, 1060, 1236, 1331],
            "9":   [819, 852, 914, 1092, 1177],
            "15":  [804, 837, 918, 1073, 1157],
            "16":  [919, 952, 1014, 1192, 1277],
            "10":  [779, 816, 911, 1078, 1169],
            "11":  [894, 931, 1012, 1213, 1304],
            "30":  [1289, 1322, 1437, 1631, 1715],
            "31":  [1394, 1427, 1542, 1736, 1820],
            "40":  [906, 938, 1070, 1286, 1370],
            "41":  [1011, 1043, 1175, 1391, 1475],
            "60":  [906, 938, 1070, 1286, 1370],
            "61":  [1011, 1043, 1175, 1391, 1475],
            "G0":  [456, 472, 552, 746, 839],
            "F0":  [588, 622, 703, 858, 942]
        },
        
        CLASSIKA: {
            "0":   [861, 895, 1081, 1341, 1425],
            "1":   [861, 895, 1081, 1341, 1425],
            "2":   [861, 895, 1081, 1341, 1425],
            "3":   [966, 1000, 1165, 1446, 1530],
            "4":   [1071, 1115, 1280, 1565, 1649],
            "5":   [861, 895, 1081, 1341, 1425],
            "6":   [914, 947, 1123, 1383, 1572],
            "7":   [1229, 1273, 1437, 1723, 1807],
            "9":   [1071, 1115, 1280, 1565, 1649],
            "15":  [1066, 1100, 1265, 1546, 1630],
            "16":  [1171, 1215, 1380, 1665, 1749],
            "10":  [1041, 1078, 1259, 1550, 1641],
            "11":  [1157, 1193, 1380, 1686, 1777],
            "30":  [1509, 1543, 1763, 2061, 2145],
            "31":  [1614, 1648, 1868, 2166, 2250],
            "G0":  [703, 736, 887, 1098, 1261],
            "F0":  [851, 884, 1070, 1295, 1414]
        },
        
        // Formato PLENIA: [80x210, 90x210, 120x210, 90x278, 120x278]
        PLENIA: {
            "0":   [719, 746, 851, 869, 953],
            "1":   [733, 763, 876, 894, 982],
            "2":   [733, 763, 876, 894, 982],
            "3":   [838, 868, 981, 999, 1087],
            "4":   [943, 973, 1086, 1104, 1192],
            "5":   [733, 763, 876, 894, 982],
            "6":   [765, 797, 903, 926, 999],
            "7":   [1059, 1089, 1201, 1262, 1318],
            "9":   [943, 973, 1086, 1104, 1192],
            "15":  [938, 968, 1081, 1099, 1187],
            "16":  [1043, 1073, 1186, 1204, 1292],
            "10":  [870, 900, 1012, 1030, 1119],
            "11":  [996, 1026, 1138, 1152, 1245],
            "30":  [1409, 1436, 1569, 1615, 1707],
            "31":  [1514, 1544, 1682, 1729, 1821],
            "40":  [877, 909, 1017, 1040, 1126],
            "41":  [982, 1014, 1122, 1145, 1231],
            "50":  [877, 909, 1017, 1040, 1126],
            "51":  [982, 1014, 1122, 1145, 1231],
            "60":  [877, 909, 1017, 1040, 1126],
            "61":  [982, 1014, 1122, 1145, 1231],
            "20":  [982, 1014, 1122, 1145, 1231],
            "100": [700, 733, 847, 865, 928],
            "101": [700, 733, 847, 865, 928],
            "102": [700, 733, 847, 865, 928],
            "103": [700, 733, 847, 865, 928],
            "120": [776, 808, 917, 945, 1024],
            "121": [776, 808, 917, 945, 1024],
            "122": [877, 909, 1017, 1040, 1126],
            "123": [877, 909, 1017, 1040, 1126],
            "126": [930, 961, 1069, 1093, 1178],
            "127": [930, 961, 1069, 1093, 1178],
            "140": [846, 877, 986, 1008, 1115],
            "150": [846, 877, 986, 1008, 1115],
            "170": [1003, 1034, 1173, 1225, 1305],
            "181": [930, 961, 1069, 1093, 1178],
            "183": [877, 909, 1017, 1040, 1126],
            "231": [930, 961, 1069, 1093, 1178],
            "232": [930, 961, 1069, 1093, 1178]
        },
        
        // KIKKA: [80x210, 90x210, 120x210, 90x278, 120x278]
        KIKKA: {
            "0":   [1778, 1884, 2302, 2345, 2793],
            "1":   [1792, 1901, 2327, 2370, 2822],
            "2":   [1792, 1901, 2327, 2370, 2822],
            "3":   [1897, 2006, 2432, 2475, 2927],
            "4":   [2002, 2111, 2537, 2580, 3032],
            "5":   [1792, 1901, 2327, 2370, 2822],
            "6":   [1824, 1935, 2354, 2402, 2839],
            "7":   [2118, 2227, 2652, 2696, 3158],
            "9":   [2002, 2111, 2537, 2580, 3032],
            "15":  [1997, 2106, 2532, 2575, 3027],
            "16":  [2102, 2211, 2637, 2680, 3132],
            "10":  [1929, 2038, 2463, 2517, 2959],
            "11":  [2055, 2164, 2585, 2626, 3082],
            "30":  [2468, 2874, 3320, 3391, 3847],
            "31":  [2573, 2982, 3433, 3505, 3961],
            "40":  [1936, 2047, 2468, 2516, 2966],
            "41":  [2041, 2152, 2573, 2621, 3071],
            "50":  [1936, 2047, 2468, 2516, 2966],
            "51":  [2041, 2152, 2573, 2621, 3071],
            "60":  [1936, 2047, 2468, 2516, 2966],
            "61":  [2041, 2152, 2573, 2621, 3071],
            "20":  [2041, 2152, 2573, 2621, 3071],
            "100": [1759, 1871, 2298, 2341, 2768],
            "101": [1759, 1871, 2298, 2341, 2768],
            "102": [1759, 1871, 2298, 2341, 2768],
            "103": [1759, 1871, 2298, 2341, 2768],
            "120": [1835, 1946, 2368, 2421, 2864],
            "121": [1835, 1946, 2368, 2421, 2864],
            "122": [1936, 2047, 2468, 2516, 2966],
            "123": [1936, 2047, 2468, 2516, 2966],
            "126": [1989, 2099, 2520, 2569, 3018],
            "127": [1989, 2099, 2520, 2569, 3018],
            "128": [1989, 2099, 2520, 2569, 3018],
            "140": [1905, 2015, 2437, 2484, 2955],
            "150": [1905, 2015, 2437, 2484, 2955],
            "170": [2062, 2172, 2624, 2701, 3145],
            "181": [1989, 2099, 2520, 2569, 3018],
            "183": [1936, 2047, 2468, 2516, 2966],
            "231": [1989, 2099, 2520, 2569, 3018],
            "232": [1989, 2099, 2520, 2569, 3018]
        },
        
        // S-NZIALE MONO Battente: [60x210, 70x210, 80x210, 90x210, 100x210]
        S_NZIALE_MONO_BATTENTE: {
            "700": [1548, 1598, 1650, 1701, 1752],  // Trasparente
            "707": [1624, 1687, 1750, 1814, 1866],  // Extra chiaro
            "711": [1770, 1827, 1884, 1940, 1997],  // Grigio
            "712": [1770, 1827, 1884, 1940, 1997],  // Bronzo
            "725": [1849, 1947, 2047, 2147, 2247],  // Semiriflettente
            "701": [1616, 1679, 1742, 1804, 1867],  // Acidato
            "702": [1772, 1858, 1945, 2032, 2046],  // Acidato extra chiaro
            "721": [1861, 1961, 2061, 2161, 2261],  // Acidato grigio
            "722": [1861, 1961, 2061, 2161, 2261],  // Acidato bronzo
            "703": [1758, 1825, 1837, 1895, 1916],  // Sabbiato trasparente
            "704": [1833, 1885, 1938, 1990, 2045],  // Sabbiato acidato
            "708": [2155, 2200, 2245, 2289, 2334],  // Scavo
            "710": [1862, 1963, 2064, 2165, 2267],  // Specchio
            "715": [2299, 2463, 2627, 2790, 2806],  // Laccato acidato
            "713": [2096, 2228, 2360, 2493, 2625],  // Laccato lucido
            "716": [2359, 2517, 2675, 2832, 2990],  // Stampa trasparente
            "717": [1939, 2029, 2120, 2210, 2300],  // Stampa acidato
            "718": [2010, 2121, 2232, 2342, 2453],  // Tessuto bianco
            "719": [2010, 2121, 2232, 2342, 2453],  // Tessuto nero
            "720": [2010, 2121, 2232, 2342, 2453]   // Tessuto naturale
        },
        
        // S-NZIALE MONO Scorrevole Scomparsa: [60x210, 70x210, 80x210, 90x210, 100x210, 110x210, 120x210]
        S_NZIALE_MONO_SCOMPARSA: {
            "700": [1429, 1479, 1531, 1581, 1633, 1684, 1734],
            "707": [1504, 1568, 1631, 1695, 1746, 1798, 1850],
            "711": [1651, 1708, 1764, 1821, 1878, 1934, 1991],
            "712": [1651, 1708, 1764, 1821, 1878, 1934, 1991],
            "725": [1730, 1828, 1928, 2028, 2128, 2228, 2328],
            "701": [1497, 1560, 1622, 1685, 1748, 1810, 1873],
            "702": [1653, 1739, 1826, 1913, 1927, 2014, 2100],
            "721": [1742, 1842, 1941, 2041, 2141, 2241, 2341],
            "722": [1742, 1842, 1941, 2041, 2141, 2241, 2341],
            "703": [1639, 1705, 1718, 1775, 1797, 1852, 1892],
            "704": [1714, 1766, 1819, 1870, 1926, 1990, 2041],
            "708": [2035, 2081, 2126, 2170, 2215, 2275, 2322],
            "710": [1743, 1844, 1945, 2046, 2147, 2248, 2350],
            "715": [2180, 2344, 2507, 2671, 2687, 2850, 3014],
            "713": [1976, 2109, 2241, 2374, 2506, 2639, 2771],
            "716": [2240, 2398, 2555, 2713, 2871, 3029, 3186],
            "717": [1820, 1910, 2000, 2091, 2181, 2271, 2362],
            "718": [1891, 2002, 2112, 2223, 2334, 2445, 2555],
            "719": [1891, 2002, 2112, 2223, 2334, 2445, 2555],
            "720": [1891, 2002, 2112, 2223, 2334, 2445, 2555]
        },
        
        // S-NZIALE MONO Rasomuro: [60x210, 70x210, 80x210, 90x210, 100x210, 110x210, 120x210]
        S_NZIALE_MONO_RASOMURO: {
            "700": [834, 884, 936, 987, 1038, 1089, 1140],
            "707": [910, 973, 1036, 1100, 1152, 1203, 1255],
            "711": [1057, 1113, 1170, 1226, 1283, 1339, 1396],
            "712": [1057, 1113, 1170, 1226, 1283, 1339, 1396],
            "725": [1135, 1234, 1333, 1433, 1533, 1633, 1733],
            "701": [902, 965, 1028, 1090, 1153, 1215, 1278],
            "702": [1058, 1144, 1231, 1318, 1332, 1419, 1506],
            "721": [1147, 1247, 1347, 1447, 1547, 1646, 1746],
            "722": [1147, 1247, 1347, 1447, 1547, 1646, 1746],
            "703": [1044, 1111, 1123, 1181, 1202, 1258, 1297],
            "704": [1119, 1171, 1224, 1276, 1331, 1395, 1447],
            "708": [1441, 1486, 1531, 1575, 1620, 1680, 1727],
            "710": [1148, 1249, 1350, 1451, 1553, 1654, 1755],
            "715": [1585, 1749, 1913, 2076, 2092, 2256, 2419],
            "713": [1382, 1514, 1646, 1779, 1911, 2044, 2176],
            "716": [1645, 1803, 1961, 2118, 2276, 2434, 2592],
            "717": [1225, 1315, 1406, 1496, 1586, 1677, 1767],
            "718": [1296, 1407, 1518, 1628, 1739, 1850, 1961],
            "719": [1296, 1407, 1518, 1628, 1739, 1850, 1961],
            "720": [1296, 1407, 1518, 1628, 1739, 1850, 1961]
        },
        
        // RECEPTIVA EI30 27dB: [80x210, 90x210, 104x210, 104x240, 94x276]
        RECEPTIVA_EI30_27DB: {
            "0":   [1046, 1079, 1160, 1315, 1399],
            "1":   [1089, 1126, 1222, 1388, 1479],
            "2":   [1089, 1126, 1222, 1388, 1479],
            "3":   [1194, 1231, 1327, 1493, 1584],
            "4":   [1309, 1346, 1423, 1612, 1704],
            "5":   [1089, 1126, 1222, 1388, 1479],
            "6":   [1141, 1178, 1275, 1440, 1532],
            "7":   [1457, 1494, 1569, 1756, 1858],
            "9":   [1309, 1346, 1423, 1612, 1704],
            "10":  [1226, 1263, 1358, 1525, 1616],
            "11":  [1341, 1378, 1459, 1660, 1751],
            "30":  [1736, 1769, 1884, 2078, 2162],
            "31":  [1841, 1874, 1989, 2183, 2267]
        },
        
        // RECEPTIVA 32dB: [80x210, 90x210, 104x210, 104x240, 94x276]
        RECEPTIVA_32DB: {
            "0":   [1146, 1179, 1260, 1415, 1499],
            "1":   [1189, 1226, 1322, 1488, 1579],
            "2":   [1189, 1226, 1322, 1488, 1579],
            "3":   [1294, 1331, 1427, 1593, 1684],
            "4":   [1409, 1446, 1523, 1712, 1804],
            "5":   [1189, 1226, 1322, 1488, 1579],
            "6":   [1241, 1278, 1375, 1540, 1632],
            "7":   [1557, 1594, 1669, 1856, 1958],
            "9":   [1409, 1446, 1523, 1712, 1804],
            "10":  [1326, 1363, 1458, 1625, 1716],
            "11":  [1441, 1478, 1559, 1760, 1851],
            "30":  [1836, 1869, 1984, 2178, 2262],
            "31":  [1941, 1974, 2089, 2283, 2367]
        },
        
        // RECEPTIVA 40dB
        RECEPTIVA_40DB: {
            "0":   [1424, 1457, 1538, 1693, 1777],
            "1":   [1467, 1504, 1600, 1766, 1857],
            "2":   [1467, 1504, 1600, 1766, 1857],
            "3":   [1572, 1609, 1705, 1871, 1962],
            "4":   [1687, 1724, 1801, 1990, 2082],
            "5":   [1467, 1504, 1600, 1766, 1857],
            "6":   [1519, 1556, 1653, 1818, 1910],
            "7":   [1835, 1872, 1947, 2134, 2236],
            "9":   [1687, 1724, 1801, 1990, 2082],
            "10":  [1604, 1641, 1736, 1903, 1994],
            "11":  [1719, 1756, 1837, 2038, 2129],
            "30":  [2114, 2147, 2262, 2456, 2540],
            "31":  [2219, 2252, 2367, 2561, 2645]
        },
        
        // RECEPTIVA 42dB
        RECEPTIVA_42DB: {
            "0":   [1729, 1762, 1843, 1998, 2082],
            "1":   [1772, 1809, 1905, 2071, 2162],
            "2":   [1772, 1809, 1905, 2071, 2162],
            "3":   [1877, 1914, 2010, 2176, 2267],
            "4":   [1992, 2029, 2106, 2295, 2387],
            "5":   [1772, 1809, 1905, 2071, 2162],
            "6":   [1824, 1861, 1958, 2123, 2215],
            "7":   [2140, 2177, 2252, 2439, 2541],
            "9":   [1992, 2029, 2106, 2295, 2387],
            "10":  [1909, 1946, 2041, 2208, 2299],
            "11":  [2024, 2061, 2142, 2343, 2434],
            "30":  [2419, 2452, 2567, 2761, 2845],
            "31":  [2524, 2557, 2672, 2866, 2950]
        }
    },

    // ==================== SUPPLEMENTI MODELLI ====================
    supplementi_modelli: {
        NIDIO: {
            // Modelli intarsiati
            "N00": { "90x210": 0, "120x288": 0 },
            "N05": { "90x210": 38, "120x288": 38 },
            "N06": { "90x210": 88, "120x288": 88 },
            "N06H": { "90x210": 88, "120x288": 88 },
            "N06Z": { "90x210": 150, "120x288": 150 },
            "N07": { "90x210": 100, "120x288": 100 },
            "N08": { "90x210": 200, "120x288": 200 },
            "N09": { "90x210": 150, "120x288": 150 },
            "N10": { "90x210": 180, "120x288": 180 },
            "N11": { "90x210": 300, "120x288": 300 },
            "N12": { "90x210": 300, "120x288": 300 },
            // Modelli inserti alluminio
            "N01D": { "90x210": 101, "120x288": 101 },
            "N01": { "90x210": 63, "120x288": 63 },
            "N02": { "90x210": 101, "120x288": 101 },
            "N03": { "90x210": 126, "120x288": 126 },
            "N04": { "90x210": 126, "120x288": 126 },
            // Modelli vetro
            "N50": { "90x210": 90, "120x288": 108 },
            "N50S": { "90x210": 90, "120x288": 108 },
            "N51": { "90x210": 280, "120x288": 297 },
            "N52": { "90x210": 280, "120x288": 297 },
            "N53": { "90x210": 90, "120x288": 108 },
            "N54": { "90x210": 208, "120x288": 246 },
            "N55": { "90x210": 262, "120x288": 308 },
            "N56": { "90x210": 259, "120x288": 478 },
            "N57": { "90x210": 551, "120x288": 770 },
            "N58": { "90x210": 551, "120x288": 770 },
            // Modelli foderine
            "N30": { "90x210": 198, "120x288": 276 },
            "N31": { "90x210": 450, "120x288": 528 },
            "N32": { "90x210": 450, "120x288": 528 },
            "N33": { "90x210": 271, "120x288": 380 },
            "N34": { "90x210": 523, "120x288": 634 },
            "N35": { "90x210": 523, "120x288": 634 },
            "N36": { "90x210": 347, "120x288": 486 },
            "N37": { "90x210": 347, "120x288": 486 },
            "N38": { "90x210": 420, "120x288": 590 },
            // Modelli bugne
            "N40": { "90x210": 254, "120x288": 373 },
            "N41": { "90x210": 506, "120x288": 624 },
            "N42": { "90x210": 506, "120x288": 624 },
            "N43": { "90x210": 402, "120x288": 582 },
            "N44": { "90x210": 654, "120x288": 833 },
            "N45": { "90x210": 654, "120x288": 833 },
            "N46": { "90x210": 530, "120x288": 774 },
            "N47": { "90x210": 530, "120x288": 774 },
            "N48": { "90x210": 660, "120x288": 970 }
        },
        
        TALEA: {
            "T00": { "90x210": 0, "120x288": 0 },
            "T01": { "90x210": 0, "120x288": 0 },
            "T02": { "90x210": 0, "120x288": 0 },
            "T03": { "90x210": 0, "120x288": 0 },
            "T04": { "90x210": 0, "120x288": 0 },
            "T20": { "90x210": 0, "120x288": 0 },
            "T21": { "90x210": 0, "120x288": 0 },
            "T22": { "90x210": 0, "120x288": 0 },
            "T23": { "90x210": 0, "120x288": 0 },
            "T24": { "90x210": 0, "120x288": 0 },
            // Modelli vetro
            "T50": { "90x210": 150, "120x288": 150 },
            "T51": { "90x210": 170, "120x288": 170 },
            "T52": { "90x210": 170, "120x288": 170 },
            "T53": { "90x210": 210, "120x288": 210 },
            "T54": { "90x210": 230, "120x288": 230 },
            "T60": { "90x210": 100, "120x288": 100 },
            "T61": { "90x210": 140, "120x288": 140 },
            "T62": { "90x210": 140, "120x288": 140 },
            "T63": { "90x210": 170, "120x288": 170 },
            "T64": { "90x210": 190, "120x288": 190 },
            "T65": { "90x210": 170, "120x288": 170 },
            "T66": { "90x210": 320, "120x288": 320 },
            "T70": { "90x210": 200, "120x288": 200 },
            "T71": { "90x210": 100, "120x288": 100 },
            "T72": { "90x210": 170, "120x288": 170 },
            "T73": { "90x210": 100, "120x288": 100 },
            "T74": { "90x210": 280, "120x288": 280 },
            "T80": { "90x210": 230, "120x288": 230 },
            "T81": { "90x210": 200, "120x288": 200 },
            "T82": { "90x210": 250, "120x288": 250 },
            "T83": { "90x210": 380, "120x288": 380 },
            // Modelli inglese
            "T10": { "90x210": 100, "120x288": 100 },
            "T11": { "90x210": 130, "120x288": 130 },
            "T12": { "90x210": 130, "120x288": 130 },
            "T13": { "90x210": 160, "120x288": 160 },
            "T14": { "90x210": 280, "120x288": 280 },
            "T15": { "90x210": 200, "120x288": 200 },
            "T16": { "90x210": 150, "120x288": 150 },
            "T17": { "90x210": 100, "120x288": 100 },
            "T90": { "90x210": 100, "120x288": 100 },
            "T91": { "90x210": 130, "120x288": 130 },
            "T92": { "90x210": 130, "120x288": 130 },
            "T93": { "90x210": 160, "120x288": 160 },
            "T94": { "90x210": 280, "120x288": 280 },
            "T95": { "90x210": 160, "120x288": 160 },
            "T96": { "90x210": 100, "120x288": 100 },
            "T97": { "90x210": 200, "120x288": 200 }
        },
        
        CLASSIKA: {
            "C00": { "90x210": 0, "120x288": 0 },
            "C01": { "90x210": 0, "120x288": 0 },
            "C02": { "90x210": 0, "120x288": 0 },
            "C03": { "90x210": 0, "120x288": 0 },
            "C04": { "90x210": 0, "120x288": 0 },
            "C20": { "90x210": 0, "120x288": 0 },
            "C21": { "90x210": 0, "120x288": 0 },
            "C22": { "90x210": 0, "120x288": 0 },
            "C23": { "90x210": 0, "120x288": 0 },
            "C24": { "90x210": 0, "120x288": 0 },
            "C25": { "90x210": 0, "120x288": 0 },
            "C30": { "90x210": 0, "120x288": 0 },
            "C31": { "90x210": 0, "120x288": 0 },
            "C32": { "90x210": 0, "120x288": 0 },
            "C35": { "90x210": 0, "120x288": 0 },
            // Modelli vetro
            "C50": { "90x210": 150, "120x288": 150 },
            "C51": { "90x210": 170, "120x288": 170 },
            "C53": { "90x210": 210, "120x288": 210 },
            "C60": { "90x210": 100, "120x288": 100 },
            "C61": { "90x210": 140, "120x288": 140 },
            "C63": { "90x210": 170, "120x288": 170 },
            "C65": { "90x210": 170, "120x288": 170 },
            "C70": { "90x210": 200, "120x288": 200 },
            "C71": { "90x210": 100, "120x288": 100 },
            "C72": { "90x210": 170, "120x288": 170 },
            // Inglese
            "C10": { "90x210": 100, "120x288": 100 },
            "C11": { "90x210": 130, "120x288": 130 },
            "C13": { "90x210": 160, "120x288": 160 },
            "C15": { "90x210": 200, "120x288": 200 },
            "C16": { "90x210": 150, "120x288": 150 },
            "C17": { "90x210": 100, "120x288": 100 },
            "C90": { "90x210": 100, "120x288": 100 },
            "C91": { "90x210": 130, "120x288": 130 },
            "C93": { "90x210": 160, "120x288": 160 },
            "C95": { "90x210": 160, "120x288": 160 }
        }
    },

    // ==================== SUPPLEMENTI VERSIONI (APERTURE) ====================
    versioni: {
        // Battente
        BT: { nome: "Battente", "1anta": 0, "2ante": 0, "1anta_sopraluce": 0, "2ante_sopraluce": 0 },
        CS: { nome: "Cerniere a scomparsa", "1anta_h210": 100, "1anta_oltre": 150, "2ante_h210": 200, "2ante_oltre": 250 },
        FL: { nome: "Fuori luce", "1anta": 50, "2ante": 60, "1anta_sopraluce": 100, "2ante_sopraluce": 120 },
        FLB: { nome: "Fuori luce con battuta", "1anta": 150, "2ante": 160, "1anta_sopraluce": 200, "2ante_sopraluce": 220 },
        FLBCS: { nome: "Fuori luce battuta + cerniere scomparsa", "1anta": 250, "2ante": 400, "1anta_sopraluce": 250, "2ante_sopraluce": 400 },
        PY: { nome: "Portoncino (serratura yale)", "1anta": 50, "2ante": 50, "1anta_sopraluce": 50, "2ante_sopraluce": 50 },
        IL: { nome: "Inlinea", "1anta": 320, "2ante": 470, "1anta_sopraluce": 380, "2ante_sopraluce": 540 },
        ILT: { nome: "Inlinea a tirare", "1anta": 320, "2ante": 470, "1anta_sopraluce": 380, "2ante_sopraluce": 540 },
        TR: { nome: "Trapezio", "1anta": 225, "2ante": 412, "1anta_sopraluce": 225, "2ante_sopraluce": 412 },
        VV: { nome: "Va e vieni", "1anta": 165, "2ante": 313, "1anta_sopraluce": 222, "2ante_sopraluce": 336 },
        L13: { nome: "Libro 1/3 - 2/3", "1anta": 620, "2ante": 1240, "1anta_sopraluce": 620, "2ante_sopraluce": 1240 },
        L12: { nome: "Libro 1/2 - 1/2", "1anta": 670, "2ante": 1340, "1anta_sopraluce": 670, "2ante_sopraluce": 1340 },
        LT: { nome: "Libro traslante", "1anta": 780, "2ante": 1560, "1anta_sopraluce": 780, "2ante_sopraluce": 1560 },
        RT: { nome: "Rototraslante", "1anta": 520, "2ante": 1040 },
        PV: { nome: "Pivot", "1anta": 300, "2ante": 600 },
        
        // Scorrevoli
        SS90: { nome: "Scorrevole scomparsa 9cm", "1anta": 150, "2ante": 200 },
        SS100: { nome: "Scorrevole scomparsa 10cm", "1anta": 150, "2ante": 200 },
        SS105: { nome: "Scorrevole scomparsa 10.5cm", "1anta": 100, "2ante": 150 },
        SS115: { nome: "Scorrevole scomparsa 11.5cm", "1anta": 150, "2ante": 200 },
        SS125: { nome: "Scorrevole scomparsa 12.5cm", "1anta": 150, "2ante": 200 },
        SS145: { nome: "Scorrevole scomparsa 14.5cm", "1anta": 150, "2ante": 200 },
        SAR: { nome: "Armonico", "1anta": 180, "2ante": 280 },
        SAP: { nome: "Applauso", "1anta": 180, "2ante": 280 },
        SES: { nome: "Rasomuro", "1anta": 0, "2ante": 0 },
        SGL: { nome: "Gran luce", "2ante": 320 },
        SPR: { nome: "Pratico", "2ante": 600 }
    },

    // ==================== TELAI E CORNICI ====================
    telai_cornici: {
        "Lineo + Recta": 0,       // Standard
        "Lineo + Plana": 15,
        "Lineo + Curva": 30,
        "Lineo + Sagoma": 80,
        "Lineo + Ampia": 30,
        "Lineo + Barocca": 220,
        "Lineo + Nove": 15,
        "Lineo + Mini": 50,       // Solo laccati lisci
        "Lineo + Design": 70,    // Solo laccati lisci
        "Radius + Recta": 0,
        "Radius + Curva": 30,
        "Radius + Sagoma": 80,
        "Radius + Barocca": 220
    },

    // ==================== SUPPLEMENTI FERRAMENTA ====================
    ferramenta: {
        finiture: {
            "cromo_satinata": 0,  // Standard
            "cromo_lucida": 10,
            "bronzata": 10,
            "ottone_lucida": 10,
            "magnetica_bianca": 20,
            "magnetica_nera": 20
        },
        serratura: {
            "patent": 0,         // Standard
            "libero_occupato": 10,
            "yale": 30,
            "magnetica": 10      // Maggiorazione
        },
        maniglie_S_NZIALE: {
            "a_L_h14": 0,
            "a_L_h20": 10,
            "a_L_h40": 20,
            "a_L_h50": 25,
            "a_L_h100": 110,
            "quadrata_inox_64": 80,
            "rettangolare_inox_150": 90
        }
    },

    // ==================== SUPPLEMENTI ALLUMINIO S-NZIALE ====================
    supplementi_alluminio: {
        argento: 0,
        laccati_serie: 340,
        laccati_fuori_serie: 580,
        ferramenta_laccata: 40,
        telaio_minimale: -200
    },

    // ==================== SUPPLEMENTI EXTRA ALTEZZA ====================
    extra_altezza: {
        "fino_220": 0.05,  // +5%
        "fino_240": 0.10,  // +10%
        "fino_270": 0.20,  // +20%
        "fino_300": 0.30   // +30%
    },

    // ==================== LAVORAZIONI ====================
    lavorazioni: {
        ante: {
            "LA01": { desc: "Anta sollevata/ribassata", prezzo: 15 },
            "LA03": { desc: "Rinforzo MDF 8mm", prezzo: 65 },
            "LA04": { desc: "Rinforzo MDF 5mm", prezzo: 35 },
            "LA09": { desc: "Anta spessore 38mm", prezzo: 50 },
            "LA11": { desc: "Predisposizione griglie aerazione", prezzo: 40 },
            "LA12": { desc: "Specchiatura a rombo", prezzo: 30 },
            "LA13": { desc: "Specchiatura triangolare", prezzo: 80 },
            "LA14": { desc: "Specchio complanare", prezzo: 570 },
            "LA15": { desc: "Predisposizione maniglie incasso", prezzo: 30 },
            "LA16": { desc: "Predisposizione kit chiusura", prezzo: 50 },
            "LA18": { desc: "Impiallacciatura a telaio", prezzo: 45 },
            "LA19": { desc: "Anta inferiore 26cm", prezzo: 45 },
            "LA20": { desc: "Predisposizione chiudiporta aereo", prezzo: 35 },
            "LA21": { desc: "Predisposizione maniglione antipanico", prezzo: 35 },
            "LA30": { desc: "Fermavetro ribassato", prezzo: 38 },
            "LA31": { desc: "Fermavetri complanari inglesi (cad)", prezzo: 25 },
            "LA32": { desc: "Fermavetri complanari 1 lato (cad)", prezzo: 200 },
            "LA33": { desc: "Fermavetro complanare", prezzo: 80 },
            "LA38": { desc: "Predisposizione vetro 6-19mm", prezzo: 20 },
            "LA53": { desc: "Anta mobile su semifissa (scomparsa)", prezzo: 100 },
            "LA55": { desc: "Anta mobile su semifissa (anuba)", prezzo: 150 },
            "LA70": { desc: "Raddrizza ante", prezzo: 150 }
        },
        verniciatura: {
            "LV01": { desc: "2 colori (interno/esterno)", prezzo: 200 },
            "LV02": { desc: "2 essenze (interno/esterno)", prezzo: 150 },
            "LV03": { desc: "Anta diversa da telaio", prezzo: 25 },
            "LV04": { desc: "1 lato essenza + 1 lato laccato", prezzo: 200 },
            "LV06": { desc: "Lucida trasparente spazzolata", prezzo: 400 },
            "LV10": { desc: "Finitura anticato", prezzo: 400 },
            "LV13": { desc: "Finitura lusso", prezzo: 400 }
        },
        telai: {
            "LT01": { desc: "Telaio senza traverso", prezzo: 15 }
        }
    },

    // ==================== VETRI ====================
    vetri: {
        tipologie: {
            trasparente: 0,
            acidato: 0,
            extra_chiaro: 200,
            grigio: 100,
            bronzo: 100,
            semiriflettente: 100
        },
        speciali_kikka: {
            sabbiati_flessya: 500,
            sabbia: 500,
            scavo: 750,
            stampati: 500,
            stampa_digitale: 1350,
            laccato_lucido: 1050,
            laccato_acidato: 1340,
            tessuto: 1000,
            materia: 1000
        },
        maggiorazioni_120x288: {
            extra_chiaro: 300,
            grigio: 150,
            bronzo: 150,
            sabbiati: 700,
            scavo: 950,
            stampati: 1000,
            stampa_digitale: 1570,
            laccato_lucido: 1250,
            laccato_acidato: 1540,
            tessuto: 1300,
            materia: 1300
        }
    },

    // ==================== ACCESSORI ====================
    accessori: {
        capitelli: {
            "A-B-C": { "1anta": 150, "2ante": 200 }
        },
        cornici_unghiate: 120,
        basette_20x10: 60,
        stampa_digitale: {
            "anta_90x210": 350,
            "anta_cornici_90x210": 450,
            "anta_oltre_90x210": 550,
            "anta_cornici_oltre": 700,
            "personalizzata_90x210": 450,
            "personalizzata_oltre": 650
        },
        effetto_essenza: 128,
        tinta_campione_fino_3: 250,
        tinta_campione_oltre_3: 180,
        tranciato_orizzontale: 38
    },

    // ==================== FUNZIONI CALCOLO ====================
    
    /**
     * Calcola il prezzo di una porta FLESSYA
     */
    calcolaPrezzo: function(params) {
        const {
            linea,
            finitura,
            dimensione,       // es: "80x210", "90x210", etc
            modello,
            versione,
            telaio_cornice,
            spessore_muro,
            accessori = []
        } = params;
        
        let prezzoTotale = 0;
        let dettaglio = [];
        
        // 1. Prezzo base
        const prezziLinea = this.prezzi_base[linea];
        if (!prezziLinea || !prezziLinea[finitura]) {
            return { errore: "Linea o finitura non trovata" };
        }
        
        const indice = this.getIndiceDimensione(linea, dimensione);
        const prezzoBase = prezziLinea[finitura][indice];
        prezzoTotale += prezzoBase;
        dettaglio.push({ voce: "Prezzo base", importo: prezzoBase });
        
        // 2. Supplemento modello
        if (modello && this.supplementi_modelli[linea]) {
            const suppModello = this.supplementi_modelli[linea][modello];
            if (suppModello) {
                const chiave = dimensione.includes("120") ? "120x288" : "90x210";
                const importoModello = suppModello[chiave] || 0;
                prezzoTotale += importoModello;
                if (importoModello > 0) {
                    dettaglio.push({ voce: `Modello ${modello}`, importo: importoModello });
                }
            }
        }
        
        // 3. Supplemento versione
        if (versione && this.versioni[versione]) {
            const suppVersione = this.versioni[versione]["1anta"] || 0;
            prezzoTotale += suppVersione;
            if (suppVersione > 0) {
                dettaglio.push({ voce: `Versione ${versione}`, importo: suppVersione });
            }
        }
        
        // 4. Supplemento telaio/cornice
        if (telaio_cornice && this.telai_cornici[telaio_cornice]) {
            const suppTelaio = this.telai_cornici[telaio_cornice];
            prezzoTotale += suppTelaio;
            if (suppTelaio > 0) {
                dettaglio.push({ voce: telaio_cornice, importo: suppTelaio });
            }
        }
        
        // 5. Accessori
        accessori.forEach(acc => {
            if (acc.prezzo) {
                prezzoTotale += acc.prezzo;
                dettaglio.push({ voce: acc.nome, importo: acc.prezzo });
            }
        });
        
        return {
            prezzoListino: prezzoTotale,
            prezzoNetto: Math.round(prezzoTotale * (1 - this.info.sconto)),
            sconto: this.info.sconto,
            dettaglio: dettaglio
        };
    },
    
    /**
     * Ottiene l'indice della dimensione nell'array prezzi
     */
    getIndiceDimensione: function(linea, dimensione) {
        // Dimensioni standard: [80x210, 90x210, 120x210, 120x240, 120x288]
        // PLENIA/KIKKA: [80x210, 90x210, 120x210, 90x278, 120x278]
        const mappa = {
            "60x210": 0,
            "70x210": 1,
            "80x210": 0,
            "90x210": 1,
            "100x210": 2,
            "110x210": 3,
            "120x210": 2,
            "104x210": 2,
            "90x278": 3,
            "120x240": 3,
            "104x240": 3,
            "120x278": 4,
            "94x276": 4,
            "120x288": 4
        };
        return mappa[dimensione] || 1;
    }
};

// Export per Node.js

        console.log('âœ… FLESSYA-DATABASE-2025 caricato');


        // ============================================================================
        // ğŸšª LISTINO FIN-DOOR PORTONCINI FINSTRAL - EUR 2025/3
        // ============================================================================
        const LISTINO_FINDOOR_PORTONCINI = {
            // PREZZI BASE TIPO 720 - Flat Frame ALU-ALU
            prezziBase720_ALU: {
                990: { 2040: 1240, 2165: 1272, 2290: 1303, 2415: 1412, 2540: 1443, 2665: 1475, 2790: 1506, 2915: 1537 },
                1115: { 2040: 1297, 2165: 1329, 2290: 1362, 2415: 1474, 2540: 1507, 2665: 1540, 2790: 1573, 2915: 1607 },
                1240: { 2040: 1351, 2165: 1388, 2290: 1422, 2415: 1535, 2540: 1570, 2665: 1606, 2790: 1640, 2915: 1675 },
                1365: { 2040: 1408, 2165: 1444, 2290: 1482, 2415: 1597, 2540: 1633, 2665: 1670, 2790: 1708, 2915: 1744 }
            },
            // PREZZI BASE TIPO 720 - Step Frame PVC-PVC
            prezziBase720_PVC: {
                990: { 2040: 1871, 2165: 1922, 2290: 1973, 2415: 2036, 2540: 2087, 2665: 2139, 2790: 2190, 2915: 2241 },
                1115: { 2040: 1944, 2165: 1998, 2290: 2051, 2415: 2117, 2540: 2169, 2665: 2223, 2790: 2276, 2915: 2329 },
                1240: { 2040: 2018, 2165: 2074, 2290: 2129, 2415: 2197, 2540: 2251, 2665: 2307, 2790: 2361, 2915: 2418 },
                1365: { 2040: 2093, 2165: 2149, 2290: 2207, 2415: 2276, 2540: 2333, 2665: 2391, 2790: 2448, 2915: 2506 },
                1490: { 2040: 2165, 2165: 2225, 2290: 2284, 2415: 2355, 2540: 2416, 2665: 2475, 2790: 2534, 2915: 2594 }
            },
            // SUPPLEMENTI MODELLO ANTA (pag. 66-72)
            supplementiModello: {
                '01': { standard: 0, grande: 0 },
                '02': { standard: 43, grande: 54 },
                '03': { standard: 98, grande: 123 },
                '04': { standard: 149, grande: 186 },
                '05': { standard: 205, grande: 256 },
                '06': { standard: 262, grande: 328 },
                '07': { standard: 320, grande: 400 },
                '20': { standard: 425, grande: 531 },
                '21': { standard: 530, grande: 662 },
                '22': { standard: 640, grande: 800 },
                '23': { standard: 755, grande: 944 },
                '24': { standard: 875, grande: 1094 },
                '41': { standard: 320, grande: 400 },
                '43': { standard: 486, grande: 608 },
                '44': { standard: 589, grande: 736 },
                '45': { standard: 698, grande: 873 },
                '46': { standard: 812, grande: 1015 },
                '47': { standard: 932, grande: 1165 },
                '48': { standard: 1058, grande: 1322 },
                '49': { standard: 1190, grande: 1487 }
            },
            // SUPPLEMENTI COLORE
            supplementiColore: {
                'gruppoA': 0, 'gruppoB': 95, 'gruppoC': 185, 'legno': 250, 'speciale': 380
            },
            // MANIGLIE
            maniglie: {
                set: { '100': 0, '101': 45, '102': 85, '103': 125, '104': 180, '105': 240 },
                maniglioni: { '340': 185, '341': 245, '342': 310, '343': 395, '350': 450, '351': 520 }
            },
            // CILINDRI
            cilindri: { '1P': 0, '1P+TP': 95, '2P': 145, '2P+TP': 195, '3P+TP': 280 },
            // CERNIERE
            cerniere: { 'standard': 0, 'scomparsa': 185 },
            // FONOASSORBENTE
            fonoassorbente: 320,
            // MOLTIPLICATORI TIPO APERTURA
            moltiplicatoriTipo: {
                '720': 1.0, '625': 1.0, '621': 1.45, '622': 1.45,
                '633': 1.85, '636': 1.75, '624': 1.35, '623': 1.40
            }
        };
        
        // ğŸšª Funzione calcolo prezzo Portoncino Fin-Door
        function calcolaPrezzoPortoncinoFindoor(ptc) {
            const dettaglio = {
                prezzoBase: 0, supplementoModello: 0, supplementoColoreInt: 0, supplementoColoreEst: 0,
                maniglia: 0, cilindro: 0, cerniere: 0, fonoassorbente: 0, moltiplicatoreTipo: 1, totale: 0
            };
            if (!ptc) return dettaglio;
            
            // 1. Tabella prezzi base
            const isALU = (ptc.materialeInt === 'ALU' && ptc.materialeEst === 'ALU');
            const tabella = isALU ? LISTINO_FINDOOR_PORTONCINI.prezziBase720_ALU : LISTINO_FINDOOR_PORTONCINI.prezziBase720_PVC;
            
            // 2. Trova prezzo base da griglia
            const L = parseInt(ptc.BRM_L) || 1000;
            const H = parseInt(ptc.BRM_H) || 2100;
            const larghezze = Object.keys(tabella).map(Number).sort((a,b) => a-b);
            const largBase = larghezze.find(l => l >= L) || larghezze[larghezze.length - 1];
            const altezze = Object.keys(tabella[largBase] || {}).map(Number).sort((a,b) => a-b);
            const altBase = altezze.find(a => a >= H) || altezze[altezze.length - 1];
            dettaglio.prezzoBase = tabella[largBase]?.[altBase] || 1500;
            
            // 3. Supplemento modello anta
            const isGrande = (L > 1115 || H > 2355);
            const modello = ptc.modelloAnta || '01';
            const supplMod = LISTINO_FINDOOR_PORTONCINI.supplementiModello[modello];
            dettaglio.supplementoModello = supplMod ? (isGrande ? supplMod.grande : supplMod.standard) : 0;
            
            // 4. Supplementi colore
            dettaglio.supplementoColoreInt = LISTINO_FINDOOR_PORTONCINI.supplementiColore[ptc.gruppoColoreInt] || 0;
            dettaglio.supplementoColoreEst = LISTINO_FINDOOR_PORTONCINI.supplementiColore[ptc.gruppoColoreEst] || 0;
            
            // 5. Maniglia
            if (ptc.tipoManiglia === 'maniglione') {
                dettaglio.maniglia = LISTINO_FINDOOR_PORTONCINI.maniglie.maniglioni[ptc.codManiglia] || 0;
            } else {
                dettaglio.maniglia = LISTINO_FINDOOR_PORTONCINI.maniglie.set[ptc.codManiglia] || 0;
            }
            
            // 6-8. Cilindro, Cerniere, Fonoassorbente
            dettaglio.cilindro = LISTINO_FINDOOR_PORTONCINI.cilindri[ptc.cilindro] || 0;
            dettaglio.cerniere = LISTINO_FINDOOR_PORTONCINI.cerniere[ptc.cerniere] || 0;
            if (ptc.fonoassorbente) dettaglio.fonoassorbente = LISTINO_FINDOOR_PORTONCINI.fonoassorbente;
            
            // 9. Moltiplicatore tipo apertura
            dettaglio.moltiplicatoreTipo = LISTINO_FINDOOR_PORTONCINI.moltiplicatoriTipo[ptc.tipoApertura] || 1;
            
            // 10. Calcolo totale
            const subtotale = dettaglio.prezzoBase + dettaglio.supplementoModello + dettaglio.supplementoColoreInt + 
                              dettaglio.supplementoColoreEst + dettaglio.maniglia + dettaglio.cilindro + 
                              dettaglio.cerniere + dettaglio.fonoassorbente;
            dettaglio.totale = Math.round(subtotale * dettaglio.moltiplicatoreTipo);
            
            console.log(`ğŸšª Calcolo Findoor: Base â‚¬${dettaglio.prezzoBase} + Mod â‚¬${dettaglio.supplementoModello} + Col â‚¬${dettaglio.supplementoColoreInt + dettaglio.supplementoColoreEst} + Man â‚¬${dettaglio.maniglia} Ã— ${dettaglio.moltiplicatoreTipo} = â‚¬${dettaglio.totale}`);
            return dettaglio;
        }
        
        const LISTINO_PUNTO_PERSIANE = {
            // Tipologia F1: Finestra 1 anta
            // Larghezze: 500-1200mm | Altezze: 700-2000mm
            F1: {
                larghezze: [500, 600, 700, 800, 900, 1000, 1100, 1200],
                prezzi: {
                    700:  [257, 282, 306, 317, 326, 335, 350, 366],
                    800:  [275, 294, 314, 327, 338, 349, 365, 381],
                    900:  [291, 306, 323, 337, 350, 364, 379, 395],
                    1000: [307, 319, 329, 347, 363, 378, 395, 411],
                    1100: [307, 327, 346, 363, 379, 397, 415, 434],
                    1200: [320, 338, 356, 377, 391, 409, 426, 444],
                    1300: [330, 350, 370, 388, 408, 427, 448, 470],
                    1400: [337, 359, 379, 400, 422, 443, 460, 478],
                    1500: [349, 371, 395, 417, 437, 459, 480, 501],
                    1600: [355, 379, 403, 426, 448, 473, 496, 520],
                    1700: [371, 395, 418, 444, 468, 493, 517, 543],
                    1800: [384, 410, 435, 462, 488, 512, 539, 567],
                    1900: [397, 426, 455, 480, 507, 530, 562, 592],
                    2000: [411, 443, 473, 500, 527, 550, 586, 616]
                }
            },
            
            // Tipologia F2: Finestra 2 ante
            // Larghezze: 800-1500mm | Altezze: 700-2000mm
            F2: {
                larghezze: [800, 900, 1000, 1100, 1200, 1300, 1400, 1500],
                prezzi: {
                    700:  [489, 500, 509, 520, 534, 548, 557, 572],
                    800:  [502, 514, 525, 537, 552, 566, 576, 592],
                    900:  [515, 527, 541, 554, 569, 586, 597, 613],
                    1000: [527, 542, 557, 572, 588, 605, 616, 635],
                    1100: [545, 562, 578, 593, 613, 631, 648, 662],
                    1200: [562, 577, 593, 613, 632, 651, 667, 686],
                    1300: [575, 595, 614, 636, 658, 679, 695, 715],
                    1400: [592, 613, 635, 656, 679, 697, 716, 740],
                    1500: [610, 633, 656, 680, 700, 721, 743, 767],
                    1600: [627, 650, 672, 695, 720, 742, 766, 790],
                    1700: [642, 667, 691, 716, 740, 764, 789, 814],
                    1800: [660, 686, 711, 737, 761, 786, 811, 837],
                    1900: [679, 706, 732, 758, 783, 808, 834, 861],
                    2000: [699, 727, 753, 780, 806, 831, 858, 885]
                }
            },
            
            // Tipologia F3: Finestra 3 ante
            // Larghezze: 1200-2300mm | Altezze: 700-2000mm
            F3: {
                larghezze: [1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000, 2100, 2200, 2300],
                prezzi: {
                    700:  [779, 783, 788, 792, 797, 817, 830, 837, 863, 871, 872, 890],
                    800:  [790, 799, 809, 818, 827, 844, 860, 870, 889, 901, 908, 925],
                    900:  [801, 816, 829, 842, 858, 872, 887, 902, 918, 930, 944, 960],
                    1000: [814, 832, 849, 869, 886, 900, 917, 933, 946, 960, 978, 995],
                    1100: [840, 861, 880, 900, 919, 934, 954, 970, 988, 1006, 1020, 1042],
                    1200: [883, 899, 913, 928, 944, 963, 981, 1002, 1017, 1037, 1054, 1075],
                    1300: [898, 918, 939, 959, 979, 1001, 1018, 1041, 1060, 1079, 1098, 1118],
                    1400: [915, 936, 960, 983, 1006, 1027, 1049, 1070, 1089, 1110, 1133, 1156],
                    1500: [941, 966, 992, 1016, 1042, 1062, 1087, 1109, 1133, 1156, 1178, 1200],
                    1600: [972, 996, 1018, 1042, 1064, 1088, 1112, 1134, 1159, 1183, 1208, 1232],
                    1700: [1001, 1026, 1051, 1077, 1101, 1129, 1156, 1181, 1208, 1234, 1259, 1284],
                    1800: [1026, 1053, 1080, 1107, 1134, 1161, 1187, 1214, 1240, 1267, 1293, 1320],
                    1900: [1057, 1085, 1113, 1140, 1169, 1195, 1223, 1250, 1278, 1305, 1332, 1360],
                    2000: [1090, 1118, 1147, 1176, 1204, 1232, 1260, 1288, 1316, 1345, 1373, 1401]
                }
            },
            
            // Tipologia F4: Finestra 4 ante
            // Larghezze: 1600-3000mm | Altezze: 800-2000mm
            F4: {
                larghezze: [1600, 1700, 1800, 1900, 2000, 2100, 2200, 2300, 2400, 2500, 2600, 2700, 2800, 2900, 3000],
                prezzi: {
                    800:  [1192, 1206, 1220, 1233, 1242, 1256, 1268, 1284, 1298, 1314, 1325, 1335, 1347, 1357, 1369],
                    900:  [1225, 1236, 1248, 1262, 1275, 1289, 1303, 1319, 1334, 1350, 1364, 1375, 1385, 1397, 1409],
                    1000: [1253, 1265, 1277, 1289, 1308, 1323, 1338, 1355, 1369, 1385, 1405, 1416, 1426, 1438, 1448],
                    1100: [1293, 1305, 1317, 1329, 1350, 1365, 1381, 1397, 1421, 1438, 1454, 1465, 1490, 1515, 1542],
                    1200: [1325, 1336, 1348, 1360, 1381, 1396, 1421, 1438, 1457, 1473, 1498, 1507, 1528, 1549, 1571],
                    1300: [1360, 1372, 1383, 1396, 1423, 1439, 1466, 1482, 1509, 1525, 1549, 1559, 1585, 1610, 1637],
                    1400: [1398, 1410, 1421, 1433, 1464, 1478, 1506, 1522, 1549, 1564, 1589, 1599, 1628, 1655, 1684],
                    1500: [1435, 1446, 1459, 1471, 1506, 1521, 1551, 1566, 1594, 1609, 1634, 1644, 1679, 1716, 1753],
                    1600: [1470, 1482, 1494, 1507, 1540, 1554, 1585, 1600, 1632, 1647, 1677, 1688, 1725, 1762, 1800],
                    1700: [1506, 1518, 1530, 1542, 1580, 1594, 1628, 1643, 1676, 1691, 1725, 1736, 1776, 1816, 1856],
                    1800: [1542, 1554, 1567, 1579, 1620, 1634, 1671, 1686, 1720, 1735, 1773, 1784, 1827, 1870, 1913],
                    1900: [1583, 1595, 1607, 1619, 1664, 1678, 1718, 1733, 1770, 1785, 1825, 1836, 1883, 1930, 1977],
                    2000: [1624, 1637, 1649, 1661, 1708, 1722, 1765, 1780, 1820, 1835, 1877, 1888, 1939, 1990, 2041]
                }
            },
            
            // Tipologia PF1: Porta Finestra 1 anta
            // Larghezze: 500-1200mm | Altezze: 1800-2700mm
            PF1: {
                larghezze: [500, 600, 700, 800, 900, 1000, 1100, 1200],
                prezzi: {
                    1800: [446, 474, 504, 530, 563, 590, 619, 648],
                    1900: [451, 481, 510, 543, 575, 603, 636, 670],
                    2000: [466, 496, 529, 562, 591, 621, 656, 691],
                    2100: [471, 506, 542, 575, 608, 639, 671, 703],
                    2200: [491, 522, 553, 590, 623, 659, 691, 722],
                    2300: [491, 529, 567, 600, 638, 673, 710, 747],
                    2400: [506, 542, 578, 616, 656, 691, 729, 767],
                    2500: [516, 553, 591, 631, 669, 708, 745, 785],
                    2600: [526, 565, 604, 645, 682, 726, 764, 802],
                    2700: [536, 577, 617, 659, 695, 743, 781, 821]
                }
            },
            
            // Tipologia PF2: Porta Finestra 2 ante
            // Larghezze: 800-1500mm | Altezze: 1800-2700mm
            PF2: {
                larghezze: [800, 900, 1000, 1100, 1200, 1300, 1400, 1500],
                prezzi: {
                    1800: [761, 789, 817, 847, 875, 906, 933, 961],
                    1900: [776, 804, 834, 866, 894, 927, 955, 985],
                    2000: [794, 826, 858, 887, 919, 954, 983, 1015],
                    2100: [815, 845, 875, 909, 941, 976, 1007, 1040],
                    2200: [828, 865, 901, 932, 966, 1002, 1035, 1068],
                    2300: [848, 881, 915, 952, 985, 1023, 1058, 1094],
                    2400: [866, 902, 939, 976, 1012, 1051, 1088, 1123],
                    2500: [881, 919, 958, 995, 1034, 1071, 1111, 1147],
                    2600: [894, 935, 977, 1014, 1054, 1091, 1135, 1173],
                    2700: [910, 954, 997, 1035, 1077, 1112, 1159, 1198]
                }
            },
            
            // Aziende che usano questo listino
            aziende: ['punto persiane', 'p. persiane', 'p persiane', 'punto', 'persiane']
        };
        
        /**
         * Database Categorie Colori Persiane Punto Persiane
         * Fonte: Listino Punto Persiane 45/52 Ottobre 2025 (pag.124-125)
         */
        const COLORI_PERSIANE_CATEGORIE = {
            // Categoria 01 (0% maggiorazione) - Standard
            'CAT01': {
                maggiorazione: 0,
                colori: ['CPF910L', 'CPF113L', 'CPF701L', 'CPF716L', 'CPF605L', 'CPF609T', 'CPF817L']
            },
            
            // Categoria 02A (+3%) - Opachi speciali
            'CAT02A': {
                maggiorazione: 3,
                colori: ['CPF735L', 'CPF609L', 'CPF621L', 'CPF119L', 'CPF524L', 'CPF811L']
            },
            
            // Categoria 02B (+5%) - Textured
            'CAT02B': {
                maggiorazione: 5,
                colori: ['CPF910T', 'CPF113T', 'CPF701T', 'CPF305T', 'CPF605T', 'CPF817T']
            },
            
            // Categoria 03 (+20%) - Legno Ezy
            'CAT03': {
                maggiorazione: 20,
                colori: ['CPF820H', 'CPF818H', 'CPF813H', 'CPFR811', 'CPF812H', 'CPFN630', 'CPFN632']
            },
            
            // Categoria 04 (+25%) - Legno Ã‰lite
            'CAT04': {
                maggiorazione: 25,
                colori: ['HD303', 'HD360', 'HD366']
            },
            
            // Categoria 05 (+25%) - Sublimato Electo
            'CAT05': {
                maggiorazione: 25,
                colori: ['CPF90RC', 'CPF91RS', 'CPF51CR']
            },
            
            // Categoria 06 (+30%) - Sublimato
            'CAT06': {
                maggiorazione: 30,
                colori: ['CPF358R', 'CPF127R', 'CPF375R', 'CPF378R', 'CPF317R']
            },
            
            // Categoria 07 (+30%) - Speciale
            'CAT07': {
                maggiorazione: 30,
                colori: ['CPF70KA'] // Winchester
            },
            
            // Categoria 08 (A preventivo) - Speciali con cambio cabina
            'CAT08': {
                maggiorazione: 0, // Da calcolare a parte
                supplementoCabina: 237,
                colori: ['CPFSLV7', 'CPFRGG4', 'CPF744L']
            }
        };
        
        /**
         * Trova maggiorazione colore persiana
         * @param {string} coloreCompleto - Colore formato "CPF70KA - Winchester"
         * @returns {object} { maggiorazione: number, categoria: string, supplementoCabina: number }
         */
        function trovaMaggiorazioneColorePersiana(coloreCompleto) {
            if (!coloreCompleto) return { maggiorazione: 0, categoria: 'CAT01', supplementoCabina: 0 };
            
            // Estrai codice colore (prima del trattino)
            const codice = coloreCompleto.split('-')[0].trim().toUpperCase();
            
            // Cerca in tutte le categorie
            for (const [catId, catData] of Object.entries(COLORI_PERSIANE_CATEGORIE)) {
                if (catData.colori.some(c => codice.includes(c))) {
                    console.log(`ğŸ¨ Colore "${codice}" â†’ ${catId} (+${catData.maggiorazione}%)`);
                    return {
                        maggiorazione: catData.maggiorazione,
                        categoria: catId,
                        supplementoCabina: catData.supplementoCabina || 0
                    };
                }
            }
            
            // Default: categoria standard
            console.warn(`âš ï¸ Colore "${codice}" non trovato, uso CAT01 (0%)`);
            return { maggiorazione: 0, categoria: 'CAT01', supplementoCabina: 0 };
        }
        
        /**
         * Calcola prezzo persiana Punto Persiane con interpolazione lineare
         * @param {number} L_mm - Larghezza in mm
         * @param {number} H_mm - Altezza in mm
         * @param {string} tipologia - Tipologia (F1, F2, F3, F4, PF1, PF2)
         * @returns {object} Dettaglio calcolo con prezzo base, totale
         */
        function calcolaPrezzoPUNTOPERSIANE(L_mm, H_mm, tipologia = 'F1') {
            // Verifica tipologia esistente
            if (!LISTINO_PUNTO_PERSIANE[tipologia]) {
                console.warn(`âš ï¸ Tipologia ${tipologia} non trovata, uso F1`);
                tipologia = 'F1';
            }
            
            const listino = LISTINO_PUNTO_PERSIANE[tipologia];
            const larghezze = listino.larghezze;
            const altezze = Object.keys(listino.prezzi).map(Number).sort((a,b) => a-b);
            
            // Trova larghezza piÃ¹ vicina o interpola
            let idx_L = -1;
            for (let i = 0; i < larghezze.length; i++) {
                if (L_mm <= larghezze[i]) {
                    idx_L = i;
                    break;
                }
            }
            
            // Se fuori range, usa estremi
            if (idx_L === -1) idx_L = larghezze.length - 1;
            if (idx_L === 0 && L_mm < larghezze[0]) idx_L = 0;
            
            // Trova altezza piÃ¹ vicina o interpola
            let idx_H = -1;
            for (let i = 0; i < altezze.length; i++) {
                if (H_mm <= altezze[i]) {
                    idx_H = i;
                    break;
                }
            }
            
            // Se fuori range, usa estremi
            if (idx_H === -1) idx_H = altezze.length - 1;
            if (idx_H === 0 && H_mm < altezze[0]) idx_H = 0;
            
            // Leggi prezzo dalla griglia
            const L_ref = larghezze[idx_L];
            const H_ref = altezze[idx_H];
            const prezzoBase = listino.prezzi[H_ref][idx_L];
            
            console.log(`ğŸ“ Persiana ${tipologia}: L=${L_mm}mmâ†’${L_ref}mm, H=${H_mm}mmâ†’${H_ref}mm = â‚¬${prezzoBase}`);
            
            return {
                prezzo_base: prezzoBase,
                totale: prezzoBase,
                dettaglio: {
                    larghezza_mm: L_mm,
                    altezza_mm: H_mm,
                    larghezza_ref: L_ref,
                    altezza_ref: H_ref,
                    tipologia: tipologia
                }
            };
        }
        
        /**
         * ğŸ†• v7.92: Calcolo COMPLETO prezzo persiana con tutte le voci
         * Include: base + maggiorazione modello + colore + cardini + imballo + contributo
         */
        function calcolaPrezzoPersianaCOMPLETO(L_mm, H_mm, tipologia, modello, colore, numAnte = 2) {
            // 1. Prezzo base da griglia
            const calcBase = calcolaPrezzoPUNTOPERSIANE(L_mm, H_mm, tipologia);
            let prezzoBase = calcBase.prezzo_base;
            
            // 2. Maggiorazione modello
            const maggiorazioneModello = MAGGIORAZIONI_MODELLI_PERSIANE[modello] || 0;
            const supplementoModello = prezzoBase * maggiorazioneModello;
            prezzoBase += supplementoModello;
            
            console.log(`ğŸ  Modello ${modello}: Base â‚¬${calcBase.prezzo_base} + ${(maggiorazioneModello*100).toFixed(1)}% = â‚¬${prezzoBase.toFixed(2)}`);
            
            // 3. Maggiorazione colore
            let supplementoColore = 0;
            let categoriaColore = 'CAT01';
            if (colore) {
                const infoColore = trovaMaggiorazioneColorePersiana(colore);
                supplementoColore = prezzoBase * (infoColore.maggiorazione / 100);
                categoriaColore = infoColore.categoria;
                console.log(`ğŸ¨ Colore ${colore} (${categoriaColore}): +${infoColore.maggiorazione}% = â‚¬${supplementoColore.toFixed(2)}`);
            }
            
            // 4. Spagnolette: INCLUSE nel prezzo base (Kit spagnoletta nera standard)
            // Il supplemento â‚¬45 Ã¨ SOLO per aperture a LIBRO (LIB-DX, LIB-SX)
            const supplementoSpagnolette = 0; // v7.93: GiÃ  incluse nel prezzo base
            
            // Subtotale persiana
            const subtotalePersiana = prezzoBase + supplementoColore + supplementoSpagnolette;
            
            // 5. Cardini (4 pz Ã— â‚¬3.50 = â‚¬14.00 per F2)
            const cardini = VOCI_FISSE_PERSIANE.cardiniBase * VOCI_FISSE_PERSIANE.cardiniQuantita;
            
            // 6. Imballo 3%
            const baseImballo = subtotalePersiana + cardini;
            const imballo = baseImballo * (VOCI_FISSE_PERSIANE.imballoPercent / 100);
            
            // 7. Contributo gestione
            const contributoGestione = VOCI_FISSE_PERSIANE.contributoGestione;
            
            // TOTALE FINALE
            const totaleFinale = subtotalePersiana + cardini + imballo + contributoGestione;
            
            console.log(`ğŸ’° Persiana COMPLETO: Base â‚¬${prezzoBase.toFixed(2)} + Colore â‚¬${supplementoColore.toFixed(2)} + Spagn â‚¬${supplementoSpagnolette} + Cardini â‚¬${cardini.toFixed(2)} + Imb â‚¬${imballo.toFixed(2)} + Contrib â‚¬${contributoGestione} = â‚¬${totaleFinale.toFixed(2)}`);
            
            return {
                prezzo_base_griglia: calcBase.prezzo_base,
                maggiorazione_modello: supplementoModello,
                prezzo_base_con_modello: prezzoBase,
                supplemento_colore: supplementoColore,
                categoria_colore: categoriaColore,
                supplemento_spagnolette: supplementoSpagnolette,
                subtotale_persiana: subtotalePersiana,
                cardini: cardini,
                imballo: imballo,
                contributo_gestione: contributoGestione,
                totale: totaleFinale,
                dettaglio: calcBase.dettaglio
            };
        }

        // ============================================================================
        // LISTINO PLASTICINO TAPPARELLE - 2025
        // ============================================================================
        
        const LISTINO_PLASTICINO = {
            // Componenti base tapparella
            componenti: {
                rullo: {
                    codice: "COMP-01",
                    nome: "Rullo Ottagonale 60mm",
                    prezzo_al_metro: 13.20,
                    calcolo: "larghezza_luce_m Ã— 13.20"
                },
                fissi: {
                    calotta: 15.00,              // COMP-02
                    avvolgitore: 10.00,          // COMP-03
                    cuscinetto: 3.50,            // COMP-04
                    supporti_coppia: 6.00,       // COMP-05 (2 pz)
                    ganci_coppia: 7.20,          // COMP-06 (2 pz)
                    placca: 5.00,                // COMP-08
                    passacinghia: 1.70,          // COMP-09
                    macchinetta: 18.00           // COMP-10
                },
                totale_fissi: 66.40  // Somma componenti fissi
            },
            
            // ğŸ†• TELI AVVOLGIBILI - Database completo da catalogo Plasticino 07.2022
            teli: {
                // ALLUMINIO COIBENTATO MEDIA DENSITÃ€
                'TA01': { nome: 'ALUPROFIL MD 13x55', tipo: 'Alluminio MD', prezzo_tinta_unita: 60.00, prezzo_tinta_legno: 61.50, prezzo_tinta_raffaello: 62.50 },
                'TA25': { nome: 'ALUPROFIL AD 13x55', tipo: 'Alluminio AD', prezzo_tinta_unita: 73.00, prezzo_tinta_legno: 74.50, prezzo_tinta_raffaello: 75.50 },
                'TA05': { nome: 'ALUPROFIL MD 9x41', tipo: 'Alluminio MD', prezzo_tinta_unita: 66.00, prezzo_tinta_legno: 67.50, prezzo_tinta_raffaello: 68.50 },
                'TA30': { nome: 'ALUPROFIL AD 9x41', tipo: 'Alluminio AD', prezzo_tinta_unita: 72.00, prezzo_tinta_legno: 73.50, prezzo_tinta_raffaello: 74.50 },
                'TA42': { nome: 'ALUPROFIL MD 8,5x32', tipo: 'Alluminio MD', prezzo_tinta_unita: 90.00, prezzo_tinta_legno: 91.50, prezzo_tinta_raffaello: 92.50 },
                'TA07': { nome: 'ALUPROFIL MD 8x37', tipo: 'Alluminio MD', prezzo_tinta_unita: 77.00, prezzo_tinta_legno: 78.50, prezzo_tinta_raffaello: null },
                
                // ACCIAIO COIBENTATO
                'TA15': { nome: 'STEELPROFIL 13x55', tipo: 'Acciaio', prezzo_tinta_unita: 75.00, prezzo_tinta_legno: 76.50, prezzo_tinta_raffaello: 77.50 },
                'TA20': { nome: 'STEELPROFIL 9x40', tipo: 'Acciaio', prezzo_tinta_unita: 109.00, prezzo_tinta_legno: 118.00, prezzo_tinta_raffaello: 120.00 },
                
                // PVC ESTRUSO
                'A01': { nome: 'ANTIGRANDINE 14x50', tipo: 'PVC', prezzo_tinta_unita: 46.20, prezzo_tinta_legno: null, prezzo_tinta_raffaello: null },
                'A10': { nome: 'PESANTE 14x50', tipo: 'PVC', prezzo_tinta_unita: 39.70, prezzo_tinta_legno: null, prezzo_tinta_raffaello: null },
                'A16': { nome: 'MINI 10 11x32', tipo: 'PVC', prezzo_tinta_unita: 54.40, prezzo_tinta_legno: null, prezzo_tinta_raffaello: null }
            },
            
            // Modello telo di default (se non specificato)
            modello_telo_default: 'TA01',  // ALUPROFIL MD 13x55 tinta unita
            colore_telo_default: 'tinta_unita',
            
            // Supplementi opzionali
            supplementi: {
                doppia_altezza: {
                    codice: "COMP-07",
                    soglia_cm: 300,              // Applica supplemento se H > 300cm
                    prezzo_al_metro: 0.50,
                    calcolo: "(altezza - 300) / 100 Ã— 0.50"
                }
            },
            
            // ğŸ†• GUIDE TAPPARELLE - Da catalogo Plasticino 07.2022
            guide: {
                // Guide 30x25x30 - COLORI STANDARD (Argento, Bronzo, Elox, Bianco)
                'TG15OX': { nome: 'Guide 30x25x30 FINESTRA', prezzo: 40.00, um: 'CP' },
                'TG10OX': { nome: 'Guide 30x25x30 PORTAFINESTRA', prezzo: 57.60, um: 'CP' },
                
                // Guide 30x25x30 - COLORI RAL
                'TG15VE': { nome: 'Guide 30x25x30 FINESTRA RAL', prezzo: 50.90, um: 'CP' },
                'TG10VE': { nome: 'Guide 30x25x30 PORTAFINESTRA RAL', prezzo: 69.00, um: 'CP' },
                
                // Guide 30x25x30 - RAL A RICHIESTA
                'TG15RA': { nome: 'Guide 30x25x30 FINESTRA RAL custom', prezzo: null, um: 'CP' },
                'TG10RA': { nome: 'Guide 30x25x30 PORTAFINESTRA RAL custom', prezzo: null, um: 'CP' },
                
                // Guide 28x19x28
                'TG18OX': { nome: 'Guide 28x19x28 FINESTRA', prezzo: 36.00, um: 'CP' },
                'TG17OX': { nome: 'Guide 28x19x28 PORTAFINESTRA', prezzo: 52.00, um: 'CP' },
                
                // Guide BARRE 6800mm
                'TG30': { nome: 'Guide 30x25x30 BARRE 6800mm', prezzo: 11.40, um: 'ML' },
                'TG33': { nome: 'Guide 28x19x28 BARRE 6800mm', prezzo: 10.20, um: 'ML' }
            },
            
            // Colori guide disponibili
            colori_guide: {
                standard: ['Argento', 'Bronzo', 'Elox', 'Bianco'],
                ral: ['Avorio RAL 1013', 'Verde RAL 6005', 'Marrone RAL 8014', 'Marrone RAL 8017', 'Marrone RAL 8019']
            },
            
            // Aziende che usano questo listino
            aziende: ['plasticino', 'new solar', 'estella']
        };
        
        // ============================================================================
        // LISTINO ACCESSORI PERSIANE - Cardini + Fermapersiane (Punto Persiane)
        // ============================================================================
        
        const LISTINO_ACCESSORI_PERSIANE = {
            // Cardini a muro (pag. 190)
            cardini: {
                'C.SAF90': { nome: 'Cardine SAF 90mm (facciata)', prezzo: 0 },
                'C.SAF150': { nome: 'Cardine SAF 150mm (cappotto)', prezzo: 0 },
                'C.SAF240': { nome: 'Cardine SAF 240mm (cappotto spesso)', prezzo: 0 },
                'C.SAF320': { nome: 'Cardine SAF 320mm (cappotto XL)', prezzo: 0 },
                'C.REG.SAF90': { nome: 'Cardine Regolabile 90mm', prezzo: 0 },
                'C.REG.SAF150': { nome: 'Cardine Regolabile 150mm', prezzo: 0 },
                'CHA.1': { nome: 'Cardine mensola lama stretta', prezzo: 18.00 },
                'CHA.SP': { nome: 'Spessore 3mm per CHA.1', prezzo: 6.00 }
            },
            
            // Fermapersiane (pag. 182)
            fermapersiane: {
                'K.EASY': { nome: 'Ferma KOMFORT a scomparsa', prezzo: 56.00 },
                'F.INC': { nome: 'Fermo Piemontese incassato', prezzo: 45.00 },
                'GRILLO': { nome: 'Ferma tipo Grillo', prezzo: 0 },
                'SALTARELLO': { nome: 'Ferma tipo Saltarello', prezzo: 0 },
                'PIEMONTESE': { nome: 'Ferma tipo Piemontese', prezzo: 0 },
                'OMETTO': { nome: 'Ferma tipo Ometto (pavimento)', prezzo: 0 }
            },
            
            // Verniciatura accessori (pag. 191)
            verniciatura: {
                cardini: { prezzo_unitario: 22.00, minimo_fatturabile: 60.00, contributo_fisso: 100.00 },
                bandelle: { prezzo_unitario: 7.00, minimo_fatturabile: 84.00, contributo_fisso: 100.00 }
            }
        };
        
        /**
         * Calcola prezzo accessori persiana (Cardini + Fermapersiane)
         * @param {object} accessoriPersiana - Oggetto con cardini e fermapersiane
         * @returns {object} Dettaglio calcolo con prezzi
         */
        function calcolaPrezzoAccessoriPersiana(accessoriPersiana) {
            if (!accessoriPersiana) return { totale: 0, dettaglio: [] };
            
            let totale = 0;
            const dettaglio = [];
            
            // Cardini
            if (accessoriPersiana.cardini && accessoriPersiana.cardini.qta > 0) {
                const cardine = LISTINO_ACCESSORI_PERSIANE.cardini[accessoriPersiana.cardini.modello] || { prezzo: 0 };
                const prezzoCardini = accessoriPersiana.cardini.qta * cardine.prezzo;
                totale += prezzoCardini;
                if (cardine.prezzo > 0) {
                    dettaglio.push({
                        tipo: 'Cardini',
                        modello: accessoriPersiana.cardini.modello,
                        nome: cardine.nome,
                        qta: accessoriPersiana.cardini.qta,
                        prezzo_unitario: cardine.prezzo,
                        prezzo_totale: prezzoCardini
                    });
                }
            }
            
            // Fermapersiane
            if (accessoriPersiana.fermapersiane && accessoriPersiana.fermapersiane.qta > 0) {
                const ferma = LISTINO_ACCESSORI_PERSIANE.fermapersiane[accessoriPersiana.fermapersiane.modello] || { prezzo: 0 };
                const prezzoFerma = accessoriPersiana.fermapersiane.qta * ferma.prezzo;
                totale += prezzoFerma;
                if (ferma.prezzo > 0) {
                    dettaglio.push({
                        tipo: 'Fermapersiane',
                        modello: accessoriPersiana.fermapersiane.modello,
                        nome: ferma.nome,
                        qta: accessoriPersiana.fermapersiane.qta,
                        prezzo_unitario: ferma.prezzo,
                        prezzo_totale: prezzoFerma
                    });
                }
            }
            
            return { totale, dettaglio };
        }
        
        /**
         * Calcola prezzo tapparella Plasticino completo
         * @param {number} L_cm - Larghezza luce in cm
         * @param {number} H_cm - Altezza in cm
         * @param {string} modello_telo - Modello telo (es. 'TA01', 'TA25', 'A01'). Default: 'TA01'
         * @param {string} colore_telo - Tipo colore ('tinta_unita', 'tinta_legno', 'tinta_raffaello'). Default: 'tinta_unita'
         * @returns {object} Dettaglio calcolo con rullo, telo, fissi, supplemento, totale
         */
        function calcolaPrezzoPLASTICINO(L_cm, H_cm, modello_telo = null, colore_telo = null) {
            const L_m = L_cm / 100;
            
            // COMP-01: Rullo (al metro sulla larghezza luce)
            const prezzoRullo = L_m * LISTINO_PLASTICINO.componenti.rullo.prezzo_al_metro;
            
            // ğŸ†• TELO AVVOLGIBILE (al mq sulla superficie)
            const superficie_mq = (L_cm * H_cm) / 10000;
            
            // Determina modello telo (usa default se non specificato)
            let modello = modello_telo || LISTINO_PLASTICINO.modello_telo_default;
            const coloreTipo = colore_telo || LISTINO_PLASTICINO.colore_telo_default;
            
            // Recupera dati telo
            let teloData = LISTINO_PLASTICINO.teli[modello];
            if (!teloData) {
                console.warn(`âš ï¸ Modello telo "${modello}" non trovato, uso default ${LISTINO_PLASTICINO.modello_telo_default}`);
                modello = LISTINO_PLASTICINO.modello_telo_default;
                teloData = LISTINO_PLASTICINO.teli[modello];
            }
            
            // Recupera prezzo in base al colore
            let prezzoTeloAlMq = 0;
            if (coloreTipo === 'tinta_raffaello' && teloData.prezzo_tinta_raffaello) {
                prezzoTeloAlMq = teloData.prezzo_tinta_raffaello;
            } else if (coloreTipo === 'tinta_legno' && teloData.prezzo_tinta_legno) {
                prezzoTeloAlMq = teloData.prezzo_tinta_legno;
            } else {
                prezzoTeloAlMq = teloData.prezzo_tinta_unita;
            }
            
            const prezzoTelo = superficie_mq * prezzoTeloAlMq;
            
            // COMP-02 a COMP-10: Componenti fissi (totale â‚¬66.40)
            const fissi = LISTINO_PLASTICINO.componenti.totale_fissi;
            
            // COMP-07: Supplemento doppia altezza (se H > 300cm)
            let suppAltezza = 0;
            if (H_cm > LISTINO_PLASTICINO.supplementi.doppia_altezza.soglia_cm) {
                const H_extra_m = (H_cm - LISTINO_PLASTICINO.supplementi.doppia_altezza.soglia_cm) / 100;
                suppAltezza = H_extra_m * LISTINO_PLASTICINO.supplementi.doppia_altezza.prezzo_al_metro;
            }
            
            // Totale tapparella = RULLO + TELO + FISSI + SUPPLEMENTO ALTEZZA
            const totale = prezzoRullo + prezzoTelo + fissi + suppAltezza;
            
            return {
                rullo: prezzoRullo,
                telo: prezzoTelo,
                telo_mq: superficie_mq,
                telo_prezzo_mq: prezzoTeloAlMq,
                telo_modello: teloData.nome,
                fissi: fissi,
                supplemento_altezza: suppAltezza,
                totale: totale,
                dettaglio: {
                    larghezza_cm: L_cm,
                    altezza_cm: H_cm,
                    larghezza_m: L_m.toFixed(2),
                    superficie_mq: superficie_mq.toFixed(2),
                    sopra_soglia: H_cm > LISTINO_PLASTICINO.supplementi.doppia_altezza.soglia_cm
                }
            };
        }

        /**
         * ğŸ†• Calcola prezzo guida tapparella
         * @param {string} codiceGuida - Es. "TG10 - Guide 30x25x30 Portafinestra"
         * @param {string} coloreGuida - Es. "Argento"
         * @param {number} altezzaMm - Altezza finestra in mm (per barre)
         */
        function calcolaPrezzoGuida(codiceGuida, coloreGuida = 'Argento', altezzaMm = null) {
            if (!codiceGuida || codiceGuida === '') {
                return { codice: '', prezzo: 0, note: 'Nessuna guida' };
            }
            
            // Estrai codice dalla stringa (es. "TG10 - Guide..." â†’ "TG10")
            let codice = codiceGuida;
            if (codiceGuida.includes(' - ')) {
                codice = codiceGuida.split(' - ')[0].trim();
            }
            
            // Determina variante in base al colore
            const coloriStandard = LISTINO_PLASTICINO.colori_guide?.standard || [];
            const coloriRAL = LISTINO_PLASTICINO.colori_guide?.ral || [];
            const isColoreStandard = coloriStandard.includes(coloreGuida);
            const isColoreRAL = coloriRAL.includes(coloreGuida);
            
            let codiceEffettivo = codice;
            if (codice === 'TG15' || codice === 'TG10') {
                if (isColoreStandard) codiceEffettivo = codice + 'OX';
                else if (isColoreRAL) codiceEffettivo = codice + 'VE';
                else codiceEffettivo = codice + 'RA';
            }
            
            const guida = LISTINO_PLASTICINO.guide?.[codiceEffettivo];
            if (!guida) {
                console.warn(`âš ï¸ Guida "${codiceEffettivo}" non trovata nel listino`);
                return { codice: codiceEffettivo, prezzo: 0, note: 'Guida non trovata' };
            }
            
            if (guida.prezzo === null) {
                return { codice: codiceEffettivo, descrizione: guida.nome, prezzo: 0, note: 'A PREVENTIVO' };
            }
            
            let prezzoFinale = guida.prezzo;
            let quantita = 1;
            
            // Se ML, calcola in base all'altezza (2 guide)
            if (guida.um === 'ML' && altezzaMm) {
                quantita = (altezzaMm / 1000) * 2;
                prezzoFinale = Math.round(guida.prezzo * quantita * 100) / 100;
            }
            
            return {
                codice: codiceEffettivo,
                descrizione: guida.nome,
                colore: coloreGuida,
                prezzoUnitario: guida.prezzo,
                prezzo: prezzoFinale,
                um: guida.um,
                quantita: quantita
            };
        }

        /**
         * ğŸ§ª Test Calcolo Tapparella
         * Funzione per testare rapidamente il calcolo prezzi nel popup Gestione Listini
         */
        function testCalcoloTapparella() {
            const L_input = document.getElementById('test-tapp-L').value;
            const H_input = document.getElementById('test-tapp-H').value;
            
            const resultDiv = document.getElementById('test-tapp-result');
            const dettaglioDiv = document.getElementById('test-tapp-dettaglio');
            
            if (!L_input || !H_input) {
                resultDiv.innerHTML = 'âš ï¸';
                resultDiv.style.color = '#dc2626';
                dettaglioDiv.style.display = 'none';
                return;
            }
            
            const L_cm = parseFloat(L_input);
            const H_cm = parseFloat(H_input);
            
            if (L_cm <= 0 || H_cm <= 0) {
                resultDiv.innerHTML = 'âŒ';
                resultDiv.style.color = '#dc2626';
                dettaglioDiv.style.display = 'none';
                return;
            }
            
            // Calcola prezzo
            const calcolo = calcolaPrezzoPLASTICINO(L_cm, H_cm);
            
            // Mostra risultato
            resultDiv.innerHTML = `â‚¬${calcolo.totale.toFixed(2)}`;
            resultDiv.style.color = '#059669';
            
            // Mostra dettaglio
            dettaglioDiv.style.display = 'block';
            dettaglioDiv.innerHTML = `
                <strong>Dettaglio Calcolo:</strong><br>
                L = ${L_cm}cm (${calcolo.dettaglio.larghezza_m}m)<br>
                H = ${H_cm}cm ${calcolo.dettaglio.sopra_soglia ? '(> 300cm âš ï¸)' : '(â‰¤ 300cm âœ“)'}<br>
                <br>
                Rullo: ${calcolo.dettaglio.larghezza_m}m Ã— â‚¬13.20 = â‚¬${calcolo.rullo.toFixed(2)}<br>
                Componenti Fissi: â‚¬${calcolo.fissi.toFixed(2)}<br>
                ${calcolo.supplemento_altezza > 0 ? 
                    `Supplemento Altezza: â‚¬${calcolo.supplemento_altezza.toFixed(2)}<br>` : 
                    ''}
                <br>
                <strong style="color: #059669;">TOTALE: â‚¬${calcolo.totale.toFixed(2)}</strong>
            `;
        }

        /**
         * ğŸ§ª Test Calcolo Tapparella per TAB Dettaglio Costi
         */
        function testCalcoloTapparellaDettaglio() {
            const L_input = document.getElementById('test-tapp-L-dettaglio').value;
            const H_input = document.getElementById('test-tapp-H-dettaglio').value;
            
            const resultDiv = document.getElementById('test-tapp-result-dettaglio');
            const dettaglioDiv = document.getElementById('test-tapp-dettaglio-result');
            
            if (!L_input || !H_input) {
                resultDiv.innerHTML = 'âš ï¸';
                resultDiv.style.color = '#dc2626';
                dettaglioDiv.style.display = 'none';
                return;
            }
            
            const L_cm = parseFloat(L_input);
            const H_cm = parseFloat(H_input);
            
            if (L_cm <= 0 || H_cm <= 0) {
                resultDiv.innerHTML = 'âŒ';
                resultDiv.style.color = '#dc2626';
                dettaglioDiv.style.display = 'none';
                return;
            }
            
            // Calcola prezzo
            const calcolo = calcolaPrezzoPLASTICINO(L_cm, H_cm);
            
            // Mostra risultato
            resultDiv.innerHTML = `â‚¬${calcolo.totale.toFixed(2)}`;
            resultDiv.style.color = '#059669';
            
            // Mostra dettaglio
            dettaglioDiv.style.display = 'block';
            dettaglioDiv.innerHTML = `
                <strong>Dettaglio Calcolo:</strong><br>
                L = ${L_cm}cm (${calcolo.dettaglio.larghezza_m}m)<br>
                H = ${H_cm}cm ${calcolo.dettaglio.sopra_soglia ? '(> 300cm âš ï¸)' : '(â‰¤ 300cm âœ“)'}<br>
                <br>
                Rullo: ${calcolo.dettaglio.larghezza_m}m Ã— â‚¬13.20 = â‚¬${calcolo.rullo.toFixed(2)}<br>
                Componenti Fissi: â‚¬${calcolo.fissi.toFixed(2)}<br>
                ${calcolo.supplemento_altezza > 0 ? 
                    `Supplemento Altezza: â‚¬${calcolo.supplemento_altezza.toFixed(2)}<br>` : 
                    ''}
                <br>
                <strong style="color: #059669;">TOTALE: â‚¬${calcolo.totale.toFixed(2)}</strong>
            `;
        }

        // ============================================================================
        // âœ… v7.73: DATABASE CONFIGURAZIONI PRODOTTI
        // ============================================================================
        
        // ============================================================================
        // âœ… v7.73: DATABASE CONFIGURAZIONI CON AZIENDE DA AZIENDE.txt
        // ============================================================================
        // v7.80: DATABASE CONFIGURAZIONI con valori corretti dai file progetto
        const DATABASE_CONFIGURAZIONI = {
            infissi: {
                azienda: { options: ['finstral', 'essepi', 'schuco', 'oknoplast', 'internorm'], allowCustom: true, label: 'ğŸ¢ Azienda' },
                telaio: { options: ['961', '962', '963', '964', '965', '966', '967', 'Z62', 'Z91', '924', '951', '991', '129', '923'], allowCustom: true, label: 'ğŸªŸ Telaio' },
                materialeTelaio: { options: ['PVC/PVC', 'PVC/Alluminio', 'Legno/Alluminio'], allowCustom: true, label: 'ğŸ”© Materiale' },
                tipoAnta: { options: ['Nova-line', 'Nova-line Plus', 'Nova-line Twin', 'Nova-line Cristal Twin', 'Classic-line', 'Step-line', 'Step-line Door', 'Slim-line', 'Slim-line Cristal', 'Slim-line Twin', 'Slim-line Cristal Twin'], allowCustom: true, label: 'ğŸšª Tipo Anta' },
                vetro: { options: ['doppio', 'triplo', 'doppio satinato', 'triplo satinato'], allowCustom: true, label: 'ğŸ’ Vetro' },
                finituraInt: { options: ['pvc', 'alluminio', 'legno'], allowCustom: true, label: 'âœ¨ Finitura Int' },
                coloreInt: { 
                    options: [
                        '01 - Bianco', '45 - Bianco', '27 - Bianco perla', '42 - Bianco', '07 - Bianco perla',
                        '46 - Grigio seta', '06 - Grigio', '13 - Castagno decoro legno', '19 - Rovere decoro legno', '55 - Noce chiaro decoro legno'
                    ],
                    allowCustom: true, label: 'ğŸ¨ Colore Int'
                },
                finituraEst: { options: ['pvc', 'alluminio', 'legno'], allowCustom: true, label: 'âœ¨ Finitura Est' },
                coloreEst: { 
                    options: [
                        '01 - Bianco', '45 - Bianco', '27 - Bianco perla', '42 - Bianco', '07 - Bianco perla',
                        '46 - Grigio seta', '06 - Grigio', '13 - Castagno decoro legno', '19 - Rovere decoro legno', '55 - Noce chiaro decoro legno',
                        'L13 - Castagno verniciato', 'L14 - Mogano verniciato', 'L16 - Douglas verniciato', 'L18 - Noce verniciato', 'L19 - Rovere verniciato',
                        'M01 - Bianco opaco', 'F716 - Grigio antracite', 'F744 - Grigio seta', 'F905 - Nero intenso'
                    ],
                    allowCustom: true, label: 'ğŸ¨ Colore Est'
                },
                maniglia: { 
                    options: ['601 - STANDARD', '712 - A PRESSIONE', '773 - DOPPIA ANTA/RIBALTA', '772 - DOPPIA ANTA'], 
                    allowCustom: true, label: 'ğŸ”§ Maniglia' 
                },
                coloreManiglia: { 
                    options: ['01 - BIANCO', '07 - PERLA', '56 - NEUTRO ANODIZZATO', '74 - BRONZO', '40 - OTTONE LUCIDO', '79 - TITANIO', 'M01 - BIANCO', 'M03 - NERO', 'M07 - BIANCO CREMA'], 
                    allowCustom: true, label: 'ğŸ¨ Col. Maniglia' 
                },
                allarme: { options: ['no', 'predisposizione', 'installato'], allowCustom: false, label: 'ğŸ”” Allarme' }
            },
            persiane: {
                azienda: { options: ['P. Persiane'], allowCustom: true, label: 'ğŸ¢ Azienda' },
                modello: { options: ['Angela', 'Giulia', 'Luna', 'Aurora', 'Alto Adige', 'Cortina', 'Oscura', 'Nerina', 'Scandola', 'Scandola Duo', 'Oscura Duo'], allowCustom: true, label: 'ğŸ“‹ Modello' },
                telaio: { options: ['TH10', 'TH40', 'TH41', 'TH45', 'TH46R', 'TH62', 'TH80', 'TH53'], allowCustom: true, label: 'ğŸªŸ Telaio' },
                colore: { options: ['CPF910L - Bianco puro', 'CPF113L - Bianco perla', 'CPF701L - Grigio argento', 'CPF716L - Antracite', 'CPF605L - Verde muschio', 'CPF817L - Marrone cioccolato'], allowCustom: true, label: 'ğŸ¨ Colore' }
            },
            tapparelle: {
                azienda: { options: ['Plasticino', 'New Solar', 'Estella'], allowCustom: true, label: 'ğŸ¢ Azienda' },
                tipo: { options: ['Standard', 'Coibentata', 'Alta densitÃ ', 'Blindata'], allowCustom: true, label: 'ğŸ“‹ Tipo' },
                materiale: { options: ['PVC', 'Alluminio', 'Acciaio'], allowCustom: true, label: 'ğŸ”© Materiale' },
                colore: { options: ['Bianco', 'Avorio', 'Marrone', 'Grigio'], allowCustom: true, label: 'ğŸ¨ Colore' },
                automazione: { options: ['Cinghia', 'Manovella', 'Motore', 'Motore+telecomando'], allowCustom: true, label: 'âš¡ Automazione' }
            },
            cassonetti: {
                azienda: { options: ['Finstral', 'MagÃ²', 'Alpac'], allowCustom: true, label: 'ğŸ¢ Azienda' },
                tipo: { options: ['Cassonetto', 'Isolamento', 'Monoblocco'], allowCustom: true, label: 'ğŸ“‹ Tipo' },
                ispezione: { options: ['Frontale', 'Esterna'], allowCustom: true, label: 'ğŸ” Ispezione' },
                isolamentoPosaclima: { options: ['SÃ¬', 'No'], allowCustom: false, label: 'ğŸŒ¡ï¸ Isolamento Posaclima' }
            },
            zanzariere: {
                azienda: { options: ['Palagina', 'Finstral'], allowCustom: true, label: 'ğŸ¢ Azienda' },
                tipo: { options: ['A rullo verticale', 'A rullo laterale', 'PlissÃ©', 'Fissa', 'A battente'], allowCustom: true, label: 'ğŸ“‹ Tipo' },
                colore: { options: ['Bianco', 'Marrone', 'Grigio', 'Nero'], allowCustom: true, label: 'ğŸ¨ Colore' },
                rete: { options: ['Standard', 'Antivento', 'Anti polline', 'Pet resistant'], allowCustom: true, label: 'ğŸ•¸ï¸ Tipo Rete' }
            }
        };

        // Stato configurazione corrente
        let configCorrente = {
            infissi: {},
            persiane: {},
            tapparelle: {},
            cassonetti: {},
            zanzariere: {}
        };

        // ============================================================================
        // LISTINO FINSTRAL INFISSI - EUR 2025/3
        // ============================================================================
        
        const FINSTRAL_PREZZI = {
            versione: "EUR 2025/3",
            dataAggiornamento: "2025-11-25",
            
            // TABELLE PREZZI BASE - Tipo 101 (1 anta anta/ribalta)
            tipo101: {
                descrizione: "Finestra 1 anta (anta/ribalta)",
                colonneL: [615, 675, 740, 800, 865, 925, 990, 1050, 1115, 1175, 1240, 1300, 1365, 1425, 1490, 1550, 1615, 1675, 1740, 1800, 1865, 1925, 1990, 2050, 2115, 2175, 2240, 2300, 2365, 2425, 2490, 2550, 2615, 2675, 2740],
                righeA: [605, 665, 730, 790, 855, 915, 980, 1040, 1105, 1165, 1230, 1290, 1355, 1415, 1480, 1540, 1605, 1665, 1730, 1790, 1855, 1915, 1980, 2040, 2105, 2165, 2230, 2290, 2355, 2415, 2480, 2540, 2605, 2665, 2730, 2790, 2855, 2915, 2980],
                prezzi: [
                    [221, 231, 237, 248, 258, 266, 287, 294, 300, 311, 317, 329, 340, 351, 362, 367, 378, 392, 403, 408, 415, 422, 436, 445, 460, 467, 478, 487, 496, 504, 511, 519, 528, 537, 545],
                    [229, 237, 243, 261, 267, 275, 295, 301, 311, 323, 329, 341, 354, 364, 371, 379, 395, 405, 415, 421, 432, 438, 449, 464, 477, 485, 492, 499, 506, 520, 530, 538, 546, 557, 567],
                    [235, 243, 257, 267, 276, 284, 308, 314, 327, 333, 343, 354, 366, 375, 382, 396, 408, 420, 427, 438, 447, 456, 471, 484, 498, 504, 512, 520, 528, 538, 544, 557, 568, 574, 584],
                    [248, 261, 269, 277, 288, 296, 314, 329, 337, 351, 363, 370, 380, 395, 405, 412, 424, 437, 448, 458, 467, 477, 493, 504, 515, 526, 537, 544, 557, 569, 580, 588, 598, 610, 618],
                    [259, 268, 277, 287, 297, 307, 328, 341, 352, 364, 374, 382, 396, 409, 417, 425, 441, 451, 466, 473, 486, 498, 511, 522, 537, 544, 556, 569, 577, 588, 599, 611, 619, 627, 640],
                    [272, 283, 289, 302, 316, 320, 350, 363, 370, 380, 393, 404, 417, 428, 440, 449, 465, 477, 490, 500, 511, 519, 537, 548, 565, 574, 585, 597, 611, 621, 634, 646, 659, 672, 683],
                    [285, 297, 308, 321, 335, 337, 368, 379, 392, 404, 412, 424, 437, 450, 464, 472, 491, 504, 514, 526, 537, 549, 565, 575, 588, 599, 611, 620, 630, 644, 653, 665, 675, 686, 693],
                    [295, 307, 319, 332, 349, 352, 378, 394, 405, 414, 424, 440, 450, 464, 474, 487, 504, 516, 530, 541, 554, 568, 582, 593, 611, 618, 627, 638, 647, 658, 667, 676, 685, 692, 702],
                    [299, 311, 324, 337, 352, 365, 392, 405, 414, 428, 440, 451, 465, 478, 493, 505, 518, 535, 549, 564, 575, 585, 600, 613, 626, 639, 650, 662, 674, 683, 692, 704, 713, 726, 736],
                    [308, 321, 333, 347, 364, 374, 402, 414, 427, 440, 450, 466, 478, 493, 507, 516, 535, 550, 568, 577, 588, 600, 617, 627, 648, 660, 673, 682, 691, 703, 712, 725, 735, 747, 756],
                    [320, 334, 347, 364, 376, 388, 416, 430, 443, 457, 469, 484, 498, 511, 523, 539, 556, 574, 586, 597, 613, 622, 637, 655, 674, 687, 700, 712, 727, 741, 754, 769, 785, 798, 813],
                    [328, 342, 361, 370, 384, 397, 425, 441, 451, 469, 482, 498, 511, 525, 539, 551, 572, 586, 601, 614, 626, 638, 660, 674, 691, 703, 717, 728, 740, 753, 768, 778, 802, 815, 829],
                    [337, 354, 367, 380, 398, 411, 438, 451, 469, 482, 497, 511, 525, 541, 553, 570, 587, 601, 625, 637, 654, 667, 687, 699, 718, 730, 742, 754, 768, 782, 795, 805, 818, 831, 843],
                    [350, 365, 375, 393, 409, 422, 450, 465, 480, 497, 511, 525, 541, 556, 572, 585, 602, 618, 639, 655, 674, 687, 704, 717, 734, 754, 775, 797, 817, 837, 855, 879, 897, 917, 937],
                    [361, 371, 382, 404, 418, 433, 464, 478, 497, 511, 523, 540, 554, 572, 586, 598, 619, 634, 660, 675, 689, 708, 726, 740, 758, 783, 804, 828, 850, 875, 895, 920, 935, 957, 980],
                    [368, 380, 397, 414, 431, 447, 477, 495, 507, 523, 539, 554, 572, 586, 599, 615, 634, 655, 678, 692, 706, 721, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [376, 395, 408, 423, 445, 457, 490, 505, 518, 539, 553, 573, 586, 601, 615, 628, 653, 677, 692, 709, 725, 741, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [382, 403, 416, 434, 450, 469, 502, 514, 530, 548, 567, 584, 597, 615, 627, 646, 675, 693, 708, 731, 745, 764, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [415, 433, 447, 466, 485, 503, 533, 550, 569, 584, 599, 618, 631, 654, 673, 688, 706, 725, 745, 762, 784, 801, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [422, 443, 456, 474, 496, 511, 542, 562, 581, 595, 612, 653, 670, 696, 714, 728, 747, 767, 789, 807, 827, 847, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [433, 451, 467, 487, 507, 526, 557, 578, 593, 611, 623, 662, 685, 701, 720, 735, 758, 774, 800, 817, 851, 886, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [437, 461, 482, 503, 525, 542, 577, 595, 612, 625, 647, 669, 687, 706, 725, 747, 768, 789, 808, 829, 893, 953, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [446, 469, 492, 512, 536, 549, 586, 606, 622, 644, 660, 678, 692, 716, 738, 759, 781, 801, 822, 842, 908, 974, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [463, 482, 503, 523, 543, 564, 596, 615, 636, 653, 675, 690, 707, 730, 752, 771, 793, 816, 838, 859, 926, 992, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [471, 493, 515, 536, 560, 581, 611, 630, 652, 674, 686, 700, 718, 739, 767, 784, 803, 822, 852, 876, 942, 1010, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [484, 505, 525, 544, 571, 590, 622, 647, 667, 685, 699, 710, 727, 749, 782, 797, 816, 835, 865, 892, 960, 1028, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [489, 511, 535, 557, 581, 598, 634, 660, 679, 698, 709, 721, 738, 762, 796, 809, 828, 844, 881, 905, 974, 1040, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [495, 518, 542, 568, 592, 610, 648, 668, 687, 707, 722, 734, 748, 774, 809, 820, 840, 856, 896, 920, 992, 1061, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [507, 531, 552, 579, 599, 621, 660, 681, 698, 721, 734, 747, 764, 789, 824, 833, 850, 868, 909, 937, 1008, 1082, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [513, 537, 565, 587, 611, 631, 670, 704, 741, 778, 793, 805, 824, 847, 859, 881, 898, 915, 934, 951, 1015, 1079, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [515, 541, 571, 598, 618, 643, 680, 716, 752, 790, 803, 817, 835, 856, 872, 892, 908, 929, 946, 964, 1026, 1088, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [518, 548, 580, 610, 625, 652, 688, 727, 761, 801, 815, 830, 847, 868, 899, 929, 945, 963, 966, 981, 1037, 1093, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [529, 559, 587, 619, 636, 664, 700, 736, 774, 814, 828, 839, 857, 884, 924, 958, 976, 994, 986, 993, 1043, 1096, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [533, 566, 596, 628, 665, 694, 727, 758, 794, 833, 847, 861, 870, 898, 946, 989, 1004, 1026, 1003, 1005, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [539, 573, 607, 640, 675, 709, 741, 778, 812, 851, 868, 883, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [541, 580, 613, 650, 694, 733, 768, 800, 833, 872, 888, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [543, 583, 621, 661, 715, 755, 791, 825, 856, 891, 904, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [552, 592, 631, 672, 734, 782, 815, 849, 884, 917, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    [560, 599, 640, 682, 752, 797, 830, 876, 907, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null]
                ]
            },

            // TABELLA PREZZI BASE - Tipo 102 (Elemento fisso)
            tipo102: {
                descrizione: "Elemento fisso",
                colonneL: [365, 490, 615, 740, 865, 990, 1115, 1240, 1365, 1490, 1615, 1740, 1865, 1990, 2115, 2240, 2365, 2490, 2615, 2740, 2865, 2990, 3115],
                righeA: [355, 415, 480, 540, 605, 665, 730, 790, 855, 915, 980, 1040, 1105, 1165, 1230, 1355, 1480, 1605, 1730, 1855, 1980, 2105, 2230, 2355, 2480, 2605, 2730, 2855, 2980],
                prezzi: [
                    [169, 177, 181, 190, 200, 208, 216, 224, 232, 239, 246, 257, 264, 272, 282, 292, 302, 312, 322, 332, 342, 351, 364],
                    [172, 179, 188, 194, 205, 214, 220, 229, 238, 245, 257, 267, 277, 288, 299, 309, 321, 330, 342, 352, 365, 375, 387],
                    [177, 182, 191, 199, 209, 218, 227, 235, 244, 259, 270, 282, 294, 306, 316, 328, 341, 352, 366, 377, 389, 401, 412],
                    [179, 188, 195, 202, 216, 222, 230, 243, 259, 270, 283, 296, 309, 321, 333, 347, 359, 374, 387, 397, 410, 423, 435],
                    [182, 191, 200, 207, 219, 228, 242, 258, 270, 283, 297, 311, 325, 338, 351, 368, 380, 395, 407, 420, 434, 447, 464],
                    [186, 195, 202, 212, 224, 237, 251, 268, 283, 296, 310, 326, 338, 355, 370, 384, 398, 412, 428, 441, 458, 472, 486],
                    [190, 199, 207, 217, 230, 246, 263, 280, 293, 309, 325, 339, 356, 372, 389, 402, 418, 434, 448, 466, 482, 498, 512],
                    [194, 202, 212, 220, 240, 258, 273, 289, 307, 322, 338, 354, 372, 389, 404, 420, 437, 452, 471, 487, 503, 519, 536],
                    [200, 211, 219, 230, 251, 270, 288, 306, 322, 338, 356, 374, 393, 410, 427, 443, 462, 480, 497, 513, 530, 549, 568],
                    [204, 214, 224, 239, 261, 281, 297, 315, 334, 351, 371, 391, 407, 425, 443, 463, 482, 500, 517, 535, 553, 573, 592],
                    [208, 218, 228, 246, 270, 289, 308, 327, 347, 368, 384, 404, 422, 443, 463, 483, 501, 522, 539, 559, 579, 597, 618],
                    [213, 220, 235, 254, 279, 298, 319, 337, 359, 380, 400, 419, 440, 461, 482, 501, 519, 540, 560, 581, 601, 622, 640],
                    [215, 226, 241, 263, 288, 308, 329, 350, 372, 393, 415, 434, 456, 479, 499, 519, 540, 562, 583, 605, 625, 646, 667],
                    [219, 229, 248, 271, 295, 317, 339, 363, 384, 405, 427, 448, 472, 493, 515, 536, 559, 582, 604, 625, 647, 669, 692],
                    [222, 234, 257, 280, 306, 327, 350, 374, 397, 419, 442, 466, 489, 512, 533, 557, 582, 604, 626, 648, 674, 695, 717],
                    [230, 245, 270, 294, 322, 346, 372, 397, 421, 445, 472, 496, 520, 545, 572, 596, 620, 645, 669, 695, 718, 744, 769],
                    [238, 259, 284, 309, 338, 368, 393, 420, 445, 473, 500, 526, 552, 580, 606, 633, 661, 687, 713, 739, 768, 795, 820],
                    [245, 269, 297, 325, 356, 385, 414, 442, 472, 500, 527, 556, 585, 614, 640, 672, 700, 729, 756, 785, 813, 842, 871],
                    [256, 281, 310, 339, 375, 404, 434, 466, 495, 526, 556, 587, 618, 647, 679, 708, 739, 770, 801, 830, 861, 893, 921],
                    [263, 293, 324, 356, 392, 423, 456, 489, 520, 553, 585, 618, 649, 683, 714, 746, 781, 811, 842, 876, 907, 938, 972],
                    [271, 306, 337, 372, 408, 442, 476, 511, 543, 579, 614, 647, 683, 717, 751, 785, 820, 852, 888, 920, 955, 989, 1023],
                    [281, 315, 350, 389, 425, 463, 499, 533, 572, 606, 641, 678, 714, 751, 786, 822, 856, 894, 930, 966, 1002, 1038, 1074],
                    [290, 327, 367, 403, 442, 483, 519, 557, 595, 633, 672, 708, 744, 785, 822, 857, 897, 936, 973, 1011, 1050, 1086, 1124],
                    [302, 340, 380, 419, 462, 502, 540, 580, 620, 660, 699, 739, 780, 820, 856, 897, 937, 977, 1017, 1055, 1096, 1135, 1176],
                    [311, 350, 392, 435, 479, 519, 562, 604, 644, 688, 728, 770, 811, 852, 894, 936, 977, 1018, 1059, 1102, 1142, 1187, 1226],
                    [321, 365, 406, 447, 495, 539, 583, 625, 670, 712, 756, 801, 842, 888, 929, 973, 1015, 1059, null, null, null, null, null],
                    [330, 376, 419, 464, 512, 558, 604, 647, 694, 739, 785, 829, 876, 920, 965, 1011, 1055, 1101, null, null, null, null, null],
                    [340, 389, 434, 480, 530, 578, 624, 673, 719, 764, 812, 861, 907, 955, 1002, 1049, 1096, 1142, null, null, null, null, null],
                    [350, 398, 446, 496, 548, 596, 645, 695, 742, 793, 841, 892, 939, 989, 1038, 1086, 1134, 1186, null, null, null, null, null]
                ]
            },

            // TABELLA PREZZI BASE - Tipo 401 (2 ante con montante mobile)
            tipo401: {
                descrizione: "2 ante con montante mobile",
                colonneL: [990, 1050, 1115, 1175, 1240, 1300, 1365, 1425, 1490, 1550, 1615, 1675, 1740, 1800, 1865, 1925, 1990, 2050, 2115, 2175, 2240, 2300, 2365, 2425, 2490, 2550, 2615],
                // âœ… v7.79: Corretto 1480â†’1490 per match con configuratore Finstral
                righeA: [605, 665, 730, 790, 855, 915, 980, 1040, 1105, 1165, 1230, 1290, 1355, 1415, 1490, 1540, 1605, 1665, 1730, 1790, 1855, 1915, 1980, 2040, 2105, 2165, 2230, 2290, 2355, 2415, 2480, 2540, 2605, 2665, 2730, 2790],
                prezzi: [
                    [378, 387, 393, 400, 408, 416, 424, 432, 441, 458, 465, 473, 482, 487, 496, 502, 509, 516, 524, 531, 539, 544, 553, 560, 570, 577, 583],
                    [392, 398, 407, 412, 418, 432, 440, 450, 457, 475, 486, 497, 506, 515, 524, 536, 545, 558, 569, 577, 584, 594, 601, 610, 619, 627, 637],
                    [403, 410, 417, 429, 435, 448, 457, 464, 472, 492, 500, 509, 517, 526, 535, 542, 554, 564, 574, 583, 593, 602, 612, 622, 632, 643, 651],
                    [423, 430, 438, 450, 460, 469, 482, 488, 498, 511, 523, 536, 546, 560, 572, 584, 594, 608, 619, 630, 641, 653, 665, 677, 689, 700, 712],
                    [436, 444, 456, 465, 476, 488, 497, 505, 512, 532, 541, 554, 567, 574, 586, 594, 607, 617, 628, 639, 650, 662, 675, 686, 698, 708, 720],
                    [462, 467, 480, 488, 497, 509, 519, 531, 539, 559, 570, 578, 590, 598, 611, 621, 631, 643, 654, 667, 678, 690, 701, 712, 723, 735, 746],
                    [489, 496, 504, 516, 526, 539, 551, 562, 571, 587, 601, 612, 623, 638, 648, 664, 675, 685, 698, 710, 722, 735, 748, 763, 776, 789, 802],
                    [514, 523, 533, 541, 557, 571, 580, 588, 604, 617, 633, 651, 666, 678, 695, 712, 725, 741, 753, 768, 780, 793, 804, 818, 830, 843, 857],
                    [527, 537, 551, 565, 573, 585, 600, 608, 618, 639, 655, 668, 679, 694, 710, 721, 734, 748, 763, 776, 790, 802, 815, 827, 840, 853, 868],
                    [540, 554, 568, 575, 587, 602, 613, 627, 639, 660, 672, 682, 694, 709, 719, 733, 745, 758, 773, 788, 801, 816, 828, 843, 857, 873, 888],
                    [566, 577, 587, 601, 609, 628, 638, 653, 664, 681, 698, 714, 729, 744, 760, 775, 793, 808, 822, 837, 850, 866, 881, 895, 910, 923, 938],
                    [579, 590, 601, 614, 628, 639, 655, 668, 679, 699, 716, 731, 746, 762, 780, 796, 810, 825, 841, 857, 875, 891, 906, 921, 937, 952, 970],
                    [599, 610, 626, 638, 653, 666, 680, 691, 705, 729, 743, 755, 771, 787, 801, 814, 827, 841, 857, 875, 891, 907, 922, 937, 953, 971, 986],
                    [613, 628, 640, 658, 669, 681, 696, 712, 725, 746, 762, 775, 790, 805, 821, 835, 848, 864, 881, 897, 912, 929, 944, 960, 977, 993, 1010],
                    [632, 641, 659, 670, 687, 703, 716, 730, 744, 763, 785, 803, 822, 838, 861, 879, 895, 916, 933, 950, 970, 986, 1003, 1020, 1037, 1054, 1073],
                    [650, 662, 678, 693, 709, 723, 740, 752, 764, 788, 805, 824, 839, 859, 878, 893, 911, 929, 947, 964, 983, 999, 1017, 1032, 1051, 1069, 1087],
                    [666, 682, 699, 710, 727, 741, 756, 772, 787, 809, 827, 843, 863, 880, 895, 913, 932, 950, 971, 989, 1010, 1029, 1047, 1068, 1087, 1106, 1124],
                    [682, 698, 710, 726, 740, 756, 773, 788, 805, 827, 843, 863, 880, 895, 915, 934, 951, 971, 989, 1008, 1027, 1044, 1065, 1085, 1104, 1122, 1139],
                    [732, 748, 763, 781, 798, 814, 829, 843, 863, 883, 903, 919, 939, 962, 980, 998, 1018, 1038, 1056, 1078, 1096, 1114, 1133, 1152, 1172, 1191, 1209],
                    [746, 761, 780, 796, 812, 830, 844, 862, 878, 903, 918, 937, 958, 975, 992, 1010, 1027, 1044, 1064, 1084, 1102, 1121, 1141, 1159, 1179, 1197, 1218],
                    [768, 784, 802, 816, 831, 852, 871, 882, 903, 926, 946, 965, 984, 1005, 1024, 1042, 1064, 1084, 1104, 1125, 1144, 1164, 1187, 1206, 1227, 1247, 1267],
                    [808, 823, 840, 859, 880, 893, 912, 932, 957, 974, 997, 1013, 1029, 1049, 1080, 1109, 1137, 1167, 1194, 1226, 1254, 1283, 1310, 1341, 1373, 1394, 1413],
                    [824, 842, 859, 878, 896, 916, 935, 952, 977, 997, 1018, 1034, 1051, 1076, 1106, 1134, 1160, 1191, 1221, 1247, 1281, 1308, 1338, 1366, 1396, 1427, 1449],
                    [838, 857, 877, 891, 913, 931, 953, 971, 997, 1013, 1033, 1052, 1076, 1092, 1123, 1151, 1184, 1216, 1243, 1279, 1306, 1338, 1369, 1399, 1431, 1465, 1487],
                    [852, 877, 901, 918, 938, 960, 977, 996, 1023, 1043, 1066, 1083, 1105, 1123, 1151, 1184, 1216, 1244, 1279, 1308, 1338, 1369, 1400, 1431, 1459, null, null],
                    [872, 893, 915, 935, 958, 975, 996, 1014, 1036, 1064, 1085, 1104, 1126, 1142, 1178, 1206, 1239, 1271, 1300, 1330, 1359, 1395, 1423, 1453, 1487, null, null],
                    [886, 907, 932, 952, 972, 993, 1015, 1030, 1062, 1081, 1104, 1125, 1141, 1162, 1195, 1230, 1263, 1295, 1325, 1355, 1394, 1424, 1456, 1491, 1525, null, null],
                    [901, 925, 946, 966, 990, 1008, 1027, 1046, 1078, 1099, 1121, 1140, 1165, 1184, 1215, 1244, 1278, 1308, 1338, 1370, 1403, 1434, 1461, 1495, 1526, null, null],
                    [918, 943, 962, 981, 1006, 1024, 1044, 1066, 1098, 1120, 1140, 1159, 1184, 1203, 1237, 1269, 1298, 1329, 1358, 1394, 1423, 1454, 1484, 1516, 1546, null, null],
                    [931, 951, 973, 993, 1020, 1039, 1062, 1085, 1118, 1138, 1163, 1180, 1199, 1227, 1256, 1290, 1319, 1350, 1384, 1414, 1445, 1475, 1506, 1537, 1568, null, null],
                    [945, 967, 989, 1010, 1037, 1056, 1083, 1102, 1135, 1158, 1184, 1195, 1220, 1246, 1283, 1311, 1341, 1372, 1404, 1435, 1463, 1498, 1527, 1559, 1588, null, null],
                    [962, 983, 1003, 1023, 1052, 1074, 1100, 1120, 1151, 1182, 1204, 1217, 1239, 1271, 1300, 1330, 1359, 1396, 1427, 1458, 1491, 1521, 1554, 1586, 1616, null, null],
                    [975, 996, 1017, 1038, 1069, 1088, 1118, 1136, 1175, 1203, 1228, 1239, 1256, 1291, 1321, 1352, 1386, 1418, 1449, 1480, 1512, 1545, 1579, 1609, 1639, null, null],
                    [989, 1011, 1033, 1055, 1084, 1107, 1132, 1155, 1193, 1223, 1247, 1276, 1300, 1326, 1351, 1382, 1406, 1438, 1463, 1495, 1522, 1552, 1584, 1611, 1638, null, null],
                    [1010, 1031, 1052, 1075, 1099, 1125, 1149, 1177, 1216, 1242, 1271, 1310, 1344, 1364, 1386, 1405, 1426, 1458, 1482, 1511, 1538, 1566, 1592, 1617, 1643, null, null],
                    [1024, 1047, 1072, 1095, 1116, 1139, 1169, 1192, 1235, 1263, 1292, 1348, 1394, 1402, 1416, 1430, 1449, 1478, 1502, 1525, null, null, null, null, null, null, null]
                ]
            },

            // SUPPLEMENTI TELAIO (EUR/metro lineare)
            // âœ… v7.73: CORRETTI valori telaio 967 forma Z per PVC-Alluminio
            // Riferimento: Listino Finstral EUR 2025/3 pag.17 + configuratore ufficiale
            supplementiTelaio: {
                "961": { pvc: 0, alluminio: 5.20 },
                "962": { pvc: 0, alluminio: 5.61 },
                "963": { pvc: 2.89, alluminio: 9.31 },
                "964": { pvc: 3.53, alluminio: 8.63 },
                "965": { pvc: 7.56, alluminio: 12.90 },
                "966": { pvc: 11.60, alluminio: 17.30 },
                "967": { pvc: 10.90, alluminio: 31.85 },  // âœ… FIX: era 15.30, configuratore calcola 31.85
                "Z62": { pvc: 5.21, alluminio: 10.40 },
                "Z91": { pvc: 16.10, alluminio: 21.70 }
            },

            // âœ… v8.10: RIVESTIMENTO TELAIO ALLUMINIO (â‚¬/ml) - Listino EUR 2025/3 pag.10-11
            // Questo Ã¨ il supplemento per il RIVESTIMENTO esterno in alluminio
            // Si applica INVECE di supplementiTelaio quando finituraEst = alluminio
            rivestimentiTelaiAlluminio: {
                // Codice telaio + tipo rivestimento: { gruppoA (bianco), gruppoB (scuri/legno) }
                "961N":  { gruppoA: 17.2, gruppoB: 20.4 },   // Standard
                "961N5": { gruppoA: 18.0, gruppoB: 19.3 },   // Sottile
                "961X":  { gruppoA: 23.6, gruppoB: 25.4 },   // Speciale (solo laterali/superiore)
                "962N":  { gruppoA: 17.2, gruppoB: 22.4 },
                "962N5": { gruppoA: 18.0, gruppoB: 19.3 },
                "963N":  { gruppoA: 18.0, gruppoB: 24.9 },
                "963N5": { gruppoA: 18.0, gruppoB: 19.3 },
                "967N":  { gruppoA: 20.4, gruppoB: 24.0 },   // Forma Z
                "Z62N":  { gruppoA: 18.0, gruppoB: 22.0 },
                "Z91N":  { gruppoA: 22.0, gruppoB: 26.0 }
            },

            // âœ… v8.10: Colori alluminio gruppo B (scuri/legno verniciato)
            // Iniziano con L (Lxx) o sono colori scuri
            coloriAlluminioGruppoB: [
                "L01", "L02", "L03", "L04", "L05", "L06", "L07", "L08", "L09", "L10",
                "L11", "L12", "L13", "L14", "L15", "L16", "L17", "L18", "L19", "L20",
                "L21", "L22", "L23", "L24", "L25", "L26", "L27", "L28", "L29", "L30"
            ],

            // SUPPLEMENTI VETRO (EUR/mÂ²) - Listino 2025/3
            supplementiVetro: {
                "2F48": 0,           // Doppio base (incluso)
                "2113": 52.20,       // Doppio Plus-Valor 2
                "11414": 118.00,     // Triplo Max-Valor 3
                standard: 0,
                doppio: 0,           // Alias
                triplo: 118.00,      // Alias 11414
                multiprotect2148: 12.70,
                multiprotectP2A: 44.80,
                multiprotectP4A: 67.40,
                multiprotectP5A: 103.00
            },

            // âœ… v7.73: SOGLIA PORTA-FINESTRA (EUR/ml)
            // âœ… v8.10: Corretto prezzo da 53.40 a 54.50 (listino Finstral)
            supplementiSoglia: {
                "codice3": 54.50,         // Soglia ribassata a taglio termico
                "codice3_scorrevole": 54.50,
                allargamento30: 24.10,   // +30mm PVC
                allargamento30K: 25.90   // +30mm alluminio
            },
            
            // âœ… v7.73: SUPPLEMENTO PROFILO ANTA (EUR/ml) - NUOVO!
            // Riferimento: Listino Finstral pag.85 (Classic), pag.92 (Step-line)
            // Questo Ã¨ il supplemento per il TIPO di profilo anta, separato dal colore
            supplementiProfiloAnta: {
                "classic-line": { pvc: 0, alluminio: 10.50 },      // codice973K
                "step-line": { pvc: 0, alluminio: 17.13 },         // codice974N - configuratore calcola 17.13â‚¬/ml
                "slim-line": { pvc: 1.94, alluminio: 12.40 },
                "nova-line": { pvc: 5.51, alluminio: 0 },          // Nova-line ha vetro esterno
                "nova-line-30": { pvc: 5.51, alluminio: 0 },       // Nova-line 30mm
                "nova-line-40": { pvc: 5.51, alluminio: 0 },       // Nova-line 40mm
                "nova-line-plus": { pvc: 23.10, alluminio: 0 }     // codice941 pag.93
            },

            // âœ… v7.79: TABELLE DIMENSIONALI ANTE SPECIALI (â‚¬/pezzo invece di â‚¬/ml)
            // Riferimento: Listino Finstral EUR 2025/3 pag.85-95
            // Queste ante hanno prezzo a tabella dimensionale invece che â‚¬/ml
            tabelleAnteDimensionali: {
                // Slim-line Cristal (codice 954) - pag.85
                // [A mm][L mm] = â‚¬/pezzo supplemento
                "slim-line-cristal": {
                    605: { 615: 232, 740: 247, 865: 264, 990: 285, 1115: 301, 1240: 317, 1365: 333, 1490: 341, 1615: 359, 1740: 374, 1865: 389, 1990: 405, 2115: 420 },
                    730: { 615: 247, 740: 267, 865: 286, 990: 309, 1115: 328, 1240: 347, 1365: 368, 1490: 380, 1615: 398, 1740: 416, 1865: 434, 1990: 453, 2115: 473 },
                    855: { 615: 265, 740: 286, 865: 307, 990: 333, 1115: 356, 1240: 379, 1365: 401, 1490: 416, 1615: 437, 1740: 460, 1865: 481, 1990: 503, 2115: 524 },
                    980: { 615: 285, 740: 310, 865: 334, 990: 365, 1115: 390, 1240: 415, 1365: 440, 1490: 458, 1615: 483, 1740: 508, 1865: 532 },
                    1105: { 615: 302, 740: 329, 865: 358, 990: 390, 1115: 418, 1240: 446, 1365: 476, 1490: 496, 1615: 523, 1740: 550, 1865: 580 },
                    1230: { 615: 318, 740: 348, 865: 380, 990: 415, 1115: 446, 1240: 479, 1365: 510, 1490: 533, 1615: 565 },
                    1355: { 615: 334, 740: 369, 865: 402, 990: 440, 1115: 476, 1240: 510, 1365: 544, 1490: 572, 1615: 605 },
                    1480: { 615: 343, 740: 381, 865: 417, 990: 460, 1115: 497, 1240: 534, 1365: 572, 1490: 602, 1615: 638 },
                    1605: { 615: 361, 740: 400, 865: 438, 990: 485, 1115: 524, 1240: 566, 1365: 606, 1490: 638, 1615: 679 },
                    1730: { 615: 376, 740: 418, 865: 462, 990: 509, 1115: 552, 1240: 596, 1365: 639, 1490: 676, 1615: 718 },
                    1855: { 615: 392, 740: 437, 865: 483, 990: 533, 1115: 581, 1240: 627, 1365: 674, 1490: 712, 1615: 758 },
                    1980: { 615: 399, 740: 446, 865: 495, 990: 548, 1115: 598, 1240: 646, 1365: 696, 1490: 736, 1615: 785 },
                    2105: { 615: 414, 740: 467, 865: 517, 990: 574, 1115: 625, 1240: 678, 1365: 729, 1490: 774 },
                    2230: { 615: 430, 740: 485, 865: 538, 990: 599, 1115: 653, 1240: 708, 1365: 763 },
                    2355: { 615: 446, 740: 504, 865: 562, 990: 623, 1115: 682, 1240: 739 },
                    2480: { 615: 463, 740: 522, 865: 583, 990: 647, 1115: 709, 1240: 771 },
                    2605: { 615: 479, 740: 541, 865: 605, 990: 674, 1115: 737 },
                    2730: { 615: 494, 740: 560, 865: 626, 990: 698, 1115: 766 }
                },
                // Slim-line Twin (codici C788/C988) - pag.87
                "slim-line-twin": {
                    605: { 615: 144, 740: 152, 865: 158, 990: 166, 1115: 171, 1240: 177, 1365: 186, 1490: 193 },
                    730: { 615: 148, 740: 159, 865: 164, 990: 173, 1115: 179, 1240: 186, 1365: 194, 1490: 202 },
                    855: { 615: 158, 740: 167, 865: 173, 990: 181, 1115: 188, 1240: 197, 1365: 205, 1490: 213 },
                    980: { 615: 175, 740: 185, 865: 191, 990: 200, 1115: 207, 1240: 215, 1365: 225, 1490: 234 },
                    1105: { 615: 180, 740: 189, 865: 197, 990: 206, 1115: 214, 1240: 224, 1365: 233, 1490: 244 },
                    1230: { 615: 187, 740: 198, 865: 205, 990: 215, 1115: 224, 1240: 233, 1365: 244, 1490: 256 },
                    1355: { 615: 200, 740: 212, 865: 219, 990: 230, 1115: 239, 1240: 250, 1365: 262, 1490: 273 },
                    1480: { 615: 198, 740: 209, 865: 218, 990: 228, 1115: 239, 1240: 250, 1365: 263, 1490: 274 },
                    1605: { 615: 212, 740: 225, 865: 233, 990: 239, 1115: 258, 1240: 269, 1365: 281, 1490: 293 },
                    1730: { 615: 218, 740: 230, 865: 239, 990: 245, 1115: 264, 1240: 276, 1365: 289, 1490: 302 },
                    1855: { 615: 225, 740: 238, 865: 248, 990: 256, 1115: 275, 1240: 287, 1365: 300, 1490: 314 },
                    1980: { 615: 227, 740: 241, 865: 251, 990: 260, 1115: 277, 1240: 290, 1365: 303, 1490: 316 },
                    2105: { 615: 232, 740: 246, 865: 259, 990: 273, 1115: 285, 1240: 298, 1365: 312, 1490: 325 },
                    2230: { 615: 245, 740: 261, 865: 273, 990: 287, 1115: 299, 1240: 313, 1365: 327, 1490: 341 },
                    2355: { 615: 256, 740: 271, 865: 282, 990: 298, 1115: 311, 1240: 325, 1365: 340, 1490: 355 },
                    2480: { 615: 258, 740: 274, 865: 286, 990: 301, 1115: 314, 1240: 329, 1365: 345, 1490: 363 },
                    2605: { 615: 266, 740: 281, 865: 294, 990: 311, 1115: 325, 1240: 340, 1365: 356, 1490: 374 },
                    2730: { 615: 273, 740: 289, 865: 303, 990: 320, 1115: 335, 1240: 350, 1365: 368, 1490: 384 }
                },
                // Nova-line Twin (codice N989) - pag.94
                "nova-line-twin": {
                    605: { 615: 231, 740: 244, 865: 254, 990: 267, 1115: 277, 1240: 289, 1365: 302, 1490: 303 },
                    730: { 615: 241, 740: 257, 865: 268, 990: 282, 1115: 293, 1240: 306, 1365: 320, 1490: 324 },
                    855: { 615: 254, 740: 271, 865: 283, 990: 298, 1115: 311, 1240: 326, 1365: 341, 1490: 346 },
                    980: { 615: 278, 740: 295, 865: 308, 990: 325, 1115: 339, 1240: 358, 1365: 375, 1490: 381 },
                    1105: { 615: 287, 740: 306, 865: 321, 990: 339, 1115: 355, 1240: 374, 1365: 393, 1490: 401 },
                    1230: { 615: 300, 740: 320, 865: 336, 990: 358, 1115: 375, 1240: 394, 1365: 414, 1490: 423 },
                    1355: { 615: 318, 740: 340, 865: 360, 990: 381, 1115: 399, 1240: 420, 1365: 442, 1490: 452 },
                    1480: { 615: 320, 740: 343, 865: 365, 990: 387, 1115: 407, 1240: 429, 1365: 452, 1490: 466 },
                    1605: { 615: 340, 740: 366, 865: 387, 990: 404, 1115: 432, 1240: 457, 1365: 483, 1490: 496 },
                    1730: { 615: 350, 740: 378, 865: 400, 990: 419, 1115: 448, 1240: 476, 1365: 501, 1490: 517 },
                    1855: { 615: 364, 740: 391, 865: 415, 990: 435, 1115: 468, 1240: 495, 1365: 523, 1490: 539 },
                    1980: { 615: 371, 740: 399, 865: 424, 990: 445, 1115: 479, 1240: 507, 1365: 535, 1490: 552 },
                    2105: { 615: 381, 740: 411, 865: 437, 990: 468, 1115: 494, 1240: 524, 1365: 553, 1490: 574 },
                    2230: { 615: 399, 740: 430, 865: 458, 990: 490, 1115: 518, 1240: 549, 1365: 582, 1490: 602 },
                    2355: { 615: 413, 740: 446, 865: 477, 990: 509, 1115: 539, 1240: 573, 1365: 605, 1490: 627 },
                    2480: { 615: 420, 740: 455, 865: 487, 990: 520, 1115: 551, 1240: 587, 1365: 621, 1490: 644 },
                    2605: { 615: 433, 740: 470, 865: 502, 990: 537, 1115: 572, 1240: 607, 1365: 642, 1490: 669 },
                    2730: { 615: 445, 740: 484, 865: 518, 990: 554, 1115: 590, 1240: 627, 1365: 666, 1490: 692 }
                }
            },

            // âœ… v7.79: MONTANTE CENTRALE / NODO (EUR/pezzo) - Aggiornato con nodi specifici
            // Riferimento: Listino Finstral EUR 2025/3 pag.83-95
            supplementiMontante: {
                // Nodi standard (Classic, Step, Slim)
                "codice28": { pvcA: 0, pvcB: 2.35, aluA: 26.70, aluB: 29.10, aluC: 30.70, aluD: 33.00 },      // Standard
                "codice25": { pvcA: 8.38, pvcB: 12.70, aluA: 35.10, aluB: 39.40, aluC: 39.00, aluD: 43.30 },  // Sottile
                "codiceS28": { pvcA: 11.00, pvcB: 14.90, aluA: 37.70, aluB: 41.60, aluC: 41.70, aluD: 45.50 }, // Slanciato
                "codiceH25": { pvcA: 11.60, pvcB: 15.90, aluA: 38.40, aluB: 42.60, aluC: 42.20, aluD: 46.50 }, // History
                // âœ… v7.79: Nodi specifici Nova-line
                "NL45": { pvcA: 0, pvcB: 2.35, aluA: 27.80, aluB: 30.10, aluC: 31.70, aluD: 34.00 },   // Nova-line sottile
                "C45": { pvcA: 0, pvcB: 3.06, aluA: 27.80, aluB: 30.10, aluC: 31.70, aluD: 34.00 },    // Twin
                "N45": { pvcA: 0, pvcB: 2.35, aluA: 27.80, aluB: 30.10, aluC: 31.70, aluD: 34.00 },    // Nova Twin sottile
                "56": { pvcA: 46.10, aluA: 46.10 },    // Nova-line Plus nodo vetro
                "N56": { pvcA: 46.10, aluA: 46.10 }    // Nova Twin vetro
            },

            // âœ… v7.79: Mappa tipo anta â†’ codice nodo
            nodiPerTipoAnta: {
                "classic-line": "codice28",
                "step-line": "codice28",
                "slim-line": "codice28",
                "slim-line-cristal": "codice28",
                "slim-line-twin": "C45",
                "nova-line": "NL45",
                "nova-line-30": "NL45",
                "nova-line-40": "NL45",
                "nova-line-plus": "56",
                "nova-line-twin": "N45"
            },

            // âœ… v7.75: TAGLI SUI TELAI (EUR/ml) - Listino pag.22-28
            // I codici arrivano dal JSON (campo pos.infisso.taglio o tagli[])
            supplementiTagli: {
                // Tagli standard â‚¬2.19/ml
                "127": 2.19, "107": 2.19, "163": 2.19, "162": 2.19, 
                "5N": 2.19, "179N": 2.19, "5X": 2.19, "179X": 2.19,
                "128": 2.19, "110": 2.19, "136": 2.19, "115": 2.19,
                "100": 2.19, "120": 2.19, "125": 2.19, "130": 2.19,
                "140": 2.19, "178": 2.19, "135": 2.19, "145": 2.19,
                "150": 2.19, "160": 2.19, "131": 2.19,
                "151": 2.19, "156": 2.19, "157": 2.19, "119": 2.19,
                "124": 2.19, "152": 2.19, "121": 2.19,
                // Tagli â‚¬2.75/ml
                "164": 2.75, "165": 2.75, "116": 2.75, "167": 2.75,
                "129": 2.75, "132": 2.75, "153": 2.75, "133": 2.75,
                "166": 2.75, "169": 2.75,
                // Tagli speciali â‚¬5.22/ml
                "118": 5.22, "172": 5.22, "149": 5.22, "147": 5.22,
                "148": 5.22, "134": 5.22, "176": 5.22, "191": 5.22,
                "192": 5.22
            },

            // âœ… v7.64: SUPPLEMENTI COLORE PVC (EUR/ml per perimetro anta)
            // Gruppo A = tonalitÃ  bianco, Gruppo B = colori scuri
            supplementiColorePVC: {
                gruppoA: ["01", "45", "27", "42", "07"],  // bianco, bianco satinato, bianco perla, bianco goffrato, bianco perla goffrato
                gruppoB: ["46", "06", "13", "19", "55"],  // grigio seta, grigio, castagno, rovere, noce chiaro
                // âœ… v7.79 FIX: Supplementi COLORE anta â‚¬/ml [gruppoA, gruppoB]
                // NOTA: Gruppo A (bianco) = â‚¬0 (incluso nel prezzo base)
                // Gruppo B (colori) = supplemento aggiuntivo
                anta: {
                    "classic-line": [0, 6.22],      // Bianco=base, colori=+6.22
                    "step-line": [0, 6.12],         // Bianco=base, colori=+6.12
                    "slim-line": [0, 6.93],         // Bianco=base, colori=+6.93
                    "nova-line": [0, 6.09],         // âœ… FIX: Bianco=â‚¬0 (era 6.01 SBAGLIATO!), colori=+6.09
                    "nova-line-30": [0, 6.09],      // Come nova-line standard
                    "nova-line-40": [0, 6.09],      // Come nova-line standard
                    "nova-line-plus": [0, 6.20]     // Bianco=base, colori=+6.20
                }
            },

            // âœ… v7.64: SUPPLEMENTI COLORE ALLUMINIO (per rivestimento esterno)
            // Gruppo 1 = standard, 1H = decori legno, 2 = RAL (+284â‚¬/ordine), 3 = NCS/speciali (+1410â‚¬/ordine)
            supplementiColoreAlluminio: {
                gruppo1: {
                    codici: ["F05", "F45", "F90", "F91", "F113", "F609", "F703", "F716", "F739", "F742", "F744", "F819", "F901", "F905",
                             "M01", "M605", "M716", "M722", "M817", "M906", "M907", "M905", "M910", "M916", "9017",
                             "303", "583", "893", "894", "2525", "DB703"],
                    costoPreparazione: 0
                },
                gruppo1H: {
                    codici: ["L13", "L14", "L16", "L18", "L19", "L55", "LX01", "LX02", "LX03", "LX04"],
                    costoPreparazione: 0
                },
                gruppo2: {
                    codici: ["F09", "F92", "F93", "F94", "F95", "F119", "F305", "F511", "F612", "F702", "F721", "F722", "F723", "F822", "F918", "F958",
                             "M822", "L05", "L56", "LC31", "LC32", "LC33", "LC34", "203", "304", "805", "358", "658", "691", "897", "FB73", "RAL"],
                    costoPreparazione: 284  // â‚¬/ordine
                },
                gruppo3: {
                    codici: ["NCS", "DB"],  // colori speciali
                    costoPreparazione: 1410  // â‚¬/ordine
                },
                // Supplementi â‚¬/ml per anta alluminio [gruppo1, gruppo2-3]
                anta: {
                    "classic-line": [10.50, 11.40],
                    "step-line": [10.50, 10.90],
                    "slim-line": [12.40, 12.90],
                    "nova-line": [0, 0]  // Nova-line ha vetro esterno, no rivestimento
                }
            },

            // âœ… v7.64: DATABASE COLORI COMUNI (per lookup rapido)
            coloriComuni: {
                "bianco": { pvc: "01", alluminio: "M01", gruppo: "A/1" },
                "bianco satinato": { pvc: "45", alluminio: "F45", gruppo: "A/1" },
                "bianco perla": { pvc: "27", alluminio: "F113", gruppo: "A/1" },
                "grigio seta": { pvc: "46", alluminio: "F744", gruppo: "B/1" },
                "grigio traffico": { pvc: null, alluminio: "F742", gruppo: "1" },
                "grigio antracite": { pvc: null, alluminio: "F716", gruppo: "1" },
                "castagno": { pvc: "13", alluminio: "L13", gruppo: "B/1H" },
                "rovere": { pvc: "19", alluminio: "L19", gruppo: "B/1H" },
                "noce chiaro": { pvc: "55", alluminio: "L55", gruppo: "B/1H" },
                "nero intenso": { pvc: null, alluminio: "F905", gruppo: "1" },
                "RAL 7016": { pvc: null, alluminio: "RAL", gruppo: "2" },
                "RAL 9005": { pvc: null, alluminio: "RAL", gruppo: "2" }
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // âœ… v7.77: FERRAMENTA / APERTURE / CERNIERE
            // Riferimento: Listino Finstral EUR 2025/3 pag.116-157
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            // TIPI APERTURA con codici ferramenta
            tipiApertura: {
                "AR": { 
                    nome: "Anta/Ribalta", 
                    codiceVista: "411.0", 
                    codiceScomparsa: "211.0",
                    minL: 350, minH: 325
                },
                "A": { 
                    nome: "Solo Anta", 
                    codiceVista: "430.0", 
                    codiceScomparsa: "230.0",
                    minL: 350, minH: 325
                },
                "R": { 
                    nome: "Solo Ribalta", 
                    codiceVista: "432.0", 
                    codiceScomparsa: "232.0",
                    minL: 350, minH: 325
                },
                "FX": { 
                    nome: "Fisso", 
                    codiceVista: "99.0", 
                    codiceScomparsa: null,
                    minL: 300, minH: 250
                },
                "VA": { 
                    nome: "Vasistas", 
                    codiceVista: "433.0", 
                    codiceScomparsa: "233.0",
                    minL: 564, minH: 306
                },
                "SP": { 
                    nome: "Scorrevole Parallela", 
                    codiceVista: "720.0", 
                    codiceScomparsa: null,  // Scorrevole usa carrelli, no cerniere
                    minL: 710, minH: 841
                },
                "SPR": { 
                    nome: "Scorrevole Parallela Ribalta", 
                    codiceVista: "710.0", 
                    codiceScomparsa: null,
                    minL: 710, minH: 841
                },
                "PFS": { 
                    nome: "Porta-Finestra Serratura", 
                    codiceVista: "475.0", 
                    codiceScomparsa: "275.0",
                    minL: 441, minH: 1626
                }
            },

            // CERNIERE: supplemento per cerniere a scomparsa (â‚¬ per unitÃ )
            // Vista (4xx.0) = â‚¬0 incluse, Scomparsa (2xx.0) = supplemento
            supplementiCerniere: {
                "AR": 47.0,      // Anta/Ribalta scomparsa 211.0
                "AR_primaria": 76.0,  // Ribalta primaria 209.0
                "A": 61.5,       // Solo anta 230.0
                "R": 67.1,       // Solo ribalta 232.0
                "VA": 63.2,      // Vasistas 231.0/233.0
                "PFS": 189.0,    // Porta-finestra serratura 275.0
                "AR_montante": 72.4   // Montante alto B211.0
            },

            // SICUREZZA: allestimenti antieffrazione
            supplementiSicurezza: {
                "perimetrali": 18.8,           // .411.4 scontri perimetrali
                "perimetrali_angolare": 27.4,  // .3 + cerniera angolare
                "antiSgancio": 40.4,           // ...2 dispositivo
                "contattoZ9": 57.8,            // Z9 magnetico 10m
                "contattoZ9_VdS": 70.3,        // Z9V certificato VdS
                "contattoZ92": 115.0,          // Z92 magnetico 20m
                "bloccoChiave": 34.2           // D0010 blocco anta
            },

            // ACCESSORI AERAZIONE
            supplementiAerazione: {
                "estateInverno1": 14.5,    // 20-1 una anta (170â†’40mm)
                "estateInverno2": 14.5,    // 20-2 due ante
                "aerazioneLimitata1": 7.28, // 14-1 apertura ~5mm
                "aerazioneLimitata2": 7.28  // 14-2 due ante
            },

            // COMFORT: dispositivi facilitazione
            supplementiComfort: {
                "facilitaChiusura": 37.6,  // 4111/2111 ante pesanti
                "fermoAntaFB200": 11.6     // min L 450mm
            },

            // SCORREVOLI: supplementi specifici
            supplementiScorrevoli: {
                "parallelaRibalta": 745.0,      // 710.0
                "parallelaRibaltaSer": 842.0,   // 711.0 con serratura
                "parallela": 745.0,             // 720.0
                "parallelaSer": 842.0,          // 721.0 con serratura
                "montanteMobile": 745.0         // 722.0
            },

            // VASISTAS CON COMANDI: supplementi per altezza
            supplementiVasistasComando: {
                "manigliaSuperiore": { base: 24.5, scomparsa: 63.2 },  // 10cm apertura
                "astaLeva": { base: 213, scomparsa: 252 },            // 19cm apertura
                "astaArganello": { base: 257, scomparsa: 296 },       // 19cm apertura
                "motore230V": { base: 669, scomparsa: 707 },          // 19cm apertura
                "motore24V": { base: 825, scomparsa: 863 }            // 30cm apertura
            },

            // RC2 ANTIEFFRAZIONE: requisiti e supplementi
            rc2: {
                requisiti: {
                    ferramenta: ".3",           // Obbligatorio
                    maniglia: ["6030", "7130"], // Con chiave
                    vetro: "P4A",               // Antisfondamento
                    minL: 540, minH: 700
                },
                supplemento: {
                    "nova-line": 29.8,   // RC2NL
                    "altri": 67.9        // RC2 standard
                },
                telaiCompatibili: ["924", "991", "923", "129", "961", "962", "963", "964", "965", "966", "967"]
            }
        };

        // FUNZIONI CALCOLO FINSTRAL
        function trovaPrezzoBaseFinstral(tipo, larghezza, altezza) {
            const tabella = FINSTRAL_PREZZI["tipo" + tipo];
            if (!tabella) return null;
            
            // Trova colonna: prima colonna dove larghezza <= limite
            let colIdx = tabella.colonneL.length - 1;
            for (let i = 0; i < tabella.colonneL.length; i++) {
                if (larghezza <= tabella.colonneL[i]) { 
                    colIdx = i; 
                    break; 
                }
            }
            
            // âœ… v7.79 FIX: Per altezza, trova riga usando logica Finstral
            // Le righe indicano il limite SUPERIORE della fascia
            // Es: riga 1480 = altezze da 1416 a 1480
            // Se altezza Ã¨ ESATTAMENTE il valore della riga, usa quella riga
            let rowIdx = 0;
            for (let i = 0; i < tabella.righeA.length; i++) {
                if (altezza <= tabella.righeA[i]) { 
                    rowIdx = i; 
                    break; 
                }
                rowIdx = i;  // Se sfora l'ultima, usa l'ultima
            }
            
            // Debug
            console.log(`ğŸ“Š trovaPrezzoBase: L=${larghezza}â†’col[${colIdx}]=${tabella.colonneL[colIdx]}, H=${altezza}â†’riga[${rowIdx}]=${tabella.righeA[rowIdx]}`);
            
            if (tabella.prezzi[rowIdx] && tabella.prezzi[rowIdx][colIdx] !== null) {
                return tabella.prezzi[rowIdx][colIdx];
            }
            return null;
        }

        function calcolaPrezzoFinstral(config) {
            const { tipo = "101", larghezza, altezza, telaio = "961", materiale = "pvc", vetro = "standard",
                    tipoAnta = "step-line", colorePVC = "01", coloreAlluminio = null } = config;
            
            // âœ… v7.73: DEBUG - Mostra parametri ricevuti
            console.log(`ğŸ”¬ calcolaPrezzoFinstral() riceve: telaio=${telaio}, materiale=${materiale}, tipoAnta=${tipoAnta}`);
            
            const risultato = { config, dettaglio: {}, totale: 0, errore: null };
            
            const prezzoBase = trovaPrezzoBaseFinstral(tipo, larghezza, altezza);
            console.log(`ğŸ”¬ trovaPrezzoBaseFinstral(tipo=${tipo}, L=${larghezza}, H=${altezza}) = ${prezzoBase}`);
            if (prezzoBase === null) {
                risultato.errore = "Dimensioni fuori range per tipo " + tipo;
                console.warn(`âš ï¸ ERRORE: ${risultato.errore}`);
                return risultato;
            }
            risultato.dettaglio.prezzoBase = prezzoBase;
            
            const perimetro = ((larghezza * 2) + (altezza * 2)) / 1000;
            risultato.dettaglio.perimetroM = perimetro;
            
            // âœ… v7.79 FIX CRITICO: Calcolo PERIMETRO BATTENTI per supplemento profilo anta
            // Il supplemento profilo anta va calcolato sul perimetro delle ANTE, non della finestra!
            // tipo 101/102 = 1 anta, tipo 401 = 2 ante
            const numAnteDaTipo = (tipo === "401" || tipo === "301") ? 2 : 1;
            const larghezzaAnta_m = (larghezza / numAnteDaTipo) / 1000;  // in metri
            const altezzaAnta_m = altezza / 1000;  // in metri
            const perimetroSingolaAnta = 2 * (larghezzaAnta_m + altezzaAnta_m);
            const perimetroBattenti = perimetroSingolaAnta * numAnteDaTipo;
            risultato.dettaglio.perimetroBattentiM = perimetroBattenti;
            risultato.dettaglio.numAnte = numAnteDaTipo;
            
            // âœ… v7.73: Normalizza tipo anta PRIMA di usarlo
            const antaNorm = tipoAnta.toLowerCase().replace(/\s+/g, '-');
            
            // âœ… v8.10: Supplemento telaio CON RIVESTIMENTO ALLUMINIO
            // Se finitura esterna = alluminio, usa tabella rivestimenti (961N, etc.)
            // altrimenti usa supplemento base telaio
            if (materiale === 'alluminio' && coloreAlluminio) {
                // Determina codice rivestimento (es. 961 â†’ 961N)
                const codiceRiv = telaio + "N";
                const rivData = FINSTRAL_PREZZI.rivestimentiTelaiAlluminio?.[codiceRiv];
                
                if (rivData) {
                    // Determina gruppo colore: A (chiari) o B (scuri/legno)
                    const colUpper = String(coloreAlluminio).toUpperCase();
                    const isGruppoB = colUpper.startsWith('L') || 
                                      FINSTRAL_PREZZI.coloriAlluminioGruppoB?.some(c => colUpper.includes(c));
                    const valoreRiv = isGruppoB ? rivData.gruppoB : rivData.gruppoA;
                    
                    console.log(`ğŸ”¬ Rivestimento ${codiceRiv}: colore ${coloreAlluminio} â†’ gruppo ${isGruppoB ? 'B' : 'A'} = â‚¬${valoreRiv}/ml Ã— ${perimetro.toFixed(2)}ml`);
                    risultato.dettaglio.supplementoTelaio = Math.round(valoreRiv * perimetro * 100) / 100;
                    risultato.dettaglio.codiceRivestimento = codiceRiv;
                    risultato.dettaglio.gruppoColoreTelaio = isGruppoB ? 'B' : 'A';
                    console.log(`ğŸ”¬ â†’ supplementoTelaio (rivestimento) = â‚¬${risultato.dettaglio.supplementoTelaio}`);
                } else {
                    // Fallback a supplemento base se rivestimento non trovato
                    const supplTelaio = FINSTRAL_PREZZI.supplementiTelaio[telaio];
                    if (supplTelaio) {
                        const valoreSuppl = supplTelaio[materiale];
                        console.log(`ğŸ”¬ Telaio ${telaio}: supplTelaio[${materiale}] = â‚¬${valoreSuppl}/ml Ã— ${perimetro.toFixed(2)}ml (rivestimento ${telaio}N non trovato)`);
                        risultato.dettaglio.supplementoTelaio = Math.round(valoreSuppl * perimetro * 100) / 100;
                    } else {
                        risultato.dettaglio.supplementoTelaio = 0;
                    }
                }
            } else {
                // PVC-PVC: usa supplemento base telaio
                const supplTelaio = FINSTRAL_PREZZI.supplementiTelaio[telaio];
                if (supplTelaio) {
                    const valoreSuppl = supplTelaio[materiale] || supplTelaio['pvc'] || 0;
                    console.log(`ğŸ”¬ Telaio ${telaio}: supplTelaio[${materiale}] = â‚¬${valoreSuppl}/ml Ã— ${perimetro.toFixed(2)}ml`);
                    risultato.dettaglio.supplementoTelaio = Math.round(valoreSuppl * perimetro * 100) / 100;
                    console.log(`ğŸ”¬ â†’ supplementoTelaio = â‚¬${risultato.dettaglio.supplementoTelaio}`);
                } else {
                    risultato.dettaglio.supplementoTelaio = 0;
                }
            }
            
            // âœ… v7.79 FIX: Supplemento PROFILO ANTA su PERIMETRO BATTENTI (non finestra!)
            // Prima controlla se esiste tabella dimensionale per questo tipo anta
            const suppTabellaAnta = getSupplementoAntaDimensionale(antaNorm, altezza, larghezza / numAnteDaTipo);
            if (suppTabellaAnta !== null && suppTabellaAnta > 0) {
                // Ante speciali (Cristal, Twin): prezzo â‚¬/pezzo Ã— numAnte
                risultato.dettaglio.supplementoProfiloAnta = Math.round(suppTabellaAnta * numAnteDaTipo * 100) / 100;
                risultato.dettaglio.tipoCalcoloAnta = "tabella";
                console.log(`ğŸ”¬ Profilo ${antaNorm}: TABELLA â‚¬${suppTabellaAnta}/pezzo Ã— ${numAnteDaTipo} ante = â‚¬${risultato.dettaglio.supplementoProfiloAnta}`);
            } else {
                // Ante normali: prezzo â‚¬/ml Ã— perimetro battenti
                const supplProfilo = FINSTRAL_PREZZI.supplementiProfiloAnta?.[antaNorm];
                if (supplProfilo) {
                    // âœ… v7.79 FIX: Nova-line Ã¨ SOLO PVC (ha vetro esterno, non alluminio)
                    // Quindi il supplemento profilo va sempre calcolato come PVC
                    const isNovaLine = antaNorm.includes('nova');
                    const materialeProfilo = isNovaLine ? 'pvc' : materiale;
                    const valoreProf = supplProfilo[materialeProfilo] || supplProfilo['pvc'] || 0;
                    console.log(`ğŸ”¬ Profilo ${antaNorm}: supplProfilo[${materialeProfilo}] = â‚¬${valoreProf}/ml Ã— ${perimetroBattenti.toFixed(2)}ml (${numAnteDaTipo} ante)`);
                    risultato.dettaglio.supplementoProfiloAnta = Math.round(valoreProf * perimetroBattenti * 100) / 100;
                    risultato.dettaglio.tipoCalcoloAnta = "perimetro";
                    risultato.dettaglio.materialeProfilo = materialeProfilo;
                    console.log(`ğŸ”¬ â†’ supplementoProfiloAnta = â‚¬${risultato.dettaglio.supplementoProfiloAnta}`);
                } else {
                    console.log(`ğŸ”¬ Profilo ${antaNorm}: NON TROVATO in supplementiProfiloAnta`);
                    risultato.dettaglio.supplementoProfiloAnta = 0;
                }
            }
            
            // âœ… v7.79 FIX: Supplemento MONTANTE MOBILE per tipo 401 (2 ante)
            // Usa nodo specifico per tipo anta (Nova-line usa NL45, Twin usa C45, ecc.)
            if (tipo === "401") {
                const codiceNodo = FINSTRAL_PREZZI.nodiPerTipoAnta?.[antaNorm] || "codice28";
                const montanteData = FINSTRAL_PREZZI.supplementiMontante?.[codiceNodo];
                console.log(`ğŸ”¬ Montante: tipo anta ${antaNorm} â†’ nodo ${codiceNodo}`);
                if (montanteData) {
                    // Determina gruppo colore per prezzo montante
                    const isGruppoB = FINSTRAL_PREZZI.supplementiColorePVC?.gruppoB?.includes(colorePVC);
                    if (materiale === 'alluminio' && coloreAlluminio) {
                        // âœ… v7.79: Determina gruppo alluminio (A, B, C, D)
                        // C = decorativi legno (Lxx), D = RAL/NCS speciali
                        let gruppoAlu = 'aluA';
                        const colUpper = coloreAlluminio.toUpperCase();
                        if (colUpper.startsWith('L') || colUpper.includes('LEGNO') || colUpper.includes('CASTAGNO') || 
                            colUpper.includes('ROVERE') || colUpper.includes('NOCE') || colUpper.includes('DECOR')) {
                            gruppoAlu = isGruppoB ? 'aluD' : 'aluC';  // Decorativi legno
                        } else if (colUpper.startsWith('RAL') || colUpper.startsWith('NCS') || colUpper.startsWith('DB')) {
                            gruppoAlu = 'aluD';  // RAL/NCS speciali
                        } else {
                            gruppoAlu = isGruppoB ? 'aluB' : 'aluA';  // Standard
                        }
                        risultato.dettaglio.supplementoMontante = montanteData[gruppoAlu] || montanteData.aluA || 0;
                        risultato.dettaglio.gruppoMontante = gruppoAlu;
                        console.log(`ğŸ”¬ Montante ${codiceNodo}[${gruppoAlu}] = â‚¬${risultato.dettaglio.supplementoMontante}`);
                    } else {
                        risultato.dettaglio.supplementoMontante = isGruppoB ? (montanteData.pvcB || 0) : (montanteData.pvcA || 0);
                        risultato.dettaglio.gruppoMontante = isGruppoB ? 'pvcB' : 'pvcA';
                    }
                } else {
                    console.warn(`âš ï¸ Nodo ${codiceNodo} non trovato in supplementiMontante`);
                    risultato.dettaglio.supplementoMontante = 0;
                }
            } else {
                risultato.dettaglio.supplementoMontante = 0;
            }
            
            // âœ… v7.79 FIX: Supplemento colore PVC su PERIMETRO BATTENTI
            const supplAntaPVC = FINSTRAL_PREZZI.supplementiColorePVC?.anta?.[antaNorm];
            if (supplAntaPVC && colorePVC) {
                const isGruppoB = FINSTRAL_PREZZI.supplementiColorePVC.gruppoB.includes(colorePVC);
                const supplColore = isGruppoB ? supplAntaPVC[1] : supplAntaPVC[0];
                risultato.dettaglio.supplementoColorePVC = Math.round(supplColore * perimetroBattenti * 100) / 100;
                risultato.dettaglio.gruppoColorePVC = isGruppoB ? "B" : "A";
            } else {
                risultato.dettaglio.supplementoColorePVC = 0;
            }
            
            // âœ… v7.79 FIX: Supplemento colore alluminio su PERIMETRO BATTENTI
            if (materiale === "alluminio" && coloreAlluminio) {
                const supplAntaAlu = FINSTRAL_PREZZI.supplementiColoreAlluminio?.anta?.[antaNorm];
                if (supplAntaAlu) {
                    // Determina gruppo alluminio
                    let gruppoAlu = "1";
                    let costoPrep = 0;
                    const alluminio = FINSTRAL_PREZZI.supplementiColoreAlluminio;
                    if (alluminio.gruppo1.codici.some(c => coloreAlluminio.toUpperCase().includes(c))) {
                        gruppoAlu = "1";
                    } else if (alluminio.gruppo1H.codici.some(c => coloreAlluminio.toUpperCase().includes(c))) {
                        gruppoAlu = "1H";
                    } else if (alluminio.gruppo2.codici.some(c => coloreAlluminio.toUpperCase().includes(c)) || 
                               coloreAlluminio.toUpperCase().startsWith("RAL")) {
                        gruppoAlu = "2";
                        costoPrep = alluminio.gruppo2.costoPreparazione;
                    } else if (coloreAlluminio.toUpperCase().startsWith("NCS") || coloreAlluminio.toUpperCase().startsWith("DB")) {
                        gruppoAlu = "3";
                        costoPrep = alluminio.gruppo3.costoPreparazione;
                    }
                    
                    const idxSuppl = (gruppoAlu === "1" || gruppoAlu === "1H") ? 0 : 1;
                    risultato.dettaglio.supplementoColoreAlluminio = Math.round(supplAntaAlu[idxSuppl] * perimetroBattenti * 100) / 100;
                    risultato.dettaglio.gruppoColoreAlluminio = gruppoAlu;
                    risultato.dettaglio.costoPreparazioneColore = costoPrep;  // Una tantum per ordine
                }
            } else {
                risultato.dettaglio.supplementoColoreAlluminio = 0;
                risultato.dettaglio.costoPreparazioneColore = 0;
            }
            
            // Supplemento vetro
            const superficieVetro = Math.max(0.4, ((larghezza - 100) / 1000) * ((altezza - 100) / 1000));
            risultato.dettaglio.superficieVetroM2 = Math.round(superficieVetro * 100) / 100;
            
            const supplVetro = FINSTRAL_PREZZI.supplementiVetro[vetro] || 0;
            risultato.dettaglio.supplementoVetro = Math.round(supplVetro * superficieVetro * 100) / 100;
            
            // TOTALE (escluso costo preparazione colore che Ã¨ una tantum)
            // âœ… v7.73: Aggiunto supplementoProfiloAnta e supplementoMontante
            risultato.totale = Math.round((
                risultato.dettaglio.prezzoBase +
                risultato.dettaglio.supplementoTelaio +
                (risultato.dettaglio.supplementoProfiloAnta || 0) +
                (risultato.dettaglio.supplementoMontante || 0) +
                (risultato.dettaglio.supplementoColorePVC || 0) +
                (risultato.dettaglio.supplementoColoreAlluminio || 0) +
                risultato.dettaglio.supplementoVetro
            ) * 100) / 100;
            
            return risultato;
        }

        console.log('âœ… FINSTRAL_PREZZI caricato - Listino EUR 2025/3 + Colori + Ferramenta/Cerniere');

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ“¦ FINSTRAL CASSONETTI PREZZI - Listino EUR 2025/3 (pag. 141-146)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const FINSTRAL_CASSONETTI_PREZZI = {
            versione: "EUR 2025/3",
            dataAggiornamento: "2025-12-04",
            note: "Per misure intermedie vale la casella piÃ¹ alta. Usb = 1,3 W/mÂ²K",
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PVC CODICE 148 - B fino a 148mm (pag. 141)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            pvc_148: {
                codice: "148",
                descrizione: "Corpo cassonetto PVC - B fino a 148mm",
                maxL: 3860,
                colonneL: [615, 740, 865, 990, 1115, 1240, 1365, 1490, 1615, 1740, 1865, 1990, 2115, 2240, 2365, 2490, 2615, 2740, 2865, 2990, 3115, 3240, 3365, 3490, 3615, 3740, 3860],
                righeA: [250, 350, 450, 550, 650],
                bianco: [
                    [172, 177, 186, 192, 202, 209, 217, 224, 231, 238, 247, 256, 262, 269, 277, 363, 369, 376, 383, 390, 396, 403, 408, 416, 421, 430, 435],
                    [179, 187, 197, 207, 214, 221, 231, 240, 248, 258, 266, 275, 282, 292, 300, 385, 395, 403, 409, 418, 428, 434, 442, 450, 462, 470, 477],
                    [186, 198, 208, 217, 225, 235, 245, 256, 264, 276, 284, 294, 303, 313, 324, 408, 419, 429, 436, 446, 460, 469, 477, 488, 497, 504, 515],
                    [192, 207, 217, 228, 238, 248, 261, 271, 281, 293, 303, 313, 326, 338, 348, 433, 444, 458, 470, 483, 495, 504, 519, 529, 540, 553, 567],
                    [202, 215, 225, 237, 250, 263, 275, 285, 297, 311, 324, 335, 348, 359, 372, 461, 473, 485, 497, 507, 522, 532, 543, 556, 569, 583, 595]
                ],
                scuri: [
                    [176, 186, 192, 202, 211, 219, 228, 235, 245, 254, 262, 269, 279, 285, 294, 380, 389, 396, 405, 412, 423, 433, 442, 452, 464, 474, 484],
                    [186, 197, 207, 215, 224, 233, 244, 254, 262, 271, 280, 289, 300, 310, 316, 405, 412, 423, 432, 440, 447, 460, 467, 475, 484, 491, 499],
                    [192, 207, 215, 225, 237, 247, 260, 269, 279, 289, 301, 311, 323, 333, 342, 429, 437, 450, 463, 473, 483, 491, 500, 509, 520, 528, 537],
                    [202, 215, 225, 238, 250, 262, 275, 284, 295, 310, 319, 332, 343, 356, 369, 456, 470, 482, 491, 501, 511, 524, 533, 543, 554, 567, 577],
                    [213, 224, 237, 250, 263, 276, 286, 301, 313, 327, 340, 355, 367, 380, 393, 483, 496, 504, 520, 532, 545, 560, 573, 590, 601, 617, 628]
                ]
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PVC CODICE 148B - B da 335 a 600mm (pag. 142)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            pvc_148B: {
                codice: "148B",
                descrizione: "Corpo cassonetto PVC - B 335-600mm (due profili accoppiati)",
                maxL: 3860,
                colonneL: [615, 740, 865, 990, 1115, 1240, 1365, 1490, 1615, 1740, 1865, 1990, 2115, 2240, 2365, 2490, 2615, 2740, 2865, 2990, 3115, 3240, 3365, 3490, 3615, 3740, 3860],
                righeA: [250, 350, 450, 550, 650],
                bianco: [
                    [179, 186, 197, 205, 214, 224, 231, 240, 248, 259, 266, 276, 284, 293, 301, 389, 395, 405, 411, 420, 430, 436, 445, 456, 464, 473, 482],
                    [186, 197, 206, 215, 226, 235, 245, 256, 266, 276, 284, 295, 306, 316, 326, 409, 420, 432, 440, 447, 460, 467, 475, 484, 491, 499, 506],
                    [192, 206, 217, 226, 237, 248, 261, 272, 281, 293, 302, 315, 327, 340, 354, 434, 446, 460, 472, 484, 496, 506, 520, 530, 542, 554, 568],
                    [200, 214, 226, 237, 250, 263, 275, 285, 299, 312, 324, 338, 350, 363, 376, 458, 469, 487, 499, 511, 526, 538, 552, 567, 579, 595, 609],
                    [208, 224, 235, 248, 263, 276, 289, 309, 323, 338, 354, 368, 382, 396, 409, 485, 500, 513, 526, 537, 550, 564, 577, 590, 600, 614, 625]
                ],
                scuri: [
                    [186, 197, 207, 217, 226, 237, 247, 259, 269, 277, 286, 297, 309, 317, 329, 416, 423, 434, 442, 450, 462, 470, 477, 487, 495, 501, 509],
                    [192, 206, 217, 228, 240, 251, 263, 275, 284, 295, 309, 317, 330, 341, 354, 437, 450, 465, 475, 485, 495, 502, 511, 523, 530, 539, 550],
                    [205, 215, 228, 240, 253, 264, 277, 289, 301, 315, 327, 342, 358, 372, 387, 467, 480, 502, 517, 529, 542, 556, 570, 586, 599, 614, 627],
                    [213, 225, 238, 251, 266, 279, 293, 315, 332, 346, 363, 379, 394, 408, 425, 490, 503, 519, 530, 543, 558, 572, 588, 600, 615, 627, 639],
                    [220, 233, 250, 264, 279, 293, 309, 324, 339, 354, 368, 383, 402, 417, 433, 509, 529, 545, 562, 575, 593, 608, 622, 635, 652, 667, 682]
                ]
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PVC CODICE 300 - B fino a 300mm (pag. 143)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            pvc_300: {
                codice: "300",
                descrizione: "Corpo cassonetto PVC - B fino a 300mm",
                maxL: 3860,
                colonneL: [615, 740, 865, 990, 1115, 1240, 1365, 1490, 1615, 1740, 1865, 1990, 2115, 2240, 2365, 2490, 2615, 2740, 2865, 2990, 3115, 3240, 3365, 3490, 3615, 3740, 3860],
                righeA: [250, 350, 450, 550, 650],
                bianco: [
                    [189, 202, 213, 224, 233, 244, 254, 264, 276, 284, 295, 306, 316, 329, 339, 423, 434, 442, 458, 470, 483, 495, 504, 519, 529, 540, 553],
                    [202, 214, 225, 235, 248, 261, 272, 282, 294, 306, 316, 330, 341, 354, 366, 450, 465, 475, 488, 499, 510, 524, 535, 546, 560, 572, 586],
                    [213, 225, 237, 250, 263, 276, 286, 300, 313, 327, 340, 354, 367, 379, 391, 482, 491, 503, 519, 530, 543, 558, 572, 588, 600, 615, 627],
                    [221, 235, 250, 263, 277, 292, 302, 317, 333, 345, 363, 376, 389, 403, 417, 504, 520, 532, 546, 564, 577, 594, 609, 624, 637, 653, 668],
                    [232, 247, 263, 277, 292, 309, 323, 338, 354, 368, 382, 396, 409, 428, 440, 532, 546, 564, 577, 594, 609, 624, 637, 653, 668, 683, 698]
                ],
                scuri: [
                    [205, 215, 228, 240, 251, 264, 277, 286, 300, 313, 326, 339, 349, 364, 376, 465, 475, 488, 500, 513, 527, 539, 553, 568, 583, 596, 612],
                    [215, 228, 241, 254, 269, 281, 294, 309, 323, 335, 348, 364, 376, 390, 403, 491, 503, 519, 530, 543, 558, 572, 588, 600, 615, 627, 639],
                    [226, 240, 254, 271, 282, 299, 313, 329, 342, 358, 372, 387, 402, 416, 429, 520, 532, 546, 564, 577, 594, 609, 624, 637, 653, 668, 683],
                    [238, 253, 271, 284, 300, 315, 332, 346, 366, 379, 394, 408, 425, 437, 458, 546, 565, 578, 595, 612, 625, 638, 654, 669, 685, 699, 714],
                    [250, 266, 282, 299, 316, 333, 348, 368, 383, 402, 417, 433, 448, 470, 485, 575, 594, 613, 626, 639, 655, 672, 686, 700, 716, 731, 747]
                ]
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PVC CODICE 300B - B da 335 a 600mm (pag. 144)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            pvc_300B: {
                codice: "300B",
                descrizione: "Corpo cassonetto PVC - B 335-600mm (due profili accoppiati)",
                maxL: 3860,
                colonneL: [615, 740, 865, 990, 1115, 1240, 1365, 1490, 1615, 1740, 1865, 1990, 2115, 2240, 2365, 2490, 2615, 2740, 2865, 2990, 3115, 3240, 3365, 3490, 3615, 3740, 3860],
                righeA: [250, 350, 450, 550, 650],
                bianco: [
                    [189, 202, 213, 224, 233, 244, 254, 264, 276, 284, 295, 306, 316, 329, 339, 423, 434, 442, 458, 470, 483, 495, 504, 519, 529, 540, 553],
                    [202, 214, 225, 235, 248, 261, 272, 282, 294, 306, 316, 330, 341, 354, 366, 450, 465, 475, 488, 499, 510, 524, 535, 546, 560, 572, 586],
                    [213, 225, 237, 250, 263, 276, 286, 300, 313, 327, 340, 354, 367, 379, 391, 482, 491, 503, 519, 530, 543, 558, 572, 588, 600, 615, 627],
                    [221, 235, 250, 263, 277, 292, 302, 317, 333, 345, 363, 376, 389, 403, 417, 504, 520, 532, 546, 564, 577, 594, 609, 624, 637, 653, 668],
                    [232, 247, 263, 277, 292, 309, 323, 338, 354, 368, 382, 396, 409, 428, 440, 532, 546, 564, 577, 594, 609, 624, 637, 653, 668, 683, 698]
                ],
                scuri: [
                    [205, 215, 228, 240, 251, 264, 277, 286, 300, 313, 326, 339, 349, 364, 376, 465, 475, 488, 500, 513, 527, 539, 553, 568, 583, 596, 612],
                    [215, 228, 241, 254, 269, 281, 294, 309, 323, 335, 348, 364, 376, 390, 403, 491, 503, 519, 530, 543, 558, 572, 588, 600, 615, 627, 639],
                    [226, 240, 254, 271, 282, 299, 313, 329, 342, 358, 372, 387, 402, 416, 429, 520, 532, 546, 564, 577, 594, 609, 624, 637, 653, 668, 683],
                    [238, 253, 271, 284, 300, 315, 332, 346, 366, 379, 394, 408, 425, 437, 458, 546, 565, 578, 595, 612, 625, 638, 654, 669, 685, 699, 714],
                    [250, 266, 282, 299, 316, 333, 348, 368, 383, 402, 417, 433, 448, 470, 485, 575, 594, 613, 626, 639, 655, 672, 686, 700, 716, 731, 747]
                ]
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // LEGNO CODICE 9-48 - B fino a 150mm (pag. 145)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            legno_948: {
                codice: "9-48",
                descrizione: "Corpo cassonetto Legno - B fino a 150mm",
                maxL: 2240,
                colonneL: [615, 740, 865, 990, 1115, 1240, 1365, 1490, 1615, 1740, 1865, 1990, 2115, 2240],
                righeA: [250, 350, 450, 550, 650],
                gruppo1: [
                    [244, 261, 279, 297, 312, 330, 345, 361, 376, 392, 407, 421, 436, 449],
                    [279, 297, 318, 336, 354, 375, 393, 411, 427, 445, 462, 479, 496, 511],
                    [318, 339, 363, 384, 405, 427, 449, 469, 489, 511, 531, 551, 572, 591],
                    [354, 378, 405, 430, 454, 479, 502, 527, 550, 575, 599, 622, 646, 668],
                    [390, 418, 448, 477, 504, 533, 560, 588, 615, 642, 670, 696, 723, 749]
                ],
                gruppo23: [
                    [368, 394, 421, 449, 471, 497, 520, 544, 566, 590, 613, 634, 656, 677],
                    [421, 449, 479, 506, 533, 565, 592, 619, 644, 672, 697, 722, 749, 771],
                    [479, 511, 547, 579, 610, 644, 677, 707, 737, 770, 800, 830, 861, 889],
                    [533, 569, 610, 648, 684, 722, 756, 794, 829, 866, 901, 936, 973, 1006],
                    [588, 629, 675, 718, 759, 803, 844, 886, 927, 967, 1008, 1048, 1089, 1127]
                ]
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // LEGNO CODICE 9-48B - B da 335 a 600mm (pag. 146)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            legno_948B: {
                codice: "9-48B",
                descrizione: "Corpo cassonetto Legno - B 335-600mm (due profili accoppiati)",
                maxL: 2240,
                colonneL: [615, 740, 865, 990, 1115, 1240, 1365, 1490, 1615, 1740, 1865, 1990, 2115, 2240],
                righeA: [250, 350, 450, 550, 650],
                gruppo1: [
                    [283, 305, 328, 352, 372, 394, 415, 435, 457, 477, 498, 517, 538, 556],
                    [328, 352, 378, 403, 425, 451, 474, 497, 520, 543, 566, 588, 611, 632],
                    [378, 405, 435, 463, 491, 520, 548, 575, 602, 631, 659, 685, 713, 739],
                    [425, 457, 491, 524, 555, 588, 619, 652, 683, 716, 748, 778, 810, 840],
                    [474, 510, 550, 588, 623, 660, 695, 732, 767, 804, 840, 874, 910, 944]
                ],
                gruppo23: [
                    [427, 460, 495, 531, 561, 594, 625, 656, 688, 719, 750, 778, 809, 837],
                    [495, 531, 570, 607, 641, 680, 714, 748, 783, 818, 852, 885, 920, 951],
                    [570, 610, 655, 697, 739, 783, 825, 866, 907, 950, 991, 1031, 1073, 1111],
                    [641, 688, 739, 789, 836, 886, 933, 981, 1029, 1078, 1126, 1172, 1220, 1265],
                    [714, 768, 827, 885, 939, 995, 1048, 1103, 1156, 1211, 1264, 1316, 1370, 1421]
                ]
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // SUPPLEMENTO ISOLAMENTO TERMICO (pag. 140)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            isolamento: {
                "40830": { spessore: "25mm", prezzo: 63.1, dimensioni: "1000x790mm", usbRisultante: 0.87 },
                "40831": { spessore: "13mm", prezzo: 47.4, dimensioni: "1000x790mm", usbRisultante: 0.87 },
                // âœ… v8.11: Alias per codici OpenPorte
                "posaclima": { spessore: "25mm", prezzo: 63.1, dimensioni: "1000x790mm", usbRisultante: 0.87 },  // Alias per 40830
                "posaclima25": { spessore: "25mm", prezzo: 63.1, dimensioni: "1000x790mm", usbRisultante: 0.87 },
                "posaclima13": { spessore: "13mm", prezzo: 47.4, dimensioni: "1000x790mm", usbRisultante: 0.87 }
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // COLORI PVC E LEGNO
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            coloriPVC: {
                bianco: ["01 extraliscio", "42 bianco goffrato", "45 bianco satinato", "07 bianco perla goffrato", "27 bianco perla satinato"],
                scuri: ["06 grigio", "46 grigio seta", "13 decoro legno castagno", "19 decoro legno rovere", "55 decoro legno noce chiaro"]
            },
            coloriLegno: {
                gruppo1: ["1X01 abete naturale", "1X03 abete sbiancato bianco", "1X05 abete sbiancato", "1X06 abete grigio beige", "1X07 abete marrone", "1X08 abete bianco perla"],
                gruppo2: ["2X01 rovere naturale", "2X02 rovere oleato naturale"],
                gruppo3: ["3X02 rovere grigio luce", "3X03 rovere grigio sabbia", "3X04 rovere grigio quarzo", "3X05 rovere grigio carbone", "3X06 rovere marrone scuro", "3X07 rovere bianco a poro aperto", "3X08 rovere bianco perla a poro aperto"]
            }
        };
        
        console.log('âœ… FINSTRAL_CASSONETTI_PREZZI caricato - Listino EUR 2025/3 (pag. 141-146)');

        // âœ… v8.11: Funzione per determinare gruppo colore cassonetto da codice
        // Ignora gruppoColoreCass e usa il codice colore effettivo
        function determinaGruppoColoreCassonetto(coloreCass) {
            if (!coloreCass) return 'bianco'; // Default
            
            // Estrai codice numerico dal colore (es. "27" da "27 - Bianco perla")
            const match = coloreCass.match(/^(\d{2})/);
            if (!match) return 'bianco';
            
            const codice = match[1];
            
            // Codici bianco (dal listino Finstral pag. 141)
            const codiciBianco = ['01', '07', '27', '42', '45'];
            // Codici scuri (dal listino Finstral pag. 141)  
            const codiciScuri = ['06', '13', '19', '46', '55'];
            
            if (codiciBianco.includes(codice)) {
                console.log(`ğŸ“¦ Colore cassonetto "${coloreCass}" â†’ BIANCO (codice ${codice})`);
                return 'bianco';
            } else if (codiciScuri.includes(codice)) {
                console.log(`ğŸ“¦ Colore cassonetto "${coloreCass}" â†’ SCURI (codice ${codice})`);
                return 'scuri';
            } else {
                // Fallback: cerca parole chiave nel nome
                const lower = coloreCass.toLowerCase();
                if (lower.includes('bianco') || lower.includes('perla') || lower.includes('satinato')) {
                    return 'bianco';
                } else if (lower.includes('grigio') || lower.includes('decoro') || lower.includes('legno') || lower.includes('castagno') || lower.includes('rovere')) {
                    return 'scuri';
                }
                return 'bianco'; // Default conservativo
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”§ v8.09: DATABASE CODICI FINSTRAL (codiceModello + ferramenta)
        // Fonte: OpenPorte v5.52 - FINSTRAL-CODICI-OPENPORTE.md
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const FINSTRAL_CODICI = {
            // CODICI MODELLO (struttura finestra)
            modelli: {
                // 1 Campo
                "101": { descrizione: "1 campo - anta", campi: 1, ante: 1 },
                "102": { descrizione: "1 campo - fisso", campi: 1, ante: 0 },
                // 2 Campi Orizzontali
                "201": { descrizione: "2 ante (SX + DX)", campi: 2, ante: 2 },
                "202": { descrizione: "Anta SX + fisso DX", campi: 2, ante: 1 },
                "203": { descrizione: "Fisso SX + anta DX", campi: 2, ante: 1 },
                "204": { descrizione: "2 fissi", campi: 2, ante: 0 },
                // 2 Campi Verticali
                "205": { descrizione: "2 ante verticali", campi: 2, ante: 2 },
                "206": { descrizione: "Anta basso + fisso alto", campi: 2, ante: 1 },
                "207": { descrizione: "Fisso basso + anta alto", campi: 2, ante: 1 },
                "208": { descrizione: "2 fissi verticali", campi: 2, ante: 0 },
                // 3 Campi
                "301": { descrizione: "3 ante (SX + centro + DX)", campi: 3, ante: 3 },
                "302": { descrizione: "Anta + fisso + anta", campi: 3, ante: 2 },
                "303": { descrizione: "Fisso + anta + fisso", campi: 3, ante: 1 },
                "304": { descrizione: "3 fissi", campi: 3, ante: 0 },
                "321": { descrizione: "Fisso SX + anta centro + anta DX", campi: 3, ante: 2 },
                "322": { descrizione: "Anta SX + anta centro + fisso DX", campi: 3, ante: 2 },
                // 4 Campi
                "316": { descrizione: "4 ante", campi: 4, ante: 4 },
                "317": { descrizione: "4 fissi", campi: 4, ante: 0 },
                // Con Montante Mobile
                "401": { descrizione: "2 ante con montante mobile", campi: 2, ante: 2, montante: true },
                "402": { descrizione: "Fisso basso + 2 ante montante alto", campi: 3, ante: 2, montante: true },
                "403": { descrizione: "2 ante montante basso + fisso alto", campi: 3, ante: 2, montante: true },
                "414": { descrizione: "Fisso SX + anta montante DX", campi: 2, ante: 1, montante: true },
                "415": { descrizione: "Anta montante SX + fisso DX", campi: 2, ante: 1, montante: true },
                "420": { descrizione: "Anta SX + anta montante DX", campi: 2, ante: 2, montante: true },
                "421": { descrizione: "Anta montante SX + anta DX", campi: 2, ante: 2, montante: true },
                "424": { descrizione: "3 ante con montante", campi: 3, ante: 3, montante: true },
                // Bilico
                "450": { descrizione: "Anta a bilico singola", campi: 1, ante: 1, bilico: true },
                "451": { descrizione: "Bilico + fisso DX", campi: 2, ante: 1, bilico: true },
                "452": { descrizione: "Fisso SX + bilico", campi: 2, ante: 1, bilico: true },
                // Scorrevole
                "500": { descrizione: "Scorrevole parallela", campi: 1, ante: 1, scorrevole: true },
                "501": { descrizione: "Scorrevole parallela SX", campi: 1, ante: 1, scorrevole: true },
                "510": { descrizione: "2 scorrevoli parallele", campi: 2, ante: 2, scorrevole: true },
                "511": { descrizione: "Scorrevole parallela DX", campi: 1, ante: 1, scorrevole: true }
            },
            
            // CODICI FERRAMENTA
            ferramenta: {
                // Anta/Ribalta
                "411": { descrizione: "Anta/ribalta", cerniere: "a-vista" },
                "211": { descrizione: "Anta/ribalta", cerniere: "a-scomparsa" },
                "409": { descrizione: "Ribalta primaria", cerniere: "a-vista" },
                "209": { descrizione: "Ribalta primaria", cerniere: "a-scomparsa" },
                // Solo Anta
                "430": { descrizione: "Anta interno", cerniere: "a-vista" },
                "230": { descrizione: "Anta interno", cerniere: "a-scomparsa" },
                "453": { descrizione: "Anta esterno", cerniere: "a-vista" },
                // Solo Ribalta
                "432": { descrizione: "Ribalta maniglia laterale", cerniere: null },
                "232": { descrizione: "Ribalta", cerniere: "a-scomparsa" },
                "431": { descrizione: "Sopraluce maniglia superiore", cerniere: null },
                "433": { descrizione: "Sopraluce comando leva", cerniere: null },
                "434": { descrizione: "Sopraluce arganello", cerniere: null },
                "436": { descrizione: "Sopraluce motorizzato", cerniere: null },
                // Con Montante
                "425": { descrizione: "Anta + comando leva", cerniere: "a-vista" },
                "225": { descrizione: "Anta + comando leva", cerniere: "a-scomparsa" },
                "B411": { descrizione: "Anta/ribalta + montante alto", cerniere: "a-vista" },
                "B211": { descrizione: "Anta/ribalta + montante", cerniere: "a-scomparsa" },
                // Porta con Serratura
                "475": { descrizione: "Anta/ribalta + serratura", cerniere: "a-vista" },
                "275": { descrizione: "Anta/ribalta + serratura", cerniere: "a-scomparsa" },
                "473": { descrizione: "Anta + serratura interno", cerniere: "a-vista" },
                "471": { descrizione: "Anta + serratura esterno", cerniere: "a-vista" },
                // Scorrevoli
                "710": { descrizione: "Scorrevole parallela a ribalta", cerniere: null },
                "711": { descrizione: "Scorrevole + serratura", cerniere: null },
                "720": { descrizione: "Scorrevole parallela", cerniere: null },
                "721": { descrizione: "Scorrevole + serratura", cerniere: null }
            },
            
            // LATI APERTURA
            lati: {
                "-1": "Sinistra (SX)",
                "-2": "Destra (DX)"
            },
            
            // ESECUZIONI SICUREZZA
            esecuzioni: {
                "0": "Standard",
                "3": "Perimetrale + angolare",
                "4": "Perimetrale"
            },
            
            // Funzioni helper
            getModello: function(codice) {
                return this.modelli[codice] || { descrizione: `Codice ${codice}`, campi: 1, ante: 1 };
            },
            
            getFerramenta: function(codice) {
                return this.ferramenta[codice] || { descrizione: `Ferramenta ${codice}`, cerniere: null };
            },
            
            getLato: function(codice) {
                return this.lati[codice] || codice;
            },
            
            getEsecuzione: function(codice) {
                return this.esecuzioni[codice] || 'Standard';
            },
            
            // Decodifica completa infisso
            decodificaInfisso: function(infisso) {
                const modello = this.getModello(infisso.codiceModello);
                const ferramenta = this.getFerramenta(infisso.ferramenta1);
                const lato = this.getLato(infisso.lato1);
                const esecuzione = this.getEsecuzione(infisso.esecuzione1);
                
                return {
                    codiceModello: infisso.codiceModello,
                    descrizioneModello: modello.descrizione,
                    campi: modello.campi,
                    ante: modello.ante,
                    montante: modello.montante || false,
                    bilico: modello.bilico || false,
                    scorrevole: modello.scorrevole || false,
                    ferramenta: infisso.ferramenta1,
                    descrizioneFerramenti: ferramenta.descrizione,
                    cerniere: ferramenta.cerniere,
                    lato: lato,
                    esecuzione: esecuzione
                };
            }
        };
        
        console.log('âœ… FINSTRAL_CODICI caricato - OpenPorte v5.52');

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”Œ DATABASE PREZZI SOMFY - v7.999 (04 DIC 2025)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”§ v8.09: DATABASE SOMFY LISTINO 2025 (Completo da Excel ufficiale)
        // Fonte: Listino_2025_CUSTOMERS_IND_B2B_-_IND_B2C_-_INST_B2C.xlsx
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SOMFY_PREZZI = {
            versione: "2025",
            dataAggiornamento: "2025-12-05",
            fonte: "Listino_2025_CUSTOMERS_IND_B2B_-_IND_B2C_-_INST_B2C.xlsx",
            note: "Prezzi LISTINO IVA esclusa - Applicare sconto installatore",
            
            // âš ï¸ SCONTO INSTALLATORE - DA COMPILARE
            SCONTO_INSTALLATORE: 0,  // Esempio: 0.43 = 43% di sconto
            
            // Helper per calcolo prezzo netto
            getPrezzoNetto: function(prezzoListino) {
                return Math.round(prezzoListino * (1 - this.SCONTO_INSTALLATORE) * 100) / 100;
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // MOTORI OXIMO IO (Connesso - Protocollo io-homecontrol)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            motori: {
                // OXIMO IO - Connessi
                "oximo_io_6":  { ref: "1032696", nome: "OXIMO IO 6/17 VVF 3M UNIT", listino: 272.10, coppia: 6, velocita: 17 },
                "oximo_io_10": { ref: "1037686", nome: "OXIMO IO 10/17 VVF 3M UNIT", listino: 284.52, coppia: 10, velocita: 17 },
                "oximo_io_15": { ref: "1039589", nome: "OXIMO IO 15/17 VVF 3M", listino: 303.14, coppia: 15, velocita: 17 },
                "oximo_io_20": { ref: "1041627", nome: "OXIMO IO 20/17 VVF 3M UNIT", listino: 321.79, coppia: 20, velocita: 17 },
                "oximo_io_30": { ref: "1045513", nome: "OXIMO IO 30/17 VVF 3M UNIT", listino: 340.42, coppia: 30, velocita: 17 },
                "oximo_io_40": { ref: "1049605", nome: "OXIMO IO 40/17 VVF 3M", listino: 371.49, coppia: 40, velocita: 17 },
                "oximo_io_50": { ref: "1049732", nome: "OXIMO IO 50/12 VVF 3M BAR", listino: 383.91, coppia: 50, velocita: 12 },
                
                // Alias retrocompatibilitÃ 
                "oximo_20": { ref: "1041627", nome: "OXIMO IO 20/17 VVF 3M UNIT", listino: 321.79, coppia: 20, velocita: 17 },
                "oximo_30": { ref: "1045513", nome: "OXIMO IO 30/17 VVF 3M UNIT", listino: 340.42, coppia: 30, velocita: 17 },
                "oximo_50_io_20": { ref: "1041627", nome: "OXIMO IO 20/17 VVF 3M UNIT", listino: 321.79, coppia: 20, velocita: 17 },
                "oximo_50_io_30": { ref: "1045513", nome: "OXIMO IO 30/17 VVF 3M UNIT", listino: 340.42, coppia: 30, velocita: 17 },
                
                // OXIMO RTS - Radio unidirezionale
                "oximo_rts_6":  { ref: "1032389", nome: "OXIMO RTS 6/17 VVF 3M UNIT", listino: 273.17, coppia: 6, velocita: 17 },
                "oximo_rts_10": { ref: "1037384", nome: "OXIMO RTS 10/17 VVF 3M UNIT", listino: 285.64, coppia: 10, velocita: 17 },
                "oximo_rts_15": { ref: "1039363", nome: "OXIMO RTS 15/17 VVF 3M UNIT", listino: 304.33, coppia: 15, velocita: 17 },
                "oximo_rts_20": { ref: "1041374", nome: "OXIMO RTS 20/17 VVF 3M UNIT", listino: 323.06, coppia: 20, velocita: 17 },
                "oximo_rts_30": { ref: "1045314", nome: "OXIMO RTS 30/17 VVF 3M UNIT", listino: 335.52, coppia: 30, velocita: 17 },
                "oximo_rts_40": { ref: "1049430", nome: "OXIMO RTS 40/17 VVF 3M UNIT", listino: 372.95, coppia: 40, velocita: 17 },
                "oximo_rts_50": { ref: "1049720", nome: "OXIMO RTS 50/12 VVF 3M BAR", listino: 385.43, coppia: 50, velocita: 12 },
                
                // OXIMO WT - Wireless/Batteria
                "oximo_wt_6":  { ref: "1032575", nome: "OXIMO WT 6/17 VVF 3M UNIT", listino: 210.54, coppia: 6, velocita: 17, wireless: true },
                "oximo_wt_10": { ref: "1037579", nome: "OXIMO WT 10/17 VVF 3M UNIT", listino: 222.32, coppia: 10, velocita: 17, wireless: true },
                "oximo_wt_15": { ref: "1039491", nome: "OXIMO WT 15/17 VVF 3M UNIT", listino: 234.08, coppia: 15, velocita: 17, wireless: true },
                "oximo_wt_20": { ref: "1041526", nome: "OXIMO WT 20/17 VVF 3M UNIT", listino: 263.48, coppia: 20, velocita: 17, wireless: true },
                "oximo_wt_30": { ref: "1045446", nome: "OXIMO WT 30/17 VVF 3M UNIT", listino: 295.24, coppia: 30, velocita: 17, wireless: true },
                "oximo_wt_40": { ref: "1049541", nome: "OXIMO WT 40/17 VVF 3M UNIT", listino: 334.07, coppia: 40, velocita: 17, wireless: true },
                
                // OXIMO AUTO - Finecorsa automatico
                "oximo_auto_rts_6": { ref: "1130128", nome: "OXIMO 50 S AUTO RTS 6/17 VVF 3M", listino: 295.80, coppia: 6, velocita: 17, auto: true },
                "oximo_auto_io_6":  { ref: "1130334", nome: "OXIMO 50 S AUTO IO 6/17 VVF 3M", listino: 321.79, coppia: 6, velocita: 17, auto: true },
                
                // LT50 HELIOS - Motori cablati
                "lt50_helios":      { ref: "1045041", nome: "LT HELIOS 30/17 VVF 2,5M UNIT", listino: 255.06, coppia: 30, velocita: 17 },
                "lt50_helios_30":   { ref: "1045041", nome: "LT HELIOS 30/17 VVF 2,5M UNIT", listino: 255.06, coppia: 30, velocita: 17 },
                "lt_helios_30_17":  { ref: "1045041", nome: "LT HELIOS 30/17 VVF 2,5M UNIT", listino: 255.06, coppia: 30, velocita: 17 },
                "lt50_helios_30_12": { ref: "1045034", nome: "LT HELIOS 30/12 VVF 2,5M UNIT", listino: 156.07, coppia: 30, velocita: 12 }
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // COMANDI E TELECOMANDI
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            comandi: {
                // AMY - Comandi a muro compatti
                "amy_1_io":           { ref: "1871061", nome: "Amy 1 io C", listino: 57.45 },
                "amy_1_io_frame":     { ref: "1871062", nome: "Amy 1 io + Frame C", listino: 57.45 },
                "amy_1_modes":        { ref: "1871077", nome: "Amy 1 Modes io C", listino: 67.34 },
                "amy_1_modes_frame":  { ref: "1871078", nome: "Amy 1 Modes io + Frame C", listino: 67.34 },
                "amy_2_modes":        { ref: "1871095", nome: "Amy 2 Modes io C", listino: 90.00 },
                "amy_4_modes_frame":  { ref: "1871114", nome: "Amy 4 Modes io + Frame C", listino: 99.60 },
                "amy1": { ref: "1871062", nome: "Amy 1 io + Frame C", listino: 57.45 },  // Alias retrocompatibilitÃ 
                
                // SITUO - Telecomandi portatili
                "situo_1_rts":       { ref: "1870496", nome: "SITUO 1 RTS DIY", listino: 72.87 },
                "situo_1_rts_pure":  { ref: "1870571", nome: "SITUO 1 RTS FCC PURE II", listino: 58.22 },
                "situo_1_var_pure":  { ref: "1811608", nome: "SITUO 1 VAR RTS PURE II 20L", listino: 100.97 },
                
                // SMOOVE - Comandi a muro
                "smoove_origin_2_io":   { ref: "1800204", nome: "Smoove Origin 2 io + Frame", listino: 84.01 },
                "smoove_origin_4_io":   { ref: "1800205", nome: "Smoove Origin 4 io + Frame 15L", listino: 102.94 },
                "smoove_origin_2_rts":  { ref: "1800223", nome: "Smoove Origin 2 RTS + Frame", listino: 80.25 },
                "smoove_origin_4_rts":  { ref: "1800295", nome: "Smoove Origin 4 RTS + Frame", listino: 103.35 },
                
                // TELIS/CHRONIS - Timer e multicanale
                "telis_6_chronis_pure":   { ref: "1805209", nome: "TELIS 6 CHRONIS RTS PURE", listino: 260.16 },
                "chronis_io":             { ref: "1805228", nome: "CHRONIS IO 10L", listino: 188.15 },
                
                // NINA - Touch screen
                "nina_io":       { ref: "1805251", nome: "NINA IO", listino: 269.67 },
                "nina_timer_io": { ref: "1811407", nome: "NINA TIMER IO", listino: 301.72 },
                
                // INIS - Pulsanti/chiave
                "inis_uno": { ref: "1800191", nome: "INIS UNO", listino: 21.70 }
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // RICEVITORI
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ricevitori: {
                // IZYMO - Micro da incasso
                "izymo_shutter":     { ref: "1822660", nome: "IZYMO SHUTTER RECEIVER IO", listino: 114.82 },
                "izymo_on_off":      { ref: "1822649", nome: "IZYMO ON-OFF RECEIVER IO", listino: 81.89 },
                "izymo_dimmer":      { ref: "1822663", nome: "IZYMO DIMMER RECEIVER IO", listino: 92.62 },
                "izymo_transmitter": { ref: "1822609", nome: "IZYMO TRANSMITTER IO", listino: 65.49 },
                "izymo": { ref: "1822660", nome: "IZYMO SHUTTER RECEIVER IO", listino: 114.82 },  // Alias
                
                // Universal - Per compatibilitÃ  RTS
                "universal_rts":       { ref: "1810624", nome: "UNIVERSAL RECEIVER RTS", listino: 159.19 },
                "universal_slim_rts":  { ref: "1810783", nome: "UNIVERSAL SLIM RECEIVER RTS", listino: 224.51 },
                
                // Micro
                "micro_shutter": { ref: "2401162", nome: "MICRO RECEIVER RTS FOR SHUTTER", listino: 81.07 }
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ACCESSORI
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            accessori: {
                "supporto": { ref: "9019821", nome: "SUPPORTO OPERATORE DA AVVITARE", listino: 7.88 },
                "supporto_operatore": { ref: "9019821", nome: "SUPPORTO OPERATORE DA AVVITARE", listino: 7.88 },
                "ruota_60": { ref: "9751001", nome: "RUOTA PER RULLO OTTAGONALE 60mm", listino: 21.00 },
                "corona_60": { ref: "9707025", nome: "CORONA OTT.60 I", listino: 17.67 }
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // HELPER FUNCTIONS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            // Helper per trovare prezzo motore per ID
            getPrezzoMotore: function(modelloId) {
                if (!modelloId) return null;
                const id = modelloId.toLowerCase().replace(/[\s-]/g, '_');
                const motore = this.motori[id];
                if (motore) {
                    return { ...motore, prezzo: motore.listino, prezzoNetto: this.getPrezzoNetto(motore.listino) };
                }
                return null;
            },
            
            // Helper per trovare prezzo comando per ID
            getPrezzoComando: function(comandoId) {
                if (!comandoId) return null;
                const id = comandoId.toLowerCase().replace(/[\s-]/g, '_');
                const comando = this.comandi[id];
                if (comando) {
                    return { ...comando, prezzo: comando.listino, prezzoNetto: this.getPrezzoNetto(comando.listino) };
                }
                // Cerca anche nei ricevitori
                const ricevitore = this.ricevitori[id];
                if (ricevitore) {
                    return { ...ricevitore, prezzo: ricevitore.listino, prezzoNetto: this.getPrezzoNetto(ricevitore.listino) };
                }
                return null;
            },
            
            // Helper per calcolare prezzo totale kit motore
            calcolaPrezzoKit: function(motoreInfo) {
                let totale = 0;
                let dettaglio = [];
                
                // Motore
                const motore = this.getPrezzoMotore(motoreInfo.modelloId);
                if (motore) {
                    totale += motore.listino;
                    dettaglio.push({ nome: motore.nome, prezzo: motore.listino });
                }
                
                // Comando
                const comando = this.getPrezzoComando(motoreInfo.comandoId);
                if (comando) {
                    totale += comando.listino;
                    dettaglio.push({ nome: comando.nome, prezzo: comando.listino });
                }
                
                // Accessori
                const acc = motoreInfo.accessori || {};
                if (acc.supporto && this.accessori.supporto) {
                    totale += this.accessori.supporto.listino;
                    dettaglio.push({ nome: this.accessori.supporto.nome, prezzo: this.accessori.supporto.listino });
                }
                if (acc.ruota_60 && this.accessori.ruota_60) {
                    totale += this.accessori.ruota_60.listino;
                    dettaglio.push({ nome: this.accessori.ruota_60.nome, prezzo: this.accessori.ruota_60.listino });
                }
                if (acc.corona_60 && this.accessori.corona_60) {
                    totale += this.accessori.corona_60.listino;
                    dettaglio.push({ nome: this.accessori.corona_60.nome, prezzo: this.accessori.corona_60.listino });
                }
                
                return { 
                    totale, 
                    totaleNetto: this.getPrezzoNetto(totale),
                    dettaglio 
                };
            }
        };
        
        console.log('âœ… SOMFY_PREZZI v8.09 - Listino 2025 completo (OXIMO IO/RTS/WT, Amy, Situo, Smoove, IZYMO)');

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ¦Ÿ DATABASE PALAGINA ZANZARIERE 2025
        // Fonte: Catalogo Zanzariere_2025_IT_128_Web-cm.pdf
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const PALAGINA_ZANZARIERE_2025 = {
            metadata: {
                fornitore: 'Palagina',
                listino: 'Zanzariere 2025',
                dataListino: '2025-01-01',
                dataEstrazione: '2025-12-05',
                valuta: 'EUR',
                consegnaSettimane: 4,
                note: 'Prezzi netti installatore'
            },

            // MODELLI CON PREZZI â‚¬/mq per fascia
            modelli: {
                // ----- LINEA SINTESI -----
                'EXTREMA': { linea: 'SINTESI', maxH: 230, prezzi: { F1: 164.00, F2: 172.20, F3: 196.80 }, minMq: 2.00 },
                'EXTREMA_CENTRALE': { linea: 'SINTESI', maxH: 230, prezzi: { F1: 173.50, F2: 182.18, F3: 208.20 }, minMq: 2.00 },
                'EXTREMA_SR': { linea: 'SINTESI', maxH: 460, prezzi: { F1: 173.50, F2: 182.18, F3: 208.20 }, minMq: 4.00 },
                'EXTREMA_INCASSO': { linea: 'SINTESI', cassonetti: [46, 50], maxH: 230, prezzi: { F1: 173.50, F2: 182.18, F3: 208.20 }, minMq: 2.00 },
                'EXTREMA_INCASSO_CENTRALE': { linea: 'SINTESI', cassonetti: [46, 50], maxH: 460, prezzi: { F1: 173.50, F2: 182.18, F3: 208.20 }, minMq: 4.00 },
                'EXTREMA_INCASSO_SR': { linea: 'SINTESI', cassonetti: [46, 50], maxH: 460, prezzi: { F1: 173.50, F2: 182.18, F3: 208.20 }, minMq: 4.00 },
                'NANO_SINTESI': { linea: 'SINTESI', cassonetti: [22], maxH: 180, prezzi: { F1: 148.00, F2: 155.40, F3: 177.60 }, minMq: 2.00 },
                'MICRO_SINTESI': { linea: 'SINTESI', cassonetti: [36], maxH: 200, prezzi: { F1: 157.00, F2: 164.85, F3: 188.40 }, minMq: 4.00 },
                'MICRO_SINTESI_CENTRALE': { linea: 'SINTESI', cassonetti: [36], maxH: 200, prezzi: { F1: 157.00, F2: 164.85, F3: 188.40 }, minMq: 4.00 },
                'SINTESI': { linea: 'SINTESI', cassonetti: [46, 50], maxH: 210, prezzi: { F1: 157.00, F2: 164.85, F3: 188.40 }, minMq: 2.00 },
                'SINTESI_CENTRALE': { linea: 'SINTESI', cassonetti: [46, 50], maxH: 210, prezzi: { F1: 166.00, F2: 174.30, F3: 199.20 }, minMq: 2.00 },
                'SINTESI_INCASSO': { linea: 'SINTESI', cassonetti: [46, 50], maxH: 210, prezzi: { F1: 166.00, F2: 174.30, F3: 199.20 }, minMq: 2.00 },
                'SINTESI_INCASSO_CENTRALE': { linea: 'SINTESI', cassonetti: [46, 50], maxH: 420, prezzi: { F1: 166.00, F2: 174.30, F3: 199.20 }, minMq: 4.00 },

                // ----- LINEA SV (NEW 2025) -----
                'SV_700': { linea: 'SV', cassonetti: [45, 50], maxH: 250, prezzi: { F1: 84.00, F2: 92.40, F3: 109.20 }, minMq: 1.50, reteDiSerie: 'HC' },

                // ----- LINEA EVO (NEW 2025) -----
                'EVO_ROOF': { linea: 'EVO', cassonetti: [40], maxH: 150, prezzi: { F1: 126.00, F2: null, F3: 176.40 }, minMq: 1.50, tipo: 'Lucernario' },

                // ----- SERIE X - COMPATTO -----
                'X1_INCASSO': { linea: 'COMPATTO', cassonetti: [50], maxH: 200, prezzi: { F1: 113.50, F2: 124.85, F3: 141.88 }, minMq: 1.50 },
                'X3_LUCE': { linea: 'COMPATTO', cassonetti: [53], maxH: 200, prezzi: { F1: 144.50, F2: 158.95, F3: 180.63 }, minMq: 1.50 }
            },

            // COLORI PER FASCIA
            colori: {
                F1: [
                    { cod: '1', nome: 'Argento OX' }, { cod: '5', nome: 'Bianco', ral: '9010' },
                    { cod: '6', nome: 'Avorio', ral: '1013' }, { cod: '10', nome: 'Grigio polvere', ral: '7037' },
                    { cod: '27', nome: 'Testa di moro' }, { cod: '28', nome: 'Nero', ral: '9011 OP' },
                    { cod: '30', nome: 'Bianco crema', ral: '9001' }, { cod: '35', nome: 'Bronzo Verniciato' },
                    { cod: '41', nome: 'Bianco', ral: '9010 OP' }, { cod: '46', nome: 'Grigio chiaro', ral: '7035' },
                    { cod: '49', nome: 'Verde', ral: '6005 OP' }, { cod: '85', nome: 'Bianco traffico', ral: '9016 OP' },
                    { cod: '90', nome: 'Marrone', ral: '8017 OP' }, { cod: '91', nome: 'Grigio silver', ral: '9006' },
                    { cod: '94', nome: 'Avorio', ral: '1013 OP' }
                ],
                F2: [
                    { cod: '13', nome: 'Grigio Michelangelo' }, { cod: '29', nome: 'Ferro micaceo' },
                    { cod: '78', nome: 'Grigio antracite', ral: '7016 SablÃ©' }
                ],
                F3: [
                    { cod: '17', nome: 'Rovere P9' }, { cod: '26', nome: 'Renolit chiaro', codice: '386-73/R' },
                    { cod: '32', nome: 'Renolit scuro', codice: '387-70/R' }, { cod: '33', nome: 'Noce', codice: '360-70/R' },
                    { cod: '37', nome: 'Douglas', codice: '335.80/R' }, { cod: '48', nome: 'Rovere Scuro', codice: '474-123/R' }
                ]
            },

            // TIPI RETE CON SUPPLEMENTI â‚¬/mq
            reti: {
                'STD': { nome: 'Standard PP', supplementoMq: 0, note: 'Polipropilene' },
                'HC': { nome: 'HC Alto Contrasto', supplementoMq: 0, note: 'Nera, fibra vetro' },
                'FV': { nome: 'Fibra vetro grigia', supplementoMq: 0 },
                'AB': { nome: 'Anti-batterica certificata', supplementoMq: 0, note: 'Antracite' },
                'AT': { nome: 'Alta trasparenza nera', supplementoMq: 5.00 },
                'SOL': { nome: 'Solar 0,35', supplementoMq: 9.50, note: 'Grigia o nera' }
            },

            // ACCESSORI
            accessori: {
                'GUIDA_PVC': { nome: 'Guida a terra in PVC pendenza 8Â°', prezzo: 0, unita: 'cad' },
                'QUICK_LOCK': { nome: 'Sgancio Quick-Lock', prezzo: 18.00, unita: 'cad' },
                'SGANCIO_CRIC': { nome: 'Sgancio cricchetto Lato Riscontro', prezzo: 20.50, unita: 'cad' },
                'CARRO_FLUO': { nome: 'Carro Fluo', prezzo: 25.00, unita: 'cad' },
                'MANIGLIA_TESS': { nome: 'Maniglia tessile', prezzo: 7.50, unita: 'cad' },
                'DOPPIA_MANIGLIA': { nome: 'Doppia maniglia ribassata int/est', prezzo: 9.00, unita: 'coppia' },
                'GUIDA_ALU': { nome: 'Guida inferiore in alluminio', prezzo: 10.50, unita: 'cad' },
                'TUBO_MAGNUM': { nome: 'Tubo Magnum Ã˜28', prezzo: 18.00, unita: 'cad', note: 'Solo cass. 50mm' },
                'KIT_REGGI': { nome: 'Kit Reggi Guide Pala-System', prezzo: 3.50, unita: 'kit' },
                'BARRA_EXTRA': { nome: 'Barramaniglia Extra Forte', prezzo: 4.50, unita: 'mq', note: 'Consig. >180cm' }
            },

            // SUPPLEMENTI SPECIALI
            supplementi: {
                ralSpecial: { percentuale: 10, fisso: 60.00 }  // +10% su F1 + â‚¬60 netti
            },

            // FUNZIONE: Determina fascia da codice colore
            getFasciaByColore: function(codColore) {
                const cod = String(codColore);
                for (const [fascia, colori] of Object.entries(this.colori)) {
                    if (colori.find(c => c.cod === cod)) return fascia;
                }
                return null;
            },

            // FUNZIONE: Calcola prezzo zanzariera
            calcolaPrezzo: function(modello, larghezzaCm, altezzaCm, fascia, tipoRete = 'STD', accessoriIds = []) {
                const mod = this.modelli[modello];
                if (!mod) return { errore: `Modello ${modello} non trovato`, totale: 0 };

                // Calcola mq
                const mq = (larghezzaCm / 100) * (altezzaCm / 100);
                const mqFatturati = Math.max(mq, mod.minMq);

                // Prezzo base
                const prezzoMq = mod.prezzi[fascia];
                if (!prezzoMq) return { errore: `Fascia ${fascia} non disponibile per ${modello}`, totale: 0 };
                const prezzoBase = mqFatturati * prezzoMq;

                // Supplemento rete
                const rete = this.reti[tipoRete];
                const suppRete = rete ? mqFatturati * rete.supplementoMq : 0;

                // Accessori
                let totAccessori = 0;
                const accessoriDettaglio = [];
                (accessoriIds || []).forEach(accId => {
                    const acc = this.accessori[accId];
                    if (acc) {
                        let costo = acc.prezzo;
                        if (acc.unita === 'mq') costo = acc.prezzo * mqFatturati;
                        totAccessori += costo;
                        accessoriDettaglio.push({ id: accId, ...acc, costo });
                    }
                });

                const totale = prezzoBase + suppRete + totAccessori;

                return {
                    modello, dimensioni: { L: larghezzaCm, H: altezzaCm },
                    mqReali: parseFloat(mq.toFixed(4)),
                    mqFatturati: parseFloat(mqFatturati.toFixed(2)),
                    minMq: mod.minMq,
                    fascia, prezzoMq,
                    prezzoBase: parseFloat(prezzoBase.toFixed(2)),
                    rete: rete ? rete.nome : 'Standard',
                    suppRete: parseFloat(suppRete.toFixed(2)),
                    accessori: accessoriDettaglio,
                    totAccessori: parseFloat(totAccessori.toFixed(2)),
                    totale: parseFloat(totale.toFixed(2))
                };
            }
        };

        console.log('âœ… PALAGINA_ZANZARIERE_2025 v1.0 - Catalogo Zanzariere 2025 (18 modelli, 3 fasce colore, 6 reti, 10 accessori)');

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ’° SISTEMA SCONTI FORNITORI v8.14
        // Sconti applicati dai fornitori a Open Porte & Finestre
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SCONTI_FORNITORI = {
            // Sconti effettivi (giÃ  calcolati per sconti composti)
            sconti: {
                'FINSTRAL':       36.76,  // 32% + 7% composto
                'PALAGINA':       50.00,
                'PUNTO PERSIANE': 55.00,
                'SOMFY':          40.00,
                'FERREROLEGNO':   50.00,
                'FLESSYA':        53.00,
                'OIKOS':          46.00,  // 40% + 10% composto
                'PLASTICINO':     45.00,  // Tapparelle/Avvolgibili
                'OLIVARI':        43.00,  // 40% + 5% composto - Maniglie
                'COLOMBO DESIGN': 40.00,  // Maniglie
            },
            
            // Alias per normalizzazione nomi
            alias: {
                'finstral': 'FINSTRAL',
                'palagina': 'PALAGINA',
                'punto persiane': 'PUNTO PERSIANE',
                'puntopersiane': 'PUNTO PERSIANE',
                'somfy': 'SOMFY',
                'ferrerolegno': 'FERREROLEGNO',
                'ferrero legno': 'FERREROLEGNO',
                'flessya': 'FLESSYA',
                'oikos': 'OIKOS',
                'plasticino': 'PLASTICINO',
                'olivari': 'OLIVARI',
                'colombo': 'COLOMBO DESIGN',
                'colombo design': 'COLOMBO DESIGN',
            },
            
            // Normalizza nome azienda
            normalizzaAzienda: function(azienda) {
                if (!azienda) return 'ALTRO';
                const lower = azienda.toLowerCase().trim();
                return this.alias[lower] || azienda.toUpperCase();
            },
            
            // Ottieni sconto % per azienda
            getSconto: function(azienda) {
                const nome = this.normalizzaAzienda(azienda);
                return this.sconti[nome] || 0;
            },
            
            // Calcola prezzo netto (tuo costo)
            calcolaNetto: function(prezzoListino, azienda) {
                const sconto = this.getSconto(azienda);
                return prezzoListino * (1 - sconto / 100);
            },
            
            // Calcola prezzo cliente con ricarico
            calcolaPrezzoCliente: function(prezzoListino, azienda, ricarico = 0) {
                const netto = this.calcolaNetto(prezzoListino, azienda);
                return netto * (1 + ricarico / 100);
            },
            
            // Calcola margine
            calcolaMargine: function(prezzoListino, azienda, ricarico = 0) {
                const netto = this.calcolaNetto(prezzoListino, azienda);
                const cliente = netto * (1 + ricarico / 100);
                return cliente - netto;
            },
            
            // Formatta con dettaglio
            calcolaDettaglio: function(prezzoListino, azienda, ricarico = 0) {
                const nome = this.normalizzaAzienda(azienda);
                const sconto = this.getSconto(azienda);
                const netto = this.calcolaNetto(prezzoListino, azienda);
                const cliente = this.calcolaPrezzoCliente(prezzoListino, azienda, ricarico);
                const margine = cliente - netto;
                
                return {
                    azienda: nome,
                    listino: parseFloat(prezzoListino.toFixed(2)),
                    sconto: sconto,
                    netto: parseFloat(netto.toFixed(2)),
                    ricarico: ricarico,
                    cliente: parseFloat(cliente.toFixed(2)),
                    margine: parseFloat(margine.toFixed(2))
                };
            }
        };
        
        console.log('âœ… SCONTI_FORNITORI v8.24 - Sistema sconti attivo (10 fornitori configurati)');

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”§ PLASTICINO AVVOLGIBILI 2025 - Database Tapparelle
        // Fonte: Listino-Catalogo Generale Avvolgibili 07.2022
        // Sconto installatore: 45%
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const PLASTICINO_AVVOLGIBILI_2025 = {
            info: { fornitore: "PLASTICINO S.r.l.", sconto: 0.45 },
            
            // TELI PRINCIPALI (â‚¬/mq)
            teli: {
                // Alluminio Media DensitÃ 
                TA01: { codice: "TA01", nome: "ALUPROFIL MD 13x55", materiale: "Alluminio MD", sezione: "13x55", prezzi: { unita: 60.00, legno: 61.50, raffaello: 62.50 }, max_l: 3000 },
                TA05: { codice: "TA05", nome: "ALUPROFIL MD 9x41", materiale: "Alluminio MD", sezione: "9x41", prezzi: { unita: 66.00, legno: 67.50, raffaello: 68.50 }, max_l: 2500 },
                TA42: { codice: "TA42", nome: "ALUPROFIL MD 8.5x32", materiale: "Alluminio MD", sezione: "8.5x32", prezzi: { unita: 90.00, legno: 91.50, raffaello: 92.50 }, max_l: 2500 },
                TA07: { codice: "TA07", nome: "ALUPROFIL MD 8x37", materiale: "Alluminio MD", sezione: "8x37", prezzi: { unita: 77.00, legno: 78.50 }, max_l: 2000 },
                
                // Alluminio Alta DensitÃ 
                TA25: { codice: "TA25", nome: "ALUPROFIL AD 13x55", materiale: "Alluminio AD", sezione: "13x55", prezzi: { unita: 73.00, legno: 74.50, raffaello: 75.50 }, max_l: 3500 },
                TA30: { codice: "TA30", nome: "ALUPROFIL AD 9x41", materiale: "Alluminio AD", sezione: "9x41", prezzi: { unita: 72.00, legno: 73.50, raffaello: 74.50 } },
                
                // Acciaio Coibentato
                TA15: { codice: "TA15", nome: "STEELPROFIL 13x55", materiale: "Acciaio", sezione: "13x55", prezzi: { unita: 75.00, legno: 76.50, raffaello: 77.50, primer: 65.00 } },
                TA20: { codice: "TA20", nome: "STEELPROFIL 9x40", materiale: "Acciaio", sezione: "9x40", prezzi: { unita: 109.00, legno: 118.00, raffaello: 120.00 }, max_l: 3200 },
                
                // PVC Estruso
                A01: { codice: "A01", nome: "ANTIGRANDINE 14x50", materiale: "PVC", sezione: "14x50", prezzi: { base: 46.20, speciali: 0.80 }, max_l: 2500 },
                A10: { codice: "A10", nome: "PESANTE 14x50", materiale: "PVC", sezione: "14x50", prezzi: { base: 39.70, speciali: 0.80 }, max_l: 2500 },
                A16: { codice: "A16", nome: "MINI 10 11x32", materiale: "PVC", sezione: "11x32", prezzi: { base: 54.40, speciali: 0.80 }, max_l: 2000 },
                A15: { codice: "A15", nome: "MINI 8 8x33", materiale: "PVC", sezione: "8x33", prezzi: { base: 48.30, speciali: 0.80 }, max_l: 1500 },
                
                // Alluminio Estruso Sicurezza
                TA10: { codice: "TA10", nome: "ALUBLIND 13x45", materiale: "Alluminio Sicurezza", sezione: "13x45", prezzi: { ral: 230.00, decoral: 306.00 }, max_l: 4000 },
                TA13: { codice: "TA13", nome: "ALUBLIND 9x27", materiale: "Alluminio Sicurezza", sezione: "9x27", prezzi: { ral: 250.00, decoral: 336.00 }, max_l: 3500 },
                
                // Termoisolanti COMBI
                A18: { codice: "A18", nome: "COMBI 13x53", materiale: "Termoisolante", sezione: "13x53", prezzi: { unita: 132.00, legno: 136.00 }, max_l: 4200 },
                A20: { codice: "A20", nome: "COMBI 10x39", materiale: "Termoisolante", sezione: "10x39", prezzi: { unita: 143.00, legno: 147.00 }, max_l: 2900 }
            },
            
            // Rinforzi PVC (â‚¬/mq)
            rinforzi: {
                E05: { min: 1250, max: 1730, prezzo: 5.80 },
                E10: { min: 1750, max: 2030, prezzo: 6.70 },
                E15: { min: 2050, max: 2430, prezzo: 7.90 },
                E20: { min: 2450, max: 2830, prezzo: 10.60 },
                E25: { min: 2850, max: 3230, prezzo: 13.20 },
                E30: { min: 3250, max: 3630, prezzo: 17.20 }
            },
            
            // Accessori
            accessori: {
                A30: { nome: "Imballo polietilene", prezzo: 3.50 },
                A24: { nome: "Imballo cartone", prezzo: 5.90 }
            },
            
            // Calcola prezzo telo
            calcolaPrezzo: function(codice, L_mm, H_mm, tipoColore = 'unita', coloreSpeciale = false, conRinforzi = false) {
                const telo = this.teli[codice];
                if (!telo) return { errore: `Codice ${codice} non trovato` };
                
                const L_m = L_mm / 1000;
                const H_m = H_mm / 1000;
                const mq = L_m * H_m;
                
                let prezzo_mq = telo.prezzi.base || telo.prezzi.ral || telo.prezzi[tipoColore] || telo.prezzi.unita;
                if (coloreSpeciale && telo.prezzi.speciali) prezzo_mq += telo.prezzi.speciali;
                
                let prezzo_telo = mq * prezzo_mq;
                let prezzo_rinforzi = 0;
                
                if (conRinforzi && telo.materiale === "PVC") {
                    for (const [cod, r] of Object.entries(this.rinforzi)) {
                        if (L_mm >= r.min && L_mm <= r.max) {
                            prezzo_rinforzi = mq * r.prezzo;
                            break;
                        }
                    }
                }
                
                const listino = prezzo_telo + prezzo_rinforzi;
                const netto = listino * (1 - this.info.sconto);
                
                return {
                    codice, modello: telo.nome, materiale: telo.materiale,
                    L_mm, H_mm, mq: Math.round(mq * 100) / 100,
                    prezzo_mq, prezzo_telo: Math.round(prezzo_telo * 100) / 100,
                    prezzo_rinforzi: Math.round(prezzo_rinforzi * 100) / 100,
                    listino: Math.round(listino * 100) / 100,
                    netto: Math.round(netto * 100) / 100,
                    sconto: this.info.sconto * 100
                };
            },
            
            // Lista modelli
            getModelli: function() {
                return Object.entries(this.teli).map(([cod, t]) => ({
                    codice: cod, nome: t.nome, materiale: t.materiale, prezzo_base: t.prezzi.base || t.prezzi.unita || t.prezzi.ral
                }));
            }
        };
        
        console.log('âœ… PLASTICINO_AVVOLGIBILI_2025 v1.0 - Database Tapparelle (18 modelli, rinforzi PVC, sconto 45%)');

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”§ PUNTO PERSIANE 2025 - Database Persiane 45/52 Collezione Infinita
        // Fonte: Listino prezzi 45/52 aggiornato 14/10/2025
        // Sconto installatore: 55%
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const PUNTO_PERSIANE_2025 = {
            info: { fornitore: "PUNTO PERSIANE", listino: "45/52", sconto: 0.55 },
            
            // Tipologie
            tipologie: {
                F1: { nome: "Finestra 1 anta", ante: 1 },
                F2: { nome: "Finestra 2 ante", ante: 2 },
                PF1: { nome: "Porta Finestra 1 anta", ante: 1 },
                PF2: { nome: "Porta Finestra 2 ante", ante: 2 }
            },
            
            // Modelli con maggiorazioni
            modelli: {
                // Stecca fissa tonda
                angela: { cat: "tonda", nome: "Angela", magg: 0.11 },
                giulia: { cat: "tonda", nome: "Giulia", magg: 0.15 },
                luna: { cat: "tonda", nome: "Luna", magg: 0.04 },
                // Stecca romboidale
                piemontese: { cat: "romboidale", nome: "Piemontese", magg: 0.04 },
                firenze: { cat: "romboidale", nome: "Firenze", magg: 0.04 },
                carolina: { cat: "romboidale", nome: "Carolina", magg: 0.11 },
                storica: { cat: "romboidale", nome: "Storica", magg: 0.34 },
                camelia: { cat: "romboidale", nome: "Camelia", magg: 0.29 },
                // Orientabili
                aurora: { cat: "orientabile", nome: "Aurora", magg: 0.17 },
                alice: { cat: "orientabile", nome: "Alice", magg: 0.17 },
                // Cieche e dogate
                nerina: { cat: "cieca", nome: "Nerina", magg: 0.04 },
                nerina_r: { cat: "cieca", nome: "Nerina [R]", magg: 0.225 },
                canazei: { cat: "cieca", nome: "Canazei", magg: 0.17 },
                alto_adige: { cat: "cieca", nome: "Alto Adige", magg: 0.33 },
                alto_adige_r: { cat: "cieca", nome: "Alto Adige [R]", magg: 0.39 },
                cortina: { cat: "cieca", nome: "Cortina", magg: 0.39 },
                cortina_r: { cat: "cieca", nome: "Cortina [R]", magg: 0.44 },
                diamante: { cat: "cieca", nome: "Diamante", magg: 0.34 }
            },
            
            // Categorie colore
            colori: {
                cat_01: { nome: "Standard", magg: 0 },
                cat_02a: { nome: "Opachi extra", magg: 0.03 },
                cat_02b: { nome: "Textured", magg: 0.05 },
                cat_03: { nome: "Legno EZY", magg: 0.20 },
                cat_04: { nome: "Legno Ã‰lite", magg: 0.25 },
                cat_05: { nome: "Legno Electo", magg: 0.25 },
                cat_06: { nome: "Legno sublimato", magg: 0.30 },
                cat_07: { nome: "Legno speciale", magg: 0.30 }
            },
            
            // Griglie prezzi base F1 (â‚¬)
            griglie_F1: {
                L: [500, 600, 700, 800, 900, 1000, 1100, 1200],
                H: [700, 800, 900, 1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000],
                P: [
                    [257, 282, 306, 317, 326, 335, 350, 366],
                    [275, 294, 314, 327, 338, 349, 365, 381],
                    [291, 306, 323, 337, 350, 364, 379, 395],
                    [307, 319, 329, 347, 363, 378, 395, 411],
                    [307, 327, 346, 363, 379, 397, 415, 434],
                    [320, 338, 356, 377, 391, 409, 426, 444],
                    [330, 350, 370, 388, 408, 427, 448, 470],
                    [337, 359, 379, 400, 422, 443, 460, 478],
                    [349, 371, 395, 417, 437, 459, 480, 501],
                    [355, 379, 403, 426, 448, 473, 496, 520],
                    [371, 395, 418, 444, 468, 493, 517, 543],
                    [384, 410, 435, 462, 488, 512, 539, 567],
                    [397, 426, 455, 480, 507, 530, 562, 592],
                    [411, 443, 473, 500, 527, 550, 586, 616]
                ]
            },
            
            // Griglie prezzi base F2 (â‚¬)
            griglie_F2: {
                L: [800, 900, 1000, 1100, 1200, 1300, 1400, 1500],
                H: [700, 800, 900, 1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000],
                P: [
                    [489, 500, 509, 520, 534, 548, 557, 572],
                    [502, 514, 525, 537, 552, 566, 576, 592],
                    [515, 527, 541, 554, 569, 586, 597, 613],
                    [527, 542, 557, 572, 588, 605, 616, 635],
                    [545, 562, 578, 593, 613, 631, 648, 662],
                    [562, 577, 593, 613, 632, 651, 667, 686],
                    [575, 595, 614, 636, 658, 679, 695, 715],
                    [592, 613, 635, 656, 679, 697, 716, 740],
                    [610, 633, 656, 680, 700, 722, 745, 770],
                    [628, 652, 677, 702, 725, 749, 773, 798],
                    [648, 674, 700, 726, 751, 777, 803, 830],
                    [670, 698, 726, 753, 780, 808, 836, 865],
                    [694, 724, 754, 783, 812, 842, 872, 903],
                    [720, 752, 784, 815, 846, 878, 910, 943]
                ]
            },
            
            // Telai
            telai: {
                TH40: {
                    L: [[400,699], [700,999], [1000,1299], [1300,1599], [1600,1999], [2000,2399], [2400,3000]],
                    H: [[700,1399], [1400,1899], [1900,2299], [2300,2700]],
                    P: [
                        [116, 123, 136, 145, 162, 172, 186],
                        [146, 152, 167, 174, 191, 201, 215],
                        [174, 181, 198, 202, 214, 224, 237],
                        [196, 202, 220, 228, 235, 258, 260]
                    ]
                },
                TH45: {
                    L: [[400,699], [700,999], [1000,1299], [1300,1599], [1600,1999], [2000,2399], [2400,3000]],
                    H: [[700,1399], [1400,1899], [1900,2299], [2300,2700]],
                    P: [
                        [65, 67, 71, 74, 84, 87, 92],
                        [76, 79, 85, 86, 95, 98, 105],
                        [90, 92, 93, 98, 102, 109, 114],
                        [98, 100, 107, 108, 113, 119, 123]
                    ]
                }
            },
            
            // Trova prezzo in griglia
            trovaPrezzoGriglia: function(tipo, L_mm, H_mm) {
                const g = tipo === 'F1' ? this.griglie_F1 : this.griglie_F2;
                let idxL = g.L.findIndex(l => L_mm <= l);
                if (idxL === -1) idxL = g.L.length - 1;
                let idxH = g.H.findIndex(h => H_mm <= h);
                if (idxH === -1) idxH = g.H.length - 1;
                return { prezzo: g.P[idxH][idxL], L_grid: g.L[idxL], H_grid: g.H[idxH] };
            },
            
            // Trova prezzo telaio
            trovaPrezzoTelaio: function(tipo, L_mm, H_mm) {
                const t = this.telai[tipo];
                if (!t) return 0;
                let idxL = t.L.findIndex(([min, max]) => L_mm >= min && L_mm <= max);
                if (idxL === -1) idxL = t.L.length - 1;
                let idxH = t.H.findIndex(([min, max]) => H_mm >= min && H_mm <= max);
                if (idxH === -1) idxH = t.H.length - 1;
                return t.P[idxH][idxL];
            },
            
            // Calcola prezzo completo
            calcolaPrezzo: function(tipologia, modello, L_mm, H_mm, colore = 'cat_01', telaio = null) {
                const mod = this.modelli[modello] || { magg: 0, nome: 'Base' };
                const col = this.colori[colore] || { magg: 0 };
                
                // Prezzo griglia
                const griglia = this.trovaPrezzoGriglia(tipologia, L_mm, H_mm);
                
                // Prezzo base con modello
                let prezzoBase = griglia.prezzo * (1 + mod.magg);
                
                // Telaio
                let prezzoTelaio = telaio ? this.trovaPrezzoTelaio(telaio, L_mm, H_mm) : 0;
                
                // Totale con colore
                let listino = (prezzoBase + prezzoTelaio) * (1 + col.magg);
                
                // Netto con sconto
                let netto = listino * (1 - this.info.sconto);
                
                return {
                    tipologia, modello: mod.nome, dimensioni: `${L_mm}x${H_mm}`,
                    griglia: griglia.prezzo, magg_modello: `+${(mod.magg*100).toFixed(0)}%`,
                    telaio: prezzoTelaio, magg_colore: `+${(col.magg*100).toFixed(0)}%`,
                    listino: Math.round(listino * 100) / 100,
                    sconto: '55%',
                    netto: Math.round(netto * 100) / 100
                };
            },
            
            // Lista modelli
            getModelli: function() {
                return Object.entries(this.modelli).map(([k, m]) => ({
                    codice: k, nome: m.nome, categoria: m.cat, maggiorazione: `+${(m.magg*100).toFixed(0)}%`
                }));
            }
        };
        
        console.log('âœ… PUNTO_PERSIANE_2025 v1.0 - Database Persiane (4 categorie, 18 modelli, sconto 55%)');

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”§ OIKOS EVO 2025 - Database Porte Blindate
        // Fonte: Listino EVO 2025 (Settembre 2025)
        // Sconto installatore: 40% + 10% = 46% effettivo
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const OIKOS_BLINDATE_2025 = {
            info: { fornitore: "OIKOS VENEZIA srl", listino: "EVO 2025", sconto: 0.46 },
            
            // Dimensioni LUCI (mm)
            luci: {
                0: { max_L: 900, max_H: 2100 },
                1: { max_L: 940, max_H: 2210 },
                2: { max_L: 1030, max_H: 2400 },
                3: { max_L: 1100, max_H: 2400 },
                4: { max_L: 1200, max_H: 2400 },
                5: { max_L: 1000, max_H: 2700 },
                6: { max_L: 1000, max_H: 3000 }
            },
            
            // Prezzi base porta (â‚¬)
            porte: {
                evolution_3: {
                    nome: "Evolution 3", classe: 3, punti: 9,
                    prezzi: { 0: 1156, 1: 1206, 2: 1441 }
                },
                evolution_4: {
                    nome: "Evolution 4", classe: 4, punti: 8,
                    prezzi: { 0: 1436, 1: 1486, 2: 1721 }
                },
                project: {
                    nome: "Project", classe: 3, punti: 5,
                    prezzi: { 0: 1173, 1: 1293, 2: 1480 }
                },
                tekno: {
                    nome: "Tekno", classe: 3, punti: 6,
                    prezzi: { 0: 1505, 1: 1655, 2: 1974, 5: 2353, 6: 2614 }
                }
            },
            
            // Rivestimenti (â‚¬ per lato)
            rivestimenti: {
                piano_tanganica: { linea: "Piano", nome: "Tanganica 1-2 / Mogano 2-3", prezzi: { 0: 192, 1: 192, 2: 235, 3: 346, 4: 414 } },
                piano_laccato: { linea: "Piano", nome: "Laccato Bianco OIKOS", prezzi: { 0: 130, 1: 145, 2: 179, 3: 284, 4: 358 } },
                piano_rovere: { linea: "Piano", nome: "Rovere 1", prezzi: { 0: 242, 1: 242, 2: 298, 3: 408, 4: 510 } },
                piano_noce: { linea: "Piano", nome: "Noce Nazionale 2", prezzi: { 0: 276, 1: 276, 2: 340, 3: 459, 4: 573 } },
                piano_bianco_talco: { linea: "Piano", nome: "Bianco/Grigio Talco", prezzi: { 0: 170, 1: 170, 2: 170 } },
                mdf_laccare: { linea: "Piano", nome: "MDF da laccare", prezzi: { 0: 114, 1: 117, 2: 127, 3: 192, 4: 192 } }
            },
            
            // Colori telaio/allumini (â‚¬)
            colori_telaio: {
                ral_8022: { nome: "RAL 8022 (standard)", prezzo: 0 },
                oikos_polveri: { nome: "Colori OIKOS a Polveri", prezzo: 246 },
                oikos_evergreen: { nome: "Colori OIKOS Evergreen", prezzo: 320 },
                oikos_future: { nome: "Colori OIKOS Future", prezzo: 384 },
                oikos_liquido: { nome: "Colori OIKOS a Liquido", prezzo: 492 }
            },
            
            // Accessori (â‚¬)
            accessori: {
                cilindro_sekur: { nome: "Cilindro SEKUR", prezzo: 238 },
                cilindro_basic: { nome: "Cilindro BASIC", prezzo: 123 },
                telaio_tt: { nome: "Telaio Taglio Termico", prezzi: { 0: 177, 1: 202, 2: 240 } },
                maniglia_ottone: { nome: "Maniglia interna ottone", prezzo: 0 },
                pomolo_ottone: { nome: "Pomolo esterno ottone", prezzo: 0 },
                spioncino_ottone: { nome: "Spioncino ottone", prezzo: 0 }
            },
            
            // Trova luce per dimensioni
            trovaLuce: function(L_mm, H_mm) {
                for (let i = 0; i <= 6; i++) {
                    const luce = this.luci[i];
                    if (luce && L_mm <= luce.max_L && H_mm <= luce.max_H) return i;
                }
                return null;
            },
            
            // Calcola prezzo completo
            calcolaPrezzo: function(modello, L_mm, H_mm, riv_int = null, riv_est = null, colore_telaio = 'ral_8022', accessori = []) {
                const porta = this.porte[modello];
                if (!porta) return { errore: `Modello ${modello} non trovato` };
                
                const luce = this.trovaLuce(L_mm, H_mm);
                if (luce === null) return { errore: `Dimensioni ${L_mm}x${H_mm} fuori range` };
                
                const prezzo_porta = porta.prezzi[luce];
                if (!prezzo_porta) return { errore: `Luce ${luce} non disponibile per ${porta.nome}` };
                
                // Rivestimenti
                let prezzo_riv = 0;
                if (riv_int && this.rivestimenti[riv_int]) {
                    prezzo_riv += this.rivestimenti[riv_int].prezzi[luce] || 0;
                }
                if (riv_est && this.rivestimenti[riv_est]) {
                    prezzo_riv += this.rivestimenti[riv_est].prezzi[luce] || 0;
                }
                
                // Colore telaio
                const prezzo_colore = this.colori_telaio[colore_telaio]?.prezzo || 0;
                
                // Accessori
                let prezzo_acc = 0;
                accessori.forEach(acc => {
                    const a = this.accessori[acc];
                    if (a) prezzo_acc += a.prezzo || (a.prezzi ? a.prezzi[luce] : 0) || 0;
                });
                
                const listino = prezzo_porta + prezzo_riv + prezzo_colore + prezzo_acc;
                const netto = listino * (1 - this.info.sconto);
                
                return {
                    modello: porta.nome, classe: porta.classe,
                    dimensioni: `${L_mm}x${H_mm}`, luce: luce,
                    prezzo_porta, prezzo_riv, prezzo_colore, prezzo_acc,
                    listino: Math.round(listino * 100) / 100,
                    sconto: '46%',
                    netto: Math.round(netto * 100) / 100
                };
            },
            
            // Lista modelli
            getModelli: function() {
                return Object.entries(this.porte).map(([k, p]) => ({
                    codice: k, nome: p.nome, classe: p.classe, punti: p.punti
                }));
            }
        };
        
        console.log('âœ… OIKOS_BLINDATE_2025 v1.0 - Database Porte Blindate (4 linee, 6 luci, sconto 46%)');

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”§ COSTI LAVORO 2025 - Posa, Smontaggio, Smaltimento, Componenti
        // Fonte: COSTI-LAVORO-2025.md
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const COSTI_LAVORO = {
            // POSA IN OPERA (â‚¬/pezzo)
            posa: {
                finestra: 200,
                portafinestra: 250,
                scorrevole: 300,
                portoncino: 350,
                blindata: 350,
                persiana: 80,
                tapparella: 120,      // Completa
                cassonetto: 80,
                zanzariera: 40,
                motore: 60
            },
            // SMONTAGGIO (â‚¬/pezzo)
            smontaggio: {
                finestra: 40,
                portafinestra: 60,
                scorrevole: 80,
                portoncino: 100,
                blindata: 100,
                persiana: 30,
                tapparella: 40,
                cassonetto: 50,
                zanzariera: 0,
                motore: 0
            },
            // SMALTIMENTO (â‚¬/pezzo)
            smaltimento: {
                finestra: 30,
                portafinestra: 50,
                scorrevole: 70,
                portoncino: 80,
                blindata: 80,
                persiana: 25,
                tapparella: 20,
                cassonetto: 30,
                zanzariera: 0,
                motore: 0
            },
            // COMPONENTI POSA (â‚¬/pezzo)
            componenti: {
                finestra: 35,
                portafinestra: 45,
                scorrevole: 60,
                portoncino: 50,
                blindata: 50,
                persiana: 15,
                tapparella: 20,
                cassonetto: 15,
                zanzariera: 10,
                motore: 5
            },
            
            // Determina tipo prodotto da stringa
            getTipoProdotto: function(tipoStr) {
                if (!tipoStr) return 'finestra';
                const t = tipoStr.toLowerCase();
                if (t.includes('portafinestra') || t.includes('porta-finestra') || t.includes('porta finestra')) return 'portafinestra';
                if (t.includes('scorrevole') || t.includes('alzante')) return 'scorrevole';
                if (t.includes('portoncino')) return 'portoncino';
                if (t.includes('blindat')) return 'blindata';
                if (t.includes('persiana')) return 'persiana';
                if (t.includes('tapparella')) return 'tapparella';
                if (t.includes('cassonetto')) return 'cassonetto';
                if (t.includes('zanzariera')) return 'zanzariera';
                if (t.includes('motore')) return 'motore';
                if (t.includes('finestra')) return 'finestra';
                return 'finestra'; // default
            },
            
            // Calcola costi per singolo prodotto
            calcolaCosti: function(tipoStr, quantita = 1) {
                const tipo = this.getTipoProdotto(tipoStr);
                return {
                    tipo: tipo,
                    posa: (this.posa[tipo] || 0) * quantita,
                    smontaggio: (this.smontaggio[tipo] || 0) * quantita,
                    smaltimento: (this.smaltimento[tipo] || 0) * quantita,
                    componenti: (this.componenti[tipo] || 0) * quantita,
                    quantita: quantita
                };
            },
            
            // Calcola totali da array di righe preventivo
            calcolaTotaliDaRighe: function(righe) {
                let totPosa = 0, totSmontaggio = 0, totSmaltimento = 0, totComponenti = 0;
                const dettaglio = [];
                
                righe.forEach(riga => {
                    const costi = this.calcolaCosti(riga.tipo, riga.quantita || 1);
                    totPosa += costi.posa;
                    totSmontaggio += costi.smontaggio;
                    totSmaltimento += costi.smaltimento;
                    totComponenti += costi.componenti;
                    dettaglio.push({
                        posizione: riga.posizione,
                        tipo: riga.tipo,
                        tipoNorm: costi.tipo,
                        quantita: costi.quantita,
                        posa: costi.posa,
                        smontaggio: costi.smontaggio,
                        smaltimento: costi.smaltimento,
                        componenti: costi.componenti
                    });
                });
                
                return {
                    posa: totPosa,
                    smontaggio: totSmontaggio,
                    smaltimento: totSmaltimento,
                    componenti: totComponenti,
                    totale: totPosa + totSmontaggio + totSmaltimento + totComponenti,
                    dettaglio: dettaglio
                };
            }
        };
        
        console.log('âœ… COSTI_LAVORO v8.15 - Posa/Smontaggio/Smaltimento/Componenti configurati');

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ“¦ FUNZIONE CALCOLO PREZZO CASSONETTO FINSTRAL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function calcolaPrezzoCassonettoFinstral(config) {
            const risultato = {
                success: false,
                prezzo: 0,
                dettaglio: {
                    prezzoBase: 0,
                    supplementoIsolamento: 0,
                    numeroIsolamenti: 0
                },
                parametri: {},
                errori: []
            };
            
            try {
                // Estrai parametri
                const L = parseInt(config.L) || parseInt(config.BRM_L) || 0;  // Larghezza mm
                const A = parseInt(config.A) || parseInt(config.BRM_H) || parseInt(config.HCASS) || 0;  // Altezza mm
                const B = parseInt(config.B) || parseInt(config.BRM_B) || 0;  // ProfonditÃ  mm
                const materiale = (config.materialeCass || config.materiale || 'PVC').toUpperCase();
                const gruppoColore = config.gruppoColoreCass || config.gruppoColore || 'bianco';
                const codiceIsolamento = config.codiceIsolamento || null;
                
                risultato.parametri = { L, A, B, materiale, gruppoColore, codiceIsolamento };
                
                // Validazione
                if (L <= 0) { risultato.errori.push('Larghezza L non valida'); return risultato; }
                if (A <= 0) { risultato.errori.push('Altezza A non valida'); return risultato; }
                
                // Determina codice cassonetto in base a B e materiale
                let codiceCass = config.codiceCass || '';
                if (!codiceCass) {
                    if (materiale === 'LEGNO') {
                        codiceCass = (B > 335) ? '9-48B' : '9-48';
                    } else {
                        // PVC: scegli tra 148 e 300 in base a B
                        if (B <= 148) {
                            codiceCass = '148';
                        } else if (B <= 300) {
                            codiceCass = '300';
                        } else {
                            // B > 300 â†’ versione B
                            codiceCass = (B <= 148 + 200) ? '148B' : '300B';
                        }
                    }
                }
                risultato.parametri.codiceCass = codiceCass;
                
                // Seleziona tabella prezzi
                let tabella = null;
                let colonnaColore = '';
                
                if (materiale === 'LEGNO') {
                    tabella = codiceCass.includes('B') ? FINSTRAL_CASSONETTI_PREZZI.legno_948B : FINSTRAL_CASSONETTI_PREZZI.legno_948;
                    colonnaColore = (gruppoColore === 'legno2+3' || gruppoColore === 'gruppo23' || gruppoColore === 'gruppo2+3') ? 'gruppo23' : 'gruppo1';
                } else {
                    // PVC
                    if (codiceCass === '148B') tabella = FINSTRAL_CASSONETTI_PREZZI.pvc_148B;
                    else if (codiceCass === '300') tabella = FINSTRAL_CASSONETTI_PREZZI.pvc_300;
                    else if (codiceCass === '300B') tabella = FINSTRAL_CASSONETTI_PREZZI.pvc_300B;
                    else tabella = FINSTRAL_CASSONETTI_PREZZI.pvc_148;
                    colonnaColore = (gruppoColore === 'scuri' || gruppoColore.includes('scur')) ? 'scuri' : 'bianco';
                }
                
                risultato.parametri.tabella = tabella.codice;
                risultato.parametri.colonnaColore = colonnaColore;
                
                // Verifica limite larghezza
                if (L > tabella.maxL) {
                    risultato.errori.push(`Larghezza ${L}mm supera max ${tabella.maxL}mm per ${tabella.codice}`);
                    return risultato;
                }
                
                // Trova indice colonna L (arrotondamento alla casella superiore)
                let idxL = tabella.colonneL.findIndex(col => L <= col);
                if (idxL === -1) idxL = tabella.colonneL.length - 1;
                
                // Trova indice riga A (arrotondamento alla casella superiore)
                let idxA = tabella.righeA.findIndex(row => A <= row);
                if (idxA === -1) idxA = tabella.righeA.length - 1;
                
                risultato.parametri.idxL = idxL;
                risultato.parametri.idxA = idxA;
                risultato.parametri.LArrotondato = tabella.colonneL[idxL];
                risultato.parametri.AArrotondato = tabella.righeA[idxA];
                
                // Ottieni prezzo dalla matrice
                const matricePrezzi = tabella[colonnaColore];
                if (!matricePrezzi || !matricePrezzi[idxA] || matricePrezzi[idxA][idxL] === undefined) {
                    risultato.errori.push('Prezzo non trovato nella griglia');
                    return risultato;
                }
                
                const prezzoBase = matricePrezzi[idxA][idxL];
                risultato.dettaglio.prezzoBase = prezzoBase;
                
                // Supplemento isolamento
                let supplementoIsolamento = 0;
                let numeroIsolamenti = 0;
                if (codiceIsolamento && FINSTRAL_CASSONETTI_PREZZI.isolamento[codiceIsolamento]) {
                    const iso = FINSTRAL_CASSONETTI_PREZZI.isolamento[codiceIsolamento];
                    // Se L > 1000mm servono piÃ¹ pezzi
                    numeroIsolamenti = Math.ceil(L / 1000);
                    supplementoIsolamento = iso.prezzo * numeroIsolamenti;
                    risultato.dettaglio.supplementoIsolamento = supplementoIsolamento;
                    risultato.dettaglio.numeroIsolamenti = numeroIsolamenti;
                    risultato.dettaglio.codiceIsolamento = codiceIsolamento;
                    risultato.dettaglio.spessoreIsolamento = iso.spessore;
                }
                
                // Totale
                risultato.prezzo = Math.round((prezzoBase + supplementoIsolamento) * 100) / 100;
                risultato.success = true;
                
                console.log('ğŸ“¦ Calcolo cassonetto Finstral:', risultato);
                return risultato;
                
            } catch (e) {
                risultato.errori.push('Errore calcolo: ' + e.message);
                console.error('âŒ Errore calcolaPrezzoCassonettoFinstral:', e);
                return risultato;
            }
        }

        // âœ… v7.73: FUNZIONE MAPPING COLORE TESTO â†’ CODICE FINSTRAL
        function mappaColoreACodiceFinstral(coloreInput, tipo = 'pvc') {
            if (!coloreInput) return tipo === 'pvc' ? '01' : 'M01'; // Default bianco
            
            const colore = coloreInput.toLowerCase().trim();
            
            // 1. Cerca match esatto in coloriComuni
            for (const [nome, dati] of Object.entries(FINSTRAL_PREZZI.coloriComuni)) {
                if (colore === nome.toLowerCase() || colore.includes(nome.toLowerCase())) {
                    return tipo === 'pvc' ? (dati.pvc || '01') : (dati.alluminio || 'M01');
                }
            }
            
            // 2. Pattern matching per codici RAL
            const ralMatch = colore.match(/ral\s*(\d{4})/i);
            if (ralMatch) {
                return tipo === 'pvc' ? '01' : 'RAL'; // Alluminio gruppo 2
            }
            
            // 3. Pattern matching per codici diretti Finstral (es. "F716", "L19", "M01")
            const codiceMatch = colore.match(/^([FLM]\d+|G\d+|LC\d+)/i);
            if (codiceMatch) {
                return codiceMatch[1].toUpperCase();
            }
            
            // âœ… v7.79: Pattern per codici PVC numerici (es. "45 - Bianco", "06 - Grigio")
            const codicePVCMatch = colore.match(/^(\d{2})\s*[-â€“]/);
            if (codicePVCMatch && tipo === 'pvc') {
                return codicePVCMatch[1];  // Restituisce "45", "06", "01", ecc.
            }
            
            // 4. Pattern matching per colori comuni
            if (colore.includes('bianco') || colore.includes('white')) {
                return tipo === 'pvc' ? '01' : 'M01';
            }
            if (colore.includes('grigio') || colore.includes('grey') || colore.includes('gray')) {
                if (colore.includes('antracite') || colore.includes('scuro')) {
                    return tipo === 'pvc' ? '46' : 'F716';
                }
                return tipo === 'pvc' ? '46' : 'F744'; // grigio seta
            }
            if (colore.includes('nero') || colore.includes('black')) {
                return tipo === 'pvc' ? '06' : 'F905';
            }
            if (colore.includes('castagno') || colore.includes('marrone')) {
                return tipo === 'pvc' ? '13' : 'L13';
            }
            if (colore.includes('rovere') || colore.includes('oak')) {
                return tipo === 'pvc' ? '19' : 'L19';
            }
            if (colore.includes('noce')) {
                return tipo === 'pvc' ? '55' : 'L55';
            }
            
            // 5. Default
            return tipo === 'pvc' ? '01' : 'M01';
        }

        // âœ… v7.73: Determina gruppo colore PVC (A o B)
        function getGruppoColorePVC(codicePVC) {
            if (FINSTRAL_PREZZI.supplementiColorePVC.gruppoA.includes(codicePVC)) return 'A';
            if (FINSTRAL_PREZZI.supplementiColorePVC.gruppoB.includes(codicePVC)) return 'B';
            return 'A'; // Default
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // âœ… v7.77: FUNZIONI HELPER FERRAMENTA / APERTURE / CERNIERE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        /**
         * Ottiene codice ferramenta completo per tipo apertura
         * @param {string} tipoApertura - AR, A, R, FX, VA, SP, SPR, PFS
         * @param {boolean} cerniereScomparsa - true = scomparsa (2xx), false = vista (4xx)
         * @returns {object} - { codice, nome, minL, minH }
         */
        function getCodiceApertura(tipoApertura, cerniereScomparsa = false) {
            const apertura = FINSTRAL_PREZZI.tipiApertura[tipoApertura];
            if (!apertura) {
                console.warn(`âš ï¸ Tipo apertura non trovato: ${tipoApertura}`);
                return { codice: "411.0", nome: "Anta/Ribalta", minL: 350, minH: 325 };
            }
            
            const codice = cerniereScomparsa && apertura.codiceScomparsa 
                ? apertura.codiceScomparsa 
                : apertura.codiceVista;
            
            return {
                codice: codice,
                nome: apertura.nome,
                minL: apertura.minL,
                minH: apertura.minH,
                hasCerniereScomparsa: !!apertura.codiceScomparsa
            };
        }

        /**
         * Formatta label tipo apertura per UI
         * @param {string} codice - AR, A, R, FX, VA, SP, SPR, PFS
         * @returns {string} - label leggibile
         */
        function formatTipoApertura(codice) {
            const labels = {
                'AR': 'Anta/Ribalta',
                'A': 'Solo Anta',
                'R': 'Solo Ribalta',
                'FX': 'Fisso',
                'VA': 'Vasistas',
                'SP': 'Scorrevole',
                'SPR': 'Scorr. Ribalta',
                'PFS': 'Porta-Fin. Ser.'
            };
            return labels[codice] || codice;
        }

        /**
         * Calcola supplemento cerniere a scomparsa
         * @param {string} tipoApertura - AR, A, R, FX, VA, PFS
         * @param {number} numAnte - numero ante (default 1)
         * @returns {number} - supplemento in â‚¬
         */
        function getSupplementoCerniereScomparsa(tipoApertura, numAnte = 1) {
            const suppl = FINSTRAL_PREZZI.supplementiCerniere[tipoApertura];
            if (!suppl) return 0;
            return suppl * numAnte;
        }

        /**
         * Calcola supplemento totale ferramenta
         * @param {object} config - { tipoApertura, cerniereScomparsa, sicurezza[], aerazione, comfort[], rc2 }
         * @returns {object} - { totale, dettaglio }
         */
        function calcolaSupplementoFerramenta(config) {
            let totale = 0;
            const dettaglio = [];

            // Cerniere scomparsa
            if (config.cerniereScomparsa && config.tipoApertura) {
                const suppl = getSupplementoCerniereScomparsa(config.tipoApertura, config.numAnte || 1);
                if (suppl > 0) {
                    totale += suppl;
                    dettaglio.push({ tipo: 'Cerniere scomparsa', importo: suppl });
                }
            }

            // Sicurezza
            if (config.sicurezza && Array.isArray(config.sicurezza)) {
                config.sicurezza.forEach(s => {
                    const suppl = FINSTRAL_PREZZI.supplementiSicurezza[s] || 0;
                    if (suppl > 0) {
                        totale += suppl;
                        dettaglio.push({ tipo: `Sicurezza ${s}`, importo: suppl });
                    }
                });
            }

            // Aerazione
            if (config.aerazione) {
                const suppl = FINSTRAL_PREZZI.supplementiAerazione[config.aerazione] || 0;
                if (suppl > 0) {
                    totale += suppl;
                    dettaglio.push({ tipo: `Aerazione ${config.aerazione}`, importo: suppl });
                }
            }

            // Comfort
            if (config.comfort && Array.isArray(config.comfort)) {
                config.comfort.forEach(c => {
                    const suppl = FINSTRAL_PREZZI.supplementiComfort[c] || 0;
                    if (suppl > 0) {
                        totale += suppl;
                        dettaglio.push({ tipo: `Comfort ${c}`, importo: suppl });
                    }
                });
            }

            // RC2
            if (config.rc2) {
                const tipoAnta = (config.tipoAnta || '').toLowerCase();
                const supplRC2 = tipoAnta.includes('nova') 
                    ? FINSTRAL_PREZZI.rc2.supplemento['nova-line']
                    : FINSTRAL_PREZZI.rc2.supplemento['altri'];
                totale += supplRC2;
                dettaglio.push({ tipo: 'RC2 Antieffrazione', importo: supplRC2 });
            }

            console.log(`ğŸ”© Supplemento ferramenta: â‚¬${totale.toFixed(2)}`, dettaglio);
            return { totale, dettaglio };
        }

        /**
         * Verifica compatibilitÃ  RC2 per telaio
         * @param {string} telaio - codice telaio (961, 967, etc.)
         * @returns {boolean}
         */
        function isTelaioRC2Compatibile(telaio) {
            return FINSTRAL_PREZZI.rc2.telaiCompatibili.includes(telaio);
        }

        /**
         * Verifica misure minime per tipo apertura
         * @param {string} tipoApertura 
         * @param {number} larghezza - mm
         * @param {number} altezza - mm
         * @returns {boolean}
         */
        function verificaMisureMinime(tipoApertura, larghezza, altezza) {
            const apertura = FINSTRAL_PREZZI.tipiApertura[tipoApertura];
            if (!apertura) return true; // Non verificabile
            return larghezza >= apertura.minL && altezza >= apertura.minH;
        }

        console.log('ğŸ”© Helper ferramenta caricati: getCodiceApertura, getSupplementoCerniereScomparsa, calcolaSupplementoFerramenta');

        // ============================================================================
        // RENDER VISTA PREVENTIVO - v7.24
        // ============================================================================

        function renderVistaPreventivo(data) {
            console.log('ğŸ’° Rendering Vista Preventivo...');
            
            // Nascondi placeholder, mostra contenuto
            document.getElementById('preventivoPlaceholder').classList.add('content-hidden');
            document.getElementById('preventivoContent').classList.remove('content-hidden');
            
            // Calcola preventivo
            const preventivo = calcolaPreventivo(data);
            
            // Popola tabella
            popolaTabellaPreventivo(preventivo);
            
            console.log('âœ… Vista Preventivo rendered');
        }

        function calcolaPreventivo(data) {
            console.log('ğŸ’° calcolaPreventivo() chiamata con data:', data);
            console.log('ğŸ“Š Numero posizioni:', (data.positions || data.posizioni || []).length);
            
            const righe = [];
            let totaleMateriali = 0;
            let numeroPezzi = 0;
            
            // GESTISCI ENTRAMBE LE STRUTTURE: positions (app) e posizioni (vecchio)
            const posizioni = data.positions || data.posizioni || [];
            
            console.log('ğŸ” Struttura posizioni:', posizioni.length > 0 ? 'OK' : 'VUOTA');
            console.log('ğŸ” Array righe PRIMA forEach:', righe.length);
            
            // Processa ogni posizione
            posizioni.forEach((pos, index) => {
                // ğŸ” v7.98_07: NORMALIZZA BLINDATA da ingresso.blindata se non giÃ  presente
                if (pos.ingresso?.blindata && !pos.blindata) {
                    pos.blindata = pos.ingresso.blindata;
                    console.log(`   ğŸ” NORMALIZZATO pos ${index + 1}: ingresso.blindata â†’ blindata`);
                }
                
                // ğŸ” DEBUG BLINDATA
                console.log(`ğŸ” Pos ${index + 1} blindata:`, pos.blindata);
                
                // Processa INFISSI
                if (pos.infisso && pos.infisso.qta > 0) {
                    const infisso = pos.infisso;
                    
                    // LEGGI MISURE BRM (con fallback a misure LVT/HVT)
                    let L_mm = infisso.BRM_L || infisso.brm?.L;
                    let H_mm = infisso.BRM_H || infisso.brm?.H;
                    
                    // FALLBACK: Se BRM null, usa misure LVT/HVT
                    if (!L_mm && pos.misure?.LVT) {
                        L_mm = parseInt(pos.misure.LVT);
                        console.warn(`âš ï¸ Pos ${index + 1}: BRM_L null, uso LVT=${L_mm}`);
                    }
                    if (!H_mm && pos.misure?.HVT) {
                        H_mm = parseInt(pos.misure.HVT);
                        console.warn(`âš ï¸ Pos ${index + 1}: BRM_H null, uso HVT=${H_mm}`);
                    }
                    
                    if (L_mm && H_mm) {
                        // âœ… v7.55: Log tipo e tipoAnta infissi
                        const numAnteInfisso = estraiNumeroAnte(infisso.tipo);
                        console.log(`ğŸªŸ Infisso tipo="${infisso.tipo || 'N/D'}" â†’ ${numAnteInfisso} ante`);
                        console.log(`ğŸšª Tipo Anta: "${infisso.tipoAnta || data.configInfissi?.tipoAnta || 'step-line'}"`);
                        
                        // Calcola perimetro BRM
                        const perimetro_ml = calcolaPerimetroBRM(L_mm, H_mm);
                        const superficie_mq = (L_mm * H_mm) / 1000000;
                        
                        // Ottieni telaio (da configurazione o da infisso)
                        const telaio = infisso.telaio || 
                                       data.configInfissi?.telaio || 
                                       '961';
                        
                        // Determina colore (per supplemento)
                        const coloreEsterno = infisso.coloreEst || 
                                             infisso.coloreEsterno || 
                                             data.configInfissi?.coloreEst ||
                                             data.configInfissi?.coloreEsterno || 
                                             '';
                        const coloreInterno = infisso.coloreInt || 
                                             infisso.coloreInterno || 
                                             data.configInfissi?.coloreInt ||
                                             data.configInfissi?.coloreInterno || 
                                             '';
                        const coloreScuro = isColoreScuro(coloreEsterno);
                        
                        // âœ… v7.73: Estrai tipo anta per calcolo colore
                        const tipoAnta = infisso.tipoAnta || data.configInfissi?.tipoAnta || 'step-line';
                        
                        // âœ… v7.63: CALCOLO FINSTRAL - Mappa tipo infisso a tipo Finstral
                        const apertura = infisso.apertura || infisso.tipo || 'battente';
                        const tipoInfisso = (infisso.tipo || '').toLowerCase();
                        
                        let tipoFinstral = "101"; // Default: 1 anta
                        if (tipoInfisso.includes('fisso') || tipoInfisso.includes('f0') || apertura.includes('fisso')) {
                            tipoFinstral = "102";
                        } else if (tipoInfisso.includes('2') || apertura.includes('2') || tipoInfisso.includes('p2')) {
                            tipoFinstral = "401";
                        }
                        
                        // Determina materiale
                        // âœ… v7.73 FIX: Usa finituraEst per determinare se esterno Ã¨ alluminio
                        const finituraEstInfisso = infisso.finituraEst || infisso.finitura_est || '';
                        const finituraEstConfig = data.configInfissi?.finituraEst || data.configInfissi?.finitura_est || '';
                        const finituraEst = (finituraEstInfisso || finituraEstConfig || '').toLowerCase();
                        const materiale = finituraEst.includes('alluminio') || finituraEst.includes('alu') ? 'alluminio' : 'pvc';
                        console.log(`ğŸ”§ Materiale Pos ${index+1}:`);
                        console.log(`   infisso.finituraEst = "${infisso.finituraEst || 'undefined'}"`);
                        console.log(`   infisso.finitura_est = "${infisso.finitura_est || 'undefined'}"`);
                        console.log(`   configInfissi.finituraEst = "${data.configInfissi?.finituraEst || 'undefined'}"`);
                        console.log(`   â†’ finituraEst finale = "${finituraEst}" â†’ materiale = ${materiale}`);
                        
                        // âœ… v7.73: Mappa colori a codici Finstral
                        const codicePVC = mappaColoreACodiceFinstral(coloreInterno || coloreEsterno, 'pvc');
                        const codiceAlluminio = materiale === 'alluminio' ? 
                            mappaColoreACodiceFinstral(coloreEsterno, 'alluminio') : null;
                        
                        // âœ… CALCOLO FINSTRAL COMPLETO CON COLORI
                        console.log(`ğŸš€ Chiamata calcolaPrezzoFinstral con materiale="${materiale}"`);
                        const risultatoFinstral = calcolaPrezzoFinstral({
                            tipo: tipoFinstral,
                            larghezza: L_mm,
                            altezza: H_mm,
                            telaio: telaio,
                            materiale: materiale,
                            tipoAnta: tipoAnta,
                            colorePVC: codicePVC,
                            coloreAlluminio: codiceAlluminio
                        });
                        
                        let prezzoBase = 400; // Fallback
                        let supplementoTelaioFinstral = 0;
                        let supplementoColoreFinstral = 0;
                        let supplementoProfiloAntaFinstral = 0;
                        let supplementoMontanteFinstral = 0;
                        
                        if (!risultatoFinstral.errore) {
                            prezzoBase = risultatoFinstral.dettaglio.prezzoBase;
                            supplementoTelaioFinstral = risultatoFinstral.dettaglio.supplementoTelaio || 0;
                            supplementoProfiloAntaFinstral = risultatoFinstral.dettaglio.supplementoProfiloAnta || 0;
                            supplementoMontanteFinstral = risultatoFinstral.dettaglio.supplementoMontante || 0;
                            supplementoColoreFinstral = (risultatoFinstral.dettaglio.supplementoColorePVC || 0) + 
                                                       (risultatoFinstral.dettaglio.supplementoColoreAlluminio || 0);
                            
                            const gruppoCol = risultatoFinstral.dettaglio.gruppoColorePVC || 'A';
                            console.log(`ğŸ’° FINSTRAL Pos ${index+1}: tipo${tipoFinstral} ${L_mm}Ã—${H_mm} tel.${telaio} ${tipoAnta}`);
                            console.log(`   â””â”€ Base â‚¬${prezzoBase} + Telaio â‚¬${supplementoTelaioFinstral.toFixed(2)} + Profilo â‚¬${supplementoProfiloAntaFinstral.toFixed(2)}`);
                        } else {
                            // âœ… v7.73 FIX: Calcola supplementi SEMPRE, anche con fallback prezzo base
                            const tipo = getTipoDaApertura(apertura);
                            prezzoBase = trovaCampionePrezzoBase(tipo, L_mm, H_mm) || 400;
                            
                            // Calcola supplementi manualmente usando FINSTRAL_PREZZI
                            const supplTelaio = FINSTRAL_PREZZI.supplementiTelaio?.[telaio];
                            if (supplTelaio) {
                                supplementoTelaioFinstral = Math.round(supplTelaio[materiale] * perimetro_ml * 100) / 100;
                            }
                            
                            // âœ… v7.79 FIX: Calcola perimetro BATTENTI per supplemento profilo anta
                            const larghezzaAnta_m_fb = (L_mm / numAnteInfisso) / 1000;
                            const altezzaAnta_m_fb = H_mm / 1000;
                            const perimetroBattenti_fb = 2 * (larghezzaAnta_m_fb + altezzaAnta_m_fb) * numAnteInfisso;
                            
                            const antaNorm = tipoAnta.toLowerCase().replace(/\s+/g, '-');
                            
                            // âœ… v7.79: Prima controlla tabelle dimensionali
                            const larghezzaAnta_mm_fb = L_mm / numAnteInfisso;
                            const suppTabella_fb = getSupplementoAntaDimensionale(antaNorm, H_mm, larghezzaAnta_mm_fb);
                            if (suppTabella_fb !== null && suppTabella_fb > 0) {
                                supplementoProfiloAntaFinstral = Math.round(suppTabella_fb * numAnteInfisso * 100) / 100;
                                console.log(`ğŸ“Š Fallback tabella ${antaNorm}: â‚¬${suppTabella_fb}/pz Ã— ${numAnteInfisso} = â‚¬${supplementoProfiloAntaFinstral}`);
                            } else {
                                const supplProfilo = FINSTRAL_PREZZI.supplementiProfiloAnta?.[antaNorm];
                                if (supplProfilo) {
                                    // âœ… v7.79 FIX: Nova-line Ã¨ SOLO PVC, usa sempre valore PVC
                                    const isNovaLine_fb = antaNorm.includes('nova');
                                    const materialeProfilo_fb = isNovaLine_fb ? 'pvc' : materiale;
                                    const valoreProf_fb = supplProfilo[materialeProfilo_fb] || supplProfilo['pvc'] || 0;
                                    supplementoProfiloAntaFinstral = Math.round(valoreProf_fb * perimetroBattenti_fb * 100) / 100;
                                    console.log(`ğŸ“Š Fallback profilo ${antaNorm}[${materialeProfilo_fb}]: â‚¬${valoreProf_fb}/ml Ã— ${perimetroBattenti_fb.toFixed(2)}ml = â‚¬${supplementoProfiloAntaFinstral}`);
                                }
                            }
                            
                            // âœ… v7.79 FIX: Montante per 2 ante con nodo specifico per tipo anta
                            if (tipoFinstral === "401") {
                                const codiceNodo_fb = FINSTRAL_PREZZI.nodiPerTipoAnta?.[antaNorm] || "codice28";
                                const montanteData = FINSTRAL_PREZZI.supplementiMontante?.[codiceNodo_fb];
                                if (montanteData) {
                                    // Per fallback, usa gruppo semplificato
                                    if (materiale === 'alluminio') {
                                        // Verifica se colore decorativo
                                        const colEst = (infisso.coloreEst || '').toUpperCase();
                                        if (colEst.startsWith('L') || colEst.includes('CASTAGNO') || colEst.includes('ROVERE')) {
                                            supplementoMontanteFinstral = montanteData.aluC || montanteData.aluA || 0;
                                        } else {
                                            supplementoMontanteFinstral = montanteData.aluA || 0;
                                        }
                                    } else {
                                        supplementoMontanteFinstral = montanteData.pvcA || 0;
                                    }
                                    console.log(`ğŸ“Š Fallback montante ${codiceNodo_fb}: â‚¬${supplementoMontanteFinstral}`);
                                }
                            }
                            
                            console.log(`âš ï¸ Finstral fuori range Pos ${index+1}, uso fallback prezzoBase: â‚¬${prezzoBase}`);
                            console.log(`   â””â”€ Perimetro battenti: ${perimetroBattenti_fb.toFixed(2)}ml (${numAnteInfisso} ante)`);
                            console.log(`   â””â”€ MA supplementi FINSTRAL: Telaio â‚¬${supplementoTelaioFinstral.toFixed(2)} + Profilo â‚¬${supplementoProfiloAntaFinstral.toFixed(2)} + Montante â‚¬${supplementoMontanteFinstral.toFixed(2)}`);
                        }
                        
                        // Usa supplementi Finstral (calcolati sempre)
                        const supplementoTelaio = supplementoTelaioFinstral;
                        
                        // âœ… v7.73: Supplemento colore (usa Finstral se disponibile)
                        const supplementoColore = supplementoColoreFinstral;
                        
                        // âœ… v7.73: Supplemento profilo anta
                        const supplementoProfiloAnta = supplementoProfiloAntaFinstral;
                        
                        // âœ… v7.73: Log dettagliato per debug
                        if (!risultatoFinstral.errore) {
                            console.log(`ğŸ“Š FINSTRAL Dettaglio Pos ${index+1}:`);
                            console.log(`   Base: â‚¬${prezzoBase}`);
                            console.log(`   Telaio ${telaio}: â‚¬${supplementoTelaioFinstral.toFixed(2)} (${perimetro_ml.toFixed(2)}ml)`);
                            console.log(`   Profilo ${tipoAnta}: â‚¬${supplementoProfiloAnta.toFixed(2)}`);
                            console.log(`   Colore: â‚¬${supplementoColore.toFixed(2)}`);
                        }
                        
                        // Calcola supplemento vetro
                        const tipoVetro = infisso.vetro || data.configInfissi?.vetro || 'doppio';
                        const supplementoVetro = calcolaSupplementoVetro(tipoVetro, superficie_mq);
                        
                        // Calcola supplemento maniglia (v7.26: supporta database Finstral)
                        const manigliaValue = infisso.maniglia || data.configInfissi?.maniglia || '';
                        const coloreValue = infisso.coloreManiglia || data.configInfissi?.coloreManiglia || '';
                        let supplementoManiglia = calcolaSupplementoManigliaFinstral(manigliaValue, coloreValue);
                        
                        // âœ… v7.56: Moltiplica maniglia per numero ante (1 maniglia/anta)
                        supplementoManiglia = supplementoManiglia * numAnteInfisso;
                        if (numAnteInfisso > 1) {
                            console.log(`ğŸ”§ Maniglie: ${numAnteInfisso} ante Ã— supplemento = â‚¬${supplementoManiglia.toFixed(2)}`);
                        }
                        
                        // âœ… v7.73: Supplemento MONTANTE (giÃ  calcolato sopra)
                        const supplementoMontante = supplementoMontanteFinstral;
                        if (supplementoMontante > 0) {
                            console.log(`ğŸ”— Montante 2 ante: â‚¬${supplementoMontante.toFixed(2)}`);
                        }
                        
                        // âœ… v7.74: Supplemento SOGLIA se porta-finestra (PF1, PF2, o H>=1800)
                        let supplementoSoglia = 0;
                        let supplementoManigliettaPF = 0;  // âœ… v8.10: Maniglietta esterna PF
                        // FIX: 'pf2'.includes('p2') = FALSE! Usiamo startsWith + controllo altezza
                        const isPortaFinestra = tipoInfisso.startsWith('pf') || tipoInfisso.startsWith('p1') || tipoInfisso.startsWith('p2') ||
                                               tipoInfisso.includes('porta') || apertura.includes('porta') ||
                                               H_mm >= 1800;  // Logica Finstral: altezza >= 1800mm = porta-finestra
                        if (isPortaFinestra) {
                            const larghezza_ml = L_mm / 1000;
                            // âœ… v8.10: Soglia ribassata codice 3 = 54.50 â‚¬/ml
                            supplementoSoglia = larghezza_ml * (FINSTRAL_PREZZI.supplementiSoglia?.["codice3"] || 54.50);
                            console.log(`ğŸšª Soglia porta-finestra: ${larghezza_ml.toFixed(2)}ml Ã— â‚¬54.50 = â‚¬${supplementoSoglia.toFixed(2)}`);
                            
                            // âœ… v8.10: Maniglietta esterna per porte-finestre (codice 454)
                            // Obbligatoria per Nova-line e altre ante
                            supplementoManigliettaPF = 39.10;  // â‚¬/pezzo
                            console.log(`ğŸšª Maniglietta esterna PF: â‚¬${supplementoManigliettaPF.toFixed(2)}`);
                        }
                        
                        // âœ… v7.75: Supplemento TAGLI TELAIO (codici dal JSON)
                        let supplementoTagli = 0;
                        let taglioDescrizione = '';
                        // Legge tagli dal JSON: puÃ² essere stringa singola o array
                        const tagliRaw = infisso.taglio || infisso.tagli || pos.taglio || pos.tagli || null;
                        if (tagliRaw) {
                            // Normalizza a array
                            const tagli = Array.isArray(tagliRaw) ? tagliRaw : [tagliRaw];
                            tagli.forEach(codice => {
                                const codiceClean = String(codice).trim().toUpperCase();
                                const prezzoTaglio = FINSTRAL_PREZZI.supplementiTagli?.[codiceClean] || 
                                                     FINSTRAL_PREZZI.supplementiTagli?.[codiceClean.toLowerCase()] || 0;
                                if (prezzoTaglio > 0) {
                                    const supplementoQuesto = prezzoTaglio * perimetro_ml;
                                    supplementoTagli += supplementoQuesto;
                                    taglioDescrizione += (taglioDescrizione ? ', ' : '') + codiceClean;
                                    console.log(`âœ‚ï¸ Taglio ${codiceClean}: ${perimetro_ml.toFixed(2)}ml Ã— â‚¬${prezzoTaglio}/ml = â‚¬${supplementoQuesto.toFixed(2)}`);
                                }
                            });
                        }
                        
                        // Prezzo unitario (con tutti i supplementi)
                        // âœ… v8.10: Aggiunto supplementoManigliettaPF
                        const supplementoTotale = supplementoTelaio + supplementoProfiloAnta + supplementoVetro + supplementoManiglia + supplementoColore + supplementoMontante + supplementoSoglia + supplementoTagli + supplementoManigliettaPF;
                        const prezzoUnitario = prezzoBase + supplementoTotale;
                        
                        // QuantitÃ  (prioritÃ : pos.quantita > infisso.qta > 1)
                        const quantita = parseInt(pos.quantita) || parseInt(infisso.qta) || 1;
                        
                        // Totale riga
                        const totaleRiga = prezzoUnitario * quantita;
                        
                        righe.push({
                            posizione: index + 1,
                            ambiente: pos.ambiente || pos.nome || pos.stanza || `Pos ${index + 1}`,
                            tipo: `Infisso ${infisso.tipo || 'F2'}`,
                            azienda: infisso.azienda || data.configInfissi?.azienda || 'Finstral',
                            telaio: telaio,  // âœ… v8.10: Solo codice telaio (es. "961")
                            tipoAnta: tipoAnta,  // âœ… v8.10: Tipo anta separato (es. "Nova-line")
                            larghezza: L_mm,
                            altezza: H_mm,
                            superficie: superficie_mq.toFixed(2),
                            perimetro: perimetro_ml.toFixed(2),
                            prezzoBase: prezzoBase.toFixed(2),
                            supplemento: supplementoTotale.toFixed(2),
                            supplementoTelaio: supplementoTelaio.toFixed(2),
                            supplementoAnta: supplementoProfiloAnta.toFixed(2),  // âœ… v7.73: Rinominato
                            supplementoVetro: supplementoVetro.toFixed(2),
                            supplementoColore: supplementoColore.toFixed(2),  // âœ… v7.73
                            supplementoManiglia: supplementoManiglia.toFixed(2),
                            supplementoMontante: supplementoMontante.toFixed(2),  // âœ… v7.73: NUOVO
                            supplementoSoglia: supplementoSoglia.toFixed(2),  // âœ… v7.74: NUOVO
                            supplementoManigliettaPF: supplementoManigliettaPF.toFixed(2),  // âœ… v8.10: NUOVO
                            supplementoTagli: supplementoTagli.toFixed(2),  // âœ… v7.75: NUOVO
                            tagli: taglioDescrizione || '',  // âœ… v7.75: Codici taglio applicati
                            isPortaFinestra: isPortaFinestra,  // âœ… v7.74: Flag per debug
                            prezzoUnitario: prezzoUnitario.toFixed(2),
                            quantita: quantita,
                            totale: totaleRiga.toFixed(2)
                        });
                        
                        totaleMateriali += totaleRiga;
                        numeroPezzi += quantita;
                    } else {
                        console.warn(`âš ï¸ Pos ${index + 1}: Misure BRM non trovate, salto calcolo`);
                    }
                }
                
                // ============================================================================
                // TAPPARELLE - PLASTICINO/NEW SOLAR/ESTELLA
                // ============================================================================
                
                // ğŸ” DEBUG: Log completo posizione
                console.log(`ğŸ” DEBUG Pos ${index + 1}:`, {
                    ha_tapparella: !!pos.tapparella,
                    tapparella_completo: pos.tapparella,
                    quantita: pos.tapparella?.quantita,
                    azienda: pos.tapparella?.azienda,
                    serveTapparella: pos.tapparella?.serveTapparella,
                    serveMotore: pos.tapparella?.serveMotore
                });
                
                // ğŸ†• v7.996: Controlla serveTapparella - se false, salta telo e vai a motore
                const serveTapparella = pos.tapparella?.serveTapparella !== false;
                const serveMotore = pos.tapparella?.serveMotore === true;
                
                // âœ… FIX v7.996: Solo se serveTapparella Ã¨ true (o undefined per retrocompatibilitÃ )
                if (pos.tapparella && serveTapparella && (pos.tapparella.quantita === undefined || pos.tapparella.quantita === null || pos.tapparella.quantita > 0)) {
                    const tapp = pos.tapparella;
                    const azienda = (tapp.azienda || '').toLowerCase();
                    
                    // FIX: Se quantita undefined, usa 1
                    const quantita = parseInt(tapp.quantita) || 1;
                    
                    console.log(`âœ… Pos ${index + 1} ha tapparella con quantitÃ  ${quantita}, azienda: "${azienda}"`);
                    
                    // ğŸ” v7.50 DEBUG ESTREMO: Vedi TUTTA la struttura pos
                    console.log(`ğŸ” v7.50 DEBUG pos.infisso completo:`, pos.infisso);
                    console.log(`ğŸ” v7.50 pos.infisso.BRM_L = ${pos.infisso?.BRM_L} (type: ${typeof pos.infisso?.BRM_L})`);
                    console.log(`ğŸ” v7.50 pos.infisso.BRM_H = ${pos.infisso?.BRM_H} (type: ${typeof pos.infisso?.BRM_H})`);
                    console.log(`ğŸ” v7.50 pos.infisso.brm = `, pos.infisso?.brm);
                    console.log(`ğŸ” v7.50 tapp.brm = `, tapp.brm);
                    console.log(`ğŸ” v7.50 tapp completo:`, tapp);
                    
                    // ğŸ” DEBUG: Accetta TUTTE le aziende per test
                    const usaListinoPlasticino = LISTINO_PLASTICINO.aziende.includes(azienda);
                    console.log(`ğŸ” Azienda "${azienda}" usa listino Plasticino? ${usaListinoPlasticino}`);
                    console.log(`ğŸ” DEBUG: PROCEDO COMUNQUE con il calcolo (versione debug)`);
                    
                    // if (LISTINO_PLASTICINO.aziende.includes(azienda)) {  // â† RIMOSSO PER DEBUG
                    if (true) {  // â† DEBUG: Accetta TUTTE le aziende
                        // âœ… v7.58 FIX PRIORITÃ€ CORRETTA TAPPARELLE
                        // 1Â° BRM_L/BRM_H (campo diretto)
                        // 2Â° brm?.L/brm?.H (retrocompatibilitÃ )
                        // 3Â° LF/HF (Larghezza/Altezza Foro) + MAGGIORAZIONI
                        // 4Â° LVT/HVT (ultimo fallback)
                        
                        let L_mm = parseInt(tapp.BRM_L) || parseInt(tapp.brm?.L) || 0;
                        let H_mm = parseInt(tapp.BRM_H) || parseInt(tapp.brm?.H) || 0;
                        let usaMisureForo = false;  // ğŸ†• v7.81: Flag per maggiorazioni
                        
                        console.log(`ğŸ” v7.58 Tapparella Pos ${index + 1}:`);
                        console.log(`   - tapp.BRM_L = ${tapp.BRM_L}, tapp.BRM_H = ${tapp.BRM_H}`);
                        console.log(`   - tapp.brm?.L = ${tapp.brm?.L}, tapp.brm?.H = ${tapp.brm?.H}`);
                        
                        // ğŸ”§ FALLBACK 1: LF e HF (misure foro tapparella)
                        if (!L_mm && pos.misure?.LF) {
                            L_mm = parseInt(pos.misure.LF);
                            usaMisureForo = true;
                            console.log(`   âš ï¸ Fallback LF: ${L_mm}mm (da foro)`);
                        }
                        if (!H_mm && pos.misure?.HF) {
                            H_mm = parseInt(pos.misure.HF);
                            usaMisureForo = true;
                            console.log(`   âš ï¸ Fallback HF: ${H_mm}mm (da foro)`);
                        }
                        
                        // ğŸ”§ FALLBACK 2 (ultimo): LVT e HVT (misure infisso)
                        if (!L_mm && pos.misure?.LVT) {
                            L_mm = parseInt(pos.misure.LVT);
                            console.log(`   âš ï¸âš ï¸ Fallback ULTIMO LVT: ${L_mm}mm`);
                        }
                        if (!H_mm && pos.misure?.HVT) {
                            H_mm = parseInt(pos.misure.HVT);
                            console.log(`   âš ï¸âš ï¸ Fallback ULTIMO HVT: ${H_mm}mm`);
                        }
                        
                        // Ultimo fallback: pos.L/H generico
                        if (!L_mm) L_mm = parseInt(pos.L) || 0;
                        if (!H_mm) H_mm = parseInt(pos.H) || 0;
                        
                        // ğŸ†• v7.81: MAGGIORAZIONI per misure foro (LF/HF)
                        // Il telo deve essere piÃ¹ grande del foro per coprirlo
                        let L_telo_mm = L_mm;
                        let H_telo_mm = H_mm;
                        if (usaMisureForo) {
                            L_telo_mm = L_mm + 40;   // +40mm larghezza
                            H_telo_mm = H_mm + 200;  // +200mm altezza
                            console.log(`   ğŸ“ v7.81 Maggiorazione foro: ${L_mm}+40=${L_telo_mm}mm Ã— ${H_mm}+200=${H_telo_mm}mm`);
                        }
                        
                        // âœ… Per calcolo Plasticino serve in CM (usa misure telo maggiorate)
                        const L_cm = Math.round(L_telo_mm / 10);
                        const H_cm = Math.round(H_telo_mm / 10);
                        
                        console.log(`âœ… v7.81 Tapparella Pos ${index + 1}: Foro=${L_mm}Ã—${H_mm}mm â†’ Telo=${L_telo_mm}Ã—${H_telo_mm}mm (${L_cm}Ã—${H_cm}cm)`);
                        
                        if (L_cm > 0 && H_cm > 0) {
                            // Determina modello telo da dati tapparella (se presente)
                            const modelloTelo = tapp.modello || null;  // es. 'TA01', 'TA25', 'A01'
                            const coloreTelo = tapp.colore_tipo || null;  // es. 'tinta_unita', 'tinta_legno'
                            
                            // Calcola prezzo usando listino Plasticino COMPLETO (con telo)
                            const calcolo = calcolaPrezzoPLASTICINO(L_cm, H_cm, modelloTelo, coloreTelo);
                            
                            // ğŸ†• v7.81: Calcola prezzo guida
                            let prezzoGuida = 0;
                            let guidaInfo = { codice: '', descrizione: '', prezzo: 0 };
                            if (tapp.guida && tapp.guida !== '') {
                                guidaInfo = calcolaPrezzoGuida(tapp.guida, tapp.coloreGuida || 'Argento', H_mm);
                                prezzoGuida = guidaInfo.prezzo || 0;
                            }
                            
                            // Totale con guida
                            const totaleConGuida = calcolo.totale + prezzoGuida;
                            const totaleRiga = totaleConGuida * quantita;
                            
                            console.log(`ğŸ’° v7.81 Dettaglio tapparella Pos ${index + 1}:`, {
                                telo: `â‚¬${calcolo.telo.toFixed(2)} (${calcolo.telo_mq.toFixed(2)} mq Ã— â‚¬${calcolo.telo_prezzo_mq}/mq) [${calcolo.telo_modello}]`,
                                rullo: `â‚¬${calcolo.rullo.toFixed(2)}`,
                                fissi: `â‚¬${calcolo.fissi.toFixed(2)}`,
                                supplemento: `â‚¬${calcolo.supplemento_altezza.toFixed(2)}`,
                                guida: `â‚¬${prezzoGuida.toFixed(2)} [${guidaInfo.codice || 'N/D'}]`,
                                totale: `â‚¬${totaleConGuida.toFixed(2)}`
                            });
                            
                            righe.push({
                                posizione: index + 1,
                                ambiente: pos.ambiente || pos.nome || pos.stanza || `Pos ${index + 1}`,
                                tipo: 'Tapparella',
                                azienda: tapp.azienda || 'Plasticino',
                                telaio: calcolo.telo_modello || '-',  // Mostra modello telo
                                larghezza: L_mm,  // âœ… v7.57: Mostra in MM (non cm!)
                                altezza: H_mm,    // âœ… v7.57: Mostra in MM (non cm!)
                                superficie: calcolo.telo_mq.toFixed(2),  // Superficie in mq
                                perimetro: '-',
                                // ğŸ†• v7.81: Mapping con GUIDA inclusa
                                prezzoBase: calcolo.telo.toFixed(2),             // TELO (costo principale)
                                supplementoTelaio: calcolo.rullo.toFixed(2),     // Rullo
                                supplementoAnta: calcolo.fissi.toFixed(2),       // Fissi
                                supplementoVetro: calcolo.supplemento_altezza.toFixed(2), // Supp altezza
                                supplementoManiglia: prezzoGuida.toFixed(2),     // ğŸ†• GUIDA
                                prezzoUnitario: totaleConGuida.toFixed(2),
                                quantita: quantita,
                                totale: totaleRiga.toFixed(2)
                            });
                            
                            totaleMateriali += totaleRiga;
                            numeroPezzi += quantita;
                            
                            console.log(`âœ… Tapparella ${azienda} Pos ${index + 1}: ${L_mm}mmÃ—${H_mm}mm = â‚¬${totaleConGuida.toFixed(2)} (Telo: â‚¬${calcolo.telo.toFixed(2)} + Rullo: â‚¬${calcolo.rullo.toFixed(2)} + Fissi: â‚¬${calcolo.fissi.toFixed(2)} + Guida: â‚¬${prezzoGuida.toFixed(2)})`);
                        } else {
                            console.warn(`âš ï¸ Pos ${index + 1}: Tapparella ${azienda} senza misure, salto calcolo`);
                        }
                    } else {
                        console.warn(`âš ï¸ Pos ${index + 1}: Azienda tapparelle "${tapp.azienda}" non ha listino prezzi`);
                    }
                }
                
                // ============================================================================
                // ğŸ”Œ v7.999: MOTORI - Aggiunge riga SEMPRE quando serveMotore=true
                // (indipendentemente da serveTapparella - possono coesistere)
                // ============================================================================
                if (pos.tapparella && serveMotore) {
                    const tapp = pos.tapparella;
                    const motori = tapp.motori || [];
                    const quantita = parseInt(tapp.qta || tapp.quantita) || 1;
                    
                    console.log(`ğŸ”Œ v7.999 Pos ${index + 1}: MOTORE (serveMotore=true)`);
                    console.log(`   Motori array:`, motori);
                    
                    // Se ci sono motori nell'array, creane una riga per ciascuno
                    if (motori.length > 0) {
                        motori.forEach((motore, motIdx) => {
                            const modelloId = motore.modelloId || tapp.motoreModelloDefault || 'oximo_20';
                            const comandoId = motore.comandoId || tapp.comandoDefault || '';
                            const accessori = motore.accessori || {};
                            const noteMotore = motore.note || '';
                            
                            // ğŸ”Œ v7.999: Calcola prezzo con SOMFY_PREZZI
                            const prezzoKit = SOMFY_PREZZI.calcolaPrezzoKit(motore);
                            const prezzoMotore = prezzoKit.totale;
                            
                            // Genera descrizione accessori per la riga
                            let descAccessori = [];
                            const motoreDb = SOMFY_PREZZI.getPrezzoMotore(modelloId);
                            if (motoreDb) descAccessori.push(motoreDb.nome);
                            const comandoDb = SOMFY_PREZZI.getPrezzoComando(comandoId);
                            if (comandoDb) descAccessori.push(comandoDb.nome);
                            if (accessori.supporto) descAccessori.push('Supporto');
                            if (accessori.ruota_60) descAccessori.push('Ruota 60');
                            if (accessori.corona_60) descAccessori.push('Corona');
                            
                            righe.push({
                                posizione: index + 1,
                                ambiente: pos.ambiente || pos.nome || `Pos ${index + 1}`,
                                tipo: 'Motore',
                                azienda: tapp.motoreAzienda || 'Somfy',
                                telaio: modelloId.replace(/_/g, ' ').toUpperCase(),
                                larghezza: '-',
                                altezza: '-',
                                superficie: '-',
                                perimetro: '-',
                                prezzoBase: (motoreDb?.prezzo || 0).toFixed(2),
                                supplementoTelaio: (comandoDb?.prezzo || 0).toFixed(2),  // Comando
                                supplementoAnta: (accessori.supporto ? (SOMFY_PREZZI.accessori.supporto?.listino || 7.88) : 0).toFixed(2),  // Supporto da DB
                                supplementoVetro: (accessori.ruota_60 ? (SOMFY_PREZZI.accessori.ruota_60?.listino || 21.00) : 0).toFixed(2),  // Ruota da DB
                                supplementoManiglia: '0.00',
                                prezzoUnitario: prezzoMotore.toFixed(2),
                                quantita: quantita,
                                totale: (prezzoMotore * quantita).toFixed(2),
                                _tipoMotore: true,
                                _accessori: accessori,
                                _comandoId: comandoId,
                                _dettaglioKit: prezzoKit.dettaglio
                            });
                            
                            // âœ… v8.11 FIX CRITICO: Somma motori al totale materiali
                            totaleMateriali += prezzoMotore * quantita;
                            numeroPezzi += quantita;
                            
                            console.log(`âœ… Motore Pos ${index + 1}: ${modelloId} = â‚¬${prezzoMotore.toFixed(2)} (aggiunto a totale)`);
                            console.log(`   Dettaglio:`, prezzoKit.dettaglio);
                        });
                    } else {
                        // Nessun motore specificato, ma serveMotore=true
                        // Usa modelloDefault se presente
                        const modelloDefault = tapp.motoreModelloDefault || 'oximo_20';
                        const comandoDefault = tapp.comandoDefault || '';
                        
                        // Calcola prezzo default
                        const motoreDb = SOMFY_PREZZI.getPrezzoMotore(modelloDefault);
                        const comandoDb = SOMFY_PREZZI.getPrezzoComando(comandoDefault);
                        const prezzoMotore = (motoreDb?.prezzo || 0) + (comandoDb?.prezzo || 0);
                        
                        righe.push({
                            posizione: index + 1,
                            ambiente: pos.ambiente || pos.nome || `Pos ${index + 1}`,
                            tipo: 'Motore',
                            azienda: tapp.motoreAzienda || 'Somfy',
                            telaio: modelloDefault.replace(/_/g, ' ').toUpperCase(),
                            larghezza: '-',
                            altezza: '-',
                            superficie: '-',
                            perimetro: '-',
                            prezzoBase: (motoreDb?.prezzo || 0).toFixed(2),
                            supplementoTelaio: (comandoDb?.prezzo || 0).toFixed(2),
                            supplementoAnta: '0.00',
                            supplementoVetro: '0.00',
                            supplementoManiglia: '0.00',
                            prezzoUnitario: prezzoMotore.toFixed(2),
                            quantita: quantita,
                            totale: (prezzoMotore * quantita).toFixed(2),
                            _tipoMotore: true
                        });
                        
                        // âœ… v8.11 FIX CRITICO: Somma motori al totale materiali
                        totaleMateriali += prezzoMotore * quantita;
                        numeroPezzi += quantita;
                        
                        console.log(`âœ… Motore Pos ${index + 1}: ${modelloDefault} (default) = â‚¬${prezzoMotore.toFixed(2)} (aggiunto a totale)`);
                    }
                }
                
                // ============================================================================
                // PERSIANE - PUNTO PERSIANE
                // ============================================================================
                if (pos.persiana && (pos.persiana.quantita === undefined || pos.persiana.quantita === null || pos.persiana.quantita > 0)) {
                    const pers = pos.persiana;
                    const quantita = parseInt(pers.quantita) || 1;
                    
                    // ğŸ”§ v7.51 FIX: Fallback COMPLETO come infissi (usa pos.misure.LVT/HVT)
                    let L_mm = parseInt(pers.brm?.L) || parseInt(pers.larghezza) || 0;
                    let H_mm = parseInt(pers.brm?.H) || parseInt(pers.altezza) || 0;
                    
                    // Fallback a pos.misure (come infissi!)
                    if (!L_mm && pos.misure?.LVT) {
                        L_mm = parseInt(pos.misure.LVT);
                        console.log(`ğŸ” v7.51 Persiana fallback LVT: ${L_mm}mm`);
                    }
                    if (!H_mm && pos.misure?.HVT) {
                        H_mm = parseInt(pos.misure.HVT);
                        console.log(`ğŸ” v7.51 Persiana fallback HVT: ${H_mm}mm`);
                    }
                    
                    // Ultimo fallback
                    if (!L_mm) L_mm = parseInt(pos.L) || 0;
                    if (!H_mm) H_mm = parseInt(pos.H) || 0;
                    
                    console.log(`ğŸ” Persiana Pos ${index + 1}: L=${L_mm}mm, H=${H_mm}mm`);
                    
                    if (L_mm > 0 && H_mm > 0) {
                        // âœ… v7.52: Implementato calcolo prezzi con listino Punto Persiane
                        const azienda = (pers.azienda || '').toLowerCase();
                        const usaListinoPuntoPersiane = LISTINO_PUNTO_PERSIANE.aziende.includes(azienda);
                        
                        console.log(`ğŸ” Azienda persiane "${azienda}" usa listino Punto Persiane? ${usaListinoPuntoPersiane}`);
                        
                        let prezzoUnitario = 0;
                        let prezzoBase = 0;
                        let supplementoColore = 0;
                        let supplementoSpagnolette = 0;
                        let categoriaColore = 'CAT01';
                        let tipologia = 'F1';
                        let cardini = 0;
                        let imballo = 0;
                        let contributoGestione = 0;
                        
                        if (usaListinoPuntoPersiane) {
                            // âœ… v7.55: Estrai numero ante dal campo tipo (F1, F2, PF2, ecc.)
                            const numAnte = estraiNumeroAnte(pers.tipo);
                            
                            // Determina se Finestra (F) o Porta Finestra (PF) in base altezza
                            const isPortaFinestra = H_mm >= 1800;
                            const prefix = isPortaFinestra ? 'PF' : 'F';
                            
                            // Determina tipologia in base al numero ante
                            tipologia = `${prefix}1`;
                            if (numAnte === 2) tipologia = `${prefix}2`;
                            else if (numAnte === 3) tipologia = 'F3'; // F3 solo finestre
                            else if (numAnte === 4) tipologia = 'F4'; // F4 solo finestre
                            
                            console.log(`ğŸ“ Persiana tipo="${pers.tipo}" â†’ ${numAnte} ante, H=${H_mm}mm â†’ ${isPortaFinestra ? 'Porta Finestra' : 'Finestra'} â†’ Tipologia ${tipologia}`);
                            console.log(`ğŸ“‹ Modello persiana: "${pers.modello || 'N/D'}"`);
                            
                            // ğŸ†• v7.92: Usa calcolo COMPLETO con tutte le voci
                            const calcolo = calcolaPrezzoPersianaCOMPLETO(
                                L_mm, 
                                H_mm, 
                                tipologia, 
                                pers.modello || 'Alto Adige',  // Modello per maggiorazione
                                pers.colorePersiana,            // Colore
                                numAnte                         // Numero ante
                            );
                            
                            prezzoBase = calcolo.prezzo_base_con_modello;
                            supplementoColore = calcolo.supplemento_colore;
                            categoriaColore = calcolo.categoria_colore;
                            supplementoSpagnolette = calcolo.supplemento_spagnolette;
                            cardini = calcolo.cardini;
                            imballo = calcolo.imballo;
                            contributoGestione = calcolo.contributo_gestione;
                            
                            // Prezzo unitario finale CON TUTTE LE VOCI
                            prezzoUnitario = calcolo.totale;
                            
                            console.log(`âœ… Persiana Pos ${index + 1}: TOTALE COMPLETO â‚¬${prezzoUnitario.toFixed(2)}`);
                        } else {
                            console.warn(`âš ï¸ Pos ${index + 1}: Azienda persiane "${pers.azienda}" non ha listino prezzi`);
                        }
                        
                        const totaleRiga = prezzoUnitario * quantita;
                        
                        righe.push({
                            posizione: index + 1,
                            ambiente: pos.ambiente || pos.nome || pos.stanza || `Pos ${index + 1}`,
                            tipo: `Persiana ${pers.tipo || tipologia}`,
                            azienda: pers.azienda || 'P. Persiane',
                            telaio: pers.modello ? `${pers.modello}` : '-',
                            larghezza: L_mm,
                            altezza: H_mm,
                            superficie: '-',
                            perimetro: '-',
                            prezzoBase: prezzoBase.toFixed(2),
                            supplementoTelaio: supplementoColore.toFixed(2),      // Colore
                            supplementoAnta: supplementoSpagnolette.toFixed(2),   // Spagnolette
                            supplementoVetro: cardini.toFixed(2),                 // ğŸ†• Cardini
                            supplementoManiglia: imballo.toFixed(2),              // ğŸ†• Imballo
                            supplementoColore: contributoGestione.toFixed(2),     // ğŸ†• Contributo gestione
                            supplementoMontante: '0.00',
                            prezzoUnitario: prezzoUnitario.toFixed(2),
                            quantita: quantita,
                            totale: totaleRiga.toFixed(2),
                            // Campi extra per debug
                            _colore: pers.colorePersiana || '-',
                            _categoriaColore: categoriaColore
                        });
                        
                        totaleMateriali += totaleRiga;
                        numeroPezzi += quantita;
                    }
                }
                
                // ============================================================================
                // ZANZARIERE - PALAGINA
                // ============================================================================
                if (pos.zanzariera && (pos.zanzariera.quantita === undefined || pos.zanzariera.quantita === null || pos.zanzariera.quantita > 0)) {
                    const zanz = pos.zanzariera;
                    const quantita = parseInt(zanz.quantita) || 1;
                    
                    // ğŸ”§ v7.51 FIX: Fallback COMPLETO come infissi (usa pos.misure.LVT/HVT)
                    let L_mm = parseInt(zanz.brm?.L) || parseInt(zanz.larghezza) || 0;
                    let H_mm = parseInt(zanz.brm?.H) || parseInt(zanz.altezza) || 0;
                    
                    // Fallback a pos.misure (come infissi!)
                    if (!L_mm && pos.misure?.LVT) {
                        L_mm = parseInt(pos.misure.LVT);
                        console.log(`ğŸ” v7.51 Zanzariera fallback LVT: ${L_mm}mm`);
                    }
                    if (!H_mm && pos.misure?.HVT) {
                        H_mm = parseInt(pos.misure.HVT);
                        console.log(`ğŸ” v7.51 Zanzariera fallback HVT: ${H_mm}mm`);
                    }
                    
                    // Ultimo fallback
                    if (!L_mm) L_mm = parseInt(pos.L) || 0;
                    if (!H_mm) H_mm = parseInt(pos.H) || 0;
                    
                    console.log(`ğŸ” Zanzariera Pos ${index + 1}: L=${L_mm}mm, H=${H_mm}mm`);
                    
                    if (L_mm > 0 && H_mm > 0) {
                        // ğŸ¦Ÿ v8.13: Calcolo prezzi con listino PALAGINA
                        let prezzoUnitario = 0;
                        let noteRiga = '';
                        let dettaglioCalcolo = null;
                        
                        const modello = zanz.modello || 'SINTESI';  // Default SINTESI
                        const codColore = zanz.codiceColore || zanz.colore || '';
                        const tipoRete = zanz.rete || zanz.tipoRete || 'STD';
                        const accessoriIds = zanz.accessori || [];
                        
                        // Determina fascia colore
                        let fascia = zanz.fascia || 'F1';
                        if (codColore && PALAGINA_ZANZARIERE_2025.getFasciaByColore) {
                            const fasciaCalc = PALAGINA_ZANZARIERE_2025.getFasciaByColore(codColore);
                            if (fasciaCalc) fascia = fasciaCalc;
                        }
                        
                        // Calcola prezzo con database PALAGINA
                        const L_cm = L_mm / 10;  // mm â†’ cm
                        const H_cm = H_mm / 10;
                        
                        if (PALAGINA_ZANZARIERE_2025.modelli[modello]) {
                            dettaglioCalcolo = PALAGINA_ZANZARIERE_2025.calcolaPrezzo(modello, L_cm, H_cm, fascia, tipoRete, accessoriIds);
                            if (dettaglioCalcolo && !dettaglioCalcolo.errore) {
                                prezzoUnitario = dettaglioCalcolo.totale;
                                noteRiga = `${modello} ${fascia} ${dettaglioCalcolo.mqFatturati}mq @${dettaglioCalcolo.prezzoMq}â‚¬`;
                                console.log(`ğŸ¦Ÿ PALAGINA Pos ${index + 1}: ${modello} ${L_cm}Ã—${H_cm}cm ${fascia} = â‚¬${prezzoUnitario}`);
                            } else {
                                noteRiga = dettaglioCalcolo?.errore || 'âš ï¸ Errore calcolo';
                                console.warn(`âš ï¸ PALAGINA Pos ${index + 1}: ${dettaglioCalcolo?.errore}`);
                            }
                        } else {
                            noteRiga = `âš ï¸ Modello ${modello} non in listino`;
                            console.warn(`âš ï¸ PALAGINA Pos ${index + 1}: Modello ${modello} non trovato`);
                        }
                        
                        const totaleRiga = prezzoUnitario * quantita;
                        
                        righe.push({
                            posizione: index + 1,
                            ambiente: pos.ambiente || pos.nome || pos.stanza || `Pos ${index + 1}`,
                            tipo: 'Zanzariera',
                            azienda: zanz.azienda || 'Palagina',
                            telaio: modello || '-',
                            larghezza: L_mm,
                            altezza: H_mm,
                            superficie: dettaglioCalcolo?.mqFatturati || '-',
                            perimetro: fascia || '-',
                            prezzoBase: (dettaglioCalcolo?.prezzoBase || 0).toFixed(2),
                            supplementoTelaio: (dettaglioCalcolo?.suppRete || 0).toFixed(2),
                            supplementoAnta: (dettaglioCalcolo?.totAccessori || 0).toFixed(2),
                            supplementoVetro: '0.00',
                            supplementoManiglia: '0.00',
                            prezzoUnitario: prezzoUnitario.toFixed(2),
                            quantita: quantita,
                            totale: totaleRiga.toFixed(2),
                            note: noteRiga,
                            _dettaglioPalagina: dettaglioCalcolo  // Per popup dettaglio
                        });
                        
                        totaleMateriali += totaleRiga;
                        numeroPezzi += quantita;
                        
                        console.log(`âœ… Zanzariera Pos ${index + 1}: ${L_mm}Ã—${H_mm} ${modello} ${fascia} = â‚¬${totaleRiga.toFixed(2)}`);
                    }
                }
                
                // ============================================================================
                // CASSONETTI - FINSTRAL/MAGÃ’/ALPAC
                // ============================================================================
                if (pos.cassonetto && (pos.cassonetto.qta === undefined || pos.cassonetto.qta === null || parseInt(pos.cassonetto.qta) > 0)) {
                    const cass = pos.cassonetto;
                    const quantita = parseInt(cass.qta) || 1;
                    
                    // ğŸ†• v7.996: Usa campi corretti BRM_L, BRM_H, B, C
                    let L_mm = parseInt(cass.BRM_L) || 0;
                    let A_mm = parseInt(cass.BRM_H) || parseInt(cass.HCASS) || 0;
                    let B_mm = parseInt(cass.BRM_B) || parseInt(cass.B) || 0;
                    let C_mm = parseInt(cass.BRM_C) || parseInt(cass.C) || 0;
                    
                    // Fallback
                    if (!L_mm && cass.LS) {
                        const ls = parseInt(cass.LS) || 0;
                        const srsx = parseInt(cass.SRSX) || 0;
                        const srdx = parseInt(cass.SRDX) || 0;
                        L_mm = ls + srsx + srdx;
                        console.log(`ğŸ” v7.996 Cassonetto fallback L: LS(${ls})+SRSX(${srsx})+SRDX(${srdx}) = ${L_mm}mm`);
                    }
                    
                    console.log(`ğŸ“¦ v7.996 Cassonetto Pos ${index + 1}: L=${L_mm}mm, A=${A_mm}mm, B=${B_mm}mm, C=${C_mm}mm`);
                    
                    const azienda = cass.azienda || 'Finstral';
                    const materialeCass = cass.materialeCass || 'PVC';
                    const codiceCass = cass.codiceCass || '';
                    // âœ… v8.11: Determina gruppo colore dal codice colore effettivo, non da gruppoColoreCass
                    const coloreCass = cass.coloreCass || '';
                    const gruppoColoreCass = determinaGruppoColoreCassonetto(coloreCass);
                    const codiceIsolamento = cass.isolamentoPosaclima ? (cass.codiceIsolamento || '') : '';
                    
                    if (L_mm > 0 && A_mm > 0 && azienda.toLowerCase() === 'finstral') {
                        // ğŸ†• v7.996: Usa calcolaPrezzoCassonettoFinstral
                        const calcolo = calcolaPrezzoCassonettoFinstral({
                            L: L_mm,
                            A: A_mm,
                            B: B_mm,
                            materialeCass: materialeCass,
                            codiceCass: codiceCass,
                            gruppoColoreCass: gruppoColoreCass,
                            codiceIsolamento: codiceIsolamento
                        });
                        
                        if (calcolo.success) {
                            const prezzoUnitario = calcolo.prezzo;
                            const totaleRiga = prezzoUnitario * quantita;
                            
                            righe.push({
                                posizione: index + 1,
                                ambiente: pos.ambiente || pos.nome || `Pos ${index + 1}`,
                                tipo: 'Cassonetto',
                                azienda: azienda,
                                telaio: `${materialeCass} ${calcolo.parametri.codiceCass || codiceCass}`,
                                larghezza: L_mm,
                                altezza: A_mm,
                                B: B_mm,
                                superficie: '-',
                                perimetro: '-',
                                prezzoBase: calcolo.dettaglio.prezzoBase.toFixed(2),
                                supplementoTelaio: '0.00',
                                supplementoAnta: '0.00',
                                supplementoVetro: calcolo.dettaglio.supplementoIsolamento.toFixed(2),
                                supplementoManiglia: '0.00',
                                prezzoUnitario: prezzoUnitario.toFixed(2),
                                quantita: quantita,
                                totale: totaleRiga.toFixed(2),
                                materialeCass: materialeCass,
                                codiceCass: calcolo.parametri.codiceCass,
                                gruppoColoreCass: gruppoColoreCass,
                                codiceIsolamento: codiceIsolamento,
                                _tipoCassonetto: true
                            });
                            
                            totaleMateriali += totaleRiga;
                            numeroPezzi += quantita;
                            
                            console.log(`âœ… Cassonetto Finstral Pos ${index + 1}: ${L_mm}Ã—${A_mm}mm (B=${B_mm}) = â‚¬${prezzoUnitario.toFixed(2)} [${materialeCass} ${calcolo.parametri.codiceCass}]`);
                        } else {
                            console.warn(`âš ï¸ Cassonetto Pos ${index + 1}: Calcolo fallito -`, calcolo.errori);
                            // Riga placeholder senza prezzo
                            righe.push({
                                posizione: index + 1,
                                ambiente: pos.ambiente || pos.nome || `Pos ${index + 1}`,
                                tipo: 'Cassonetto',
                                azienda: azienda,
                                telaio: `${materialeCass} ${codiceCass}`,
                                larghezza: L_mm,
                                altezza: A_mm,
                                superficie: '-',
                                perimetro: '-',
                                prezzoBase: '0.00',
                                supplementoTelaio: '0.00',
                                supplementoAnta: '0.00',
                                supplementoVetro: '0.00',
                                supplementoManiglia: '0.00',
                                prezzoUnitario: '0.00',
                                quantita: quantita,
                                totale: '0.00',
                                note: calcolo.errori.join(', '),
                                _tipoCassonetto: true
                            });
                        }
                    } else if (L_mm > 0 && A_mm > 0) {
                        // Altre aziende (no calcolo automatico)
                        righe.push({
                            posizione: index + 1,
                            ambiente: pos.ambiente || pos.nome || `Pos ${index + 1}`,
                            tipo: 'Cassonetto',
                            azienda: azienda,
                            telaio: '-',
                            larghezza: L_mm,
                            altezza: A_mm,
                            superficie: '-',
                            perimetro: '-',
                            prezzoBase: '0.00',
                            supplementoTelaio: '0.00',
                            supplementoAnta: '0.00',
                            supplementoVetro: '0.00',
                            supplementoManiglia: '0.00',
                            prezzoUnitario: '0.00',
                            quantita: quantita,
                            totale: '0.00',
                            note: `${azienda}: prezzo manuale`,
                            _tipoCassonetto: true
                        });
                        console.log(`ğŸ“¦ Cassonetto ${azienda} Pos ${index + 1}: ${L_mm}Ã—${A_mm}mm - Prezzo manuale`);
                    }
                }
                
                // ============================================================================
                // PORTE BLINDATE - OIKOS
                // ============================================================================
                // ğŸ” v7.98: blindata esiste se ha LNP o versione (LNP puÃ² essere stringa)
                const hasBlindataData = pos.blindata && (
                    parseInt(pos.blindata.LNP_L) > 0 || 
                    parseInt(pos.blindata.LNP_H) > 0 || 
                    pos.blindata.versione
                );
                
                if (hasBlindataData) {
                    const bld = pos.blindata;
                    const quantita = 1; // Porte blindate sempre qta 1
                    
                    // Leggi misure LNP (Luce Netta Passaggio) - possono essere stringhe
                    const L_mm = parseInt(bld.LNP_L) || 0;
                    const H_mm = parseInt(bld.LNP_H) || 0;
                    
                    console.log(`ğŸ” Blindata Pos ${index + 1}: LNP=${L_mm}Ã—${H_mm}mm, versione=${bld.versione}`);
                    
                    if (L_mm > 0 && H_mm > 0) {
                        // Calcola prezzo con funzione Oikos
                        const prezzoCalcolato = calcolaPrezzoBlindataOikos(bld);
                        const prezzoUnitario = prezzoCalcolato.totale || 0;
                        const totaleRiga = prezzoUnitario * quantita;
                        
                        // Descrizione configurazione
                        const configDesc = [
                            bld.versione || 'E3',
                            bld.tipoAnta === 'doppia' ? '2 Ante' : '1 Anta',
                            bld.sensoApertura || '',
                            bld.controtelaio === 'si' ? 'Con CT' : 'Senza CT'
                        ].filter(x => x).join(' | ');
                        
                        righe.push({
                            posizione: index + 1,
                            ambiente: pos.ambiente || pos.nome || pos.stanza || `Pos ${index + 1}`,
                            tipo: `ğŸ” Blindata ${bld.versione || 'E3'}`,
                            azienda: bld.azienda || 'Oikos',
                            telaio: configDesc,
                            larghezza: L_mm,
                            altezza: H_mm,
                            superficie: ((L_mm * H_mm) / 1000000).toFixed(2),
                            perimetro: '-',
                            prezzoBase: (prezzoCalcolato.dettaglio?.prezzoBase || 0).toFixed(2),
                            supplementoTelaio: (prezzoCalcolato.dettaglio?.controtelaio || 0).toFixed(2),
                            supplementoAnta: (prezzoCalcolato.dettaglio?.cilindro || 0).toFixed(2),
                            supplementoVetro: (prezzoCalcolato.dettaglio?.rivestimenti || 0).toFixed(2),
                            supplementoColore: (prezzoCalcolato.dettaglio?.colore || 0).toFixed(2),
                            supplementoManiglia: (prezzoCalcolato.dettaglio?.optional || 0).toFixed(2),
                            supplementoMontante: (prezzoCalcolato.dettaglio?.kitAAV || 0).toFixed(2),
                            prezzoUnitario: prezzoUnitario.toFixed(2),
                            quantita: quantita,
                            totale: totaleRiga.toFixed(2),
                            _tipoBlindato: true,
                            _luceCalcolata: bld.luceCalcolata || 'luce0'
                        });
                        
                        totaleMateriali += totaleRiga;
                        numeroPezzi += quantita;
                        
                        console.log(`âœ… Blindata Pos ${index + 1}: â‚¬${prezzoUnitario.toFixed(2)} (${bld.luceCalcolata})`);
                    } else {
                        console.warn(`âš ï¸ Pos ${index + 1}: Misure blindata non trovate`);
                    }
                }
                
                // ============================================================================
                // ğŸšª PORTONCINI FIN-DOOR FINSTRAL - v7.99
                // ============================================================================
                // Normalizza portoncino da ingresso.portoncino se non giÃ  presente
                if (pos.ingresso?.portoncino && !pos.portoncino) {
                    pos.portoncino = pos.ingresso.portoncino;
                    console.log(`   ğŸšª NORMALIZZATO pos ${index + 1}: ingresso.portoncino â†’ portoncino`);
                }
                
                const hasPortoncinoData = pos.portoncino && (
                    parseInt(pos.portoncino.BRM_L) > 0 || 
                    parseInt(pos.portoncino.BRM_H) > 0 || 
                    pos.portoncino.tipoApertura
                );
                
                if (hasPortoncinoData) {
                    const ptc = pos.portoncino;
                    const quantita = 1;
                    
                    const L_mm = parseInt(ptc.BRM_L) || 0;
                    const H_mm = parseInt(ptc.BRM_H) || 0;
                    
                    console.log(`ğŸšª Portoncino Pos ${index + 1}: BRM=${L_mm}Ã—${H_mm}mm, tipo=${ptc.tipoApertura}`);
                    
                    if (L_mm > 0 && H_mm > 0) {
                        const prezzoCalcolato = calcolaPrezzoPortoncinoFindoor(ptc);
                        const prezzoUnitario = prezzoCalcolato.totale || 0;
                        const totaleRiga = prezzoUnitario * quantita;
                        
                        const configDesc = [
                            `Tipo ${ptc.tipoApertura || '720'}`,
                            ptc.materialeInt && ptc.materialeEst ? `${ptc.materialeInt}-${ptc.materialeEst}` : '',
                            ptc.modelloAnta ? `Mod.${ptc.modelloAnta}` : ''
                        ].filter(x => x).join(' | ');
                        
                        righe.push({
                            posizione: index + 1,
                            ambiente: pos.ambiente || pos.nome || pos.stanza || `Pos ${index + 1}`,
                            tipo: `ğŸšª Portoncino ${ptc.tipoApertura || '720'}`,
                            azienda: 'Finstral',
                            telaio: configDesc,
                            larghezza: L_mm,
                            altezza: H_mm,
                            superficie: ((L_mm * H_mm) / 1000000).toFixed(2),
                            perimetro: '-',
                            prezzoBase: (prezzoCalcolato.prezzoBase || 0).toFixed(2),
                            supplementoTelaio: (prezzoCalcolato.supplementoModello || 0).toFixed(2),
                            supplementoAnta: (prezzoCalcolato.cilindro || 0).toFixed(2),
                            supplementoVetro: (prezzoCalcolato.cerniere || 0).toFixed(2),
                            supplementoColore: ((prezzoCalcolato.supplementoColoreInt || 0) + (prezzoCalcolato.supplementoColoreEst || 0)).toFixed(2),
                            supplementoManiglia: (prezzoCalcolato.maniglia || 0).toFixed(2),
                            supplementoMontante: (prezzoCalcolato.fonoassorbente || 0).toFixed(2),
                            prezzoUnitario: prezzoUnitario.toFixed(2),
                            quantita: quantita,
                            totale: totaleRiga.toFixed(2),
                            _tipoPortoncino: true,
                            _moltiplicatoreTipo: prezzoCalcolato.moltiplicatoreTipo
                        });
                        
                        totaleMateriali += totaleRiga;
                        numeroPezzi += quantita;
                        
                        console.log(`âœ… Portoncino Pos ${index + 1}: â‚¬${prezzoUnitario.toFixed(2)} (Ã—${prezzoCalcolato.moltiplicatoreTipo})`);
                    } else {
                        console.warn(`âš ï¸ Pos ${index + 1}: Misure portoncino non trovate`);
                    }
                }
            });
            
            console.log('ğŸ” Array righe DOPO forEach:', righe.length);
            console.log('ğŸ” Dettaglio righe create:');
            righe.forEach((r, i) => {
                console.log(`   Riga ${i + 1}: ${r.tipo} - ${r.azienda} - ${r.ambiente} - â‚¬${r.totale}`);
            });
            
            // ğŸ’° v8.14: Calcolo sconti fornitori per ogni riga
            const ricaricoPct = parseFloat(document.getElementById('ricaricoPct')?.value || 30);
            let totaleNetto = 0;
            let totaleCliente = 0;
            
            righe.forEach(riga => {
                const totaleListino = parseFloat(riga.totale) || 0;
                const sconto = SCONTI_FORNITORI.getSconto(riga.azienda);
                const netto = totaleListino * (1 - sconto / 100);
                const cliente = netto * (1 + ricaricoPct / 100);
                
                riga._scontoPerc = sconto.toFixed(0);
                riga._totaleNetto = netto.toFixed(2);
                riga._totaleCliente = cliente.toFixed(2);
                
                totaleNetto += netto;
                totaleCliente += cliente;
                
                console.log(`ğŸ’° ${riga.azienda}: â‚¬${totaleListino} -${sconto}% = â‚¬${netto.toFixed(2)} +${ricaricoPct}% = â‚¬${cliente.toFixed(2)}`);
            });
            
            // Calcola posa e smontaggio
            const posa = numeroPezzi * COSTI_EXTRA.posa_per_pezzo;
            const smontaggio = numeroPezzi * COSTI_EXTRA.smontaggio_per_pezzo;
            
            // Posa e smontaggio: applica ricarico
            const posaNetto = posa;  // Nessuno sconto sulla posa
            const posaCliente = posa * (1 + ricaricoPct / 100);
            const smontaggioNetto = smontaggio;
            const smontaggioCliente = smontaggio * (1 + ricaricoPct / 100);
            
            const subtotale = totaleMateriali + posa + smontaggio;
            
            // IVA (calcolata dopo in ricalcolaTotaliPreventivo)
            const ivaPercent = 0; // v8.16: IVA gestita separatamente in base a tipo intervento
            const iva = subtotale * (ivaPercent / 100);
            const totale = subtotale + iva;
            
            console.log(`ğŸ’° TOTALI: Listino â‚¬${totaleMateriali.toFixed(2)} | Netto â‚¬${totaleNetto.toFixed(2)} | Cliente â‚¬${totaleCliente.toFixed(2)} | Ricarico ${ricaricoPct}%`);
            
            return {
                righe: righe,
                totaleMateriali: totaleMateriali,
                _totaleNetto: totaleNetto,
                _totaleCliente: totaleCliente,
                _ricaricoPct: ricaricoPct,
                posa: posa,
                _posaNetto: posaNetto,
                _posaCliente: posaCliente,
                smontaggio: smontaggio,
                _smontaggioNetto: smontaggioNetto,
                _smontaggioCliente: smontaggioCliente,
                subtotale: subtotale,
                ivaPercent: ivaPercent,
                iva: iva,
                totale: totale
            };
        }

        function popolaTabellaPreventivo(preventivo) {
            console.log('ğŸ“‹ popolaTabellaPreventivo() chiamata');
            console.log('ğŸ“‹ Righe ricevute:', preventivo.righe.length);
            console.log('ğŸ“‹ Dettaglio righe:', preventivo.righe.map(r => `${r.tipo}-${r.azienda}`).join(', '));
            
            const tbody = document.getElementById('preventivoTableBody');
            if (!tbody) {
                console.error('âŒ Tabella preventivo non trovata');
                return;
            }
            
            tbody.innerHTML = '';
            
            // ğŸ†• v7.82: Salva righe per click handler
            // ğŸ› v8.21 FIX: Esplicito window. per visibilitÃ  globale
            window.righePreventivo = preventivo.righe;
            
            console.log('ğŸ“‹ tbody.innerHTML cleared');
            
            // Popola righe
            preventivo.righe.forEach((riga, index) => {
                const tr = document.createElement('tr');
                
                // ğŸ†• v7.996: TUTTI i tipi sono cliccabili per dettaglio (incluso cassonetto)
                // ğŸ”Œ v8.09: Aggiunto Motore
                const isTapparella = riga.tipo.toLowerCase().includes('tapparella');
                const isPersiana = riga.tipo.toLowerCase().includes('persiana');
                const isCassonetto = riga.tipo.toLowerCase().includes('cassonetto');
                const isMotore = riga.tipo.toLowerCase().includes('motore') || riga._tipoMotore;
                const isInfisso = riga.tipo.toLowerCase().includes('infisso') || 
                                  riga.tipo.toLowerCase().includes('finestra') ||
                                  riga.tipo.toLowerCase().includes('porta');
                const isBlindato = riga.tipo.toLowerCase().includes('blindata') || riga._tipoBlindato;
                const isPortoncino = riga.tipo.toLowerCase().includes('portoncino') || riga._tipoPortoncino;
                const isClickable = isTapparella || isPersiana || isCassonetto || isInfisso || isBlindato || isPortoncino || isMotore;
                
                if (isClickable) {
                    tr.style.cursor = 'pointer';
                    tr.title = 'ğŸ” Clicca per vedere il dettaglio costi';
                    // Colori hover diversi per tipo
                    // ğŸ”Œ v8.09: Motore = arancione chiaro #ffedd5
                    const hoverColor = isTapparella ? '#fef3c7' : isPersiana ? '#f3e8ff' : isCassonetto ? '#ffedd5' : isBlindato ? '#fee2e2' : isPortoncino ? '#fce7f3' : isMotore ? '#fed7aa' : '#dbeafe';
                    tr.onmouseover = function() { this.style.background = hoverColor; };
                    tr.onmouseout = function() { this.style.background = ''; };
                    
                    // ğŸ†• v7.82 FIX: Usa window. e salva posizione in variabile locale
                    const posIdx = riga.posizione;
                    const rigaCopia = Object.assign({}, riga); // Copia per closure
                    tr.onclick = function() {
                        if (isMotore) {
                            console.log('ğŸ–±ï¸ Click su motore pos', posIdx);
                            window.mostraDettaglioCostiMotore(posIdx, rigaCopia);
                        } else if (isPortoncino) {
                            console.log('ğŸ–±ï¸ Click su portoncino pos', posIdx);
                            window.mostraDettaglioCostiPortoncino(posIdx, rigaCopia);
                        } else if (isBlindato) {
                            console.log('ğŸ–±ï¸ Click su blindata pos', posIdx);
                            window.mostraDettaglioCostiBlindato(posIdx, rigaCopia);
                        } else if (isCassonetto) {
                            console.log('ğŸ–±ï¸ Click su cassonetto pos', posIdx);
                            window.mostraDettaglioCostiCassonetto(posIdx, rigaCopia);
                        } else if (isTapparella) {
                            console.log('ğŸ–±ï¸ Click su tapparella pos', posIdx);
                            window.mostraDettaglioCostiTapparella(posIdx, rigaCopia);
                        } else if (isPersiana) {
                            console.log('ğŸ–±ï¸ Click su persiana pos', posIdx);
                            window.mostraDettaglioCostiPersiana(posIdx, rigaCopia);
                        } else if (isInfisso) {
                            console.log('ğŸ–±ï¸ Click su infisso pos', posIdx);
                            window.mostraDettaglioCostiInfisso(posIdx, rigaCopia);
                        }
                    };
                }
                
                tr.innerHTML = `
                    <td>${riga.posizione}</td>
                    <td style="text-align: left;">${riga.ambiente}</td>
                    <td>${riga.tipo}${isClickable ? ' <span style="font-size: 0.7rem; color: #3b82f6;">ğŸ”</span>' : ''}</td>
                    <td>${riga.azienda}</td>
                    <td>${riga.telaio}</td>
                    <td>${riga.larghezza}</td>
                    <td>${riga.altezza}</td>
                    <td>${riga.superficie}</td>
                    <td>${riga.perimetro}</td>
                    <td>â‚¬ ${riga.prezzoBase}</td>
                    <td>â‚¬ ${riga.supplementoTelaio}</td>
                    <td>â‚¬ ${riga.supplementoAnta}</td>
                    <td>â‚¬ ${riga.supplementoVetro}</td>
                    <td>â‚¬ ${riga.supplementoColore || '0.00'}</td>
                    <td>â‚¬ ${riga.supplementoManiglia}</td>
                    <td>â‚¬ ${riga.supplementoMontante || '0.00'}</td>
                    <td>${riga.quantita}</td>
                    <td style="background: #fef3c7;">â‚¬ ${riga.totale}</td>
                    <td style="background: #d1fae5; color: #059669; font-size: 0.7rem;">${riga._scontoPerc || 0}%</td>
                    <td style="background: #d1fae5; font-weight: 600; color: #059669;">â‚¬ ${riga._totaleNetto || riga.totale}</td>
                    <td style="background: #dbeafe; font-weight: 700; color: #1d4ed8;">â‚¬ ${riga._totaleCliente || riga.totale}</td>
                `;
                tbody.appendChild(tr);
                console.log(`ğŸ“‹ Riga aggiunta: ${riga.posizione} - ${riga.tipo} - ${riga.azienda}${isClickable ? ' (cliccabile)' : ''}`);
            });
            
            // Aggiorna totali - v8.14 con sconti
            const totListino = preventivo.totaleMateriali;
            const totNetto = preventivo._totaleNetto || totListino;
            const totCliente = preventivo._totaleCliente || totListino;
            const margine = totCliente - totNetto;
            
            // Salva totali materiali in variabili globali per ricalcolo
            window._preventivoMateriali = {
                listino: totListino,
                netto: totNetto,
                cliente: totCliente,
                ricaricoPct: preventivo._ricaricoPct || 30,
                ivaPercent: preventivo.ivaPercent
            };
            
            // Popola totali materiali
            document.getElementById('totaleListino').textContent = `â‚¬ ${totListino.toFixed(2)}`;
            document.getElementById('totaleNetto').textContent = `â‚¬ ${totNetto.toFixed(2)}`;
            document.getElementById('totaleCliente').textContent = `â‚¬ ${totCliente.toFixed(2)}`;
            
            // ğŸ”§ v8.15: Calcola costi lavoro suggeriti da righe preventivo
            const costiSuggeriti = COSTI_LAVORO.calcolaTotaliDaRighe(preventivo.righe);
            
            // Mostra suggerimenti
            document.getElementById('posaSuggerito').textContent = `sugg. â‚¬${costiSuggeriti.posa}`;
            document.getElementById('smontaggioSuggerito').textContent = `sugg. â‚¬${costiSuggeriti.smontaggio}`;
            document.getElementById('smaltimentoSuggerito').textContent = `sugg. â‚¬${costiSuggeriti.smaltimento}`;
            document.getElementById('componentiSuggerito').textContent = `sugg. â‚¬${costiSuggeriti.componenti}`;
            
            // Imposta input ai valori suggeriti (l'utente puÃ² modificare)
            document.getElementById('inputPosa').value = costiSuggeriti.posa;
            document.getElementById('inputSmontaggio').value = costiSuggeriti.smontaggio;
            document.getElementById('inputSmaltimento').value = costiSuggeriti.smaltimento;
            document.getElementById('inputComponenti').value = costiSuggeriti.componenti;
            
            // Salva anche i suggeriti per riferimento
            window._costiLavoroSuggeriti = costiSuggeriti;
            
            // Ricalcola totali con valori suggeriti
            ricalcolaTotaliPreventivo();
            
            console.log(`âœ… Tabella preventivo popolata: ${preventivo.righe.length} righe`);
            console.log(`ğŸ’° Listino: â‚¬${totListino.toFixed(2)} | Netto: â‚¬${totNetto.toFixed(2)} | Cliente: â‚¬${totCliente.toFixed(2)}`);
            console.log(`ğŸ”§ Costi lavoro suggeriti: Posa â‚¬${costiSuggeriti.posa} | Smontaggio â‚¬${costiSuggeriti.smontaggio} | Smaltimento â‚¬${costiSuggeriti.smaltimento} | Componenti â‚¬${costiSuggeriti.componenti}`);
        }
        
        /**
         * ğŸ’° v8.15: Ricalcola totali quando cambiano posa/smontaggio/smaltimento/componenti/ricarico
         */
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ“Š MODULO IVA MISTA - BENI SIGNIFICATIVI (Art. 7 L. 488/1999) - v8.16
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Riferimenti normativi:
        // - Art. 7, comma 1, lettera b) Legge 488/1999
        // - D.M. 29 dicembre 1999 (elenco beni significativi)
        // - Circolare Agenzia Entrate n. 15/E del 12/07/2018
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const CLASSIFICAZIONE_FISCALE = {
            // Tipi che rientrano nei BENI SIGNIFICATIVI (IVA mista 10%/22%)
            beniSignificativi: [
                'Infisso', 'Portafinestra', 'Finestra', 'Portoncino', 'Blindata', 'Scorrevole'
            ],
            // Parti che seguono il bene principale SE fornite insieme
            partiIntegrabili: ['Zanzariera'],
            // Parti SEMPRE autonome â†’ tutto al 10%
            partiAutonome: [
                'Cassonetto', 'Persiana', 'Tapparella', 'Scuro', 'Veneziana', 'Grata', 'Inferriata', 'Motore'
            ],
            // Configurazione: zanzariere integrate con infisso
            zanzariereIntegrate: true
        };
        
        /**
         * Classifica un prodotto in base al tipo dalla riga preventivo
         */
        function classificaProdottoFiscale(tipoRiga, fornitaConInfisso = true) {
            if (!tipoRiga) return 'parte_autonoma';
            const tipoUpper = tipoRiga.toUpperCase();
            
            // Controlla se Ã¨ un bene significativo
            for (const bs of CLASSIFICAZIONE_FISCALE.beniSignificativi) {
                if (tipoUpper.includes(bs.toUpperCase())) {
                    return 'bene_significativo';
                }
            }
            
            // Controlla zanzariere (caso speciale)
            if (tipoUpper.includes('ZANZARIERA')) {
                if (CLASSIFICAZIONE_FISCALE.zanzariereIntegrate && fornitaConInfisso) {
                    return 'bene_significativo';
                }
                return 'parte_autonoma';
            }
            
            // Controlla parti autonome
            for (const pa of CLASSIFICAZIONE_FISCALE.partiAutonome) {
                if (tipoUpper.includes(pa.toUpperCase())) {
                    return 'parte_autonoma';
                }
            }
            
            return 'parte_autonoma';
        }
        
        /**
         * Calcola la ripartizione IVA mista secondo normativa beni significativi
         */
        function calcolaIVAMista(righe, lavori, ricaricoPct = 30, enea = 0) {
            let totaleBeniSignificativi = 0;
            let totalePartiAutonome = 0;
            let dettaglioBeniSignif = [];
            let dettaglioPartiAutonome = [];
            
            const moltiplicatore = 1 + (ricaricoPct / 100);
            
            console.log('ğŸ“Š calcolaIVAMista v8.26 - Analisi righe:', righe.length, '| ENEA:', enea);
            
            righe.forEach(riga => {
                // Usa prezzo CLIENTE (listino * ricarico)
                const totaleListino = parseFloat(riga.totale) || 0;
                const totaleCliente = totaleListino * moltiplicatore;
                const classificazione = classificaProdottoFiscale(riga.tipo, true);
                
                console.log(`   - ${riga.tipo}: â‚¬${totaleListino.toFixed(2)} â†’ â‚¬${totaleCliente.toFixed(2)} [${classificazione}]`);
                
                if (classificazione === 'bene_significativo') {
                    totaleBeniSignificativi += totaleCliente;
                    dettaglioBeniSignif.push({ tipo: riga.tipo, posizione: riga.posizione, totale: totaleCliente });
                } else {
                    totalePartiAutonome += totaleCliente;
                    dettaglioPartiAutonome.push({ tipo: riga.tipo, posizione: riga.posizione, totale: totaleCliente });
                }
            });
            
            // Calcola totale manodopera (giÃ  prezzi cliente passati)
            const totaleManodopera = (parseFloat(lavori.posa) || 0) +
                                    (parseFloat(lavori.smontaggio) || 0) +
                                    (parseFloat(lavori.smaltimento) || 0) +
                                    (parseFloat(lavori.componenti) || 0);
            
            console.log(`ğŸ“Š Totali: Beni Signif â‚¬${totaleBeniSignificativi.toFixed(2)} | Parti Aut â‚¬${totalePartiAutonome.toFixed(2)} | Manodop â‚¬${totaleManodopera.toFixed(2)} | ENEA â‚¬${enea.toFixed(2)}`);
            
            // Calcola valore prestazione (tutto tranne beni significativi)
            const valorePrestazione = totalePartiAutonome + totaleManodopera;
            const totaleIntervento = totaleBeniSignificativi + valorePrestazione + enea;
            
            // Applica formula normativa
            let beniSignif10 = 0;
            let beniSignif22 = 0;
            
            if (totaleBeniSignificativi <= valorePrestazione) {
                beniSignif10 = totaleBeniSignificativi;
                beniSignif22 = 0;
            } else {
                beniSignif10 = valorePrestazione;
                beniSignif22 = totaleBeniSignificativi - valorePrestazione;
            }
            
            // Calcola imponibili e IVA (ENEA va sempre al 22%)
            const imponibile10 = beniSignif10 + totalePartiAutonome + totaleManodopera;
            const imponibile22 = beniSignif22 + enea;
            
            const iva10 = imponibile10 * 0.10;
            const iva22 = imponibile22 * 0.22;
            const ivaTotale = iva10 + iva22;
            const totaleConIVA = totaleIntervento + ivaTotale;
            
            return {
                beniSignificativi: { totale: totaleBeniSignificativi, quota10: beniSignif10, quota22: beniSignif22, dettaglio: dettaglioBeniSignif },
                partiAutonome: { totale: totalePartiAutonome, dettaglio: dettaglioPartiAutonome },
                manodopera: { totale: totaleManodopera, dettaglio: lavori },
                enea: enea,
                totaleIntervento, valorePrestazione,
                imponibile10, imponibile22,
                iva10, iva22, ivaTotale, totaleConIVA,
                haIVAMista: imponibile22 > 0
            };
        }
        
        /**
         * Verifica tipo IVA per intervento
         */
        function getTipoIVAIntervento(tipoIntervento) {
            switch (tipoIntervento) {
                case 'manutenzione':
                    return { applicaIVAMista: true, aliquotaUnica: null, note: 'IVA mista con beni significativi' };
                case 'ristrutturazione':
                    return { applicaIVAMista: false, aliquotaUnica: 10, note: 'Ristrutturazione - IVA 10%' };
                case 'nuova_costruzione_prima':
                    return { applicaIVAMista: false, aliquotaUnica: 4, note: 'Prima casa - IVA 4%' };
                case 'nuova_costruzione_altra':
                    return { applicaIVAMista: false, aliquotaUnica: 10, note: 'Altra abitazione - IVA 10%' };
                case 'sola_fornitura':
                    return { applicaIVAMista: false, aliquotaUnica: 22, note: 'Sola fornitura - IVA 22%' };
                default:
                    return { applicaIVAMista: false, aliquotaUnica: 0, note: 'Nessuna IVA' };
            }
        }
        
        console.log('ğŸ“Š Modulo IVA Mista caricato - v8.17');
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FINE MODULO IVA MISTA
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function ricalcolaTotaliPreventivo() {
            const mat = window._preventivoMateriali;
            if (!mat) return;
            
            const ricaricoPct = parseFloat(document.getElementById('ricaricoPct')?.value || 30);
            const tipoIntervento = document.getElementById('tipoInterventoSelect')?.value || 'nessuna';
            
            // Tutti i costi lavoro dagli input
            const posa = parseFloat(document.getElementById('inputPosa')?.value || 0);
            const smontaggio = parseFloat(document.getElementById('inputSmontaggio')?.value || 0);
            const smaltimento = parseFloat(document.getElementById('inputSmaltimento')?.value || 0);
            const componenti = parseFloat(document.getElementById('inputComponenti')?.value || 0);
            
            // ENEA Ecobonus (v8.26)
            const eneaChecked = document.getElementById('checkENEA')?.checked || false;
            const eneaValore = eneaChecked ? parseFloat(document.getElementById('inputENEA')?.value || 0) : 0;
            
            // Costi lavoro: netto = cliente = SENZA ricarico (v8.26)
            const posaNetto = posa;
            const posaCliente = posa;
            const smontaggioNetto = smontaggio;
            const smontaggioCliente = smontaggio;
            const smaltimentoNetto = smaltimento;
            const smaltimentoCliente = smaltimento;
            const componentiNetto = componenti;
            const componentiCliente = componenti;
            
            // Totale lavori
            const lavoriListino = posa + smontaggio + smaltimento + componenti;
            const lavoriNetto = posaNetto + smontaggioNetto + smaltimentoNetto + componentiNetto;
            const lavoriCliente = posaCliente + smontaggioCliente + smaltimentoCliente + componentiCliente;
            
            // Subtotali (incluso ENEA)
            const subtotaleListino = mat.listino + lavoriListino + eneaValore;
            const subtotaleNetto = mat.netto + lavoriNetto + eneaValore;
            const subtotaleCliente = mat.cliente + lavoriCliente + eneaValore;
            
            // Margine
            const margineTotale = subtotaleCliente - subtotaleNetto;
            
            // Aggiorna DOM - Posa
            document.getElementById('totalePosaListino').textContent = `â‚¬ ${posa.toFixed(2)}`;
            document.getElementById('totalePosaNetto').textContent = `â‚¬ ${posaNetto.toFixed(2)}`;
            document.getElementById('totalePosaCliente').textContent = `â‚¬ ${posaCliente.toFixed(2)}`;
            
            // Smontaggio
            document.getElementById('totaleSmontaggioListino').textContent = `â‚¬ ${smontaggio.toFixed(2)}`;
            document.getElementById('totaleSmontaggioNetto').textContent = `â‚¬ ${smontaggioNetto.toFixed(2)}`;
            document.getElementById('totaleSmontaggioCliente').textContent = `â‚¬ ${smontaggioCliente.toFixed(2)}`;
            
            // Smaltimento
            document.getElementById('totaleSmaltimentoListino').textContent = `â‚¬ ${smaltimento.toFixed(2)}`;
            document.getElementById('totaleSmaltimentoNetto').textContent = `â‚¬ ${smaltimentoNetto.toFixed(2)}`;
            document.getElementById('totaleSmaltimentoCliente').textContent = `â‚¬ ${smaltimentoCliente.toFixed(2)}`;
            
            // Componenti
            document.getElementById('totaleComponentiListino').textContent = `â‚¬ ${componenti.toFixed(2)}`;
            document.getElementById('totaleComponentiNetto').textContent = `â‚¬ ${componentiNetto.toFixed(2)}`;
            document.getElementById('totaleComponentiCliente').textContent = `â‚¬ ${componentiCliente.toFixed(2)}`;
            
            // ENEA (v8.26)
            document.getElementById('totaleENEAListino').textContent = `â‚¬ ${eneaValore.toFixed(2)}`;
            document.getElementById('totaleENEANetto').textContent = `â‚¬ ${eneaValore.toFixed(2)}`;
            document.getElementById('totaleENEACliente').textContent = `â‚¬ ${eneaValore.toFixed(2)}`;
            const inputENEA = document.getElementById('inputENEA');
            if (inputENEA) inputENEA.disabled = !eneaChecked;
            
            // Totale lavori
            document.getElementById('totaleLavoriListino').textContent = `â‚¬ ${lavoriListino.toFixed(2)}`;
            document.getElementById('totaleLavoriNetto').textContent = `â‚¬ ${lavoriNetto.toFixed(2)}`;
            document.getElementById('totaleLavoriCliente').textContent = `â‚¬ ${lavoriCliente.toFixed(2)}`;
            
            // Subtotali
            document.getElementById('subtotaleListino').textContent = `â‚¬ ${subtotaleListino.toFixed(2)}`;
            document.getElementById('subtotaleNetto').textContent = `â‚¬ ${subtotaleNetto.toFixed(2)}`;
            document.getElementById('subtotaleCliente').textContent = `â‚¬ ${subtotaleCliente.toFixed(2)}`;
            
            // Margine
            document.getElementById('totaleMargineLordo').textContent = `â‚¬ ${margineTotale.toFixed(2)}`;
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ†• v8.16: GESTIONE IVA PER TIPO INTERVENTO
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            // Nascondi tutte le righe IVA
            const righeIVA = [
                'rowSeparatoreFiscale', 'rowBeniSignif10', 'rowBeniSignif22',
                'rowPartiAutonome', 'rowManodoperaFiscale', 'rowSepImponibili',
                'rowImponibile10', 'rowImponibile22', 'rowIVA10', 'rowIVA22', 'rowIVA'
            ];
            righeIVA.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            
            // Aggiorna label tipo IVA
            const labelTipoIVA = document.getElementById('labelTipoIVA');
            
            // Determina tipo IVA da applicare
            const configIVA = getTipoIVAIntervento(tipoIntervento);
            
            let grandTotalCliente = subtotaleCliente;
            let grandTotalListino = subtotaleListino;
            let grandTotalNetto = subtotaleNetto;
            
            if (tipoIntervento === 'nessuna') {
                // Nessuna IVA
                if (labelTipoIVA) labelTipoIVA.textContent = '(senza IVA)';
                
            } else if (configIVA.applicaIVAMista) {
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // IVA MISTA - BENI SIGNIFICATIVI
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                if (labelTipoIVA) labelTipoIVA.textContent = 'ğŸ“Š Beni signif.';
                
                // Usa le righe del preventivo salvate
                const righe = window.righePreventivo || [];
                
                // Calcola IVA mista (v8.26: ENEA al 22%)
                const calcolo = calcolaIVAMista(righe, {
                    posa: posaCliente,
                    smontaggio: smontaggioCliente,
                    smaltimento: smaltimentoCliente,
                    componenti: componentiCliente
                }, ricaricoPct, eneaValore);
                
                // Mostra righe riepilogo fiscale
                document.getElementById('rowSeparatoreFiscale').style.display = 'table-row';
                document.getElementById('rowBeniSignif10').style.display = 'table-row';
                document.getElementById('rowPartiAutonome').style.display = 'table-row';
                document.getElementById('rowManodoperaFiscale').style.display = 'table-row';
                document.getElementById('rowSepImponibili').style.display = 'table-row';
                document.getElementById('rowImponibile10').style.display = 'table-row';
                document.getElementById('rowIVA10').style.display = 'table-row';
                
                // Popola valori
                document.getElementById('valBeniSignif10').textContent = `â‚¬ ${calcolo.beniSignificativi.quota10.toFixed(2)}`;
                document.getElementById('valPartiAutonome').textContent = `â‚¬ ${calcolo.partiAutonome.totale.toFixed(2)}`;
                document.getElementById('valManodoperaFiscale').textContent = `â‚¬ ${calcolo.manodopera.totale.toFixed(2)}`;
                document.getElementById('valImponibile10').textContent = `â‚¬ ${calcolo.imponibile10.toFixed(2)}`;
                document.getElementById('valIVA10').textContent = `â‚¬ ${calcolo.iva10.toFixed(2)}`;
                
                // Se c'Ã¨ quota 22%, mostra anche quelle righe
                if (calcolo.haIVAMista) {
                    document.getElementById('rowBeniSignif22').style.display = 'table-row';
                    document.getElementById('rowImponibile22').style.display = 'table-row';
                    document.getElementById('rowIVA22').style.display = 'table-row';
                    
                    document.getElementById('valBeniSignif22').textContent = `â‚¬ ${calcolo.beniSignificativi.quota22.toFixed(2)}`;
                    document.getElementById('valImponibile22').textContent = `â‚¬ ${calcolo.imponibile22.toFixed(2)}`;
                    document.getElementById('valIVA22').textContent = `â‚¬ ${calcolo.iva22.toFixed(2)}`;
                }
                
                grandTotalCliente = calcolo.totaleConIVA;
                
                // Salva calcolo per export
                window._calcoloIVAMista = calcolo;
                
                console.log('ğŸ“Š IVA Mista calcolata:', calcolo);
                
            } else if (configIVA.aliquotaUnica > 0) {
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // IVA ALIQUOTA UNICA (4%, 10%, 22%) - v8.26: ENEA sempre al 22%
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const aliquota = configIVA.aliquotaUnica;
                if (labelTipoIVA) labelTipoIVA.textContent = `IVA ${aliquota}%`;
                
                // Mostra riga IVA singola
                const rowIVA = document.getElementById('rowIVA');
                if (rowIVA) rowIVA.style.display = 'table-row';
                document.getElementById('ivaPercent').textContent = aliquota;
                
                // v8.26: ENEA sempre al 22%, resto all'aliquota selezionata
                const baseCliente = subtotaleCliente - eneaValore;
                const baseListino = subtotaleListino - eneaValore;
                const baseNetto = subtotaleNetto - eneaValore;
                
                const ivaBaseCliente = baseCliente * aliquota / 100;
                const ivaEnea = eneaValore * 0.22;
                const ivaCliente = ivaBaseCliente + ivaEnea;
                
                const ivaListino = baseListino * aliquota / 100 + ivaEnea;
                const ivaNetto = baseNetto * aliquota / 100 + ivaEnea;
                
                document.getElementById('totaleIVAListino').textContent = `â‚¬ ${ivaListino.toFixed(2)}`;
                document.getElementById('totaleIVANetto').textContent = `â‚¬ ${ivaNetto.toFixed(2)}`;
                document.getElementById('totaleIVACliente').textContent = `â‚¬ ${ivaCliente.toFixed(2)}`;
                
                grandTotalCliente = subtotaleCliente + ivaCliente;
                grandTotalListino = subtotaleListino + ivaListino;
                grandTotalNetto = subtotaleNetto + ivaNetto;
            }
            
            // Aggiorna totali finali
            document.getElementById('grandTotalListino').textContent = `â‚¬ ${grandTotalListino.toFixed(2)}`;
            document.getElementById('grandTotalNetto').textContent = `â‚¬ ${grandTotalNetto.toFixed(2)}`;
            document.getElementById('grandTotalCliente').textContent = `â‚¬ ${grandTotalCliente.toFixed(2)}`;
            
            console.log(`ğŸ’° Ricalcolo v8.26: Tipo=${tipoIntervento} | Subtot â‚¬${subtotaleCliente.toFixed(2)} | ENEA â‚¬${eneaValore.toFixed(2)} | Tot â‚¬${grandTotalCliente.toFixed(2)}`);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v7.82 DETTAGLIO COSTI - BREAKDOWN SINGOLA RIGA
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * ğŸ†• v7.82: Estrae codice da stringa tipo "TA01 - Tipo ALUPROFIL MD 13x55" â†’ "TA01"
         */
        function estraiCodiceProdotto(stringa) {
            if (!stringa) return null;
            // Prende la parte prima del " - " o prima dello spazio se non c'Ã¨ " - "
            const parti = String(stringa).split(' - ');
            return parti[0].trim();
        }
        
        /**
         * Mostra dettaglio costi per TAPPARELLA
         * @param {number} posIndex - Indice posizione (1-based)
         * @param {object} rigaPreventivo - Dati riga dal preventivo (opzionale)
         */
        /**
         * ğŸ†• v7.89: Mostra dettaglio costi tapparella
         * USA SOLO I DATI GIÃ€ CALCOLATI NEL PREVENTIVO - NON RICALCOLA!
         * @param {number} posIndex - Indice posizione (1-based)
         * @param {object} rigaPreventivo - Dati riga dal preventivo
         */
        function mostraDettaglioCostiTapparella(posIndex, rigaPreventivo = {}) {
            try {
                console.log(`ğŸ“Š v7.89 Dettaglio Tapparella Pos ${posIndex} - DATI DA PREVENTIVO:`, rigaPreventivo);
                
                // ğŸ†• v7.89: USA DIRETTAMENTE I DATI DEL PREVENTIVO!
                // Non ricalcoliamo nulla, trascriviamo solo quello che c'Ã¨ giÃ 
                const L_mm = rigaPreventivo.larghezza || 0;
                const H_mm = rigaPreventivo.altezza || 0;
                const superficie = rigaPreventivo.superficie || '0.00';
                const modelloTelo = rigaPreventivo.telaio || 'N/D';
                const azienda = rigaPreventivo.azienda || 'Plasticino';
                const ambiente = rigaPreventivo.ambiente || `Pos ${posIndex}`;
                
                // Prezzi dal preventivo (giÃ  calcolati)
                const prezzoTelo = parseFloat(rigaPreventivo.prezzoBase) || 0;
                const prezzoRullo = parseFloat(rigaPreventivo.supplementoTelaio) || 0;
                const prezzoFissi = parseFloat(rigaPreventivo.supplementoAnta) || 0;
                const prezzoSuppAltezza = parseFloat(rigaPreventivo.supplementoVetro) || 0;
                const prezzoGuida = parseFloat(rigaPreventivo.supplementoManiglia) || 0;
                const totale = parseFloat(rigaPreventivo.totale) || 0;
                const quantita = parseInt(rigaPreventivo.quantita) || 1;
                const prezzoUnitario = parseFloat(rigaPreventivo.prezzoUnitario) || totale;
                
                // Calcola prezzo al mq per visualizzazione
                const superficieMq = parseFloat(superficie) || 1;
                const prezzoMq = superficieMq > 0 ? (prezzoTelo / superficieMq) : 60;
                
                let dettaglioHTML = `
                <div style="padding: 1.5rem;">
                    <!-- HEADER -->
                    <div style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0; font-size: 1.25rem;">ğŸšï¸ Tapparella - Posizione ${posIndex}</h3>
                                <p style="margin: 0.25rem 0 0 0; opacity: 0.9;">${ambiente}</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.5rem; font-weight: 700;">â‚¬ ${totale.toFixed(2)}</div>
                                <div style="font-size: 0.875rem; opacity: 0.9;">Totale${quantita > 1 ? ` (${quantita} pz)` : ''}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- MISURE -->
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #0369a1;">ğŸ“ Misure</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Larghezza</div>
                                <div style="font-size: 1.25rem; font-weight: 600;">${L_mm} mm</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Altezza</div>
                                <div style="font-size: 1.25rem; font-weight: 600;">${H_mm} mm</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Superficie</div>
                                <div style="font-size: 1.25rem; font-weight: 600;">${superficie} mÂ²</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BREAKDOWN COSTI -->
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; margin-bottom: 1rem;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Componente</th>
                                    <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid #e5e7eb;">Dettaglio</th>
                                    <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #e5e7eb;">Importo</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- TELO -->
                                <tr style="background: #fefce8;">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ¨ Telo Avvolgibile</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">${modelloTelo}</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #e5e7eb; font-family: monospace;">
                                        ${superficie} mÂ² Ã— â‚¬${prezzoMq.toFixed(2)}/mÂ²
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #ca8a04;">
                                        â‚¬ ${prezzoTelo.toFixed(2)}
                                    </td>
                                </tr>
                                
                                <!-- RULLO -->
                                <tr>
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ”„ Rullo Ottagonale 60mm</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">COMP-01</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #e5e7eb; font-family: monospace;">
                                        ${(L_mm / 1000).toFixed(2)} m Ã— â‚¬13.20/m
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #2563eb;">
                                        â‚¬ ${prezzoRullo.toFixed(2)}
                                    </td>
                                </tr>
                                
                                <!-- COMPONENTI FISSI -->
                                <tr style="background: #f9fafb;">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ”§ Componenti Fissi</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">COMP-02 a COMP-10</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #e5e7eb;">
                                        <details style="cursor: pointer;">
                                            <summary style="font-size: 0.8rem; color: #6b7280;">Vedi dettaglio â–¼</summary>
                                            <div style="text-align: left; margin-top: 0.5rem; font-size: 0.75rem; line-height: 1.4;">
                                                Calotta: â‚¬15.00<br>
                                                Avvolgitore: â‚¬10.00<br>
                                                Cuscinetto: â‚¬3.50<br>
                                                Supporti x2: â‚¬6.00<br>
                                                Ganci x2: â‚¬7.20<br>
                                                Placca: â‚¬5.00<br>
                                                Passacinghia: â‚¬1.70<br>
                                                Macchinetta: â‚¬18.00
                                            </div>
                                        </details>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #059669;">
                                        â‚¬ ${prezzoFissi.toFixed(2)}
                                    </td>
                                </tr>
                                
                                ${prezzoSuppAltezza > 0 ? `
                                <!-- SUPPLEMENTO ALTEZZA -->
                                <tr>
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ“ Supplemento Altezza</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">H > 300cm</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #e5e7eb;">
                                        -
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #dc2626;">
                                        â‚¬ ${prezzoSuppAltezza.toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                ${prezzoGuida > 0 ? `
                                <!-- GUIDA -->
                                <tr style="background: #fef3c7;">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ“ Guida</strong>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #e5e7eb;">
                                        Coppia (CP)
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #d97706;">
                                        â‚¬ ${prezzoGuida.toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                <!-- TOTALE -->
                                <tr style="background: #dcfce7;">
                                    <td colspan="2" style="padding: 1rem; text-align: right; font-weight: 700; font-size: 1.1rem;">
                                        TOTALE TAPPARELLA
                                    </td>
                                    <td style="padding: 1rem; text-align: right; font-weight: 700; font-size: 1.25rem; color: #059669;">
                                        â‚¬ ${totale.toFixed(2)}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- INFO AGGIUNTIVE -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.85rem;">
                        <div style="background: #f9fafb; padding: 0.75rem; border-radius: 0.375rem;">
                            <strong>ğŸ­ Azienda:</strong> ${azienda}
                        </div>
                        <div style="background: #f9fafb; padding: 0.75rem; border-radius: 0.375rem;">
                            <strong>ğŸ¨ Modello:</strong> ${modelloTelo}
                        </div>
                    </div>
                </div>
            `;
            
            // Mostra modal
            mostraModalDettaglioCosti('Tapparella', dettaglioHTML);
            } catch (e) {
                console.error('âŒ Errore in mostraDettaglioCostiTapparella:', e);
                alert('Errore dettaglio costi: ' + e.message);
            }
        }

        /**
         * ğŸ†• v7.89: Mostra dettaglio costi INFISSO
         * USA SOLO I DATI GIÃ€ CALCOLATI NEL PREVENTIVO - NON RICALCOLA!
         */
        function mostraDettaglioCostiInfisso(posIndex, rigaPreventivo = {}) {
            try {
                console.log(`ğŸ“Š v7.89 Dettaglio Infisso Pos ${posIndex} - DATI DA PREVENTIVO:`, rigaPreventivo);
                
                // Dati dal preventivo
                const L_mm = rigaPreventivo.larghezza || 0;
                const H_mm = rigaPreventivo.altezza || 0;
                const superficie = rigaPreventivo.superficie || '0.00';
                const perimetro = rigaPreventivo.perimetro || '-';
                const telaio = rigaPreventivo.telaio || 'N/D';
                const tipoAnta = rigaPreventivo.tipoAnta || '';  // âœ… v8.10: Tipo anta separato
                const azienda = rigaPreventivo.azienda || 'N/D';
                const ambiente = rigaPreventivo.ambiente || `Pos ${posIndex}`;
                const tipo = rigaPreventivo.tipo || 'Infisso';
                
                // Prezzi dal preventivo
                const prezzoBase = parseFloat(rigaPreventivo.prezzoBase) || 0;
                const suppTelaio = parseFloat(rigaPreventivo.supplementoTelaio) || 0;
                const suppAnta = parseFloat(rigaPreventivo.supplementoAnta) || 0;
                const suppVetro = parseFloat(rigaPreventivo.supplementoVetro) || 0;
                const suppColore = parseFloat(rigaPreventivo.supplementoColore) || 0;
                const suppManiglia = parseFloat(rigaPreventivo.supplementoManiglia) || 0;
                const suppMontante = parseFloat(rigaPreventivo.supplementoMontante) || 0;
                const suppSoglia = parseFloat(rigaPreventivo.supplementoSoglia) || 0;  // âœ… v8.10
                const suppManigliettaPF = parseFloat(rigaPreventivo.supplementoManigliettaPF) || 0;  // âœ… v8.10
                const prezzoUnitario = parseFloat(rigaPreventivo.prezzoUnitario) || 0;
                const quantita = parseInt(rigaPreventivo.quantita) || 1;
                const totale = parseFloat(rigaPreventivo.totale) || 0;
                
                let dettaglioHTML = `
                <div style="padding: 1.5rem;">
                    <!-- HEADER -->
                    <div style="background: linear-gradient(135deg, #065f46 0%, #10b981 100%); color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0; font-size: 1.25rem;">ğŸªŸ ${tipo} - Posizione ${posIndex}</h3>
                                <p style="margin: 0.25rem 0 0 0; opacity: 0.9;">${ambiente}</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.5rem; font-weight: 700;">â‚¬ ${totale.toFixed(2)}</div>
                                <div style="font-size: 0.875rem; opacity: 0.9;">Totale${quantita > 1 ? ` (${quantita} pz)` : ''}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- MISURE -->
                    <div style="background: #ecfdf5; border: 1px solid #6ee7b7; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #065f46;">ğŸ“ Misure</h4>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Larghezza</div>
                                <div style="font-size: 1.25rem; font-weight: 600;">${L_mm} mm</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Altezza</div>
                                <div style="font-size: 1.25rem; font-weight: 600;">${H_mm} mm</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Superficie</div>
                                <div style="font-size: 1.25rem; font-weight: 600;">${superficie} mÂ²</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Perimetro</div>
                                <div style="font-size: 1.25rem; font-weight: 600;">${perimetro} ml</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BREAKDOWN COSTI -->
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; margin-bottom: 1rem;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Componente</th>
                                    <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #e5e7eb;">Importo</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- PREZZO BASE -->
                                <tr style="background: #ecfdf5;">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ“¦ Prezzo Base Infisso</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">Da listino ${azienda}</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #065f46;">
                                        â‚¬ ${prezzoBase.toFixed(2)}
                                    </td>
                                </tr>
                                
                                ${suppTelaio > 0 ? `
                                <!-- SUPPLEMENTO TELAIO -->
                                <tr>
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ”² Supplemento Telaio</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">${telaio}${telaio && azienda?.toLowerCase() === 'finstral' ? 'N' : ''} - Forma ad L</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #2563eb;">
                                        â‚¬ ${suppTelaio.toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                ${suppAnta > 0 ? `
                                <!-- SUPPLEMENTO ANTA -->
                                <tr style="background: #f9fafb;">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸšª Supplemento Anta</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">${tipoAnta || 'Profilo battente'}</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #7c3aed;">
                                        â‚¬ ${suppAnta.toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                ${suppVetro > 0 ? `
                                <!-- SUPPLEMENTO VETRO -->
                                <tr>
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ”· Supplemento Vetro</strong>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #0891b2;">
                                        â‚¬ ${suppVetro.toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                ${suppColore > 0 ? `
                                <!-- SUPPLEMENTO COLORE -->
                                <tr style="background: #fefce8;">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ¨ Supplemento Colore</strong>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #ca8a04;">
                                        â‚¬ ${suppColore.toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                ${suppManiglia > 0 ? `
                                <!-- SUPPLEMENTO MANIGLIA -->
                                <tr>
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ”§ Maniglia/Ferramenta</strong>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #dc2626;">
                                        â‚¬ ${suppManiglia.toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                ${suppMontante > 0 ? `
                                <!-- SUPPLEMENTO MONTANTE -->
                                <tr style="background: #f9fafb;">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ“ Montante Centrale</strong>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #9333ea;">
                                        â‚¬ ${suppMontante.toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                ${suppSoglia > 0 ? `
                                <!-- âœ… v8.10: SUPPLEMENTO SOGLIA -->
                                <tr>
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸšª Soglia Ribassata</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">Codice 3 - Taglio termico</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #ea580c;">
                                        â‚¬ ${suppSoglia.toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                ${suppManigliettaPF > 0 ? `
                                <!-- âœ… v8.10: MANIGLIETTA ESTERNA PF -->
                                <tr style="background: #f9fafb;">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ”‘ Maniglietta Esterna</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">Per porta-finestra</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #be185d;">
                                        â‚¬ ${suppManigliettaPF.toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                <!-- PREZZO UNITARIO -->
                                <tr style="background: #f0fdf4;">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb; font-weight: 600;">
                                        Prezzo Unitario
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600;">
                                        â‚¬ ${prezzoUnitario.toFixed(2)}
                                    </td>
                                </tr>
                                
                                ${quantita > 1 ? `
                                <!-- QUANTITA -->
                                <tr>
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        QuantitÃ 
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb;">
                                        Ã— ${quantita}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                <!-- TOTALE -->
                                <tr style="background: #dcfce7;">
                                    <td style="padding: 1rem; font-weight: 700; font-size: 1.1rem;">
                                        TOTALE INFISSO
                                    </td>
                                    <td style="padding: 1rem; text-align: right; font-weight: 700; font-size: 1.25rem; color: #059669;">
                                        â‚¬ ${totale.toFixed(2)}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- INFO AGGIUNTIVE -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.85rem;">
                        <div style="background: #f9fafb; padding: 0.75rem; border-radius: 0.375rem;">
                            <strong>ğŸ­ Azienda:</strong> ${azienda}
                        </div>
                        <div style="background: #f9fafb; padding: 0.75rem; border-radius: 0.375rem;">
                            <strong>ğŸ”² Telaio:</strong> ${telaio}
                        </div>
                    </div>
                    ${tipoAnta ? `
                    <div style="margin-top: 0.5rem; font-size: 0.85rem;">
                        <div style="background: #f0fdf4; padding: 0.75rem; border-radius: 0.375rem;">
                            <strong>ğŸšª Anta:</strong> ${tipoAnta}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            mostraModalDettaglioCosti('Infisso', dettaglioHTML);
            } catch (e) {
                console.error('âŒ Errore in mostraDettaglioCostiInfisso:', e);
                alert('Errore dettaglio costi: ' + e.message);
            }
        }

        /**
         * ğŸ†• v7.89: Mostra dettaglio costi PERSIANA
         * USA SOLO I DATI GIÃ€ CALCOLATI NEL PREVENTIVO - NON RICALCOLA!
         */
        function mostraDettaglioCostiPersiana(posIndex, rigaPreventivo = {}) {
            try {
                console.log(`ğŸ“Š v7.92 Dettaglio Persiana Pos ${posIndex} - DATI DA PREVENTIVO:`, rigaPreventivo);
                
                // Dati dal preventivo
                const L_mm = rigaPreventivo.larghezza || 0;
                const H_mm = rigaPreventivo.altezza || 0;
                const superficie = rigaPreventivo.superficie || '-';
                const modello = rigaPreventivo.telaio || 'N/D';
                const azienda = rigaPreventivo.azienda || 'P. Persiane';
                const ambiente = rigaPreventivo.ambiente || `Pos ${posIndex}`;
                const tipo = rigaPreventivo.tipo || 'Persiana';
                
                // Prezzi dal preventivo - MAPPING v7.92:
                const prezzoBase = parseFloat(rigaPreventivo.prezzoBase) || 0;
                const suppColore = parseFloat(rigaPreventivo.supplementoTelaio) || 0;
                const suppSpagnolette = parseFloat(rigaPreventivo.supplementoAnta) || 0;
                const cardini = parseFloat(rigaPreventivo.supplementoVetro) || 0;
                const imballo = parseFloat(rigaPreventivo.supplementoManiglia) || 0;
                const contributoGestione = parseFloat(rigaPreventivo.supplementoColore) || 0;
                const prezzoUnitario = parseFloat(rigaPreventivo.prezzoUnitario) || 0;
                const quantita = parseInt(rigaPreventivo.quantita) || 1;
                const totale = parseFloat(rigaPreventivo.totale) || 0;
                
                // Info extra
                const coloreInfo = rigaPreventivo._colore || 'N/D';
                const categoriaColore = rigaPreventivo._categoriaColore || 'N/D';
                
                let dettaglioHTML = `
                <div style="padding: 1.5rem;">
                    <!-- HEADER -->
                    <div style="background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%); color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0; font-size: 1.25rem;">ğŸšª ${tipo} - Posizione ${posIndex}</h3>
                                <p style="margin: 0.25rem 0 0 0; opacity: 0.9;">${ambiente}</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.5rem; font-weight: 700;">â‚¬ ${totale.toFixed(2)}</div>
                                <div style="font-size: 0.875rem; opacity: 0.9;">Totale${quantita > 1 ? ` (${quantita} pz)` : ''}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- MISURE -->
                    <div style="background: #f5f3ff; border: 1px solid #c4b5fd; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #7c3aed;">ğŸ“ Misure</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Larghezza</div>
                                <div style="font-size: 1.25rem; font-weight: 600;">${L_mm} mm</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Altezza</div>
                                <div style="font-size: 1.25rem; font-weight: 600;">${H_mm} mm</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Superficie</div>
                                <div style="font-size: 1.25rem; font-weight: 600;">${superficie}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BREAKDOWN COSTI -->
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; margin-bottom: 1rem;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Componente</th>
                                    <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #e5e7eb;">Importo</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- PREZZO BASE -->
                                <tr style="background: #f5f3ff;">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ“¦ Prezzo Base Persiana</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">Modello: ${modello}</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #7c3aed;">
                                        â‚¬ ${prezzoBase.toFixed(2)}
                                    </td>
                                </tr>
                                
                                ${suppColore > 0 ? `
                                <!-- MAGGIORAZIONE COLORE -->
                                <tr style="background: #fefce8;">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ¨ Maggiorazione Colore</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">${coloreInfo} (${categoriaColore})</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #ca8a04;">
                                        â‚¬ ${suppColore.toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                ${suppSpagnolette > 0 ? `
                                <!-- SPAGNOLETTE -->
                                <tr>
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ”§ Spagnolette</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">Per 2+ ante</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #059669;">
                                        â‚¬ ${suppSpagnolette.toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                ${cardini > 0 ? `
                                <!-- CARDINI -->
                                <tr style="background: #f9fafb;">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ”© Cardini</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">C.SAF90 Ã— 4 pz</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #6b7280;">
                                        â‚¬ ${cardini.toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                ${imballo > 0 ? `
                                <!-- IMBALLO -->
                                <tr>
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ“¦ Imballo</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">3% standard</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #6b7280;">
                                        â‚¬ ${imballo.toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                ${contributoGestione > 0 ? `
                                <!-- CONTRIBUTO GESTIONE -->
                                <tr style="background: #fef3c7;">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ“‹ Contributo Gestione</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">Fisso per ordine</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #d97706;">
                                        â‚¬ ${contributoGestione.toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                <!-- PREZZO UNITARIO -->
                                <tr style="background: #faf5ff;">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb; font-weight: 600;">
                                        Prezzo Unitario
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600;">
                                        â‚¬ ${prezzoUnitario.toFixed(2)}
                                    </td>
                                </tr>
                                
                                ${quantita > 1 ? `
                                <!-- QUANTITA -->
                                <tr>
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        QuantitÃ 
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb;">
                                        Ã— ${quantita}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                <!-- TOTALE -->
                                <tr style="background: #ede9fe;">
                                    <td style="padding: 1rem; font-weight: 700; font-size: 1.1rem;">
                                        TOTALE PERSIANA
                                    </td>
                                    <td style="padding: 1rem; text-align: right; font-weight: 700; font-size: 1.25rem; color: #7c3aed;">
                                        â‚¬ ${totale.toFixed(2)}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- INFO AGGIUNTIVE -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.85rem;">
                        <div style="background: #f9fafb; padding: 0.75rem; border-radius: 0.375rem;">
                            <strong>ğŸ­ Azienda:</strong> ${azienda}
                        </div>
                        <div style="background: #f9fafb; padding: 0.75rem; border-radius: 0.375rem;">
                            <strong>ğŸšª Modello:</strong> ${modello}
                        </div>
                    </div>
                </div>
            `;
            
            mostraModalDettaglioCosti('Persiana', dettaglioHTML);
            } catch (e) {
                console.error('âŒ Errore in mostraDettaglioCostiPersiana:', e);
                alert('Errore dettaglio costi: ' + e.message);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”Œ v8.09: DETTAGLIO COSTI MOTORE SOMFY
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function mostraDettaglioCostiMotore(posIndex, rigaPreventivo = {}) {
            try {
                console.log(`ğŸ”Œ v8.09 Dettaglio Motore Pos ${posIndex} - DATI:`, rigaPreventivo);
                
                const ambiente = rigaPreventivo.ambiente || `Pos ${posIndex}`;
                const azienda = rigaPreventivo.azienda || 'Somfy';
                const modelloId = rigaPreventivo.telaio || 'N/D';
                const totale = parseFloat(rigaPreventivo.totale) || 0;
                const quantita = parseInt(rigaPreventivo.quantita) || 1;
                const prezzoUnitario = parseFloat(rigaPreventivo.prezzoUnitario) || totale;
                
                // Prezzi componenti dal preventivo
                const prezzoMotore = parseFloat(rigaPreventivo.prezzoBase) || 0;
                const prezzoComando = parseFloat(rigaPreventivo.supplementoTelaio) || 0;
                const prezzoSupporto = parseFloat(rigaPreventivo.supplementoAnta) || 0;
                const prezzoRuota = parseFloat(rigaPreventivo.supplementoVetro) || 0;
                
                // Dettaglio kit se disponibile
                const dettaglioKit = rigaPreventivo._dettaglioKit || [];
                const accessori = rigaPreventivo._accessori || {};
                const comandoId = rigaPreventivo._comandoId || '';
                
                // Cerca info nel database SOMFY
                const motoreDb = SOMFY_PREZZI.getPrezzoMotore(modelloId.toLowerCase().replace(/\s+/g, '_'));
                const nomeMotore = motoreDb?.nome || modelloId;
                const refMotore = motoreDb?.ref || '';
                const coppia = motoreDb?.coppia || '';
                const velocita = motoreDb?.velocita || '';
                
                let dettaglioHTML = `
                <div style="padding: 1.5rem;">
                    <!-- HEADER -->
                    <div style="background: linear-gradient(135deg, #ea580c 0%, #f97316 100%); color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0; font-size: 1.25rem;">ğŸ”Œ Motore - Posizione ${posIndex}</h3>
                                <p style="margin: 0.25rem 0 0 0; opacity: 0.9;">${ambiente}</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.5rem; font-weight: 700;">â‚¬ ${totale.toFixed(2)}</div>
                                <div style="font-size: 0.875rem; opacity: 0.9;">Totale${quantita > 1 ? ` (${quantita} pz)` : ''}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- INFO MOTORE -->
                    <div style="background: #fff7ed; border: 1px solid #fed7aa; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #c2410c;">âš¡ Specifiche Motore</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Modello</div>
                                <div style="font-size: 1rem; font-weight: 600;">${nomeMotore}</div>
                                ${refMotore ? `<div style="font-size: 0.7rem; color: #9ca3af;">Ref: ${refMotore}</div>` : ''}
                            </div>
                            ${coppia ? `
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Coppia</div>
                                <div style="font-size: 1.25rem; font-weight: 600;">${coppia} Nm</div>
                            </div>
                            ` : ''}
                            ${velocita ? `
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280;">VelocitÃ </div>
                                <div style="font-size: 1.25rem; font-weight: 600;">${velocita} rpm</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- BREAKDOWN COSTI -->
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; margin-bottom: 1rem;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Componente</th>
                                    <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #e5e7eb;">Prezzo Listino</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- MOTORE -->
                                <tr style="background: #fff7ed;">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ”Œ Motore</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">${nomeMotore}</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #ea580c;">
                                        â‚¬ ${prezzoMotore.toFixed(2)}
                                    </td>
                                </tr>
                                
                                ${prezzoComando > 0 ? `
                                <!-- COMANDO -->
                                <tr>
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ® Comando/Ricevitore</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">${comandoId || 'N/D'}</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #2563eb;">
                                        â‚¬ ${prezzoComando.toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                ${accessori.supporto ? `
                                <!-- SUPPORTO -->
                                <tr style="background: #f9fafb;">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ”© Supporto Operatore</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">Ref: 9019821</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #059669;">
                                        â‚¬ ${prezzoSupporto.toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                ${accessori.ruota_60 ? `
                                <!-- RUOTA -->
                                <tr>
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>âš™ï¸ Ruota Ottagonale 60mm</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">Ref: 9751001</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #059669;">
                                        â‚¬ ${prezzoRuota.toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                ${accessori.corona_60 ? `
                                <!-- CORONA -->
                                <tr style="background: #f9fafb;">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ‘‘ Corona Ottagonale 60</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">Ref: 9707025</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #059669;">
                                        â‚¬ ${(SOMFY_PREZZI.accessori.corona_60?.listino || 17.67).toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                                
                                ${quantita > 1 ? `
                                <!-- QUANTITA -->
                                <tr style="background: #fef3c7;">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ“¦ QuantitÃ </strong>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600;">
                                        Ã— ${quantita} pz
                                    </td>
                                </tr>
                                ` : ''}
                                
                                <!-- TOTALE -->
                                <tr style="background: #ffedd5;">
                                    <td style="padding: 1rem; font-weight: 700; font-size: 1.1rem;">
                                        TOTALE MOTORE
                                    </td>
                                    <td style="padding: 1rem; text-align: right; font-weight: 700; font-size: 1.25rem; color: #ea580c;">
                                        â‚¬ ${totale.toFixed(2)}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- INFO AGGIUNTIVE -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.85rem;">
                        <div style="background: #f9fafb; padding: 0.75rem; border-radius: 0.375rem;">
                            <strong>ğŸ­ Azienda:</strong> ${azienda}
                        </div>
                        <div style="background: #f9fafb; padding: 0.75rem; border-radius: 0.375rem;">
                            <strong>ğŸ’¡ Prezzo Unitario:</strong> â‚¬ ${prezzoUnitario.toFixed(2)}
                        </div>
                    </div>
                    
                    <!-- NOTE SCONTO -->
                    <div style="margin-top: 1rem; padding: 0.75rem; background: #fef3c7; border-radius: 0.375rem; font-size: 0.8rem; color: #92400e;">
                        <strong>âš ï¸ Nota:</strong> Prezzi da listino SOMFY 2025. Applicare sconto installatore per prezzo netto.
                    </div>
                </div>
            `;
            
            mostraModalDettaglioCosti('Motore', dettaglioHTML);
            } catch (e) {
                console.error('âŒ Errore in mostraDettaglioCostiMotore:', e);
                alert('Errore dettaglio costi: ' + e.message);
            }
        }
        
        // Esponi globalmente
        window.mostraDettaglioCostiMotore = mostraDettaglioCostiMotore;

        // ğŸ” v7.98_07: DETTAGLIO COSTI BLINDATA
        function mostraDettaglioCostiBlindato(posIndex, rigaPreventivo = {}) {
            try {
                console.log('ğŸ” mostraDettaglioCostiBlindato posizione:', posIndex);
                
                // Trova la posizione nei dati caricati
                const data = window.projectData || window.currentData;
                if (!data) {
                    alert('Dati progetto non trovati');
                    return;
                }
                
                const posizioni = data.positions || data.posizioni || [];
                const pos = posizioni[posIndex - 1];
                if (!pos) {
                    alert('Posizione non trovata');
                    return;
                }
                
                // Prendi i dati blindata (normalizzati)
                const bld = pos.blindata || pos.ingresso?.blindata;
                if (!bld) {
                    alert('Dati blindata non trovati');
                    return;
                }
                
                // Ricalcola prezzo per avere il dettaglio
                const prezzoCalcolato = calcolaPrezzoBlindataOikos(bld);
                const det = prezzoCalcolato.dettaglio || {};
                
                // Costruisci HTML del popup
                const contenutoHTML = `
                    <div style="padding: 1rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: #fff7ed; padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 0.8rem; color: #9a3412;">Luce Netta Passaggio (LNP)</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #c2410c;">${bld.LNP_L || 0} Ã— ${bld.LNP_H || 0} mm</div>
                            </div>
                            <div style="background: #fef2f2; padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 0.8rem; color: #991b1b;">Luce Calcolata</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #dc2626;">${(bld.luceCalcolata || 'luce0').toUpperCase()}</div>
                            </div>
                        </div>
                        
                        <div style="background: #f1f5f9; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">ğŸ“‹ Configurazione</div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; font-size: 0.85rem;">
                                <div><strong>Versione:</strong> ${bld.versione || 'E3'}</div>
                                <div><strong>Tipo Anta:</strong> ${bld.tipoAnta || 'singola'}</div>
                                <div><strong>Apertura:</strong> ${bld.sensoApertura || 'SX'}</div>
                                <div><strong>Controtelaio:</strong> ${bld.controtelaio === 'si' ? 'SÃ¬' : 'No'}</div>
                                <div><strong>Cilindro:</strong> ${bld.cilindro || 'BASIC'}</div>
                                <div><strong>Colore Telaio:</strong> ${bld.coloreTelaio || 'RAL8022'}</div>
                                <div><strong>Kit AAV:</strong> ${bld.kitAAV || 'N/D'}</div>
                                <div><strong>Termica:</strong> ${bld.termica || 'serie'}</div>
                                <div><strong>Acustica:</strong> ${bld.acustica || 'serie'}</div>
                            </div>
                        </div>
                        
                        <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">ğŸ¨ Rivestimenti</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.85rem;">
                                <div>
                                    <strong>Interno:</strong><br>
                                    ${bld.rivestimentoInt?.linea || 'N/D'} - ${bld.rivestimentoInt?.modello || ''}<br>
                                    ${bld.rivestimentoInt?.essenza || ''} ${bld.rivestimentoInt?.tinta || ''}
                                </div>
                                <div>
                                    <strong>Esterno:</strong><br>
                                    ${bld.rivestimentoEst?.linea || 'N/D'} - ${bld.rivestimentoEst?.modello || ''}<br>
                                    ${bld.rivestimentoEst?.essenza || ''} ${bld.rivestimentoEst?.tinta || ''}
                                </div>
                            </div>
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: #e11d48; color: white;">
                                    <th style="padding: 0.75rem; text-align: left;">Voce</th>
                                    <th style="padding: 0.75rem; text-align: right;">Importo â‚¬</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: #fff;">
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">Prezzo Base ${bld.versione || 'E3'}</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${(det.prezzoBase || 0).toFixed(2)}</td>
                                </tr>
                                ${det.controtelaio > 0 ? `
                                <tr style="background: #f9fafb;">
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">Controtelaio</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${det.controtelaio.toFixed(2)}</td>
                                </tr>
                                ` : ''}
                                <tr style="background: #fff;">
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">Cilindro ${bld.cilindro || 'BASIC'}</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${(det.cilindro || 0).toFixed(2)}</td>
                                </tr>
                                ${det.colore > 0 ? `
                                <tr style="background: #f9fafb;">
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">Colore Telaio ${bld.coloreTelaio || ''}</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${det.colore.toFixed(2)}</td>
                                </tr>
                                ` : ''}
                                ${det.rivestimenti > 0 ? `
                                <tr style="background: #fff;">
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">Rivestimenti INT + EST</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${det.rivestimenti.toFixed(2)}</td>
                                </tr>
                                ` : ''}
                                ${det.kitAAV > 0 ? `
                                <tr style="background: #f9fafb;">
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">Kit AAV ${bld.kitAAV || ''}</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${det.kitAAV.toFixed(2)}</td>
                                </tr>
                                ` : ''}
                                ${det.maniglie > 0 ? `
                                <tr style="background: #fff;">
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">ğŸšª Maniglie (INT: ${bld.manigliaInt || 'std'} ${bld.finituraInt || ''} + EST: ${bld.manigliaEst || 'std'} ${bld.finituraEst || ''})</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${det.maniglie.toFixed(2)}</td>
                                </tr>
                                ` : ''}
                                ${det.chiaviExtra > 0 ? `
                                <tr style="background: #f9fafb;">
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">ğŸ”‘ Chiavi extra (${parseInt(bld.numChiavi || 3) - 3} Ã— â‚¬25)</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${det.chiaviExtra.toFixed(2)}</td>
                                </tr>
                                ` : ''}
                                ${det.imbotti > 0 ? `
                                <tr style="background: #fff;">
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">ğŸ“ Imbotte Est. ${bld.imbotteEstAltezza || ''} Ã— ${bld.imbotteEstLargh || ''} (${bld.imbotteEstEssenza || 'std'})</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${det.imbotti.toFixed(2)}</td>
                                </tr>
                                ` : ''}
                                ${det.cornici > 0 ? `
                                <tr style="background: #f9fafb;">
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">ğŸ–¼ï¸ Cornici ${bld.corniciFermaPannello ? 'Ferma Pannello' : ''} ${bld.corniciInt ? '+ Interne' : ''}</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${det.cornici.toFixed(2)}</td>
                                </tr>
                                ` : ''}
                                ${det.acustica > 0 ? `
                                <tr style="background: #fff;">
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">Maggiorazione Acustica</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${det.acustica.toFixed(2)}</td>
                                </tr>
                                ` : ''}
                                ${det.termica > 0 ? `
                                <tr style="background: #f9fafb;">
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">Termica ${bld.termica || ''}</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${det.termica.toFixed(2)}</td>
                                </tr>
                                ` : ''}
                                ${det.optional > 0 ? `
                                <tr style="background: #fff;">
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">Optional (vetro/sopraluce/fiancoluce)</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${det.optional.toFixed(2)}</td>
                                </tr>
                                ` : ''}
                            </tbody>
                            <tfoot>
                                <tr style="background: #e11d48; color: white; font-weight: bold;">
                                    <td style="padding: 0.75rem;">TOTALE BLINDATA</td>
                                    <td style="padding: 0.75rem; text-align: right;">â‚¬ ${(prezzoCalcolato.totale || 0).toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
                
                // Usa la funzione modale generica
                mostraModalDettaglioCosti(`ğŸ” Dettaglio Blindata - Pos. ${posIndex}`, contenutoHTML);
                
            } catch (e) {
                console.error('âŒ Errore in mostraDettaglioCostiBlindato:', e);
                alert('Errore dettaglio costi: ' + e.message);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸšª v7.99 DETTAGLIO COSTI PORTONCINO FIN-DOOR
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function mostraDettaglioCostiPortoncino(posIndex, rigaPreventivo = {}) {
            try {
                console.log('ğŸšª mostraDettaglioCostiPortoncino posizione:', posIndex);
                
                const data = window.projectData || window.currentData;
                if (!data) { alert('Dati progetto non trovati'); return; }
                
                const posizioni = data.positions || data.posizioni || [];
                const pos = posizioni[posIndex - 1];
                if (!pos) { alert('Posizione non trovata'); return; }
                
                const ptc = pos.portoncino || pos.ingresso?.portoncino;
                if (!ptc) { alert('Dati portoncino non trovati'); return; }
                
                const prezzoCalcolato = calcolaPrezzoPortoncinoFindoor(ptc);
                
                const tipiApertura = {
                    '720': 'Porta singola', '625': 'Porta singola (var.)', '621': 'Porta + laterale sx',
                    '622': 'Porta + laterale dx', '633': 'Porta + 2 laterali', '636': 'Doppia porta',
                    '624': 'Porta + sopraluce', '623': 'Porta + anta sup.'
                };
                
                const contenutoHTML = `
                    <div style="padding: 1rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: #fdf4ff; padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 0.8rem; color: #86198f;">Misure BRM</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #a21caf;">${ptc.BRM_L || 0} Ã— ${ptc.BRM_H || 0} mm</div>
                            </div>
                            <div style="background: #fce7f3; padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 0.8rem; color: #9d174d;">Tipo Apertura</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #be185d;">${ptc.tipoApertura || '720'}</div>
                                <div style="font-size: 0.75rem; color: #9d174d;">${tipiApertura[ptc.tipoApertura] || 'Porta singola'}</div>
                            </div>
                        </div>
                        
                        <div style="background: #f1f5f9; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">ğŸ“‹ Configurazione</div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; font-size: 0.85rem;">
                                <div><strong>Mat. Int:</strong> ${ptc.materialeInt || 'PVC'}</div>
                                <div><strong>Mat. Est:</strong> ${ptc.materialeEst || 'PVC'}</div>
                                <div><strong>Modello:</strong> ${ptc.modelloAnta || '01'}</div>
                                <div><strong>Apertura:</strong> ${ptc.versoApertura || ptc.direzioneApertura || '-'} + ${ptc.sensoApertura || ptc.latoCerniere || '-'}</div>
                                <div><strong>Cilindro:</strong> ${ptc.cilindro || '1P'}</div>
                            </div>
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: #db2777; color: white;">
                                    <th style="padding: 0.75rem; text-align: left;">Voce</th>
                                    <th style="padding: 0.75rem; text-align: right;">â‚¬</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: #fff;"><td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">Prezzo Base</td><td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${(prezzoCalcolato.prezzoBase || 0).toFixed(2)}</td></tr>
                                ${prezzoCalcolato.supplementoModello > 0 ? `<tr style="background: #f9fafb;"><td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">Modello Anta ${ptc.modelloAnta}</td><td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${prezzoCalcolato.supplementoModello.toFixed(2)}</td></tr>` : ''}
                                ${prezzoCalcolato.supplementoColoreInt > 0 ? `<tr style="background: #fff;"><td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">Colore Int (${ptc.gruppoColoreInt})</td><td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${prezzoCalcolato.supplementoColoreInt.toFixed(2)}</td></tr>` : ''}
                                ${prezzoCalcolato.supplementoColoreEst > 0 ? `<tr style="background: #f9fafb;"><td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">Colore Est (${ptc.gruppoColoreEst})</td><td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${prezzoCalcolato.supplementoColoreEst.toFixed(2)}</td></tr>` : ''}
                                ${prezzoCalcolato.maniglia > 0 ? `<tr style="background: #fff;"><td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">ğŸšª Maniglia ${ptc.codManiglia}</td><td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${prezzoCalcolato.maniglia.toFixed(2)}</td></tr>` : ''}
                                ${prezzoCalcolato.cilindro > 0 ? `<tr style="background: #f9fafb;"><td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">ğŸ”‘ Cilindro ${ptc.cilindro}</td><td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${prezzoCalcolato.cilindro.toFixed(2)}</td></tr>` : ''}
                                ${prezzoCalcolato.cerniere > 0 ? `<tr style="background: #fff;"><td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">âš™ï¸ Cerniere scomparsa</td><td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${prezzoCalcolato.cerniere.toFixed(2)}</td></tr>` : ''}
                                ${prezzoCalcolato.fonoassorbente > 0 ? `<tr style="background: #f9fafb;"><td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">ğŸ”‡ Fonoassorbente 42dB</td><td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right;">â‚¬ ${prezzoCalcolato.fonoassorbente.toFixed(2)}</td></tr>` : ''}
                                ${prezzoCalcolato.moltiplicatoreTipo !== 1 ? `<tr style="background: #fef3c7;"><td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; font-style: italic;">ğŸ“ Moltiplicatore Ã—${prezzoCalcolato.moltiplicatoreTipo}</td><td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: right; font-style: italic;">applicato</td></tr>` : ''}
                            </tbody>
                            <tfoot>
                                <tr style="background: #db2777; color: white; font-weight: bold;">
                                    <td style="padding: 0.75rem;">TOTALE PORTONCINO</td>
                                    <td style="padding: 0.75rem; text-align: right;">â‚¬ ${(prezzoCalcolato.totale || 0).toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
                
                mostraModalDettaglioCosti(`ğŸšª Dettaglio Portoncino - Pos. ${posIndex}`, contenutoHTML);
                
            } catch (e) {
                console.error('âŒ Errore in mostraDettaglioCostiPortoncino:', e);
                alert('Errore dettaglio costi: ' + e.message);
            }
        }

        window.mostraDettaglioCostiTapparella = mostraDettaglioCostiTapparella;
        window.mostraDettaglioCostiPersiana = mostraDettaglioCostiPersiana;
        window.mostraDettaglioCostiInfisso = mostraDettaglioCostiInfisso;
        window.mostraDettaglioCostiBlindato = mostraDettaglioCostiBlindato;
        window.mostraDettaglioCostiPortoncino = mostraDettaglioCostiPortoncino;
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ“¦ v7.996: DETTAGLIO COSTI CASSONETTO FINSTRAL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function mostraDettaglioCostiCassonetto(posIndex, rigaPreventivo = {}) {
            try {
                console.log(`ğŸ“¦ Dettaglio Cassonetto Pos ${posIndex}:`, rigaPreventivo);
                
                const L_mm = rigaPreventivo.larghezza || 0;
                const A_mm = rigaPreventivo.altezza || 0;
                const B_mm = rigaPreventivo.B || 0;
                const azienda = rigaPreventivo.azienda || 'Finstral';
                const ambiente = rigaPreventivo.ambiente || `Pos ${posIndex}`;
                const materiale = rigaPreventivo.materialeCass || rigaPreventivo.materiale || 'PVC';
                const codiceCass = rigaPreventivo.codiceCass || '148';
                const gruppoColore = rigaPreventivo.gruppoColoreCass || 'bianco';
                const isolamento = rigaPreventivo.codiceIsolamento || null;
                const quantita = parseInt(rigaPreventivo.quantita) || 1;
                
                // Ricalcola per dettaglio
                const calcolo = calcolaPrezzoCassonettoFinstral({
                    L: L_mm,
                    A: A_mm,
                    B: B_mm,
                    materialeCass: materiale,
                    codiceCass: codiceCass,
                    gruppoColoreCass: gruppoColore,
                    codiceIsolamento: isolamento
                });
                
                const prezzoBase = calcolo.dettaglio?.prezzoBase || 0;
                const suppIsolamento = calcolo.dettaglio?.supplementoIsolamento || 0;
                const numIsolamenti = calcolo.dettaglio?.numeroIsolamenti || 0;
                const prezzoUnitario = calcolo.prezzo || 0;
                const totale = prezzoUnitario * quantita;
                const LArr = calcolo.parametri?.LArrotondato || L_mm;
                const AArr = calcolo.parametri?.AArrotondato || A_mm;
                
                let dettaglioHTML = `
                <div style="padding: 1.5rem;">
                    <!-- HEADER -->
                    <div style="background: linear-gradient(135deg, #ea580c 0%, #f97316 100%); color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0; font-size: 1.25rem;">ğŸ“¦ Cassonetto - Posizione ${posIndex}</h3>
                                <p style="margin: 0.25rem 0 0 0; opacity: 0.9;">${ambiente} - ${azienda}</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.5rem; font-weight: 700;">â‚¬ ${totale.toFixed(2)}</div>
                                <div style="font-size: 0.875rem; opacity: 0.9;">Totale${quantita > 1 ? ` (${quantita} pz)` : ''}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CONFIGURAZIONE -->
                    <div style="background: #fff7ed; border: 1px solid #fed7aa; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #c2410c;">âš™ï¸ Configurazione</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.9rem;">
                            <div><strong>Materiale:</strong> ${materiale}</div>
                            <div><strong>Codice:</strong> ${codiceCass}</div>
                            <div><strong>Colore:</strong> ${gruppoColore}</div>
                            <div><strong>Isolamento:</strong> ${isolamento || 'No'}</div>
                        </div>
                    </div>
                    
                    <!-- MISURE -->
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #0369a1;">ğŸ“ Misure (Reali â†’ Listino)</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Larghezza L</div>
                                <div style="font-size: 1.1rem; font-weight: 600;">${L_mm} â†’ ${LArr} mm</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Altezza A</div>
                                <div style="font-size: 1.1rem; font-weight: 600;">${A_mm} â†’ ${AArr} mm</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280;">ProfonditÃ  B</div>
                                <div style="font-size: 1.1rem; font-weight: 600;">${B_mm} mm</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BREAKDOWN COSTI -->
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; margin-bottom: 1rem;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Componente</th>
                                    <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid #e5e7eb;">Dettaglio</th>
                                    <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #e5e7eb;">Importo</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- CORPO CASSONETTO -->
                                <tr style="background: #fef3c7;">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ“¦ Corpo Cassonetto</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">${materiale} cod. ${codiceCass} - ${gruppoColore}</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #e5e7eb; font-family: monospace;">
                                        L${LArr} Ã— A${AArr}
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #ca8a04;">
                                        â‚¬ ${prezzoBase.toFixed(2)}
                                    </td>
                                </tr>
                                ${suppIsolamento > 0 ? `
                                <!-- ISOLAMENTO -->
                                <tr>
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                        <strong>ğŸ§Š Isolamento Termico</strong><br>
                                        <span style="font-size: 0.8rem; color: #6b7280;">Cod. ${isolamento} (Usb 0,87 W/mÂ²K)</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #e5e7eb; font-family: monospace;">
                                        ${numIsolamenti} pz Ã— â‚¬${(suppIsolamento/numIsolamenti).toFixed(2)}
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #0891b2;">
                                        â‚¬ ${suppIsolamento.toFixed(2)}
                                    </td>
                                </tr>
                                ` : ''}
                            </tbody>
                            <tfoot>
                                <tr style="background: #f0fdf4;">
                                    <td colspan="2" style="padding: 0.75rem; font-weight: 700; color: #166534;">
                                        TOTALE CASSONETTO ${quantita > 1 ? `(Ã— ${quantita} pz)` : ''}
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; font-size: 1.25rem; font-weight: 700; color: #166534;">
                                        â‚¬ ${totale.toFixed(2)}
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <!-- NOTE -->
                    <div style="background: #fefce8; border: 1px solid #fef08a; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.8rem; color: #854d0e;">
                        <strong>ğŸ“‹ Note:</strong> Listino Finstral EUR 2025/3. Per misure intermedie vale la casella superiore.
                        ${L_mm > 2750 ? '<br>âš ï¸ L > 2750mm: coperchio consegnato in due parti.' : ''}
                        ${materiale === 'LEGNO' && L_mm > 2240 ? '<br>âš ï¸ Legno: larghezza max 2240mm!' : ''}
                    </div>
                </div>
                `;
                
                mostraModalDettaglioCosti('ğŸ“¦ Dettaglio Costi Cassonetto', dettaglioHTML);
                
            } catch (e) {
                console.error('âŒ Errore mostraDettaglioCostiCassonetto:', e);
                alert('Errore dettaglio cassonetto: ' + e.message);
            }
        }
        
        window.mostraDettaglioCostiCassonetto = mostraDettaglioCostiCassonetto;
        
        /**
         * ğŸ†• v7.90: Mostra modal generico per dettaglio costi
         */
        function mostraModalDettaglioCosti(tipoTitolo, contenutoHTML) {
            // Rimuovi modal esistente se presente
            const existingModal = document.getElementById('modalDettaglioCosti');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Crea overlay e modal
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'modalDettaglioCosti';
            modalOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 0.75rem;
                max-width: 700px;
                width: 90%;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
                position: relative;
            `;
            
            // Header con titolo e X di chiusura
            const header = document.createElement('div');
            header.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 1rem 1.5rem;
                border-bottom: 1px solid #e5e7eb;
                background: #f9fafb;
                border-radius: 0.75rem 0.75rem 0 0;
            `;
            header.innerHTML = `
                <h2 style="margin: 0; font-size: 1.25rem; color: #1f2937;">ğŸ’° Dettaglio Costi - ${tipoTitolo}</h2>
                <button onclick="window.chiudiModalDettaglioCosti()" style="
                    background: none;
                    border: none;
                    font-size: 1.5rem;
                    cursor: pointer;
                    color: #6b7280;
                    padding: 0.25rem;
                    line-height: 1;
                " title="Chiudi">Ã—</button>
            `;
            
            // Corpo del modal
            const body = document.createElement('div');
            body.innerHTML = contenutoHTML;
            
            modalContent.appendChild(header);
            modalContent.appendChild(body);
            modalOverlay.appendChild(modalContent);
            
            // Chiudi cliccando fuori
            modalOverlay.onclick = function(e) {
                if (e.target === modalOverlay) {
                    window.chiudiModalDettaglioCosti();
                }
            };
            
            // Chiudi con ESC
            document.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape') {
                    window.chiudiModalDettaglioCosti();
                    document.removeEventListener('keydown', escHandler);
                }
            });
            
            document.body.appendChild(modalOverlay);
            console.log(`ğŸ“‹ Modal dettaglio ${tipoTitolo} aperto`);
        }
        
        /**
         * Chiude il modal dettaglio costi
         */
        function chiudiModalDettaglioCosti() {
            const modal = document.getElementById('modalDettaglioCosti');
            if (modal) {
                modal.remove();
                console.log('ğŸ“‹ Modal dettaglio chiuso');
            }
        }
        
        window.mostraModalDettaglioCosti = mostraModalDettaglioCosti;
        window.chiudiModalDettaglioCosti = chiudiModalDettaglioCosti;
        
        // Variabile globale per memorizzare le righe del preventivo per il click
        // ğŸ› v8.21 FIX: Deve essere window.righePreventivo per essere accessibile ovunque
        window.righePreventivo = [];

        // Funzione: Ricalcola preventivo (chiamata da select IVA)
        function ricalcolaPreventivo() {
            const currentData = window.currentData;
            if (currentData && currentData.posizioni) {
                renderVistaPreventivo(currentData);
                console.log('ğŸ”„ Preventivo ricalcolato');
            }
        }

        // Funzione: Export Excel preventivo (TODO)
        function exportPreventivoExcel() {
            console.log('ğŸ“Š Export Excel preventivo...');
            alert('Funzione Export Excel da implementare con libreria XLSX');
            // TODO: Implementare export con SheetJS
        }

        // Helper: Normalizza nome azienda (case-insensitive)
        function normalizeAziendaName(azienda) {
            // Gestisci casi speciali
            if (!azienda || azienda.trim() === '') {
                return {
                    key: 'azienda non specificata',
                    display: 'Azienda Non Specificata'
                };
            }
            
            // Converti in lowercase per normalizzazione
            const normalized = azienda.toLowerCase().trim();
            
            // Capitalizza prima lettera di ogni parola per display
            const displayName = normalized
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
            
            return {
                key: normalized,      // Per raggruppamento (es: "finstral")
                display: displayName  // Per visualizzazione (es: "Finstral")
            };
        }

        // Helper: Raggruppa prodotti per azienda
        function groupProductsByAzienda(posizioni) {
            const aziendeMap = new Map();
            
            // Helper per creare struttura azienda vuota
            function createEmptyAzienda(displayName) {
                return {
                    displayName: displayName,
                    prodotti: [],
                    totali: {
                        infissi: 0,
                        tapparelle: 0,
                        motori: 0,
                        persiane: 0,
                        cassonetti: 0,
                        zanzariere: 0,
                        blindate: 0
                    },
                    posizioniCoinvolte: new Set()
                };
            }
            
            // âœ… v7.73: OTTIENI PREZZI DA PREVENTIVO (fonte unica)
            // Crea mappa prezzi da righe preventivo per consistenza tra viste
            const prezziMap = new Map();
            
            // Chiama calcolaPreventivo se abbiamo projectData/currentData
            if ((projectData && projectData.posizioni) || (currentData && currentData.posizioni)) {
                const dataPerPreventivo = projectData || currentData;
                try {
                    const preventivo = calcolaPreventivo(dataPerPreventivo);
                    if (preventivo && preventivo.righe) {
                        preventivo.righe.forEach(riga => {
                            // Crea chiave: "posizione-tipoProdotto" es: "1-infisso"
                            let tipoProdotto = 'unknown';
                            if (riga.tipo.toLowerCase().includes('infisso')) tipoProdotto = 'infisso';
                            else if (riga.tipo.toLowerCase().includes('tapparella')) tipoProdotto = 'tapparella';
                            else if (riga.tipo.toLowerCase().includes('persiana')) tipoProdotto = 'persiana';
                            else if (riga.tipo.toLowerCase().includes('zanzariera')) tipoProdotto = 'zanzariera';
                            else if (riga.tipo.toLowerCase().includes('cassonetto')) tipoProdotto = 'cassonetto';
                            else if (riga.tipo.toLowerCase().includes('blindata')) tipoProdotto = 'blindata';
                            
                            const chiave = `${riga.posizione}-${tipoProdotto}`;
                            prezziMap.set(chiave, {
                                prezzoUnitario: parseFloat(riga.prezzoUnitario) || 0,
                                prezzoTotale: parseFloat(riga.totale) || 0,
                                quantita: riga.quantita || 1
                            });
                        });
                        console.log(`âœ… v7.73 prezziMap caricata: ${prezziMap.size} prodotti`);
                    }
                } catch (err) {
                    console.warn('âš ï¸ v7.73 Errore caricamento prezzi da preventivo:', err);
                }
            }
            
            posizioni.forEach((pos, posIndex) => {
                // Processa ogni tipo di prodotto
                ['infisso', 'tapparella', 'persiana', 'cassonetto', 'zanzariera', 'blindata'].forEach(tipoProdotto => {
                    const prodotto = tipoProdotto === 'blindata' ? pos.blindata : pos[tipoProdotto];
                    
                    // âœ… FIX: Accetta anche quantita undefined/null (tratta come 1)
                    // ğŸ” v7.98: Per blindata usa campo 'attivo' invece di 'quantita'
                    let quantitaProdotto = 0;
                    let hasProdotto = false;
                    
                    if (tipoProdotto === 'blindata') {
                        // Blindata: esiste se l'oggetto ha dati validi (LNP puÃ² essere stringa)
                        hasProdotto = prodotto && (parseInt(prodotto.LNP_L) > 0 || parseInt(prodotto.LNP_H) > 0 || prodotto.versione);
                        quantitaProdotto = hasProdotto ? 1 : 0;
                    } else {
                        quantitaProdotto = prodotto ? (parseInt(prodotto.quantita || prodotto.qta) || 1) : 0;
                        hasProdotto = prodotto && quantitaProdotto > 0;
                    }
                    
                    if (hasProdotto) {
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        // ğŸ”Œ v7.999: GESTIONE SPECIALE TAPPARELLE + MOTORI
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        if (tipoProdotto === 'tapparella') {
                            const serveTapparella = prodotto.serveTapparella === true;
                            const serveMotore = prodotto.serveMotore === true;
                            
                            // === PRODOTTO 1: TAPPARELLA (se serveTapparella=true) ===
                            if (serveTapparella) {
                                const aziendaTap = prodotto.azienda || 'Plasticino';
                                const { key: aziendaKey, display: aziendaDisplay } = normalizeAziendaName(aziendaTap);
                                
                                if (!aziendeMap.has(aziendaKey)) {
                                    aziendeMap.set(aziendaKey, createEmptyAzienda(aziendaDisplay));
                                }
                                const aziendaData = aziendeMap.get(aziendaKey);
                                
                                // Misure
                                let misureL = parseInt(prodotto.BRM_L) || 0;
                                let misureH = parseInt(prodotto.BRM_H) || 0;
                                
                                // Prezzo tapparella
                                let prezzoTap = null;
                                const chiavePrezzo = `${posIndex + 1}-tapparella`;
                                const prezzoFromMap = prezziMap.get(chiavePrezzo);
                                if (prezzoFromMap) {
                                    prezzoTap = prezzoFromMap.prezzoUnitario;
                                }
                                
                                aziendaData.prodotti.push({
                                    tipo: 'tapparella',
                                    posizione: pos.ambiente || pos.nome || pos.stanza || pos.id,
                                    quantita: quantitaProdotto,
                                    brm: { L: misureL, H: misureH },
                                    fonteMisure: { L: 'BRM_L', H: 'BRM_H', valL: misureL, valH: misureH },
                                    modello: prodotto.modello || 'N/D',
                                    configurazione: `${prodotto.guida ? 'Guida: ' + prodotto.guida.split(' - ')[0] : ''} ${prodotto.colore || ''}`.trim() || 'Standard',
                                    colore: prodotto.colore || 'N/D',
                                    note: prodotto.note || '',
                                    prezzoUnitario: prezzoTap,
                                    prezzoTotale: prezzoTap ? prezzoTap * quantitaProdotto : null,
                                    larghezza: misureL,
                                    altezza: misureH
                                });
                                
                                aziendaData.totali.tapparelle += quantitaProdotto;
                                aziendaData.posizioniCoinvolte.add(pos.id);
                            }
                            
                            // === PRODOTTO 2: MOTORE SOMFY (se serveMotore=true) ===
                            if (serveMotore && prodotto.motori && prodotto.motori.length > 0) {
                                const aziendaMotore = prodotto.motoreAzienda || 'Somfy';
                                const { key: aziendaKeyMot, display: aziendaDisplayMot } = normalizeAziendaName(aziendaMotore);
                                
                                if (!aziendeMap.has(aziendaKeyMot)) {
                                    aziendeMap.set(aziendaKeyMot, createEmptyAzienda(aziendaDisplayMot));
                                }
                                const aziendaDataMot = aziendeMap.get(aziendaKeyMot);
                                
                                const motoreInfo = prodotto.motori[0];
                                const modelloMotore = motoreInfo.modelloId || prodotto.motoreModelloDefault || 'oximo_20';
                                const comandoId = motoreInfo.comandoId || prodotto.comandoDefault || '';
                                
                                // Calcola prezzo kit motore
                                const prezzoKit = SOMFY_PREZZI.calcolaPrezzoKit(motoreInfo);
                                
                                // Genera descrizione configurazione
                                let configParts = [];
                                const motoreDb = SOMFY_PREZZI.getPrezzoMotore(modelloMotore);
                                if (motoreDb) configParts.push(motoreDb.nome.split(' ')[0] + ' ' + motoreDb.nome.split(' ')[1]);
                                const comandoDb = SOMFY_PREZZI.getPrezzoComando(comandoId);
                                if (comandoDb) configParts.push('+ ' + comandoDb.nome.split('+')[0].trim());
                                if (motoreInfo.accessori?.supporto) configParts.push('+ Supporto');
                                if (motoreInfo.accessori?.ruota_60) configParts.push('+ Ruota 60');
                                
                                aziendaDataMot.prodotti.push({
                                    tipo: 'motore',
                                    posizione: pos.ambiente || pos.nome || pos.stanza || pos.id,
                                    quantita: quantitaProdotto,
                                    brm: { L: 0, H: 0 },
                                    fonteMisure: { L: '-', H: '-', valL: 0, valH: 0 },
                                    modello: modelloMotore.replace(/_/g, ' ').toUpperCase(),
                                    configurazione: configParts.join(' | ') || 'Solo motore',
                                    colore: '-',
                                    note: motoreInfo.note || '',
                                    prezzoUnitario: prezzoKit.totale,
                                    prezzoTotale: prezzoKit.totale * quantitaProdotto,
                                    larghezza: 0,
                                    altezza: 0,
                                    dettaglioPrezzo: prezzoKit.dettaglio  // Per popup dettaglio
                                });
                                
                                aziendaDataMot.totali.motori += quantitaProdotto;
                                aziendaDataMot.posizioniCoinvolte.add(pos.id);
                            }
                            
                            // Se nÃ© tapparella nÃ© motore, skip
                            return;
                        }
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        
                        // Per tutti gli altri prodotti (infissi, persiane, etc.)
                        let aziendaRaw;
                        if (tipoProdotto === 'blindata') {
                            aziendaRaw = prodotto.azienda || 'Oikos';
                        } else {
                            aziendaRaw = prodotto.azienda || 'Azienda Non Specificata';
                        }
                        
                        // âœ… FIX CASE-INSENSITIVE: Normalizza nome azienda
                        const { key: aziendaKey, display: aziendaDisplay } = normalizeAziendaName(aziendaRaw);
                        
                        // Inizializza azienda se non esiste
                        if (!aziendeMap.has(aziendaKey)) {
                            aziendeMap.set(aziendaKey, {
                                displayName: aziendaDisplay,  // Nome per visualizzazione
                                prodotti: [],
                                totali: {
                                    infissi: 0,
                                    tapparelle: 0,
                                    motori: 0,  // v7.998
                                    persiane: 0,
                                    cassonetti: 0,
                                    zanzariere: 0,
                                    blindate: 0
                                },
                                posizioniCoinvolte: new Set()
                            });
                        }
                        
                        const aziendaData = aziendeMap.get(aziendaKey);
                        
                        // âœ… v7.73: USA PREZZI DA PREVENTIVO (fonte unica)
                        let prezzoUnitario = null;
                        let prezzoTotale = null;
                        
                        // Chiave per lookup: posizione (1-based) + tipo prodotto
                        const chiavePrezzo = `${posIndex + 1}-${tipoProdotto}`;
                        const prezzoFromMap = prezziMap.get(chiavePrezzo);
                        
                        if (prezzoFromMap && prezzoFromMap.prezzoUnitario > 0) {
                            // âœ… USA PREZZO GIÃ€ CALCOLATO DA PREVENTIVO
                            prezzoUnitario = prezzoFromMap.prezzoUnitario;
                            prezzoTotale = prezzoFromMap.prezzoTotale;
                            console.log(`âœ… v7.73 Prezzo da Preventivo [${chiavePrezzo}]: â‚¬${prezzoUnitario.toFixed(2)} Ã— ${quantitaProdotto} = â‚¬${prezzoTotale.toFixed(2)}`);
                        } else {
                            // âš ï¸ FALLBACK: Calcola se non presente in mappa
                            console.log(`âš ï¸ v7.73 Prezzo non in mappa [${chiavePrezzo}], uso fallback`);
                            
                            // FALLBACK per tapparelle
                            if (tipoProdotto === 'tapparella') {
                                const aziendaLower = (prodotto.azienda || '').toLowerCase();
                                if (LISTINO_PLASTICINO.aziende.includes(aziendaLower) || aziendaLower.includes('plasticino') || aziendaLower.includes('solar') || aziendaLower.includes('estella')) {
                                    const L_cm = parseInt(prodotto.brm?.L) || parseInt(prodotto.larghezza) || parseInt(pos.L) || 0;
                                    const H_cm = parseInt(prodotto.brm?.H) || parseInt(prodotto.altezza) || parseInt(pos.H) || 0;
                                    if (L_cm > 0 && H_cm > 0) {
                                        const calcolo = calcolaPrezzoPLASTICINO(L_cm, H_cm, prodotto.modello || null, prodotto.colore_tipo || null);
                                        // ğŸ†• v7.81: Aggiungi guida
                                        let prezzoGuida = 0;
                                        if (prodotto.guida && prodotto.guida !== '') {
                                            const guidaCalc = calcolaPrezzoGuida(prodotto.guida, prodotto.coloreGuida || 'Argento', H_cm * 10);
                                            prezzoGuida = guidaCalc.prezzo || 0;
                                        }
                                        prezzoUnitario = calcolo.totale + prezzoGuida;
                                        prezzoTotale = prezzoUnitario * quantitaProdotto;
                                    }
                                }
                            }
                            
                            // FALLBACK per infissi
                            if (tipoProdotto === 'infisso') {
                                const aziendaLower = (prodotto.azienda || '').toLowerCase();
                                if (aziendaLower.includes('finstral')) {
                                    let L_mm = parseInt(pos.misure?.LVT) || parseInt(prodotto.BRM_L) || parseInt(prodotto.brm?.L) || parseInt(prodotto.larghezza) || 0;
                                    let H_mm = parseInt(pos.misure?.HVT) || parseInt(prodotto.BRM_H) || parseInt(prodotto.brm?.H) || parseInt(prodotto.altezza) || 0;
                                    if (L_mm > 0 && H_mm > 0) {
                                        let tipoFinstral = "101";
                                        const tipoInfisso = (prodotto.tipo || '').toLowerCase();
                                        if (tipoInfisso.includes('fisso') || tipoInfisso.includes('f0')) tipoFinstral = "102";
                                        else if (tipoInfisso.includes('2')) tipoFinstral = "401";
                                        
                                        const calcolo = calcolaPrezzoFinstral({
                                            tipo: tipoFinstral,
                                            larghezza: L_mm,
                                            altezza: H_mm,
                                            telaio: prodotto.telaio || "967",
                                            materiale: (prodotto.materiale || '').toLowerCase().includes('alluminio') ? 'alluminio' : 'pvc'
                                        });
                                        if (!calcolo.errore) {
                                            prezzoUnitario = calcolo.totale;
                                            prezzoTotale = calcolo.totale * quantitaProdotto;
                                        }
                                    }
                                }
                            }
                        }
                        
                        // âœ… v7.73: Calcola misure corrette CON FONTE per debug
                        // ğŸ” v7.98: Per blindata usa LNP_L/LNP_H
                        let misureL = 0, misureH = 0;
                        let fonteL = '', fonteH = '';
                        
                        if (tipoProdotto === 'blindata') {
                            // Blindata usa LNP (Luce Netta Passaggio)
                            misureL = parseInt(prodotto.LNP_L) || 0;
                            misureH = parseInt(prodotto.LNP_H) || 0;
                            fonteL = 'LNP_L';
                            fonteH = 'LNP_H';
                        } else {
                            // PrioritÃ  LVT/HVT
                            if (pos.misure?.LVT) {
                                misureL = parseInt(pos.misure.LVT);
                                fonteL = 'LVT';
                            } else if (prodotto.BRM_L) {
                                misureL = parseInt(prodotto.BRM_L);
                                fonteL = 'BRM_L';
                            } else if (prodotto.brm?.L) {
                                misureL = parseInt(prodotto.brm.L);
                                fonteL = 'brm.L';
                            } else if (prodotto.larghezza) {
                                misureL = parseInt(prodotto.larghezza);
                                fonteL = 'larg';
                            }
                            
                            if (pos.misure?.HVT) {
                                misureH = parseInt(pos.misure.HVT);
                                fonteH = 'HVT';
                            } else if (prodotto.BRM_H) {
                                misureH = parseInt(prodotto.BRM_H);
                                fonteH = 'BRM_H';
                            } else if (prodotto.brm?.H) {
                                misureH = parseInt(prodotto.brm.H);
                                fonteH = 'brm.H';
                            } else if (prodotto.altezza) {
                                misureH = parseInt(prodotto.altezza);
                                fonteH = 'alt';
                            }
                        }
                        
                        // Aggiungi prodotto (NON tapparelle - giÃ  gestite sopra)
                        // ğŸ” v7.98: Per blindata modello = versione
                        // âœ… v8.11: Per cassonetto modello = materialeCass + codiceCass (es. "PVC 300")
                        let modelloEffettivo = 'N/D';
                        if (tipoProdotto === 'blindata') {
                            modelloEffettivo = prodotto.versione || 'E3';
                        } else if (tipoProdotto === 'cassonetto') {
                            const mat = prodotto.materialeCass || 'PVC';
                            const cod = prodotto.codiceCass || '';
                            modelloEffettivo = cod ? `${mat} ${cod}` : mat;
                        } else {
                            modelloEffettivo = prodotto.tipo || 'N/D';
                        }
                        
                        aziendaData.prodotti.push({
                            tipo: tipoProdotto,
                            posizione: pos.ambiente || pos.nome || pos.stanza || pos.id,
                            quantita: quantitaProdotto,
                            brm: { L: misureL, H: misureH },
                            fonteMisure: { L: fonteL, H: fonteH, valL: misureL, valH: misureH },
                            modello: modelloEffettivo,
                            configurazione: tipoProdotto === 'blindata' ? 
                                `${prodotto.tipoAnta === 'doppia' ? '2 Ante' : '1 Anta'} | ${prodotto.sensoApertura || ''} | ${prodotto.controtelaio === 'si' ? 'Con CT' : 'Senza CT'}` :
                                (tipoProdotto === 'cassonetto' ? 
                                    (prodotto.isolamentoPosaclima ? 'Con Posaclima' : 'Standard') :
                                    getProdottoConfigString(prodotto)),
                            // âœ… v8.11: Per cassonetto usa coloreCass
                            colore: tipoProdotto === 'blindata' ? (prodotto.coloreTelaio || 'RAL8022') : 
                                    (tipoProdotto === 'cassonetto' ? (prodotto.coloreCass || 'Bianco') :
                                    (prodotto.finitura_int || prodotto.colore || 'N/D')),
                            note: prodotto.note || '',
                            prezzoUnitario: prezzoUnitario,
                            prezzoTotale: prezzoTotale,
                            larghezza: misureL,
                            altezza: misureH
                        });
                        
                        // Aggiorna totali
                        if (tipoProdotto === 'infisso') aziendaData.totali.infissi += quantitaProdotto;
                        else if (tipoProdotto === 'persiana') aziendaData.totali.persiane += quantitaProdotto;
                        else if (tipoProdotto === 'cassonetto') aziendaData.totali.cassonetti += quantitaProdotto;
                        else if (tipoProdotto === 'zanzariera') aziendaData.totali.zanzariere += quantitaProdotto;
                        else if (tipoProdotto === 'blindata') aziendaData.totali.blindate += quantitaProdotto;
                        
                        // Aggiungi posizione coinvolta
                        aziendaData.posizioniCoinvolte.add(pos.id);
                    }
                });
            });
            
            return aziendeMap;
        }

        // Helper: Ottieni stringa configurazione prodotto
        function getProdottoConfigString(prodotto) {
            const parts = [];
            
            if (prodotto.apertura) parts.push(formatAperturaLabel(prodotto.apertura));
            if (prodotto.motorizzazione === 'si') parts.push('Motorizzata');
            if (prodotto.allarme === 'si') parts.push('Con Allarme');
            if (prodotto.materiale) parts.push(prodotto.materiale);
            
            return parts.length > 0 ? parts.join(' | ') : 'Standard';
        }
        
        // ğŸ”Œ v7.998: Helper per configurazione motore
        function getMotoreConfigString(prodotto) {
            const parts = [];
            const motoreInfo = prodotto.motori?.[0] || {};
            
            // Accessori
            if (motoreInfo.accessori?.supporto) parts.push('+ Supporto');
            if (motoreInfo.accessori?.ruota_60) parts.push('+ Ruota 60');
            if (motoreInfo.accessori?.corona_60) parts.push('+ Corona');
            
            // Comando
            if (motoreInfo.comandoId) parts.push(`Cmd: ${motoreInfo.comandoId}`);
            
            return parts.length > 0 ? parts.join(' | ') : 'Solo motore';
        }

        // Helper: Format apertura label
        function formatAperturaLabel(apertura) {
            const labels = {
                'battente_1_anta': '1 Anta',
                'battente_2_ante': '2 Ante',
                'scorrevole': 'Scorrevole',
                'vasistas': 'Vasistas',
                'ribalta': 'Ribalta',
                'basculante': 'Basculante'
            };
            return labels[apertura] || apertura;
        }

        // ğŸ†• Render configurazioni prodotti per specifica azienda
        // ============================================================================
        // ğŸ”„ v8.03: CONFIGURAZIONE SPECIFICA PER AZIENDA
        // Mostra SOLO la configurazione relativa ai prodotti di questa azienda
        // ============================================================================
        function renderConfigurazioniProdottiAzienda(aziendaData, projectData) {
            if (!projectData) return '';
            
            const aziendaNameLower = (aziendaData.displayName || '').toLowerCase();
            const configurazioni = [];
            
            // INFISSI - Solo se questa azienda ha infissi
            if (aziendaData.totali.infissi > 0 && projectData.configInfissi) {
                const cfg = projectData.configInfissi;
                configurazioni.push({
                    tipo: 'Infissi',
                    icon: 'ğŸªŸ',
                    color: '#0ea5e9',
                    bgColor: '#f0f9ff',
                    fields: [
                        { label: 'Azienda', value: cfg.azienda },
                        { label: 'Telaio', value: cfg.telaio },
                        { label: 'Tipo Anta', value: cfg.tipoAnta },
                        { label: 'Finitura INT', value: cfg.finIntMateriale && cfg.finIntCodice ? 
                            `${cfg.finIntMateriale} + ${cfg.finIntCodice}${cfg.finIntDescrizione ? ' - ' + cfg.finIntDescrizione : ''}` : cfg.coloreInterno },
                        { label: 'Finitura EST', value: cfg.finEstMateriale && cfg.finEstCodice ? 
                            `${cfg.finEstMateriale} + ${cfg.finEstCodice}${cfg.finEstDescrizione ? ' - ' + cfg.finEstDescrizione : ''}` : cfg.coloreEsterno },
                        { label: 'Vetro', value: cfg.vetro },
                        { label: 'Maniglia', value: cfg.maniglia },
                        { label: 'Tagli Telaio', value: cfg.tagliTelaio },
                        { label: 'Allarme', value: cfg.allarme }
                    ].filter(f => f.value && f.value !== 'N/D')
                });
            }
            
            // TAPPARELLE - Solo se questa azienda ha tapparelle
            if (aziendaData.totali.tapparelle > 0 && projectData.configTapparelle) {
                const cfg = projectData.configTapparelle;
                configurazioni.push({
                    tipo: 'Tapparelle',
                    icon: 'ğŸ”½',
                    color: '#10b981',
                    bgColor: '#ecfdf5',
                    fields: [
                        { label: 'Azienda', value: cfg.azienda },
                        { label: 'Modello', value: cfg.modello },
                        { label: 'Colore', value: cfg.colore },
                        { label: 'Tipo Guida', value: cfg.guidaTipo },
                        { label: 'Colore Guida', value: cfg.guidaColore }
                    ].filter(f => f.value && f.value !== 'N/D')
                });
            }
            
            // MOTORI - Solo se questa azienda ha motori (Somfy)
            if (aziendaData.totali.motori > 0) {
                configurazioni.push({
                    tipo: 'Motori',
                    icon: 'ğŸ”Œ',
                    color: '#f59e0b',
                    bgColor: '#fffbeb',
                    fields: [
                        { label: 'Azienda', value: 'Somfy' },
                        { label: 'Linea', value: 'Oximo io' },
                        { label: 'Tecnologia', value: 'Radio io-homecontrolÂ®' }
                    ]
                });
            }
            
            // CASSONETTI - Solo se questa azienda ha cassonetti
            if (aziendaData.totali.cassonetti > 0 && projectData.configCassonetti) {
                const cfg = projectData.configCassonetti;
                configurazioni.push({
                    tipo: 'Cassonetti',
                    icon: 'ğŸ“¦',
                    color: '#8b5cf6',
                    bgColor: '#f5f3ff',
                    fields: [
                        { label: 'Azienda', value: cfg.azienda },
                        { label: 'Tipo', value: cfg.tipo },
                        { label: 'Materiale', value: cfg.materiale },
                        { label: 'Finitura', value: cfg.finitura },
                        { label: 'Coibentazione', value: cfg.coibentazione }
                    ].filter(f => f.value && f.value !== 'N/D')
                });
            }
            
            // PERSIANE - Solo se questa azienda ha persiane
            if (aziendaData.totali.persiane > 0 && projectData.configPersiane) {
                const cfg = projectData.configPersiane;
                configurazioni.push({
                    tipo: 'Persiane',
                    icon: 'ğŸªŸ',
                    color: '#ec4899',
                    bgColor: '#fdf2f8',
                    fields: [
                        { label: 'Azienda', value: cfg.azienda },
                        { label: 'Modello', value: cfg.modello },
                        { label: 'Colore', value: cfg.colore },
                        { label: 'Materiale', value: cfg.materiale }
                    ].filter(f => f.value && f.value !== 'N/D')
                });
            }
            
            // ZANZARIERE - Solo se questa azienda ha zanzariere
            if (aziendaData.totali.zanzariere > 0 && projectData.configZanzariere) {
                const cfg = projectData.configZanzariere;
                configurazioni.push({
                    tipo: 'Zanzariere',
                    icon: 'ğŸ¦Ÿ',
                    color: '#06b6d4',
                    bgColor: '#ecfeff',
                    fields: [
                        { label: 'Azienda', value: cfg.azienda },
                        { label: 'Modello PF', value: cfg.modelloPF },
                        { label: 'Modello F', value: cfg.modelloF },
                        { label: 'Colore', value: cfg.colore }
                    ].filter(f => f.value && f.value !== 'N/D')
                });
            }
            
            // BLINDATE - Solo se questa azienda ha blindate
            if (aziendaData.totali.blindate > 0 && projectData.configBlindate) {
                const cfg = projectData.configBlindate;
                configurazioni.push({
                    tipo: 'Blindate',
                    icon: 'ğŸ”',
                    color: '#dc2626',
                    bgColor: '#fef2f2',
                    fields: [
                        { label: 'Azienda', value: cfg.azienda || 'Oikos' },
                        { label: 'Versione', value: cfg.versione },
                        { label: 'Classe', value: cfg.classe },
                        { label: 'Pannello EST', value: cfg.pannelloEst },
                        { label: 'Pannello INT', value: cfg.pannelloInt }
                    ].filter(f => f.value && f.value !== 'N/D')
                });
            }
            
            // Se non ci sono configurazioni, non mostrare nulla
            if (configurazioni.length === 0) return '';
            
            // ğŸ”„ v8.03: Genera HTML con box separati per ogni tipo prodotto
            return `
                <div class="azienda-configurazioni">
                    <h3 class="azienda-config-title">
                        âš™ï¸ Configurazione Prodotti ${aziendaData.displayName}
                    </h3>
                    <div class="azienda-config-grid">
                        ${configurazioni.map(config => `
                            <div class="azienda-config-box" style="background: ${config.bgColor}; border-left: 4px solid ${config.color};">
                                <div class="azienda-config-header" style="color: ${config.color};">
                                    <span>${config.icon}</span> ${config.tipo}
                                </div>
                                <div class="azienda-config-fields">
                                    ${config.fields.map(field => `
                                        <div class="azienda-config-field">
                                            <span class="azienda-config-label">${field.label}:</span>
                                            <span class="azienda-config-value">${field.value}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Render singola card azienda
        function renderAziendaCard(aziendaName, aziendaData, projectData) {
            const totaleProdotti = aziendaData.prodotti.length;
            const totaleQuantita = aziendaData.prodotti.reduce((sum, p) => sum + p.quantita, 0);
            const posizioniCount = aziendaData.posizioniCoinvolte.size;
            const totaleEuro = aziendaData.prodotti.reduce((sum, p) => sum + (p.prezzoTotale || 0), 0);
            
            // ğŸ’° v8.14: Calcola totale netto con sconto fornitore
            const scontoFornitore = SCONTI_FORNITORI.getSconto(aziendaName);
            const totaleNetto = totaleEuro * (1 - scontoFornitore / 100);
            
            // Determina quali badge mostrare
            const badges = [];
            if (aziendaData.totali.infissi > 0) badges.push({ label: `${aziendaData.totali.infissi} Infissi`, class: 'infissi' });
            if (aziendaData.totali.tapparelle > 0) badges.push({ label: `${aziendaData.totali.tapparelle} Tapparelle`, class: 'tapparelle' });
            if (aziendaData.totali.motori > 0) badges.push({ label: `${aziendaData.totali.motori} Motori`, class: 'motori' });
            if (aziendaData.totali.persiane > 0) badges.push({ label: `${aziendaData.totali.persiane} Persiane`, class: 'persiane' });
            if (aziendaData.totali.cassonetti > 0) badges.push({ label: `${aziendaData.totali.cassonetti} Cassonetti`, class: 'cassonetti' });
            if (aziendaData.totali.zanzariere > 0) badges.push({ label: `${aziendaData.totali.zanzariere} Zanzariere`, class: 'zanzariere' });
            if (aziendaData.totali.blindate > 0) badges.push({ label: `${aziendaData.totali.blindate} Blindate`, class: 'blindate' });
            
            // ğŸ†• v8.03: Estrai configurazioni prodotti per questa azienda
            const configHTML = renderConfigurazioniProdottiAzienda(aziendaData, projectData);
            
            return `
                <div class="azienda-card">
                    <!-- Header con totale in evidenza -->
                    <div class="azienda-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
                        <div class="azienda-header-left">
                            <div class="azienda-name" style="font-size: 1.4rem;">
                                <span class="azienda-name-icon">ğŸ­</span>
                                ${aziendaName}
                            </div>
                            <div class="azienda-badges" style="margin-top: 0.5rem;">
                                ${badges.map(badge => `
                                    <span class="azienda-badge ${badge.class}">${badge.label}</span>
                                `).join('')}
                            </div>
                        </div>
                        <!-- ğŸ’° v8.14: Box con Listino e Netto -->
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <div style="background: #fef3c7; color: #92400e; padding: 0.75rem 1rem; border-radius: 8px; text-align: right;">
                                <div style="font-size: 0.7rem; text-transform: uppercase;">Listino</div>
                                <div style="font-size: 1.2rem; font-weight: 700;">â‚¬ ${totaleEuro.toFixed(2)}</div>
                                <div style="font-size: 0.7rem;">-${scontoFornitore}%</div>
                            </div>
                            <div class="azienda-totale-box" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 0.75rem 1rem; border-radius: 8px; text-align: right;">
                                <div style="font-size: 0.7rem; text-transform: uppercase; opacity: 0.9;">Tuo Costo</div>
                                <div style="font-size: 1.4rem; font-weight: 700;">â‚¬ ${totaleNetto.toFixed(2)}</div>
                                <div style="font-size: 0.7rem; opacity: 0.85;">${totaleQuantita} pz</div>
                            </div>
                        </div>
                    </div>

                    <!-- ğŸ†• v8.03: Configurazione Prodotti Azienda -->
                    ${configHTML}

                    <!-- ğŸ”„ v8.03: Tabella Prodotti Semplificata -->
                    <h3 style="font-size: 1rem; font-weight: 600; color: #1f2937; margin: 1.5rem 0 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        ğŸ“‹ Lista Prodotti
                    </h3>
                    <div style="overflow-x: auto;">
                        <table class="azienda-prodotti-table-v2">
                            <thead>
                                <tr>
                                    <th style="width: 100px;">Tipo</th>
                                    <th>Modello</th>
                                    <th style="width: 120px;">Misure (mm)</th>
                                    <th style="width: 50px; text-align: center;">Qty</th>
                                    <th style="width: 90px; text-align: right;">Listino</th>
                                    <th style="width: 90px; text-align: right; background: #d1fae5;">Netto</th>
                                    <th style="width: 100px;">Posizione</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${aziendaData.prodotti.map(prod => {
                                    const prezzoNetto = (prod.prezzoTotale || 0) * (1 - scontoFornitore / 100);
                                    return `
                                    <tr>
                                        <td>
                                            <span class="product-type-badge ${prod.tipo}">
                                                ${prod.tipo.charAt(0).toUpperCase() + prod.tipo.slice(1)}
                                            </span>
                                        </td>
                                        <td>
                                            <div style="font-weight: 600; color: #1f2937;">${prod.modello}</div>
                                            ${prod.configurazione && prod.configurazione !== 'Standard' ? 
                                                `<div style="font-size: 0.8rem; color: #6b7280; margin-top: 2px;">${prod.configurazione}</div>` : ''}
                                        </td>
                                        <td style="font-family: monospace; font-weight: 500;">
                                            ${prod.larghezza && prod.altezza && prod.larghezza > 0 ? 
                                                `${prod.larghezza} Ã— ${prod.altezza}` : 
                                                '-'}
                                        </td>
                                        <td style="text-align: center; font-weight: 600; color: #10b981;">${prod.quantita}</td>
                                        <td style="text-align: right; font-weight: 500; color: #92400e;">
                                            ${prod.prezzoTotale !== null && prod.prezzoTotale > 0 ? 
                                                `â‚¬ ${prod.prezzoTotale.toFixed(2)}` : '-'}
                                        </td>
                                        <td style="text-align: right; font-weight: 700; color: #059669; background: #ecfdf5;">
                                            ${prezzoNetto > 0 ? `â‚¬ ${prezzoNetto.toFixed(2)}` : '-'}
                                        </td>
                                        <td>
                                            <span class="position-tag">${prod.posizione}</span>
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                            <tfoot>
                                <tr class="azienda-totale-row">
                                    <td colspan="3" style="font-weight: 700; color: #065f46;">
                                        TOTALE ${aziendaName.toUpperCase()}
                                    </td>
                                    <td style="text-align: center; font-weight: 700; color: #065f46;">${totaleQuantita}</td>
                                    <td style="text-align: right; font-weight: 600; color: #92400e;">
                                        â‚¬ ${totaleEuro.toFixed(2)}
                                    </td>
                                    <td style="text-align: right; font-weight: 700; font-size: 1.1rem; color: #059669; background: #d1fae5;">
                                        â‚¬ ${totaleNetto.toFixed(2)}
                                    </td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Azioni Export -->
                    <div class="azienda-actions" style="margin-top: 1.5rem;">
                        <button class="azienda-action-btn primary" onclick="exportAziendaExcel('${aziendaName}')">
                            ğŸ“Š Export Excel
                        </button>
                        <button class="azienda-action-btn" onclick="copyAziendaText('${aziendaName}')">
                            ğŸ“‹ Copia Testo
                        </button>
                        <button class="azienda-action-btn" onclick="window.print()">
                            ğŸ–¨ï¸ Stampa
                        </button>
                    </div>

                    <!-- Note Fornitore -->
                    <div class="azienda-note" style="margin-top: 1.5rem;">
                        <div class="azienda-note-title">
                            ğŸ“ Note Fornitore
                        </div>
                        <textarea 
                            placeholder="Aggiungi note per questo fornitore (tempi consegna, condizioni, referente, numero ordine Odoo...)"
                            id="note-${aziendaName.replace(/\s+/g, '-')}"
                            onchange="saveAziendaNote('${aziendaName}', this.value)"
                        ></textarea>
                    </div>
                </div>
            `;
        }

        // Funzioni export (stub - da implementare completamente se necessario)
        function exportAziendaExcel(aziendaName) {
            console.log(`ğŸ“Š Export Excel per ${aziendaName} - Da implementare`);
            alert(`Funzione Export Excel per ${aziendaName}\nDa implementare con libreria XLSX`);
        }

        function copyAziendaText(aziendaName) {
            console.log(`ğŸ“‹ Copia testo per ${aziendaName}`);
            alert(`Testo copiato per ${aziendaName}!\n(Implementare copia negli appunti)`);
        }

        function saveAziendaNote(aziendaName, note) {
            console.log(`ğŸ’¾ Salvataggio note per ${aziendaName}:`, note);
            // Salva in localStorage
            const notesKey = `azienda-notes-${aziendaName}`;
            localStorage.setItem(notesKey, note);
        }

        // ============================================================================
        // POPOLA FILTRI PIANO E STANZA
        // ============================================================================
        function populateFilters() {
            const pianiSet = new Set();
            const stanzeSet = new Set();
            
            allPositionsData.forEach(pos => {
                if (pos.piano) pianiSet.add(pos.piano);
                if (pos.stanza) stanzeSet.add(pos.stanza);
            });
            
            // Popola select piano
            const filterPiano = document.getElementById('filterPiano');
            filterPiano.innerHTML = '<option value="">Tutti i piani</option>';
            Array.from(pianiSet).sort().forEach(piano => {
                filterPiano.innerHTML += `<option value="${piano}">${piano}</option>`;
            });
            
            // Popola select stanza
            const filterStanza = document.getElementById('filterStanza');
            filterStanza.innerHTML = '<option value="">Tutte le stanze</option>';
            Array.from(stanzeSet).sort().forEach(stanza => {
                filterStanza.innerHTML += `<option value="${stanza}">${stanza}</option>`;
            });
        }

        // ============================================================================
        // FILTRA POSIZIONI
        // ============================================================================
        function filterPositions() {
            const piano = document.getElementById('filterPiano').value;
            const stanza = document.getElementById('filterStanza').value;
            
            filteredPositions = allPositionsData.filter(pos => {
                const matchPiano = !piano || pos.piano === piano;
                const matchStanza = !stanza || pos.stanza === stanza;
                return matchPiano && matchStanza;
            });
            
            // Reset index
            currentPositionIndex = 0;
            
            // Re-render
            renderPositionsList();
            if (filteredPositions.length > 0) {
                renderPositionDetail(0);
            }
        }

        // ============================================================================
        // RENDER LISTA POSIZIONI SIDEBAR
        // ============================================================================
        function renderPositionsList() {
            const container = document.getElementById('positionsList');
            const countSpan = document.getElementById('positionsCount');
            
            countSpan.textContent = `(${filteredPositions.length})`;
            
            container.innerHTML = filteredPositions.map((pos, index) => `
                <div class="position-list-item ${index === currentPositionIndex ? 'active' : ''}" 
                     onclick="selectPosition(${index})">
                    <div class="position-item-details" style="padding: 0.75rem;">
                        <strong>${pos.ambiente || pos.nome || pos.stanza || 'Posizione ' + (index + 1)}</strong>
                    </div>
                </div>
            `).join('');
        }

        // ============================================================================
        // SELEZIONA POSIZIONE
        // ============================================================================
        function selectPosition(index) {
            currentPositionIndex = index;
            renderPositionsList();
            renderPositionDetail(index);
            
            // Scroll to top della card
            document.querySelector('.position-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ============================================================================
        // RENDER CONFIG GLOBALE INFISSI
        // ============================================================================
        /**
         * ğŸš« v7.94: Funzione DEPRECATA - Config globale ora Ã¨ dentro i tabs
         * @deprecated Use renderConfigGlobaleInTab() instead
         */
        function renderConfigGlobale() {
            console.log('âš ï¸ v7.94: renderConfigGlobale() DEPRECATA - Config ora dentro i tabs prodotto');
            // Non fare nulla - la config globale ora Ã¨ dentro ogni tab
            return;
        }
        
        function toggleConfigGlobale() {
            const content = document.getElementById('configContent');
            const toggle = document.getElementById('configToggle');
            
            if (!content || !toggle) return;
            
            content.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }
        
        /**
         * ğŸ†• v7.94: Toggle per config globale dentro i tabs
         */
        function toggleConfigGlobaleTab(tipo) {
            const content = document.getElementById(`configContent_${tipo}`);
            const toggle = document.getElementById(`configToggle_${tipo}`);
            
            if (!content || !toggle) return;
            
            content.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }
        
        /**
         * ğŸ†• v7.94: Genera HTML per Configurazione Globale DENTRO il tab prodotto
         */
        function renderConfigGlobaleInTab(tipo, config) {
            if (!config || Object.keys(config).length === 0) {
                return `
                    <div class="config-globale-intab">
                        <div class="config-globale-header-intab" onclick="toggleConfigGlobaleTab('${tipo}')">
                            <div class="config-globale-title-intab">
                                <span>âš™ï¸</span>
                                <span>CONFIGURAZIONE GLOBALE ${tipo.toUpperCase()}</span>
                            </div>
                            <div class="config-globale-toggle-intab" id="configToggle_${tipo}">â–¼</div>
                        </div>
                        <div class="config-globale-content-intab" id="configContent_${tipo}">
                            <p style="color: #9ca3af; font-style: italic; padding: 1rem;">Nessuna configurazione globale</p>
                        </div>
                    </div>
                `;
            }
            
            let items = [];
            
            if (tipo === 'infisso') {
                // Costruisci finitura INT completa
                const finIntCompleta = config.finituraInt ? 
                    `${config.finituraInt}${config.coloreInt ? ' + ' + config.coloreInt : ''}` : 'N/D';
                const finEstCompleta = config.finituraEst ? 
                    `${config.finituraEst}${config.coloreEst ? ' + ' + config.coloreEst : ''}` : 'N/D';
                const manigliaCompleta = config.maniglia ? 
                    `${config.maniglia}${config.coloreManiglia ? ' + ' + config.coloreManiglia : ''}` : 'N/D';
                const tagliCompleti = config.tagliTelaio ? 
                    `${config.tagliTelaio}${config.codTagli?.length > 0 ? ' [' + config.codTagli.join(', ') + ']' : ''}` : 'N/D';
                
                items = [
                    { label: 'ğŸ­ AZIENDA', value: config.azienda || 'N/D' },
                    { label: 'ğŸªŸ TELAIO', value: config.telaio || 'N/D' },
                    { label: 'ğŸ¨ FINITURA INT', value: finIntCompleta },
                    { label: 'ğŸ¨ FINITURA EST', value: finEstCompleta },
                    { label: 'ğŸ“ TIPO ANTA', value: config.tipoAnta || 'N/D' },
                    { label: 'ğŸ’ VETRO', value: config.vetro || 'N/D' },
                    { label: 'ğŸ”§ MANIGLIA', value: manigliaCompleta },
                    { label: 'âœ‚ï¸ TAGLI TELAIO', value: tagliCompleti },
                    { label: 'ğŸ”” ALLARME', value: config.allarme || 'N/D' }
                ];
            } else if (tipo === 'persiana') {
                items = [
                    { label: 'ğŸ­ AZIENDA', value: config.azienda || 'N/D' },
                    { label: 'ğŸ“‹ MODELLO', value: config.modello || 'N/D' },
                    { label: 'ğŸ¨ COLORE PERSIANA', value: config.colorePersiana || 'N/D' },
                    { label: 'ğŸ”§ FISSAGGIO', value: config.fissaggio || 'N/D' }
                ];
                
                // Mostra colore telaio SOLO se ha un valore (esportato solo se fissaggio=telaio)
                if (config.coloreTelaio) {
                    items.push({ label: 'ğŸ¨ COLORE TELAIO', value: config.coloreTelaio });
                }
                
                items.push(
                    { label: 'ğŸ“ TIPO', value: config.tipo || 'N/D' },
                    { label: 'ğŸšª APERTURA', value: config.apertura || 'N/D' },
                    { label: 'ğŸ“ BATTUTA', value: config.battuta || 'N/D' }
                );
            } else if (tipo === 'tapparella') {
                items = [
                    { label: 'ğŸ­ AZIENDA', value: config.azienda || 'N/D' },
                    { label: 'ğŸ“‹ MODELLO TELO', value: config.modelloTelo || 'N/D' },
                    { label: 'ğŸ¨ COLORE TELO', value: config.coloreTelo || 'N/D' },
                    { label: 'âš™ï¸ TIPO MANOVRA', value: config.tipoManovra || 'N/D' },
                    { label: 'ğŸ”§ MOTORE', value: config.motore || 'N/D' }
                ];
            } else if (tipo === 'cassonetto') {
                // ğŸ”§ v8.11: Usa campi corretti da configCassonetti
                const modelloCompleto = config.materialeCass && config.codiceCass 
                    ? `${config.materialeCass} ${config.codiceCass}` 
                    : (config.modello || 'N/D');
                const coloreCompleto = config.coloreCass || config.gruppoColoreCass || config.colore || 'N/D';
                const isolamento = config.codiceIsolamento || 'N/D';
                
                items = [
                    { label: 'ğŸ­ AZIENDA', value: config.azienda || 'N/D' },
                    { label: 'ğŸ“‹ MODELLO', value: modelloCompleto },
                    { label: 'ğŸ¨ COLORE', value: coloreCompleto },
                    { label: 'ğŸ“ TIPO', value: config.tipo || 'N/D' },
                    { label: 'ğŸ§Š ISOLAMENTO', value: isolamento }
                ];
            } else if (tipo === 'zanzariera') {
                items = [
                    { label: 'ğŸ­ AZIENDA', value: config.azienda || 'N/D' },
                    { label: 'ğŸ“‹ MODELLO', value: config.modello || 'N/D' },
                    { label: 'ğŸ¨ COLORE', value: config.colore || 'N/D' },
                    { label: 'ğŸ“ TIPO', value: config.tipo || 'N/D' }
                ];
            }
            
            return `
                <div class="config-globale-intab">
                    <div class="config-globale-header-intab" onclick="toggleConfigGlobaleTab('${tipo}')">
                        <div class="config-globale-title-intab">
                            <span>âš™ï¸</span>
                            <span>CONFIGURAZIONE GLOBALE ${tipo.toUpperCase()}</span>
                        </div>
                        <div class="config-globale-toggle-intab" id="configToggle_${tipo}">â–¼</div>
                    </div>
                    <div class="config-globale-content-intab" id="configContent_${tipo}">
                        ${items.map(item => `
                            <div class="config-item-intab">
                                <div class="config-item-label-intab">${item.label}</div>
                                <div class="config-item-value-intab ${item.value === 'N/D' ? 'empty' : ''}">${item.value}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ============================================================================
        // âœ… v7.73: FUNZIONI MENU CONFIGURAZIONE PRODOTTI
        // ============================================================================
        
        /**
         * Switch tra tab categorie
         */
        function switchConfigTab(categoria) {
            // Rimuovi active da tutti i tab e pannelli
            document.querySelectorAll('.config-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.config-panel').forEach(panel => panel.classList.remove('active'));
            
            // Attiva tab cliccato
            const tabs = document.querySelectorAll('.config-tab');
            tabs.forEach(tab => {
                if (tab.textContent.toLowerCase().includes(categoria.substring(0, 4))) {
                    tab.classList.add('active');
                }
            });
            
            // Attiva pannello
            const panelId = `configPanel${categoria.charAt(0).toUpperCase() + categoria.slice(1)}`;
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.add('active');
                renderConfigPanel(categoria);
            }
        }
        
        /**
         * Render pannello configurazione
         */
        function renderConfigPanel(categoria) {
            const panelId = `configPanel${categoria.charAt(0).toUpperCase() + categoria.slice(1)}`;
            const panel = document.getElementById(panelId);
            
            if (!panel || !DATABASE_CONFIGURAZIONI[categoria]) return;
            
            const config = DATABASE_CONFIGURAZIONI[categoria];
            const valoriSalvati = configCorrente[categoria] || {};
            
            console.log(`ğŸ“‹ v7.80 renderConfigPanel(${categoria}):`, JSON.stringify(valoriSalvati));
            
            // Helper per escape HTML
            const escapeHtml = (str) => {
                if (!str) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            };
            
            let html = '<div class="config-fields-grid">';
            
            for (const [campo, configCampo] of Object.entries(config)) {
                const valoreSalvato = valoriSalvati[campo] || '';
                
                // Opzioni dal config
                let opzioni = configCampo.options || [];
                
                // v7.80: Matching migliorato - cerca esatto o contenuto
                const valoreLower = (valoreSalvato || '').toString().toLowerCase().trim();
                let matchedOption = null;
                let isInOptions = false;
                
                if (valoreLower) {
                    // Prima cerca match esatto
                    matchedOption = opzioni.find(opt => opt.toLowerCase() === valoreLower);
                    
                    // Se non trovato, cerca match parziale
                    if (!matchedOption) {
                        matchedOption = opzioni.find(opt => 
                            opt.toLowerCase().includes(valoreLower) || 
                            valoreLower.includes(opt.toLowerCase())
                        );
                    }
                    
                    isInOptions = !!matchedOption;
                }
                
                const isCustom = valoreSalvato && !isInOptions;
                
                console.log(`   ğŸ“Œ ${campo}: "${valoreSalvato}" â†’ match: ${matchedOption || 'CUSTOM'}`);
                
                html += `
                    <div class="config-field ${valoreSalvato ? 'modified' : ''}" data-campo="${campo}">
                        <div class="config-field-label">${configCampo.label}</div>
                        <select class="config-select" 
                                onchange="handleConfigSelect(this, '${categoria}', '${campo}')"
                                data-categoria="${categoria}"
                                data-campo="${campo}">
                            <option value="">-- Seleziona --</option>
                            ${opzioni.map(opt => {
                                const isSelected = matchedOption && opt.toLowerCase() === matchedOption.toLowerCase();
                                return `<option value="${escapeHtml(opt)}" ${isSelected ? 'selected' : ''}>${escapeHtml(opt)}</option>`;
                            }).join('')}
                            ${configCampo.allowCustom ? `<option value="__custom__" ${isCustom ? 'selected' : ''}>âœï¸ Altro...</option>` : ''}
                        </select>
                        ${configCampo.allowCustom ? `
                            <input type="text" 
                                   class="config-custom-input ${isCustom ? '' : 'hidden'}"
                                   placeholder="Inserisci valore..."
                                   value="${escapeHtml(isCustom ? valoreSalvato : '')}"
                                   onchange="handleConfigCustomInput(this, '${categoria}', '${campo}')"
                                   data-categoria="${categoria}"
                                   data-campo="${campo}">
                        ` : ''}
                    </div>
                `;
            }
            
            html += '</div>';
            panel.innerHTML = html;
        }
        
        /**
         * Gestione selezione da dropdown
         */
        function handleConfigSelect(select, categoria, campo) {
            const value = select.value;
            const customInput = select.parentElement.querySelector('.config-custom-input');
            
            if (value === '__custom__') {
                if (customInput) {
                    customInput.classList.remove('hidden');
                    customInput.focus();
                }
            } else {
                if (customInput) {
                    customInput.classList.add('hidden');
                    customInput.value = '';
                }
                
                if (!configCorrente[categoria]) configCorrente[categoria] = {};
                configCorrente[categoria][campo] = value;
                
                // Aggiorna UI
                const fieldElement = select.closest('.config-field');
                if (value) {
                    fieldElement.classList.add('modified');
                } else {
                    fieldElement.classList.remove('modified');
                }
                
                console.log(`ğŸ“ Config ${categoria}.${campo} = "${value}"`);
                
                // Gestione campo collegato rivestimentoEst â†’ coloreEst
                if (categoria === 'infissi' && campo === 'rivestimentoEst') {
                    aggiornaOpzioniColoreEsterno(value);
                }
            }
        }
        
        /**
         * Gestione input custom
         */
        function handleConfigCustomInput(input, categoria, campo) {
            const value = input.value.trim();
            
            if (!configCorrente[categoria]) configCorrente[categoria] = {};
            configCorrente[categoria][campo] = value;
            
            const fieldElement = input.closest('.config-field');
            if (value) {
                fieldElement.classList.add('modified');
            } else {
                fieldElement.classList.remove('modified');
            }
            
            console.log(`ğŸ“ Config ${categoria}.${campo} = "${value}" (custom)`);
        }
        
        /**
         * Aggiorna opzioni colore esterno in base al rivestimento
         */
        function aggiornaOpzioniColoreEsterno(rivestimento) {
            const config = DATABASE_CONFIGURAZIONI.infissi.coloreEst;
            const selectColoreEst = document.querySelector('[data-categoria="infissi"][data-campo="coloreEst"]');
            
            if (!selectColoreEst) return;
            
            const isAlluminio = rivestimento && !rivestimento.toUpperCase().startsWith('NO');
            const opzioni = isAlluminio ? config.optionsAlluminio : config.optionsPVC;
            const labelTipo = isAlluminio ? '(Alu â—‡â—†)' : '(PVC â—‹â—)';
            
            const valoreCorrente = configCorrente.infissi?.coloreEst || '';
            
            let html = `<option value="">-- Seleziona ${labelTipo} --</option>`;
            opzioni.forEach(opt => {
                html += `<option value="${opt}" ${valoreCorrente === opt ? 'selected' : ''}>${opt}</option>`;
            });
            if (config.allowCustom) {
                html += `<option value="__custom__">âœï¸ Altro...</option>`;
            }
            
            selectColoreEst.innerHTML = html;
            
            const labelElement = selectColoreEst.closest('.config-field')?.querySelector('.config-field-label');
            if (labelElement) {
                labelElement.textContent = `ğŸ¨ Colore Est ${labelTipo}`;
            }
            
            console.log(`ğŸ”„ Colore Est aggiornato per ${isAlluminio ? 'Alluminio' : 'PVC'}`);
        }
        
        /**
         * Salva configurazione globale
         */
        function salvaConfigGlobaleMenu() {
            if (!projectData) {
                showAlert('error', 'âŒ Nessun progetto caricato');
                return;
            }
            
            projectData.configInfissi = configCorrente.infissi;
            projectData.configPersiane = configCorrente.persiane;
            projectData.configTapparelle = configCorrente.tapparelle;
            projectData.configCassonetti = configCorrente.cassonetti;
            projectData.configZanzariere = configCorrente.zanzariere;
            
            showAlert('success', 'âœ… Configurazione globale salvata!');
            console.log('ğŸ’¾ Configurazione salvata:', configCorrente);
        }
        
        /**
         * Reset configurazione
         */
        function resetConfigGlobaleMenu() {
            if (!confirm('Resettare tutti i valori di configurazione?')) return;
            
            configCorrente = {
                infissi: {},
                persiane: {},
                tapparelle: {},
                cassonetti: {},
                zanzariere: {}
            };
            
            // Re-render pannello attivo
            const activePanel = document.querySelector('.config-panel.active');
            if (activePanel) {
                const categoria = activePanel.id.replace('configPanel', '').toLowerCase();
                renderConfigPanel(categoria);
            }
            
            showAlert('success', 'ğŸ”„ Configurazione resettata');
        }
        
        /**
         * Inizializza menu configurazione
         */
        function initConfigMenu() {
            console.log('ğŸ”„ v8.17 initConfigMenu() chiamato');
            console.log('   ğŸ“¦ projectData exists:', !!projectData);
            console.log('   ğŸ“¦ projectData.configInfissi:', projectData?.configInfissi);
            
            // Mostra container (opzionale - potrebbe non esistere in tutte le viste)
            const container = document.getElementById('configMenuContainer');
            if (container) {
                container.style.display = 'block';
            } else {
                // v8.16: Non Ã¨ un errore, il container potrebbe non essere presente in questa vista
                console.log('â„¹ï¸ configMenuContainer non presente (normale in alcune viste)');
            }
            
            // âœ… v7.80: Carica config da progetto
            if (projectData && projectData.configInfissi) {
                configCorrente = {
                    infissi: { ...projectData.configInfissi },
                    persiane: { ...(projectData.configPersiane || {}) },
                    tapparelle: { ...(projectData.configTapparelle || {}) },
                    cassonetti: { ...(projectData.configCassonetti || {}) },
                    zanzariere: { ...(projectData.configZanzariere || {}) }
                };
                
                console.log('âœ… v7.80 configCorrente caricato:');
                console.log('   ğŸ“¦ azienda:', configCorrente.infissi.azienda);
                console.log('   ğŸ“¦ telaio:', configCorrente.infissi.telaio);
            } else {
                console.warn('âš ï¸ v7.80 projectData o configInfissi mancante!');
                configCorrente = {
                    infissi: {},
                    persiane: {},
                    tapparelle: {},
                    cassonetti: {},
                    zanzariere: {}
                };
            }
            
            // Render pannello iniziale
            renderConfigPanel('infissi');
            
            console.log('âš™ï¸ Menu configurazione inizializzato v7.80');
        }

        // ============================================================================
        // v7.997: CONFIGURAZIONE PRODOTTI GLOBALE - VERSIONE UFFICIO
        // ============================================================================
        
        /**
         * Switch tab configurazione - versione Ufficio
         */
        function switchConfigTabUfficio(categoria) {
            // Rimuovi active da tutti i tab e pannelli UFFICIO
            document.querySelectorAll('#configGlobaleUfficioContainer .config-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('#configGlobaleUfficioContainer .config-panel').forEach(panel => panel.classList.remove('active'));
            
            // Attiva tab cliccato
            const tabs = document.querySelectorAll('#configGlobaleUfficioContainer .config-tab');
            tabs.forEach(tab => {
                if (tab.textContent.toLowerCase().includes(categoria.substring(0, 4))) {
                    tab.classList.add('active');
                }
            });
            
            // Attiva pannello
            const panelId = `configPanel${categoria.charAt(0).toUpperCase() + categoria.slice(1)}Ufficio`;
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.add('active');
                renderConfigPanelUfficio(categoria);
            }
        }
        
        /**
         * Render pannello configurazione - versione Ufficio
         */
        function renderConfigPanelUfficio(categoria) {
            const panelId = `configPanel${categoria.charAt(0).toUpperCase() + categoria.slice(1)}Ufficio`;
            const panel = document.getElementById(panelId);
            
            if (!panel || !DATABASE_CONFIGURAZIONI[categoria]) return;
            
            const config = DATABASE_CONFIGURAZIONI[categoria];
            const valoriSalvati = configCorrente[categoria] || {};
            
            console.log(`ğŸ“‹ v7.997 renderConfigPanelUfficio(${categoria}):`, JSON.stringify(valoriSalvati));
            
            // Helper per escape HTML
            const escapeHtml = (str) => {
                if (!str) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            };
            
            let html = '<div class="config-fields-grid">';
            
            for (const [campo, configCampo] of Object.entries(config)) {
                const valoreSalvato = valoriSalvati[campo] || '';
                
                // Opzioni dal config
                let opzioni = configCampo.options || [];
                
                // Matching migliorato
                const valoreLower = (valoreSalvato || '').toString().toLowerCase().trim();
                let matchedOption = null;
                
                if (valoreLower) {
                    matchedOption = opzioni.find(opt => opt.toLowerCase() === valoreLower);
                    if (!matchedOption) {
                        matchedOption = opzioni.find(opt => 
                            opt.toLowerCase().includes(valoreLower) || 
                            valoreLower.includes(opt.toLowerCase())
                        );
                    }
                }
                
                const isInOptions = !!matchedOption;
                const displayValue = matchedOption || valoreSalvato;
                const hasValue = displayValue && displayValue.trim() !== '';
                const checkmark = hasValue ? 'âœ“' : '';
                const labelClass = hasValue ? 'config-label filled' : 'config-label';
                
                html += `
                    <div class="config-field">
                        <label class="${labelClass}">
                            ${configCampo.icon || ''} ${configCampo.label} ${checkmark}
                        </label>
                        <select class="config-select" 
                                data-categoria="${categoria}" 
                                data-campo="${campo}"
                                onchange="updateConfigFieldUfficio(this)">
                            <option value="">-- Seleziona --</option>
                            ${opzioni.map(opt => `
                                <option value="${escapeHtml(opt)}" ${opt.toLowerCase() === (matchedOption || '').toLowerCase() ? 'selected' : ''}>
                                    ${escapeHtml(opt)}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                `;
            }
            
            html += '</div>';
            panel.innerHTML = html;
        }
        
        /**
         * Update campo configurazione - versione Ufficio
         */
        function updateConfigFieldUfficio(select) {
            const categoria = select.dataset.categoria;
            const campo = select.dataset.campo;
            const valore = select.value;
            
            if (!configCorrente[categoria]) {
                configCorrente[categoria] = {};
            }
            
            configCorrente[categoria][campo] = valore;
            
            // Aggiorna label con checkmark
            const label = select.previousElementSibling;
            if (valore) {
                label.classList.add('filled');
                if (!label.textContent.includes('âœ“')) {
                    label.textContent = label.textContent + ' âœ“';
                }
            } else {
                label.classList.remove('filled');
                label.textContent = label.textContent.replace(' âœ“', '');
            }
            
            console.log(`ğŸ“ Config Ufficio: ${categoria}.${campo} = ${valore}`);
        }
        
        /**
         * Salva configurazione - versione Ufficio
         */
        function salvaConfigGlobaleMenuUfficio() {
            if (!projectData) {
                showAlert('error', 'âŒ Nessun progetto caricato');
                return;
            }
            
            projectData.configInfissi = configCorrente.infissi;
            projectData.configPersiane = configCorrente.persiane;
            projectData.configTapparelle = configCorrente.tapparelle;
            projectData.configCassonetti = configCorrente.cassonetti;
            projectData.configZanzariere = configCorrente.zanzariere;
            
            showAlert('success', 'âœ… Configurazione globale salvata!');
            console.log('ğŸ’¾ Configurazione salvata da Ufficio:', configCorrente);
        }
        
        /**
         * Reset configurazione - versione Ufficio
         */
        function resetConfigGlobaleMenuUfficio() {
            if (!confirm('Resettare tutti i valori di configurazione?')) return;
            
            configCorrente = {
                infissi: {},
                persiane: {},
                tapparelle: {},
                cassonetti: {},
                zanzariere: {}
            };
            
            // Re-render pannello attivo
            const activePanel = document.querySelector('#configGlobaleUfficioContainer .config-panel.active');
            if (activePanel) {
                const categoria = activePanel.id.replace('configPanel', '').replace('Ufficio', '').toLowerCase();
                renderConfigPanelUfficio(categoria);
            }
            
            showAlert('success', 'ğŸ”„ Configurazione resettata');
        }
        
        /**
         * Inizializza menu configurazione Ufficio
         */
        function initConfigMenuUfficio() {
            console.log('ğŸ”„ v7.997 initConfigMenuUfficio() chiamato');
            
            const container = document.getElementById('configGlobaleUfficioContainer');
            if (!container) {
                console.error('âŒ configGlobaleUfficioContainer non trovato!');
                return;
            }
            
            // Mostra container
            container.style.display = 'block';
            
            // Carica config da progetto
            if (projectData && projectData.configInfissi) {
                configCorrente = {
                    infissi: { ...projectData.configInfissi },
                    persiane: { ...(projectData.configPersiane || {}) },
                    tapparelle: { ...(projectData.configTapparelle || {}) },
                    cassonetti: { ...(projectData.configCassonetti || {}) },
                    zanzariere: { ...(projectData.configZanzariere || {}) }
                };
            }
            
            // Render pannello iniziale
            renderConfigPanelUfficio('infissi');
            
            console.log('âš™ï¸ Menu configurazione Ufficio inizializzato v7.997');
        }

        // ============================================================================
        // RENDER DETTAGLIO POSIZIONE
        // ============================================================================
        function renderPositionDetail(index) {
            if (index < 0 || index >= filteredPositions.length) return;
            
            const pos = filteredPositions[index];
            const container = document.getElementById('positionDetailCard');
            
            // ğŸ”„ v8.02: Nuovo ordine - Prodotti PRIMA, poi sezioni tecniche collassabili
            container.innerHTML = `
                ${renderPositionHeader(pos)}
                ${renderPositionProducts(pos)}
                ${renderPositionMeasuresCollapsible(pos)}
                ${renderPositionWallCharsCollapsible(pos)}
                ${renderPositionPreexisting(pos)}
                ${renderPositionNotes(pos)}
                ${renderPositionNavigation(index)}
            `;
            
            // Setup tabs prodotti
            setupProductTabs();
        }

        // ============================================================================
        // SEZIONE A: HEADER POSIZIONE
        // ============================================================================
        function renderPositionHeader(pos) {
            return `
                <div class="position-header">
                    <div class="position-id-large">${pos.ambiente || pos.nome || pos.stanza || 'Posizione'}</div>
                    <div class="position-location">
                        <span class="position-location-item">ğŸ“ Piano: ${pos.piano || 'N/D'}</span>
                        <span class="position-location-item">|</span>
                        <span class="position-location-item">ğŸšª N/D</span>
                    </div>
                    <div class="position-qty">QuantitÃ : ${pos.quantita || 1}</div>
                </div>
            `;
        }

        // ============================================================================
        // SEZIONE B: MISURE COMPLETE - COLLASSABILE v8.02
        // ============================================================================
        function renderPositionMeasuresCollapsible(pos) {
            const m = pos.misure || {};
            
            // ğŸ”§ Helper per convertire valore (evita [object Object])
            const getVal = (val) => {
                if (val === null || val === undefined) return null;
                if (typeof val === 'object') return null;
                return val;
            };
            
            const mainMeasures = [
                { label: 'Larghezza Vecchio Telaio (LVT)', value: getVal(m.LVT) },
                { label: 'Altezza Vecchio Telaio (HVT)', value: getVal(m.HVT) },
                { label: 'Larghezza Foro (LF)', value: getVal(m.LF) },
                { label: 'Altezza Foro (HF)', value: getVal(m.HF) },
                { label: 'Larghezza Massima Muro Int (TMV)', value: getVal(m.TMV) },
                { label: 'Altezza Massima Muro Int (HMT)', value: getVal(m.HMT) }
            ];
            
            const additionalMeasures = [
                { label: 'Larghezza Variabile (LVAR)', value: getVal(m.LVAR) },
                { label: 'Altezza Variabile (HVAR)', value: getVal(m.HVAR) },
                { label: 'Altezza Soffitto (HSoffitto)', value: getVal(m.HSoffitto) },
                { label: 'H Parapetto-Soffitto', value: getVal(m.HParapettoSoffitto) },
                { label: 'H Pavimento-Parapetto', value: getVal(m.HPavimentoParapetto) },
                { label: 'Dislivello Piana Sopra', value: getVal(m.profPianaSopra) },
                { label: 'Dislivello Piana Sotto', value: getVal(m.profPianaSotto) }
            ];
            
            // Conta misure disponibili
            const mainCount = mainMeasures.filter(m => m.value != null).length;
            const addCount = additionalMeasures.filter(m => m.value != null).length;
            const totalCount = mainCount + addCount;
            
            // Se non ci sono misure, non mostrare nulla
            if (totalCount === 0) return '';
            
            const uniqueId = 'measures_' + Math.random().toString(36).substr(2, 9);
            
            return `
                <div class="position-section collapsible-section">
                    <h3 class="position-section-title collapsible-header" onclick="toggleCollapsible('${uniqueId}')" style="cursor: pointer; user-select: none;">
                        <span class="position-section-icon">ğŸ“</span>
                        Misure Complete
                        <span style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem;">
                            <span class="collapsible-count" style="background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">${totalCount} misure</span>
                            <span class="collapsible-arrow" id="arrow_${uniqueId}" style="transition: transform 0.3s;">â–¼</span>
                        </span>
                    </h3>
                    <div class="collapsible-content" id="${uniqueId}" style="display: none; padding-top: 1rem;">
                        ${mainCount > 0 ? `
                            <h4 style="font-size: 0.95rem; font-weight: 600; color: #6b7280; margin-bottom: 1rem;">
                                Misure Principali
                            </h4>
                            <table class="measures-table">
                                <tbody>
                                    ${mainMeasures.filter(m => m.value != null).map(m => `
                                        <tr>
                                            <td class="measure-label">${m.label}</td>
                                            <td class="measure-value">
                                                <span class="measure-highlight">${m.value} mm</span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : ''}
                        
                        ${addCount > 0 ? `
                            <h4 style="font-size: 0.95rem; font-weight: 600; color: #6b7280; margin: 1.5rem 0 1rem;">
                                Misure Aggiuntive
                            </h4>
                            <table class="measures-table">
                                <tbody>
                                    ${additionalMeasures.filter(m => m.value != null).map(m => `
                                        <tr>
                                            <td class="measure-label">${m.label}</td>
                                            <td class="measure-value">${m.value} mm</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ============================================================================
        // SEZIONE C: CARATTERISTICHE MURO - COLLASSABILE v8.02
        // ============================================================================
        function renderPositionWallCharsCollapsible(pos) {
            const override = pos.caratteristiche_muro_override || {};
            const global = currentData?.caratteristiche_muro_globali || {};
            const hasOverride = Object.keys(override).length > 0;
            
            // Usa override se presente, altrimenti globale
            const chars = hasOverride ? override : global;
            
            const items = [
                { label: 'Telaio', value: chars.telaio_larghezza && chars.telaio_altezza ? 
                    `${chars.telaio_larghezza} Ã— ${chars.telaio_altezza} mm` : null },
                { label: 'Falso Esistente', value: chars.falso_esistente || null },
                { label: 'Spessore Falso', value: chars.spessore_falso ? `${chars.spessore_falso} mm` : null },
                { label: 'ProfonditÃ  Muro INT', value: chars.prof_muro_int ? `${chars.prof_muro_int} mm` : null },
                { label: 'ProfonditÃ  Muro EST', value: chars.prof_muro_est ? `${chars.prof_muro_est} mm` : null },
                { label: 'Guida Tipo', value: chars.guida_tipo || null },
                { label: 'Coprifilo', value: chars.coprifilo_larghezza ? `${chars.coprifilo_larghezza} mm` : null },
                { label: 'Battuta Sup. Tapparella', value: chars.battuta_superiore_tapparella ? 
                    `${chars.battuta_superiore_tapparella} mm` : null }
            ];
            
            // Conta solo valori reali (non N/D)
            const validItems = items.filter(item => item.value !== null);
            
            // ğŸ”„ v8.02: Se TUTTI sono null/N/D, NON mostrare la sezione
            if (validItems.length === 0) return '';
            
            const uniqueId = 'wallchars_' + Math.random().toString(36).substr(2, 9);
            
            return `
                <div class="position-section collapsible-section">
                    <h3 class="position-section-title collapsible-header" onclick="toggleCollapsible('${uniqueId}')" style="cursor: pointer; user-select: none;">
                        <span class="position-section-icon">ğŸ§±</span>
                        Caratteristiche Muro
                        ${hasOverride ? '<span class="override-badge">OVERRIDE</span>' : ''}
                        <span style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem;">
                            <span class="collapsible-count" style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">${validItems.length} dati</span>
                            <span class="collapsible-arrow" id="arrow_${uniqueId}" style="transition: transform 0.3s;">â–¼</span>
                        </span>
                    </h3>
                    <div class="collapsible-content" id="${uniqueId}" style="display: none; padding-top: 1rem;">
                        <div class="wall-chars-grid">
                            ${validItems.map(item => `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">${item.label}</div>
                                    <div class="wall-char-value">${item.value}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ğŸ”„ v8.02: Funzione toggle per sezioni collassabili
        function toggleCollapsible(id) {
            const content = document.getElementById(id);
            const arrow = document.getElementById('arrow_' + id);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                if (arrow) arrow.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            }
        }

        // ============================================================================
        // SEZIONE B LEGACY: MISURE COMPLETE (mantenuta per compatibilitÃ )
        // ============================================================================
        function renderPositionMeasures(pos) {
            return renderPositionMeasuresCollapsible(pos);
        }

        // ============================================================================
        // SEZIONE C LEGACY: CARATTERISTICHE MURO (mantenuta per compatibilitÃ )
        // ============================================================================
        function renderPositionWallChars(pos) {
            return renderPositionWallCharsCollapsible(pos);
        }

        // ============================================================================
        // SEZIONE D: PRODOTTI E CONFIGURAZIONI
        // ============================================================================
        function renderPositionProducts(pos) {
            // ğŸ” v7.98: Aggiunto blindata
            const hasProdotti = (pos.infisso && pos.infisso.quantita > 0) ||
                              (pos.tapparella && pos.tapparella.quantita > 0) ||
                              (pos.cassonetto && pos.cassonetto.quantita > 0) ||
                              (pos.persiana && pos.persiana.quantita > 0) ||
                              (pos.zanzariera && pos.zanzariera.quantita > 0) ||
                              (pos.blindata && (parseInt(pos.blindata.LNP_L) > 0 || parseInt(pos.blindata.LNP_H) > 0 || pos.blindata.versione));
            
            if (!hasProdotti) {
                return `
                    <div class="position-section">
                        <h3 class="position-section-title">
                            <span class="position-section-icon">ğŸ“¦</span>
                            Prodotti e Configurazioni
                        </h3>
                        <p style="color: #6b7280; font-style: italic;">Nessun prodotto configurato</p>
                    </div>
                `;
            }
            
            // âœ… v7.76 FIX: Determina quale prodotto Ã¨ il PRIMO disponibile (sarÃ  active)
            // ğŸ” v7.98: Aggiunto blindata e portoncino
            // ğŸ”Œ v8.00: Aggiunto motore come tab separato
            const prodotti = [
                { key: 'infisso', label: 'ğŸªŸ Infisso', data: pos.infisso },
                { key: 'tapparella', label: 'ğŸ”½ Tapparella', data: pos.tapparella },
                { key: 'motore', label: 'ğŸ”Œ Motore', data: pos.tapparella?.serveMotore ? pos.tapparella : null },  // v8.00
                { key: 'cassonetto', label: 'ğŸ“¦ Cassonetto', data: pos.cassonetto },
                { key: 'persiana', label: 'ğŸªŸ Persiana', data: pos.persiana },
                { key: 'zanzariera', label: 'ğŸ¦Ÿ Zanzariera', data: pos.zanzariera },
                { key: 'blindata', label: 'ğŸ” Blindata', data: pos.blindata || pos.ingresso?.blindata },
                { key: 'portoncino', label: 'ğŸšª Portoncino', data: pos.portoncino || pos.ingresso?.portoncino }
            ];
            
            // ğŸ†• v7.82: Filtra solo quelli con quantita > 0 (supporta sia qta che quantita)
            // ğŸ” v7.98: Blindata e Portoncino non usano quantita, controlla se esistono
            // ğŸ”Œ v8.00: Motore esiste se serveMotore=true
            const prodottiDisponibili = prodotti.filter(p => {
                if (!p.data) return false;
                if (p.key === 'blindata') {
                    return parseInt(p.data.LNP_L) > 0 || parseInt(p.data.LNP_H) > 0 || p.data.versione;
                }
                if (p.key === 'portoncino') {
                    return p.data.azienda || p.data.modelloAnta || p.data.tipoApertura || p.data.formaTelaio;
                }
                if (p.key === 'motore') {
                    // ğŸ”Œ v8.00: Motore esiste se serveMotore=true
                    return p.data.serveMotore === true;
                }
                if (p.key === 'tapparella') {
                    // ğŸ”Œ v8.00: Tapparella esiste solo se serveTapparella=true (o undefined per retrocompat)
                    const serveTap = p.data.serveTapparella !== false;
                    const qty = parseInt(p.data.quantita) || parseInt(p.data.qta) || 0;
                    return serveTap && qty > 0;
                }
                const qty = parseInt(p.data.quantita) || parseInt(p.data.qta) || 0;
                return qty > 0;
            });
            
            // Il primo Ã¨ active
            const primoProdottoKey = prodottiDisponibili.length > 0 ? prodottiDisponibili[0].key : 'infisso';
            
            // Genera tabs
            const tabsHTML = prodottiDisponibili
                .map(p => `<button class="product-tab ${p.key === primoProdottoKey ? 'active' : ''}" onclick="switchProductTab('${p.key}', event)">${p.label}</button>`)
                .join('');
            
            // Genera contenuti - SOLO il primo Ã¨ active
            const contenutiHTML = prodottiDisponibili
                .map(p => renderProductContent(p.key, p.data, p.key === primoProdottoKey))
                .join('');
            
            return `
                <div class="position-section">
                    <h3 class="position-section-title">
                        <span class="position-section-icon">ğŸ“¦</span>
                        Prodotti e Configurazioni
                    </h3>
                    
                    <div class="products-tabs">
                        ${tabsHTML}
                    </div>
                    
                    ${contenutiHTML}
                </div>
            `;
        }

        function renderProductContent(tipo, prodotto, isActive) {
            // ğŸ” v7.98: Blindata non usa quantita
            if (tipo === 'blindata') {
                return renderBlindataContent(prodotto, isActive);
            }
            
            // ğŸšª v7.98: Portoncino non usa quantita
            if (tipo === 'portoncino') {
                return renderPortoncinoContent(prodotto, isActive);
            }
            
            // ğŸ”Œ v8.00: Motore - tab separato
            if (tipo === 'motore') {
                return renderMotoreContent(prodotto, isActive);
            }
            
            // ğŸ†• v7.82: Supporta sia qta che quantita
            const qty = parseInt(prodotto?.quantita) || parseInt(prodotto?.qta) || 0;
            if (!prodotto || qty === 0) return '';
            
            // ğŸ”§ v8.09: Normalizza BRM (supporta sia brm.L che BRM_L)
            const brm = {
                L: prodotto.brm?.L || prodotto.BRM_L || 0,
                H: prodotto.brm?.H || prodotto.BRM_H || 0
            };
            
            // Per INFISSI: usa nuovo design con override detection
            if (tipo === 'infisso') {
                return renderInfissoContent(prodotto, brm, isActive);
            }
            
            // ğŸ†• v7.94: Ottieni config globale per questo tipo di prodotto
            let configGlobale = {};
            if (tipo === 'persiana') {
                configGlobale = projectData?.configPersiana || projectData?.configPersiane || {};
            } else if (tipo === 'tapparella') {
                configGlobale = projectData?.configTapparella || projectData?.configTapparelle || {};
            } else if (tipo === 'cassonetto') {
                configGlobale = projectData?.configCassonetto || projectData?.configCassonetti || {};
            } else if (tipo === 'zanzariera') {
                configGlobale = projectData?.configZanzariera || projectData?.configZanzariere || {};
            }
            
            const configGlobaleHTML = renderConfigGlobaleInTab(tipo, configGlobale);
            
            // Per ALTRI PRODOTTI: rendering completo originale
            return `
                <div class="product-content ${isActive ? 'active' : ''}" data-product="${tipo}">
                    
                    <!-- ğŸ†• v7.94: Configurazione Globale DENTRO il tab -->
                    ${configGlobaleHTML}
                    
                    ${brm.L || brm.H ? `
                        <div class="brm-box">
                            <div class="brm-title">ğŸ“ Misure BRM ${tipo.toUpperCase()}</div>
                            <div class="brm-grid">
                                ${brm.L ? `
                                    <div class="brm-item">
                                        <div class="brm-label">L (Larghezza)</div>
                                        <div class="brm-value">${brm.L} mm</div>
                                    </div>
                                ` : ''}
                                ${brm.H ? `
                                    <div class="brm-item">
                                        <div class="brm-label">H (Altezza)</div>
                                        <div class="brm-value">${brm.H} mm</div>
                                    </div>
                                ` : ''}
                                ${brm.C ? `
                                    <div class="brm-item">
                                        <div class="brm-label">C (ProfonditÃ )</div>
                                        <div class="brm-value">${brm.C} mm</div>
                                    </div>
                                ` : ''}
                                ${brm.B ? `
                                    <div class="brm-item">
                                        <div class="brm-label">B (Base)</div>
                                        <div class="brm-value">${brm.B} mm</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="wall-chars-grid" style="margin-top: 1.5rem;">
                        ${prodotto.quantita ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">QuantitÃ </div>
                                <div class="wall-char-value">${prodotto.quantita}</div>
                            </div>
                        ` : ''}
                        ${(prodotto.tipo || prodotto.apertura) && tipo === 'infisso' ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Tipo Infisso</div>
                                <div class="wall-char-value">${prodotto.tipo || ''}${prodotto.tipo && prodotto.apertura ? ' + ' : ''}${prodotto.apertura || ''}</div>
                            </div>
                        ` : ''}
                        ${prodotto.tipo && tipo !== 'infisso' ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">${
                                    tipo === 'persiana' ? 'Tipo Persiana' :
                                    tipo === 'tapparella' ? 'Tipo Tapparella' :
                                    tipo === 'zanzariera' ? 'Tipo Zanzariera' :
                                    tipo === 'cassonetto' ? 'Tipo Cassonetto' : 'Tipo'
                                }</div>
                                <div class="wall-char-value">${prodotto.tipo}</div>
                            </div>
                        ` : ''}
                        ${prodotto.azienda ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Azienda</div>
                                <div class="wall-char-value">${prodotto.azienda}</div>
                            </div>
                        ` : ''}
                        ${prodotto.telaio && tipo === 'infisso' ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Telaio</div>
                                <div class="wall-char-value">${prodotto.telaio}</div>
                            </div>
                        ` : ''}
                        ${prodotto.apertura && tipo !== 'infisso' ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Apertura</div>
                                <div class="wall-char-value">${prodotto.apertura}</div>
                            </div>
                        ` : ''}
                        ${prodotto.finitura_int ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Finitura INT</div>
                                <div class="wall-char-value">${prodotto.finitura_int}</div>
                            </div>
                        ` : ''}
                        ${prodotto.finitura_est ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Finitura EST</div>
                                <div class="wall-char-value">${prodotto.finitura_est}</div>
                            </div>
                        ` : ''}
                        ${prodotto.colore ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Colore</div>
                                <div class="wall-char-value">${prodotto.colore}</div>
                            </div>
                        ` : ''}
                        ${prodotto.motorizzazione ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Motorizzazione</div>
                                <div class="wall-char-value">${prodotto.motorizzazione}</div>
                            </div>
                        ` : ''}
                        ${prodotto.tipoInfissoAssociato ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">${tipo === 'persiana' ? 'Tipo Infisso Associato' : 'Tipo Infisso'}</div>
                                <div class="wall-char-value">${prodotto.tipoInfissoAssociato === 'F' ? 'Finestra' : 'Porta Finestra'}</div>
                            </div>
                        ` : ''}
                        ${prodotto.tagliTelaio ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Tagli Telaio</div>
                                <div class="wall-char-value">${prodotto.tagliTelaio}</div>
                            </div>
                        ` : ''}
                        ${prodotto.codTagli && prodotto.codTagli.length > 0 ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Codici Taglio</div>
                                <div class="wall-char-value">${prodotto.codTagli.join(', ')}</div>
                            </div>
                        ` : ''}
                        ${prodotto.vetro ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Vetro</div>
                                <div class="wall-char-value">${prodotto.vetro}</div>
                            </div>
                        ` : ''}
                        ${prodotto.tipoAnta ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Tipo Anta</div>
                                <div class="wall-char-value">${prodotto.tipoAnta}</div>
                            </div>
                        ` : ''}
                        ${prodotto.telaio && tipo !== 'infisso' ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Telaio</div>
                                <div class="wall-char-value">${prodotto.telaio}</div>
                            </div>
                        ` : ''}
                        ${prodotto.finituraInt ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Finitura Interna</div>
                                <div class="wall-char-value">${prodotto.finituraInt}</div>
                            </div>
                        ` : ''}
                        ${prodotto.finituraEst ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Finitura Esterna</div>
                                <div class="wall-char-value">${prodotto.finituraEst}</div>
                            </div>
                        ` : ''}
                        ${prodotto.coloreInt ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Colore Interno</div>
                                <div class="wall-char-value">${prodotto.coloreInt}</div>
                            </div>
                        ` : ''}
                        ${prodotto.coloreEst ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Colore Esterno</div>
                                <div class="wall-char-value">${prodotto.coloreEst}</div>
                            </div>
                        ` : ''}
                        ${prodotto.maniglia ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Maniglia</div>
                                <div class="wall-char-value">${prodotto.maniglia}</div>
                            </div>
                        ` : ''}
                        ${prodotto.coloreManiglia ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Colore Maniglia</div>
                                <div class="wall-char-value">${prodotto.coloreManiglia}</div>
                            </div>
                        ` : ''}
                        ${prodotto.allarme ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Allarme</div>
                                <div class="wall-char-value">${prodotto.allarme}</div>
                            </div>
                        ` : ''}
                        ${prodotto.materiale ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Materiale</div>
                                <div class="wall-char-value">${prodotto.materiale}</div>
                            </div>
                        ` : ''}
                        ${prodotto.modello ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Modello</div>
                                <div class="wall-char-value">${prodotto.modello}</div>
                            </div>
                        ` : ''}
                        ${prodotto.sistema ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Sistema</div>
                                <div class="wall-char-value">${prodotto.sistema}</div>
                            </div>
                        ` : ''}
                        ${prodotto.coibentazione ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Isolamento Posaclima</div>
                                <div class="wall-char-value">${prodotto.coibentazione}</div>
                            </div>
                        ` : ''}
                        ${prodotto.maglia ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Maglia</div>
                                <div class="wall-char-value">${prodotto.maglia}</div>
                            </div>
                        ` : ''}
                        ${prodotto.guida ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Guida</div>
                                <div class="wall-char-value">${prodotto.guida}</div>
                            </div>
                        ` : ''}
                        ${prodotto.profilo ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Profilo</div>
                                <div class="wall-char-value">${prodotto.profilo}</div>
                            </div>
                        ` : ''}
                        ${prodotto.accessori ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Accessori</div>
                                <div class="wall-char-value">${prodotto.accessori}</div>
                            </div>
                        ` : ''}
                        ${prodotto.note ? `
                            <div class="wall-char-item" style="grid-column: 1 / -1;">
                                <div class="wall-char-label">ğŸ“ Note</div>
                                <div class="wall-char-value">${prodotto.note}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        // ============================================================================
        // ğŸ”Œ v8.00: RENDER MOTORE CONTENT - TAB SEPARATO
        // ============================================================================
        function renderMotoreContent(tapparella, isActive) {
            if (!tapparella || !tapparella.serveMotore) return '';
            
            const motori = tapparella.motori || [];
            const motoreInfo = motori[0] || {};
            const modelloId = motoreInfo.modelloId || tapparella.motoreModelloDefault || 'oximo_20';
            const comandoId = motoreInfo.comandoId || tapparella.comandoDefault || '';
            const accessori = motoreInfo.accessori || {};
            const quantita = parseInt(tapparella.qta || tapparella.quantita) || 1;
            
            // Ottieni info dai database
            const motoreDb = SOMFY_PREZZI.getPrezzoMotore(modelloId);
            const comandoDb = SOMFY_PREZZI.getPrezzoComando(comandoId);
            
            // Calcola prezzo kit
            const prezzoKit = SOMFY_PREZZI.calcolaPrezzoKit(motoreInfo);
            
            return `
                <div class="product-content ${isActive ? 'active' : ''}" data-product="motore">
                    
                    <!-- Header Somfy -->
                    <div style="padding: 1rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border: 2px solid #f59e0b; margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 2rem;">ğŸ”Œ</span>
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: #92400e;">Motore ${tapparella.motoreAzienda || 'Somfy'}</div>
                                <div style="font-size: 0.9rem; color: #b45309;">QuantitÃ : ${quantita}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configurazione Motore -->
                    <div class="wall-chars-grid">
                        <div class="wall-char-item">
                            <div class="wall-char-label">ğŸ­ Azienda</div>
                            <div class="wall-char-value">${tapparella.motoreAzienda || 'Somfy'}</div>
                        </div>
                        <div class="wall-char-item">
                            <div class="wall-char-label">âš™ï¸ Modello</div>
                            <div class="wall-char-value">${motoreDb?.nome || modelloId.replace(/_/g, ' ').toUpperCase()}</div>
                        </div>
                        ${motoreDb?.coppia ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">ğŸ’ª Coppia</div>
                                <div class="wall-char-value">${motoreDb.coppia} Nm</div>
                            </div>
                        ` : ''}
                        ${motoreDb?.velocita ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">ğŸ”„ VelocitÃ </div>
                                <div class="wall-char-value">${motoreDb.velocita} rpm</div>
                            </div>
                        ` : ''}
                        ${comandoDb ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">ğŸ® Comando</div>
                                <div class="wall-char-value">${comandoDb.nome}</div>
                            </div>
                        ` : ''}
                        ${accessori.supporto ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">ğŸ”§ Supporto</div>
                                <div class="wall-char-value" style="color: #059669;">âœ… Incluso</div>
                            </div>
                        ` : ''}
                        ${accessori.ruota_60 ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">âš™ï¸ Ruota 60mm</div>
                                <div class="wall-char-value" style="color: #059669;">âœ… Inclusa</div>
                            </div>
                        ` : ''}
                        ${accessori.corona_60 ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">ğŸ‘‘ Corona 60</div>
                                <div class="wall-char-value" style="color: #059669;">âœ… Inclusa</div>
                            </div>
                        ` : ''}
                        ${motoreInfo.note ? `
                            <div class="wall-char-item" style="grid-column: 1 / -1;">
                                <div class="wall-char-label">ğŸ“ Note</div>
                                <div class="wall-char-value">${motoreInfo.note}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Dettaglio Prezzi Kit -->
                    <div style="margin-top: 1.5rem; padding: 1.25rem; background: #fffbeb; border-radius: 12px; border: 1px solid #fcd34d;">
                        <div style="font-weight: 700; color: #92400e; margin-bottom: 1rem; font-size: 1.1rem;">
                            ğŸ’° Dettaglio Prezzo Kit
                        </div>
                        <div style="display: grid; gap: 0.5rem;">
                            ${prezzoKit.dettaglio.map(item => `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 6px;">
                                    <span style="color: #4b5563;">${item.nome}</span>
                                    <span style="font-weight: 600; color: #1f2937;">â‚¬ ${item.prezzo.toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 8px; color: white;">
                            <span style="font-weight: 700; font-size: 1.1rem;">TOTALE KIT (x${quantita})</span>
                            <span style="font-weight: 700; font-size: 1.3rem;">â‚¬ ${(prezzoKit.totale * quantita).toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ============================================================================
        // ğŸ” RENDER BLINDATA CONTENT - v7.98
        // ============================================================================
        function renderBlindataContent(bld, isActive) {
            if (!bld) return '';
            
            const configGlobale = projectData?.configBlindate || {};
            
            // Calcola prezzo stimato
            let prezzoStimato = 0;
            if (typeof calcolaPrezzoBlindataOikos === 'function') {
                const calcolo = calcolaPrezzoBlindataOikos(bld);
                prezzoStimato = calcolo.totale || 0;
            }
            
            return `
                <div class="product-content ${isActive ? 'active' : ''}" data-product="blindata">
                    
                    <!-- Config Globale Blindate -->
                    ${Object.keys(configGlobale).length > 0 ? `
                        <div class="config-globale-box" style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                            <div style="font-weight: 600; color: #991b1b; margin-bottom: 8px; cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                                âš™ï¸ Config Globale Blindate â–¼
                            </div>
                            <div style="display: none; font-size: 0.85rem;">
                                ${configGlobale.versione ? `<div>Versione: <b>${configGlobale.versione}</b></div>` : ''}
                                ${configGlobale.tipoAnta ? `<div>Tipo Anta: <b>${configGlobale.tipoAnta}</b></div>` : ''}
                                ${configGlobale.cilindro ? `<div>Cilindro: <b>${configGlobale.cilindro}</b></div>` : ''}
                                ${configGlobale.coloreTelaio ? `<div>Colore Telaio: <b>${configGlobale.coloreTelaio}</b></div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Misure LNP -->
                    <div class="brm-box" style="background: #fef2f2; border-color: #fecaca;">
                        <div class="brm-title" style="color: #991b1b;">ğŸ“ Luce Netta Passaggio (LNP)</div>
                        <div class="brm-grid">
                            ${bld.LNP_L ? `
                                <div class="brm-item">
                                    <div class="brm-label">Larghezza</div>
                                    <div class="brm-value">${bld.LNP_L} mm</div>
                                </div>
                            ` : ''}
                            ${bld.LNP_H ? `
                                <div class="brm-item">
                                    <div class="brm-label">Altezza</div>
                                    <div class="brm-value">${bld.LNP_H} mm</div>
                                </div>
                            ` : ''}
                            ${bld.luceCalcolata ? `
                                <div class="brm-item">
                                    <div class="brm-label">Luce</div>
                                    <div class="brm-value" style="color: #dc2626; font-weight: bold;">${bld.luceCalcolata.toUpperCase()}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Configurazione -->
                    <div class="wall-chars-grid" style="margin-top: 1.5rem;">
                        ${bld.azienda ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Azienda</div>
                                <div class="wall-char-value">${bld.azienda}</div>
                            </div>
                        ` : ''}
                        ${bld.versione ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Versione</div>
                                <div class="wall-char-value">${bld.versione}</div>
                            </div>
                        ` : ''}
                        ${bld.tipoAnta ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Tipo Anta</div>
                                <div class="wall-char-value">${bld.tipoAnta === 'doppia' ? '2 Ante' : '1 Anta'}</div>
                            </div>
                        ` : ''}
                        ${bld.sensoApertura ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Senso Apertura</div>
                                <div class="wall-char-value">${bld.sensoApertura}</div>
                            </div>
                        ` : ''}
                        ${bld.versoApertura ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Verso Apertura</div>
                                <div class="wall-char-value">${bld.versoApertura === 'tirare' ? 'â¬…ï¸ Tirare (interno)' : 'â¡ï¸ Spingere (esterno)'}</div>
                            </div>
                        ` : ''}
                        ${bld.controtelaio ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Controtelaio</div>
                                <div class="wall-char-value">${bld.controtelaio === 'si' ? 'âœ… SÃ¬' : 'âŒ No'}</div>
                            </div>
                        ` : ''}
                        ${bld.cilindro ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Cilindro</div>
                                <div class="wall-char-value">${bld.cilindro}</div>
                            </div>
                        ` : ''}
                        ${bld.coloreTelaio ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Colore Telaio</div>
                                <div class="wall-char-value">${bld.coloreTelaio}</div>
                            </div>
                        ` : ''}
                        ${bld.kitAAV ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Kit AAV</div>
                                <div class="wall-char-value">${bld.kitAAV}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Prezzo Stimato -->
                    ${prezzoStimato > 0 ? `
                        <div style="margin-top: 1.5rem; padding: 12px; background: #dcfce7; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85rem; color: #166534;">Prezzo Stimato</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #15803d;">â‚¬ ${prezzoStimato.toFixed(2)}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // ============================================================================
        // ğŸšª v7.98: RENDER PORTONCINO CONTENT - FIN-Door Finstral
        // ============================================================================
        function renderPortoncinoContent(ptc, isActive) {
            if (!ptc) return '';
            
            // Helper per descrizione tipo apertura
            const getTipoAperturaDesc = (tipo) => {
                const desc = {
                    '720': 'Porta singola',
                    '625': 'Porta singola (variante)',
                    '621': 'Porta + laterale sx',
                    '622': 'Porta + laterale dx',
                    '621C': 'Accoppiata + lat. sx',
                    '622C': 'Accoppiata + lat. dx',
                    '633': 'Porta + 2 laterali',
                    '633C': 'Accoppiata + 2 lat.',
                    '624': 'Porta + sopraluce',
                    '623': 'Porta + anta sup.',
                    '636': 'Doppia porta',
                    '626': 'Doppia + lat. sx',
                    '627': 'Doppia + lat. dx',
                    '649': 'Doppia + 2 laterali'
                };
                return desc[tipo] || tipo || '-';
            };
            
            // Costruisci Apertura: tirare/spingere + SX/DX
            const buildApertura = () => {
                const verso = ptc.versoApertura || ptc.direzioneApertura || '';
                const senso = ptc.sensoApertura || ptc.latoCerniere || '';
                if (!verso && !senso) return '-';
                let result = '';
                if (verso) result += verso === 'tirare' ? 'Tirare' : 'Spingere';
                if (senso) result += (result ? ' + ' : '') + (senso.toUpperCase() === 'SX' ? 'SX' : 'DX');
                return result || '-';
            };
            
            return `
                <div class="product-content ${isActive ? 'active' : ''}" data-product="portoncino">
                    
                    <!-- Tipo Apertura -->
                    <div class="brm-box" style="background: #f3e8ff; border-color: #c4b5fd;">
                        <div class="brm-title" style="color: #6b21a8;">ğŸ“ Tipo Apertura</div>
                        <div class="brm-grid">
                            <div class="brm-item">
                                <div class="brm-label">Configurazione</div>
                                <div class="brm-value" style="color: #7c3aed;">${ptc.tipoApertura || '720'} - ${getTipoAperturaDesc(ptc.tipoApertura)}</div>
                            </div>
                            <div class="brm-item">
                                <div class="brm-label">Apertura</div>
                                <div class="brm-value">${buildApertura()}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dimensioni BRM -->
                    ${ptc.BRM_L || ptc.BRM_H ? `
                        <div class="brm-box" style="background: #f0fdfa; border-color: #99f6e4; margin-top: 1rem;">
                            <div class="brm-title" style="color: #0f766e;">ğŸ“ Dimensioni BRM</div>
                            <div class="brm-grid">
                                ${ptc.BRM_L ? `
                                    <div class="brm-item">
                                        <div class="brm-label">Larghezza</div>
                                        <div class="brm-value">${ptc.BRM_L} mm</div>
                                    </div>
                                ` : ''}
                                ${ptc.BRM_H ? `
                                    <div class="brm-item">
                                        <div class="brm-label">Altezza</div>
                                        <div class="brm-value">${ptc.BRM_H} mm</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Finiture -->
                    <div class="brm-box" style="background: #fef3c7; border-color: #fcd34d; margin-top: 1rem;">
                        <div class="brm-title" style="color: #92400e;">ğŸ¨ Finiture</div>
                        <div class="brm-grid">
                            <div class="brm-item">
                                <div class="brm-label">Finitura INT</div>
                                <div class="brm-value">${ptc.finituraInt || ptc.materialeInt || '-'}${ptc.coloreInt ? ' - ' + ptc.coloreInt : ''}</div>
                            </div>
                            <div class="brm-item">
                                <div class="brm-label">Finitura EST</div>
                                <div class="brm-value">${ptc.finituraEst || ptc.materialeEst || '-'}${ptc.coloreEst ? ' - ' + ptc.coloreEst : ''}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configurazione Telaio e Anta -->
                    <div class="wall-chars-grid" style="margin-top: 1.5rem;">
                        ${ptc.codTelaio ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Cod. Telaio</div>
                                <div class="wall-char-value">${ptc.codTelaio}</div>
                            </div>
                        ` : ''}
                        ${ptc.codTagli ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Cod. Tagli</div>
                                <div class="wall-char-value">${ptc.codTagli}</div>
                            </div>
                        ` : ''}
                        ${ptc.modelloAnta ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Modello Anta</div>
                                <div class="wall-char-value" style="font-weight: bold; color: #7c3aed;">${ptc.modelloAnta}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Maniglie -->
                    <div class="wall-chars-grid" style="margin-top: 1rem;">
                        ${ptc.tipoManiglia ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Tipo Maniglia</div>
                                <div class="wall-char-value">${ptc.tipoManiglia === 'maniglione' ? 'Maniglione' : 'Set maniglia'}</div>
                            </div>
                        ` : ''}
                        ${ptc.codManiglia ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Cod. Maniglia</div>
                                <div class="wall-char-value">${ptc.codManiglia}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Colori (gruppi) -->
                    <div class="wall-chars-grid" style="margin-top: 1rem;">
                        ${ptc.gruppoColoreInt ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Gruppo Col. Int</div>
                                <div class="wall-char-value">${ptc.gruppoColoreInt}</div>
                            </div>
                        ` : ''}
                        ${ptc.gruppoColoreEst ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Gruppo Col. Est</div>
                                <div class="wall-char-value">${ptc.gruppoColoreEst}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Optional -->
                    <div class="brm-box" style="background: #fee2e2; border-color: #fca5a5; margin-top: 1rem;">
                        <div class="brm-title" style="color: #991b1b;">âš™ï¸ Optional</div>
                        <div class="brm-grid">
                            <div class="brm-item">
                                <div class="brm-label">Cilindro</div>
                                <div class="brm-value">${ptc.cilindro || '1P'}</div>
                            </div>
                            <div class="brm-item">
                                <div class="brm-label">Cerniere</div>
                                <div class="brm-value">${ptc.cerniere === 'scomparsa' ? 'A scomparsa' : 'Standard'}</div>
                            </div>
                            <div class="brm-item">
                                <div class="brm-label">Fonoassorbente</div>
                                <div class="brm-value">${ptc.fonoassorbente ? 'âœ… SÃ¬ (42dB)' : 'âŒ No'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ============================================================================
        // RENDER INFISSO CONTENT - CON OVERRIDE DETECTION
        // ============================================================================
        function renderInfissoContent(prodotto, brm, isActive) {
            const config = projectData?.configInfissi || {};
            
            // ğŸ†• v7.94: Genera HTML per Configurazione Globale INFISSO (dentro il tab)
            const configGlobaleInfissoHTML = renderConfigGlobaleInTab('infisso', config);
            
            // Costruisci valori combinati per confronto
            const configFinInt = config.finituraInt ? 
                `${config.finituraInt}${config.coloreInt ? ' + ' + config.coloreInt : ''}` : null;
            const prodFinInt = prodotto.finituraInt ? 
                `${prodotto.finituraInt}${prodotto.coloreInt ? ' + ' + prodotto.coloreInt : ''}` : null;
            
            const configFinEst = config.finituraEst ? 
                `${config.finituraEst}${config.coloreEst ? ' + ' + config.coloreEst : ''}` : null;
            const prodFinEst = prodotto.finituraEst ? 
                `${prodotto.finituraEst}${prodotto.coloreEst ? ' + ' + prodotto.coloreEst : ''}` : null;
            
            const configMan = config.maniglia ? 
                `${config.maniglia}${config.coloreManiglia ? ' + ' + config.coloreManiglia : ''}` : null;
            const prodMan = prodotto.maniglia ? 
                `${prodotto.maniglia}${prodotto.coloreManiglia ? ' + ' + prodotto.coloreManiglia : ''}` : null;
            
            const configTagli = config.tagliTelaio ? 
                `${config.tagliTelaio}${config.codTagli && config.codTagli.length > 0 ? ' [' + config.codTagli.join(', ') + ']' : ''}` : null;
            const prodTagli = prodotto.tagliTelaio ? 
                `${prodotto.tagliTelaio}${prodotto.codTagli && prodotto.codTagli.length > 0 ? ' [' + prodotto.codTagli.join(', ') + ']' : ''}` : null;
            
            // Confronta prodotto con config globale
            const overrides = [];
            
            if (prodotto.azienda && prodotto.azienda !== config.azienda) {
                overrides.push({ label: 'Azienda', old: config.azienda, new: prodotto.azienda });
            }
            if (prodotto.telaio && prodotto.telaio !== config.telaio) {
                overrides.push({ label: 'Telaio', old: config.telaio, new: prodotto.telaio });
            }
            if (prodFinInt && prodFinInt !== configFinInt) {
                overrides.push({ label: 'Finitura INT', old: configFinInt, new: prodFinInt });
            }
            if (prodFinEst && prodFinEst !== configFinEst) {
                overrides.push({ label: 'Finitura EST', old: configFinEst, new: prodFinEst });
            }
            if (prodotto.tipoAnta && prodotto.tipoAnta !== config.tipoAnta) {
                overrides.push({ label: 'Tipo Anta', old: config.tipoAnta, new: prodotto.tipoAnta });
            }
            if (prodotto.vetro && prodotto.vetro !== config.vetro) {
                overrides.push({ label: 'Vetro', old: config.vetro, new: prodotto.vetro });
            }
            if (prodMan && prodMan !== configMan) {
                overrides.push({ label: 'Maniglia', old: configMan, new: prodMan });
            }
            if (prodTagli && prodTagli !== configTagli) {
                overrides.push({ label: 'Tagli Telaio', old: configTagli, new: prodTagli });
            }
            if (prodotto.allarme && prodotto.allarme !== config.allarme) {
                overrides.push({ label: 'Allarme', old: config.allarme, new: prodotto.allarme });
            }
            // v7.78: Override cerniere e tipo apertura
            if (prodotto.cerniere && prodotto.cerniere !== config.cerniere) {
                overrides.push({ label: 'Cerniere', old: config.cerniere || 'N/D', new: prodotto.cerniere });
            }
            if (prodotto.ferramenta?.tipoApertura && 
                prodotto.ferramenta.tipoApertura !== config.ferramenta?.tipoApertura) {
                overrides.push({ 
                    label: 'Tipo Apertura', 
                    old: formatTipoApertura(config.ferramenta?.tipoApertura) || 'N/D', 
                    new: formatTipoApertura(prodotto.ferramenta.tipoApertura) 
                });
            }
            
            const hasOverrides = overrides.length > 0;
            
            return `
                <div class="product-content ${isActive ? 'active' : ''}" data-product="infisso">
                    
                    <!-- ğŸ†• v7.94: Configurazione Globale DENTRO il tab -->
                    ${configGlobaleInfissoHTML}
                    
                    <!-- BRM (grande e chiaro) -->
                    ${brm.L || brm.H ? `
                        <div class="brm-box">
                            <div class="brm-title">ğŸ“ Misure BRM INFISSO</div>
                            <div class="brm-grid">
                                ${brm.L ? `
                                    <div class="brm-item">
                                        <div class="brm-label">L (Larghezza)</div>
                                        <div class="brm-value">${brm.L} mm</div>
                                    </div>
                                ` : ''}
                                ${brm.H ? `
                                    <div class="brm-item">
                                        <div class="brm-label">H (Altezza)</div>
                                        <div class="brm-value">${brm.H} mm</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Info Essenziali (QtÃ  + Tipo) -->
                    <div style="display: flex; gap: 1.5rem; margin-top: 1.5rem; flex-wrap: wrap;">
                        ${(prodotto.quantita || prodotto.qta) ? `
                            <div style="background: #e0f2fe; padding: 1rem 1.5rem; border-radius: 8px; flex: 1; min-width: 150px;">
                                <div style="font-size: 0.85rem; font-weight: 600; color: #0369a1; margin-bottom: 0.25rem;">QUANTITÃ€</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #0c4a6e;">${prodotto.quantita || prodotto.qta}</div>
                            </div>
                        ` : ''}
                        ${(prodotto.tipo || prodotto.apertura) ? `
                            <div style="background: #dbeafe; padding: 1rem 1.5rem; border-radius: 8px; flex: 2; min-width: 200px;">
                                <div style="font-size: 0.85rem; font-weight: 600; color: #0369a1; margin-bottom: 0.25rem;">TIPO INFISSO</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #0c4a6e;">${prodotto.tipo || ''}${prodotto.tipo && prodotto.apertura ? ' + ' : ''}${prodotto.apertura || ''}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- ğŸ”© v8.09: APERTURA E FERRAMENTA con codici Finstral -->
                    ${(prodotto.codiceModello || prodotto.ferramenta1 || prodotto.cerniere || prodotto.ferramenta) ? `
                        <div style="margin-top: 1.5rem; padding: 1rem 1.5rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border-left: 4px solid #d97706;">
                            <div style="font-size: 0.9rem; font-weight: 700; color: #92400e; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                ğŸ”© APERTURA E FERRAMENTA
                            </div>
                            <div class="wall-chars-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                                ${prodotto.codiceModello ? `
                                    <div class="wall-char-item" style="background: white;">
                                        <div class="wall-char-label">ğŸ“ Codice Modello</div>
                                        <div class="wall-char-value" style="font-weight: 700; color: #0c4a6e;">
                                            ${prodotto.codiceModello}
                                        </div>
                                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 2px;">
                                            ${FINSTRAL_CODICI.getModello(prodotto.codiceModello).descrizione}
                                        </div>
                                    </div>
                                ` : ''}
                                ${prodotto.ferramenta1 ? `
                                    <div class="wall-char-item" style="background: white;">
                                        <div class="wall-char-label">ğŸ”§ Ferramenta</div>
                                        <div class="wall-char-value" style="font-weight: 700; color: #0c4a6e;">
                                            ${prodotto.ferramenta1}${prodotto.lato1 || ''}
                                        </div>
                                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 2px;">
                                            ${FINSTRAL_CODICI.getFerramenta(prodotto.ferramenta1).descrizione}
                                        </div>
                                    </div>
                                ` : ''}
                                ${(prodotto.cerniere || FINSTRAL_CODICI.getFerramenta(prodotto.ferramenta1)?.cerniere) ? `
                                    <div class="wall-char-item" style="background: white;">
                                        <div class="wall-char-label">ğŸ”— Cerniere</div>
                                        <div class="wall-char-value" style="font-weight: 600; color: ${(prodotto.cerniere || FINSTRAL_CODICI.getFerramenta(prodotto.ferramenta1)?.cerniere) === 'a-scomparsa' ? '#059669' : '#1f2937'};">
                                            ${(prodotto.cerniere || FINSTRAL_CODICI.getFerramenta(prodotto.ferramenta1)?.cerniere) === 'a-scomparsa' ? 'ğŸ”’ A scomparsa' : 'ğŸ‘ï¸ A vista'}
                                        </div>
                                    </div>
                                ` : ''}
                                ${prodotto.esecuzione1 ? `
                                    <div class="wall-char-item" style="background: white;">
                                        <div class="wall-char-label">ğŸ›¡ï¸ Sicurezza</div>
                                        <div class="wall-char-value">${FINSTRAL_CODICI.getEsecuzione(prodotto.esecuzione1)}</div>
                                    </div>
                                ` : ''}
                                ${prodotto.ferramenta?.tipoApertura ? `
                                    <div class="wall-char-item" style="background: white;">
                                        <div class="wall-char-label">ğŸšª Tipo Apertura</div>
                                        <div class="wall-char-value">${formatTipoApertura(prodotto.ferramenta.tipoApertura)}</div>
                                    </div>
                                ` : ''}
                                ${prodotto.ferramenta?.supplemento > 0 ? `
                                    <div class="wall-char-item" style="background: white;">
                                        <div class="wall-char-label">ğŸ’° Supplemento</div>
                                        <div class="wall-char-value" style="color: #dc2626; font-weight: 700;">â‚¬ ${prodotto.ferramenta.supplemento.toFixed(2)}</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Badge o Override -->
                    ${!hasOverrides ? `
                        <div style="margin-top: 1.5rem; padding: 1rem 1.5rem; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-radius: 8px; border-left: 4px solid #10b981;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="font-size: 1.5rem;">âœ…</span>
                                <div>
                                    <div style="font-weight: 700; color: #065f46; font-size: 1.1rem;">Usa configurazione globale</div>
                                    <div style="color: #047857; font-size: 0.9rem;">Tutte le caratteristiche ereditate dalla config globale</div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div style="margin-top: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                                <span style="font-size: 1.5rem;">âš ï¸</span>
                                <div style="font-weight: 700; color: #92400e; font-size: 1.1rem;">MODIFICHE LOCALI</div>
                            </div>
                            <div style="display: grid; gap: 0.75rem;">
                                ${overrides.map(o => `
                                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <span style="font-size: 1.25rem;">ğŸ”„</span>
                                        <div style="flex: 1;">
                                            <span style="font-weight: 600; color: #1f2937;">${o.label}:</span>
                                            <span style="color: #6b7280; text-decoration: line-through; margin: 0 0.5rem;">${o.old || 'N/D'}</span>
                                            <span style="color: #6b7280;">â†’</span>
                                            <span style="color: #059669; font-weight: 600; margin-left: 0.5rem;">${o.new}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        function setupProductTabs() {
            // GiÃ  gestito con onclick inline
        }

        function switchProductTab(tipo, event) {
            // âœ… v7.75 FIX: Opera solo nel contenitore della posizione corrente
            if (!event || !event.target) return;
            
            // Trova il contenitore .position-section che contiene questo tab
            const container = event.target.closest('.position-section');
            if (!container) {
                console.warn('âš ï¸ switchProductTab: contenitore non trovato');
                return;
            }
            
            // Rimuovi active solo dai tab e contenuti DENTRO questo contenitore
            container.querySelectorAll('.product-tab').forEach(tab => tab.classList.remove('active'));
            container.querySelectorAll('.product-content').forEach(content => content.classList.remove('active'));
            
            // Attiva tab cliccato
            event.target.classList.add('active');
            
            // Attiva contenuto corrispondente DENTRO questo contenitore
            const targetContent = container.querySelector(`.product-content[data-product="${tipo}"]`);
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            console.log(`ğŸ“¦ Tab prodotto: ${tipo} (contenitore isolato)`);
        }

        // ============================================================================
        // SEZIONE E: SITUAZIONE PREESISTENTE - TUTTI I PRODOTTI
        // ============================================================================
        function renderPositionPreexisting(pos) {
            const rilievi = {
                infissi: pos.rilievo_preesistente || {},
                persiane: pos.rilievo_persiane || {},
                tapparelle: pos.rilievo_tapparelle || {},
                zanzariere: pos.rilievo_zanzariere || {},
                cassonetti: pos.rilievo_cassonetti || {}
            };
            
            // Verifica se c'Ã¨ almeno un rilievo compilato
            const hasData = Object.values(rilievi).some(r => 
                r.materiale || r.togliere || r.smaltimento || r.tipologia || r.stato
            );
            
            if (!hasData) return '';
            
            let html = `<div class="position-section">
                <h3 class="position-section-title">
                    <span class="position-section-icon">ğŸ”„</span>
                    Situazione Preesistente
                </h3>`;
            
            // INFISSI
            if (rilievi.infissi.materiale || rilievi.infissi.togliere || rilievi.infissi.smaltimento) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-weight: 600; color: #4b5563; margin-bottom: 8px;">ğŸªŸ Infissi</h4>
                        <div class="wall-chars-grid">
                            ${rilievi.infissi.materiale ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Materiale</div>
                                    <div class="wall-char-value">${rilievi.infissi.materiale}</div>
                                </div>
                            ` : ''}
                            ${rilievi.infissi.togliere ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Da Togliere</div>
                                    <div class="wall-char-value">âœ… SÃ¬</div>
                                </div>
                            ` : ''}
                            ${rilievi.infissi.smaltimento ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Smaltimento</div>
                                    <div class="wall-char-value">âœ… Necessario</div>
                                </div>
                            ` : ''}
                            ${rilievi.infissi.coprifiliInt ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Coprifili Int</div>
                                    <div class="wall-char-value">âœ… Presente</div>
                                </div>
                            ` : ''}
                            ${rilievi.infissi.coprifiliEst ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Coprifili Est</div>
                                    <div class="wall-char-value">âœ… Presente</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // PERSIANE
            if (rilievi.persiane.materiale || rilievi.persiane.togliere || rilievi.persiane.smaltimento) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-weight: 600; color: #4b5563; margin-bottom: 8px;">ğŸšª Persiane</h4>
                        <div class="wall-chars-grid">
                            ${rilievi.persiane.materiale ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Materiale</div>
                                    <div class="wall-char-value">${rilievi.persiane.materiale}</div>
                                </div>
                            ` : ''}
                            ${rilievi.persiane.togliere ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Da Togliere</div>
                                    <div class="wall-char-value">âœ… SÃ¬</div>
                                </div>
                            ` : ''}
                            ${rilievi.persiane.smaltimento ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Smaltimento</div>
                                    <div class="wall-char-value">âœ… Necessario</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // TAPPARELLE
            if (rilievi.tapparelle.materiale || rilievi.tapparelle.togliere || rilievi.tapparelle.smaltimento) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-weight: 600; color: #4b5563; margin-bottom: 8px;">ğŸ“¦ Tapparelle</h4>
                        <div class="wall-chars-grid">
                            ${rilievi.tapparelle.materiale ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Materiale</div>
                                    <div class="wall-char-value">${rilievi.tapparelle.materiale}</div>
                                </div>
                            ` : ''}
                            ${rilievi.tapparelle.togliere ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Da Togliere</div>
                                    <div class="wall-char-value">âœ… SÃ¬</div>
                                </div>
                            ` : ''}
                            ${rilievi.tapparelle.smaltimento ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Smaltimento</div>
                                    <div class="wall-char-value">âœ… Necessario</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // ZANZARIERE
            if (rilievi.zanzariere.materiale || rilievi.zanzariere.togliere || rilievi.zanzariere.smaltimento) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-weight: 600; color: #4b5563; margin-bottom: 8px;">ğŸª° Zanzariere</h4>
                        <div class="wall-chars-grid">
                            ${rilievi.zanzariere.materiale ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Materiale</div>
                                    <div class="wall-char-value">${rilievi.zanzariere.materiale}</div>
                                </div>
                            ` : ''}
                            ${rilievi.zanzariere.togliere ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Da Togliere</div>
                                    <div class="wall-char-value">âœ… SÃ¬</div>
                                </div>
                            ` : ''}
                            ${rilievi.zanzariere.smaltimento ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Smaltimento</div>
                                    <div class="wall-char-value">âœ… Necessario</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // CASSONETTI
            if (rilievi.cassonetti.materiale || rilievi.cassonetti.togliere || rilievi.cassonetti.smaltimento) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-weight: 600; color: #4b5563; margin-bottom: 8px;">ğŸ“¦ Cassonetti</h4>
                        <div class="wall-chars-grid">
                            ${rilievi.cassonetti.materiale ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Materiale</div>
                                    <div class="wall-char-value">${rilievi.cassonetti.materiale}</div>
                                </div>
                            ` : ''}
                            ${rilievi.cassonetti.togliere ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Da Togliere</div>
                                    <div class="wall-char-value">âœ… SÃ¬</div>
                                </div>
                            ` : ''}
                            ${rilievi.cassonetti.smaltimento ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Smaltimento</div>
                                    <div class="wall-char-value">âœ… Necessario</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            html += `</div>`;
            return html;
        }

        // ============================================================================
        // SEZIONE F: NOTE TECNICHE
        // ============================================================================
        function renderPositionNotes(pos) {
            const hasNotes = pos.note || pos.note_tecniche || pos.note_montaggio;
            
            if (!hasNotes) return '';
            
            return `
                <div class="position-section">
                    <h3 class="position-section-title">
                        <span class="position-section-icon">ğŸ“</span>
                        Note Tecniche e CriticitÃ 
                    </h3>
                    
                    <div class="notes-tags">
                        ${pos.urgente ? '<span class="note-tag urgente">âš ï¸ URGENTE</span>' : ''}
                        ${pos.da_verificare ? '<span class="note-tag verificare">ğŸ” Da Verificare</span>' : ''}
                        ${pos.richiesta_cliente ? '<span class="note-tag richiesta">ğŸ’¬ Richiesta Cliente</span>' : ''}
                        ${pos.problema_accesso ? '<span class="note-tag problema">ğŸš§ Problema Accesso</span>' : ''}
                    </div>
                    
                    <div class="notes-content">
                        ${pos.note || pos.note_tecniche || pos.note_montaggio || 'Nessuna nota'}
                    </div>
                </div>
            `;
        }

        // ============================================================================
        // NAVIGAZIONE POSIZIONI
        // ============================================================================
        function renderPositionNavigation(index) {
            const hasPrev = index > 0;
            const hasNext = index < filteredPositions.length - 1;
            
            return `
                <div class="position-navigation">
                    <button class="nav-btn-position" 
                            onclick="navigatePosition(-1)" 
                            ${!hasPrev ? 'disabled' : ''}>
                        â† Posizione Precedente
                    </button>
                    <button class="nav-btn-position" 
                            onclick="navigatePosition(1)" 
                            ${!hasNext ? 'disabled' : ''}>
                        Posizione Successiva â†’
                    </button>
                </div>
            `;
        }

        function navigatePosition(direction) {
            const newIndex = currentPositionIndex + direction;
            if (newIndex >= 0 && newIndex < filteredPositions.length) {
                selectPosition(newIndex);
            }
        }

        // Keyboard shortcuts per navigazione posizioni
        document.addEventListener('keydown', (e) => {
            // Solo se Vista Posizioni Ã¨ attiva
            const vistaActive = document.getElementById('vista-posizioni-ufficio').classList.contains('active');
            if (!vistaActive) return;
            
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                navigatePosition(-1);
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                navigatePosition(1);
            }
        });

        // ============================================================================
        // MODIFICHE FUNZIONE LOAD DATA PER ATTIVARE VISTA POSIZIONI
        // ============================================================================
        // Modifichiamo la funzione handleDataLoad esistente per popolare anche Vista Posizioni

        // ============================================================================
        // BLOCCO POSA - STATO E NAVIGAZIONE
        // ============================================================================
        let posaState = {
            currentView: 'generale', // 'generale' o 'posizioni'
            currentPositionIndex: 0,
            totalPositions: 0,
            positions: []
        };

        /**
         * Apri Posa App separata in nuova finestra
         * v7.29
         */
        function apriPosaApp() {
            // Verifica che ci sia un progetto caricato
            if (!appState.rilievoData) {
                alert('âš ï¸ Carica prima un progetto per aprire la Posa App!');
                return;
            }
            
            // Ottieni ID progetto
            const projectId = appState.rilievoData.id || appState.rilievoData.codiceCommessa || 'progetto';
            
            // Salva ID in localStorage per la Posa App
            localStorage.setItem('posa_app_project_id', projectId);
            
            console.log('ğŸ”— Apertura Posa App per progetto:', projectId);
            
            // Apri Posa App in nuova finestra
            const posaWindow = window.open(
                'posa-app-v1_6.html',
                'PosaApp',
                'width=1400,height=900,menubar=no,toolbar=no,location=no,status=yes,scrollbars=yes,resizable=yes'
            );
            
            if (!posaWindow) {
                alert('âš ï¸ Popup bloccato!\n\nAbilita i popup per questo sito nelle impostazioni del browser.');
            } else {
                console.log('âœ… Posa App aperta in nuova finestra');
            }
        }

        // Switch tra viste Posa
        function switchVistaPosa(vista, event) {
            console.log(`Switching Posa vista to: ${vista}`);
            posaState.currentView = vista;
            
            // v7.20: Gestisci stati bottoni submenu
            if (event) {
                document.querySelectorAll('.submenu-btn-posa').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
            }
            
            // Nascondi tutte le viste posa
            document.querySelectorAll('.posa-view').forEach(v => v.style.display = 'none');
            
            // Mostra vista selezionata
            if (vista === 'generale') {
                document.getElementById('posa-generale').style.display = 'block';
                if (appState.rilievoData) {
                    renderVistaGeneraleCantiere(appState.rilievoData);
                }
            } else if (vista === 'posizioni') {
                document.getElementById('posa-posizioni').style.display = 'block';
                if (appState.rilievoData) {
                    renderVistaPosizioneCantiere(appState.rilievoData);
                }
            } else if (vista === 'dettaglio') {
                // v7.20: Vista dettaglio posa
                document.getElementById('posa-dettaglio').style.display = 'block';
                if (appState.rilievoData) {
                    document.getElementById('posaDettaglioPlaceholder').style.display = 'none';
                    document.getElementById('posaDettaglioContent').style.display = 'block';
                    renderDettaglioPosa();
                } else {
                    document.getElementById('posaDettaglioPlaceholder').style.display = 'block';
                    document.getElementById('posaDettaglioContent').style.display = 'none';
                }
            }
        }

        // ============================================================================
        // VISTA 3.1 - GENERALE CANTIERE
        // ============================================================================
        function renderVistaGeneraleCantiere(data) {
            console.log('ğŸ—ï¸ Rendering Vista Generale Cantiere...');
            
            const placeholder = document.getElementById('posaCantierePlaceholder');
            const content = document.getElementById('posaCantiereContent');
            
            if (!data || !data.posizioni) {
                placeholder.style.display = 'block';
                content.style.display = 'none';
                return;
            }
            
            placeholder.style.display = 'none';
            content.style.display = 'block';
            
            let html = '';
            
            // SEZIONE A - MATERIALI DA PORTARE
            html += renderMaterialiDaPortare(data.posizioni);
            
            // SEZIONE B - STRUMENTI NECESSARI
            html += renderStrumentiNecessari(data.posizioni);
            
            // SEZIONE C - ORDINE MONTAGGIO
            html += renderOrdineMontaggio(data.posizioni);
            
            // SEZIONE D - CHECKLIST PREPARAZIONE
            html += renderChecklistPreparazione();
            
            // SEZIONE E - INFO LOGISTICHE
            html += renderInfoLogistiche(data);
            
            content.innerHTML = html;
            
            // Setup event listeners per checklist
            setupChecklistListeners();
        }

        function renderMaterialiDaPortare(posizioni) {
            // Raggruppa materiali per tipo
            const materiali = {
                infissi: [],
                persiane: [],
                tapparelle: [],
                zanzariere: [],
                cassonetti: [],
                accessori: []
            };
            
            posizioni.forEach(pos => {
                if (pos.infisso && pos.infisso.quantita > 0) {
                    materiali.infissi.push({
                        tipo: pos.infisso.tipo || 'N/D',
                        azienda: pos.infisso.azienda || 'N/D',
                        quantita: pos.infisso.quantita,
                        brm: pos.infisso.brm || {},
                        posizione: pos.ambiente || pos.nome || pos.stanza || pos.id
                    });
                }
                
                if (pos.persiana && pos.persiana.quantita > 0) {
                    materiali.persiane.push({
                        tipo: pos.persiana.tipo || 'Persiana',
                        azienda: pos.persiana.azienda || 'N/D',
                        quantita: pos.persiana.quantita,
                        brm: pos.persiana.brm || {},
                        posizione: pos.ambiente || pos.nome || pos.stanza || pos.id
                    });
                }
                
                if (pos.tapparella && pos.tapparella.quantita > 0) {
                    materiali.tapparelle.push({
                        tipo: pos.tapparella.tipo || 'Tapparella',
                        motorizzata: pos.tapparella.motorizzazione !== 'manuale',
                        azienda: pos.tapparella.azienda || 'N/D',
                        quantita: pos.tapparella.quantita,
                        brm: pos.tapparella.brm || {},
                        posizione: pos.ambiente || pos.nome || pos.stanza || pos.id
                    });
                }
                
                if (pos.zanzariera && pos.zanzariera.quantita > 0) {
                    materiali.zanzariere.push({
                        tipo: pos.zanzariera.tipo || 'Zanzariera',
                        quantita: pos.zanzariera.quantita,
                        brm: pos.zanzariera.brm || {},
                        posizione: pos.ambiente || pos.nome || pos.stanza || pos.id
                    });
                }
                
                if (pos.cassonetto && pos.cassonetto.quantita > 0) {
                    materiali.cassonetti.push({
                        tipo: pos.cassonetto.tipo || 'Cassonetto',
                        quantita: pos.cassonetto.quantita,
                        brm: pos.cassonetto.brm || {},
                        posizione: pos.ambiente || pos.nome || pos.stanza || pos.id
                    });
                }
            });
            
            let html = `
                <div class="cantiere-section">
                    <h2 class="cantiere-section-title">ğŸ“¦ Materiali da Portare</h2>
                    <div class="materials-grid">
            `;
            
            // INFISSI
            if (materiali.infissi.length > 0) {
                html += `
                    <div class="material-category">
                        <div class="material-category-title">ğŸªŸ INFISSI</div>
                `;
                materiali.infissi.forEach(item => {
                    html += `
                        <div class="material-item">
                            <strong>${item.azienda} - ${item.tipo} (x${item.quantita})</strong>
                            ${item.brm.L ? `L: ${item.brm.L}mm Ã— H: ${item.brm.H}mm` : ''}
                            <br><small>Posizione: ${item.posizione}</small>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // PERSIANE
            if (materiali.persiane.length > 0) {
                html += `
                    <div class="material-category">
                        <div class="material-category-title">ğŸªŸ PERSIANE</div>
                `;
                materiali.persiane.forEach(item => {
                    html += `
                        <div class="material-item">
                            <strong>${item.azienda} - ${item.tipo} (x${item.quantita})</strong>
                            ${item.brm.L ? `L: ${item.brm.L}mm Ã— H: ${item.brm.H}mm` : ''}
                            <br><small>Posizione: ${item.posizione}</small>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // TAPPARELLE
            if (materiali.tapparelle.length > 0) {
                html += `
                    <div class="material-category">
                        <div class="material-category-title">ğŸªŸ TAPPARELLE</div>
                `;
                materiali.tapparelle.forEach(item => {
                    html += `
                        <div class="material-item">
                            <strong>${item.azienda} - ${item.tipo} (x${item.quantita})</strong>
                            ${item.motorizzata ? 'âš¡ Motorizzata' : 'Manuale'}
                            ${item.brm.L ? `<br>L: ${item.brm.L}mm Ã— H: ${item.brm.H}mm` : ''}
                            <br><small>Posizione: ${item.posizione}</small>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // ZANZARIERE
            if (materiali.zanzariere.length > 0) {
                html += `
                    <div class="material-category">
                        <div class="material-category-title">ğŸ¦Ÿ ZANZARIERE</div>
                `;
                materiali.zanzariere.forEach(item => {
                    html += `
                        <div class="material-item">
                            <strong>${item.tipo} (x${item.quantita})</strong>
                            ${item.brm.L ? `L: ${item.brm.L}mm Ã— H: ${item.brm.H}mm` : ''}
                            <br><small>Posizione: ${item.posizione}</small>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // CASSONETTI
            if (materiali.cassonetti.length > 0) {
                html += `
                    <div class="material-category">
                        <div class="material-category-title">ğŸ“¦ CASSONETTI</div>
                `;
                materiali.cassonetti.forEach(item => {
                    html += `
                        <div class="material-item">
                            <strong>${item.tipo} (x${item.quantita})</strong>
                            ${item.brm.L ? `L: ${item.brm.L}mm Ã— H: ${item.brm.H}mm` : ''}
                            <br><small>Posizione: ${item.posizione}</small>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // ACCESSORI
            html += `
                <div class="material-category">
                    <div class="material-category-title">ğŸ”§ ACCESSORI</div>
                    <div class="material-item"><strong>Viti e tasselli</strong></div>
                    <div class="material-item"><strong>Silicone</strong></div>
                    <div class="material-item"><strong>Guarnizioni</strong></div>
                    <div class="material-item"><strong>Coprifili</strong></div>
                </div>
            `;
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderStrumentiNecessari(posizioni) {
            const strumenti = [
                'Trapano elettrico',
                'Livella laser',
                'Metro a nastro (5m)',
                'Seghetto alternativo',
                'Cacciaviti (set completo)',
                'Chiavi inglesi',
                'Martello',
                'Pistola silicone',
                'Aspiratore/Soffiatore',
                'Scala telescopica',
                'Protezioni (occhiali, guanti)',
                'Materiale imballaggio vecchi infissi'
            ];
            
            let html = `
                <div class="cantiere-section">
                    <h2 class="cantiere-section-title">ğŸ› ï¸ Strumenti Necessari</h2>
                    <div class="tools-checklist">
            `;
            
            strumenti.forEach((strumento, index) => {
                html += `
                    <div class="tool-item">
                        <input type="checkbox" class="tool-checkbox" id="tool-${index}" 
                               onchange="saveToolCheck(${index}, this.checked)">
                        <label for="tool-${index}">${strumento}</label>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderOrdineMontaggio(posizioni) {
            // Raggruppa per piano
            const perPiano = {};
            posizioni.forEach(pos => {
                const piano = pos.piano || 'Non specificato';
                if (!perPiano[piano]) {
                    perPiano[piano] = [];
                }
                perPiano[piano].push(pos);
            });
            
            let html = `
                <div class="cantiere-section">
                    <h2 class="cantiere-section-title">ğŸ“‹ Ordine Montaggio Suggerito</h2>
                    <div class="mounting-order">
            `;
            
            let stepNum = 1;
            Object.keys(perPiano).sort().forEach(piano => {
                html += `
                    <div class="order-step">
                        <span class="order-step-number">${stepNum}</span>
                        <strong>${piano}</strong>
                        <div style="margin-left: 3rem; margin-top: 0.5rem;">
                `;
                
                // Raggruppa per stanza in questo piano
                const perStanza = {};
                perPiano[piano].forEach(pos => {
                    const stanza = pos.stanza || 'Non specificata';
                    if (!perStanza[stanza]) {
                        perStanza[stanza] = [];
                    }
                    perStanza[stanza].push(pos);
                });
                
                Object.keys(perStanza).forEach((stanza, idx) => {
                    html += `${idx > 0 ? ' â†’ ' : ''}${stanza} (${perStanza[stanza].length} pos.)`;
                });
                
                html += `
                        </div>
                    </div>
                `;
                stepNum++;
            });
            
            html += `
                    </div>
                    <div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-radius: 8px;">
                        ğŸ’¡ <strong>Suggerimento:</strong> Procedere dal basso verso l'alto per ottimizzare i tempi e ridurre i trasporti di materiale.
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderChecklistPreparazione() {
            const checklist = {
                'Pre-cantiere': [
                    'Materiali caricati su furgone',
                    'Strumenti verificati e funzionanti',
                    'Squadra informata e briefing fatto',
                    'Cliente avvisato orario arrivo',
                    'Accessi e parcheggio verificati'
                ],
                'Durante lavori': [
                    'Protezioni pavimenti/mobili posizionate',
                    'Aspiratore/soffiatore pronto',
                    'Area lavoro delimitata',
                    'Contenitori per smaltimento predisposti'
                ],
                'Fine lavori': [
                    'Pulizia completa area lavoro',
                    'Smaltimento rifiuti organizzato',
                    'Verifica con cliente',
                    'Documenti firmati'
                ]
            };
            
            let html = `
                <div class="cantiere-section">
                    <h2 class="cantiere-section-title">âœ… Checklist Preparazione</h2>
                    <div class="preparation-checklist">
            `;
            
            Object.keys(checklist).forEach(gruppo => {
                html += `
                    <div class="checklist-group">
                        <div class="checklist-group-title">${gruppo}</div>
                `;
                
                checklist[gruppo].forEach((item, index) => {
                    const itemId = `prep-${gruppo.replace(/\s+/g, '-')}-${index}`;
                    html += `
                        <div class="checklist-item" id="item-${itemId}">
                            <input type="checkbox" id="${itemId}" 
                                   onchange="toggleChecklistItem('${itemId}', this.checked)">
                            <label for="${itemId}">${item}</label>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderInfoLogistiche(data) {
            const cliente = data.cliente || {};
            
            let html = `
                <div class="cantiere-section">
                    <h2 class="cantiere-section-title">ğŸ“ Informazioni Logistiche</h2>
                    <div class="logistics-info">
                        <div class="logistics-item">
                            <span class="logistics-label">ğŸ  Indirizzo cantiere:</span>
                            <span class="logistics-value">${cliente.indirizzo || 'Non specificato'}</span>
                        </div>
                        <div class="logistics-item">
                            <span class="logistics-label">ğŸ“… Piano:</span>
                            <span class="logistics-value">${cliente.piano || 'Non specificato'}</span>
                        </div>
                        <div class="logistics-item">
                            <span class="logistics-label">ğŸ‘¤ Referente:</span>
                            <span class="logistics-value">${cliente.nome || 'Non specificato'}</span>
                        </div>
                        <div class="logistics-item">
                            <span class="logistics-label">ğŸ“ Telefono:</span>
                            <span class="logistics-value">${cliente.telefono || 'Non specificato'}</span>
                        </div>
                        <div class="logistics-item">
                            <span class="logistics-label">â° Orari accesso:</span>
                            <span class="logistics-value">Da concordare</span>
                        </div>
                        <div class="logistics-item">
                            <span class="logistics-label">ğŸ…¿ï¸ Parcheggio:</span>
                            <span class="logistics-value">Da verificare</span>
                        </div>
                        ${data.note_progetto ? `
                        <div class="logistics-item" style="border-top: 2px solid #f59e0b; margin-top: 1rem; padding-top: 1rem;">
                            <span class="logistics-label">ğŸ“ Note progetto:</span>
                            <span class="logistics-value">${data.note_progetto}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            return html;
        }

        // ============================================================================
        // VISTA 3.2 - POSIZIONI CANTIERE
        // ============================================================================
        function renderVistaPosizioneCantiere(data) {
            console.log('ğŸ”¨ Rendering Vista Posizioni Cantiere...');
            
            if (!data || !data.posizioni || data.posizioni.length === 0) {
                return;
            }
            
            posaState.positions = data.posizioni;
            posaState.totalPositions = data.posizioni.length;
            posaState.currentPositionIndex = 0;
            
            renderSchedaMontaggio();
        }

        function renderSchedaMontaggio() {
            const pos = posaState.positions[posaState.currentPositionIndex];
            if (!pos) return;
            
            const content = document.getElementById('posaPositionContent');
            if (!content) return;
            
            // Update header info
            document.getElementById('posaCurrentPositionId').textContent = pos.id || 'N/D';
            document.getElementById('posaCurrentLocation').textContent = 
                `${pos.piano || 'N/D'} | ${pos.stanza || 'N/D'} | ${pos.ambiente || 'N/D'}`;
            
            // Update navigation buttons
            document.getElementById('posaPrevBtn').disabled = (posaState.currentPositionIndex === 0);
            document.getElementById('posaNextBtn').disabled = (posaState.currentPositionIndex === posaState.totalPositions - 1);
            
            let html = '';
            
            // MISURE BRM GRANDI
            html += renderMisureBRMGrandi(pos);
            
            // CARATTERISTICHE MURO
            html += renderCaratteristicheMuro(pos);
            
            // ISTRUZIONI MONTAGGIO
            html += renderIstruzioniMontaggio(pos);
            
            // MATERIALI SPECIFICI
            html += renderMaterialiPosizione(pos);
            
            // NOTE E ALERT
            html += renderNoteAlert(pos);
            
            // CHECKLIST OPERAZIONI
            html += renderChecklistOperazioni(pos);
            
            content.innerHTML = html;
            
            // Restore checklist state
            restoreChecklistState(pos.id);
        }

        function renderMisureBRMGrandi(pos) {
            let html = '<div class="brm-section">';
            html += '<h2 class="cantiere-section-title">ğŸ“ Misure BRM</h2>';
            
            // INFISSO
            if (pos.infisso && pos.infisso.quantita > 0) {
                // ğŸ”§ COMPATIBILITÃ€: Legge sia brm.L che BRM_L
                const L = pos.infisso.brm?.L || pos.infisso.BRM_L || 0;
                const H = pos.infisso.brm?.H || pos.infisso.BRM_H || 0;
                const C = pos.infisso.brm?.C || pos.infisso.BRM_C || 0;
                const B = pos.infisso.brm?.B || pos.infisso.BRM_B || 0;
                
                if (L || H) {  // Mostra solo se ha misure
                    html += `
                        <div class="brm-box-large">
                            <div class="brm-product-title">ğŸªŸ INFISSO ${pos.infisso.tipo || ''}</div>
                            <div class="brm-measurements">
                                ${L ? `
                                    <div class="brm-measure">
                                        <div class="brm-label">Larghezza (L)</div>
                                        <div class="brm-value">${L}<span class="brm-unit">mm</span></div>
                                    </div>
                                ` : ''}
                                ${H ? `
                                    <div class="brm-measure">
                                        <div class="brm-label">Altezza (H)</div>
                                        <div class="brm-value">${H}<span class="brm-unit">mm</span></div>
                                    </div>
                                ` : ''}
                                ${C ? `
                                    <div class="brm-measure">
                                        <div class="brm-label">Cassettone (C)</div>
                                        <div class="brm-value">${C}<span class="brm-unit">mm</span></div>
                                    </div>
                                ` : ''}
                                ${B ? `
                                    <div class="brm-measure">
                                        <div class="brm-label">Base (B)</div>
                                        <div class="brm-value">${B}<span class="brm-unit">mm</span></div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            }
            
            // TAPPARELLA
            if (pos.tapparella && pos.tapparella.quantita > 0 && pos.tapparella.brm) {
                const brm = pos.tapparella.brm;
                html += `
                    <div class="brm-box-large">
                        <div class="brm-product-title">ğŸªŸ TAPPARELLA</div>
                        <div class="brm-measurements">
                            <div class="brm-measure">
                                <div class="brm-label">Larghezza (L)</div>
                                <div class="brm-value">${brm.L || 0}<span class="brm-unit">mm</span></div>
                            </div>
                            <div class="brm-measure">
                                <div class="brm-label">Altezza (H)</div>
                                <div class="brm-value">${brm.H || 0}<span class="brm-unit">mm</span></div>
                            </div>
                            <div class="brm-measure">
                                <div class="brm-label">Cassettone (C)</div>
                                <div class="brm-value">${brm.C || 0}<span class="brm-unit">mm</span></div>
                            </div>
                            <div class="brm-measure">
                                <div class="brm-label">Base (B)</div>
                                <div class="brm-value">${brm.B || 0}<span class="brm-unit">mm</span></div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // CASSONETTO
            if (pos.cassonetto && pos.cassonetto.quantita > 0) {
                const cass = pos.cassonetto;
                const brm = cass.brm || {};
                const hasRilevate = cass.LS || cass.HCASS || cass.B || cass.C;
                
                html += `
                    <div class="brm-box-large">
                        <div class="brm-product-title">ğŸ“¦ CASSONETTO ${cass.materialeCass && cass.codiceCass ? `(${cass.materialeCass} ${cass.codiceCass})` : ''}</div>
                        
                        <!-- BRM per ordine -->
                        <div class="brm-measurements">
                            ${brm.L ? `
                                <div class="brm-measure">
                                    <div class="brm-label">L (Larghezza)</div>
                                    <div class="brm-value">${brm.L}<span class="brm-unit">mm</span></div>
                                </div>
                            ` : ''}
                            ${brm.H ? `
                                <div class="brm-measure">
                                    <div class="brm-label">H (Altezza)</div>
                                    <div class="brm-value">${brm.H}<span class="brm-unit">mm</span></div>
                                </div>
                            ` : ''}
                            ${brm.C ? `
                                <div class="brm-measure">
                                    <div class="brm-label">C (ProfonditÃ )</div>
                                    <div class="brm-value">${brm.C}<span class="brm-unit">mm</span></div>
                                </div>
                            ` : ''}
                            ${brm.B ? `
                                <div class="brm-measure">
                                    <div class="brm-label">B (Base)</div>
                                    <div class="brm-value">${brm.B}<span class="brm-unit">mm</span></div>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${hasRilevate ? `
                            <!-- Misure Rilevate -->
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #ccc;">
                                <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.5rem;">ğŸ“ Misure Rilevate:</div>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; font-size: 0.8rem;">
                                    ${cass.LS ? `<div><strong>LS:</strong> ${cass.LS}</div>` : ''}
                                    ${cass.SRSX ? `<div><strong>SRSX:</strong> ${cass.SRSX}</div>` : ''}
                                    ${cass.SRDX ? `<div><strong>SRDX:</strong> ${cass.SRDX}</div>` : ''}
                                    ${cass.HCASS ? `<div><strong>HCASS:</strong> ${cass.HCASS}</div>` : ''}
                                    ${cass.B ? `<div><strong>B:</strong> ${cass.B}</div>` : ''}
                                    ${cass.C ? `<div><strong>C:</strong> ${cass.C}</div>` : ''}
                                    ${cass.ZSX_tipo ? `<div><strong>ZSX:</strong> ${cass.ZSX_tipo}</div>` : ''}
                                    ${cass.ZDX_tipo ? `<div><strong>ZDX:</strong> ${cass.ZDX_tipo}</div>` : ''}
                                    ${cass.BSuperiore ? `<div><strong>B.Sup:</strong> ${cass.BSuperiore}</div>` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        function renderCaratteristicheMuro(pos) {
            const muro = pos.caratteristiche_muro_override || appState.rilievoData?.caratteristiche_muro_globali || {};
            
            let html = `
                <div class="muro-section">
                    <h2 class="cantiere-section-title">ğŸ§± Caratteristiche Muro</h2>
                    <div class="muro-grid">
                        <div class="muro-item">
                            <div class="muro-label">Telaio</div>
                            <div class="muro-value">${muro.telaio_larghezza || 0} Ã— ${muro.telaio_altezza || 0} mm</div>
                        </div>
                        <div class="muro-item">
                            <div class="muro-label">ProfonditÃ  Muro INT</div>
                            <div class="muro-value">${muro.prof_muro_int || 0} mm</div>
                        </div>
                        <div class="muro-item">
                            <div class="muro-label">ProfonditÃ  Muro EST</div>
                            <div class="muro-value">${muro.prof_muro_est || 0} mm</div>
                        </div>
                        <div class="muro-item">
                            <div class="muro-label">Falso Esistente</div>
                            <div class="muro-value">${muro.falso_esistente === 'si' ? `SÃ¬ (${muro.spessore_falso || 0}mm)` : 'No'}</div>
                        </div>
                        <div class="muro-item">
                            <div class="muro-label">Coprifilo</div>
                            <div class="muro-value">${muro.coprifilo_larghezza || 0} mm</div>
                        </div>
                        <div class="muro-item">
                            <div class="muro-label">Battuta Sup. Tapparella</div>
                            <div class="muro-value">${muro.battuta_superiore_tapparella || 0} mm</div>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderIstruzioniMontaggio(pos) {
            const steps = [
                {
                    title: 'PREPARAZIONE',
                    tasks: [
                        'Rimuovere vecchio infisso/telaio',
                        'Pulire vano da polvere e detriti',
                        `Verificare misure vano: LVT ${pos.misure?.LVT || 'N/D'} Ã— HVT ${pos.misure?.HVT || 'N/D'} mm`,
                        'Controllare planaritÃ  muro'
                    ]
                },
                {
                    title: 'MONTAGGIO TELAIO',
                    tasks: [
                        `Posizionare telaio (BRM: L=${pos.infisso?.brm?.L || 'N/D'} H=${pos.infisso?.brm?.H || 'N/D'})`,
                        'Centrare e mettere in bolla',
                        'Fissare con viti/tasselli (min. 4 punti)',
                        'Verificare apertura/chiusura'
                    ]
                },
                {
                    title: 'MONTAGGIO ANTA',
                    tasks: [
                        'Inserire anta nei cardini',
                        'Regolare cerniere',
                        'Verificare chiusura ermetica',
                        'Testare movimenti'
                    ]
                }
            ];
            
            // Add tapparella step if present
            if (pos.tapparella && pos.tapparella.quantita > 0) {
                steps.push({
                    title: 'MONTAGGIO TAPPARELLA',
                    tasks: [
                        `Installare guide (BRM: L=${pos.tapparella?.brm?.L || 'N/D'})`,
                        'Inserire telo tapparella',
                        pos.tapparella.motorizzazione !== 'manuale' ? 'Collegare motore e testare' : 'Installare cinghia',
                        'Verificare scorrimento fluido'
                    ]
                });
            }
            
            // Add cassonetto step if present
            if (pos.cassonetto && pos.cassonetto.quantita > 0) {
                steps.push({
                    title: 'MONTAGGIO CASSONETTO',
                    tasks: [
                        `Posizionare cassonetto (BRM: L=${pos.cassonetto?.brm?.L || 'N/D'})`,
                        'Fissare al muro',
                        'Chiudere sportelli',
                        'Verificare allineamento'
                    ]
                });
            }
            
            steps.push({
                title: 'RIFINITURA',
                tasks: [
                    'Applicare silicone perimetrale',
                    'Montare coprifili INT/EST',
                    'Pulizia finale area lavoro',
                    'Verifica con cliente'
                ]
            });
            
            let html = `
                <div class="instructions-section">
                    <h2 class="cantiere-section-title">ğŸ“‹ Istruzioni Montaggio</h2>
            `;
            
            steps.forEach((step, index) => {
                html += `
                    <div class="instruction-step">
                        <span class="step-number">${index + 1}</span>
                        <div class="step-title">${step.title}</div>
                        <ul class="step-tasks">
                `;
                
                step.tasks.forEach((task, taskIndex) => {
                    const taskId = `step-${index}-task-${taskIndex}`;
                    html += `
                        <li class="step-task">
                            <input type="checkbox" id="${taskId}">
                            <label for="${taskId}">${task}</label>
                        </li>
                    `;
                });
                
                html += `
                        </ul>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function renderMaterialiPosizione(pos) {
            let html = `
                <div class="materials-list">
                    <h2 class="cantiere-section-title">ğŸ“¦ Materiali Specifici Posizione</h2>
            `;
            
            if (pos.infisso && pos.infisso.quantita > 0) {
                html += `
                    <div class="material-list-item">
                        ğŸªŸ <strong>Infisso ${pos.infisso.tipo || 'N/D'}</strong> - ${pos.infisso.azienda || 'N/D'}
                        <br>Finitura: ${pos.infisso.finitura_int || 'N/D'} / ${pos.infisso.finitura_est || 'N/D'}
                        <br>QuantitÃ : ${pos.infisso.quantita}
                    </div>
                `;
            }
            
            if (pos.tapparella && pos.tapparella.quantita > 0) {
                html += `
                    <div class="material-list-item">
                        ğŸªŸ <strong>Tapparella</strong> ${pos.tapparella.motorizzazione !== 'manuale' ? 'âš¡ Motorizzata' : 'Manuale'}
                        <br>Azienda: ${pos.tapparella.azienda || 'N/D'}
                        <br>QuantitÃ : ${pos.tapparella.quantita}
                    </div>
                `;
            }
            
            if (pos.cassonetto && pos.cassonetto.quantita > 0) {
                html += `
                    <div class="material-list-item">
                        ğŸ“¦ <strong>Cassonetto ${pos.cassonetto.tipo || 'N/D'}</strong>
                        <br>QuantitÃ : ${pos.cassonetto.quantita}
                    </div>
                `;
            }
            
            if (pos.persiana && pos.persiana.quantita > 0) {
                html += `
                    <div class="material-list-item">
                        ğŸªŸ <strong>Persiana ${pos.persiana.tipo || 'N/D'}</strong>
                        <br>Azienda: ${pos.persiana.azienda || 'N/D'}
                        <br>QuantitÃ : ${pos.persiana.quantita}
                    </div>
                `;
            }
            
            if (pos.zanzariera && pos.zanzariera.quantita > 0) {
                html += `
                    <div class="material-list-item">
                        ğŸ¦Ÿ <strong>Zanzariera ${pos.zanzariera.tipo || 'N/D'}</strong>
                        <br>QuantitÃ : ${pos.zanzariera.quantita}
                    </div>
                `;
            }
            
            // Coprifili
            const coprifilo = pos.caratteristiche_muro_override?.coprifilo_larghezza || 
                            appState.rilievoData?.caratteristiche_muro_globali?.coprifilo_larghezza || 0;
            if (coprifilo > 0) {
                html += `
                    <div class="material-list-item">
                        ğŸ“ <strong>Coprifili ${coprifilo}mm</strong> - circa 6m
                    </div>
                `;
            }
            
            html += `
                    <div class="material-list-item">
                        ğŸ”§ <strong>Accessori:</strong> Viti, tasselli, silicone, guarnizioni
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderNoteAlert(pos) {
            let html = `
                <div class="notes-alerts-section">
                    <h2 class="cantiere-section-title">âš ï¸ Note e Attenzioni</h2>
            `;
            
            // Note posizione
            if (pos.note_posizione) {
                html += `
                    <div class="alert-item info">
                        ğŸ“ <strong>Nota:</strong> ${pos.note_posizione}
                    </div>
                `;
            }
            
            // Falso telaio presente
            const muro = pos.caratteristiche_muro_override || appState.rilievoData?.caratteristiche_muro_globali || {};
            if (muro.falso_esistente === 'si') {
                html += `
                    <div class="alert-item warning">
                        âš ï¸ <strong>Attenzione:</strong> Falso telaio presente (${muro.spessore_falso || 0}mm)!
                    </div>
                `;
            }
            
            // Suggerimenti
            html += `
                <div class="alert-item tip">
                    ğŸ’¡ <strong>Suggerimento:</strong> Verificare sempre le misure in opera prima del montaggio
                </div>
            `;
            
            // Delta INT/EST diverso
            if (pos.misure && Math.abs((pos.misure.DeltaINT || 0) - (pos.misure.DeltaEST || 0)) > 5) {
                html += `
                    <div class="alert-item warning">
                        âš ï¸ <strong>Attenzione:</strong> Spessore muro variabile (INT: ${pos.misure.DeltaINT || 0}mm, EST: ${pos.misure.DeltaEST || 0}mm)
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        function renderChecklistOperazioni(pos) {
            const operations = [
                'Vano preparato e pulito',
                'Telaio montato e fissato',
                'Anta installata e funzionante',
                'Tapparella installata (se presente)',
                'Cassonetto montato (se presente)',
                'Silicone applicato',
                'Coprifili montati',
                'Pulizia effettuata',
                'Cliente soddisfatto e ha firmato'
            ];
            
            let html = `
                <div class="final-checklist-section">
                    <h2 class="cantiere-section-title">âœ… Checklist Operazioni Finali</h2>
            `;
            
            operations.forEach((op, index) => {
                const opId = `final-op-${pos.id}-${index}`;
                html += `
                    <div class="final-checklist-item" id="item-${opId}">
                        <input type="checkbox" id="${opId}" 
                               onchange="toggleFinalCheckItem('${opId}', this.checked, '${pos.id}')">
                        <label for="${opId}">${op}</label>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // ============================================================================
        // VISTA 3.3 - DETTAGLIO POSA (v7.20)
        // ============================================================================
        
        /**
         * Configurazione campi prodotti - MODULABILE
         * Modifica qui per cambiare quali campi visualizzare
         */
        const CAMPI_PRODOTTI_POSA = {
            infisso: {
                label: 'ğŸªŸ Infisso',
                campi: [
                    { key: 'tipo', label: 'Tipo' },
                    { key: 'telaio', label: 'Telaio' },
                    { key: 'tipoAnta', label: 'Tipo Anta' },
                    { key: 'finituraInt', label: 'Fin. Int', combineWith: 'coloreInt' },
                    { key: 'finituraEst', label: 'Fin. Est', combineWith: 'coloreEst' },
                    { key: 'allarme', label: 'Allarme', separate: true }
                ]
            },
            persiana: {
                label: 'ğŸšª Persiana',
                campi: [
                    { key: 'tipo', label: 'Tipo' },
                    { key: 'apertura', label: 'Apertura' },
                    { key: 'fissaggio', label: 'Fissaggio' },
                    { key: 'brm_l', label: 'BRM L', source: 'brm.larghezza' },
                    { key: 'brm_h', label: 'BRM H', source: 'brm.altezza' }
                ]
            },
            zanzariera: {
                label: 'ğŸ¦Ÿ Zanzariera',
                campi: [
                    { key: 'tipo', label: 'Tipo' },
                    { key: 'montaggio', label: 'Montaggio' },
                    { key: 'brm_l', label: 'BRM L', source: 'brm.larghezza' },
                    { key: 'brm_h', label: 'BRM H', source: 'brm.altezza' }
                ]
            },
            cassonetto: {
                label: 'ğŸ“¦ Cassonetto',
                campi: [
                    { key: 'modello', label: 'Modello' },
                    { key: 'brm_l', label: 'BRM L', source: 'brm.larghezza' },
                    { key: 'brm_h', label: 'BRM H', source: 'brm.altezza' },
                    { key: 'brm_c', label: 'BRM C', source: 'brm.profondita' },
                    { key: 'brm_b', label: 'BRM B', source: 'brm.spessore' }
                ]
            },
            tapparella: {
                label: 'ğŸšï¸ Tapparella',
                campi: [
                    { key: 'tipo', label: 'Tipo' },
                    { key: 'montaggio', label: 'Montaggio' },
                    { key: 'sistema', label: 'Sistema' },
                    { key: 'azionamento', label: 'Azionamento' }
                ]
            }
        };

        /**
         * Ottiene valore campo da prodotto navigando percorso (es: 'brm.larghezza')
         */
        function getValoreCampo(prodotto, source) {
            if (!source) return '-';
            
            const path = source.split('.');
            let value = prodotto;
            
            for (const key of path) {
                if (value && typeof value === 'object' && key in value) {
                    value = value[key];
                } else {
                    return '-';
                }
            }
            
            return value || '-';
        }

        /**
         * Combina due campi in un valore (es: "pvc 42" o "alluminio L19")
         */
        function combineFields(prodotto, field1, field2) {
            const val1 = prodotto[field1] || '';
            const val2 = prodotto[field2] || '';
            
            if (!val1 && !val2) return '-';
            if (!val1) return val2;
            if (!val2) return val1;
            
            return `${val1} ${val2}`;
        }

        /**
         * Renderizza tabella dettaglio posa
         */
        function renderDettaglioPosa() {
            if (!appState.rilievoData || !appState.rilievoData.posizioni) {
                console.log('âŒ Nessun dato rilievo disponibile');
                return;
            }

            const posizioni = appState.rilievoData.posizioni;
            const container = document.getElementById('dettaglioPosaContainer');
            
            if (!container) {
                console.error('âŒ Container dettaglio posa non trovato');
                return;
            }

            let html = '';

            // Per ogni posizione
            posizioni.forEach((pos, idx) => {
                const posNum = idx + 1;
                const nomePos = pos.nome || pos.ambiente || `Posizione ${posNum}`;
                const piano = pos.piano || '-';
                
                // Raccogli tutti i prodotti della posizione
                const prodottiPosizione = [];
                
                // Controlla ogni tipo di prodotto
                ['infisso', 'persiana', 'zanzariera', 'cassonetto', 'tapparella'].forEach(tipoProdotto => {
                    const prodotto = pos[tipoProdotto];
                    
                    // Se prodotto esiste e ha quantitÃ  > 0
                    if (prodotto && (prodotto.quantita > 0 || prodotto.qta > 0)) {
                        const qta = prodotto.quantita || prodotto.qta || 1;
                        prodottiPosizione.push({
                            tipo: tipoProdotto,
                            dati: prodotto,
                            quantita: qta
                        });
                    }
                });

                // Se posizione ha prodotti, crea sezione
                if (prodottiPosizione.length > 0) {
                    html += `
                        <div class="card" style="margin-bottom: 1.5rem;">
                            <!-- Header Posizione -->
                            <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 1rem; border-radius: 8px 8px 0 0; margin: -1.5rem -1.5rem 1rem -1.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h3 style="margin: 0; font-size: 1.1rem;">ğŸ“ ${nomePos}</h3>
                                        <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; opacity: 0.9;">Piano: ${piano} â€¢ ${prodottiPosizione.length} prodott${prodottiPosizione.length > 1 ? 'i' : 'o'}</p>
                                    </div>
                                    <div style="font-size: 1.5rem; font-weight: bold; opacity: 0.8;">#${posNum}</div>
                                </div>
                            </div>
                    `;

                    // Per ogni prodotto, genera tabella specifica
                    prodottiPosizione.forEach(prodInfo => {
                        const config = CAMPI_PRODOTTI_POSA[prodInfo.tipo];
                        if (!config) return;

                        html += `
                            <!-- Tabella ${config.label} -->
                            <div style="overflow-x: auto; margin-bottom: 1.5rem;">
                                <table class="data-table" style="font-size: 0.9rem;">
                                    <thead>
                                        <tr>
                                            <th colspan="10" style="background: #f3f4f6; text-align: left; padding: 0.75rem;">
                                                <strong>${config.label}</strong>
                                            </th>
                                        </tr>
                                        <tr style="background: #fafafa;">
                                            <th style="width: 60px; text-align: center;">QtÃ </th>
                        `;

                        // Header colonne (escludi campi separati)
                        const campiPrincipali = config.campi.filter(c => !c.separate);
                        campiPrincipali.forEach(campo => {
                            html += `<th style="min-width: 100px;">${campo.label}</th>`;
                        });

                        html += `
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td style="text-align: center;"><strong>${prodInfo.quantita}</strong></td>
                        `;

                        // Valori campi principali
                        campiPrincipali.forEach(campo => {
                            let valore;
                            
                            if (campo.combineWith) {
                                // Combina due campi (es: finitura + colore)
                                valore = combineFields(prodInfo.dati, campo.key, campo.combineWith);
                            } else if (campo.source) {
                                valore = getValoreCampo(prodInfo.dati, campo.source);
                            } else {
                                valore = prodInfo.dati[campo.key] || '-';
                            }
                            
                            html += `<td><strong>${valore}</strong></td>`;
                        });

                        html += `</tr>`;

                        // Riga separata per campi speciali (es: allarme)
                        const campiSeparati = config.campi.filter(c => c.separate);
                        if (campiSeparati.length > 0) {
                            html += `<tr style="background: #fffbeb;">`;
                            html += `<td></td>`; // Cella vuota sotto QtÃ 
                            
                            let html_campi_separati = '';
                            campiSeparati.forEach(campo => {
                                const valore = prodInfo.dati[campo.key] || '-';
                                html_campi_separati += `<span style="font-size: 0.85rem; color: #92400e;"><strong>${campo.label}:</strong> ${valore}</span> `;
                            });
                            
                            html += `<td colspan="${campiPrincipali.length}" style="padding: 0.5rem 1rem;">${html_campi_separati}</td>`;
                            html += `</tr>`;
                        }

                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    });

                    html += `</div>`; // Chiudi card
                }
            });

            // Se nessuna posizione con prodotti
            if (html === '') {
                html = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“‹</div>
                            <div>Nessun prodotto trovato nelle posizioni</div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
            console.log(`âœ… Dettaglio posa renderizzato per ${posizioni.length} posizioni`);
        }

        /**
         * Export CSV dettaglio posa
         */
        function exportDettaglioPosaCSV() {
            if (!appState.rilievoData || !appState.rilievoData.posizioni) {
                alert('âš ï¸ Nessun dato da esportare');
                return;
            }

            const posizioni = appState.rilievoData.posizioni;
            
            // Header CSV
            let csv = 'Posizione,Piano,Ambiente,Prodotto,Quantita,';
            
            // Trova numero massimo colonne
            let maxColonne = 0;
            Object.values(CAMPI_PRODOTTI_POSA).forEach(config => {
                maxColonne = Math.max(maxColonne, config.campi.length);
            });
            
            for (let i = 1; i <= maxColonne; i++) {
                csv += `Campo${i}_Nome,Campo${i}_Valore,`;
            }
            csv = csv.slice(0, -1) + '\n'; // Rimuovi ultima virgola

            // Righe dati
            posizioni.forEach((pos, idx) => {
                const posNum = idx + 1;
                const nomePos = pos.nome || pos.ambiente || `Pos${posNum}`;
                const piano = pos.piano || '';

                ['infisso', 'persiana', 'zanzariera', 'cassonetto', 'tapparella'].forEach(tipoProdotto => {
                    const prodotto = pos[tipoProdotto];
                    
                    if (prodotto && (prodotto.quantita > 0 || prodotto.qta > 0)) {
                        const config = CAMPI_PRODOTTI_POSA[tipoProdotto];
                        if (!config) return;

                        const qta = prodotto.quantita || prodotto.qta || 1;
                        
                        let row = [
                            posNum,
                            piano,
                            nomePos,
                            config.label.replace(/[ğŸªŸğŸšªğŸ¦ŸğŸ“¦ğŸšï¸]/g, '').trim(),
                            qta
                        ];

                        // Aggiungi coppie nome-valore
                        config.campi.forEach(campo => {
                            const valore = campo.source 
                                ? getValoreCampo(prodotto, campo.source)
                                : (prodotto[campo.key] || '-');
                            
                            row.push(campo.label);
                            row.push(valore);
                        });

                        // Riempi colonne vuote
                        const colonneUsate = config.campi.length;
                        for (let i = colonneUsate; i < maxColonne; i++) {
                            row.push('');
                            row.push('');
                        }

                        csv += row.join(',') + '\n';
                    }
                });
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const cliente = appState.rilievoData.clientData?.clientName || 'Cliente';
            const filename = `${cliente}_DettaglioPosa_${new Date().toISOString().split('T')[0]}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`âœ… Export CSV dettaglio posa: ${filename}`);
        }

        // ============================================================================
        // NAVIGAZIONE POSIZIONI CANTIERE
        // ============================================================================
        function navigatePosaPosition(direction) {
            if (direction === 'prev' && posaState.currentPositionIndex > 0) {
                posaState.currentPositionIndex--;
                renderSchedaMontaggio();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else if (direction === 'next' && posaState.currentPositionIndex < posaState.totalPositions - 1) {
                posaState.currentPositionIndex++;
                renderSchedaMontaggio();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // ============================================================================
        // CHECKLIST PERSISTENCE (localStorage)
        // ============================================================================
        function toggleChecklistItem(itemId, checked) {
            const item = document.getElementById(`item-${itemId}`);
            if (item) {
                if (checked) {
                    item.classList.add('checked');
                } else {
                    item.classList.remove('checked');
                }
            }
            
            // Save state
            const checklistState = JSON.parse(localStorage.getItem('posa_checklist_state') || '{}');
            checklistState[itemId] = checked;
            localStorage.setItem('posa_checklist_state', JSON.stringify(checklistState));
        }

        function toggleFinalCheckItem(itemId, checked, positionId) {
            const item = document.getElementById(`item-${itemId}`);
            if (item) {
                if (checked) {
                    item.classList.add('checked');
                } else {
                    item.classList.remove('checked');
                }
            }
            
            // Save state
            const finalCheckState = JSON.parse(localStorage.getItem('posa_final_check_state') || '{}');
            if (!finalCheckState[positionId]) {
                finalCheckState[positionId] = {};
            }
            finalCheckState[positionId][itemId] = checked;
            localStorage.setItem('posa_final_check_state', JSON.stringify(finalCheckState));
        }

        function saveToolCheck(toolIndex, checked) {
            const toolsState = JSON.parse(localStorage.getItem('posa_tools_state') || '{}');
            toolsState[toolIndex] = checked;
            localStorage.setItem('posa_tools_state', JSON.stringify(toolsState));
        }

        function restoreChecklistState(positionId) {
            // Restore general checklist
            const checklistState = JSON.parse(localStorage.getItem('posa_checklist_state') || '{}');
            Object.keys(checklistState).forEach(itemId => {
                const checkbox = document.getElementById(itemId);
                const item = document.getElementById(`item-${itemId}`);
                if (checkbox) {
                    checkbox.checked = checklistState[itemId];
                    if (checklistState[itemId] && item) {
                        item.classList.add('checked');
                    }
                }
            });
            
            // Restore final checks for this position
            const finalCheckState = JSON.parse(localStorage.getItem('posa_final_check_state') || '{}');
            if (finalCheckState[positionId]) {
                Object.keys(finalCheckState[positionId]).forEach(itemId => {
                    const checkbox = document.getElementById(itemId);
                    const item = document.getElementById(`item-${itemId}`);
                    if (checkbox) {
                        checkbox.checked = finalCheckState[positionId][itemId];
                        if (finalCheckState[positionId][itemId] && item) {
                            item.classList.add('checked');
                        }
                    }
                });
            }
            
            // Restore tools
            const toolsState = JSON.parse(localStorage.getItem('posa_tools_state') || '{}');
            Object.keys(toolsState).forEach(toolIndex => {
                const checkbox = document.getElementById(`tool-${toolIndex}`);
                if (checkbox) {
                    checkbox.checked = toolsState[toolIndex];
                }
            });
        }

        function setupChecklistListeners() {
            // Restore checklist state on page load
            const checklistState = JSON.parse(localStorage.getItem('posa_checklist_state') || '{}');
            Object.keys(checklistState).forEach(itemId => {
                const checkbox = document.getElementById(itemId);
                const item = document.getElementById(`item-${itemId}`);
                if (checkbox) {
                    checkbox.checked = checklistState[itemId];
                    if (checklistState[itemId] && item) {
                        item.classList.add('checked');
                    }
                }
            });
            
            // Restore tools state
            const toolsState = JSON.parse(localStorage.getItem('posa_tools_state') || '{}');
            Object.keys(toolsState).forEach(toolIndex => {
                const checkbox = document.getElementById(`tool-${toolIndex}`);
                if (checkbox) {
                    checkbox.checked = toolsState[toolIndex];
                }
            });
        }

        // ============================================================================
        // FULLSCREEN TOGGLE
        // ============================================================================
        function togglePosaFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // Initialize menu on load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ¯ Initializing Advanced Menu...');
            renderAdvancedMenu();
            updateBreadcrumb('generale', 'dashboard');
            setupKeyboardShortcuts();
            console.log('âœ… Advanced Menu initialized');
            
            // ğŸ”„ FASE 027E: Auto-load progetti da GitHub
            initGitHubSync();
        });

        // ============================================
        // ğŸ”„ GITHUB READER MODULE - Dashboard v1.0
        // ============================================
        // Legge automaticamente progetti sincronizzati da GitHub
        
        const GITHUB_DASHBOARD_CONFIG = {
            enabled: true, // Abilita lettura automatica
            owner: 'Openporte2025',
            repo: 'dati-cantieri',
            branch: 'main',
            token: '', // âš ï¸ Token caricato da localStorage - NON inserire qui!
            autoRefreshInterval: 60000, // 60 secondi
            lastSync: null
        };

        /**
         * Carica configurazione salvata
         */
        function loadGitHubConfig() {
            try {
                const saved = localStorage.getItem('github_dashboard_config');
                if (saved) {
                    const config = JSON.parse(saved);
                    GITHUB_DASHBOARD_CONFIG.owner = config.owner || GITHUB_DASHBOARD_CONFIG.owner;
                    GITHUB_DASHBOARD_CONFIG.repo = config.repo || GITHUB_DASHBOARD_CONFIG.repo;
                    GITHUB_DASHBOARD_CONFIG.branch = config.branch || GITHUB_DASHBOARD_CONFIG.branch;
                    console.log(`ğŸ“ Config caricata: ${GITHUB_DASHBOARD_CONFIG.owner}/${GITHUB_DASHBOARD_CONFIG.repo}`);
                }
            } catch (e) {
                console.log('â„¹ï¸ Nessuna config salvata, uso default');
            }
        }

        /**
         * Salva configurazione
         */
        function saveGitHubConfig() {
            const config = {
                owner: GITHUB_DASHBOARD_CONFIG.owner,
                repo: GITHUB_DASHBOARD_CONFIG.repo,
                branch: GITHUB_DASHBOARD_CONFIG.branch
            };
            localStorage.setItem('github_dashboard_config', JSON.stringify(config));
            console.log('ğŸ’¾ Config salvata');
        }

        /**
         * Inizializza sincronizzazione GitHub
         */
        async function initGitHubSync() {
            console.log('ğŸ”„ GitHub Reader Module - Initializing...');
            
            // Carica configurazione salvata (owner/repo)
            loadGitHubConfig();
            
            // Carica token da localStorage (salvato in questa dashboard)
            try {
                const savedToken = localStorage.getItem('github_dashboard_token');
                if (savedToken) {
                    GITHUB_DASHBOARD_CONFIG.token = savedToken;
                    console.log('âœ… Token GitHub caricato da localStorage dashboard');
                }
            } catch (e) {
                console.log('â„¹ï¸ Nessun token salvato');
            }
            
            // Se non trovato, prova da app-rilievo
            if (!GITHUB_DASHBOARD_CONFIG.token) {
                try {
                    const appData = localStorage.getItem('openPorteData');
                    if (appData) {
                        const parsed = JSON.parse(appData);
                        if (parsed.github?.token) {
                            GITHUB_DASHBOARD_CONFIG.token = parsed.github.token;
                            console.log('âœ… Token GitHub trovato da app-rilievo');
                        }
                    }
                } catch (e) {
                    console.log('â„¹ï¸ Token non trovato in app-rilievo');
                }
            }
            
            // Carica progetti da GitHub
            if (GITHUB_DASHBOARD_CONFIG.enabled) {
                await loadProjectsFromGitHub();
                
                // Auto-refresh ogni minuto (solo se caricamento ha successo)
                if (GITHUB_DASHBOARD_CONFIG.lastSync) {
                    setInterval(async () => {
                        console.log('ğŸ”„ Auto-refresh progetti da GitHub...');
                        await loadProjectsFromGitHub();
                    }, GITHUB_DASHBOARD_CONFIG.autoRefreshInterval);
                }
            }
        }

        /**
         * Carica tutti i progetti dal repository GitHub
         */
        async function loadProjectsFromGitHub() {
            try {
                console.log('ğŸ“¡ Caricamento progetti da GitHub...');
                
                // Usa Git Tree API per ricerca ricorsiva in tutte le cartelle
                const url = `https://api.github.com/repos/${GITHUB_DASHBOARD_CONFIG.owner}/${GITHUB_DASHBOARD_CONFIG.repo}/git/trees/${GITHUB_DASHBOARD_CONFIG.branch}?recursive=1`;
                
                const headers = {
                    'Accept': 'application/vnd.github.v3+json'
                };
                
                // Aggiungi token se disponibile
                if (GITHUB_DASHBOARD_CONFIG.token) {
                    headers['Authorization'] = `token ${GITHUB_DASHBOARD_CONFIG.token}`;
                    console.log('ğŸ”‘ Token GitHub presente');
                } else {
                    console.log('âš ï¸ Nessun token - tentativo accesso pubblico');
                }
                
                const response = await fetch(url, { headers });
                
                // Gestione errori specifici
                if (response.status === 404) {
                    throw new Error('Repository non trovato. Verifica owner/repo.');
                }
                
                if (response.status === 401 || response.status === 403) {
                    console.error('âŒ Accesso negato - Repository privato o token non valido');
                    showGitHubTokenForm();
                    throw new Error('Repository privato - Inserisci token GitHub');
                }
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                }
                
                const tree = await response.json();
                
                // Filtra file JSON progetto da TUTTE le sottocartelle
                const projectFiles = tree.tree
                    .filter(f => 
                        f.path.endsWith('.json') && 
                        f.type === 'blob' &&
                        f.path.includes('progetto-')
                    )
                    .map(f => ({
                        name: f.path.split('/').pop(),
                        path: f.path,
                        sha: f.sha,
                        download_url: `https://api.github.com/repos/${GITHUB_DASHBOARD_CONFIG.owner}/${GITHUB_DASHBOARD_CONFIG.repo}/contents/${f.path}?ref=${GITHUB_DASHBOARD_CONFIG.branch}`
                    }));
                
                console.log(`ğŸ“‚ Trovati ${projectFiles.length} progetti su GitHub`);
                console.log(`ğŸ“„ Path file trovati:`, projectFiles.map(f => f.path));
                
                if (projectFiles.length === 0) {
                    showGitHubStatus('info', 'Nessun progetto sincronizzato trovato');
                    return;
                }
                
                // Carica contenuto di ogni progetto
                const allProjects = [];
                for (const file of projectFiles) {
                    try {
                        const loadedProjectData = await loadGitHubFile(file.download_url);
                        if (loadedProjectData) {
                            allProjects.push({
                                filename: file.name,
                                data: loadedProjectData,
                                lastModified: file.sha
                            });
                        }
                    } catch (e) {
                        console.error(`âŒ Errore caricamento ${file.name}:`, e);
                    }
                }
                
                console.log(`âœ… Caricati ${allProjects.length} progetti con successo`);
                console.log(`ğŸ“Š Dati progetti:`, allProjects.map(p => ({
                    filename: p.filename,
                    id: p.data?.id,
                    projectName: p.data?.projectName,
                    customerName: p.data?.customerName
                })));
                
                // Aggiorna UI con progetti
                updateDashboardWithGitHubProjects(allProjects);
                
                GITHUB_DASHBOARD_CONFIG.lastSync = new Date().toISOString();
                showGitHubStatus('success', `${allProjects.length} progetti caricati da GitHub`);
                
            } catch (error) {
                console.error('âŒ Errore caricamento da GitHub:', error);
                showGitHubStatus('error', error.message || 'Errore connessione GitHub');
            }
        }

        /**
         * Mostra form per inserire token GitHub
         */
        function showGitHubTokenForm() {
            const existingForm = document.getElementById('github-token-modal');
            if (existingForm) return; // Form giÃ  presente
            
            const modal = document.createElement('div');
            modal.id = 'github-token-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
                    <h2 style="margin: 0 0 1rem 0; color: #2d3748; font-size: 1.5rem;">
                        âš™ï¸ Configurazione GitHub
                    </h2>
                    
                    <p style="color: #718096; margin-bottom: 1.5rem; line-height: 1.6;">
                        Configura l'accesso al repository GitHub dove sono salvati i progetti sincronizzati.
                    </p>
                    
                    <!-- Repository Config -->
                    <div style="background: #f7fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; color: #4a5568; font-size: 1rem;">
                            ğŸ“¦ Repository
                        </h3>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #4a5568; font-weight: 600; font-size: 0.9rem;">
                                Owner (username o organization):
                            </label>
                            <input type="text" id="github-owner-input" 
                                   value="${GITHUB_DASHBOARD_CONFIG.owner}"
                                   placeholder="Openporte2025"
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem;">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #4a5568; font-weight: 600; font-size: 0.9rem;">
                                Repository name:
                            </label>
                            <input type="text" id="github-repo-input" 
                                   value="${GITHUB_DASHBOARD_CONFIG.repo}"
                                   placeholder="dati-cantieri"
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem;">
                        </div>
                        
                        <div style="color: #718096; font-size: 0.85rem; margin-top: 0.5rem;">
                            ğŸ’¡ URL completo: github.com/<span id="preview-owner">${GITHUB_DASHBOARD_CONFIG.owner}</span>/<span id="preview-repo">${GITHUB_DASHBOARD_CONFIG.repo}</span>
                        </div>
                    </div>
                    
                    <!-- Token Config -->
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #4a5568; font-weight: 600;">
                            ğŸ”‘ Token GitHub (opzionale se repo pubblico):
                        </label>
                        <input type="password" id="github-token-input" 
                               placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                               value="${GITHUB_DASHBOARD_CONFIG.token || ''}"
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem; font-family: monospace;"
                               onkeypress="if(event.key==='Enter') saveGitHubConfigAndToken()">
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <a href="https://github.com/settings/tokens/new?scopes=repo&description=OpenPorte%20Dashboard" 
                           target="_blank"
                           style="color: #6366f1; text-decoration: none; font-size: 0.9rem;">
                            ğŸ“ Crea nuovo token su GitHub â†’
                        </a>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="closeGitHubTokenForm()" 
                                style="padding: 0.75rem 1.5rem; background: #e2e8f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: #4a5568;">
                            Annulla
                        </button>
                        <button onclick="saveGitHubConfigAndToken()" 
                                style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: white;">
                            ğŸ’¾ Salva e Carica
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Update preview on input
            const ownerInput = document.getElementById('github-owner-input');
            const repoInput = document.getElementById('github-repo-input');
            
            ownerInput.addEventListener('input', () => {
                document.getElementById('preview-owner').textContent = ownerInput.value || 'owner';
            });
            
            repoInput.addEventListener('input', () => {
                document.getElementById('preview-repo').textContent = repoInput.value || 'repo';
            });
            
            ownerInput.focus();
        }

        /**
         * Salva configurazione GitHub completa
         */
        function saveGitHubConfigAndToken() {
            const owner = document.getElementById('github-owner-input')?.value.trim();
            const repo = document.getElementById('github-repo-input')?.value.trim();
            const token = document.getElementById('github-token-input')?.value.trim();
            
            if (!owner || !repo) {
                showGitHubStatus('warning', 'Owner e Repository sono obbligatori');
                return;
            }
            
            // Aggiorna config
            GITHUB_DASHBOARD_CONFIG.owner = owner;
            GITHUB_DASHBOARD_CONFIG.repo = repo;
            if (token) {
                GITHUB_DASHBOARD_CONFIG.token = token;
            }
            
            // Salva in localStorage
            saveGitHubConfig();
            if (token) {
                localStorage.setItem('github_dashboard_token', token);
            }
            
            console.log(`âœ… Config salvata: ${owner}/${repo}`);
            
            // Chiudi form
            closeGitHubTokenForm();
            
            // Ricarica progetti
            showGitHubStatus('info', 'Caricamento progetti...');
            loadProjectsFromGitHub();
        }

        /**
         * Chiude form token
         */
        function closeGitHubTokenForm() {
            const modal = document.getElementById('github-token-modal');
            if (modal) {
                modal.remove();
            }
        }

        /**
         * Carica un singolo file da GitHub
         */
        async function loadGitHubFile(downloadUrl) {
            try {
                const headers = {
                    'Accept': 'application/vnd.github.v3+json'
                };
                
                // Aggiungi token se disponibile per repo privati
                if (GITHUB_DASHBOARD_CONFIG.token) {
                    headers['Authorization'] = `token ${GITHUB_DASHBOARD_CONFIG.token}`;
                }
                
                const response = await fetch(downloadUrl, { headers });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // L'API GitHub restituisce il contenuto in base64
                // Decodifica e parsifica JSON
                const content = atob(data.content.replace(/\n/g, ''));
                return JSON.parse(content);
            } catch (error) {
                console.error('Errore caricamento file:', error);
                return null;
            }
        }

        /**
         * Aggiorna dashboard con progetti da GitHub
         */
        function updateDashboardWithGitHubProjects(githubProjects) {
            if (githubProjects.length === 0) return;
            
            console.log('ğŸ”„ Aggiornamento dashboard con progetti GitHub...');
            console.log('ğŸ“Š Progetti ricevuti:', githubProjects);
            
            // Converte progetti GitHub nel formato della dashboard
            const projectsList = githubProjects.map(gp => {
                const data = gp.data;
                
                // Supporta sia formato vecchio che nuovo
                let id, projectName, customerName, ambiente, posizioni, metadata;
                
                if (data.rilievo) {
                    // NUOVO FORMATO (con struttura "rilievo")
                    id = data.rilievo.meta?.id_rilievo;
                    customerName = data.rilievo.cliente?.nome || data.rilievo.cliente?.ragione_sociale || 'Cliente Senza Nome';
                    projectName = customerName; // Usa sempre il nome cliente
                    ambiente = data.rilievo.cantiere?.indirizzo || data.rilievo.cantiere?.cittÃ  || 'N/D';
                    posizioni = data.rilievo.misure?.length || 0;
                    metadata = {
                        lastModified: data.rilievo.meta?.data_modifica || data.rilievo.meta?.data_creazione
                    };
                } else {
                    // VECCHIO FORMATO (formato app-rilievo)
                    id = data.id;
                    // ğŸ”§ v8.13: PrioritÃ  nome cliente su nome progetto/file
                    // OpenPorte usa: client (nome), clientData.nome (dettaglio), name (progetto)
                    customerName = data.client || data.clientData?.nome || data.cliente?.nome || data.customerName || 'Cliente Senza Nome';
                    // Se customerName Ã¨ uguale al nome file (es. "INFISSI+PERSIANE"), prova altri campi
                    if (customerName === data.name && (data.clientData?.nome || data.cliente?.nome)) {
                        customerName = data.clientData?.nome || data.cliente?.nome;
                    }
                    projectName = data.projectName || data.name || customerName;
                    ambiente = data.currentEnvironment || 'N/D';
                    posizioni = data.positions?.length || data.project?.rilievoInfissi?.length || 0;
                    metadata = data.metadata;
                }
                
                console.log('ğŸ” Mapping progetto:', {
                    filename: gp.filename,
                    formato: data.rilievo ? 'NUOVO' : 'VECCHIO',
                    id: id,
                    projectName: projectName,
                    customerName: customerName,
                    posizioni: posizioni
                });
                
                // Estrai informazioni progetto
                return {
                    id: id || gp.filename,
                    nome: customerName || projectName || 'Progetto Senza Nome',
                    cliente: customerName,
                    ambiente: ambiente,
                    dataModifica: new Date(metadata?.lastModified || Date.now()).toLocaleDateString('it-IT'),
                    posizioni: posizioni,
                    completamento: calcolaCompletamentoProgetto(data),
                    source: 'github',
                    rawData: data
                };
            });
            
            // Salva in una variabile globale per accesso rapido
            window.githubProjects = projectsList;
            
            // ğŸ†• Popola menu laterale con progetti
            updateSidebarMenu(projectsList);
            
            // Se siamo nella vista lista progetti, aggiorna
            if (window.location.hash === '#progetti' || !window.location.hash) {
                renderProjectsList(projectsList);
            }
            
            console.log(`âœ… Dashboard aggiornata con ${projectsList.length} progetti`);
        }

        /**
         * Calcola completamento progetto
         */
        function calcolaCompletamentoProgetto(data) {
            let score = 0;
            let total = 0;
            
            // Cliente (25%)
            total += 25;
            if (data.customerName) score += 10;
            if (data.customerPhone) score += 5;
            if (data.customerEmail) score += 5;
            if (data.customerAddress) score += 5;
            
            // Setup (25%)
            total += 25;
            const hasProdotti = data.project?.hasInfissi || data.project?.hasPersiane || 
                               data.project?.hasTapparelle || data.project?.hasZanzariere;
            if (hasProdotti) score += 25;
            
            // Posizioni (50%)
            total += 50;
            const posizioni = data.project?.rilievoInfissi?.length || 0;
            if (posizioni > 0) {
                score += Math.min(50, posizioni * 10);
            }
            
            return Math.round((score / total) * 100);
        }

        /**
         * Renderizza lista progetti
         */
        function renderProjectsList(projects) {
            const container = document.getElementById('progetti-list-container');
            const card = document.getElementById('githubProjectsCard');
            
            if (!container) return;
            
            // Mostra card se ci sono progetti
            if (card) {
                card.style.display = projects.length > 0 ? 'block' : 'none';
            }
            
            if (projects.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #718096;">
                        Nessun progetto sincronizzato trovato su GitHub
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="padding: 1rem 0;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
            `;
            
            projects.forEach(p => {
                const completamentoColor = p.completamento >= 80 ? '#10b981' : 
                                          p.completamento >= 50 ? '#f59e0b' : '#ef4444';
                
                html += `
                    <div style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s; border: 2px solid transparent;" 
                         onclick="loadGitHubProject('${p.id}')"
                         onmouseover="this.style.transform='translateY(-4px)'; this.style.borderColor='#6366f1'; this.style.boxShadow='0 8px 16px rgba(99, 102, 241, 0.2)'"
                         onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='transparent'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                        
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <h3 style="font-size: 1.1rem; color: #2d3748; margin: 0; font-weight: 700;">${p.nome}</h3>
                            <span style="background: ${completamentoColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 700;">
                                ${p.completamento}%
                            </span>
                        </div>
                        
                        <div style="color: #4a5568; font-size: 0.95rem; margin-bottom: 0.5rem; font-weight: 500;">
                            ğŸ‘¤ ${p.cliente}
                        </div>
                        
                        <div style="color: #718096; font-size: 0.9rem; margin-bottom: 0.5rem;">
                            ğŸ  ${p.ambiente}
                        </div>
                        
                        <div style="color: #718096; font-size: 0.9rem; margin-bottom: 0.5rem;">
                            ğŸ“ ${p.posizioni} posizion${p.posizioni !== 1 ? 'i' : 'e'}
                        </div>
                        
                        <div style="color: #a0aec0; font-size: 0.85rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                            <span>ğŸ“… ${p.dataModifica}</span>
                            <span style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GitHub</span>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        /**
         * Carica progetto specifico da GitHub
         */
        /**
         * Converte formato GitHub nel formato compatibile con la dashboard
         */
        function convertGitHubToDashboardFormat(githubData) {
            console.log('ğŸ”„ Conversione formato GitHub â†’ Dashboard');
            console.log('ğŸ“¦ Dati ricevuti:', githubData);
            console.log('ğŸ” Campi disponibili:', Object.keys(githubData));
            console.log('ğŸ“‹ configInfissi presente:', !!githubData.configInfissi);
            console.log('ğŸ“‹ configInfissi contenuto:', githubData.configInfissi);
            
            // Se giÃ  ha il campo "posizioni", ritorna cosÃ¬ com'Ã¨
            if (githubData.posizioni && Array.isArray(githubData.posizioni)) {
                console.log('âœ… Formato giÃ  corretto con posizioni array');
                console.log('   â¡ï¸ configInfissi preservato:', !!githubData.configInfissi);
                return githubData;
            }
            
            // FORMATO 1: data.rilievo.misure â†’ data.posizioni
            if (githubData.rilievo?.misure) {
                console.log('âœ… Formato NUOVO riconosciuto (rilievo.misure)');
                console.log('ğŸ“Š Numero posizioni:', githubData.rilievo.misure.length);
                return {
                    ...githubData,
                    posizioni: githubData.rilievo.misure,
                    nome: githubData.rilievo.cliente?.nome || githubData.rilievo.cliente?.ragione_sociale || 'Progetto',
                    nome_ricerca: githubData.rilievo.meta?.nome_progetto || githubData.rilievo.cliente?.nome || 'N/D',
                    cliente: {
                        nome: githubData.rilievo.cliente?.nome || githubData.rilievo.cliente?.ragione_sociale || 'N/D',
                        cognome: githubData.rilievo.cliente?.cognome || '',
                        progetto: githubData.rilievo.meta?.nome_progetto || githubData.rilievo.cliente?.nome || 'N/D',
                        piano: githubData.rilievo.cantiere?.piano || '',
                        indirizzo: githubData.rilievo.cantiere?.indirizzo || '',
                        via: githubData.rilievo.cantiere?.via || '',
                        citta: githubData.rilievo.cantiere?.cittÃ  || githubData.rilievo.cantiere?.citta || '',
                        telefono: githubData.rilievo.cliente?.telefono || '',
                        email: githubData.rilievo.cliente?.email || ''
                    },
                    data_rilievo: githubData.rilievo.meta?.data_creazione || Date.now(),
                    project: githubData.rilievo
                };
            }
            
            // FORMATO 2: data.project.rilievoInfissi â†’ data.posizioni
            if (githubData.project?.rilievoInfissi && Array.isArray(githubData.project.rilievoInfissi)) {
                console.log('âœ… Formato VECCHIO riconosciuto (project.rilievoInfissi)');
                console.log('ğŸ“Š Numero posizioni:', githubData.project.rilievoInfissi.length);
                
                // Normalizza ogni posizione
                const posizioniNormalizzate = githubData.project.rilievoInfissi.map(pos => {
                    const normalized = { ...pos };
                    
                    // Normalizza infisso
                    if (pos.infisso) {
                        normalized.infisso = {
                            ...pos.infisso,
                            quantita: parseInt(pos.infisso.qta) || 0,
                            azienda: pos.infisso.azienda || 'Non specificata',
                            brm: {
                                L: pos.infisso.BRM_L || 0,
                                H: pos.infisso.BRM_H || 0
                            },
                            finitura_int: pos.infisso.finituraInt,
                            finitura_est: pos.infisso.finituraEst,
                            colore_int: pos.infisso.coloreInt,
                            colore_est: pos.infisso.coloreEst
                        };
                    }
                    
                    // Normalizza persiana
                    if (pos.persiana) {
                        normalized.persiana = {
                            ...pos.persiana,
                            quantita: parseInt(pos.persiana.qta) || 0,
                            azienda: pos.persiana.azienda || 'Non specificata',
                            modello: pos.persiana.modello || pos.persiana.tipo,
                            brm: {
                                L: pos.persiana.BRM_L || 0,
                                H: pos.persiana.BRM_H || 0
                            },
                            colore: pos.persiana.colorePersiana || pos.persiana.colore
                        };
                    }
                    
                    // Normalizza zanzariera
                    if (pos.zanzariera) {
                        normalized.zanzariera = {
                            ...pos.zanzariera,
                            quantita: parseInt(pos.zanzariera.qta) || 0,
                            azienda: pos.zanzariera.azienda || 'Non specificata',
                            modello: pos.zanzariera.modello || pos.zanzariera.tipo,
                            brm: {
                                L: pos.zanzariera.BRM_L || 0,
                                H: pos.zanzariera.BRM_H || 0
                            },
                            colore: pos.zanzariera.coloreTelaio
                        };
                    }
                    
                    // Normalizza tapparella
                    if (pos.tapparella) {
                        normalized.tapparella = {
                            ...pos.tapparella,
                            quantita: parseInt(pos.tapparella.qta) || 0,
                            azienda: pos.tapparella.azienda || 'Non specificata',
                            brm: {
                                L: pos.tapparella.BRM_L || 0,
                                H: pos.tapparella.BRM_H || 0
                            }
                        };
                    }
                    
                    // Normalizza cassonetto
                    if (pos.cassonetto) {
                        normalized.cassonetto = {
                            ...pos.cassonetto,
                            quantita: parseInt(pos.cassonetto.qta) || 0,
                            azienda: pos.cassonetto.azienda || 'Non specificata',
                            // ğŸ†• v8.12: Misure rilevate
                            LS: parseInt(pos.cassonetto.LS) || 0,
                            HCASS: parseInt(pos.cassonetto.HCASS) || 0,
                            B: parseInt(pos.cassonetto.B) || 0,
                            C: parseInt(pos.cassonetto.C) || 0,
                            brm: {
                                L: parseInt(pos.cassonetto.BRM_L) || 0,
                                H: parseInt(pos.cassonetto.BRM_H) || parseInt(pos.cassonetto.HCASS) || 0,
                                C: parseInt(pos.cassonetto.BRM_C) || parseInt(pos.cassonetto.C) || 0,
                                B: parseInt(pos.cassonetto.BRM_B) || parseInt(pos.cassonetto.B) || 0
                            }
                        };
                    }
                    
                    return normalized;
                });
                
                return {
                    ...githubData,
                    posizioni: posizioniNormalizzate,
                    nome: githubData.projectName || githubData.customerName || 'Progetto',
                    nome_ricerca: githubData.projectName || githubData.customerName || 'N/D',
                    cliente: githubData.clientData || {
                        nome: githubData.customerName || 'N/D',
                        cognome: '',
                        progetto: githubData.projectName || githubData.customerName || 'N/D',
                        piano: githubData.piano || '',
                        indirizzo: githubData.indirizzo || '',
                        via: githubData.via || '',
                        citta: githubData.citta || '',
                        telefono: githubData.customerPhone || '',
                        email: githubData.customerEmail || ''
                    },
                    // âœ… v7.73: FIX - Preserva configInfissi
                    configInfissi: githubData.configInfissi || {},
                    // ğŸ” v7.98: Preserva configBlindate
                    configBlindate: githubData.configBlindate || {},
                    data_rilievo: githubData.metadata?.created || Date.now()
                };
            }
            
            // FORMATO 3: Formato openporte-v4_5 (positions array)
            if (githubData.positions && Array.isArray(githubData.positions)) {
                console.log('âœ… Formato OPENPORTE riconosciuto (positions)');
                console.log('ğŸ“Š Numero posizioni:', githubData.positions.length);
                
                // âœ… Normalizza ogni posizione con conversione prodotti
                const posizioniNormalizzate = githubData.positions.map((posGitHub, index) => {
                    const posDash = {
                        id: posGitHub.id || `pos-${index}`,
                        nome: posGitHub.name || `Posizione ${index + 1}`,
                        ambiente: posGitHub.ambiente || '',
                        quantita: parseInt(posGitHub.quantita || 1),
                        misure: {}
                    };
                    
                    // âœ… Converti misure (mantieni valori semplici!)
                    // Copia direttamente le misure senza trasformarle in oggetti
                    if (posGitHub.misure) {
                        posDash.misure = { ...posGitHub.misure };
                    }
                    
                    // âš ï¸ FIX CRITICO: Converti prodotti con qtaâ†’quantita e BRM
                    ['infisso', 'tapparella', 'persiana', 'zanzariera', 'cassonetto'].forEach(tipoProdotto => {
                        if (posGitHub[tipoProdotto]) {
                            const prodGitHub = posGitHub[tipoProdotto];
                            
                            // Inizializza prodotto copiando tutti i campi
                            posDash[tipoProdotto] = { ...prodGitHub };
                            
                            // âœ… FIX 1: Converti qta â†’ quantita (numero)
                            posDash[tipoProdotto].quantita = parseInt(prodGitHub.qta || prodGitHub.quantita || 0);
                            
                            // âœ… FIX 2: Gestione BRM intelligente
                            const hasBRM = prodGitHub.BRM_L && prodGitHub.BRM_H && 
                                          prodGitHub.BRM_L !== null && prodGitHub.BRM_H !== null &&
                                          parseInt(prodGitHub.BRM_L) > 0 && parseInt(prodGitHub.BRM_H) > 0;
                            
                            if (hasBRM) {
                                // BRM presente: converti formato BRM_L/BRM_H â†’ brm.L/brm.H
                                posDash[tipoProdotto].brm = {
                                    L: parseInt(prodGitHub.BRM_L),
                                    H: parseInt(prodGitHub.BRM_H)
                                };
                                console.log(`âœ… ${tipoProdotto} Pos ${index + 1}: BRM da GitHub ${posDash[tipoProdotto].brm.L}Ã—${posDash[tipoProdotto].brm.H}`);
                            } else {
                                // BRM mancante: usa LF o default
                                if (posDash.misure && posDash.misure.LF && posDash.misure.LF.L > 0) {
                                    posDash[tipoProdotto].brm = {
                                        L: posDash.misure.LF.L,
                                        H: posDash.misure.LF.H
                                    };
                                    console.log(`âœ… ${tipoProdotto} Pos ${index + 1}: BRM calcolato da LF ${posDash[tipoProdotto].brm.L}Ã—${posDash[tipoProdotto].brm.H}`);
                                } else {
                                    // Default ragionevole
                                    posDash[tipoProdotto].brm = {
                                        L: 1000,
                                        H: 1200
                                    };
                                    console.warn(`âš ï¸ ${tipoProdotto} Pos ${index + 1}: BRM default usato 1000Ã—1200`);
                                }
                            }
                            
                            // Rimuovi campi obsoleti
                            delete posDash[tipoProdotto].qta;
                            delete posDash[tipoProdotto].BRM_L;
                            delete posDash[tipoProdotto].BRM_H;
                        }
                    });
                    
                    // ğŸ” v7.98_06: Converti BLINDATA/PORTONCINO (supporta pos.ingresso.blindata e pos.blindata)
                    const blindataSource = posGitHub.ingresso?.blindata || posGitHub.blindata;
                    if (blindataSource) {
                        posDash.blindata = { ...blindataSource };
                        posDash.ingresso = {
                            tipo: posGitHub.ingresso?.tipo || 'blindata',
                            blindata: { ...blindataSource }
                        };
                        console.log(`âœ… blindata Pos ${index + 1}: ${blindataSource.LNP_L}Ã—${blindataSource.LNP_H} (${blindataSource.versione})`);
                    }
                    
                    // ğŸ” v7.98_06: Converti PORTONCINO
                    const portoncinoSource = posGitHub.ingresso?.portoncino || posGitHub.portoncino;
                    if (portoncinoSource) {
                        posDash.portoncino = { ...portoncinoSource };
                        posDash.ingresso = {
                            tipo: posGitHub.ingresso?.tipo || 'portoncino',
                            portoncino: { ...portoncinoSource }
                        };
                        console.log(`âœ… portoncino Pos ${index + 1}`);
                    }
                    
                    return posDash;
                });
                
                return {
                    ...githubData,
                    posizioni: posizioniNormalizzate,
                    nome: githubData.name || githubData.projectName || 'Progetto',
                    nome_ricerca: githubData.projectName || githubData.name || 'N/D',
                    cliente: githubData.clientData || {
                        nome: githubData.client || githubData.customerName || 'N/D',
                        cognome: '',
                        progetto: githubData.projectName || githubData.name || 'N/D',
                        piano: githubData.piano || '',
                        indirizzo: githubData.indirizzo || '',
                        via: githubData.via || '',
                        citta: githubData.citta || '',
                        telefono: githubData.customerPhone || '',
                        email: githubData.customerEmail || ''
                    },
                    // âœ… v7.73: FIX - Preserva configInfissi
                    configInfissi: githubData.configInfissi || {},
                    // ğŸ” v7.98: Preserva configBlindate
                    configBlindate: githubData.configBlindate || {},
                    data_rilievo: githubData.created || Date.now()
                };
            }
            
            // Formato sconosciuto - crea struttura minima con posizioni vuoto
            console.error('âš ï¸ Formato dati non riconosciuto:', githubData);
            console.error('ğŸ“‹ Campi root disponibili:', Object.keys(githubData));
            console.error('ğŸ’¡ Suggerimento: controlla la struttura del JSON salvato su GitHub');
            
            return {
                ...githubData,
                posizioni: [], // âœ… Garantisci array vuoto invece di undefined
                nome: githubData.name || githubData.projectName || githubData.customerName || 'Progetto Sconosciuto',
                nome_ricerca: githubData.projectName || githubData.name || 'N/D',
                cliente: githubData.clientData || githubData.cliente || { 
                    nome: githubData.customerName || githubData.client || 'N/D',
                    cognome: '',
                    progetto: githubData.projectName || githubData.name || 'N/D',
                    piano: githubData.piano || '',
                    indirizzo: githubData.indirizzo || '',
                    via: githubData.via || '',
                    citta: githubData.citta || '',
                    telefono: githubData.customerPhone || '',
                    email: githubData.customerEmail || ''
                },
                data_rilievo: Date.now()
            };
        }

        function loadGitHubProject(projectId) {
            console.log('ğŸ“‚ loadGitHubProject chiamato con ID:', projectId);
            
            const project = window.githubProjects?.find(p => p.id === projectId);
            if (!project) {
                showAlert('error', 'Progetto non trovato');
                return;
            }
            
            console.log('ğŸ“‚ Caricamento progetto:', project.nome);
            console.log('   ğŸ” rawData.configInfissi:', project.rawData?.configInfissi);
            
            // âœ… CONVERTI formato GitHub â†’ formato Dashboard
            const dashboardData = convertGitHubToDashboardFormat(project.rawData);
            console.log('   ğŸ” dashboardData.configInfissi dopo conversione:', dashboardData?.configInfissi);
            
            // âœ… v7.73: Aggiorna projectData PRIMA di processare
            projectData = dashboardData;
            console.log('   ğŸ” projectData.configInfissi dopo assegnazione:', projectData?.configInfissi);
            
            // Usa la funzione esistente della dashboard per caricare i dati
            processRilievoData(dashboardData, `${project.nome}.json`);
            
            // âœ… v7.73: Aggiorna config globale dopo caricamento
            console.log('   ğŸ”„ Chiamata renderConfigGlobale...');
            renderConfigGlobale();
            console.log('   ğŸ”„ Chiamata initConfigMenu...');
            initConfigMenu();
            console.log('âš™ï¸ v7.73: Config aggiornata dopo loadGitHubProject');
            
            // âœ… PASSA AUTOMATICAMENTE AL BLOCCO UFFICIO
            switchBlocco('ufficio');
            
            showAlert('success', `Progetto "${project.nome}" caricato da GitHub!`);
        }

        /**
         * Mostra stato sincronizzazione GitHub
         */
        function showGitHubStatus(type, message) {
            // Crea badge di stato se non esiste
            let badge = document.getElementById('github-status-badge');
            if (!badge) {
                badge = document.createElement('div');
                badge.id = 'github-status-badge';
                badge.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    padding: 0.75rem 1rem;
                    border-radius: 8px;
                    font-size: 0.9rem;
                    font-weight: 600;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 9999;
                    transition: all 0.3s;
                    opacity: 0;
                `;
                document.body.appendChild(badge);
            }
            
            // Colori per tipo
            const colors = {
                success: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                error: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
                info: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
                warning: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'
            };
            
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                info: 'â„¹ï¸',
                warning: 'âš ï¸'
            };
            
            badge.style.background = colors[type] || colors.info;
            badge.style.color = 'white';
            badge.innerHTML = `${icons[type] || 'â„¹ï¸'} ${message}`;
            badge.style.opacity = '1';
            
            // Nascondi dopo 5 secondi
            setTimeout(() => {
                badge.style.opacity = '0';
            }, 5000);
        }

        console.log('ğŸ”„ GitHub Reader Module loaded');

        // ============================================================================
        // SISTEMA PREVENTIVAZIONE
        // ============================================================================
        
        /**
         * Apre il wizard preventivo con analisi intelligente
         */
        function apriPreventivo() {
            console.log('ğŸ’° Apertura preventivo...');
            
            if (!window.PreventivoUI) {
                console.error('âŒ PreventivoUI non caricato!');
                alert('Errore: modulo preventivo non disponibile');
                return;
            }
            
            if (!window.currentData) {
                alert('âš ï¸ Nessun progetto caricato. Carica prima un rilievo.');
                return;
            }
            
            // Analizza dati e apre wizard se necessario
            window.WizardCompletamento.avviaAnalisi();
        }
        
        console.log('âœ… Sistema Preventivazione initialized');

    </script>

    <!-- Moduli Sistema Menu Avanzato (opzionali) -->
    <!-- <script src="completion-tracker.js"></script> -->
    <!-- <script src="badge-renderer.js"></script> -->
    
    <!-- Stub per compatibilitÃ  se moduli esterni non disponibili -->
    <script>
        if (!window.CompletionTracker) {
            window.CompletionTracker = {
                updateMenuStatus: function() {
                    console.log('âš ï¸ CompletionTracker stub - funzione non implementata');
                }
            };
        }
        
        if (!window.BadgeRenderer) {
            window.BadgeRenderer = {
                getBadgeHTML: function() { return ''; },
                renderMiniProgressBar: function() { return ''; }
            };
        }
    </script>
    
    <!-- SISTEMA PREVENTIVI - INLINE -->
    <script>
        // ============================================================================
        // PREVENTIVO CALCULATOR - Sistema di calcolo preventivi
        // ============================================================================
        window.PreventivoCalculator = {
            
            // Listini fornitori (caricati dinamicamente)
            listini: {
                finstral: null,
                palagina: null,
                persiane: null
            },
            
            // LISTINO FINSTRAL PREZZI MEDI
            listino_finstral: {
                telai: {
                    "961": { nome: "Base 961", pvc_pvc: 0, pvc_alluminio: 25.0 },
                    "965": { nome: "965 Ribassato", pvc_pvc: 8.0, pvc_alluminio: 30.0 },
                    "967": { nome: "967 Forma Z", pvc_pvc: 10.9, pvc_alluminio: 35.0 },
                    "Z62": { nome: "Z62 Compatto", pvc_pvc: 5.21, pvc_alluminio: 28.0 },
                    "Z91": { nome: "Z91 Rinforzato", pvc_pvc: 16.1, pvc_alluminio: 38.0 },
                    "962": { nome: "962 Intermedio", pvc_pvc: 17.0, pvc_alluminio: 32.0 },
                    "924": { nome: "924 Leggero", pvc_pvc: 18.0, pvc_alluminio: 33.0 },
                    "951": { nome: "951 Rinforzato", pvc_pvc: 22.5, pvc_alluminio: 40.0 }
                },
                ante: {
                    "classic-line": { nome: "Classic-line", codice: "973", pvc_pvc: 180, pvc_alluminio: 220 },
                    "step-line": { nome: "Step-line", codice: "974", pvc_pvc: 190, pvc_alluminio: 230 },
                    "nova-line": { nome: "Nova-line", pvc_pvc: 200, pvc_alluminio: 250 },
                    "slim-line": { nome: "Slim-line", pvc_pvc: 195, pvc_alluminio: 240 }
                },
                vetri: {
                    "doppio": { nome: "Doppio", prezzo: 45 },
                    "doppio-sat": { nome: "Doppio Satinato", prezzo: 55 },
                    "triplo": { nome: "Triplo", prezzo: 65 },
                    "triplo-sat": { nome: "Triplo Satinato", prezzo: 75 }
                }
            },
            
            // Configurazione prezzi base
            config: {
                iva: 0.22,
                margine_default: 1.30,
                costo_posa_mq: 85.00,
                costo_smontaggio: 45.00
            },
            
            /**
             * Calcola preventivo completo per un progetto
             */
            calcolaPreventivo(datiProgetto) {
                console.log('ğŸ’° Calcolo preventivo per:', datiProgetto.nome);
                
                const risultato = {
                    successo: true,
                    progetto: datiProgetto.nome || 'Progetto',
                    cliente: datiProgetto.cliente || {},
                    timestamp: new Date().toISOString(),
                    voci: [],
                    totali: {
                        materiali: 0,
                        posa: 0,
                        smontaggio: 0,
                        subtotale: 0,
                        iva: 0,
                        totale: 0
                    },
                    warnings: []
                };
                
                // Analizza ogni posizione
                const posizioni = datiProgetto.posizioni || [];
                
                posizioni.forEach((pos, idx) => {
                    // INFISSI - ğŸ†• v7.82: Supporta sia qta che quantita
                    const infQta = parseInt(pos.infisso?.quantita) || parseInt(pos.infisso?.qta) || 0;
                    if (pos.infisso && infQta > 0) {
                        pos.infisso.quantita = infQta;
                        const voce = this.calcolaVoceInfisso(pos, idx + 1);
                        if (voce.successo) {
                            risultato.voci.push(voce);
                            risultato.totali.materiali += parseFloat(voce.importo);
                            risultato.totali.posa += parseFloat(voce.costo_posa || 0);
                        } else {
                            risultato.warnings.push(voce.errore);
                        }
                    }
                    
                    // ZANZARIERE - ğŸ†• v7.82: Supporta sia qta che quantita
                    const zanzQta = parseInt(pos.zanzariera?.quantita) || parseInt(pos.zanzariera?.qta) || 0;
                    if (pos.zanzariera && zanzQta > 0) {
                        pos.zanzariera.quantita = zanzQta;
                        const voce = this.calcolaVoceZanzariera(pos, idx + 1);
                        if (voce.successo) {
                            risultato.voci.push(voce);
                            risultato.totali.materiali += parseFloat(voce.importo);
                        } else {
                            risultato.warnings.push(voce.errore);
                        }
                    }
                    
                    // PERSIANE - ğŸ†• v7.82: Supporta sia qta che quantita
                    const persQta = parseInt(pos.persiana?.quantita) || parseInt(pos.persiana?.qta) || 0;
                    if (pos.persiana && persQta > 0) {
                        pos.persiana.quantita = persQta;
                        const voce = this.calcolaVocePersiana(pos, idx + 1);
                        if (voce.successo) {
                            risultato.voci.push(voce);
                            risultato.totali.materiali += parseFloat(voce.importo);
                            risultato.totali.posa += parseFloat(voce.costo_posa || 0);
                        } else {
                            risultato.warnings.push(voce.errore);
                        }
                    }
                    
                    // TAPPARELLE - ğŸ†• v7.82: Supporta sia qta che quantita
                    const tappQta = parseInt(pos.tapparella?.quantita) || parseInt(pos.tapparella?.qta) || 0;
                    if (pos.tapparella && tappQta > 0) {
                        // Assicura che quantita sia valorizzato
                        pos.tapparella.quantita = tappQta;
                        const voce = this.calcolaVoceTapparella(pos, idx + 1);
                        if (voce.successo) {
                            risultato.voci.push(voce);
                            risultato.totali.materiali += parseFloat(voce.importo);
                        } else {
                            risultato.warnings.push(voce.errore);
                        }
                    }
                    
                    // CASSONETTI - ğŸ†• v7.82: Supporta sia qta che quantita
                    const cassQta = parseInt(pos.cassonetto?.quantita) || parseInt(pos.cassonetto?.qta) || 0;
                    if (pos.cassonetto && cassQta > 0) {
                        pos.cassonetto.quantita = cassQta;
                        const voce = this.calcolaVoceCassonetto(pos, idx + 1);
                        if (voce.successo) {
                            risultato.voci.push(voce);
                            risultato.totali.materiali += parseFloat(voce.importo);
                        } else {
                            risultato.warnings.push(voce.errore);
                        }
                    }
                });
                
                // Calcola totali
                risultato.totali.smontaggio = posizioni.length * this.config.costo_smontaggio;
                risultato.totali.subtotale = risultato.totali.materiali + 
                                             risultato.totali.posa + 
                                             risultato.totali.smontaggio;
                risultato.totali.iva = risultato.totali.subtotale * this.config.iva;
                risultato.totali.totale = risultato.totali.subtotale + risultato.totali.iva;
                
                // Arrotonda tutti i totali
                Object.keys(risultato.totali).forEach(key => {
                    risultato.totali[key] = parseFloat(risultato.totali[key].toFixed(2));
                });
                
                console.log('âœ… Preventivo calcolato:', risultato.totali);
                
                return risultato;
            },
            
            /**
             * Calcola voce infisso
             */
            calcolaVoceInfisso(posizione, numero) {
                const infisso = posizione.infisso;
                
                // ğŸ”§ COMPATIBILITÃ€ RETROATTIVA: Supporta sia brm.L che BRM_L
                const L = infisso.brm?.L || infisso.BRM_L || 0;
                const H = infisso.brm?.H || infisso.BRM_H || 0;
                
                // Validazione dati base
                if (!L || !H) {
                    return {
                        successo: false,
                        errore: `Posizione ${numero}: Mancano misure BRM per infisso`
                    };
                }
                
                // Calcoli base (L e H giÃ  definiti sopra)
                const perimetro = 2 * (L + H) / 1000; // metri lineari
                const superficie = (L * H) / 1000000; // mq
                
                let prezzo_totale = 0;
                let dettaglio = [];
                
                // CALCOLO FINSTRAL CON FORMULA AVANZATA
                if (infisso.azienda && infisso.azienda.toLowerCase().includes('finstral')) {
                    
                    // DETERMINA MATERIALE da finituraEst (o finituraInt come fallback)
                    const finitura = infisso.finituraEst || infisso.finituraInt || '';
                    const isMaterialePVC = !finitura.toLowerCase().includes('alluminio');
                    
                    // 1. PREZZO BASE (tipo 101 finestra o tipo 401 porta-finestra)
                    const isPortaFinestra = infisso.tipo && (
                        infisso.tipo.toLowerCase().includes('pf') || 
                        infisso.tipo.toLowerCase().includes('porta') ||
                        H > 1800
                    );
                    
                    let prezzo_base = 0;
                    if (isPortaFinestra) {
                        // Tipo 401: ~220â‚¬/mq + 200â‚¬ fisso
                        prezzo_base = (superficie * 220) + 200;
                        dettaglio.push(`Base Porta-finestra (tipo 401): ${prezzo_base.toFixed(0)}â‚¬`);
                    } else {
                        // Tipo 101: ~180â‚¬/mq + 100â‚¬ fisso
                        prezzo_base = (superficie * 180) + 100;
                        dettaglio.push(`Base Finestra (tipo 101): ${prezzo_base.toFixed(0)}â‚¬`);
                    }
                    
                    prezzo_totale += prezzo_base;
                    
                    // 2. SUPPLEMENTO TELAIO (se diverso da 961 base)
                    if (infisso.telaio && infisso.telaio !== '961') {
                        const supplementi_telaio = {
                            '965': { pvc_pvc: 8.0, pvc_alluminio: 30.0 },
                            '967': { pvc_pvc: 10.9, pvc_alluminio: 35.0 },
                            'Z62': { pvc_pvc: 5.21, pvc_alluminio: 28.0 },
                            'Z91': { pvc_pvc: 16.1, pvc_alluminio: 38.0 },
                            '962': { pvc_pvc: 17.0, pvc_alluminio: 32.0 },
                            '924': { pvc_pvc: 18.0, pvc_alluminio: 33.0 },
                            '951': { pvc_pvc: 22.5, pvc_alluminio: 40.0 }
                        };
                        
                        const supp_telaio = supplementi_telaio[infisso.telaio];
                        if (supp_telaio) {
                            const prezzo_ml = isMaterialePVC ? supp_telaio.pvc_pvc : supp_telaio.pvc_alluminio;
                            const costo = perimetro * prezzo_ml;
                            
                            prezzo_totale += costo;
                            const materiale_label = isMaterialePVC ? 'PVC/PVC' : 'PVC/Alu';
                            dettaglio.push(`Supp.Tel.${infisso.telaio}(${materiale_label}): +${costo.toFixed(0)}â‚¬`);
                        }
                    }
                    
                    // 3. SUPPLEMENTO MATERIALE (Alluminio su telaio base 961)
                    if (!isMaterialePVC && (!infisso.telaio || infisso.telaio === '961')) {
                        const costo = perimetro * 25;
                        prezzo_totale += costo;
                        dettaglio.push(`Rivestimento Alluminio: +${costo.toFixed(0)}â‚¬`);
                    }
                    
                    // 4. SUPPLEMENTO ANTA (se diversa da Classic/Step-line base)
                    if (infisso.tipoAnta && 
                        !['classic-line', 'step-line'].includes(infisso.tipoAnta.toLowerCase())) {
                        const supplementi_anta = {
                            'nova-line': { pvc_pvc: 20, pvc_alluminio: 30 },
                            'slim-line': { pvc_pvc: 15, pvc_alluminio: 20 }
                        };
                        
                        const supp_anta = supplementi_anta[infisso.tipoAnta.toLowerCase()];
                        if (supp_anta) {
                            const prezzo_mq = isMaterialePVC ? supp_anta.pvc_pvc : supp_anta.pvc_alluminio;
                            const costo = superficie * prezzo_mq;
                            
                            prezzo_totale += costo;
                            dettaglio.push(`Supp.Anta ${infisso.tipoAnta}: +${costo.toFixed(0)}â‚¬`);
                        }
                    }
                    
                    // 5. SUPPLEMENTO VETRO (se diverso da doppio standard)
                    if (infisso.vetro && infisso.vetro !== 'doppio') {
                        const supplementi_vetro = {
                            'doppio-sat': 10,
                            'triplo': 20,
                            'triplo-sat': 30
                        };
                        
                        const supp_vetro_mq = supplementi_vetro[infisso.vetro.toLowerCase()];
                        if (supp_vetro_mq) {
                            const costo = superficie * supp_vetro_mq;
                            prezzo_totale += costo;
                            dettaglio.push(`Supp.Vetro ${infisso.vetro}: +${costo.toFixed(0)}â‚¬`);
                        }
                    }
                    
                } else {
                    // CALCOLO STANDARD NON-FINSTRAL
                    prezzo_totale = superficie * 450;
                    dettaglio.push('Calcolo standard');
                }
                
                // POSA
                const costo_posa = superficie * this.config.costo_posa_mq * infisso.quantita;
                const importo_totale = prezzo_totale * infisso.quantita;
                
                return {
                    successo: true,
                    tipo: 'Infisso',
                    posizione: posizione.nome || posizione.ambiente || `Pos. ${numero}`,
                    descrizione: `${infisso.azienda || 'Infisso'} - ${infisso.tipo || ''} ${infisso.telaio || ''}`,
                    quantita: infisso.quantita,
                    misure: `${L}Ã—${H} mm`,  // Usa variabili uniformate
                    perimetro_ml: perimetro.toFixed(2),
                    superficie_mq: superficie.toFixed(2),
                    prezzo_unitario: prezzo_totale.toFixed(2),
                    importo: importo_totale.toFixed(2),
                    costo_posa: costo_posa.toFixed(2),
                    dettaglio_calcolo: dettaglio.join(' | '),
                    note: infisso.note || ''
                };
            },
            
            /**
             * Calcola voce zanzariera
             */
            calcolaVoceZanzariera(posizione, numero) {
                const zanzariera = posizione.zanzariera;
                
                if (!zanzariera.brm || !zanzariera.brm.L || !zanzariera.brm.H) {
                    return {
                        successo: false,
                        errore: `Posizione ${numero}: Mancano misure BRM per zanzariera`
                    };
                }
                
                const superficie_mq = (zanzariera.brm.L * zanzariera.brm.H) / 1000000;
                
                const prezzi_base = {
                    'plisse': 120,
                    'avvolgibile': 95,
                    'battente': 85,
                    'scorrevole': 110
                };
                
                const tipo_lower = (zanzariera.tipo || zanzariera.modello || '').toLowerCase();
                let prezzo_mq = 100;
                
                for (const [key, value] of Object.entries(prezzi_base)) {
                    if (tipo_lower.includes(key)) {
                        prezzo_mq = value;
                        break;
                    }
                }
                
                const prezzo_unitario = superficie_mq * prezzo_mq;
                const importo = prezzo_unitario * zanzariera.quantita;
                
                return {
                    successo: true,
                    tipo: 'Zanzariera',
                    posizione: posizione.nome || posizione.ambiente || `Pos. ${numero}`,
                    descrizione: zanzariera.tipo || zanzariera.modello || 'Zanzariera',
                    quantita: zanzariera.quantita,
                    misure: `${zanzariera.brm.L}Ã—${zanzariera.brm.H} mm`,
                    superficie_mq: superficie_mq.toFixed(2),
                    prezzo_unitario: prezzo_unitario.toFixed(2),
                    importo: importo.toFixed(2)
                };
            },
            
            /**
             * Calcola voce persiana
             */
            calcolaVocePersiana(posizione, numero) {
                const persiana = posizione.persiana;
                
                if (!persiana.brm || !persiana.brm.L || !persiana.brm.H) {
                    return {
                        successo: false,
                        errore: `Posizione ${numero}: Mancano misure BRM per persiana`
                    };
                }
                
                const superficie_mq = (persiana.brm.L * persiana.brm.H) / 1000000;
                const prezzo_mq = 180;
                const prezzo_unitario = superficie_mq * prezzo_mq;
                const costo_posa = superficie_mq * 45 * persiana.quantita;
                const importo = prezzo_unitario * persiana.quantita;
                
                return {
                    successo: true,
                    tipo: 'Persiana',
                    posizione: posizione.nome || posizione.ambiente || `Pos. ${numero}`,
                    descrizione: persiana.tipo || 'Persiana',
                    quantita: persiana.quantita,
                    misure: `${persiana.brm.L}Ã—${persiana.brm.H} mm`,
                    superficie_mq: superficie_mq.toFixed(2),
                    prezzo_unitario: prezzo_unitario.toFixed(2),
                    importo: importo.toFixed(2),
                    costo_posa: costo_posa.toFixed(2)
                };
            },
            
            /**
             * Calcola voce tapparella
             */
            calcolaVoceTapparella(posizione, numero) {
                const tapparella = posizione.tapparella;
                
                // ğŸ†• v7.82: Helper locale per estrarre codice
                const estraiCodice = (str) => str ? String(str).split(' - ')[0].trim() : null;
                
                // ğŸ†• v7.82: Estrai misure (supporta piÃ¹ formati)
                let L_mm = parseInt(tapparella.brm?.L) || parseInt(tapparella.BRM_L) || parseInt(posizione.misure?.LF) || 0;
                let H_mm = parseInt(tapparella.brm?.H) || parseInt(tapparella.BRM_H) || parseInt(posizione.misure?.HF) || 0;
                
                if (!L_mm || !H_mm) {
                    return {
                        successo: false,
                        errore: `Posizione ${numero}: Mancano misure BRM per tapparella`
                    };
                }
                
                // ğŸ†• v7.82: Maggiorazione foro se da LF/HF
                const usaMisureForo = !tapparella.brm?.L && !tapparella.BRM_L && (posizione.misure?.LF || posizione.misure?.HF);
                if (usaMisureForo) {
                    L_mm += 40;   // +40mm larghezza
                    H_mm += 200;  // +200mm altezza
                }
                
                const L_cm = L_mm / 10;
                const H_cm = H_mm / 10;
                
                // ğŸ†• v7.82: Estrai codice modello (es. "TA01" da "TA01 - Tipo ALUPROFIL MD 13x55")
                const modelloCompleto = tapparella.modello || 'TA01';
                const modelloTelo = estraiCodice(modelloCompleto) || 'TA01';
                const coloreTelo = tapparella.colore_tipo || 'tinta_unita';
                
                let prezzo_unitario = 0;
                let dettaglioCalcolo = null;
                
                // Verifica se calcolaPrezzoPLASTICINO Ã¨ disponibile
                if (typeof calcolaPrezzoPLASTICINO === 'function') {
                    dettaglioCalcolo = calcolaPrezzoPLASTICINO(L_cm, H_cm, modelloTelo, coloreTelo);
                    prezzo_unitario = dettaglioCalcolo.totale || 0;
                    
                    // ğŸ†• v7.82: Estrai codice guida (es. "TG10" da "TG10 - Guide 30x25x30 Portafinestra")
                    const guidaCompleta = tapparella.guida || '';
                    const guidaCodice = estraiCodice(guidaCompleta);
                    if (guidaCodice && guidaCodice !== '' && typeof calcolaPrezzoGuida === 'function') {
                        const coloreGuida = tapparella.coloreGuida || 'Argento';
                        const guidaCalc = calcolaPrezzoGuida(guidaCodice, coloreGuida, H_mm);
                        prezzo_unitario += guidaCalc.prezzo || 0;
                    }
                    
                    console.log(`âœ… v7.82 Tapparella Pos ${numero}: ${L_cm}Ã—${H_cm}cm â†’ â‚¬${prezzo_unitario.toFixed(2)}`);
                } else {
                    // Fallback se funzione non disponibile
                    const superficie_mq = (L_cm * H_cm) / 10000;
                    const prezzo_base = tapparella.motorizzazione === 'si' ? 250 : 120;
                    prezzo_unitario = superficie_mq * prezzo_base;
                    console.warn(`âš ï¸ v7.82 Tapparella Pos ${numero}: Fallback calcolo semplificato`);
                }
                
                const quantita = parseInt(tapparella.quantita) || 1;
                const importo = prezzo_unitario * quantita;
                const superficie_mq = (L_cm * H_cm) / 10000;
                
                return {
                    successo: true,
                    tipo: 'Tapparella',
                    posizione: posizione.nome || posizione.ambiente || `Pos. ${numero}`,
                    descrizione: tapparella.motorizzazione === 'si' ? 'Tapparella Motorizzata' : 'Tapparella Manuale',
                    quantita: quantita,
                    misure: `${L_mm}Ã—${H_mm} mm`,
                    superficie_mq: superficie_mq.toFixed(2),
                    prezzo_unitario: prezzo_unitario.toFixed(2),
                    importo: importo.toFixed(2),
                    dettaglio: dettaglioCalcolo  // ğŸ†• v7.82: Salva dettaglio per breakdown
                };
            },
            
            /**
             * Calcola voce cassonetto
             */
            calcolaVoceCassonetto(posizione, numero) {
                const cassonetto = posizione.cassonetto;
                
                if (!cassonetto.brm || !cassonetto.brm.L) {
                    return {
                        successo: false,
                        errore: `Posizione ${numero}: Mancano misure per cassonetto`
                    };
                }
                
                const lunghezza_m = cassonetto.brm.L / 1000;
                const prezzo_ml = 65;
                const prezzo_unitario = lunghezza_m * prezzo_ml;
                const importo = prezzo_unitario * cassonetto.quantita;
                
                return {
                    successo: true,
                    tipo: 'Cassonetto',
                    posizione: posizione.nome || posizione.ambiente || `Pos. ${numero}`,
                    descrizione: cassonetto.tipo || 'Cassonetto',
                    quantita: cassonetto.quantita,
                    misure: `L: ${cassonetto.brm.L} mm`,
                    prezzo_unitario: prezzo_unitario.toFixed(2),
                    importo: importo.toFixed(2)
                };
            }
        };

        console.log('ğŸ’° PreventivoCalculator loaded');
    </script>
    
    <script>
        // ============================================================================
        // PREVENTIVO UI - Interfaccia utente per preventivi
        // ============================================================================
        window.PreventivoUI = {
            
            preventivoCorrente: null,
            
            apriModalPreventivo() {
                console.log('ğŸ“Š Apertura modal preventivo...');
                
                if (!window.currentData || !window.currentData.posizioni) {
                    this.mostraErrore('Nessun progetto caricato');
                    return;
                }
                
                const preventivo = window.PreventivoCalculator.calcolaPreventivo(window.currentData);
                this.preventivoCorrente = preventivo;
                
                // RIMOSSA VALIDAZIONE - ora gestita dal Wizard
                // Il wizard si occupa di completare i dati mancanti prima di arrivare qui
                
                this.renderPreventivo(preventivo);
            },
            
            mostraNoData() {
                const html = `
                    <div class="preventivo-modal-overlay" id="preventivo-modal" onclick="if(event.target===this) PreventivoUI.chiudiModal()">
                        <div class="preventivo-modal">
                            <div class="preventivo-modal-header">
                                <h2 class="preventivo-modal-title">ğŸ’° Dettaglio Costi</h2>
                                <button class="preventivo-modal-close" onclick="PreventivoUI.chiudiModal()">âœ•</button>
                            </div>
                            
                            <div class="preventivo-warning">
                                <div class="preventivo-warning-icon">âš ï¸</div>
                                <div class="preventivo-warning-text">
                                    <p>Nessun prodotto con dati sufficienti per calcolare il preventivo.</p>
                                    <p>Verifica che siano presenti <strong>modelli</strong> e <strong>misure BRM</strong> nei rilievi.</p>
                                </div>
                            </div>
                            
                            <div class="preventivo-modal-actions">
                                <button class="btn-preventivo btn-secondary" onclick="PreventivoUI.chiudiModal()">
                                    â† Chiudi
                                </button>
                                <button class="btn-preventivo btn-primary" disabled style="opacity: 0.5; cursor: not-allowed;">
                                    ğŸ“„ Esporta PDF
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                const container = document.createElement('div');
                container.innerHTML = html;
                document.body.appendChild(container.firstElementChild);
            },
            
            renderPreventivo(preventivo) {
                console.log('ğŸ¨ Rendering preventivo...', preventivo);
                
                // Se davvero non ci sono voci (dopo wizard), mostra messaggio
                if (preventivo.voci.length === 0) {
                    const html = `
                        <div class="preventivo-modal-overlay" id="preventivo-modal" onclick="if(event.target===this) PreventivoUI.chiudiModal()">
                            <div class="preventivo-modal">
                                <div class="preventivo-modal-header">
                                    <h2 class="preventivo-modal-title">ğŸ’° Dettaglio Costi</h2>
                                    <button class="preventivo-modal-close" onclick="PreventivoUI.chiudiModal()">âœ•</button>
                                </div>
                                
                                <div class="preventivo-warning">
                                    <div class="preventivo-warning-icon">âš ï¸</div>
                                    <div class="preventivo-warning-text">
                                        <p>Nessun prodotto trovato nel progetto.</p>
                                        <p>Verifica che ci siano prodotti con <strong>quantitÃ  > 0</strong> nelle posizioni.</p>
                                    </div>
                                </div>
                                
                                <div class="preventivo-modal-actions">
                                    <button class="btn-preventivo btn-secondary" onclick="PreventivoUI.chiudiModal()">
                                        â† Chiudi
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', html);
                    return;
                }
                
                const html = `
                    <div class="preventivo-modal-overlay" id="preventivo-modal" onclick="if(event.target===this) PreventivoUI.chiudiModal()">
                        <div class="preventivo-modal preventivo-modal-large">
                            <div class="preventivo-modal-header">
                                <div>
                                    <h2 class="preventivo-modal-title">ğŸ’° Dettaglio Costi</h2>
                                    <p class="preventivo-modal-subtitle">${preventivo.progetto}</p>
                                </div>
                                <button class="preventivo-modal-close" onclick="PreventivoUI.chiudiModal()">âœ•</button>
                            </div>
                            
                            <div class="preventivo-cliente-info">
                                <div class="preventivo-info-item">
                                    <span class="preventivo-info-label">Cliente:</span>
                                    <span class="preventivo-info-value">${preventivo.cliente.nome || 'N/D'}</span>
                                </div>
                                ${preventivo.cliente.indirizzo ? `
                                <div class="preventivo-info-item">
                                    <span class="preventivo-info-label">Indirizzo:</span>
                                    <span class="preventivo-info-value">${preventivo.cliente.indirizzo}</span>
                                </div>
                                ` : ''}
                                <div class="preventivo-info-item">
                                    <span class="preventivo-info-label">Data:</span>
                                    <span class="preventivo-info-value">${new Date().toLocaleDateString('it-IT')}</span>
                                </div>
                            </div>
                            
                            ${preventivo.warnings.length > 0 ? `
                            <div class="preventivo-warnings-list">
                                <div class="preventivo-warnings-title">âš ï¸ Avvisi:</div>
                                ${preventivo.warnings.map(w => `<div class="preventivo-warning-item">${w}</div>`).join('')}
                            </div>
                            ` : ''}
                            
                            <div class="preventivo-table-container">
                                <table class="preventivo-table">
                                    <thead>
                                        <tr>
                                            <th>Posizione</th>
                                            <th>Tipo</th>
                                            <th>Descrizione</th>
                                            <th>Misure</th>
                                            <th>QtÃ </th>
                                            <th>Prezzo Unit.</th>
                                            <th>Importo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${preventivo.voci.map((voce, index) => {
                                            // ğŸ†• v7.82: Determina se riga Ã¨ cliccabile
                                            // ğŸ”Œ v8.09: Aggiunto Motore
                                            const isTapparella = voce.tipo.toLowerCase() === 'tapparella';
                                            const isPersiana = voce.tipo.toLowerCase() === 'persiana';
                                            const isMotore = voce.tipo.toLowerCase() === 'motore';
                                            const isClickable = isTapparella || isPersiana || isMotore;
                                            const clickStyle = isClickable ? 'cursor: pointer;' : '';
                                            // Estrai numero posizione (es: "Pos. 1" â†’ 1)
                                            const posNum = parseInt(String(voce.posizione).replace(/\D/g, '')) || (index + 1);
                                            // ğŸ†• v7.84: Supporto persiane
                                            // ğŸ”Œ v8.09: Supporto motori
                                            const clickHandler = isTapparella ? `onclick="window.mostraDettaglioCostiTapparella(${posNum})" onmouseover="this.style.background='#fef3c7'" onmouseout="this.style.background=''"` : 
                                                                 isPersiana ? `onclick="window.mostraDettaglioCostiPersiana(${posNum})" onmouseover="this.style.background='#f3e8ff'" onmouseout="this.style.background=''"` :
                                                                 isMotore ? `onclick="window.mostraDettaglioCostiMotore(${posNum})" onmouseover="this.style.background='#ffedd5'" onmouseout="this.style.background=''"` : '';
                                            const clickIcon = isClickable ? ' ğŸ”' : '';
                                            const clickTitle = isClickable ? 'title="Clicca per vedere il dettaglio costi"' : '';
                                            
                                            return `
                                            <tr style="${clickStyle}" ${clickHandler} ${clickTitle}>
                                                <td>${voce.posizione}</td>
                                                <td><span class="voce-tipo-badge ${voce.tipo.toLowerCase()}">${voce.tipo}${clickIcon}</span></td>
                                                <td>${voce.descrizione}</td>
                                                <td style="font-family: monospace; font-size: 0.9rem;">${voce.misure}</td>
                                                <td style="text-align: center; font-weight: 600;">${voce.quantita}</td>
                                                <td style="text-align: right;">â‚¬ ${voce.prezzo_unitario}</td>
                                                <td style="text-align: right; font-weight: 700;">â‚¬ ${voce.importo}</td>
                                            </tr>
                                        `}).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="preventivo-totali">
                                <div class="preventivo-totale-row">
                                    <span>Materiali:</span>
                                    <span>â‚¬ ${preventivo.totali.materiali.toFixed(2)}</span>
                                </div>
                                <div class="preventivo-totale-row">
                                    <span>Posa:</span>
                                    <span>â‚¬ ${preventivo.totali.posa.toFixed(2)}</span>
                                </div>
                                <div class="preventivo-totale-row">
                                    <span>Smontaggio:</span>
                                    <span>â‚¬ ${preventivo.totali.smontaggio.toFixed(2)}</span>
                                </div>
                                <div class="preventivo-totale-row subtotale">
                                    <span>Subtotale:</span>
                                    <span>â‚¬ ${preventivo.totali.subtotale.toFixed(2)}</span>
                                </div>
                                <div class="preventivo-totale-row">
                                    <span>IVA (22%):</span>
                                    <span>â‚¬ ${preventivo.totali.iva.toFixed(2)}</span>
                                </div>
                                <div class="preventivo-totale-row finale">
                                    <span>TOTALE:</span>
                                    <span>â‚¬ ${preventivo.totali.totale.toFixed(2)}</span>
                                </div>
                            </div>
                            
                            <div class="preventivo-modal-actions">
                                <button class="btn-preventivo btn-secondary" onclick="PreventivoUI.chiudiModal()">
                                    â† Chiudi
                                </button>
                                <button class="btn-preventivo btn-primary" onclick="PreventivoUI.esportaPDF()">
                                    ğŸ“„ Esporta PDF
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                const container = document.createElement('div');
                container.innerHTML = html;
                document.body.appendChild(container.firstElementChild);
            },
            
            chiudiModal() {
                const modal = document.getElementById('preventivo-modal');
                if (modal) {
                    modal.remove();
                }
            },
            
            esportaPDF() {
                if (!this.preventivoCorrente) {
                    alert('Nessun preventivo da esportare');
                    return;
                }
                
                console.log('ğŸ“„ Esportazione PDF preventivo...');
                alert('Funzione esportazione PDF in arrivo!');
            },
            
            mostraErrore(messaggio) {
                alert('âŒ ' + messaggio);
            }
        };

        console.log('ğŸ¨ PreventivoUI loaded');
    </script>
    
    <script>
        // ============================================================================
        // WIZARD COMPLETAMENTO DATI - Sistema intelligente multi-step
        // ============================================================================
        window.WizardCompletamento = {
            
            datiProgetto: null,
            analisi: null,
            configurazioneMisure: null,
            attributiCompletati: {},
            stepCorrente: 0,
            
            /**
             * Avvia analisi dati progetto
             */
            avviaAnalisi() {
                console.log('ğŸ” Avvio analisi dati progetto...');
                
                this.datiProgetto = window.currentData;
                this.analisi = this.analizzaDati();
                
                console.log('ğŸ“Š Analisi completata:', this.analisi);
                
                // Se tutto OK, vai diretto al preventivo
                if (this.analisi.tuttoOK) {
                    console.log('âœ… Tutti i dati presenti, genero preventivo diretto');
                    window.PreventivoUI.apriModalPreventivo();
                    return;
                }
                
                // Altrimenti apri wizard
                this.apriWizard();
            },
            
            /**
             * Analizza dati e trova cosa manca
             */
            analizzaDati() {
                const analisi = {
                    tuttoOK: true,
                    posizioniTotali: 0,
                    posizioniComplete: 0,
                    problemi: {
                        misureBRM: [],
                        attributi: []
                    }
                };
                
                const posizioni = this.datiProgetto.posizioni || [];
                analisi.posizioniTotali = posizioni.length;
                
                posizioni.forEach((pos, idx) => {
                    let posOK = true;
                    
                    // Controlla ogni tipo di prodotto
                    ['infisso', 'zanzariera', 'persiana', 'tapparella', 'cassonetto'].forEach(tipo => {
                        const prodotto = pos[tipo];
                        
                        if (prodotto && prodotto.quantita > 0) {
                            // Verifica BRM
                            const brmOK = this.verificaBRM(prodotto, tipo);
                            if (!brmOK) {
                                analisi.problemi.misureBRM.push({
                                    posizioneIdx: idx,
                                    posizione: pos.nome || pos.ambiente || `Posizione ${idx + 1}`,
                                    tipo: tipo,
                                    prodotto: prodotto,
                                    misureDisponibili: pos.misure || {}
                                });
                                posOK = false;
                                analisi.tuttoOK = false;
                            }
                            
                            // Verifica attributi specifici
                            const attributiMancanti = this.verificaAttributi(prodotto, tipo);
                            if (attributiMancanti.length > 0) {
                                analisi.problemi.attributi.push({
                                    posizioneIdx: idx,
                                    posizione: pos.nome || pos.ambiente || `Posizione ${idx + 1}`,
                                    tipo: tipo,
                                    prodotto: prodotto,
                                    attributiMancanti: attributiMancanti
                                });
                                posOK = false;
                                analisi.tuttoOK = false;
                            }
                        }
                    });
                    
                    if (posOK) analisi.posizioniComplete++;
                });
                
                return analisi;
            },
            
            /**
             * Verifica se BRM Ã¨ presente e valido
             */
            verificaBRM(prodotto, tipo) {
                if (tipo === 'cassonetto') {
                    // Cassonetto serve solo L
                    return prodotto.brm && prodotto.brm.L && prodotto.brm.L > 0;
                } else {
                    // Altri prodotti servono L e H
                    return prodotto.brm && 
                           prodotto.brm.L && prodotto.brm.L > 0 &&
                           prodotto.brm.H && prodotto.brm.H > 0;
                }
            },
            
            /**
             * Verifica attributi specifici per tipo prodotto
             */
            verificaAttributi(prodotto, tipo) {
                const mancanti = [];
                
                switch(tipo) {
                    case 'persiana':
                        if (!prodotto.telaio) mancanti.push({campo: 'telaio', label: 'Tipo Telaio'});
                        if (!prodotto.colore) mancanti.push({campo: 'colore', label: 'Colore'});
                        break;
                    
                    case 'zanzariera':
                        if (!prodotto.modello && !prodotto.tipo) mancanti.push({campo: 'modello', label: 'Modello'});
                        break;
                    
                    case 'infisso':
                        if (!prodotto.tipo) mancanti.push({campo: 'tipo', label: 'Tipo Infisso'});
                        if (!prodotto.azienda) mancanti.push({campo: 'azienda', label: 'Azienda/Fornitore'});
                        break;
                }
                
                return mancanti;
            },
            
            /**
             * Apre il wizard multi-step
             */
            apriWizard() {
                console.log('ğŸ§™ Apertura wizard completamento dati...');
                this.stepCorrente = 0;
                this.renderWizard();
            },
            
            /**
             * Render wizard container
             */
            renderWizard() {
                const html = `
                    <div class="wizard-overlay" id="wizard-preventivo" onclick="if(event.target===this) WizardCompletamento.chiudiWizard()">
                        <div class="wizard-container">
                            <div id="wizard-content"></div>
                        </div>
                    </div>
                `;
                
                const container = document.createElement('div');
                container.innerHTML = html;
                document.body.appendChild(container.firstElementChild);
                
                this.renderStepCorrente();
            },
            
            /**
             * Render step corrente
             */
            renderStepCorrente() {
                const content = document.getElementById('wizard-content');
                if (!content) return;
                
                switch(this.stepCorrente) {
                    case 0:
                        content.innerHTML = this.renderStepAnalisi();
                        break;
                    case 1:
                        content.innerHTML = this.renderStepConfiguraMisure();
                        break;
                    case 2:
                        content.innerHTML = this.renderStepAttributi();
                        break;
                    case 3:
                        content.innerHTML = this.renderStepRiepilogo();
                        break;
                }
            },
            
            /**
             * STEP 1: Analisi
             */
            renderStepAnalisi() {
                const a = this.analisi;
                
                return `
                    <div class="wizard-header">
                        <h2 class="wizard-title">ğŸ” Analisi Progetto</h2>
                        <button class="wizard-close" onclick="WizardCompletamento.chiudiWizard()">âœ•</button>
                    </div>
                    
                    <div class="wizard-body">
                        <div class="wizard-info-box">
                            <div class="wizard-info-row">
                                <span class="wizard-info-label">Progetto:</span>
                                <span class="wizard-info-value">${this.datiProgetto.nome || 'Senza nome'}</span>
                            </div>
                            <div class="wizard-info-row">
                                <span class="wizard-info-label">Posizioni totali:</span>
                                <span class="wizard-info-value">${a.posizioniTotali}</span>
                            </div>
                        </div>
                        
                        <div class="wizard-analysis">
                            ${a.posizioniComplete > 0 ? `
                            <div class="wizard-stat success">
                                <div class="wizard-stat-icon">âœ…</div>
                                <div class="wizard-stat-text">
                                    ${a.posizioniComplete} posizioni hanno dati completi
                                </div>
                            </div>
                            ` : ''}
                            
                            ${a.problemi.misureBRM.length > 0 ? `
                            <div class="wizard-stat warning">
                                <div class="wizard-stat-icon">âš ï¸</div>
                                <div class="wizard-stat-text">
                                    ${a.problemi.misureBRM.length} posizioni mancano misure BRM
                                </div>
                            </div>
                            ` : ''}
                            
                            ${a.problemi.attributi.length > 0 ? `
                            <div class="wizard-stat warning">
                                <div class="wizard-stat-icon">âš ï¸</div>
                                <div class="wizard-stat-text">
                                    ${a.problemi.attributi.length} posizioni mancano attributi
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="wizard-message">
                            <p>Il wizard ti guiderÃ  nella configurazione dei dati mancanti.</p>
                            <p><strong>Configurazione globale:</strong> Imposti i parametri UNA VOLTA e si applicano a tutte le posizioni.</p>
                        </div>
                    </div>
                    
                    <div class="wizard-footer">
                        <button class="wizard-btn wizard-btn-secondary" onclick="WizardCompletamento.chiudiWizard()">
                            â† Annulla
                        </button>
                        <button class="wizard-btn wizard-btn-primary" onclick="WizardCompletamento.avanti()">
                            Continua â†’
                        </button>
                    </div>
                `;
            },
            
            /**
             * STEP 2: Configurazione Misure BRM Globale
             */
            renderStepConfiguraMisure() {
                const problemi = this.analisi.problemi.misureBRM;
                
                if (problemi.length === 0) {
                    // Salta questo step
                    this.stepCorrente++;
                    return this.renderStepCorrente();
                }
                
                // Trova misure disponibili (esempio dalla prima posizione)
                const primaPosConMisure = problemi[0];
                const misureDisp = primaPosConMisure.misureDisponibili || {};
                
                return `
                    <div class="wizard-header">
                        <h2 class="wizard-title">âš™ï¸ Configurazione Misure BRM</h2>
                        <p class="wizard-subtitle">Si applica a TUTTE le ${problemi.length} posizioni mancanti</p>
                        <button class="wizard-close" onclick="WizardCompletamento.chiudiWizard()">âœ•</button>
                    </div>
                    
                    <div class="wizard-body">
                        <div class="wizard-section">
                            <h3 class="wizard-section-title">Posizioni da configurare:</h3>
                            <ul class="wizard-list">
                                ${problemi.map(p => `
                                    <li>â€¢ ${p.posizione} (${p.tipo.charAt(0).toUpperCase() + p.tipo.slice(1)})</li>
                                `).join('')}
                            </ul>
                        </div>
                        
                        <div class="wizard-section">
                            <h3 class="wizard-section-title">Misure disponibili nel rilievo:</h3>
                            <div class="wizard-misure-disponibili">
                                ${Object.keys(misureDisp).length > 0 ? Object.keys(misureDisp).map(key => `
                                    <div class="wizard-misura-badge">âœ“ ${key}</div>
                                `).join('') : '<div class="wizard-warning-text">Nessuna misura trovata nel rilievo</div>'}
                            </div>
                        </div>
                        
                        <div class="wizard-section">
                            <h3 class="wizard-section-title">Quale misura vuoi usare come riferimento?</h3>
                            <div class="wizard-radio-group">
                                <label class="wizard-radio">
                                    <input type="radio" name="misura-riferimento" value="LF" checked>
                                    <span class="wizard-radio-label">Luce Foro (LF)</span>
                                </label>
                                <label class="wizard-radio">
                                    <input type="radio" name="misura-riferimento" value="FM">
                                    <span class="wizard-radio-label">Foro Muro (FM)</span>
                                </label>
                                <label class="wizard-radio">
                                    <input type="radio" name="misura-riferimento" value="MT">
                                    <span class="wizard-radio-label">Misura Telaio (MT)</span>
                                </label>
                                <label class="wizard-radio">
                                    <input type="radio" name="misura-riferimento" value="manuale">
                                    <span class="wizard-radio-label">Inserimento manuale</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="wizard-section">
                            <h3 class="wizard-section-title">Correzioni da applicare:</h3>
                            <div class="wizard-corrections">
                                <div class="wizard-correction-item">
                                    <label class="wizard-label">Larghezza:</label>
                                    <div class="wizard-input-group">
                                        <button class="wizard-btn-mini" onclick="this.nextElementSibling.value = '+'; this.nextElementSibling.nextElementSibling.nextElementSibling.value = '+'">+</button>
                                        <input type="text" id="correzione-segno-L" value="+" style="width: 40px; text-align: center" readonly>
                                        <input type="number" id="correzione-valore-L" value="20" style="width: 80px">
                                        <button class="wizard-btn-mini" onclick="document.getElementById('correzione-segno-L').value = '-'; document.getElementById('correzione-valore-L').value = Math.abs(parseInt(document.getElementById('correzione-valore-L').value) || 0)">-</button>
                                        <span class="wizard-unit">mm</span>
                                    </div>
                                </div>
                                <div class="wizard-correction-item">
                                    <label class="wizard-label">Altezza:</label>
                                    <div class="wizard-input-group">
                                        <button class="wizard-btn-mini" onclick="this.nextElementSibling.value = '+'; this.nextElementSibling.nextElementSibling.nextElementSibling.value = '+'">+</button>
                                        <input type="text" id="correzione-segno-H" value="-" style="width: 40px; text-align: center" readonly>
                                        <input type="number" id="correzione-valore-H" value="10" style="width: 80px">
                                        <button class="wizard-btn-mini" onclick="document.getElementById('correzione-segno-H').value = '-'; document.getElementById('correzione-valore-H').value = Math.abs(parseInt(document.getElementById('correzione-valore-H').value) || 0)">-</button>
                                        <span class="wizard-unit">mm</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="wizard-example">
                                ğŸ’¡ Esempio: Se LF=1200mm, con +20mm â†’ BRM=1220mm
                            </div>
                        </div>
                        
                        <div class="wizard-section">
                            <h3 class="wizard-section-title">ğŸ“‹ Anteprima applicazione:</h3>
                            <div class="wizard-preview" id="preview-misure">
                                <div class="wizard-loading">Seleziona parametri sopra...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="wizard-footer">
                        <button class="wizard-btn wizard-btn-secondary" onclick="WizardCompletamento.indietro()">
                            â† Indietro
                        </button>
                        <button class="wizard-btn wizard-btn-primary" onclick="WizardCompletamento.applicaMisure()">
                            Applica a Tutte â†’
                        </button>
                    </div>
                `;
            },
            
            /**
             * STEP 3: Attributi prodotti (placeholder - da espandere)
             */
            renderStepAttributi() {
                const problemi = this.analisi.problemi.attributi;
                
                if (problemi.length === 0) {
                    this.stepCorrente++;
                    return this.renderStepCorrente();
                }
                
                return `
                    <div class="wizard-header">
                        <h2 class="wizard-title">ğŸ¨ Completa Attributi Prodotti</h2>
                        <button class="wizard-close" onclick="WizardCompletamento.chiudiWizard()">âœ•</button>
                    </div>
                    
                    <div class="wizard-body">
                        <div class="wizard-message">
                            <p>Trovati ${problemi.length} prodotti con attributi mancanti.</p>
                            <p><em>FunzionalitÃ  in sviluppo - per ora usa valori default</em></p>
                        </div>
                    </div>
                    
                    <div class="wizard-footer">
                        <button class="wizard-btn wizard-btn-secondary" onclick="WizardCompletamento.indietro()">
                            â† Indietro
                        </button>
                        <button class="wizard-btn wizard-btn-primary" onclick="WizardCompletamento.avanti()">
                            Salta â†’
                        </button>
                    </div>
                `;
            },
            
            /**
             * STEP 4: Riepilogo
             */
            renderStepRiepilogo() {
                return `
                    <div class="wizard-header">
                        <h2 class="wizard-title">ğŸ“Š Riepilogo Configurazione</h2>
                        <button class="wizard-close" onclick="WizardCompletamento.chiudiWizard()">âœ•</button>
                    </div>
                    
                    <div class="wizard-body">
                        <div class="wizard-summary">
                            <div class="wizard-summary-item success">
                                <div class="wizard-summary-icon">âœ…</div>
                                <div class="wizard-summary-text">
                                    <strong>Configurazione completata</strong>
                                    <p>Tutti i dati sono stati configurati</p>
                                </div>
                            </div>
                            
                            ${this.configurazioneMisure ? `
                            <div class="wizard-summary-section">
                                <h4>Misure BRM:</h4>
                                <ul>
                                    <li>Riferimento: ${this.configurazioneMisure.riferimento}</li>
                                    <li>Correzione L: ${this.configurazioneMisure.correzioneL}</li>
                                    <li>Correzione H: ${this.configurazioneMisure.correzioneH}</li>
                                </ul>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="wizard-message">
                            <p><strong>Pronto per generare il preventivo!</strong></p>
                            <p>Click su "Genera Preventivo" per calcolare i costi.</p>
                        </div>
                    </div>
                    
                    <div class="wizard-footer">
                        <button class="wizard-btn wizard-btn-secondary" onclick="WizardCompletamento.chiudiWizard()">
                            â† Annulla
                        </button>
                        <button class="wizard-btn wizard-btn-primary" onclick="WizardCompletamento.generaPreventivo()">
                            ğŸ“„ Genera Preventivo
                        </button>
                    </div>
                `;
            },
            
            /**
             * Naviga avanti
             */
            avanti() {
                this.stepCorrente++;
                this.renderStepCorrente();
            },
            
            /**
             * Naviga indietro
             */
            indietro() {
                if (this.stepCorrente > 0) {
                    this.stepCorrente--;
                    this.renderStepCorrente();
                }
            },
            
            /**
             * Applica configurazione misure
             */
            applicaMisure() {
                const riferimento = document.querySelector('input[name="misura-riferimento"]:checked')?.value || 'LF';
                const segnoL = document.getElementById('correzione-segno-L')?.value || '+';
                const valoreL = parseInt(document.getElementById('correzione-valore-L')?.value || 0);
                const segnoH = document.getElementById('correzione-segno-H')?.value || '+';
                const valoreH = parseInt(document.getElementById('correzione-valore-H')?.value || 0);
                
                this.configurazioneMisure = {
                    riferimento: riferimento,
                    correzioneL: `${segnoL}${valoreL}mm`,
                    correzioneH: `${segnoH}${valoreH}mm`
                };
                
                console.log('âœ… Configurazione misure salvata:', this.configurazioneMisure);
                
                // Applica alle posizioni
                this.applicaMisureAiDati();
                
                // Vai avanti
                this.avanti();
            },
            
            /**
             * Applica misure configurate ai dati progetto
             */
            applicaMisureAiDati() {
                const problemi = this.analisi.problemi.misureBRM;
                
                problemi.forEach(problema => {
                    const pos = this.datiProgetto.posizioni[problema.posizioneIdx];
                    const prodotto = pos[problema.tipo];
                    
                    // Se giÃ  ha BRM, salta
                    if (this.verificaBRM(prodotto, problema.tipo)) return;
                    
                    // Inizializza BRM se non esiste
                    if (!prodotto.brm) prodotto.brm = {};
                    
                    // Calcola BRM da misure disponibili
                    const misure = problema.misureDisponibili;
                    const rif = this.configurazioneMisure.riferimento;
                    
                    // Prova a trovare la misura di riferimento
                    let misuraBase = misure[rif] || misure['LF'] || misure['FM'] || misure['luce_foro'];
                    
                    if (misuraBase) {
                        // Applica correzioni
                        const correzioneL = parseInt(this.configurazioneMisure.correzioneL.replace(/[^0-9-]/g, ''));
                        const correzioneH = parseInt(this.configurazioneMisure.correzioneH.replace(/[^0-9-]/g, ''));
                        
                        prodotto.brm.L = (misuraBase.L || 0) + correzioneL;
                        prodotto.brm.H = (misuraBase.H || 0) + correzioneH;
                        
                        console.log(`âœ… BRM applicato a ${problema.posizione}: ${prodotto.brm.L}Ã—${prodotto.brm.H}`);
                    } else {
                        // ğŸ”§ v8.10: NON usare valori di default - lascia null per non mostrare dati falsi
                        console.warn(`âš ï¸ Nessuna misura trovata per ${problema.posizione}, BRM non calcolabile`);
                    }
                });
            },
            
            /**
             * Genera preventivo finale
             */
            generaPreventivo() {
                console.log('ğŸ“Š Generazione preventivo con dati completati...');
                
                // Chiudi wizard
                this.chiudiWizard();
                
                // Apri preventivo con dati aggiornati
                setTimeout(() => {
                    window.PreventivoUI.apriModalPreventivo();
                }, 300);
            },
            
            /**
             * Chiudi wizard
             */
            chiudiWizard() {
                const wizard = document.getElementById('wizard-preventivo');
                if (wizard) {
                    wizard.remove();
                }
            }
        };

        console.log('ğŸ§™ WizardCompletamento loaded');
    </script>
    
    <script>
        // Listino Finstral inline (opzionale - rimosso caricamento fetch)
        // TODO: Integrare listino se necessario
        
        // Init completion tracker quando dati disponibili
        if (window.currentData) {
            console.log('ğŸš€ Initializing completion tracker...');
            CompletionTracker.updateMenuStatus(menuStructure, window.currentData);
            renderAdvancedMenu();
        }
    </script>

    <!-- MODAL SCELTA BRM -->
    <div id="brm-modal-overlay" class="brm-modal-overlay">
        <div class="brm-modal">
            <div class="brm-modal-header">
                <h2 class="brm-modal-title">âš ï¸ Selezione Misure BRM</h2>
                <p class="brm-modal-subtitle" id="brm-posizione-nome"></p>
            </div>
            
            <div class="brm-modal-body">
                <div class="brm-alert">
                    <p class="brm-alert-text">
                        Le misure BRM non sono state definite nel rilievo. 
                        Seleziona quali misure usare come riferimento per il listino Finstral.
                    </p>
                </div>
                
                <!-- SEZIONE LARGHEZZA -->
                <div class="brm-section" id="brm-section-larghezza" style="display: none;">
                    <div class="brm-section-title">
                        <span class="brm-section-icon">â†”ï¸</span>
                        LARGHEZZA
                    </div>
                    <div class="brm-options" id="brm-options-larghezza"></div>
                </div>
                
                <!-- SEZIONE ALTEZZA -->
                <div class="brm-section" id="brm-section-altezza" style="display: none;">
                    <div class="brm-section-title">
                        <span class="brm-section-icon">â†•ï¸</span>
                        ALTEZZA
                    </div>
                    <div class="brm-options" id="brm-options-altezza"></div>
                </div>
            </div>
            
            <div class="brm-modal-actions">
                <button class="brm-btn brm-btn-secondary" onclick="chiudiModalBRM()">Annulla</button>
                <button class="brm-btn brm-btn-primary" id="brm-btn-conferma" onclick="confermaBRM()" disabled>
                    Conferma e Calcola âœ“
                </button>
            </div>
        </div>
    </div>

    <!-- MODALE GESTIONE LISTINI -->
    <div id="listini-modal" class="preventivo-modal-overlay" style="display: none;" onclick="if(event.target===this) chiudiGestioneListini()">
        <div class="preventivo-modal" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <div class="preventivo-modal-header">
                <h2 class="preventivo-modal-title">ğŸ“š Gestione Listini Prezzi</h2>
                <button class="preventivo-modal-close" onclick="chiudiGestioneListini()">âœ•</button>
            </div>
            
            <!-- Tab Navigation -->
            <div style="display: flex; gap: 1rem; padding: 1rem; border-bottom: 2px solid #e5e7eb; background: #f9fafb;">
                <button class="tab-listini active" onclick="switchTabListini('persiane')">
                    ğŸšª Persiane
                </button>
                <button class="tab-listini" onclick="switchTabListini('tapparelle')">
                    ğŸšï¸ Tapparelle
                </button>
                <button class="tab-listini" onclick="switchTabListini('zanzariere')">
                    ğŸ¦Ÿ Zanzariere
                </button>
                <button class="tab-listini" onclick="switchTabListini('test')">
                    ğŸ§ª Test Calcolo
                </button>
            </div>
            
            <!-- Content Persiane -->
            <div id="tab-content-persiane" class="tab-content-listini" style="padding: 1.5rem;">
                <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ“Š Listino Persiane - STEP 1</h3>
                
                <!-- Info Generale -->
                <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.5rem;">
                    <p style="margin: 0; font-weight: 600; color: #065f46;">
                        â„¹ï¸ Versione: <span id="listino-persiane-versione"></span> | 
                        Aggiornamento: <span id="listino-persiane-data"></span>
                    </p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #047857;">
                        ğŸ“„ Fonte: <span id="listino-persiane-fonte"></span>
                    </p>
                </div>
                
                <!-- Modelli -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 0.75rem; color: #374151;">ğŸ—ï¸ Modelli Disponibili</h4>
                    <div id="listino-persiane-modelli"></div>
                </div>
                
                <!-- Telai -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 0.75rem; color: #374151;">ğŸ› ï¸ Telai</h4>
                    <div id="listino-persiane-telai"></div>
                </div>
                
                <!-- Colori -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 0.75rem; color: #374151;">ğŸ¨ Colori</h4>
                    <div id="listino-persiane-colori"></div>
                </div>
                
                <!-- Supplementi -->
                <div>
                    <h4 style="margin-bottom: 0.75rem; color: #374151;">ğŸ’° Supplementi</h4>
                    <div id="listino-persiane-supplementi"></div>
                </div>
            </div>
            
            <!-- Content Tapparelle -->
            <div id="tab-content-tapparelle" class="tab-content-listini" style="display: none; padding: 1.5rem;">
                <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ“Š Listino Tapparelle - PLASTICINO</h3>
                
                <!-- Info Generale -->
                <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.5rem;">
                    <p style="margin: 0; font-weight: 600; color: #1e40af;">
                        â„¹ï¸ Aziende: Plasticino | New Solar | Estella
                    </p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #1e3a8a;">
                        ğŸ“„ Formula: <strong>TOTALE = (L Ã— â‚¬13.20/m) + â‚¬66.40 + Supplemento H</strong>
                    </p>
                </div>
                
                <!-- Formula Calcolo -->
                <div style="margin-bottom: 1.5rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                    <h4 style="margin: 0 0 1rem 0; color: #374151;">ğŸ§® Formula di Calcolo</h4>
                    <div style="font-family: monospace; background: white; padding: 1rem; border-radius: 0.375rem; border: 1px solid #d1d5db;">
                        <div style="margin-bottom: 0.5rem;"><strong>TOTALE</strong> = <span style="color: #2563eb;">(L_metri Ã— 13.20)</span> + <span style="color: #059669;">66.40</span> + <span style="color: #dc2626;">Supplemento_H</span></div>
                        <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
                            â€¢ L_metri = Larghezza in metri (L_cm Ã· 100)<br>
                            â€¢ 13.20 = Costo rullo â‚¬/metro lineare<br>
                            â€¢ 66.40 = Totale componenti fissi<br>
                            â€¢ Supplemento_H = â‚¬0.50/metro se H > 300cm
                        </div>
                    </div>
                </div>
                
                <!-- Componenti Fissi -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 0.75rem; color: #374151;">ğŸ”§ Componenti Fissi (â‚¬66.40)</h4>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                        <thead>
                            <tr style="background: #f3f4f6;">
                                <th style="padding: 0.5rem; text-align: left; border: 1px solid #e5e7eb;">Codice</th>
                                <th style="padding: 0.5rem; text-align: left; border: 1px solid #e5e7eb;">Descrizione</th>
                                <th style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">Prezzo</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">COMP-01</td>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Rullo Ottagonale 60mm</td>
                                <td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb; color: #2563eb; font-weight: 600;">â‚¬13.20/m</td>
                            </tr>
                            <tr style="background: #f9fafb;">
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">COMP-02</td>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Calotta</td>
                                <td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">â‚¬15.00</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">COMP-03</td>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Avvolgitore</td>
                                <td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">â‚¬10.00</td>
                            </tr>
                            <tr style="background: #f9fafb;">
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">COMP-04</td>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Cuscinetto</td>
                                <td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">â‚¬3.50</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">COMP-05</td>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Supporti x2</td>
                                <td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">â‚¬6.00</td>
                            </tr>
                            <tr style="background: #f9fafb;">
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">COMP-06</td>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Ganci x2</td>
                                <td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">â‚¬7.20</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">COMP-08</td>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Placca</td>
                                <td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">â‚¬5.00</td>
                            </tr>
                            <tr style="background: #f9fafb;">
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">COMP-09</td>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Passacinghia</td>
                                <td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">â‚¬1.70</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">COMP-10</td>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Macchinetta</td>
                                <td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">â‚¬18.00</td>
                            </tr>
                            <tr style="background: #dcfce7; font-weight: 600;">
                                <td colspan="2" style="padding: 0.5rem; border: 1px solid #e5e7eb; text-align: right;">TOTALE COMPONENTI FISSI:</td>
                                <td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb; color: #059669;">â‚¬66.40</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Supplementi -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 0.75rem; color: #374151;">ğŸ’° Supplementi</h4>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                        <thead>
                            <tr style="background: #f3f4f6;">
                                <th style="padding: 0.5rem; text-align: left; border: 1px solid #e5e7eb;">Codice</th>
                                <th style="padding: 0.5rem; text-align: left; border: 1px solid #e5e7eb;">Descrizione</th>
                                <th style="padding: 0.5rem; text-align: left; border: 1px solid #e5e7eb;">Condizione</th>
                                <th style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">Prezzo</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">COMP-07</td>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Doppia Altezza</td>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">Se H > 300cm</td>
                                <td style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb; color: #dc2626; font-weight: 600;">â‚¬0.50/m</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Test Rapido -->
                <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 0.5rem; padding: 1rem;">
                    <h4 style="margin: 0 0 1rem 0; color: #92400e;">ğŸ§ª Test Calcolo Rapido</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #78350f;">Larghezza (cm):</label>
                            <input type="number" id="test-tapp-L" placeholder="es. 127.5" style="width: 100%; padding: 0.5rem; border: 1px solid #d97706; border-radius: 0.375rem;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #78350f;">Altezza (cm):</label>
                            <input type="number" id="test-tapp-H" placeholder="es. 242.5" style="width: 100%; padding: 0.5rem; border: 1px solid #d97706; border-radius: 0.375rem;">
                        </div>
                        <div id="test-tapp-result" style="font-size: 1.25rem; font-weight: 700; color: #059669; text-align: center; padding: 0.5rem;">
                            -
                        </div>
                        <button onclick="testCalcoloTapparella()" style="padding: 0.5rem 1rem; background: #2563eb; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 600; white-space: nowrap;">
                            ğŸ§® Calcola
                        </button>
                    </div>
                    <div id="test-tapp-dettaglio" style="margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 0.375rem; font-size: 0.875rem; font-family: monospace; display: none;"></div>
                </div>
            </div>
            
            <!-- Content Zanzariere -->
            <div id="tab-content-zanzariere" class="tab-content-listini" style="display: none; padding: 1.5rem;">
                <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ“Š Listino Zanzariere</h3>
                <div id="listino-zanzariere-content"></div>
            </div>
            
            <!-- Content Test -->
            <div id="tab-content-test" class="tab-content-listini" style="display: none; padding: 1.5rem;">
                <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ§ª Test Calcolo Rapido</h3>
                
                <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; color: #374151;">Persiana</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Modello:</label>
                            <select id="test-modello" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                <option value="">Seleziona...</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Tipologia:</label>
                            <select id="test-tipologia" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                <option value="">Seleziona...</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Larghezza (mm):</label>
                            <input type="number" id="test-larghezza" placeholder="es. 1400" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Altezza (mm):</label>
                            <input type="number" id="test-altezza" placeholder="es. 1300" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Telaio:</label>
                            <select id="test-telaio" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                <option value="">Nessuno</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Colore:</label>
                            <select id="test-colore" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                <option value="">Nessuno</option>
                            </select>
                        </div>
                    </div>
                    
                    <button onclick="eseguiTestCalcolo()" style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer;">
                        ğŸ§® Calcola Prezzo
                    </button>
                    
                    <div id="test-risultato" style="margin-top: 1rem;"></div>
                </div>
            </div>
            
            <div class="preventivo-modal-actions">
                <button class="btn-preventivo btn-secondary" onclick="chiudiGestioneListini()">
                    â† Chiudi
                </button>
            </div>
        </div>
    </div>

    <!-- MODALE INSERIMENTO MANUALE PREZZO PERSIANA -->
    <div id="modal-prezzo-manuale" class="preventivo-modal-overlay" style="display: none;" onclick="if(event.target===this) chiudiModalPrezzoManuale()">
        <div class="preventivo-modal" style="max-width: 600px;">
            <div class="preventivo-modal-header">
                <h2 class="preventivo-modal-title">âš ï¸ Inserimento Manuale Prezzo</h2>
                <button class="preventivo-modal-close" onclick="chiudiModalPrezzoManuale()">âœ•</button>
            </div>
            
            <div style="padding: 1.5rem;">
                <!-- Info dimensione non trovata -->
                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 0.375rem; margin-bottom: 1.5rem;">
                    <p style="margin: 0; color: #92400e; font-weight: 600;">
                        ğŸ“ Dimensione non trovata nel listino
                    </p>
                    <p id="dimensione-mancante-info" style="margin: 0.5rem 0 0 0; color: #78350f; font-size: 0.875rem;"></p>
                </div>
                
                <!-- Form inserimento -->
                <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem;">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                            ğŸ’° Prezzo Base (â‚¬): *
                        </label>
                        <input type="number" id="input-prezzo-base-manuale" 
                               placeholder="es. 850.00" 
                               step="0.01"
                               style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                            ğŸ› ï¸ Prezzo Telaio (â‚¬):
                        </label>
                        <input type="number" id="input-telaio-manuale" 
                               placeholder="es. 136.00 (opzionale)" 
                               step="0.01"
                               style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                            ğŸ¨ Maggiorazione Colore (%):
                        </label>
                        <input type="number" id="input-colore-perc-manuale" 
                               placeholder="es. 30 (opzionale)" 
                               min="0" 
                               max="100"
                               style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                            ğŸ“ Note:
                        </label>
                        <textarea id="input-note-manuale" 
                                  placeholder="es. Prezzo da preventivo fornitore ABC del 15/11/2025" 
                                  rows="3"
                                  style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem; resize: vertical;"></textarea>
                    </div>
                    
                    <!-- Anteprima calcolo -->
                    <div id="anteprima-calcolo-manuale" style="background: white; border: 2px solid #10b981; border-radius: 0.375rem; padding: 1rem; margin-top: 1rem; display: none;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #065f46;">ğŸ’¡ Anteprima Calcolo:</h4>
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; font-size: 0.875rem;">
                            <div style="color: #6b7280;">Prezzo Base:</div>
                            <div id="preview-base" style="font-weight: 600; color: #1f2937;"></div>
                            
                            <div style="color: #6b7280;">Telaio:</div>
                            <div id="preview-telaio" style="font-weight: 600; color: #1f2937;"></div>
                            
                            <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; color: #6b7280;">Subtotale:</div>
                            <div id="preview-subtotale" style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; font-weight: 600; color: #1f2937;"></div>
                            
                            <div style="color: #6b7280;">Colore (%):</div>
                            <div id="preview-colore" style="font-weight: 600; color: #f59e0b;"></div>
                            
                            <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; color: #6b7280;">Totale Prodotto:</div>
                            <div id="preview-totale-prodotto" style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; font-weight: 700; color: #059669;"></div>
                            
                            <div style="color: #6b7280;">Contributo:</div>
                            <div id="preview-contributo" style="font-weight: 600; color: #1f2937;">â‚¬57.00</div>
                            
                            <div style="color: #6b7280;">Imballo (3%):</div>
                            <div id="preview-imballo" style="font-weight: 600; color: #1f2937;"></div>
                            
                            <div style="padding-top: 0.5rem; border-top: 2px solid #10b981; color: #065f46; font-weight: 700;">TOTALE FINALE:</div>
                            <div id="preview-finale" style="padding-top: 0.5rem; border-top: 2px solid #10b981; font-weight: 700; color: #059669; font-size: 1.125rem;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="preventivo-modal-actions">
                <button class="btn-preventivo btn-secondary" onclick="chiudiModalPrezzoManuale()">
                    Annulla
                </button>
                <button class="btn-preventivo btn-primary" onclick="calcolaAnteprimaManuale()" style="background: #3b82f6;">
                    ğŸ§® Calcola Anteprima
                </button>
                <button id="btn-salva-prezzo-manuale" class="btn-preventivo btn-primary" onclick="salvaPrezzoManuale()" disabled style="opacity: 0.5;">
                    âœ… Salva Prezzo
                </button>
            </div>
        </div>
    </div>

</body>
</html>
